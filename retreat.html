<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ретрит | Rupa Seva</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <!-- Open Graph для шаринга -->
    <meta property="og:type" content="event">
    <meta property="og:title" id="og-title" content="Ретрит | Rupa Seva">
    <meta property="og:description" id="og-description" content="">
    <meta property="og:image" id="og-image" content="">
    <meta property="og:url" id="og-url" content="">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'srsk-green': '#147D30',
                        'srsk-green-light': '#1a9e3d',
                        'srsk-orange': '#FFBA47',
                        'srsk-bg': '#F5F3EF'
                    }
                }
            }
        }
    </script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Portal CSS -->
    <link rel="stylesheet" href="guest-portal/css/portal.css">

    <style>
        /* Дополнительные стили для страницы ретрита */
        .hero-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 0.75rem;
        }

        .step-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .step-dot {
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
            background-color: #d1d5db;
            transition: all 0.3s;
        }

        .step-dot.active {
            width: 1.5rem;
            background-color: var(--srsk-green);
        }

        .step-dot.completed {
            background-color: var(--srsk-green);
        }

        /* Скрыть шаги формы */
        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
        }

        /* Анимация появления */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-step.active {
            animation: fadeIn 0.3s ease-out;
        }

        /* Переключатель языка на тёмном фоне */
        header .lang-btn.active {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }
    </style>
</head>
<body class="bg-srsk-bg min-h-screen flex flex-col">

    <!-- Loader -->
    <div id="loader" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="flex flex-col items-center gap-3">
            <div class="w-10 h-10 border-4 border-srsk-green border-t-transparent rounded-full animate-spin"></div>
            <span class="text-gray-600" data-i18n="loading">Загрузка...</span>
        </div>
    </div>

    <!-- 404 страница -->
    <div id="not-found" class="hidden min-h-screen flex items-center justify-center">
        <div class="text-center px-4">
            <div class="w-24 h-24 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2" data-i18n="retreat_not_found">Ретрит не найден</h1>
            <p class="text-gray-500 mb-6" data-i18n="retreat_not_found_hint">Проверьте ссылку или вернитесь на главную</p>
            <a href="/guest-portal/" class="btn-primary">
                <span data-i18n="retreat_go_home">На главную</span>
            </a>
        </div>
    </div>

    <!-- Основной контент -->
    <div id="main-content" class="hidden flex-1 flex flex-col">
        <!-- Хедер -->
        <header class="bg-srsk-green">
            <div class="max-w-6xl mx-auto px-4 md:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16 relative">
                    <!-- Назад в профиль (для залогиненных) -->
                    <a id="back-to-profile" href="/guest-portal/" class="hidden items-center gap-1 text-white/80 hover:text-white text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        <span data-i18n="back_to_profile">в профиль</span>
                    </a>
                    <!-- Пустой div для выравнивания когда не залогинен -->
                    <div id="back-placeholder" class="w-20"></div>

                    <!-- Логотип по центру -->
                    <a href="/guest-portal/" class="flex items-center absolute left-1/2 -translate-x-1/2">
                        <svg class="h-10" viewBox="0 0 308.75 98.28">
                            <path fill="#FFBA47" d="M143.64,4.26h-4.62v24.95c0,1.89.04,3.53-.27,4.87-.31,1.36-.79,2.43-1.45,3.22-.61.86-1.48,1.47-2.59,1.84-.73.3-1.55.49-2.47.56-.31.06-.61.1-.92.1h-.19c-1.16-.06-2.2-.25-3.12-.56-1.16-.37-2.14-.95-2.93-1.75-.81-.86-1.39-1.96-1.74-3.32-.37-1.34-.56-3-.56-4.96V4.26h-4.6v27.15c0,4.17,1.16,7.29,3.49,9.37,1.16,1.05,2.61,1.82,4.33,2.3.36.13.78.23,1.28.29-4.23,1.53-7.11,3.62-8.65,6.25-2.15,3.24-2.21,7.35-.19,12.33l12.59,30.6,12.16-30.6c1.95-4.97,1.89-9.08-.19-12.33-1.47-2.58-4.25-4.63-8.36-6.15.49-.13.97-.26,1.45-.39,1.6-.48,2.95-1.28,4.04-2.37,1.16-1.11,2.03-2.49,2.59-4.14.61-1.71.92-3.74.92-6.08V4.26M139.21,51.92c1.23,2.21,1.17,5-.17,8.36l-8.02,20.76-8.45-20.76c-1.4-3.36-1.46-6.14-.17-8.36,1.41-2.28,4.19-3.96,8.36-5.06,4.17,1.1,6.98,2.79,8.45,5.06"/>
                            <path fill="#fff" d="M26.44,33.99c0-1.56-.46-2.83-1.39-3.81-.93-.98-2.09-1.86-3.48-2.62-1.39-.76-2.91-1.48-4.54-2.14-1.63-.67-3.15-1.48-4.54-2.42-1.39-.95-2.55-2.12-3.48-3.51-.93-1.39-1.39-3.17-1.39-5.32,0-3.05,1.06-5.46,3.18-7.24,2.12-1.78,5.12-2.67,9.02-2.67,2.26,0,4.33.17,6.18.5,1.86.34,3.3.76,4.35,1.28l-1.39,4.12c-.85-.42-2.11-.82-3.76-1.21-1.65-.38-3.52-.58-5.6-.58-2.45,0-4.29.55-5.52,1.64-1.22,1.1-1.84,2.39-1.84,3.87s.46,2.66,1.39,3.62c.93.96,2.09,1.83,3.48,2.59,1.39.76,2.91,1.51,4.54,2.26,1.63.74,3.15,1.61,4.54,2.59,1.39.98,2.55,2.16,3.48,3.54.93,1.38,1.39,3.08,1.39,5.12,0,1.67-.3,3.18-.89,4.51-.59,1.34-1.47,2.49-2.62,3.46-1.15.97-2.54,1.71-4.18,2.23-1.64.52-3.49.78-5.57.78-2.79,0-5.09-.21-6.91-.64-1.82-.43-3.23-.9-4.23-1.42l1.56-4.12c.85.47,2.12.93,3.79,1.38,1.67.45,3.55.68,5.63.68,1.23,0,2.38-.12,3.45-.36,1.08-.24,2.01-.63,2.79-1.17.78-.54,1.4-1.22,1.87-2.03.46-.82.7-1.78.7-2.9"/>
                            <rect fill="#fff" x="63.63" y="4.91" width="4.62" height="38.99"/>
                            <path fill="#fff" d="M89.54,5.25c1.41-.26,3.04-.46,4.87-.61,1.84-.15,3.52-.22,5.04-.22,1.71,0,3.33.19,4.87.56,1.54.37,2.9.98,4.07,1.84,1.17.86,2.11,1.97,2.81,3.34s1.06,3.05,1.06,5.01c0,3.04-.84,5.51-2.51,7.41-1.67,1.89-2.76,2.86-5.32,3.49l10.86,17.79h-5.4l-10.27-16.82h-5.46s0,16.82,0,16.82h-4.62V5.25ZM99.57,8.43h-1.5c-.52,0-1.02.02-1.5.06-.48.04-.94.08-1.37.11-.43.04-.77.09-1.03.17v14.37h4.34c2.56,0,4.68-.63,6.35-1.89,1.67-1.26,2.51-3.23,2.51-5.9,0-2.01-.69-3.66-2.06-4.96-1.37-1.3-3.29-1.95-5.74-1.95"/>
                            <path fill="#fff" d="M150.26,5.25c1.41-.33,2.93-.56,4.57-.67,1.63-.11,3.25-.17,4.85-.17,1.71,0,3.44.17,5.21.5,1.76.33,3.37.95,4.82,1.84,1.45.89,2.63,2.12,3.54,3.68.91,1.56,1.36,3.55,1.36,5.96s-.43,4.38-1.28,6.02c-.86,1.64-1.99,2.96-3.4,3.98-1.41,1.02-3.03,1.75-4.85,2.2-1.82.45-3.7.67-5.63.67h-.92c-.43,0-.87,0-1.34-.03-.46-.02-.92-.05-1.37-.08-.45-.04-.76-.07-.95-.11v14.82h-4.62V5.25ZM159.78,8.43c-.97,0-1.89.02-2.79.06-.89.04-1.6.13-2.12.28v16.16c.19.08.48.12.89.14.41.02.84.04,1.28.06.45.02.87.03,1.28.03h.89c1.26,0,2.52-.12,3.76-.36,1.24-.24,2.37-.68,3.37-1.31,1-.63,1.81-1.52,2.42-2.67.61-1.15.92-2.62.92-4.4,0-1.52-.29-2.79-.86-3.81-.58-1.02-1.34-1.84-2.28-2.45-.95-.61-2.01-1.05-3.2-1.31-1.19-.26-2.37-.39-3.56-.39"/>
                            <path fill="#fff" d="M80.84,80.79c0-1.56-.46-2.83-1.39-3.82-.93-.98-2.09-1.86-3.48-2.62-1.39-.76-2.91-1.48-4.54-2.15-1.63-.67-3.15-1.47-4.54-2.42-1.39-.95-2.55-2.12-3.48-3.51-.93-1.39-1.39-3.17-1.39-5.32,0-3.04,1.06-5.46,3.18-7.24,2.12-1.78,5.12-2.67,9.02-2.67,2.26,0,4.33.17,6.18.5,1.86.33,3.3.76,4.35,1.28l-1.39,4.12c-.85-.42-2.11-.82-3.76-1.21-1.65-.38-3.52-.58-5.6-.58-2.45,0-4.29.55-5.52,1.64-1.22,1.1-1.84,2.39-1.84,3.87s.46,2.66,1.39,3.62c.93.97,2.09,1.83,3.48,2.59,1.39.76,2.91,1.51,4.54,2.26,1.63.74,3.15,1.61,4.54,2.59,1.39.98,2.55,2.16,3.48,3.54.93,1.38,1.39,3.08,1.39,5.12,0,1.67-.3,3.18-.89,4.51-.59,1.34-1.47,2.49-2.62,3.45-1.15.97-2.54,1.71-4.18,2.23-1.64.52-3.49.78-5.57.78-2.79,0-5.09-.21-6.91-.64-1.82-.43-3.23-.9-4.23-1.42l1.56-4.12c.85.47,2.12.93,3.79,1.38,1.67.45,3.55.68,5.63.68,1.23,0,2.38-.12,3.45-.36,1.08-.24,2.01-.63,2.79-1.17.78-.54,1.4-1.22,1.87-2.03.46-.82.7-1.78.7-2.9"/>
                            <polygon fill="#fff" points="89.42 51.71 111.13 51.71 111.13 55.84 94.05 55.84 94.05 68.59 109.25 68.59 109.25 72.72 94.05 72.72 94.05 86.59 112.38 86.59 112.38 90.71 89.42 90.71 89.42 51.71"/>
                            <polygon fill="#fff" points="195.8 72.33 195.61 72.33 195.61 90.38 190.98 90.38 190.98 51.39 195.61 51.39 195.61 68.77 195.69 68.77 211.2 51.39 216.55 51.39 199.62 69.92 217.8 90.38 212.43 90.38 195.8 72.33"/>
                            <path fill="#fff" d="M291.04,51.39h4.62v30.42c0,2.97-.66,5.24-1.98,6.8-1.32,1.56-3.31,2.34-5.99,2.34-.3,0-.67-.02-1.11-.06-.45-.04-.89-.09-1.34-.17-.45-.08-.88-.17-1.31-.28-.43-.11-.77-.24-1.03-.39l.89-3.9c1.04.45,2.17.67,3.4.67,1.56,0,2.59-.55,3.09-1.64.5-1.09.75-2.59.75-4.48v-29.3Z"/>
                            <path fill="#fff" d="M158.1,51.1h-2.12l-14.76,39.61h4.62l3.88-10.81h14.3l3.99,10.81h4.9l-14.82-39.61ZM151.22,75.89l5.71-15.69,5.71,15.69h-11.42Z"/>
                            <path fill="#fff" d="M188.73,4.25h-2.12l-14.76,39.61h4.62l3.88-10.81h14.3l3.99,10.81h4.9l-14.82-39.61ZM181.86,29.04l5.71-15.69,5.71,15.69h-11.42Z"/>
                            <path fill="#fff" d="M35.03,5.3c1.41-.26,3.04-.46,4.87-.61,1.84-.15,3.52-.22,5.04-.22,1.71,0,3.33.19,4.87.56,1.54.37,2.9.98,4.07,1.84,1.17.85,2.11,1.97,2.81,3.34s1.06,3.04,1.06,5.01c0,3.05-.84,5.52-2.51,7.41-1.67,1.89-2.76,2.86-5.32,3.49l10.86,17.79h-5.4l-10.27-16.82h-5.46s0,16.82,0,16.82h-4.62V5.3ZM45.05,8.47h-1.5c-.52,0-1.02.02-1.5.06-.48.04-.94.08-1.37.11-.43.04-.77.09-1.03.17v14.37h4.34c2.56,0,4.68-.63,6.35-1.89,1.67-1.26,2.51-3.23,2.51-5.91,0-2-.69-3.66-2.06-4.96-1.37-1.3-3.29-1.95-5.74-1.95"/>
                            <polygon fill="#fff" points="274.27 51.39 274.27 76.79 274.27 80.33 253.05 50.78 250.6 50.78 250.6 90.38 254.94 90.38 254.94 61.19 276.17 91 278.62 91 278.62 51.39 274.27 51.39"/>
                            <path fill="#fff" d="M241.51,51.39h-1.05v24.73c0,2,.08,3.83-.31,5.19-.19.65-.29,1.04-.57,1.57-.33.53-.67,1-.98,1.41-.05.07-.11.13-.16.19-.77.79-1.71,1.37-2.84,1.73-1.09.35-1.93.53-3.29.55-1.37-.02-2.21-.21-3.3-.55-1.13-.36-2.07-.94-2.84-1.73-.05-.06-.11-.13-.16-.19-.16-.21-.35-.43-.54-.67-.48-.7-.68-1.14-.96-2.11-.39-1.36-.31-3.28-.31-5.38v-24.73h-4.6v26.91c0,4.23,1.17,7.39,3.51,9.47,1.81,1.61,3.71,2.59,6.6,2.95.7.11,1.45.16,2.33.16.09,0,.17,0,.26,0,.09,0,.17,0,.26,0,.88,0,1.62-.06,2.33-.16,2.89-.37,4.8-1.35,6.6-2.95,2.34-2.08,3.51-5.24,3.51-9.47v-26.91h-3.49Z"/>
                        </svg>
                    </a>

                    <!-- Переключатель языка -->
                    <div class="flex items-center gap-1 bg-white/10 rounded-lg p-1">
                        <button class="lang-btn px-2 py-1 text-sm rounded text-white/70 hover:text-white" data-lang="ru">RU</button>
                        <button class="lang-btn px-2 py-1 text-sm rounded text-white/70 hover:text-white" data-lang="en">EN</button>
                        <button class="lang-btn px-2 py-1 text-sm rounded text-white/70 hover:text-white" data-lang="hi">HI</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Герой-секция -->
        <section id="hero-section" class="bg-white flex-1">
            <div class="max-w-6xl mx-auto px-4 md:px-6 lg:px-8 py-6 md:py-8">
                <div class="flex flex-col md:flex-row gap-6 md:gap-8">
                    <!-- Картинка 1/3 -->
                    <div class="md:w-1/3 flex-shrink-0">
                        <img id="retreat-image" class="hero-image w-full" src="" alt="">
                    </div>
                    <!-- Текст 2/3 -->
                    <div class="md:w-2/3 flex flex-col justify-center">
                        <h1 id="retreat-name" class="text-2xl md:text-3xl font-bold text-gray-800 mb-2"></h1>
                        <p id="retreat-dates" class="text-lg text-srsk-green font-medium mb-4"></p>
                        <p id="retreat-description" class="text-gray-600 whitespace-pre-line mb-6"></p>

                        <!-- Регистрация -->
                        <div id="registration-section">
                            <!-- Если регистрация открыта -->
                            <div id="registration-open" class="hidden">
                                <button id="register-btn" onclick="openRegistrationModal()" class="btn-primary text-lg py-3 px-8">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                    <span data-i18n="retreat_register_btn">Подать заявку</span>
                                </button>
                            </div>

                            <!-- Если регистрация закрыта -->
                            <div id="registration-closed" class="hidden">
                                <div class="bg-gray-100 rounded-lg p-3 inline-block">
                                    <p class="text-gray-500 text-sm" data-i18n="retreat_registration_closed">Регистрация на этот ретрит закрыта</p>
                                </div>
                            </div>

                            <!-- Если уже зарегистрирован -->
                            <div id="already-registered" class="hidden">
                                <div class="bg-green-50 border border-green-200 rounded-lg p-3 inline-flex items-center gap-3">
                                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="font-medium text-green-800 text-sm" data-i18n="retreat_already_registered">Вы уже зарегистрированы</p>
                                        <a href="/guest-portal/retreats.html" class="text-xs text-green-600 hover:underline" data-i18n="retreat_view_my_retreats">Мои ретриты</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Персональная информация для зарегистрированных -->
                <div id="guest-info-section" class="hidden mt-8 pt-8 border-t border-gray-200 space-y-4">

                    <!-- Размещение -->
                    <div id="accommodation-card" class="hidden rounded-2xl p-5" style="background: #E8F5E9;">
                        <div class="text-xs font-medium uppercase tracking-wider mb-3" style="color: #2E7D32;">Размещение</div>
                        <div class="p-4 bg-white/60 rounded-xl">
                            <p id="accommodation-room" class="text-xl font-medium text-gray-800"></p>
                            <div id="accommodation-roommate" class="hidden mt-3 pt-3 border-t border-gray-200/50">
                                <span class="text-xs text-gray-500" data-i18n="retreat_roommate">Сосед:</span>
                                <div class="flex items-center gap-2 mt-1">
                                    <div id="roommate-photo" class="w-8 h-8 rounded-full bg-white overflow-hidden flex items-center justify-center">
                                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                        </svg>
                                    </div>
                                    <span id="roommate-name" class="text-sm font-medium text-gray-700"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Самостоятельное проживание -->
                    <div id="self-accommodation-card" class="hidden rounded-2xl p-5" style="background: #FFF3E0;">
                        <div class="text-xs font-medium uppercase tracking-wider mb-3" style="color: #E65100;">Размещение</div>
                        <div class="p-4 bg-white/60 rounded-xl">
                            <p class="text-xl font-medium text-gray-800" data-i18n="retreat_self_accommodation">Самостоятельное</p>
                        </div>
                    </div>

                    <!-- Трансфер -->
                    <div id="transfer-card" class="hidden rounded-2xl p-5" style="background: #FFF3CD;">
                        <div class="text-xs font-medium uppercase tracking-wider mb-3" style="color: #997A00;">Трансфер</div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <!-- Прилёт -->
                            <div id="arrival-card" class="hidden p-4 bg-white/60 rounded-xl">
                                <div class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-3">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                                    </svg>
                                    Прилёт
                                </div>
                                <div id="arrival-datetime" class="text-xl font-medium text-gray-800"></div>
                                <div id="arrival-flight" class="text-sm text-gray-500"></div>
                                <div id="arrival-taxi" class="hidden mt-3">
                                    <span class="inline-flex items-center gap-1 text-xs font-medium px-2 py-1 rounded" style="background: #C8E6C9; color: #2E7D32;">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                        <span data-i18n="retreat_taxi_ordered">Такси заказано</span>
                                    </span>
                                </div>
                            </div>

                            <!-- Вылет -->
                            <div id="departure-card" class="hidden p-4 bg-white/60 rounded-xl">
                                <div class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-3">
                                    <svg class="w-4 h-4 rotate-180" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                                    </svg>
                                    Вылет
                                </div>
                                <div id="departure-datetime" class="text-xl font-medium text-gray-800"></div>
                                <div id="departure-flight" class="text-sm text-gray-500"></div>
                                <div id="departure-taxi" class="hidden mt-3">
                                    <span class="inline-flex items-center gap-1 text-xs font-medium px-2 py-1 rounded" style="background: #C8E6C9; color: #2E7D32;">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                        <span data-i18n="retreat_taxi_ordered">Такси заказано</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Футер с соцсетями -->
        <footer class="bg-srsk-green">
            <div class="max-w-6xl mx-auto px-4 md:px-6 lg:px-8 py-6">
                <div class="flex flex-col items-center gap-4">
                    <p class="text-white/80 text-sm" data-i18n="retreat_join_community">Присоединяйтесь к Шри Рупа Сева Кундже</p>
                    <div class="flex flex-wrap justify-center gap-3">
                        <!-- Website -->
                        <a href="https://www.rupaseva.com" target="_blank" class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center hover:bg-white/30 transition-colors text-white">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                            </svg>
                        </a>
                        <!-- Telegram -->
                        <a href="https://t.me/rupaseva" target="_blank" class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center hover:bg-[#26A5E4] transition-colors text-white">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                            </svg>
                        </a>
                        <!-- YouTube -->
                        <a href="https://www.youtube.com/@Rupaseva" target="_blank" class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center hover:bg-[#FF0000] transition-colors text-white">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                            </svg>
                        </a>
                        <!-- RuTube -->
                        <a href="https://rutube.ru/channel/67606039/" target="_blank" class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center hover:bg-black transition-colors text-white">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12.76 11.54c.56 0 .86-.24.86-.72 0-.5-.3-.74-.86-.74h-1.12v1.46h1.12zm8.67-7.38v15.68a2.62 2.62 0 01-2.62 2.62H5.2a2.62 2.62 0 01-2.62-2.62V4.16A2.62 2.62 0 015.2 1.54h13.61a2.62 2.62 0 012.62 2.62zm-5.27 6.4c0-1.7-1.18-2.7-3.14-2.7H9.5v8.3h1.94v-2.88h.94l1.42 2.88h2.12l-1.68-3.18c.96-.46 1.52-1.36 1.52-2.42z"/>
                            </svg>
                        </a>
                        <!-- Instagram -->
                        <a href="https://www.instagram.com/rupaseva/" target="_blank" class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center hover:bg-gradient-to-br hover:from-[#833AB4] hover:via-[#FD1D1D] hover:to-[#F77737] transition-colors text-white">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.789.306-1.459.717-2.126 1.384S.935 3.35.63 4.14C.333 4.905.131 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.261 2.148.558 2.913.306.788.717 1.459 1.384 2.126.667.666 1.336 1.079 2.126 1.384.766.296 1.636.499 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.788-.306 1.459-.718 2.126-1.384.666-.667 1.079-1.335 1.384-2.126.296-.765.499-1.636.558-2.913.06-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.149-.558-2.913-.306-.789-.718-1.459-1.384-2.126C21.319 1.347 20.651.935 19.86.63c-.765-.297-1.636-.499-2.913-.558C15.667.012 15.26 0 12 0zm0 2.16c3.203 0 3.585.016 4.85.071 1.17.055 1.805.249 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.266.07 1.646.07 4.85s-.015 3.585-.074 4.85c-.061 1.17-.256 1.805-.421 2.227-.224.562-.479.96-.899 1.382-.419.419-.824.679-1.38.896-.42.164-1.065.36-2.235.413-1.274.057-1.649.07-4.859.07-3.211 0-3.586-.015-4.859-.074-1.171-.061-1.816-.256-2.236-.421-.569-.224-.96-.479-1.379-.899-.421-.419-.69-.824-.9-1.38-.165-.42-.359-1.065-.42-2.235-.045-1.26-.061-1.649-.061-4.844 0-3.196.016-3.586.061-4.861.061-1.17.255-1.814.42-2.234.21-.57.479-.96.9-1.381.419-.419.81-.689 1.379-.898.42-.166 1.051-.361 2.221-.421 1.275-.045 1.65-.06 4.859-.06l.045.03zm0 3.678c-3.405 0-6.162 2.76-6.162 6.162 0 3.405 2.76 6.162 6.162 6.162 3.405 0 6.162-2.76 6.162-6.162 0-3.405-2.76-6.162-6.162-6.162zM12 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm7.846-10.405c0 .795-.646 1.44-1.44 1.44-.795 0-1.44-.646-1.44-1.44 0-.794.646-1.439 1.44-1.439.793-.001 1.44.645 1.44 1.439z"/>
                            </svg>
                        </a>
                        <!-- VK -->
                        <a href="https://vk.com/rupaseva" target="_blank" class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center hover:bg-[#0077FF] transition-colors text-white">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15.684 0H8.316C1.592 0 0 1.592 0 8.316v7.368C0 22.408 1.592 24 8.316 24h7.368C22.408 24 24 22.408 24 15.684V8.316C24 1.592 22.391 0 15.684 0zm3.692 17.123h-1.744c-.66 0-.864-.525-2.05-1.727-1.033-1-1.49-1.135-1.744-1.135-.356 0-.458.102-.458.593v1.575c0 .424-.135.678-1.253.678-1.846 0-3.896-1.118-5.335-3.202C4.624 10.857 4.03 8.57 4.03 8.096c0-.254.102-.491.593-.491h1.744c.44 0 .61.203.78.677.863 2.49 2.303 4.675 2.896 4.675.22 0 .322-.102.322-.66V9.721c-.068-1.186-.695-1.287-.695-1.71 0-.203.17-.407.44-.407h2.744c.373 0 .508.203.508.643v3.473c0 .372.17.508.271.508.22 0 .407-.136.813-.542 1.254-1.406 2.151-3.574 2.151-3.574.119-.254.322-.491.763-.491h1.744c.525 0 .644.27.525.643-.22 1.017-2.354 4.031-2.354 4.031-.186.305-.254.44 0 .78.186.254.796.779 1.203 1.253.745.847 1.32 1.558 1.473 2.05.17.49-.085.744-.576.744z"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Модалка регистрации -->
    <div id="registration-modal" class="modal-backdrop hidden">
        <div class="modal max-w-md">
            <!-- Хедер модалки -->
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="retreat_registration_title">Регистрация на ретрит</h2>
                <button onclick="closeRegistrationModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <!-- Индикатор шагов -->
                <div class="step-indicator">
                    <div class="step-dot active" data-step="1"></div>
                    <div class="step-dot" data-step="2"></div>
                    <div class="step-dot" data-step="3"></div>
                </div>

                <!-- Алерт ошибки -->
                <div id="modal-error" class="alert alert-error hidden mb-4"></div>

                <!-- Шаг 1: Email -->
                <div id="step-email" class="form-step active">
                    <div class="text-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-800" data-i18n="retreat_enter_email">Введите ваш email</h3>
                        <p class="text-sm text-gray-500 mt-1" data-i18n="retreat_email_hint">Мы проверим, есть ли у вас аккаунт</p>
                    </div>

                    <form id="email-form" class="space-y-4">
                        <div class="form-group">
                            <input type="email" id="check-email" class="input text-center text-lg" required
                                   placeholder="email@example.com" autocomplete="email">
                        </div>
                        <button type="submit" class="btn-primary w-full">
                            <span data-i18n="continue">Продолжить</span>
                            <svg id="email-spinner" class="w-5 h-5 animate-spin hidden" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </form>
                </div>

                <!-- Шаг 2а: Логин (для существующих) -->
                <div id="step-login" class="form-step">
                    <div class="text-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">
                            <span data-i18n="retreat_welcome_back">Добро пожаловать обратно,</span>
                            <span id="welcome-name" class="text-srsk-green"></span>!
                        </h3>
                        <p class="text-sm text-gray-500 mt-1" data-i18n="retreat_login_hint">Войдите, чтобы продолжить</p>
                    </div>

                    <form id="login-form" class="space-y-4">
                        <div class="form-group">
                            <label class="label" data-i18n="password">Пароль</label>
                            <div class="relative">
                                <input type="password" id="login-password" class="input pr-10" required autocomplete="current-password">
                                <button type="button" onclick="toggleLoginPassword()" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    <svg class="w-5 h-5" id="login-eye-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary w-full">
                            <span data-i18n="retreat_login_continue">Войти и продолжить</span>
                            <svg id="login-spinner" class="w-5 h-5 animate-spin hidden" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                        <div class="text-center">
                            <button type="button" onclick="forgotPassword()" class="text-sm text-gray-500 hover:text-srsk-green">
                                <span data-i18n="forgot_password">Забыли пароль?</span>
                            </button>
                        </div>
                    </form>
                    <button type="button" onclick="goToStep('email')" class="w-full text-center text-sm text-gray-500 hover:text-gray-700 mt-4">
                        <span data-i18n="use_different_email">Использовать другой email</span>
                    </button>
                </div>

                <!-- Шаг 2б: Регистрация (для новых) -->
                <div id="step-register" class="form-step">
                    <div class="text-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-800" data-i18n="retreat_create_account">Создайте аккаунт</h3>
                        <p class="text-sm text-gray-500 mt-1" id="register-email-display"></p>
                    </div>

                    <form id="register-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="form-group">
                                <label class="label">
                                    <span data-i18n="first_name">Имя</span>
                                    <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="reg-first-name" class="input" required>
                            </div>
                            <div class="form-group">
                                <label class="label">
                                    <span data-i18n="last_name">Фамилия</span>
                                    <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="reg-last-name" class="input" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="label" data-i18n="spiritual_name">Духовное имя</label>
                            <input type="text" id="reg-spiritual-name" class="input">
                        </div>

                        <div class="form-group">
                            <label class="label">
                                <span data-i18n="phone">Телефон</span>
                                <span class="text-red-500">*</span>
                            </label>
                            <input type="tel" id="reg-phone" class="input" required placeholder="+7 999 123-45-67">
                        </div>

                        <div class="form-group">
                            <label class="label" data-i18n="telegram">Telegram</label>
                            <input type="text" id="reg-telegram" class="input" placeholder="@username">
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div class="form-group">
                                <label class="label">
                                    <span data-i18n="country">Страна</span>
                                    <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="reg-country" class="input" required>
                            </div>
                            <div class="form-group">
                                <label class="label" data-i18n="city">Город</label>
                                <input type="text" id="reg-city" class="input">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="label">
                                <span data-i18n="password">Пароль</span>
                                <span class="text-red-500">*</span>
                            </label>
                            <input type="password" id="reg-password" class="input" required minlength="6" autocomplete="new-password">
                            <p class="text-xs text-gray-500 mt-1" data-i18n="password_hint">Минимум 6 символов</p>
                        </div>

                        <button type="submit" class="btn-primary w-full">
                            <span data-i18n="continue">Продолжить</span>
                            <svg id="register-spinner" class="w-5 h-5 animate-spin hidden" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </form>
                    <button type="button" onclick="goToStep('email')" class="w-full text-center text-sm text-gray-500 hover:text-gray-700 mt-4">
                        <span data-i18n="use_different_email">Использовать другой email</span>
                    </button>
                </div>

                <!-- Шаг 3: Форма заявки -->
                <div id="step-application" class="form-step">
                    <div class="text-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-800" data-i18n="retreat_application_title">Заявка на ретрит</h3>
                        <p class="text-sm text-srsk-green font-medium" id="application-retreat-name"></p>
                    </div>

                    <!-- Сообщение для залогиненных пользователей -->
                    <div id="logged-in-notice" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <p class="text-sm text-green-800"><span id="logged-in-user-name" class="font-medium"></span>, <span data-i18n="retreat_has_contact_info"></span></p>
                    </div>

                    <form id="application-form" class="space-y-4">
                        <div class="form-group">
                            <label class="label" data-i18n="retreat_companions">С кем едете</label>
                            <textarea id="app-companions" class="input" rows="2" placeholder="Имена попутчиков, если едете не один"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="label" data-i18n="retreat_accommodation_wishes">Пожелания по размещению</label>
                            <textarea id="app-accommodation" class="input" rows="3" placeholder="Соседи, этаж, особенности..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="label" data-i18n="retreat_questions">Вопросы организаторам</label>
                            <textarea id="app-questions" class="input" rows="3" placeholder="Ваши вопросы..."></textarea>
                        </div>

                        <button type="submit" class="btn-primary w-full">
                            <span data-i18n="retreat_submit">Отправить заявку</span>
                            <svg id="application-spinner" class="w-5 h-5 animate-spin hidden" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </form>
                </div>

                <!-- Успешная отправка -->
                <div id="step-success" class="form-step">
                    <div class="text-center py-6">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2" data-i18n="retreat_success">Заявка отправлена!</h3>
                        <p class="text-gray-500 mb-6" data-i18n="retreat_success_hint">Мы свяжемся с вами для подтверждения</p>
                        <a href="/guest-portal/retreats.html" class="btn-primary">
                            <span data-i18n="retreat_view_my_retreats">Мои ретриты</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/date-utils.js"></script>
    <script src="guest-portal/js/portal-config.js"></script>
    <script>
        const db = window.portalSupabase;
        let currentLang = localStorage.getItem('srsk_lang') || 'ru';
        let translations = {};
        let currentRetreat = null;
        let currentUser = null;
        let checkEmail = '';

        // Fallback переводы
        const fallbackTranslations = {
            loading: { ru: 'Загрузка...', en: 'Loading...', hi: 'लोड हो रहा है...' },
            retreat_not_found: { ru: 'Ретрит не найден', en: 'Retreat not found', hi: 'रिट्रीट नहीं मिला' },
            retreat_not_found_hint: { ru: 'Проверьте ссылку или вернитесь на главную', en: 'Check the link or go back home', hi: 'लिंक जांचें या होम पेज पर वापस जाएं' },
            retreat_go_home: { ru: 'На главную', en: 'Go home', hi: 'होम पेज' },
            retreat_register_btn: { ru: 'Подать заявку', en: 'Apply', hi: 'आवेदन करें' },
            retreat_registration_closed: { ru: 'Регистрация на этот ретрит закрыта', en: 'Registration for this retreat is closed', hi: 'इस रिट्रीट के लिए पंजीकरण बंद है' },
            retreat_already_registered: { ru: 'Вы уже зарегистрированы на этот ретрит', en: 'You are already registered for this retreat', hi: 'आप पहले से इस रिट्रीट के लिए पंजीकृत हैं' },
            retreat_view_my_retreats: { ru: 'Мои ретриты', en: 'My retreats', hi: 'मेरे रिट्रीट' },
            retreat_registration_title: { ru: 'Регистрация на ретрит', en: 'Retreat registration', hi: 'रिट्रीट पंजीकरण' },
            retreat_enter_email: { ru: 'Введите ваш email', en: 'Enter your email', hi: 'अपना ईमेल दर्ज करें' },
            retreat_email_hint: { ru: 'Мы проверим, есть ли у вас аккаунт', en: 'We will check if you have an account', hi: 'हम जांचेंगे कि आपका खाता है या नहीं' },
            continue: { ru: 'Продолжить', en: 'Continue', hi: 'जारी रखें' },
            retreat_welcome_back: { ru: 'Добро пожаловать обратно,', en: 'Welcome back,', hi: 'वापसी पर स्वागत है,' },
            retreat_login_hint: { ru: 'Войдите, чтобы продолжить', en: 'Sign in to continue', hi: 'जारी रखने के लिए साइन इन करें' },
            password: { ru: 'Пароль', en: 'Password', hi: 'पासवर्ड' },
            retreat_login_continue: { ru: 'Войти и продолжить', en: 'Sign in and continue', hi: 'साइन इन करें और जारी रखें' },
            forgot_password: { ru: 'Забыли пароль?', en: 'Forgot password?', hi: 'पासवर्ड भूल गए?' },
            use_different_email: { ru: 'Использовать другой email', en: 'Use a different email', hi: 'अलग ईमेल का उपयोग करें' },
            retreat_create_account: { ru: 'Создайте аккаунт', en: 'Create an account', hi: 'खाता बनाएं' },
            first_name: { ru: 'Имя', en: 'First name', hi: 'नाम' },
            last_name: { ru: 'Фамилия', en: 'Last name', hi: 'उपनाम' },
            spiritual_name: { ru: 'Духовное имя', en: 'Spiritual name', hi: 'आध्यात्मिक नाम' },
            phone: { ru: 'Телефон', en: 'Phone', hi: 'फोन' },
            telegram: { ru: 'Telegram', en: 'Telegram', hi: 'टेलीग्राम' },
            country: { ru: 'Страна', en: 'Country', hi: 'देश' },
            city: { ru: 'Город', en: 'City', hi: 'शहर' },
            password_hint: { ru: 'Минимум 6 символов', en: 'At least 6 characters', hi: 'कम से कम 6 अक्षर' },
            retreat_application_title: { ru: 'Заявка на ретрит', en: 'Retreat application', hi: 'रिट्रीट आवेदन' },
            retreat_companions: { ru: 'С кем едете', en: 'Traveling with', hi: 'किसके साथ यात्रा' },
            retreat_accommodation_wishes: { ru: 'Пожелания по размещению', en: 'Accommodation preferences', hi: 'आवास प्राथमिकताएं' },
            retreat_questions: { ru: 'Вопросы организаторам', en: 'Questions for organizers', hi: 'आयोजकों के लिए प्रश्न' },
            retreat_submit: { ru: 'Отправить заявку', en: 'Submit application', hi: 'आवेदन जमा करें' },
            retreat_success: { ru: 'Заявка отправлена!', en: 'Application submitted!', hi: 'आवेदन जमा हो गया!' },
            retreat_success_hint: { ru: 'Мы свяжемся с вами для подтверждения', en: 'We will contact you for confirmation', hi: 'हम पुष्टि के लिए आपसे संपर्क करेंगे' },
            error_invalid_credentials: { ru: 'Неверный пароль', en: 'Invalid password', hi: 'गलत पासवर्ड' },
            error_email_taken: { ru: 'Этот email уже зарегистрирован', en: 'This email is already registered', hi: 'यह ईमेल पहले से पंजीकृत है' },
            error_unknown: { ru: 'Произошла ошибка', en: 'An error occurred', hi: 'एक त्रुटि हुई' },
            error_password_reset_sent: { ru: 'Ссылка для сброса пароля отправлена на вашу почту', en: 'Password reset link sent to your email', hi: 'पासवर्ड रीसेट लिंक आपके ईमेल पर भेजा गया' },
            back_to_profile: { ru: 'в профиль', en: 'to profile', hi: 'प्रोफाइल' },
            retreat_join_community: { ru: 'Присоединяйтесь к Шри Рупа Сева Кундже', en: 'Join Sri Rupa Seva Kunj', hi: 'श्री रूपा सेवा कुंज से जुड़ें' },
            retreat_your_info: { ru: 'Ваша информация', en: 'Your information', hi: 'आपकी जानकारी' },
            retreat_accommodation: { ru: 'Размещение', en: 'Accommodation', hi: 'आवास' },
            retreat_self_accommodation: { ru: 'Самостоятельное', en: 'Self-arranged', hi: 'स्व-व्यवस्थित' },
            retreat_roommate: { ru: 'Сосед:', en: 'Roommate:', hi: 'रूममेट:' },
            retreat_arrival: { ru: 'Заезд', en: 'Arrival', hi: 'आगमन' },
            retreat_departure: { ru: 'Выезд', en: 'Departure', hi: 'प्रस्थान' },
            retreat_taxi_ordered: { ru: 'Такси заказано', en: 'Taxi ordered', hi: 'टैक्सी बुक' }
        };

        // Загрузка переводов
        async function loadTranslations() {
            try {
                const { data } = await db
                    .from('translations')
                    .select('key, ru, en, hi');

                if (data) {
                    for (const row of data) {
                        translations[row.key] = { ru: row.ru, en: row.en, hi: row.hi };
                    }
                }
            } catch (e) {
                console.warn('Не удалось загрузить переводы:', e);
            }

            // Добавляем fallback
            for (const [key, value] of Object.entries(fallbackTranslations)) {
                if (!translations[key]) {
                    translations[key] = value;
                }
            }
        }

        // Получить перевод
        function t(key) {
            const trans = translations[key] || fallbackTranslations[key];
            if (!trans) return key;
            return trans[currentLang] || trans['en'] || trans['ru'] || key;
        }

        // Обновить все переводы
        function updateTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                el.textContent = t(el.dataset.i18n);
            });
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === currentLang);
            });
        }

        // Получить название на текущем языке
        function getName(item) {
            const key = `name_${currentLang}`;
            return item[key] || item.name_en || item.name_ru || '';
        }

        // Получить описание на текущем языке
        function getDescription(item) {
            const key = `description_${currentLang}`;
            return item[key] || item.description_en || item.description_ru || '';
        }

        // Форматирование диапазона дат
        function formatDateRange(startDate, endDate) {
            const start = DateUtils.parseDate(startDate);
            const end = DateUtils.parseDate(endDate);
            const locale = currentLang === 'ru' ? 'ru-RU' : currentLang === 'hi' ? 'hi-IN' : 'en-US';

            if (start.getMonth() === end.getMonth() && start.getFullYear() === end.getFullYear()) {
                return `${start.getDate()}–${end.getDate()} ${start.toLocaleDateString(locale, { month: 'long', year: 'numeric' })}`;
            }

            return `${start.toLocaleDateString(locale, { day: 'numeric', month: 'short' })} – ${end.toLocaleDateString(locale, { day: 'numeric', month: 'short', year: 'numeric' })}`;
        }

        // Загрузка данных ретрита
        async function loadRetreat() {
            const params = new URLSearchParams(location.search);
            const id = params.get('id');
            const slug = params.get('slug');

            if (!id && !slug) {
                showNotFound();
                return;
            }

            let query = db.from('retreats').select('*');
            if (id) {
                query = query.eq('id', id);
            } else if (slug) {
                query = query.eq('slug', slug);
            }

            const { data: retreat, error } = await query.single();

            if (error || !retreat) {
                showNotFound();
                return;
            }

            currentRetreat = retreat;
            renderRetreat(retreat);

            // Проверяем авторизацию для "уже зарегистрирован"
            await checkExistingRegistration();

            // Показываем контент
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        }

        // Показать 404
        function showNotFound() {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('not-found').classList.remove('hidden');
        }

        // Рендер ретрита
        function renderRetreat(retreat) {
            // Картинка
            const img = document.getElementById('retreat-image');
            if (retreat.image_url) {
                img.src = retreat.image_url;
                img.alt = getName(retreat);
            } else {
                // Заглушка
                img.src = 'data:image/svg+xml,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" width="800" height="400" viewBox="0 0 800 400">
                        <rect fill="#e5e7eb" width="800" height="400"/>
                        <text fill="#9ca3af" font-family="sans-serif" font-size="48" x="50%" y="50%" text-anchor="middle" dy=".3em">🕉</text>
                    </svg>
                `);
            }

            // Название и даты
            document.getElementById('retreat-name').textContent = getName(retreat);
            document.getElementById('retreat-dates').textContent = formatDateRange(retreat.start_date, retreat.end_date);

            // Описание
            const description = getDescription(retreat);
            document.getElementById('retreat-description').textContent = description;

            // Open Graph
            document.getElementById('og-title').content = getName(retreat);
            document.getElementById('og-description').content = description?.substring(0, 200) || '';
            if (retreat.image_url) {
                document.getElementById('og-image').content = retreat.image_url;
            }
            document.getElementById('og-url').content = window.location.href;
            document.title = getName(retreat) + ' | Rupa Seva';

            // Кнопка регистрации
            if (retreat.registration_open) {
                document.getElementById('registration-open').classList.remove('hidden');
            } else {
                document.getElementById('registration-closed').classList.remove('hidden');
            }
        }

        // Проверка существующей регистрации
        async function checkExistingRegistration() {
            const { data: { session } } = await db.auth.getSession();
            if (!session) return;

            // Показываем ссылку "в профиль" для залогиненных
            document.getElementById('back-to-profile').classList.remove('hidden');
            document.getElementById('back-to-profile').classList.add('flex');
            document.getElementById('back-placeholder').classList.add('hidden');

            // Получаем vaishnava_id
            const { data: vaishnava } = await db
                .from('vaishnavas')
                .select('id, first_name, spiritual_name')
                .eq('user_id', session.user.id)
                .single();

            if (!vaishnava) return;

            currentUser = {
                id: vaishnava.id,
                email: session.user.email,
                firstName: vaishnava.first_name,
                spiritualName: vaishnava.spiritual_name
            };

            // Проверяем регистрацию
            const { data: registration } = await db
                .from('retreat_registrations')
                .select('id')
                .eq('vaishnava_id', vaishnava.id)
                .eq('retreat_id', currentRetreat.id)
                .eq('is_deleted', false)
                .single();

            if (registration) {
                // Уже зарегистрирован
                document.getElementById('registration-open').classList.add('hidden');
                document.getElementById('already-registered').classList.remove('hidden');

                // Загружаем дополнительную информацию
                await loadGuestInfo(vaishnava.id, currentRetreat.id);
            }
        }

        // Загрузка персональной информации гостя
        async function loadGuestInfo(vaishnavId, retreatId) {
            // Сначала получаем registration_id
            const { data: registration } = await db
                .from('retreat_registrations')
                .select('id')
                .eq('vaishnava_id', vaishnavId)
                .eq('retreat_id', retreatId)
                .eq('is_deleted', false)
                .maybeSingle();

            if (!registration) return;

            // Загружаем параллельно: размещение и трансферы
            const [accommodationResult, transfersResult] = await Promise.all([
                db.from('residents')
                    .select(`
                        id, room_id,
                        room:rooms(id, number, building:buildings(id, name_ru, name_en, name_hi))
                    `)
                    .eq('vaishnava_id', vaishnavId)
                    .eq('retreat_id', retreatId)
                    .maybeSingle(),
                db.from('guest_transfers')
                    .select('*')
                    .eq('registration_id', registration.id)
            ]);

            const accommodation = accommodationResult.data;
            const transfers = transfersResult.data || [];

            let hasInfo = false;

            // Размещение
            if (accommodation) {
                hasInfo = true;
                if (accommodation.room_id && accommodation.room) {
                    // Размещение в ашраме
                    document.getElementById('accommodation-card').classList.remove('hidden');
                    const buildingName = getName(accommodation.room.building);
                    document.getElementById('accommodation-room').textContent =
                        `${buildingName}, №${accommodation.room.number}`;

                    // Сосед
                    const { data: roommates } = await db
                        .from('residents')
                        .select('vaishnava:vaishnavas(id, first_name, spiritual_name, photo_url)')
                        .eq('room_id', accommodation.room_id)
                        .eq('retreat_id', retreatId)
                        .neq('vaishnava_id', vaishnavId);

                    if (roommates && roommates.length > 0 && roommates[0].vaishnava) {
                        const roommate = roommates[0].vaishnava;
                        document.getElementById('accommodation-roommate').classList.remove('hidden');
                        document.getElementById('roommate-name').textContent =
                            roommate.spiritual_name || roommate.first_name || '';
                        if (roommate.photo_url) {
                            document.getElementById('roommate-photo').innerHTML =
                                `<img src="${roommate.photo_url}" class="w-full h-full object-cover" alt="">`;
                        }
                    }
                } else {
                    // Самостоятельное проживание
                    document.getElementById('self-accommodation-card').classList.remove('hidden');
                }
            }

            // Трансферы
            const arrival = transfers.find(t => t.direction === 'arrival');
            const departure = transfers.find(t => t.direction === 'departure');

            if (arrival || departure) {
                hasInfo = true;
                document.getElementById('transfer-card').classList.remove('hidden');

                if (arrival) {
                    document.getElementById('arrival-card').classList.remove('hidden');
                    document.getElementById('arrival-datetime').textContent =
                        formatTransferDateTime(arrival.flight_datetime);
                    if (arrival.flight_number) {
                        document.getElementById('arrival-flight').textContent =
                            `Рейс: ${arrival.flight_number}`;
                    }
                    if (arrival.taxi_status === 'ordered') {
                        document.getElementById('arrival-taxi').classList.remove('hidden');
                    }
                }

                if (departure) {
                    document.getElementById('departure-card').classList.remove('hidden');
                    document.getElementById('departure-datetime').textContent =
                        formatTransferDateTime(departure.flight_datetime);
                    if (departure.flight_number) {
                        document.getElementById('departure-flight').textContent =
                            `Рейс: ${departure.flight_number}`;
                    }
                    if (departure.taxi_status === 'ordered') {
                        document.getElementById('departure-taxi').classList.remove('hidden');
                    }
                }
            }

            // Показываем секцию если есть данные
            if (hasInfo) {
                document.getElementById('guest-info-section').classList.remove('hidden');
            }
        }

        // Форматирование даты/времени трансфера
        function formatTransferDateTime(datetime) {
            if (!datetime) return '';
            const date = new Date(datetime);
            const locale = currentLang === 'ru' ? 'ru-RU' : currentLang === 'hi' ? 'hi-IN' : 'en-US';
            return date.toLocaleDateString(locale, {
                day: 'numeric',
                month: 'long',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Открыть модалку регистрации
        function openRegistrationModal() {
            document.getElementById('registration-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Если уже авторизован — сразу на форму заявки
            if (currentUser) {
                goToStep('application');
            }
        }

        // Закрыть модалку
        function closeRegistrationModal() {
            document.getElementById('registration-modal').classList.add('hidden');
            document.body.style.overflow = '';
            resetForms();
        }

        // Сброс форм
        function resetForms() {
            document.getElementById('email-form').reset();
            document.getElementById('login-form').reset();
            document.getElementById('register-form').reset();
            document.getElementById('application-form').reset();
            hideError();
            goToStep('email');
        }

        // Переход к шагу
        function goToStep(step) {
            // Скрываем все шаги
            document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));

            // Показываем нужный
            const stepEl = document.getElementById(`step-${step}`);
            if (stepEl) {
                stepEl.classList.add('active');
            }

            // Обновляем индикатор
            const stepMap = { 'email': 1, 'login': 2, 'register': 2, 'application': 3, 'success': 3 };
            const currentStep = stepMap[step] || 1;

            document.querySelectorAll('.step-dot').forEach(dot => {
                const dotStep = parseInt(dot.dataset.step);
                dot.classList.remove('active', 'completed');
                if (dotStep < currentStep) {
                    dot.classList.add('completed');
                } else if (dotStep === currentStep) {
                    dot.classList.add('active');
                }
            });

            // Название ретрита на форме заявки
            if (step === 'application') {
                document.getElementById('application-retreat-name').textContent = getName(currentRetreat);
                // Показываем сообщение для залогиненных пользователей
                const notice = document.getElementById('logged-in-notice');
                if (currentUser) {
                    const userName = currentUser.spiritual_name ||
                        `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim() ||
                        currentUser.email;
                    document.getElementById('logged-in-user-name').textContent = userName;
                    notice.classList.remove('hidden');
                } else {
                    notice.classList.add('hidden');
                }
            }
        }

        // Показать ошибку
        function showError(messageKey) {
            const alert = document.getElementById('modal-error');
            alert.textContent = t(messageKey);
            alert.classList.remove('hidden');
        }

        // Скрыть ошибку
        function hideError() {
            document.getElementById('modal-error').classList.add('hidden');
        }

        // Toggle пароля в форме логина
        function toggleLoginPassword() {
            const input = document.getElementById('login-password');
            const icon = document.getElementById('login-eye-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>`;
            } else {
                input.type = 'password';
                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>`;
            }
        }

        // Забыли пароль
        async function forgotPassword() {
            if (!checkEmail) return;

            try {
                await db.auth.resetPasswordForEmail(checkEmail, {
                    redirectTo: window.location.origin + '/reset-password/'
                });
                showError('error_password_reset_sent');
            } catch (e) {
                console.error('Forgot password error:', e);
            }
        }

        // Шаг 1: Проверка email
        async function handleEmailCheck(e) {
            e.preventDefault();
            hideError();

            const email = document.getElementById('check-email').value.trim().toLowerCase();
            const spinner = document.getElementById('email-spinner');
            spinner.classList.remove('hidden');

            checkEmail = email;

            try {
                // Проверяем есть ли пользователь
                const { data: vaishnava } = await db
                    .from('vaishnavas')
                    .select('id, first_name, spiritual_name, user_id')
                    .ilike('email', email)
                    .maybeSingle();

                if (vaishnava) {
                    // Найден — показываем форму логина
                    const displayName = vaishnava.spiritual_name || vaishnava.first_name;
                    document.getElementById('welcome-name').textContent = displayName;
                    goToStep('login');
                } else {
                    // Не найден — форма регистрации
                    document.getElementById('register-email-display').textContent = email;
                    goToStep('register');
                }
            } catch (error) {
                console.error('Email check error:', error);
                showError('error_unknown');
            } finally {
                spinner.classList.add('hidden');
            }
        }

        // Шаг 2а: Логин
        async function handleLogin(e) {
            e.preventDefault();
            hideError();

            const password = document.getElementById('login-password').value;
            const spinner = document.getElementById('login-spinner');
            spinner.classList.remove('hidden');

            try {
                const { data, error } = await db.auth.signInWithPassword({
                    email: checkEmail,
                    password: password
                });

                if (error) {
                    showError('error_invalid_credentials');
                    return;
                }

                // Получаем данные пользователя
                const { data: vaishnava } = await db
                    .from('vaishnavas')
                    .select('id, first_name, spiritual_name')
                    .eq('user_id', data.user.id)
                    .single();

                if (vaishnava) {
                    currentUser = {
                        id: vaishnava.id,
                        email: checkEmail,
                        firstName: vaishnava.first_name,
                        spiritualName: vaishnava.spiritual_name
                    };
                    goToStep('application');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('error_unknown');
            } finally {
                spinner.classList.add('hidden');
            }
        }

        // Шаг 2б: Регистрация
        async function handleRegister(e) {
            e.preventDefault();
            hideError();

            const spinner = document.getElementById('register-spinner');
            spinner.classList.remove('hidden');

            const userData = {
                email: checkEmail,
                password: document.getElementById('reg-password').value,
                firstName: document.getElementById('reg-first-name').value.trim(),
                lastName: document.getElementById('reg-last-name').value.trim(),
                spiritualName: document.getElementById('reg-spiritual-name').value.trim(),
                phone: document.getElementById('reg-phone').value.trim(),
                telegram: document.getElementById('reg-telegram').value.trim().replace('@', ''),
                country: document.getElementById('reg-country').value.trim(),
                city: document.getElementById('reg-city').value.trim()
            };

            try {
                // Создаём auth user
                const { data: authData, error: signUpError } = await db.auth.signUp({
                    email: userData.email,
                    password: userData.password
                });

                if (signUpError) {
                    if (signUpError.message.includes('already registered')) {
                        showError('error_email_taken');
                    } else {
                        showError('error_unknown');
                    }
                    return;
                }

                // Создаём vaishnava через RPC функцию (обходит RLS)
                const { data: registerResult, error: rpcError } = await db.rpc('register_guest', {
                    p_email: userData.email,
                    p_first_name: userData.firstName,
                    p_last_name: userData.lastName,
                    p_spiritual_name: userData.spiritualName || null,
                    p_phone: userData.phone || null,
                    p_telegram_username: userData.telegram || null,
                    p_country: userData.country || null,
                    p_city: userData.city || null
                });

                if (rpcError) {
                    console.error('Register guest RPC error:', rpcError);
                    showError('error_unknown');
                    return;
                }

                const result = registerResult?.[0];
                if (!result || !result.success) {
                    console.error('Register guest failed:', result?.error_code);
                    showError('error_unknown');
                    return;
                }

                const vaishnava = { id: result.vaishnava_id };

                currentUser = {
                    id: vaishnava.id,
                    email: userData.email,
                    firstName: userData.firstName,
                    spiritualName: userData.spiritualName
                };

                goToStep('application');

            } catch (error) {
                console.error('Register error:', error);
                showError('error_unknown');
            } finally {
                spinner.classList.add('hidden');
            }
        }

        // Шаг 3: Отправка заявки
        async function handleApplication(e) {
            e.preventDefault();
            hideError();

            const spinner = document.getElementById('application-spinner');
            spinner.classList.remove('hidden');

            const applicationData = {
                retreat_id: currentRetreat.id,
                vaishnava_id: currentUser.id,
                status: 'guest',
                companions: document.getElementById('app-companions').value.trim() || null,
                accommodation_wishes: document.getElementById('app-accommodation').value.trim() || null,
                guest_questions: document.getElementById('app-questions').value.trim() || null,
                registration_date: DateUtils.toISO(new Date())
            };

            try {
                const { error } = await db
                    .from('retreat_registrations')
                    .insert(applicationData);

                if (error) {
                    console.error('Application error:', error);
                    showError('error_unknown');
                    return;
                }

                goToStep('success');

            } catch (error) {
                console.error('Application error:', error);
                showError('error_unknown');
            } finally {
                spinner.classList.add('hidden');
            }
        }

        // Инициализация
        async function init() {
            await loadTranslations();
            updateTranslations();

            // Обработчики форм
            document.getElementById('email-form').addEventListener('submit', handleEmailCheck);
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('application-form').addEventListener('submit', handleApplication);

            // Переключатель языка
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentLang = btn.dataset.lang;
                    localStorage.setItem('srsk_lang', currentLang);
                    updateTranslations();

                    // Перерендерим ретрит с новым языком
                    if (currentRetreat) {
                        renderRetreat(currentRetreat);
                    }
                });
            });

            // Закрытие модалки по клику на фон
            document.getElementById('registration-modal').addEventListener('click', (e) => {
                if (e.target.id === 'registration-modal') {
                    closeRegistrationModal();
                }
            });

            // Закрытие по Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeRegistrationModal();
                }
            });

            // Загружаем ретрит
            await loadRetreat();
        }

        init();
    </script>
</body>
</html>
