<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script src="../js/color-init.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è ‚Äî –®–†–°–ö</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 flex-1">

        <div class="mb-6">
            <h1 class="text-2xl font-bold" data-i18n="inventory_title">–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</h1>
            <p class="text-sm opacity-60" id="inventoriesCount">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>

        <!-- Tabs -->
        <div class="tabs tabs-boxed bg-base-100 p-1 mb-6 inline-flex" id="mainTabs">
            <button class="tab tab-active" data-tab="new" onclick="switchTab('new')" data-i18n="new_inventory">–ù–æ–≤–∞—è</button>
            <button class="tab" data-tab="in_progress" onclick="switchTab('in_progress')" data-i18n="in_progress_inventories">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</button>
            <button class="tab" data-tab="completed" onclick="switchTab('completed')" data-i18n="completed_inventories">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</button>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø—Ä–∞–≤ -->
        <div class="alert alert-warning mb-6" data-no-permission="conduct_inventory" style="display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <span>–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ. –î–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä.</span>
        </div>

        <!-- New Inventory Tab -->
        <div id="tabNew" class="tab-pane">
            <div class="bg-base-100 rounded-lg p-6 shadow-sm max-w-xl">
                <h2 class="text-lg font-semibold mb-4" data-i18n="create_inventory">–°–æ–∑–¥–∞—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é</h2>

                <div class="space-y-4">
                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="inventory_date">–î–∞—Ç–∞</span></label>
                        <input type="date" id="inventoryDate" class="input input-bordered w-full" />
                    </div>

                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="select_categories">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</span></label>
                        <div class="flex flex-wrap gap-2" id="categoryCheckboxes">
                            <!-- Generated by JS -->
                        </div>
                    </div>

                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="notes">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</span></label>
                        <textarea id="inventoryNotes" class="textarea textarea-bordered w-full" rows="2"></textarea>
                    </div>

                    <button class="btn btn-primary w-full" onclick="createInventory()" data-i18n="create_inventory" data-permission="conduct_inventory">
                        –°–æ–∑–¥–∞—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é
                    </button>
                </div>
            </div>
        </div>

        <!-- In Progress Tab -->
        <div id="tabInProgress" class="tab-pane hidden">
            <div class="space-y-3" id="inProgressList"></div>
        </div>

        <!-- Completed Tab -->
        <div id="tabCompleted" class="tab-pane hidden">
            <div class="space-y-3" id="completedList"></div>
        </div>

        <!-- Counting Section (hidden initially) -->
        <div id="countingSection" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-lg font-semibold" id="countingTitle">–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</h2>
                    <p class="text-sm opacity-60" id="countingInfo"></p>
                </div>
                <button class="btn btn-ghost btn-sm" onclick="backToList()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    <span data-i18n="back">–ù–∞–∑–∞–¥</span>
                </button>
            </div>

            <!-- Filter by category -->
            <div class="flex flex-wrap gap-2 mb-4" id="filterCategoryButtons"></div>

            <!-- Stats -->
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="bg-base-100 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold" id="statTotal">0</div>
                    <div class="text-xs opacity-60" data-i18n="products">–ü—Ä–æ–¥—É–∫—Ç–æ–≤</div>
                </div>
                <div class="bg-base-100 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-success" id="statCounted">0</div>
                    <div class="text-xs opacity-60" data-i18n="items_counted">–ü–æ–¥—Å—á–∏—Ç–∞–Ω–æ</div>
                </div>
                <div class="bg-base-100 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-error" id="statDiscrepancies">0</div>
                    <div class="text-xs opacity-60" data-i18n="discrepancies_found">–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π</div>
                </div>
            </div>

            <!-- Search and non-zero filter -->
            <div class="flex flex-wrap items-center gap-4 mb-4">
                <div class="relative w-full sm:w-64">
                    <input type="text" id="countingSearch" class="input input-bordered input-sm w-full pl-9 pr-8" placeholder="–ü–æ–∏—Å–∫..." data-i18n-placeholder="search" oninput="onCountingSearch(this.value)" />
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 opacity-40" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <button type="button" id="countingSearchClear" class="absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 opacity-40 hover:opacity-70 hidden" onclick="clearCountingSearch()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <label class="label cursor-pointer gap-2">
                    <input type="checkbox" class="checkbox checkbox-sm" id="nonZeroFilter" onchange="toggleNonZeroFilter(this.checked)" />
                    <span class="label-text" data-i18n="only_non_zero">–¢–æ–ª—å–∫–æ –Ω–µ –Ω—É–ª–µ–≤—ã–µ</span>
                </label>
            </div>

            <!-- Items table -->
            <div class="bg-base-100 rounded-lg shadow-sm overflow-hidden">
                <table class="table table-sm">
                    <thead class="bg-base-200">
                        <tr>
                            <th data-i18n="product">–ü—Ä–æ–¥—É–∫—Ç</th>
                            <th class="w-28 text-center" data-i18n="expected">–û–∂–∏–¥–∞–µ–º–æ</th>
                            <th class="w-32 text-center" data-i18n="actual">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏</th>
                            <th class="w-28 text-center" data-i18n="difference">–†–∞–∑–Ω–∏—Ü–∞</th>
                        </tr>
                    </thead>
                    <tbody id="countingItems"></tbody>
                </table>
            </div>

            <!-- Actions -->
            <div class="flex justify-between items-center mt-4" data-permission="conduct_inventory">
                <button class="btn btn-ghost btn-error" onclick="cancelInventory()" data-i18n="cancel_inventory">
                    –û—Ç–º–µ–Ω–∏—Ç—å
                </button>
                <button class="btn btn-primary" onclick="applyInventory()" id="applyBtn" data-i18n="apply_inventory">
                    –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                </button>
            </div>
        </div>

    </main>

    <div id="footer-placeholder"></div>

    <!-- Confirm Modal -->
    <dialog id="confirmModal" class="modal">
        <div class="modal-box max-w-sm">
            <p id="confirmMessage" class="py-4 text-center"></p>
            <div class="modal-action justify-center gap-2">
                <button type="button" class="btn btn-ghost" onclick="confirmNo()" data-i18n="no">–ù–µ—Ç</button>
                <button type="button" class="btn btn-primary" onclick="confirmYes()" data-i18n="yes">–î–∞</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <script src="../js/config.js"></script>
    <script src="../js/auth-check.js?v=3"></script>
    <script src="../js/cache.js"></script>
    <script src="../js/utils.js?v=2"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/date-utils.js"></script>
    <script src="../js/layout.js?v=5"></script>
    <script>
        // ==================== STATE ====================
        let inventories = [];
        let products = [];
        let productCategories = [];
        let stock = [];
        let currentTab = 'new';
        let currentInventory = null;
        let currentItems = [];
        let filterCategory = 'all';
        let searchQuery = '';
        let showOnlyNonZero = false;
        let initialized = false;
        let selectedCategories = new Set();

        const t = key => Layout.t(key);

        // ==================== HELPER FUNCTIONS ====================
        function tr(key, fallback) {
            const val = Layout.t(key);
            return val !== key ? val : fallback;
        }

        function formatNumberWithYear(num) {
            if (!num) return '';
            const str = String(num);
            if (str.includes('/')) return str;
            const currentYear = new Date().getFullYear();
            return `${str}/${currentYear}`;
        }

        const UNITS = {
            kg: { ru: '–∫–≥', en: 'kg', hi: '‡§ï‡§ø‡§≤‡•ã' },
            g: { ru: '–≥', en: 'g', hi: '‡§ó‡•ç‡§∞‡§æ‡§Æ' },
            l: { ru: '–ª', en: 'l', hi: '‡§≤‡•Ä‡§ü‡§∞' },
            ml: { ru: '–º–ª', en: 'ml', hi: '‡§Æ‡§ø‡§≤‡•Ä' },
            pcs: { ru: '—à—Ç', en: 'pcs', hi: '‡§ü‡•Å‡§ï‡§°‡§º‡§æ' },
            pack: { ru: '—É–ø', en: 'pack', hi: '‡§™‡•à‡§ï‡•á‡§ü' }
        };

        function localizeUnit(unit) {
            if (!unit) return '';
            return UNITS[unit]?.[Layout.currentLang] || unit;
        }

        // ==================== CONFIRM DIALOG ====================
        let confirmResolve = null;

        function showConfirm(message) {
            return new Promise(resolve => {
                confirmResolve = resolve;
                Layout.$('#confirmMessage').textContent = message;
                Layout.$('#confirmModal').showModal();
            });
        }

        function confirmYes() {
            Layout.$('#confirmModal').close();
            if (confirmResolve) confirmResolve(true);
            confirmResolve = null;
        }

        function confirmNo() {
            Layout.$('#confirmModal').close();
            if (confirmResolve) confirmResolve(false);
            confirmResolve = null;
        }

        // ==================== TABS ====================
        function switchTab(tab) {
            if (!initialized) return;
            currentTab = tab;

            document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('#mainTabs .tab').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.style.backgroundColor = '';
                btn.style.color = '';
            });

            const activeBtn = document.querySelector(`#mainTabs .tab[data-tab="${tab}"]`);
            activeBtn.classList.add('tab-active');
            activeBtn.style.backgroundColor = 'var(--current-color)';
            activeBtn.style.color = 'white';

            Layout.$('#countingSection').classList.add('hidden');

            if (tab === 'new') {
                Layout.$('#tabNew').classList.remove('hidden');
            } else if (tab === 'in_progress') {
                Layout.$('#tabInProgress').classList.remove('hidden');
                renderInProgressList();
            } else if (tab === 'completed') {
                Layout.$('#tabCompleted').classList.remove('hidden');
                renderCompletedList();
            }
        }

        // ==================== DATA LOADING ====================
        async function loadProducts() {
            const { data, error } = await Layout.db.from('products').select('*, product_categories(*)');
            if (error) { console.error('Error loading products:', error); return; }
            products = data || [];
        }

        async function loadProductCategories() {
            productCategories = await Cache.getOrLoad('product_categories', async () => {
                const { data, error } = await Layout.db.from('product_categories').select('*').order('name_ru');
                if (error) { console.error('Error loading categories:', error); return null; }
                return data;
            });
            productCategories = productCategories || [];
        }

        async function loadStock() {
            const locationId = Layout.locations?.find(l => l.slug === Layout.currentLocation)?.id;
            const { data, error } = await Layout.db.from('stock').select('*').eq('location_id', locationId);
            if (error) { console.error('Error loading stock:', error); return; }
            stock = data || [];
        }

        async function loadInventories() {
            const locationId = Layout.locations?.find(l => l.slug === Layout.currentLocation)?.id;
            const { data, error } = await Layout.db
                .from('stock_inventories')
                .select('*, stock_inventory_items(*, products(*))')
                .eq('location_id', locationId)
                .order('created_at', { ascending: false });

            if (error) { console.error('Error loading inventories:', error); return; }
            inventories = data || [];
            updateCount();
        }

        function updateCount() {
            const inProgress = inventories.filter(i => i.status === 'in_progress').length;
            Layout.$('#inventoriesCount').textContent = inProgress > 0
                ? `${inProgress} ${tr('in_progress_inventories', '–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ')}`
                : tr('no_inventories', '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–π');
        }

        function getStockQuantity(productId) {
            const s = stock.find(s => s.product_id === productId);
            return s ? s.current_quantity : 0;
        }

        // ==================== CATEGORY CHECKBOXES ====================
        function renderCategoryCheckboxes() {
            const container = Layout.$('#categoryCheckboxes');

            let html = `
                <label class="label cursor-pointer gap-2 bg-base-200 rounded-lg px-3 py-2">
                    <input type="checkbox" class="checkbox checkbox-sm" id="catAll" onchange="toggleAllCategories(this.checked)" checked />
                    <span class="label-text">${tr('all_categories', '–í—Å–µ')}</span>
                </label>
            `;

            productCategories.forEach(cat => {
                html += `
                    <label class="label cursor-pointer gap-2 bg-base-200 rounded-lg px-3 py-2">
                        <input type="checkbox" class="checkbox checkbox-sm" data-cat="${cat.id}" onchange="toggleCategory('${cat.id}')" checked />
                        <span class="label-text">${cat.emoji || ''} ${Layout.getName(cat)}</span>
                    </label>
                `;
                selectedCategories.add(cat.id);
            });

            container.innerHTML = html;
        }

        function toggleAllCategories(checked) {
            selectedCategories.clear();
            document.querySelectorAll('#categoryCheckboxes input[data-cat]').forEach(cb => {
                cb.checked = checked;
                if (checked) selectedCategories.add(cb.dataset.cat);
            });
        }

        function toggleCategory(catId) {
            if (selectedCategories.has(catId)) {
                selectedCategories.delete(catId);
            } else {
                selectedCategories.add(catId);
            }
            // Update "All" checkbox
            const allCb = Layout.$('#catAll');
            allCb.checked = selectedCategories.size === productCategories.length;
        }

        // ==================== CREATE INVENTORY ====================
        async function createInventory() {
            if (selectedCategories.size === 0) {
                Layout.showNotification(tr('select_categories', '–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é'), 'warning');
                return;
            }

            const locationId = Layout.locations?.find(l => l.slug === Layout.currentLocation)?.id;
            const date = Layout.$('#inventoryDate').value;
            const notes = Layout.$('#inventoryNotes').value.trim();

            // Create inventory session
            const { data: inventory, error } = await Layout.db
                .from('stock_inventories')
                .insert({
                    location_id: locationId,
                    inventory_date: date,
                    notes: notes || null
                })
                .select()
                .single();

            if (error) {
                console.error('Error creating inventory:', error);
                Layout.showNotification(tr('save_error', '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è'), 'error');
                return;
            }

            // Get products in selected categories
            const relevantProducts = products.filter(p =>
                p.product_categories && selectedCategories.has(p.product_categories.id)
            );

            // Create inventory items
            const items = relevantProducts.map(p => ({
                inventory_id: inventory.id,
                product_id: p.id,
                expected_quantity: getStockQuantity(p.id),
                actual_quantity: null
            }));

            if (items.length > 0) {
                const { error: itemsError } = await Layout.db
                    .from('stock_inventory_items')
                    .insert(items);

                if (itemsError) {
                    console.error('Error creating items:', itemsError);
                }
            }

            // Reload and open
            await loadInventories();
            openInventory(inventory.id);
        }

        // ==================== LISTS ====================
        function renderInProgressList() {
            const container = Layout.$('#inProgressList');
            const list = inventories.filter(i => i.status === 'in_progress');

            if (list.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 opacity-50">
                        <div class="text-4xl mb-2">üìã</div>
                        <div>${tr('no_inventories', '–ù–µ—Ç –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ')}</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = list.map(inv => renderInventoryCard(inv, 'in_progress')).join('');
        }

        function renderCompletedList() {
            const container = Layout.$('#completedList');
            const list = inventories.filter(i => i.status === 'completed' || i.status === 'cancelled');

            if (list.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 opacity-50">
                        <div class="text-4xl mb-2">‚úÖ</div>
                        <div>${tr('no_inventories', '–ù–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–π')}</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = list.map(inv => renderInventoryCard(inv, inv.status)).join('');
        }

        function renderInventoryCard(inv, status) {
            const items = inv.stock_inventory_items || [];
            const counted = items.filter(i => i.actual_quantity !== null).length;
            const discrepancies = items.filter(i =>
                i.actual_quantity !== null && i.actual_quantity !== i.expected_quantity
            ).length;
            const date = DateUtils.parseDate(inv.inventory_date).toLocaleDateString('ru-RU');

            const borderColor = status === 'cancelled' ? 'border-gray-300' :
                               status === 'completed' ? 'border-green-500' : 'border-yellow-500';

            const statusText = status === 'cancelled' ? tr('inventory_cancelled', '–û—Ç–º–µ–Ω–µ–Ω–∞') :
                              status === 'completed' ? tr('inventory_completed', '–ó–∞–≤–µ—Ä—à–µ–Ω–∞') :
                              tr('inventory_in_progress', '–í –ø—Ä–æ—Ü–µ—Å—Å–µ');

            return `
                <div class="bg-base-100 rounded-lg p-4 shadow-sm border-l-4 ${borderColor}">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <div class="font-semibold text-lg">${tr('inventory_title', '–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è')} #${formatNumberWithYear(inv.number)}</div>
                            <div class="text-sm opacity-60">${date} ¬∑ ${statusText}</div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-center">
                                <div class="font-bold">${items.length}</div>
                                <div class="text-xs opacity-60">${tr('products', '–ø–æ–∑–∏—Ü–∏–π')}</div>
                            </div>
                            <div class="text-center">
                                <div class="font-bold text-success">${counted}</div>
                                <div class="text-xs opacity-60">${tr('items_counted', '–ø–æ–¥—Å—á–∏—Ç–∞–Ω–æ')}</div>
                            </div>
                            ${discrepancies > 0 ? `
                            <div class="text-center">
                                <div class="font-bold text-error">${discrepancies}</div>
                                <div class="text-xs opacity-60">${tr('discrepancies_found', '—Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π')}</div>
                            </div>
                            ` : ''}
                            <button class="btn btn-ghost btn-md" onclick="openInventory('${inv.id}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== COUNTING ====================
        function openInventory(id) {
            const inv = inventories.find(i => i.id === id);
            if (!inv) return;

            currentInventory = inv;
            currentItems = (inv.stock_inventory_items || []).map(item => ({
                ...item,
                product: products.find(p => p.id === item.product_id)
            }));
            filterCategory = 'all';
            searchQuery = '';
            showOnlyNonZero = false;

            // Hide tabs content, show counting
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));
            Layout.$('#countingSection').classList.remove('hidden');

            // –°–±—Ä–æ—Å UI —Ñ–∏–ª—å—Ç—Ä–æ–≤
            Layout.$('#countingSearch').value = '';
            Layout.$('#countingSearchClear').classList.add('hidden');
            Layout.$('#nonZeroFilter').checked = false;

            Layout.$('#countingTitle').textContent = `${tr('inventory_title', '–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è')} #${formatNumberWithYear(inv.number)}`;
            Layout.$('#countingInfo').textContent = DateUtils.parseDate(inv.inventory_date).toLocaleDateString('ru-RU');

            // Disable apply button if completed/cancelled
            Layout.$('#applyBtn').disabled = inv.status !== 'in_progress';

            buildFilterButtons();
            renderCountingItems();
            updateStats();
        }

        function backToList() {
            Layout.$('#countingSection').classList.add('hidden');
            currentInventory = null;
            currentItems = [];

            if (currentTab === 'new') {
                Layout.$('#tabNew').classList.remove('hidden');
            } else if (currentTab === 'in_progress') {
                Layout.$('#tabInProgress').classList.remove('hidden');
                renderInProgressList();
            } else {
                Layout.$('#tabCompleted').classList.remove('hidden');
                renderCompletedList();
            }
        }

        function buildFilterButtons() {
            const container = Layout.$('#filterCategoryButtons');
            const categories = [...new Set(currentItems.map(i => i.product?.product_categories?.id).filter(Boolean))];
            const cats = productCategories.filter(c => categories.includes(c.id));

            let html = `<button class="btn btn-sm ${filterCategory === 'all' ? '' : 'btn-ghost'}" onclick="setFilterCategory('all')" style="${filterCategory === 'all' ? 'background-color: var(--current-color); border-color: var(--current-color); color: white;' : ''}">${tr('all', '–í—Å–µ')}</button>`;

            cats.forEach(cat => {
                const isActive = filterCategory === cat.id;
                html += `<button class="btn btn-sm ${isActive ? '' : 'btn-ghost'}" onclick="setFilterCategory('${cat.id}')" style="${isActive ? 'background-color: var(--current-color); border-color: var(--current-color); color: white;' : ''}">${cat.emoji || ''} ${Layout.getName(cat)}</button>`;
            });

            container.innerHTML = html;
        }

        function setFilterCategory(catId) {
            filterCategory = catId;
            buildFilterButtons();
            renderCountingItems();
        }

        function onCountingSearch(query) {
            searchQuery = query.toLowerCase().trim();
            Layout.$('#countingSearchClear').classList.toggle('hidden', !query);
            renderCountingItems();
        }

        function clearCountingSearch() {
            Layout.$('#countingSearch').value = '';
            searchQuery = '';
            Layout.$('#countingSearchClear').classList.add('hidden');
            renderCountingItems();
        }

        function toggleNonZeroFilter(checked) {
            showOnlyNonZero = checked;
            renderCountingItems();
        }

        function renderCountingItems() {
            const tbody = Layout.$('#countingItems');

            let filtered = currentItems;

            // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if (filterCategory !== 'all') {
                filtered = filtered.filter(i => i.product?.product_categories?.id === filterCategory);
            }

            // –§–∏–ª—å—Ç—Ä "—Ç–æ–ª—å–∫–æ –Ω–µ –Ω—É–ª–µ–≤—ã–µ" ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã —Å expected_quantity > 0
            if (showOnlyNonZero) {
                filtered = filtered.filter(i => i.expected_quantity > 0);
            }

            // –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞
            if (searchQuery) {
                filtered = filtered.filter(i => {
                    const p = i.product;
                    if (!p) return false;
                    const name = (p.name_ru || '') + ' ' + (p.name_en || '') + ' ' + (p.name_hi || '');
                    return name.toLowerCase().includes(searchQuery);
                });
            }

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-8 opacity-50">${tr('no_products_to_count', '–ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤')}</td></tr>`;
                return;
            }

            const isEditable = currentInventory?.status === 'in_progress';

            tbody.innerHTML = filtered.map((item, idx) => {
                const product = item.product;
                if (!product) return '';

                const expected = item.expected_quantity || 0;
                const actual = item.actual_quantity;
                const diff = actual !== null ? actual - expected : null;

                let diffClass = '';
                let diffText = '‚Äî';
                if (diff !== null) {
                    if (diff > 0) {
                        diffClass = 'text-warning font-medium';
                        diffText = `+${Layout.formatQuantity(diff, product.unit)}`;
                    } else if (diff < 0) {
                        diffClass = 'text-error font-medium';
                        diffText = Layout.formatQuantity(diff, product.unit);
                    } else {
                        diffClass = 'text-success';
                        diffText = '‚úì';
                    }
                }

                const realIdx = currentItems.findIndex(i => i.id === item.id);

                return `
                    <tr class="${item.actual_quantity !== null ? '' : 'bg-base-200/30'}">
                        <td>
                            <div class="font-medium">${Layout.getName(product)}</div>
                            <div class="text-xs opacity-50">${product.product_categories?.emoji || ''} ${Layout.getName(product.product_categories)}</div>
                        </td>
                        <td class="text-center opacity-60">${Layout.formatQuantity(expected, product.unit)} ${localizeUnit(product.unit)}</td>
                        <td class="text-center">
                            ${isEditable ? `
                                <input type="number"
                                       class="input input-bordered input-sm w-24 text-center"
                                       value="${actual !== null ? actual : ''}"
                                       placeholder="‚Äî"
                                       step="0.01"
                                       onchange="updateActual(${realIdx}, this.value, '${product.unit}')" />
                            ` : `
                                <span>${actual !== null ? Layout.formatQuantity(actual, product.unit) : '‚Äî'} ${actual !== null ? localizeUnit(product.unit) : ''}</span>
                            `}
                        </td>
                        <td class="text-center ${diffClass}">${diffText}</td>
                    </tr>
                `;
            }).join('');
        }

        async function updateActual(idx, value, unit) {
            const item = currentItems[idx];
            if (!item) return;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –µ–¥–∏–Ω–∏—Ü–∞—Ö –ø—Ä–æ–¥—É–∫—Ç–∞ (–±–µ–∑ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏)
            let actualValue = null;
            if (value !== '' && value !== null) {
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    actualValue = numValue;
                }
            }

            // Update in DB
            await Layout.db
                .from('stock_inventory_items')
                .update({ actual_quantity: actualValue })
                .eq('id', item.id);

            // Update local
            currentItems[idx].actual_quantity = actualValue;
            updateStats();
            renderCountingItems();
        }

        function updateStats() {
            const total = currentItems.length;
            const counted = currentItems.filter(i => i.actual_quantity !== null).length;
            const discrepancies = currentItems.filter(i =>
                i.actual_quantity !== null && i.actual_quantity !== i.expected_quantity
            ).length;

            Layout.$('#statTotal').textContent = total;
            Layout.$('#statCounted').textContent = counted;
            Layout.$('#statDiscrepancies').textContent = discrepancies;
        }

        // ==================== APPLY / CANCEL ====================
        async function applyInventory() {
            if (!currentInventory || currentInventory.status !== 'in_progress') return;

            const uncounted = currentItems.filter(i => i.actual_quantity === null).length;
            if (uncounted > 0) {
                const proceed = await showConfirm(`${uncounted} –ø–æ–∑–∏—Ü–∏–π –Ω–µ –ø–æ–¥—Å—á–∏—Ç–∞–Ω–æ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`);
                if (!proceed) return;
            }

            const confirmed = await showConfirm(tr('confirm_apply', '–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏? –û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ –±—É–¥—É—Ç —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã.'));
            if (!confirmed) return;

            const locationId = Layout.locations?.find(l => l.slug === Layout.currentLocation)?.id;

            // Update stock quantities
            for (const item of currentItems) {
                if (item.actual_quantity === null) continue;

                const { data: stockItem } = await Layout.db
                    .from('stock')
                    .select('id')
                    .eq('product_id', item.product_id)
                    .eq('location_id', locationId)
                    .single();

                if (stockItem) {
                    await Layout.db.from('stock').update({
                        current_quantity: item.actual_quantity
                    }).eq('id', stockItem.id);
                } else if (item.actual_quantity > 0) {
                    await Layout.db.from('stock').insert({
                        location_id: locationId,
                        product_id: item.product_id,
                        current_quantity: item.actual_quantity,
                        min_quantity: 0
                    });
                }
            }

            // Mark inventory as completed
            await Layout.db.from('stock_inventories').update({
                status: 'completed',
                completed_at: new Date().toISOString()
            }).eq('id', currentInventory.id);

            await loadStock();
            await loadInventories();
            backToList();
            switchTab('completed');
        }

        async function cancelInventory() {
            if (!currentInventory || currentInventory.status !== 'in_progress') return;

            const confirmed = await showConfirm(tr('cancel_confirm', '–û—Ç–º–µ–Ω–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é?'));
            if (!confirmed) return;

            await Layout.db.from('stock_inventories').update({
                status: 'cancelled'
            }).eq('id', currentInventory.id);

            await loadInventories();
            backToList();
        }

        // ==================== EVENT LISTENERS ====================
        window.onLanguageChange = function() {
            Layout.updateAllTranslations();
            renderCategoryCheckboxes();
            if (currentTab === 'in_progress') renderInProgressList();
            if (currentTab === 'completed') renderCompletedList();
            if (currentInventory) renderCountingItems();
        };

        window.onLocationChange = async function() {
            await loadStock();
            await loadInventories();
            renderCategoryCheckboxes();
            if (currentTab === 'in_progress') renderInProgressList();
            if (currentTab === 'completed') renderCompletedList();
        };

        // ==================== INIT ====================
        async function init() {
            await Layout.init({ module: 'kitchen', menuId: 'stock', itemId: 'inventory' });

            Layout.$('#inventoryDate').value = DateUtils.toISO(new Date());

            const activeBtn = document.querySelector('#mainTabs .tab[data-tab="new"]');
            activeBtn.style.backgroundColor = 'var(--current-color)';
            activeBtn.style.color = 'white';

            await Promise.all([
                loadProducts(),
                loadProductCategories(),
                loadStock(),
                loadInventories()
            ]);

            renderCategoryCheckboxes();
            renderInProgressList();
            renderCompletedList();
            initialized = true;
            Layout.updateAllTranslations();
        }

        init();
    </script>
</body>
</html>
