<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script src="../js/color-init.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Выдать — ШРСК</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        @media print {
            body * { visibility: hidden; }
            #viewIssuanceModal, #viewIssuanceModal * { visibility: visible; }
            #viewIssuanceModal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
            }
            #viewIssuanceModal .modal-box {
                max-width: 100%;
                box-shadow: none;
            }
            #viewIssuanceModal .modal-action,
            #viewIssuanceModal .btn-ghost,
            #viewIssuanceModal form[method="dialog"] { display: none !important; }
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 flex-1">

        <div class="mb-6">
            <h1 class="text-2xl font-bold" data-i18n="issuance_title">Выдать продукты</h1>
            <p class="text-sm opacity-60" id="issuancesCount" data-i18n="loading">Загрузка...</p>
        </div>

        <!-- Tabs -->
        <div class="tabs tabs-boxed bg-base-100 p-1 mb-6 inline-flex" id="mainTabs">
            <button class="tab tab-active" data-tab="new" onclick="switchTab('new')" data-i18n="new_issuance_tab">Новая выдача</button>
            <button class="tab" data-tab="saved" onclick="switchTab('saved')" data-i18n="saved_issuances_tab">Сохранённые</button>
            <button class="tab" data-tab="archive" onclick="switchTab('archive')" data-i18n="archived_issuances_tab">Архивные</button>
            <button class="tab" data-tab="deleted" onclick="switchTab('deleted')" data-i18n="deleted_issuances_tab">Удалённые</button>
        </div>

        <!-- Сообщение об отсутствии прав -->
        <div class="alert alert-warning mb-6" data-no-permission="issue_stock" style="display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <span data-i18n="no_permission_warning">У вас нет прав для совершения действий на этой странице. Доступен только просмотр.</span>
        </div>

        <!-- New Issuance Tab -->
        <div id="tabNew" class="tab-pane">

            <!-- Choice: From Menu or Manual -->
            <div id="issueChoiceSection" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Option 1: From Menu -->
                <div class="bg-base-100 rounded-lg p-6 shadow-sm">
                    <div class="text-lg font-semibold mb-2" data-i18n="issue_from_menu_title">Выдать из меню</div>
                    <p class="text-sm opacity-60 mb-4" data-i18n="issue_from_menu_desc">Рассчитать продукты на основе меню на день</p>

                    <div class="space-y-4">
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="date">Дата</span></label>
                            <input type="date" id="menuLoadDate" class="input input-bordered w-full" />
                        </div>

                        <div id="mealTypeSection">
                            <label class="label"><span class="label-text font-medium" data-i18n="meal_type">Приём пищи</span></label>
                            <div class="flex gap-4">
                                <label class="label cursor-pointer gap-2">
                                    <input type="checkbox" id="menuLoadBreakfast" class="checkbox checkbox-sm" checked />
                                    <span class="label-text" data-i18n="breakfast">Завтрак</span>
                                </label>
                                <label class="label cursor-pointer gap-2">
                                    <input type="checkbox" id="menuLoadLunch" class="checkbox checkbox-sm" checked />
                                    <span class="label-text" data-i18n="lunch">Обед</span>
                                </label>
                                <label class="label cursor-pointer gap-2">
                                    <input type="checkbox" id="menuLoadDinner" class="checkbox checkbox-sm" checked />
                                    <span class="label-text" data-i18n="dinner">Ужин</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary w-full mt-4" onclick="generateFromMenu()" data-i18n="generate" data-permission="issue_stock">
                        Сформировать
                    </button>
                </div>

                <!-- Option 2: Manual -->
                <div class="bg-base-100 rounded-lg p-6 shadow-sm flex flex-col">
                    <div class="text-lg font-semibold mb-2" data-i18n="issue_manual_title">Выдать вручную</div>
                    <p class="text-sm opacity-60 mb-4" data-i18n="issue_manual_desc">Ввести продукты для выдачи вручную</p>

                    <div class="flex-1"></div>

                    <button class="btn btn-outline btn-primary w-full" onclick="createManualIssue()" data-i18n="create_issue" data-permission="issue_stock">
                        Создать выдачу
                    </button>
                </div>
            </div>

            <!-- Issue Form (hidden initially) -->
            <div id="issueFormSection" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="issueTitle" class="text-lg font-semibold" data-i18n="new_issue">Новая выдача</h2>
                    <button class="btn btn-ghost btn-sm" onclick="backToChoice()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        <span data-i18n="back">Назад</span>
                    </button>
                </div>

                <div class="bg-base-100 rounded-lg p-6 shadow-sm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="issuance_date">Дата выдачи</span></label>
                            <input type="date" id="issuanceDate" class="input input-bordered w-full" />
                        </div>
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="receiver">Кто получил</span></label>
                            <select id="issuanceReceiver" class="select select-bordered w-full">
                                <option value="" data-i18n="select_receiver">— Выберите —</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="label"><span class="label-text font-medium" data-i18n="products">Продукты</span></label>
                        <div class="border border-base-300 rounded-lg overflow-hidden">
                            <table class="table table-sm">
                                <thead class="bg-base-200">
                                    <tr>
                                        <th data-i18n="product">Продукт</th>
                                        <th class="w-24" data-i18n="in_stock">На складе</th>
                                        <th class="w-40" data-i18n="quantity">Кол-во</th>
                                        <th class="w-10"></th>
                                    </tr>
                                </thead>
                                <tbody id="issuanceItems"></tbody>
                            </table>
                        </div>

                        <div class="flex flex-wrap gap-2 mt-2">
                            <button type="button" class="btn btn-sm gap-1" style="background-color: var(--current-color); border-color: var(--current-color); color: white;" onclick="openProductModal()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                <span data-i18n="add_product">Добавить продукт</span>
                            </button>
                            <button type="button" class="btn btn-sm gap-1 btn-ghost" onclick="openMenuDishesModal()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <span data-i18n="add_from_menu">Из меню</span>
                            </button>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="label"><span class="label-text font-medium" data-i18n="notes">Примечания</span></label>
                        <textarea id="issuanceNotes" class="textarea textarea-bordered w-full" rows="2" placeholder="Примечания..." data-i18n-placeholder="notes"></textarea>
                    </div>

                    <div class="flex justify-between items-center">
                        <div class="text-right">
                            <div class="text-sm opacity-60" data-i18n="total_items_short">Позиций</div>
                            <div class="text-2xl font-bold" id="issuanceTotal">0</div>
                        </div>
                        <button type="button" class="btn btn-primary" id="saveIssuanceBtn" onclick="saveIssuance()" data-permission="issue_stock">
                            <span class="loading loading-spinner loading-sm hidden" id="saveSpinner"></span>
                            <span id="saveText" data-i18n="save_issuance">Сохранить выдачу</span>
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Saved Issuances Tab -->
        <div id="tabSaved" class="tab-pane hidden">
            <div class="alert alert-success mb-4 py-2">
                <span class="text-sm" data-i18n="issuance_completed_info">Выдача проведена, склад обновлён</span>
            </div>
            <div class="space-y-3" id="savedIssuancesList"></div>
        </div>

        <!-- Archived Issuances Tab -->
        <div id="tabArchive" class="tab-pane hidden">
            <div class="alert alert-info mb-4 py-2">
                <span class="text-sm" data-i18n="issuance_completed_info">Выдача проведена, склад обновлён</span>
            </div>
            <div class="space-y-3" id="archivedIssuancesList"></div>
        </div>

        <!-- Deleted Issuances Tab -->
        <div id="tabDeleted" class="tab-pane hidden">
            <div class="alert alert-warning mb-4 py-2">
                <span class="text-sm" data-i18n="issuance_cancelled_info">Выдача отменена, склад не изменялся</span>
            </div>
            <div class="space-y-3" id="deletedIssuancesList"></div>
        </div>

    </main>

    <div id="footer-placeholder"></div>

    <!-- View/Edit Issuance Modal -->
    <dialog id="viewIssuanceModal" class="modal">
        <div class="modal-box max-w-2xl">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>
            <h3 class="font-bold text-lg mb-4" id="viewIssuanceTitle">Выдача</h3>

            <div class="mb-4">
                <div class="flex gap-4 text-sm opacity-60 mb-2">
                    <span id="viewIssuanceDate"></span>
                    <span id="viewIssuanceReceiver"></span>
                </div>
            </div>

            <div class="border border-base-300 rounded-lg overflow-hidden mb-4">
                <table class="table table-sm">
                    <thead class="bg-base-200">
                        <tr>
                            <th data-i18n="product">Продукт</th>
                            <th class="w-40" data-i18n="quantity">Кол-во</th>
                            <th class="w-10"></th>
                        </tr>
                    </thead>
                    <tbody id="viewIssuanceItems"></tbody>
                </table>
            </div>

            <div class="flex justify-between items-center mb-4">
                <div id="viewIssuanceNotes" class="text-sm opacity-60 italic"></div>
                <div class="text-right">
                    <div class="text-sm opacity-60" data-i18n="total_items_short">Позиций</div>
                    <div class="text-2xl font-bold" id="viewIssuanceTotal">0</div>
                </div>
            </div>

            <div class="modal-action">
                <button type="button" class="btn btn-ghost gap-2" onclick="printViewedIssuance()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                    <span data-i18n="print">Печать</span>
                </button>
                <button type="button" class="btn btn-ghost" onclick="closeViewIssuanceModal()" data-i18n="close">Закрыть</button>
                <button type="button" class="btn btn-primary" onclick="saveViewedIssuance()" data-i18n="save_changes">Сохранить изменения</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Add Product Modal -->
    <dialog id="productModal" class="modal">
        <div class="modal-box max-w-lg relative">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="productModal.close()">✕</button>
            <h3 class="font-bold text-lg mb-4" data-i18n="add_product">Добавить продукт</h3>

            <div class="space-y-4">
                <!-- Tabs -->
                <div class="tabs tabs-boxed bg-base-200">
                    <a class="tab" id="tabProductSearch" onclick="switchProductTab('search')" data-i18n="search" style="background-color: var(--current-color); color: white;">Поиск</a>
                    <a class="tab" id="tabProductBrowse" onclick="switchProductTab('browse')" data-i18n="by_category">По категории</a>
                </div>

                <!-- Search Tab -->
                <div id="productSearchTab">
                    <div class="relative">
                        <input type="text"
                               id="productSearch"
                               class="input input-bordered w-full"
                               placeholder="Начните вводить название..." data-i18n-placeholder="search_placeholder"
                               autocomplete="off"
                               oninput="filterProducts(this.value)"
                               onfocus="showProductDropdown()"
                        />
                        <div id="productDropdown" class="absolute z-50 w-full bg-base-100 border border-base-300 rounded-lg shadow-lg mt-1 max-h-64 overflow-y-auto hidden">
                        </div>
                    </div>
                </div>

                <!-- Browse Tab -->
                <div id="productBrowseTab" class="hidden">
                    <div class="flex flex-wrap gap-2 mb-3" id="productCategoryButtons">
                    </div>
                    <div id="productCategoryList" class="max-h-64 overflow-y-auto border border-base-300 rounded-lg">
                    </div>
                </div>

                <!-- Selected Product -->
                <div id="selectedProductDisplay" class="hidden">
                    <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg border-2" style="border-color: var(--current-color);">
                        <div>
                            <div class="font-medium" id="selectedProductName"></div>
                            <div class="text-sm opacity-50" id="selectedProductNameEn"></div>
                        </div>
                        <button type="button" class="btn btn-ghost btn-sm btn-square" onclick="clearSelectedProduct()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Quantity -->
                <div id="productQuantitySection" class="hidden">
                    <label class="label"><span class="label-text font-medium" data-i18n="quantity">Количество</span></label>
                    <div class="join w-full">
                        <input type="number" id="productQuantity" class="input input-bordered join-item w-full" value="1" min="0.1" step="0.1" />
                        <span id="productUnit" class="btn join-item no-animation pointer-events-none bg-base-200">кг</span>
                    </div>
                    <div class="text-sm opacity-60 mt-1" id="productStockInfo"></div>
                </div>
            </div>

            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="productModal.close()" data-i18n="cancel">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveProductBtn" onclick="addProductFromModal()" disabled data-i18n="add">Добавить</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Menu Dishes Modal -->
    <dialog id="menuDishesModal" class="modal">
        <div class="modal-box max-w-2xl relative">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="menuDishesModal.close()">✕</button>
            <h3 class="font-bold text-lg mb-4" data-i18n="add_from_menu">Добавить из меню</h3>

            <!-- Период -->
            <div class="flex flex-wrap items-center gap-2 mb-4">
                <span class="text-sm opacity-60" data-i18n="from">с</span>
                <input type="date" id="menuDishesFrom" class="input input-bordered input-sm w-36" />
                <span class="text-sm opacity-60" data-i18n="to">по</span>
                <input type="date" id="menuDishesTo" class="input input-bordered input-sm w-36" />
                <button class="btn btn-sm btn-primary" onclick="loadMenuDishes()" data-i18n="load">Загрузить</button>
            </div>

            <!-- Список дней с блюдами -->
            <div id="menuDishesList" class="space-y-3 max-h-96 overflow-y-auto">
                <div class="text-center py-8 opacity-50" data-i18n="select_period_and_load">Выберите период и нажмите «Загрузить»</div>
            </div>

            <!-- Подвал -->
            <div class="modal-action">
                <div class="flex-1 text-sm opacity-60">
                    <span data-i18n="selected">Выбрано</span>: <span id="menuDishesCount" class="font-bold">0</span> <span data-i18n="dishes_count">блюд</span>
                </div>
                <button type="button" class="btn btn-ghost" onclick="menuDishesModal.close()" data-i18n="cancel">Отмена</button>
                <button type="button" class="btn btn-primary" id="addDishesBtn" onclick="addSelectedDishes()" disabled data-i18n="add_ingredients">Добавить ингредиенты</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Alert Modal -->
    <dialog id="alertModal" class="modal">
        <div class="modal-box max-w-sm">
            <p id="alertMessage" class="py-4 text-center"></p>
            <div class="modal-action justify-center">
                <button type="button" class="btn btn-primary" onclick="closeAlert()">OK</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Confirm Modal -->
    <dialog id="confirmModal" class="modal">
        <div class="modal-box max-w-sm">
            <p id="confirmMessage" class="py-4 text-center"></p>
            <div class="modal-action justify-center gap-2">
                <button type="button" class="btn btn-ghost" onclick="confirmNo()" data-i18n="no">Нет</button>
                <button type="button" class="btn btn-primary" onclick="confirmYes()" data-i18n="yes">Да</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <script src="../js/config.js"></script>
    <script src="../js/auth-check.js?v=4"></script>
    <script src="../js/cache.js"></script>
    <script src="../js/utils.js?v=2"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/date-utils.js"></script>
    <script src="../js/eating-utils.js"></script>
    <script src="../js/layout.js?v=5"></script>
    <script>
        // ==================== STATE ====================
        let issuances = [];
        let products = [];
        let productCategories = [];
        let stock = [];
        let issuanceItemsList = [];
        let currentTab = 'new';
        let viewingIssuance = null;
        let viewingItems = [];
        let initialized = false;
        let selectedProduct = null;
        let currentProductCategory = 'all';
        let cooks = []; // Список поваров из команды
        let menuRecipes = [];
        let menuDishesData = [];
        let menuDishesEatingCounts = {};

        const t = key => Layout.t(key);

        // ==================== HELPER FUNCTIONS ====================
        function tr(key, fallback) {
            const val = Layout.t(key);
            return val !== key ? val : fallback;
        }

        function formatNumberWithYear(num) {
            if (!num) return '';
            const str = String(num);
            if (str.includes('/')) return str;
            const currentYear = new Date().getFullYear();
            return `${str}/${currentYear}`;
        }

        const UNITS = {
            kg: { ru: 'кг', en: 'kg', hi: 'किलो' },
            g: { ru: 'г', en: 'g', hi: 'ग्राम' },
            l: { ru: 'л', en: 'l', hi: 'लीटर' },
            ml: { ru: 'мл', en: 'ml', hi: 'मिली' },
            pcs: { ru: 'шт', en: 'pcs', hi: 'टुकड़ा' },
            pack: { ru: 'уп', en: 'pack', hi: 'पैकेट' }
        };

        function localizeUnit(unit) {
            if (!unit) return '';
            const lang = Layout.currentLang;
            return UNITS[unit]?.[lang] || unit;
        }

        // Unit conversion functions
        function toGrams(amount, unit) {
            if (unit === 'kg') return amount * 1000;
            if (unit === 'g') return amount;
            return amount;
        }

        function fromGrams(grams, targetUnit) {
            if (targetUnit === 'kg') return grams / 1000;
            if (targetUnit === 'g') return grams;
            return grams;
        }

        function toBaseUnit(amount, unit) {
            if (unit === 'kg') return amount * 1000;
            if (unit === 'g') return amount;
            if (unit === 'l') return amount * 1000;
            if (unit === 'ml') return amount;
            return amount;
        }

        function toSmartDisplay(amountInBaseUnit, stockUnit) {
            if (stockUnit === 'kg' || stockUnit === 'g') {
                if (amountInBaseUnit >= 1000) {
                    return { amount: amountInBaseUnit / 1000, unit: 'kg' };
                } else {
                    return { amount: amountInBaseUnit, unit: 'g' };
                }
            }
            if (stockUnit === 'l' || stockUnit === 'ml') {
                if (amountInBaseUnit >= 1000) {
                    return { amount: amountInBaseUnit / 1000, unit: 'l' };
                } else {
                    return { amount: amountInBaseUnit, unit: 'ml' };
                }
            }
            return { amount: amountInBaseUnit, unit: stockUnit || 'pcs' };
        }

        function toStockUnit(amount, displayUnit, stockUnit) {
            if (!stockUnit || !displayUnit) return amount;
            const base = toBaseUnit(amount, displayUnit);
            if (stockUnit === 'kg') return base / 1000;
            if (stockUnit === 'g') return base;
            if (stockUnit === 'l') return base / 1000;
            if (stockUnit === 'ml') return base;
            return amount;
        }

        // ==================== MODAL DIALOGS ====================
        function showAlert(message) {
            const modal = Layout.$('#alertModal');
            Layout.$('#alertMessage').textContent = message;
            modal.showModal();
        }

        function closeAlert() {
            Layout.$('#alertModal').close();
        }

        let confirmResolve = null;

        function showConfirm(message) {
            return new Promise(resolve => {
                confirmResolve = resolve;
                const modal = Layout.$('#confirmModal');
                Layout.$('#confirmMessage').textContent = message;
                modal.showModal();
            });
        }

        function confirmYes() {
            Layout.$('#confirmModal').close();
            if (confirmResolve) confirmResolve(true);
            confirmResolve = null;
        }

        function confirmNo() {
            Layout.$('#confirmModal').close();
            if (confirmResolve) confirmResolve(false);
            confirmResolve = null;
        }

        // ==================== PRODUCT MODAL ====================
        function openProductModal() {
            selectedProduct = null;
            currentProductCategory = 'all';
            Layout.$('#productSearch').value = '';
            Layout.$('#productDropdown').classList.add('hidden');
            Layout.$('#selectedProductDisplay').classList.add('hidden');
            Layout.$('#productQuantitySection').classList.add('hidden');
            Layout.$('#saveProductBtn').disabled = true;
            Layout.$('#productQuantity').value = 1;
            Layout.$('#productStockInfo').textContent = '';
            switchProductTab('search');
            buildProductCategoryButtons();
            Layout.$('#productModal').showModal();
        }

        function buildProductCategoryButtons() {
            const container = Layout.$('#productCategoryButtons');
            let html = `<button class="btn btn-sm ${currentProductCategory === 'all' ? '' : 'btn-ghost'}" data-cat="all" style="${currentProductCategory === 'all' ? 'background-color: var(--current-color); border-color: var(--current-color); color: white;' : ''}">${tr('all', 'Все')}</button>`;
            productCategories.forEach(cat => {
                const isActive = currentProductCategory === cat.slug;
                html += `<button class="btn btn-sm ${isActive ? '' : 'btn-ghost'}" data-cat="${cat.slug}" style="${isActive ? 'background-color: var(--current-color); border-color: var(--current-color); color: white;' : ''}">${cat.emoji || ''} ${Layout.getName(cat)}</button>`;
            });
            container.innerHTML = html;
            container.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentProductCategory = btn.dataset.cat;
                    buildProductCategoryButtons();
                    filterProductsByCategory();
                });
            });
        }

        function switchProductTab(tab) {
            const searchTab = Layout.$('#tabProductSearch');
            const browseTab = Layout.$('#tabProductBrowse');
            const searchContent = Layout.$('#productSearchTab');
            const browseContent = Layout.$('#productBrowseTab');

            if (tab === 'search') {
                searchTab.style.backgroundColor = 'var(--current-color)';
                searchTab.style.color = 'white';
                browseTab.style.backgroundColor = '';
                browseTab.style.color = '';
                searchContent.classList.remove('hidden');
                browseContent.classList.add('hidden');
            } else {
                browseTab.style.backgroundColor = 'var(--current-color)';
                browseTab.style.color = 'white';
                searchTab.style.backgroundColor = '';
                searchTab.style.color = '';
                browseContent.classList.remove('hidden');
                searchContent.classList.add('hidden');
                filterProductsByCategory();
            }
        }

        function filterProducts(query) {
            const dropdown = Layout.$('#productDropdown');
            if (!query || query.length < 1) {
                dropdown.classList.add('hidden');
                return;
            }
            const q = query.toLowerCase();
            const filtered = products.filter(p =>
                p.name_ru?.toLowerCase().includes(q) ||
                p.name_en?.toLowerCase().includes(q) ||
                p.name_hi?.includes(q)
            ).slice(0, 10);

            if (filtered.length === 0) {
                dropdown.innerHTML = `<div class="p-3 text-center opacity-50">${tr('not_found', 'Не найдено')}</div>`;
            } else {
                dropdown.innerHTML = filtered.map(p => `
                    <div class="p-2 hover:bg-base-200 cursor-pointer" data-action="select-product" data-id="${p.id}">
                        <div class="font-medium">${Layout.getName(p)}</div>
                        <div class="text-xs opacity-50">${p.product_categories?.emoji || ''} ${Layout.getName(p.product_categories)}</div>
                    </div>
                `).join('');
            }
            dropdown.classList.remove('hidden');
        }

        function showProductDropdown() {
            const query = Layout.$('#productSearch').value;
            if (query && query.length >= 1) {
                filterProducts(query);
            }
        }

        function filterProductsByCategory() {
            const container = Layout.$('#productCategoryList');
            let filtered = products;
            if (currentProductCategory !== 'all') {
                filtered = products.filter(p => p.product_categories?.slug === currentProductCategory);
            }

            if (filtered.length === 0) {
                container.innerHTML = `<div class="p-4 text-center opacity-50">${tr('no_products_in_category', 'В этой категории нет продуктов')}</div>`;
            } else {
                container.innerHTML = filtered.map(p => `
                    <div class="p-2 hover:bg-base-200 cursor-pointer border-b border-base-200 last:border-b-0" data-action="select-product" data-id="${p.id}">
                        <div class="font-medium">${Layout.getName(p)}</div>
                        <div class="text-xs opacity-50">${p.product_categories?.emoji || ''} ${Layout.getName(p.product_categories)}</div>
                    </div>
                `).join('');
            }
        }

        function selectProduct(productId) {
            selectedProduct = products.find(p => p.id === productId);
            if (!selectedProduct) return;

            Layout.$('#productDropdown').classList.add('hidden');
            Layout.$('#selectedProductDisplay').classList.remove('hidden');
            Layout.$('#productQuantitySection').classList.remove('hidden');
            Layout.$('#selectedProductName').textContent = Layout.getName(selectedProduct);
            const secondaryLang = Layout.currentLang === 'ru' ? 'en' : 'ru';
            Layout.$('#selectedProductNameEn').textContent = selectedProduct[`name_${secondaryLang}`] || '';
            Layout.$('#productUnit').textContent = localizeUnit(selectedProduct.unit);
            Layout.$('#saveProductBtn').disabled = false;

            // Show stock info
            const stockQty = getStockQuantity(productId);
            Layout.$('#productStockInfo').textContent = `${tr('in_stock', 'На складе')}: ${stockQty} ${selectedProduct.unit || ''}`;
        }

        function clearSelectedProduct() {
            selectedProduct = null;
            Layout.$('#selectedProductDisplay').classList.add('hidden');
            Layout.$('#productQuantitySection').classList.add('hidden');
            Layout.$('#saveProductBtn').disabled = true;
            Layout.$('#productSearch').value = '';
            Layout.$('#productStockInfo').textContent = '';
        }

        function addProductFromModal() {
            if (!selectedProduct) return;

            const quantity = parseFloat(Layout.$('#productQuantity').value) || 1;

            if (issuanceItemsList.some(i => i.product_id === selectedProduct.id)) {
                showAlert(tr('product_already_added', 'Продукт уже добавлен'));
                return;
            }

            addIssuanceItem(selectedProduct.id, quantity, selectedProduct.unit);
            Layout.$('#productModal').close();
        }

        // Получить имя получателя по ID
        function getReceiverName(receiverId) {
            if (!receiverId) return tr('not_specified', 'Не указан');
            const cook = cooks.find(c => c.id === receiverId);
            if (!cook) return tr('not_specified', 'Не указан');
            return cook.spiritual_name || `${cook.first_name || ''} ${cook.last_name || ''}`.trim() || t('no_name');
        }

        const ISSUANCE_FORMS = {
            ru: ['выдача', 'выдачи', 'выдач'],
            en: ['issuance', 'issuances'],
            hi: 'जारी'
        };

        // ==================== TABS ====================
        function switchTab(tab) {
            if (!initialized) return;
            currentTab = tab;
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('#mainTabs .tab').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.style.backgroundColor = '';
                btn.style.color = '';
            });

            const activeBtn = document.querySelector(`#mainTabs .tab[data-tab="${tab}"]`);
            activeBtn.classList.add('tab-active');
            activeBtn.style.backgroundColor = 'var(--current-color)';
            activeBtn.style.color = 'white';

            if (tab === 'new') {
                Layout.$('#tabNew').classList.remove('hidden');
                backToChoice();
            } else if (tab === 'saved') {
                Layout.$('#tabSaved').classList.remove('hidden');
                renderSavedIssuances();
            } else if (tab === 'archive') {
                Layout.$('#tabArchive').classList.remove('hidden');
                renderArchivedIssuances();
            } else if (tab === 'deleted') {
                Layout.$('#tabDeleted').classList.remove('hidden');
                renderDeletedIssuances();
            }
        }

        // ==================== DATA LOADING ====================
        async function loadProducts() {
            const { data, error } = await Layout.db.from('products').select('*, product_categories(*)');
            if (error) { console.error('Error loading products:', error); return; }
            products = data || [];
        }

        async function loadProductCategories() {
            productCategories = await Cache.getOrLoad('product_categories', async () => {
                const { data, error } = await Layout.db.from('product_categories').select('*').order('name_ru');
                if (error) { console.error('Error loading categories:', error); return null; }
                return data;
            });
            productCategories = productCategories || [];
        }

        async function loadStock() {
            const locationId = (await Layout.db.from('locations').select('id').eq('slug', Layout.currentLocation).single()).data?.id;
            const { data, error } = await Layout.db.from('stock').select('*').eq('location_id', locationId);
            if (error) { console.error('Error loading stock:', error); return; }
            stock = data || [];
        }

        async function loadCooks() {
            // Загружаем ID департаментов "Кухня" и "Кафе"
            const { data: depts, error: deptsError } = await Layout.db
                .from('departments')
                .select('id, name_ru')
                .in('name_ru', ['Кухня', 'Кафе']);

            const kitchenDeptIds = depts?.map(d => d.id) || [];

            if (kitchenDeptIds.length === 0) {
                console.warn('Kitchen/Cafe departments not found');
                cooks = [];
                renderCooksSelect();
                return;
            }

            // Загружаем членов команды из этих департаментов
            const { data, error } = await Layout.db
                .from('vaishnavas')
                .select('id, spiritual_name, first_name, last_name, department_id')
                .eq('is_team_member', true)
                .eq('is_deleted', false)
                .in('department_id', kitchenDeptIds)
                .order('spiritual_name');

            if (error) { console.error('Error loading cooks:', error); return; }
            cooks = data || [];
            renderCooksSelect();
        }

        function renderCooksSelect() {
            const select = Layout.$('#issuanceReceiver');
            if (!select) return;
            const e = Layout.escapeHtml;
            select.innerHTML = `<option value="">${tr('select_receiver', '— Выберите —')}</option>` +
                cooks.map(c => {
                    const name = c.spiritual_name || `${c.first_name || ''} ${c.last_name || ''}`.trim() || t('no_name');
                    return `<option value="${c.id}">${e(name)}</option>`;
                }).join('');
        }

        async function loadIssuances() {
            const locationId = (await Layout.db.from('locations').select('id').eq('slug', Layout.currentLocation).single()).data?.id;
            const { data, error } = await Layout.db
                .from('stock_issuances')
                .select('*, stock_issuance_items(*, products(*))')
                .eq('location_id', locationId)
                .order('created_at', { ascending: false });

            if (error) { console.error('Error loading issuances:', error); return; }
            issuances = data || [];
            updateIssuancesCount();
        }

        function updateIssuancesCount() {
            const saved = issuances.filter(r => !r.archived && !r.deleted).length;
            Layout.$('#issuancesCount').textContent = Layout.pluralize(saved, ISSUANCE_FORMS);
        }

        function getStockQuantity(productId) {
            const s = stock.find(s => s.product_id === productId);
            return s ? s.current_quantity : 0;
        }

        // ==================== NEW ISSUANCE ====================
        function renderIssuanceItems() {
            const tbody = Layout.$('#issuanceItems');
            const total = issuanceItemsList.length;
            Layout.$('#issuanceTotal').textContent = total;

            if (issuanceItemsList.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center opacity-50 py-4">${tr('add_products', 'Добавьте продукты')}</td></tr>`;
                return;
            }

            tbody.innerHTML = issuanceItemsList.map((item, idx) => {
                const product = products.find(p => p.id === item.product_id);
                const stockQty = getStockQuantity(item.product_id);
                const displayUnit = item.display_unit || product?.unit || '';
                // Compare in same units
                const qtyInStockUnit = toStockUnit(item.quantity, displayUnit, product?.unit);
                const isOverStock = qtyInStockUnit > stockQty;
                return `
                    <tr>
                        <td>
                            <div class="font-medium">${Layout.getName(product)}</div>
                            ${product?.translit || product?.name_hi ? `<div class="text-xs opacity-50 italic">${product?.translit || Layout.transliterateHindi(product?.name_hi)}</div>` : ''}
                        </td>
                        <td class="opacity-60">${stockQty} ${product?.unit || ''}</td>
                        <td>
                            <div class="flex items-center gap-1">
                                <input type="number" class="input input-bordered input-sm w-20 ${isOverStock ? 'input-error' : ''}" value="${item.quantity}" min="0" step="0.1" onchange="updateIssuanceItem(${idx}, 'quantity', this.value)" />
                                <span class="text-xs opacity-50">${displayUnit}</span>
                            </div>
                            ${product?.waste_percent ? `<div class="text-xs opacity-60 mt-1">(+${product.waste_percent}% ${t('for_cleaning')})</div>` : ''}
                        </td>
                        <td>
                            <button class="btn btn-ghost btn-sm btn-square text-error" data-action="remove-issuance-item" data-index="${idx}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateIssuanceItem(idx, field, value) {
            issuanceItemsList[idx][field] = parseFloat(value) || 0;
            renderIssuanceItems();
        }

        function removeIssuanceItem(idx) {
            issuanceItemsList.splice(idx, 1);
            renderIssuanceItems();
        }

        function addIssuanceItem(productId, quantity = 1, displayUnit = null) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            if (issuanceItemsList.some(i => i.product_id === productId)) {
                showAlert(tr('product_already_added', 'Продукт уже добавлен'));
                return;
            }

            // Учитываем процент на очистку при выдаче
            // Формула: нужно_очищенной / (1 - waste_percent/100)
            const wastePercent = product.waste_percent || 0;
            const quantityToIssue = wastePercent > 0
                ? quantity / (1 - wastePercent / 100)
                : quantity;

            issuanceItemsList.push({
                product_id: productId,
                quantity: quantityToIssue,
                display_unit: displayUnit || product.unit
            });

            renderIssuanceItems();
        }

        // Callback for product modal
        function onProductAdded(product, quantity) {
            addIssuanceItem(product.id, quantity, product.unit);
        }

        // ==================== МЕНЮ: ЗАГРУЗКА И МОДАЛКА ====================
        async function loadMenuRecipes() {
            const { data, error } = await Layout.db
                .from('recipes')
                .select('*, recipe_ingredients(*), category:recipe_categories(*)');
            if (error) { console.error('Error loading recipes:', error); return; }
            menuRecipes = data || [];
        }

        async function loadMenuForPeriod(fromDate, toDate) {
            const locId = Layout.locations?.find(l => l.slug === Layout.currentLocation)?.id;
            if (!locId) return [];
            const { data } = await Layout.db
                .from('menu_meals')
                .select('*, dishes:menu_dishes(*, recipe:recipes(*))')
                .eq('location_id', locId)
                .gte('date', fromDate)
                .lte('date', toDate);
            return data || [];
        }

        function openMenuDishesModal() {
            const today = new Date();
            const weekLater = new Date(today);
            weekLater.setDate(weekLater.getDate() + 6);

            Layout.$('#menuDishesFrom').value = DateUtils.toISO(today);
            Layout.$('#menuDishesTo').value = DateUtils.toISO(weekLater);

            menuDishesData = [];
            menuDishesEatingCounts = {};
            Layout.$('#menuDishesList').innerHTML = `<div class="text-center py-8"><span class="loading loading-spinner"></span></div>`;
            Layout.$('#menuDishesCount').textContent = '0';
            Layout.$('#addDishesBtn').disabled = true;

            menuDishesModal.showModal();
            loadMenuDishes();
        }

        async function loadMenuDishes() {
            const fromDate = Layout.$('#menuDishesFrom').value;
            const toDate = Layout.$('#menuDishesTo').value;
            if (!fromDate || !toDate) return;

            Layout.$('#menuDishesList').innerHTML = `<div class="text-center py-8"><span class="loading loading-spinner"></span></div>`;

            const [menuData, eatingCounts] = await Promise.all([
                loadMenuForPeriod(fromDate, toDate),
                EatingUtils.loadCounts(fromDate, toDate)
            ]);

            menuDishesData = menuData;
            menuDishesEatingCounts = eatingCounts;
            renderMenuDishes();
        }

        function renderMenuDishes() {
            const container = Layout.$('#menuDishesList');

            if (menuDishesData.length === 0) {
                container.innerHTML = `<div class="text-center py-8 opacity-50">${tr('menu_not_found', 'Меню на выбранный период не найдено')}</div>`;
                return;
            }

            // Группировка по дате
            const byDate = {};
            menuDishesData.forEach((meal, mealIdx) => {
                if (!byDate[meal.date]) byDate[meal.date] = [];
                byDate[meal.date].push({ meal, mealIdx });
            });

            const mealTypeOrder = { breakfast: 0, lunch: 1, dinner: 2, menu: 3 };
            const mealTypeLabels = {
                breakfast: tr('breakfast', 'Завтрак'),
                lunch: tr('lunch', 'Обед'),
                dinner: tr('dinner', 'Ужин'),
                menu: tr('menu_day', 'Меню')
            };

            const lang = Layout.currentLang || 'ru';
            let html = '';
            const sortedDates = Object.keys(byDate).sort();

            sortedDates.forEach(dateStr => {
                const d = DateUtils.parseDate(dateStr);
                const dayNum = d.getDate();
                const dayOfWeek = DateUtils.dayNamesShort[lang]?.[d.getDay()] || DateUtils.dayNamesShort.ru[d.getDay()];
                const monthShort = DateUtils.monthNamesShort[lang]?.[d.getMonth()] || DateUtils.monthNamesShort.ru[d.getMonth()];

                const meals = byDate[dateStr].sort((a, b) =>
                    (mealTypeOrder[a.meal.meal_type] || 99) - (mealTypeOrder[b.meal.meal_type] || 99)
                );
                const maxPortions = Math.max(...meals.map(m =>
                    m.meal.portions || EatingUtils.getTotal(menuDishesEatingCounts, dateStr, m.meal.meal_type)
                ));

                html += `<div class="bg-base-100 rounded-lg p-3 border border-base-300">`;
                html += `<div class="flex items-center gap-2 mb-2">`;
                html += `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-40 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>`;
                html += `<span class="font-medium">${dayNum} ${monthShort}, ${dayOfWeek}</span>`;
                html += `<span class="text-sm opacity-50">&middot; ${maxPortions} ${tr('portions_short', 'порц.')}</span>`;
                html += `</div>`;

                meals.forEach(({ meal, mealIdx }) => {
                    const dishes = meal.dishes || [];
                    if (dishes.length === 0) return;

                    const portions = meal.portions || EatingUtils.getTotal(menuDishesEatingCounts, dateStr, meal.meal_type);

                    html += `<div class="ml-6 mb-2">`;
                    html += `<div class="flex items-center gap-1.5 mb-1">`;
                    html += `<input type="checkbox" class="checkbox checkbox-xs meal-toggle-cb" data-meal-idx="${mealIdx}" data-action="toggle-meal">`;
                    html += `<span class="text-sm font-medium opacity-60">${mealTypeLabels[meal.meal_type] || meal.meal_type} <span class="font-normal">(${portions})</span></span>`;
                    html += `</div>`;
                    html += `<div class="flex flex-wrap gap-1.5 ml-5">`;

                    dishes.forEach((dish, dishIdx) => {
                        const recipe = menuRecipes.find(r => r.id === dish.recipe_id);
                        if (!recipe) return;

                        const catColor = recipe.category?.color || '#999';
                        const recipeName = Layout.getName(recipe);

                        html += `
                            <label class="flex items-center gap-1 px-2 py-1 rounded-full text-sm cursor-pointer border transition-colors hover:opacity-80"
                                   style="border-color: ${catColor}40; background-color: ${catColor}10;">
                                <input type="checkbox" class="checkbox checkbox-xs menu-dish-cb"
                                       data-meal-idx="${mealIdx}" data-dish-idx="${dishIdx}"
                                       data-action="toggle-menu-dish">
                                <span style="color: ${catColor}">${recipeName}</span>
                            </label>
                        `;
                    });

                    html += `</div></div>`;
                });

                html += `</div>`;
            });

            container.innerHTML = html;
            updateMenuDishesCount();
        }

        function toggleMeal(mealIdx) {
            const mealCb = document.querySelector(`.meal-toggle-cb[data-meal-idx="${mealIdx}"]`);
            const dishCbs = document.querySelectorAll(`.menu-dish-cb[data-meal-idx="${mealIdx}"]`);
            const checked = mealCb.checked;
            dishCbs.forEach(cb => cb.checked = checked);
            updateMenuDishesCount();
        }

        function updateMenuDishesCount() {
            const checked = document.querySelectorAll('.menu-dish-cb:checked').length;
            Layout.$('#menuDishesCount').textContent = checked;
            Layout.$('#addDishesBtn').disabled = checked === 0;

            // Синхронизируем галочки приёмов пищи
            document.querySelectorAll('.meal-toggle-cb').forEach(mealCb => {
                const idx = mealCb.dataset.mealIdx;
                const all = document.querySelectorAll(`.menu-dish-cb[data-meal-idx="${idx}"]`);
                const allChecked = document.querySelectorAll(`.menu-dish-cb[data-meal-idx="${idx}"]:checked`);
                mealCb.checked = all.length > 0 && all.length === allChecked.length;
                mealCb.indeterminate = allChecked.length > 0 && allChecked.length < all.length;
            });
        }

        function calculateIngredientsFromMenu(menuData, eatingCounts) {
            const ingredientTotals = {};
            menuData.forEach(meal => {
                const mealPortions = meal.portions || EatingUtils.getTotal(eatingCounts, meal.date, meal.meal_type);
                (meal.dishes || []).forEach(dish => {
                    const recipe = menuRecipes.find(r => r.id === dish.recipe_id);
                    if (!recipe?.recipe_ingredients) return;

                    const baseOutputGrams = toBaseUnit(recipe.output_amount || 1, recipe.output_unit || 'kg');
                    const targetGrams = mealPortions * (recipe.portion_amount || 150);
                    const multiplier = targetGrams / baseOutputGrams;

                    recipe.recipe_ingredients.forEach(ing => {
                        if (!ing.product_id) return;
                        const qtyGrams = toBaseUnit(ing.amount || 0, ing.unit || 'g') * multiplier;
                        ingredientTotals[ing.product_id] = (ingredientTotals[ing.product_id] || 0) + qtyGrams;
                    });
                });
            });
            return ingredientTotals;
        }

        function addSelectedDishes() {
            const checkboxes = document.querySelectorAll('.menu-dish-cb:checked');
            if (checkboxes.length === 0) return;

            // Группируем выбранные блюда по meal
            const selectedByMeal = {};
            checkboxes.forEach(cb => {
                const mealIdx = Number(cb.dataset.mealIdx);
                const dishIdx = Number(cb.dataset.dishIdx);
                if (!selectedByMeal[mealIdx]) selectedByMeal[mealIdx] = [];
                selectedByMeal[mealIdx].push(dishIdx);
            });

            // Строим виртуальные meal-объекты только с выбранными блюдами
            const virtualMeals = [];
            Object.entries(selectedByMeal).forEach(([mealIdx, dishIndices]) => {
                const meal = menuDishesData[Number(mealIdx)];
                if (!meal) return;
                virtualMeals.push({
                    ...meal,
                    dishes: dishIndices.map(idx => meal.dishes[idx]).filter(Boolean)
                });
            });

            // Расчёт ингредиентов (в базовых единицах — г/мл)
            const ingredientTotals = calculateIngredientsFromMenu(virtualMeals, menuDishesEatingCounts);

            // Добавляем в список выдачи
            Object.entries(ingredientTotals).forEach(([productId, amountInBaseUnit]) => {
                const product = products.find(p => p.id === productId);
                if (!product) return;

                // Конвертируем в удобные единицы отображения (кг/г, л/мл)
                const display = toSmartDisplay(amountInBaseUnit, product.unit);

                // Если продукт уже есть — увеличиваем количество (в базовых единицах)
                const existing = issuanceItemsList.find(i => i.product_id === productId);
                if (existing) {
                    // Конвертируем существующее количество в базовые, складываем, обратно
                    const existingBase = toBaseUnit(existing.quantity, existing.display_unit);
                    const totalBase = existingBase + amountInBaseUnit;
                    const newDisplay = toSmartDisplay(totalBase, product.unit);
                    existing.quantity = newDisplay.amount;
                    existing.display_unit = newDisplay.unit;
                } else {
                    // addIssuanceItem учитывает waste_percent — используем его
                    addIssuanceItem(productId, display.amount, display.unit);
                }
            });

            menuDishesModal.close();
            renderIssuanceItems();
        }

        // ==================== SAVE ISSUANCE ====================
        let saving = false;

        function setSaving(isSaving) {
            saving = isSaving;
            const btn = Layout.$('#saveIssuanceBtn');
            const spinner = Layout.$('#saveSpinner');
            const text = Layout.$('#saveText');

            btn.disabled = isSaving;
            spinner.classList.toggle('hidden', !isSaving);
            text.textContent = isSaving ? tr('saving', 'Сохранение...') : tr('save_issuance', 'Сохранить выдачу');
        }

        async function saveIssuance() {
            if (!window.hasPermission?.('issue_stock')) return;
            // Блокируем сразу синхронно
            if (saving) return;
            saving = true;
            Layout.$('#saveIssuanceBtn').disabled = true;

            if (issuanceItemsList.length === 0) {
                showAlert(tr('add_at_least_one', 'Добавьте хотя бы один продукт'));
                saving = false;
                Layout.$('#saveIssuanceBtn').disabled = false;
                return;
            }

            // Проверка что выбран получатель
            const receiverId = Layout.$('#issuanceReceiver').value;
            if (!receiverId) {
                showAlert(tr('select_receiver_required', 'Выберите кто получил продукты'));
                saving = false;
                Layout.$('#saveIssuanceBtn').disabled = false;
                return;
            }

            // Check if any items exceed stock
            const overStockItems = [];
            for (const item of issuanceItemsList) {
                const product = products.find(p => p.id === item.product_id);
                const stockQty = getStockQuantity(item.product_id);
                const qtyInStockUnit = toStockUnit(item.quantity, item.display_unit, product?.unit);

                if (qtyInStockUnit > stockQty) {
                    overStockItems.push(Layout.getName(product));
                }
            }

            if (overStockItems.length > 0) {
                showAlert(tr('insufficient_stock', 'Недостаточно на складе') + ':\n' + overStockItems.join(', '));
                saving = false;
                Layout.$('#saveIssuanceBtn').disabled = false;
                return;
            }

            setSaving(true);

            try {
                const locationId = (await Layout.db.from('locations').select('id').eq('slug', Layout.currentLocation).single()).data?.id;

                const items = issuanceItemsList.map(i => {
                    const product = products.find(p => p.id === i.product_id);
                    return {
                        product_id: i.product_id,
                        quantity: toStockUnit(i.quantity, i.display_unit, product?.unit)
                    };
                });

                const { error } = await Layout.db.rpc('save_stock_issuance', {
                    p_location_id: locationId,
                    p_date: Layout.$('#issuanceDate').value,
                    p_receiver_id: receiverId,
                    p_notes: Layout.$('#issuanceNotes').value.trim(),
                    p_items: items
                });

                if (error) {
                    console.error('Error saving issuance:', error);
                    showAlert(tr('save_error', 'Ошибка сохранения'));
                    setSaving(false);
                    return;
                }

                // Clear form and switch to saved tab
                issuanceItemsList = [];
                Layout.$('#issuanceDate').value = DateUtils.toISO(new Date());
                Layout.$('#issuanceReceiver').value = '';
                Layout.$('#issuanceNotes').value = '';
                renderIssuanceItems();

                await loadStock();
                await loadIssuances();
                switchTab('saved');
            } finally {
                setSaving(false);
            }
        }

        // ==================== SAVED ISSUANCES ====================
        function renderSavedIssuances() {
            const container = document.getElementById('savedIssuancesList');
            if (!container) return;

            const saved = issuances.filter(r => !r.archived && !r.deleted);

            if (saved.length === 0) {
                container.innerHTML = `<div class="text-center py-12 opacity-50"><div class="text-4xl mb-2">📤</div><div>${tr('no_issuances', 'Нет сохранённых выдач')}</div></div>`;
                return;
            }

            container.innerHTML = saved.map(rec => renderIssuanceCard(rec, 'saved')).join('');
        }

        function renderArchivedIssuances() {
            const container = document.getElementById('archivedIssuancesList');
            if (!container) return;

            const archived = issuances.filter(r => r.archived && !r.deleted);

            if (archived.length === 0) {
                container.innerHTML = `<div class="text-center py-12 opacity-50"><div class="text-4xl mb-2">📦</div><div>${tr('issuances_empty', 'Нет выдач в архиве')}</div></div>`;
                return;
            }

            container.innerHTML = archived.map(rec => renderIssuanceCard(rec, 'archived')).join('');
        }

        function renderDeletedIssuances() {
            const container = document.getElementById('deletedIssuancesList');
            if (!container) return;

            const deleted = issuances.filter(r => r.deleted);

            if (deleted.length === 0) {
                container.innerHTML = `<div class="text-center py-12 opacity-50"><div class="text-4xl mb-2">🗑️</div><div>${tr('deleted_issuances_empty', 'Нет удалённых выдач')}</div></div>`;
                return;
            }

            container.innerHTML = deleted.map(rec => renderIssuanceCard(rec, 'deleted')).join('');
        }

        function renderIssuanceCard(rec, status) {
            // status: 'saved', 'archived', 'deleted'
            const items = rec.stock_issuance_items || [];
            const date = new Date(rec.issuance_date || rec.created_at).toLocaleDateString('ru-RU');
            const receiverName = getReceiverName(rec.receiver_id);

            const borderColor = status === 'deleted' ? 'border-red-300' : (status === 'archived' ? 'border-gray-300' : 'border-green-500');

            let actions = '';
            if (status === 'saved') {
                actions = `
                    <button class="btn btn-ghost btn-sm text-sm opacity-60 normal-case font-normal" data-action="archive-issuance" data-id="${rec.id}">${tr('to_archive', 'В архив')}</button>
                    <span class="text-base-300">|</span>
                    <button class="btn btn-ghost btn-sm text-sm text-error opacity-60 normal-case font-normal" data-action="delete-issuance" data-id="${rec.id}">${tr('delete', 'Удалить')}</button>
                `;
            } else if (status === 'archived') {
                actions = `
                    <button class="btn btn-ghost btn-sm text-sm text-error opacity-60 normal-case font-normal" data-action="delete-issuance" data-id="${rec.id}">${tr('delete', 'Удалить')}</button>
                `;
            } else if (status === 'deleted') {
                actions = `
                    <button class="btn btn-ghost btn-sm text-sm text-success opacity-60 normal-case font-normal" data-action="restore-issuance" data-id="${rec.id}">${tr('restore', 'Восстановить')}</button>
                    <span class="text-base-300">|</span>
                    <button class="btn btn-ghost btn-sm text-sm text-error opacity-60 normal-case font-normal" data-action="permanent-delete-issuance" data-id="${rec.id}">${tr('delete_permanently', 'Удалить навсегда')}</button>
                `;
            }

            return `
                <div class="bg-base-100 rounded-lg p-4 shadow-sm border-l-4 ${borderColor}">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <div class="font-semibold text-lg">${tr('issuance', 'Выдача')} #${formatNumberWithYear(rec.number || rec.id?.slice(0,4))}</div>
                            <div class="text-sm opacity-60">${date} · ${receiverName}</div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-center">
                                <div class="font-bold" style="color: var(--current-color)">${items.length}</div>
                                <div class="text-xs opacity-60">${tr('items', 'позиций')}</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="btn btn-ghost btn-md" title="${tr('view', 'Просмотр')}" data-action="view-issuance" data-id="${rec.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                </button>
                                <span class="text-base-300">|</span>
                                ${actions}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== VIEW/EDIT ISSUANCE ====================
        function viewIssuance(id) {
            const rec = issuances.find(r => r.id === id);
            if (!rec) return;

            viewingIssuance = rec;
            viewingItems = (rec.stock_issuance_items || []).map(i => ({
                product_id: i.product_id,
                quantity: i.quantity
            }));

            Layout.$('#viewIssuanceTitle').textContent = `${tr('issuance', 'Выдача')} #${formatNumberWithYear(rec.number || id.slice(0,4))}`;
            Layout.$('#viewIssuanceDate').textContent = new Date(rec.issuance_date || rec.created_at).toLocaleDateString('ru-RU');
            Layout.$('#viewIssuanceReceiver').textContent = getReceiverName(rec.receiver_id);
            Layout.$('#viewIssuanceNotes').textContent = rec.notes || '';

            renderViewedIssuance();
            Layout.$('#viewIssuanceModal').showModal();
        }

        function renderViewedIssuance() {
            const tbody = Layout.$('#viewIssuanceItems');
            const total = viewingItems.length;
            Layout.$('#viewIssuanceTotal').textContent = total;

            tbody.innerHTML = viewingItems.map((item, idx) => {
                const product = products.find(p => p.id === item.product_id);
                return `
                    <tr>
                        <td>
                            <div class="font-medium">${Layout.getName(product)}</div>
                            ${product?.translit || product?.name_hi ? `<div class="text-xs opacity-50 italic">${product?.translit || Layout.transliterateHindi(product?.name_hi)}</div>` : ''}
                        </td>
                        <td>
                            <div class="flex items-center gap-1">
                                <input type="number" class="input input-bordered input-sm w-20" value="${item.quantity}" min="0" step="0.1" onchange="updateViewedItem(${idx}, 'quantity', this.value)" />
                                <span class="text-xs opacity-50">${product?.unit || ''}</span>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-ghost btn-sm btn-square text-error" data-action="remove-viewed-item" data-index="${idx}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateViewedItem(idx, field, value) {
            viewingItems[idx][field] = parseFloat(value) || 0;
            renderViewedIssuance();
        }

        function removeViewedItem(idx) {
            viewingItems.splice(idx, 1);
            renderViewedIssuance();
        }

        async function saveViewedIssuance() {
            if (!window.hasPermission?.('issue_stock')) return;
            if (!viewingIssuance) return;

            const items = viewingItems.map(i => ({
                product_id: i.product_id,
                quantity: i.quantity
            }));

            const { error } = await Layout.db.rpc('update_stock_issuance_items', {
                p_issuance_id: viewingIssuance.id,
                p_items: items
            });

            if (error) {
                console.error('Error updating issuance items:', error);
                showAlert(tr('save_error', 'Ошибка сохранения'));
                return;
            }

            closeViewIssuanceModal();
            await loadIssuances();
            if (currentTab === 'saved') renderSavedIssuances();
            if (currentTab === 'archive') renderArchivedIssuances();
        }

        function closeViewIssuanceModal() {
            Layout.$('#viewIssuanceModal').close();
            viewingIssuance = null;
            viewingItems = [];
        }

        function printViewedIssuance() {
            window.print();
        }

        // ==================== ARCHIVE & DELETE ====================
        async function archiveIssuance(id) {
            if (!window.hasPermission?.('issue_stock')) return;
            if (!await showConfirm(tr('archive_confirm', 'Переместить в архив?'))) return;

            const { error } = await Layout.db.from('stock_issuances').update({ archived: true }).eq('id', id);
            if (error) {
                console.error('Error archiving:', error);
                return;
            }
            await loadIssuances();
            renderSavedIssuances();
        }

        async function deleteIssuance(id) {
            if (!window.hasPermission?.('issue_stock')) return;
            if (!await showConfirm(tr('delete_confirm', 'Переместить в удалённые?'))) return;

            const { error } = await Layout.db.from('stock_issuances').update({ deleted: true }).eq('id', id);
            if (error) {
                console.error('Error deleting:', error);
                return;
            }
            await loadIssuances();
            if (currentTab === 'saved') renderSavedIssuances();
            if (currentTab === 'archive') renderArchivedIssuances();
        }

        async function restoreIssuance(id) {
            if (!window.hasPermission?.('issue_stock')) return;
            const { error } = await Layout.db.from('stock_issuances').update({ deleted: false }).eq('id', id);
            if (error) {
                console.error('Error restoring:', error);
                return;
            }
            await loadIssuances();
            renderDeletedIssuances();
        }

        async function permanentDeleteIssuance(id) {
            if (!window.hasPermission?.('issue_stock')) return;
            if (!await showConfirm(tr('permanent_delete_confirm', 'Удалить навсегда? Количества на складе будут возвращены. Это действие нельзя отменить!'))) return;

            const rec = issuances.find(r => r.id === id);
            if (!rec) return;

            const locationId = (await Layout.db.from('locations').select('id').eq('slug', Layout.currentLocation).single()).data?.id;

            // Возвращаем количества на склад (ADD back)
            for (const item of (rec.stock_issuance_items || [])) {
                const { data: stockItem } = await Layout.db
                    .from('stock')
                    .select('id, current_quantity')
                    .eq('product_id', item.product_id)
                    .eq('location_id', locationId)
                    .single();

                if (stockItem) {
                    const newQty = stockItem.current_quantity + item.quantity;
                    await Layout.db.from('stock').update({ current_quantity: newQty }).eq('id', stockItem.id);
                }
            }

            // Удаляем items
            await Layout.db.from('stock_issuance_items').delete().eq('issuance_id', id);

            // Удаляем выдачу
            const { error } = await Layout.db.from('stock_issuances').delete().eq('id', id);
            if (error) {
                console.error('Error deleting issuance:', error);
                return;
            }

            await loadStock();
            await loadIssuances();
            renderDeletedIssuances();
        }

        // ==================== EVENT LISTENERS ====================
        window.onLanguageChange = function(lang) {
            Layout.updateAllTranslations();
            renderIssuanceItems();
            if (currentTab === 'saved') renderSavedIssuances();
            if (currentTab === 'archive') renderArchivedIssuances();
            if (currentTab === 'deleted') renderDeletedIssuances();
        };

        window.onLocationChange = async function() {
            await loadStock();
            await loadIssuances();
            updateMealTypeCheckboxes();
            renderIssuanceItems();
            if (currentTab === 'saved') renderSavedIssuances();
            if (currentTab === 'archive') renderArchivedIssuances();
            if (currentTab === 'deleted') renderDeletedIssuances();
        };

        // Скрыть/показать чекбоксы приёмов пищи в зависимости от локации
        function updateMealTypeCheckboxes() {
            const mealTypeSection = Layout.$('#mealTypeSection');
            if (mealTypeSection) {
                mealTypeSection.classList.toggle('hidden', Layout.currentLocation === 'cafe');
            }
        }

        // ==================== CHOICE SECTION ====================
        function showChoiceSection() {
            Layout.$('#issueChoiceSection').classList.remove('hidden');
            Layout.$('#issueFormSection').classList.add('hidden');
        }

        function showFormSection() {
            Layout.$('#issueChoiceSection').classList.add('hidden');
            Layout.$('#issueFormSection').classList.remove('hidden');
        }

        function backToChoice() {
            issuanceItemsList = [];
            renderIssuanceItems();
            showChoiceSection();
        }

        function createManualIssue() {
            issuanceItemsList = [];
            Layout.$('#issuanceDate').value = DateUtils.toISO(new Date());
            Layout.$('#issuanceReceiver').value = '';
            Layout.$('#issuanceNotes').value = '';
            renderIssuanceItems();
            showFormSection();
        }

        async function generateFromMenu() {
            const date = Layout.$('#menuLoadDate').value;
            const isCafe = Layout.currentLocation === 'cafe';

            // Для кафе используем 'menu', для остальных — выбранные чекбоксы
            let mealTypes = [];
            if (isCafe) {
                mealTypes = ['menu'];
            } else {
                const includeBreakfast = Layout.$('#menuLoadBreakfast').checked;
                const includeLunch = Layout.$('#menuLoadLunch').checked;
                const includeDinner = Layout.$('#menuLoadDinner').checked;

                if (!includeBreakfast && !includeLunch && !includeDinner) {
                    showAlert(tr('select_meal', 'Выберите хотя бы один приём пищи'));
                    return;
                }

                if (includeBreakfast) mealTypes.push('breakfast');
                if (includeLunch) mealTypes.push('lunch');
                if (includeDinner) mealTypes.push('dinner');
            }

            try {
                // Get location ID
                const locationId = (await Layout.db.from('locations').select('id').eq('slug', Layout.currentLocation).single()).data?.id;

                // Step 1: Get meals for the selected date
                const { data: meals, error: mealsError } = await Layout.db
                    .from('menu_meals')
                    .select('id, meal_type, portions, date')
                    .eq('location_id', locationId)
                    .eq('date', date)
                    .in('meal_type', mealTypes);

                if (mealsError) throw mealsError;

                if (!meals || meals.length === 0) {
                    showAlert(tr('no_menu_for_date', 'На выбранную дату меню не найдено'));
                    return;
                }

                // Step 2: Get dishes for these meals
                const mealIds = meals.map(m => m.id);

                const { data: dishes, error: dishesError } = await Layout.db
                    .from('menu_dishes')
                    .select('meal_id, recipe_id')
                    .in('meal_id', mealIds);

                if (dishesError) throw dishesError;

                if (!dishes || dishes.length === 0) {
                    showAlert(tr('no_dishes', 'Для выбранных приёмов пищи нет блюд'));
                    return;
                }

                // Step 3: Get recipes to know their output (for scaling)
                const recipeIds = [...new Set(dishes.map(d => d.recipe_id))];
                const { data: recipes, error: recipesError } = await Layout.db
                    .from('recipes')
                    .select('id, output_amount, output_unit, portion_amount, portion_unit')
                    .in('id', recipeIds);

                if (recipesError) throw recipesError;

                // Step 4: Get ingredients for these recipes (with unit!)
                const { data: ingredients, error: ingredientsError } = await Layout.db
                    .from('recipe_ingredients')
                    .select('recipe_id, product_id, amount, unit')
                    .in('recipe_id', recipeIds);

                if (ingredientsError) throw ingredientsError;

                // Build lookup maps
                const mealsMap = {};
                meals.forEach(m => mealsMap[m.id] = m);

                const recipesMap = {};
                recipes.forEach(r => recipesMap[r.id] = r);

                // Calculate how many portions a recipe makes
                function getRecipePortions(recipe) {
                    if (!recipe || !recipe.output_amount || !recipe.portion_amount) {
                        return 1; // fallback
                    }
                    // Convert both to same base unit
                    const output = toBaseUnit(recipe.output_amount, recipe.output_unit);
                    const portion = toBaseUnit(recipe.portion_amount, recipe.portion_unit);
                    if (portion <= 0) return 1;
                    return output / portion;
                }

                // Загружаем кол-во едоков как fallback (если повар не задал порции вручную)
                const eatingCounts = await EatingUtils.loadCounts(date, date);

                // Collect all ingredients with proper scaling
                const ingredientsMap = {};

                dishes.forEach(dish => {
                    const meal = mealsMap[dish.meal_id];
                    const recipe = recipesMap[dish.recipe_id];
                    if (!meal) return;

                    const mealPortions = meal.portions || EatingUtils.getTotal(eatingCounts, meal.date, meal.meal_type);
                    const recipePortions = getRecipePortions(recipe);
                    const scale = mealPortions / recipePortions;

                    // Find ingredients for this recipe
                    const recipeIngredients = ingredients.filter(i => i.recipe_id === dish.recipe_id);

                    recipeIngredients.forEach(ing => {
                        if (!ing.product_id) return;

                        if (!ingredientsMap[ing.product_id]) {
                            ingredientsMap[ing.product_id] = 0;
                        }
                        const baseAmount = toBaseUnit(ing.amount || 0, ing.unit);
                        ingredientsMap[ing.product_id] += baseAmount * scale;
                    });
                });

                if (Object.keys(ingredientsMap).length === 0) {
                    showAlert(tr('no_ingredients', 'Ингредиенты не найдены'));
                    return;
                }

                // Clear existing items and add from menu
                issuanceItemsList = [];

                Object.entries(ingredientsMap).forEach(([productId, amountInBaseUnit]) => {
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        // Convert to smart display (kg/g, l/ml)
                        const display = toSmartDisplay(amountInBaseUnit, product.unit);

                        // Учитываем процент на очистку (овощи/фрукты)
                        // Формула: нужно_очищенной / (1 - waste_percent/100)
                        const wastePercent = product?.waste_percent || 0;
                        const quantityWithWaste = wastePercent > 0
                            ? display.amount / (1 - wastePercent / 100)
                            : display.amount;

                        issuanceItemsList.push({
                            product_id: productId,
                            quantity: Layout.formatQuantity(quantityWithWaste, display.unit),
                            display_unit: display.unit
                        });
                    }
                });

                renderIssuanceItems();

                // Update the issuance date to match menu date
                Layout.$('#issuanceDate').value = date;

                showFormSection();

            } catch (error) {
                console.error('Error loading from menu:', error);
                showAlert(tr('load_error', 'Ошибка загрузки'));
            }
        }

        // ==================== INIT ====================
        async function init() {
            await Layout.init({ module: 'kitchen', menuId: 'stock', itemId: 'issue' });

            // Set initial dates
            const today = DateUtils.toISO(new Date());
            Layout.$('#issuanceDate').value = today;
            Layout.$('#menuLoadDate').value = today;

            // Style initial active tab
            const activeBtn = document.querySelector('#mainTabs .tab[data-tab="new"]');
            activeBtn.style.backgroundColor = 'var(--current-color)';
            activeBtn.style.color = 'white';

            await loadProducts();
            await loadProductCategories();
            await loadStock();
            await loadCooks();
            await loadIssuances();
            await loadMenuRecipes();

            renderIssuanceItems();
            renderSavedIssuances();
            renderArchivedIssuances();
            renderDeletedIssuances();
            updateMealTypeCheckboxes();
            initialized = true;
            Layout.updateAllTranslations();
        }

        // ==================== EVENT DELEGATION ====================
        document.addEventListener('click', e => {
            const el = e.target.closest('[data-action]');
            if (!el) return;
            const action = el.dataset.action;
            const id = el.dataset.id;
            const index = el.dataset.index;

            switch(action) {
                case 'select-product': selectProduct(id); break;
                case 'remove-issuance-item': removeIssuanceItem(parseInt(index)); break;
                case 'archive-issuance': archiveIssuance(id); break;
                case 'delete-issuance': deleteIssuance(id); break;
                case 'restore-issuance': restoreIssuance(id); break;
                case 'permanent-delete-issuance': permanentDeleteIssuance(id); break;
                case 'view-issuance': viewIssuance(id); break;
                case 'remove-viewed-item': removeViewedItem(parseInt(index)); break;
            }
        });

        // Делегирование change-событий для модалки меню
        document.addEventListener('change', e => {
            const el = e.target.closest('[data-action]');
            if (!el) return;
            if (el.dataset.action === 'toggle-menu-dish') updateMenuDishesCount();
            if (el.dataset.action === 'toggle-meal') toggleMeal(el.dataset.mealIdx);
        });

        init();
    </script>
</body>
</html>
