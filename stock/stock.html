<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script src="../js/color-init.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Å—Ç–∞—Ç–∫–∏ ‚Äî –®–†–°–ö</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        .status-ok { background-color: rgba(107, 158, 90, 0.15); border-left: 4px solid #6B9E5A; }
        .status-low { background-color: rgba(212, 168, 75, 0.15); border-left: 4px solid #D4A84B; }
        .status-critical { background-color: rgba(220, 38, 38, 0.15); border-left: 4px solid #DC2626; }
        .trend-up { color: #DC2626; }
        .trend-down { color: #6B9E5A; }
        .trend-stable { color: #6B7280; }
        /* –£–±–∏—Ä–∞–µ–º —Å—Ç—Ä–µ–ª–∫–∏ —É —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 flex-1">

        <div class="mb-6">
            <h1 class="text-2xl font-bold" data-i18n="stock_inventory_title">–û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ</h1>
            <p class="text-sm opacity-60" id="stockCount" data-i18n="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 mb-4">
            <div class="flex-1 max-w-md relative">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." class="input input-bordered w-full pr-10" data-i18n-placeholder="search_placeholder" />
                <button type="button" id="clearSearch" class="absolute right-3 top-1/2 -translate-y-1/2 text-base-content/40 hover:text-base-content hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <select id="sortSelect" class="select select-bordered w-full sm:w-auto">
                <option value="priority" data-i18n="sort_priority">–ü–æ –≤–∞–∂–Ω–æ—Å—Ç–∏</option>
                <option value="name_asc" data-i18n="sort_name_asc">–ê ‚Üí –Ø</option>
                <option value="name_desc" data-i18n="sort_name_desc">–Ø ‚Üí –ê</option>
            </select>
        </div>

        <div class="flex flex-wrap gap-2 mb-6" id="categoryFilters">
            <div class="skeleton h-8 w-16"></div>
            <div class="skeleton h-8 w-20"></div>
            <div class="skeleton h-8 w-20"></div>
        </div>

        <div class="space-y-3" id="stockList">
            <!-- Skeleton loader -->
            <div class="bg-base-100 rounded-lg p-4 shadow-sm border-l-4 border-base-300"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><div class="skeleton w-10 h-10 rounded-lg"></div><div><div class="skeleton h-5 w-32 mb-1"></div><div class="skeleton h-3 w-20"></div></div></div><div class="flex items-center gap-4"><div class="skeleton h-8 w-24"></div><div class="skeleton h-4 w-16"></div></div></div></div>
            <div class="bg-base-100 rounded-lg p-4 shadow-sm border-l-4 border-base-300"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><div class="skeleton w-10 h-10 rounded-lg"></div><div><div class="skeleton h-5 w-40 mb-1"></div><div class="skeleton h-3 w-24"></div></div></div><div class="flex items-center gap-4"><div class="skeleton h-8 w-20"></div><div class="skeleton h-4 w-12"></div></div></div></div>
            <div class="bg-base-100 rounded-lg p-4 shadow-sm border-l-4 border-base-300"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><div class="skeleton w-10 h-10 rounded-lg"></div><div><div class="skeleton h-5 w-28 mb-1"></div><div class="skeleton h-3 w-16"></div></div></div><div class="flex items-center gap-4"><div class="skeleton h-8 w-28"></div><div class="skeleton h-4 w-20"></div></div></div></div>
            <div class="bg-base-100 rounded-lg p-4 shadow-sm border-l-4 border-base-300"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><div class="skeleton w-10 h-10 rounded-lg"></div><div><div class="skeleton h-5 w-36 mb-1"></div><div class="skeleton h-3 w-20"></div></div></div><div class="flex items-center gap-4"><div class="skeleton h-8 w-24"></div><div class="skeleton h-4 w-16"></div></div></div></div>
        </div>

    </main>

    <div id="footer-placeholder"></div>

    <script src="../js/config.js"></script>
    <script src="../js/auth-check.js?v=3"></script>
    <script src="../js/cache.js"></script>
    <script src="../js/utils.js?v=2"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/layout.js?v=5"></script>
    <script>
        // ==================== STATE ====================
        let currentCategory = 'all';
        let searchQuery = '';
        let currentSort = 'priority';
        let stockItems = [];
        let products = [];
        let categories = [];
        let locationId = null;

        const t = key => Layout.t(key);

        function tr(key, fallback) {
            const val = t(key);
            return (val && val !== key) ? val : fallback;
        }

        // ==================== HELPER FUNCTIONS ====================
        const UNITS = {
            kg: { ru: '–∫–≥', en: 'kg', hi: '‡§ï‡§ø‡§≤‡•ã' },
            g: { ru: '–≥', en: 'g', hi: '‡§ó‡•ç‡§∞‡§æ‡§Æ' },
            l: { ru: '–ª', en: 'l', hi: '‡§≤‡•Ä‡§ü‡§∞' },
            ml: { ru: '–º–ª', en: 'ml', hi: '‡§Æ‡§ø‡§≤‡•Ä' },
            pcs: { ru: '—à—Ç', en: 'pcs', hi: '‡§ü‡•Å‡§ï‡§°‡§º‡§æ' },
            pack: { ru: '—É–ø', en: 'pack', hi: '‡§™‡•à‡§ï‡•á‡§ü' }
        };

        function localizeUnit(unit) {
            if (!unit) return '';
            const lang = Layout.currentLang;
            return UNITS[unit]?.[lang] || unit;
        }

        // ==================== UPDATE STOCK ====================
        async function updateStockQuantity(stockId, newQuantity) {
            const { error } = await Layout.db
                .from('stock')
                .update({ current_quantity: newQuantity })
                .eq('id', stockId);

            if (error) {
                console.error('Error updating stock:', error);
                return;
            }

            // Update local data and re-render
            const item = stockItems.find(s => s.id === stockId);
            if (item) {
                item.current_quantity = newQuantity;
                renderCategoryFilters();
                renderStock();
            }
        }

        const ITEM_FORMS = {
            ru: ['–ø–æ–∑–∏—Ü–∏—è', '–ø–æ–∑–∏—Ü–∏–∏', '–ø–æ–∑–∏—Ü–∏–π'],
            en: ['item', 'items'],
            hi: '‡§Ü‡§á‡§ü‡§Æ'
        };

        // ==================== DATA LOADING ====================
        async function loadLocationId() {
            const { data } = await Layout.db
                .from('locations')
                .select('id')
                .eq('slug', Layout.currentLocation)
                .single();
            locationId = data?.id;
        }

        async function loadCategories() {
            categories = await Cache.getOrLoad('product_categories', async () => {
                const { data, error } = await Layout.db.from('product_categories').select('id, slug, name_ru, name_en, name_hi, emoji').order('name_ru');
                if (error) { console.error('Error loading categories:', error); return null; }
                return data;
            });
            categories = categories || [];
            renderCategoryFilters();
        }

        async function loadProducts() {
            const { data, error } = await Layout.db.from('products').select('id, name_ru, name_en, name_hi, unit, product_categories(id, slug, name_ru, name_en, name_hi)');
            if (error) { console.error('Error loading products:', error); return; }
            products = data;
        }

        async function loadStock() {
            if (!locationId) return;

            const { data, error } = await Layout.db
                .from('stock')
                .select('id, current_quantity, min_quantity, placement, supplier, location_id, products(id, name_ru, name_en, name_hi, unit, product_categories(id, slug, name_ru, name_en, name_hi))')
                .eq('location_id', locationId);

            if (error) { console.error('Error loading stock:', error); return; }
            stockItems = data || [];
            renderStock();
        }

        // ==================== RENDERING ====================

        function getStatus(item) {
            if (!item) return 'none';
            if (item.current_quantity <= 0) return 'critical';
            if (item.current_quantity < item.min_quantity) return 'critical';
            if (item.current_quantity < item.min_quantity * 1.5) return 'low';
            return 'ok';
        }

        function renderCategoryFilters() {
            const container = Layout.$('#categoryFilters');
            // –°—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–∏ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º > 0
            const visibleItems = stockItems.filter(item => item.current_quantity > 0);
            const counts = { all: visibleItems.length };

            visibleItems.forEach(item => {
                const slug = item.products?.product_categories?.slug;
                if (slug) counts[slug] = (counts[slug] || 0) + 1;
            });

            let html = `<button class="btn btn-sm ${currentCategory === 'all' ? '' : 'btn-ghost'}" data-category="all" style="${currentCategory === 'all' ? 'background-color: var(--current-color); border-color: var(--current-color); color: white;' : ''}">${t('all')}<sup class="ml-1 opacity-60">${counts.all || 0}</sup></button>`;

            categories.forEach(cat => {
                const isActive = currentCategory === cat.slug;
                html += `<button class="btn btn-sm ${isActive ? '' : 'btn-ghost'}" data-category="${cat.slug}" style="${isActive ? 'background-color: var(--current-color); border-color: var(--current-color); color: white;' : ''}">${cat.emoji || ''} ${Layout.getName(cat)}<sup class="ml-1 opacity-60">${counts[cat.slug] || 0}</sup></button>`;
            });

            container.innerHTML = html;
            container.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentCategory = btn.dataset.category;
                    renderCategoryFilters();
                    renderStock();
                });
            });
        }

        function renderStock() {
            const container = Layout.$('#stockList');
            const lang = Layout.currentLang;

            let filtered = stockItems.filter(item => {
                // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ —Å –Ω—É–ª–µ–≤—ã–º –æ—Å—Ç–∞—Ç–∫–æ–º
                if (item.current_quantity <= 0) return false;

                const matchesCategory = currentCategory === 'all' || item.products?.product_categories?.slug === currentCategory;
                const product = item.products;
                const matchesSearch = searchQuery === '' ||
                    product?.name_ru?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    product?.name_en?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    product?.name_hi?.includes(searchQuery);
                return matchesCategory && matchesSearch;
            });

            // Sort based on selected option
            filtered.sort((a, b) => {
                const nameA = (Layout.getName(a.products) || '').toLowerCase();
                const nameB = (Layout.getName(b.products) || '').toLowerCase();

                switch (currentSort) {
                    case 'name_asc':
                        return nameA.localeCompare(nameB, 'ru');
                    case 'name_desc':
                        return nameB.localeCompare(nameA, 'ru');
                    case 'priority':
                    default:
                        // –ü–æ –≤–∞–∂–Ω–æ—Å—Ç–∏: –∫—Ä–∏—Ç–∏—á–Ω—ã–µ ‚Üí –Ω–∏–∑–∫–∏–µ ‚Üí –Ω–æ—Ä–º–∞
                        const order = { critical: 0, low: 1, ok: 2, none: 3 };
                        const statusA = order[getStatus(a)] ?? 3;
                        const statusB = order[getStatus(b)] ?? 3;
                        if (statusA !== statusB) return statusA - statusB;
                        return nameA.localeCompare(nameB, 'ru');
                }
            });

            Layout.$('#stockCount').textContent = Layout.pluralize(filtered.length, ITEM_FORMS);

            if (filtered.length === 0) {
                container.innerHTML = `<div class="text-center py-12 opacity-50"><div class="text-4xl mb-2">üì¶</div><div>${t('no_items')}</div></div>`;
                return;
            }

            container.innerHTML = filtered.map(item => {
                const product = item.products;
                const cat = product?.product_categories;
                const status = getStatus(item);
                const statusClass = status === 'critical' ? 'status-critical' : status === 'low' ? 'status-low' : 'status-ok';
                const secondaryLang = lang === 'ru' ? 'en' : 'ru';

                return `
                    <div class="bg-base-100 rounded-lg p-4 shadow-sm ${statusClass}">
                        <div class="flex flex-col md:flex-row md:items-center gap-4">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 flex-wrap">
                                    <span class="font-semibold text-lg">${Layout.getName(product)}</span>
                                    <span class="text-sm opacity-50">${product?.[`name_${secondaryLang}`] || ''}</span>
                                </div>
                                <div class="text-sm opacity-60">${Layout.getName(cat) || ''}</div>
                                ${item.placement || item.supplier ? `
                                <div class="text-xs opacity-50 mt-1 flex flex-wrap gap-3">
                                    ${item.placement ? `<span title="${t('placement')}">üìç ${item.placement}</span>` : ''}
                                    ${item.supplier ? `<span title="${t('supplier')}">üì¶ ${item.supplier}</span>` : ''}
                                </div>
                                ` : ''}
                            </div>

                            <div class="flex items-center gap-6">
                                <div class="text-center">
                                    <div class="join">
                                        <input type="number"
                                            class="input input-bordered join-item w-20 text-xl font-bold text-center ${status === 'critical' ? 'text-red-600' : status === 'low' ? 'text-yellow-600' : ''}"
                                            value="${item.current_quantity}"
                                            min="0"
                                            step="0.1"
                                            onchange="updateStockQuantity('${item.id}', parseFloat(this.value) || 0)"
                                        />
                                        <span class="btn join-item no-animation pointer-events-none bg-base-200 text-lg">${localizeUnit(product?.unit)}</span>
                                    </div>
                                    <div class="text-xs opacity-50 mt-1">${tr('stock_should_be', '–º–∏–Ω.')} ‚â• ${item.min_quantity} ${localizeUnit(product?.unit)}</div>
                                </div>

                                                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderSortSelect() {
            const select = Layout.$('#sortSelect');
            const options = [
                { value: 'priority', key: 'sort_priority', fallback: '–ü–æ –≤–∞–∂–Ω–æ—Å—Ç–∏' },
                { value: 'name_asc', key: 'sort_name_asc', fallback: '–ê ‚Üí –Ø' },
                { value: 'name_desc', key: 'sort_name_desc', fallback: '–Ø ‚Üí –ê' }
            ];
            select.innerHTML = options.map(opt => {
                const label = tr(opt.key, opt.fallback);
                return `<option value="${opt.value}" ${currentSort === opt.value ? 'selected' : ''}>${label}</option>`;
            }).join('');
        }

        function updatePageLanguage() {
            Layout.updateAllTranslations();
            renderSortSelect();
            renderCategoryFilters();
            renderStock();
        }

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = Layout.$('#searchInput');
            const clearBtn = Layout.$('#clearSearch');
            const debouncedSearch = Layout.debounce(() => renderStock(), 200);

            searchInput?.addEventListener('input', e => {
                searchQuery = e.target.value;
                clearBtn?.classList.toggle('hidden', !e.target.value);
                debouncedSearch();
            });

            clearBtn?.addEventListener('click', () => {
                searchInput.value = '';
                searchQuery = '';
                clearBtn.classList.add('hidden');
                renderStock();
                searchInput.focus();
            });

            // Sort select
            Layout.$('#sortSelect')?.addEventListener('change', e => {
                currentSort = e.target.value;
                renderStock();
            });
        });

        window.onLanguageChange = function(lang) {
            updatePageLanguage();
        };

        // –ö–æ–ª–±—ç–∫ –ø—Ä–∏ —Å–º–µ–Ω–µ –ª–æ–∫–∞—Ü–∏–∏
        window.onLocationChange = async function() {
            await loadLocationId();
            await loadStock();
            renderCategoryFilters();
        };

        // ==================== INIT ====================
        async function init() {
            await Layout.init({ module: 'kitchen', menuId: 'stock', itemId: 'stock_balance' });
            Layout.showLoader();
            await loadLocationId();
            await loadCategories();
            await loadProducts();
            await loadStock();
            updatePageLanguage();
            Layout.hideLoader();

            // Realtime: –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
            subscribeToRealtime();
        }

        // Realtime –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∫–ª–∞–¥–∞
        function subscribeToRealtime() {
            Layout.db.channel('stock-realtime')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'stock' },
                    handleRealtimeChange
                )
                .subscribe();
        }

        let realtimeTimeout = null;
        function handleRealtimeChange(payload) {
            if (realtimeTimeout) clearTimeout(realtimeTimeout);
            realtimeTimeout = setTimeout(async () => {
                await loadStock();
                Layout.showNotification(t('data_updated'), 'info');
            }, 500);
        }

        init();
    </script>
</body>
</html>
