<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script>(function(){var c={kitchen:'#f49800',housing:'#8b5cf6'};var m=localStorage.getItem('srsk_module')||'kitchen';document.documentElement.style.setProperty('--current-color',c[m]||c.kitchen);})();</script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞—è–≤–∫–∞ –Ω–∞ –∑–∞–∫—É–ø–∫—É ‚Äî –®–†–°–ö</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 flex-1">

        <div class="flex justify-between items-start mb-6">
            <div>
                <h1 class="text-2xl font-bold" data-i18n="purchase_request_title">–ó–∞—è–≤–∫–∞ –Ω–∞ –∑–∞–∫—É–ø–∫—É</h1>
                <p class="text-sm opacity-60" data-i18n="purchase_request_subtitle">–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è –∑–∞–∫—É–ø–∫–∏</p>
            </div>
            <a href="stock.html" class="link link-hover text-sm opacity-60 flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                <span data-i18n="back_to_stock">–ù–∞ —Å–∫–ª–∞–¥</span>
            </a>
        </div>

        <!-- Tabs -->
        <div class="tabs tabs-boxed bg-base-100 p-1 mb-6 inline-flex" id="mainTabs">
            <button class="tab tab-active" data-tab="new" onclick="switchTab('new')" data-i18n="new_request_tab">–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</button>
            <button class="tab" data-tab="saved" onclick="switchTab('saved')" data-i18n="saved_requests_tab">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ</button>
            <button class="tab" data-tab="archive" onclick="switchTab('archive')" data-i18n="archived_requests_tab">–ê—Ä—Ö–∏–≤–Ω—ã–µ</button>
        </div>

        <!-- Tab: New Request -->
        <div id="tabContentNew">

        <!-- Choice: From Menu or Manual -->
        <div id="requestChoiceSection" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Option 1: From Menu -->
            <div class="bg-base-100 rounded-lg p-6 shadow-sm">
                <div class="text-lg font-semibold mb-2" data-i18n="request_from_menu_title">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∑–∞—è–≤–∫—É –∏–∑ –º–µ–Ω—é</div>
                <p class="text-sm opacity-60 mb-4" data-i18n="request_from_menu_desc">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –Ω—É–∂–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ–Ω—é</p>

                <div class="text-sm font-medium mb-3 opacity-70" data-i18n="menu_period">–ü–µ—Ä–∏–æ–¥ –º–µ–Ω—é</div>

                <div class="flex flex-wrap items-center gap-2 mb-4">
                    <button class="btn btn-sm period-btn" data-period="today" onclick="selectPeriod('today')" data-i18n="period_today">–°–µ–≥–æ–¥–Ω—è</button>
                    <button class="btn btn-sm btn-ghost period-btn" data-period="3days" onclick="selectPeriod('3days')" data-i18n="period_3days">3 –¥–Ω—è</button>
                    <button class="btn btn-sm btn-ghost period-btn" data-period="week" onclick="selectPeriod('week')" data-i18n="period_week">–ù–µ–¥–µ–ª—è</button>
                    <button class="btn btn-sm btn-ghost period-btn" data-period="2weeks" onclick="selectPeriod('2weeks')" data-i18n="period_2weeks">2 –Ω–µ–¥–µ–ª–∏</button>
                </div>

                <div class="flex flex-wrap items-center gap-2 mb-4">
                    <span class="text-sm opacity-60" data-i18n="from">—Å</span>
                    <input type="date" id="periodFrom" class="input input-bordered input-sm w-36" />
                    <span class="text-sm opacity-60" data-i18n="to">–ø–æ</span>
                    <input type="date" id="periodTo" class="input input-bordered input-sm w-36" />
                </div>

                <button class="btn btn-primary w-full" onclick="generateRequest()" data-i18n="generate">
                    –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>

            <!-- Option 2: Manual -->
            <div class="bg-base-100 rounded-lg p-6 shadow-sm flex flex-col">
                <div class="text-lg font-semibold mb-2" data-i18n="request_manual_title">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –≤—Ä—É—á–Ω—É—é</div>
                <p class="text-sm opacity-60 mb-4" data-i18n="request_manual_desc">–í–≤–µ—Å—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è –∑–∞—è–≤–∫–∏ –≤—Ä—É—á–Ω—É—é</p>

                <div class="flex-1"></div>

                <button class="btn btn-outline btn-primary w-full" onclick="createManualRequest()" data-i18n="create_request">
                    –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
                </button>
            </div>
        </div>

        <!-- Results -->
        <div id="resultsSection" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 id="requestTitle" class="text-lg font-semibold">–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</h2>
                <button id="saveBtn" class="btn btn-primary btn-sm gap-1" onclick="saveRequest()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg>
                    <span data-i18n="save_request">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                </button>
            </div>

            <div class="bg-base-100 rounded-lg shadow-sm overflow-hidden">
                <table class="table">
                    <thead class="bg-base-200">
                        <tr>
                            <th data-i18n="product">–ü—Ä–æ–¥—É–∫—Ç</th>
                            <th data-i18n="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th class="text-right" data-i18n="needed">–ù—É–∂–Ω–æ</th>
                            <th class="text-right" data-i18n="in_stock">–ù–∞ —Å–∫–ª–∞–¥–µ</th>
                            <th class="text-right w-32" data-i18n="to_purchase">–ó–∞–∫—É–ø–∏—Ç—å</th>
                            <th class="text-right" data-i18n="est_price">‚âà –°—É–º–º–∞</th>
                            <th class="w-10"></th>
                        </tr>
                    </thead>
                    <tbody id="requestItemsTable"></tbody>
                </table>
            </div>

            <div class="mt-4 flex flex-wrap justify-between items-center gap-4">
                <button class="btn btn-ghost btn-sm gap-1" onclick="openProductModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    <span data-i18n="add_product">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</span>
                </button>
                <div class="flex items-center gap-6">
                    <div>
                        <span class="text-sm opacity-60" data-i18n="total_items">–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π: </span>
                        <span class="font-bold" id="totalItems">0</span>
                    </div>
                    <div>
                        <span class="text-sm opacity-60" data-i18n="est_total">–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—É–º–º–∞: </span>
                        <span class="font-bold text-lg" id="totalSum">‚Äî</span>
                    </div>
                </div>
            </div>
        </div>


        </div><!-- /tabContentNew -->

        <!-- Tab: Saved Requests -->
        <div id="tabContentSaved" class="hidden">
            <div class="space-y-3" id="savedRequestsList"></div>
        </div>

        <!-- Tab: Archived Requests -->
        <div id="tabContentArchive" class="hidden">
            <div class="space-y-3" id="archivedRequestsList"></div>
        </div>

    </main>

    <div id="footer-placeholder"></div>

    <!-- Print-only container (outside modal) -->
    <div id="printContainer" class="hidden print:block">
        <!-- –ö—Ä—É–ø–Ω–∞—è –ø–ª–∞—à–∫–∞ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∫—É—Ö–Ω–∏ -->
        <div id="printKitchenBanner" style="padding: 10px 16px; margin-bottom: 1rem; border-radius: 6px; text-align: center; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
            <div style="font-size: 18px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; color: white;" id="printKitchenName"></div>
        </div>
        <div id="printHeader" style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid black;">
            <div style="display: flex; justify-content: space-between;">
                <div>
                    <div style="font-size: 14px; font-weight: bold;" data-i18n="org_name">–®—Ä–∏ –†—É–ø–∞ –°–µ–≤–∞ –ö—É–Ω–¥–∂–∞</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 16px; font-weight: bold;" id="printContainerTitle"></div>
                    <div style="font-size: 11px;" id="printContainerPeriod"></div>
                </div>
            </div>
        </div>
        <div id="printContainerItems" class="print-columns"></div>
        <div style="margin-top: 1rem; font-size: 12px;">
            <span data-i18n="total_items_short">–ü–æ–∑–∏—Ü–∏–π</span>: <span id="printContainerCount"></span>
        </div>
    </div>

    <!-- Add Product Modal -->
    <dialog id="productModal" class="modal">
        <div class="modal-box max-w-lg relative">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="productModal.close()">‚úï</button>
            <h3 class="font-bold text-lg mb-4" data-i18n="add_product">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h3>

            <div class="space-y-4">
                <!-- Tabs -->
                <div class="tabs tabs-boxed">
                    <a class="tab tab-active" id="tabProductSearch" onclick="switchProductTab('search')" data-i18n="search">–ü–æ–∏—Å–∫</a>
                    <a class="tab" id="tabProductBrowse" onclick="switchProductTab('browse')" data-i18n="by_category">–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
                </div>

                <!-- Search Tab -->
                <div id="productSearchTab">
                    <div class="relative">
                        <input type="text"
                               id="productSearch"
                               class="input input-bordered w-full"
                               placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ..." data-i18n-placeholder="search_placeholder"
                               autocomplete="off"
                               oninput="filterProducts(this.value)"
                               onfocus="showProductDropdown()"
                        />
                        <div id="productDropdown" class="absolute z-50 w-full bg-base-100 border border-base-300 rounded-lg shadow-lg mt-1 max-h-64 overflow-y-auto hidden">
                        </div>
                    </div>
                </div>

                <!-- Browse Tab -->
                <div id="productBrowseTab" class="hidden">
                    <div class="flex flex-wrap gap-2 mb-3" id="productCategoryButtons">
                        <!-- Generated by JS -->
                    </div>
                    <div id="productCategoryList" class="max-h-64 overflow-y-auto border border-base-300 rounded-lg">
                    </div>
                </div>

                <!-- Selected Product -->
                <div id="selectedProductDisplay" class="hidden">
                    <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg border-2" style="border-color: var(--current-color);">
                        <div>
                            <div class="font-medium" id="selectedProductName"></div>
                            <div class="text-sm opacity-50" id="selectedProductNameEn"></div>
                        </div>
                        <button type="button" class="btn btn-ghost btn-sm btn-square" onclick="clearSelectedProduct()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Quantity -->
                <div id="productQuantitySection" class="hidden">
                    <label class="label"><span class="label-text font-medium" data-i18n="quantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</span></label>
                    <div class="join w-full">
                        <input type="number" id="productQuantity" class="input input-bordered join-item w-full" value="1" min="0.1" step="0.1" />
                        <span id="productUnit" class="btn join-item no-animation pointer-events-none bg-base-200">–∫–≥</span>
                    </div>
                </div>
            </div>

            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="productModal.close()" data-i18n="cancel">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="saveProductBtn" onclick="addProductToRequest()" disabled data-i18n="add">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- View/Edit Request Modal -->
    <dialog id="viewRequestModal" class="modal">
        <div class="modal-box max-w-4xl relative">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 no-print" onclick="viewRequestModal.close()">‚úï</button>

            <div class="flex items-start gap-4 mb-4 no-print">
                <div>
                    <h3 class="font-bold text-lg" id="viewRequestTitle">–ó–∞—è–≤–∫–∞ #1</h3>
                    <p class="text-sm opacity-60" id="viewRequestPeriod">–ü–µ—Ä–∏–æ–¥: ...</p>
                </div>
                <button class="btn btn-primary btn-sm gap-1" onclick="printViewedRequest()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                    <span data-i18n="print">–ü–µ—á–∞—Ç—å</span>
                </button>
            </div>

            <!-- –≠–∫—Ä–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è (—Ç–∞–±–ª–∏—Ü–∞) -->
            <div class="overflow-x-auto no-print">
                <table class="table table-sm">
                    <thead class="bg-base-200">
                        <tr>
                            <th colspan="2" data-i18n="product">–ü—Ä–æ–¥—É–∫—Ç</th>
                            <th class="text-right w-32" data-i18n="to_purchase">–ó–∞–∫—É–ø–∏—Ç—å</th>
                            <th class="text-right" data-i18n="est_price">‚âà –°—É–º–º–∞</th>
                            <th class="w-10"></th>
                        </tr>
                    </thead>
                    <tbody id="viewRequestItems"></tbody>
                </table>
            </div>

            
            <div class="mt-4 flex flex-wrap justify-between items-center gap-4 border-t pt-4">
                <button class="btn btn-ghost btn-sm gap-1 no-print" onclick="openProductModalForViewing()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    <span data-i18n="add_product">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</span>
                </button>
                <div class="flex items-center gap-4">
                    <div class="text-sm opacity-60">
                        <span data-i18n="total_items_short">–ü–æ–∑–∏—Ü–∏–π</span>: <span class="font-bold" id="viewRequestCount">0</span>
                    </div>
                    <div class="no-print">
                        <span data-i18n="total">–ò—Ç–æ–≥–æ</span>: <span class="font-bold text-lg" id="viewRequestTotal">‚Äî</span>
                    </div>
                </div>
            </div>

            <div class="modal-action no-print">
                <button type="button" class="btn btn-ghost" onclick="viewRequestModal.close()" data-i18n="close">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="btn btn-primary" id="saveViewedRequestBtn" onclick="saveViewedRequest()" data-i18n="save_changes">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Alert Modal -->
    <dialog id="alertModal" class="modal">
        <div class="modal-box max-w-sm">
            <p id="alertMessage" class="py-4 text-center"></p>
            <div class="modal-action justify-center">
                <button type="button" class="btn btn-primary" onclick="closeAlert()">OK</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Confirm Modal -->
    <dialog id="confirmModal" class="modal">
        <div class="modal-box max-w-sm">
            <p id="confirmMessage" class="py-4 text-center"></p>
            <div class="modal-action justify-center gap-2">
                <button type="button" class="btn btn-ghost" onclick="confirmNo()" data-i18n="no">–ù–µ—Ç</button>
                <button type="button" class="btn btn-primary" onclick="confirmYes()" data-i18n="yes">–î–∞</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <script src="../js/layout.js"></script>
    <script>
        // ==================== STATE ====================
        let recipes = [];
        let products = [];
        let productCategories = [];
        let stockItems = [];
        let requestItems = [];
        let locationId = null;
        let savedRequestId = null;
        let savedRequestNumber = null;
        let nextRequestNumber = null;
        let savedRequests = [];
        let viewingRequest = null; // Currently viewed request in modal
        let viewingItems = []; // Editable items for the viewed request
        let selectedProduct = null;
        let currentProductCategory = 'all';
        let highlightRequestId = null; // ID –∑–∞—è–≤–∫–∏ –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        let buyers = []; // –°–ø–∏—Å–æ–∫ –∑–∞–∫—É–ø—â–∏–∫–æ–≤
        let addingToViewedRequest = false; // –§–ª–∞–≥: –¥–æ–±–∞–≤–ª—è–µ–º –≤ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º—É—é –∑–∞—è–≤–∫—É

        const t = key => Layout.t(key);

        // –•–µ–ª–ø–µ—Ä –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤ —Å fallback
        function tr(key, fallback) {
            const val = t(key);
            return (val && val !== key) ? val : fallback;
        }

        // ==================== MODAL DIALOGS ====================
        let confirmResolve = null;

        function showAlert(message) {
            Layout.$('#alertMessage').textContent = message;
            Layout.$('#alertModal').showModal();
        }

        function closeAlert() {
            Layout.$('#alertModal').close();
        }

        function showConfirm(message) {
            return new Promise(resolve => {
                confirmResolve = resolve;
                Layout.$('#confirmMessage').textContent = message;
                Layout.$('#confirmModal').showModal();
            });
        }

        function confirmYes() {
            Layout.$('#confirmModal').close();
            if (confirmResolve) confirmResolve(true);
        }

        function confirmNo() {
            Layout.$('#confirmModal').close();
            if (confirmResolve) confirmResolve(false);
        }

        // ==================== HELPERS ====================
        const UNITS = {
            kg: { ru: '–∫–≥', en: 'kg', hi: '‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ', toGrams: 1000 },
            g: { ru: '–≥', en: 'g', hi: '‡§ó‡•ç‡§∞‡§æ', toGrams: 1 },
            l: { ru: '–ª', en: 'l', hi: '‡§≤‡•Ä', toGrams: 1000 },
            ml: { ru: '–º–ª', en: 'ml', hi: '‡§Æ‡§ø‡§≤‡•Ä', toGrams: 1 },
            pcs: { ru: '—à—Ç', en: 'pcs', hi: '‡§™‡•Ä‡§∏', toGrams: 1 }
        };

        function formatQty(num) {
            if (num === Math.floor(num)) return num.toString();
            return num.toFixed(1).replace(/\.0$/, '');
        }

        function localizeUnit(unit) {
            const u = (unit || '').toLowerCase();
            return UNITS[u]?.[Layout.currentLang] || unit;
        }


        function toGrams(amount, unit) {
            const u = (unit || 'g').toLowerCase();
            return (amount || 0) * (UNITS[u]?.toGrams || 1);
        }

        function fromGrams(grams, preferKg = true) {
            if (preferKg && grams >= 1000) {
                return { value: grams / 1000, unit: 'kg' };
            }
            return { value: grams, unit: 'g' };
        }

        // –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–ª—è –∑–∞–∫—É–ø–∫–∏
        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: min_purchase –ø—Ä–æ–¥—É–∫—Ç–∞ > —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ
        function roundForPurchase(value, unit, category = null, minPurchaseGrams = null) {
            // –ï—Å–ª–∏ –∑–∞–¥–∞–Ω–∞ –º–∏–Ω. –∑–∞–∫—É–ø–∫–∞ - –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ –Ω–µ—ë
            if (minPurchaseGrams && minPurchaseGrams > 0) {
                const valueGrams = unit === 'kg' ? value * 1000 : value;
                const rounded = Math.ceil(valueGrams / minPurchaseGrams) * minPurchaseGrams;
                return unit === 'kg' ? rounded / 1000 : rounded;
            }

            // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ
            const isVegetable = category === 'vegetables';

            if (isVegetable) {
                // –û–≤–æ—â–∏ –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 1 –∫–≥
                const valueKg = unit === 'kg' ? value : value / 1000;
                return Math.ceil(valueKg);
            }

            if (unit === 'kg') {
                return Math.ceil(value);
            }
            return Math.ceil(value / 50) * 50;
        }

        // Format number with year suffix (e.g. 4-26 for request #4 in 2026)
        function formatNumberWithYear(num) {
            const year = new Date().getFullYear().toString().slice(-2);
            return `${num}-${year}`;
        }

        // ==================== DATA LOADING ====================
        async function loadLocationId() {
            const { data } = await Layout.db
                .from('locations')
                .select('id')
                .eq('slug', Layout.currentLocation)
                .single();
            locationId = data?.id;
        }

        async function loadProducts() {
            const { data } = await Layout.db
                .from('products')
                .select('*, product_categories(*)');
            products = data || [];
        }

        async function loadProductCategories() {
            const { data } = await Layout.db
                .from('product_categories')
                .select('*')
                .order('sort_order');
            productCategories = data || [];
        }

        async function loadBuyers() {
            const { data } = await Layout.db
                .from('buyers')
                .select('*')
                .order('sort_order');
            buyers = data || [];
        }

        async function loadStock() {
            const { data } = await Layout.db
                .from('stock')
                .select('*')
                .eq('location_id', locationId);
            stockItems = data || [];
        }

        async function loadRecipes() {
            const { data } = await Layout.db
                .from('recipes')
                .select('*, recipe_ingredients(*)');
            recipes = data || [];
        }

        async function loadMenuForPeriod(fromDate, toDate) {
            const { data } = await Layout.db
                .from('menu_meals')
                .select('*, dishes:menu_dishes(*, recipe:recipes(*))')
                .eq('location_id', locationId)
                .gte('date', fromDate)
                .lte('date', toDate);
            return data || [];
        }

        // ==================== PERIOD SELECTION ====================
        function selectPeriod(period) {
            // Update button styles
            document.querySelectorAll('.period-btn').forEach(btn => {
                const isActive = btn.dataset.period === period;
                btn.classList.toggle('btn-ghost', !isActive);
                btn.classList.toggle('btn-current-color', isActive);
            });

            // Calculate dates
            const today = new Date();
            const fromDate = new Date(today);
            const toDate = new Date(today);

            const daysToAdd = { today: 0, '3days': 2, week: 6, '2weeks': 13 };
            toDate.setDate(toDate.getDate() + (daysToAdd[period] || 0));

            Layout.$('#periodFrom').value = fromDate.toISOString().split('T')[0];
            Layout.$('#periodTo').value = toDate.toISOString().split('T')[0];
        }

        function clearPeriodButtons() {
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.add('btn-ghost');
                btn.classList.remove('btn-current-color');
            });
        }

        // ==================== GENERATE REQUEST ====================
        async function generateRequest() {
            const fromDate = Layout.$('#periodFrom').value;
            const toDate = Layout.$('#periodTo').value;

            if (!fromDate || !toDate) {
                showAlert(tr('select_period', '–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥'));
                return;
            }

            const menuData = await loadMenuForPeriod(fromDate, toDate);

            if (menuData.length === 0) {
                showAlert(tr('menu_not_found', '–ú–µ–Ω—é –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'));
                return;
            }

            // Calculate required ingredients
            const ingredientTotals = {};

            menuData.forEach(meal => {
                const mealPortions = meal.portions || 1;

                (meal.dishes || []).forEach(dish => {
                    const recipe = recipes.find(r => r.id === dish.recipe_id);
                    if (!recipe?.recipe_ingredients) return;

                    // Calculate multiplier: (portions √ó portion size) / recipe output
                    const baseOutputGrams = toGrams(recipe.output_amount || 1, recipe.output_unit || 'kg');
                    const targetGrams = mealPortions * (recipe.portion_amount || 150);
                    const multiplier = targetGrams / baseOutputGrams;

                    recipe.recipe_ingredients.forEach(ing => {
                        if (!ing.product_id) return;

                        const qtyGrams = toGrams(ing.amount, ing.unit) * multiplier;

                        if (ingredientTotals[ing.product_id]) {
                            ingredientTotals[ing.product_id] += qtyGrams;
                        } else {
                            ingredientTotals[ing.product_id] = qtyGrams;
                        }
                    });
                });
            });

            // Calculate what needs to be purchased
            requestItems = [];

            Object.entries(ingredientTotals).forEach(([productId, neededGrams]) => {
                const product = products.find(p => p.id === productId);
                const stock = stockItems.find(s => s.product_id === productId);
                const stockGrams = toGrams(stock?.current_quantity, product?.unit);
                const toPurchaseGrams = Math.max(0, neededGrams - stockGrams);

                if (toPurchaseGrams > 0) {
                    const categorySlug = product?.product_categories?.slug;
                    const isVegetable = categorySlug === 'vegetables';

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –µ–¥–∏–Ω–∏—Ü—É - –µ—Å–ª–∏ –∑–∞–∫—É–ø–∏—Ç—å >= 1 –∫–≥ –∏–ª–∏ –æ–≤–æ—â–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–≥, –∏–Ω–∞—á–µ –≥—Ä–∞–º–º—ã
                    const useKg = toPurchaseGrams >= 1000 || isVegetable;
                    const unit = useKg ? 'kg' : 'g';

                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤—Å—ë –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é –µ–¥–∏–Ω–∏—Ü—É
                    const needed = useKg ? neededGrams / 1000 : neededGrams;
                    const inStock = useKg ? stockGrams / 1000 : stockGrams;
                    const toPurchase = useKg ? toPurchaseGrams / 1000 : toPurchaseGrams;

                    // –û–∫—Ä—É–≥–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –∑–∞–∫—É–ø–∫–∏ (—É—á–∏—Ç—ã–≤–∞–µ–º min_purchase)
                    const roundedPurchase = roundForPurchase(toPurchase, unit, categorySlug, product?.min_purchase);

                    // Get last price from stock (price per kg)
                    const lastPrice = stock?.last_price || null;

                    // –°—É–º–º–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –æ–∫—Ä—É–≥–ª—ë–Ω–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É (–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –∫–≥ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞)
                    const purchaseKg = useKg ? roundedPurchase : roundedPurchase / 1000;

                    requestItems.push({
                        product_id: productId,
                        product,
                        needed: needed,
                        in_stock: inStock,
                        to_purchase: roundedPurchase,
                        unit: unit,
                        last_price: lastPrice,
                        est_sum: lastPrice ? purchaseKg * lastPrice : null
                    });
                }
            });

            // Sort by category
            requestItems.sort((a, b) => {
                const catA = a.product?.product_categories?.name_ru || '';
                const catB = b.product?.product_categories?.name_ru || '';
                return catA.localeCompare(catB);
            });

            // Reset saved state for new generated request
            savedRequestId = null;
            savedRequestNumber = null;
            nextRequestNumber = await getNextRequestNumber();

            renderResults();
        }

        // ==================== CREATE MANUAL REQUEST ====================
        async function createManualRequest() {
            // Start with empty items
            requestItems = [];
            savedRequestId = null;
            savedRequestNumber = null;
            nextRequestNumber = await getNextRequestNumber();

            // Clear period fields for manual requests
            Layout.$('#periodFrom').value = '';
            Layout.$('#periodTo').value = '';

            // Show results section
            Layout.$('#requestChoiceSection')?.classList.add('hidden');
            Layout.$('#resultsSection').classList.remove('hidden');

            renderResults();
        }

        // Get next request number from database
        async function getNextRequestNumber() {
            const { data } = await Layout.db
                .from('purchase_requests')
                .select('number')
                .eq('location_id', locationId)
                .order('number', { ascending: false })
                .limit(1);
            return (data?.[0]?.number || 0) + 1;
        }

        // ==================== RENDERING ====================
        function renderResults() {
            const tbody = Layout.$('#requestItemsTable');

            // Update title
            const titleEl = Layout.$('#requestTitle');
            if (savedRequestNumber) {
                titleEl.textContent = `${tr('request', '–ó–∞—è–≤–∫–∞')} #${formatNumberWithYear(savedRequestNumber)}`;
            } else if (nextRequestNumber) {
                titleEl.textContent = `${tr('new_request_tab', '–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞')} #${formatNumberWithYear(nextRequestNumber)}`;
            } else {
                titleEl.textContent = tr('new_request_tab', '–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞');
            }

            // Always show results section (hide choice section)
            Layout.$('#requestChoiceSection')?.classList.add('hidden');
            Layout.$('#resultsSection').classList.remove('hidden');
            Layout.$('#totalItems').textContent = requestItems.length;

            // Calculate total sum
            let totalSum = 0;
            let hasAllPrices = true;

            requestItems.forEach(item => {
                if (item.est_sum !== null) {
                    totalSum += item.est_sum;
                } else {
                    hasAllPrices = false;
                }
            });

            // Display total (with ~ if some prices are missing)
            const totalEl = Layout.$('#totalSum');
            if (totalSum > 0) {
                totalEl.textContent = (hasAllPrices ? '' : '‚âà ') + '‚Çπ' + Math.round(totalSum).toLocaleString();
            } else {
                totalEl.textContent = '‚Äî';
            }

            if (requestItems.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-8 opacity-50">
                    <div class="text-2xl mb-2">üìã</div>
                    <div>${tr('add_products_hint', '–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ')}</div>
                </td></tr>`;
                return;
            }

            tbody.innerHTML = requestItems.map((item, index) => {
                const product = item.product;
                const cat = product?.product_categories;
                const unit = localizeUnit(item.unit);
                const estSum = item.est_sum !== null ? '‚Çπ' + Math.round(item.est_sum).toLocaleString() : '‚Äî';

                return `
                    <tr>
                        <td>
                            <div class="font-medium">${Layout.getName(product)}</div>
                            <div class="text-xs opacity-50">${product?.name_en || ''}</div>
                        </td>
                        <td>
                            <span class="badge badge-sm" style="background-color: ${cat?.color || '#999'}20; color: ${cat?.color || '#999'}">
                                ${Layout.getName(cat) || '‚Äî'}
                            </span>
                        </td>
                        <td class="text-right">${formatQty(item.needed)} ${unit}</td>
                        <td class="text-right opacity-60">${formatQty(item.in_stock)} ${unit}</td>
                        <td class="text-right">
                            <div class="join">
                                <input type="number"
                                    class="input input-bordered input-sm join-item w-20 text-right font-bold"
                                    style="color: var(--current-color)"
                                    value="${formatQty(item.to_purchase)}"
                                    min="0"
                                    step="1"
                                    onchange="updateItemQuantity(${index}, this.value)"
                                />
                                <span class="btn btn-sm join-item no-animation pointer-events-none bg-base-200">${unit}</span>
                            </div>
                        </td>
                        <td class="text-right opacity-70">${estSum}</td>
                        <td>
                            <button class="btn btn-ghost btn-sm btn-square text-error/60 hover:text-error hover:bg-error/10" onclick="removeItem(${index})" title="${t('remove') || '–£–¥–∞–ª–∏—Ç—å'}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ==================== ACTIONS ====================
        async function saveRequest() {
            if (requestItems.length === 0) {
                showAlert(tr('add_at_least_one', '–ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'));
                return;
            }

            const periodFrom = Layout.$('#periodFrom').value || null;
            const periodTo = Layout.$('#periodTo').value || null;

            const requestData = {
                location_id: locationId,
                period_from: periodFrom,
                period_to: periodTo,
                status: 'pending'
            };

            const { data: request, error } = await Layout.db
                .from('purchase_requests')
                .insert(requestData)
                .select()
                .single();

            if (error) {
                showAlert(tr('save_error', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'));
                return;
            }

            // Save quantities in grams for consistency, and price per kg
            const items = requestItems.map(i => ({
                request_id: request.id,
                product_id: i.product_id,
                quantity: toGrams(i.to_purchase, i.unit),
                price: i.last_price  // price per kg at time of request
            }));

            await Layout.db.from('purchase_request_items').insert(items);

            // Fetch the saved request to get the generated number
            const { data: savedReq } = await Layout.db
                .from('purchase_requests')
                .select('id, number')
                .eq('id', request.id)
                .single();

            // Update state with saved request info
            savedRequestId = savedReq?.id || request.id;
            savedRequestNumber = savedReq?.number || request.number;
            nextRequestNumber = null;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
            highlightRequestId = savedRequestId;

            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            requestItems = [];

            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫
            switchTab('saved');
        }

        function printRequest() {
            window.print();
        }

        // ==================== TABS ====================
        function switchTab(tab) {
            // Update tab buttons
            Layout.$$('.tab[data-tab]').forEach(btn => {
                btn.classList.toggle('tab-active', btn.dataset.tab === tab);
            });

            // Show/hide content
            Layout.$('#tabContentNew').classList.toggle('hidden', tab !== 'new');
            Layout.$('#tabContentSaved').classList.toggle('hidden', tab !== 'saved');
            Layout.$('#tabContentArchive').classList.toggle('hidden', tab !== 'archive');

            // When switching to "new" tab, show choice section
            if (tab === 'new') {
                Layout.$('#requestChoiceSection')?.classList.remove('hidden');
                Layout.$('#resultsSection')?.classList.add('hidden');
            }

            if (tab === 'saved' || tab === 'archive') {
                loadSavedRequests();
            }
        }

        // ==================== SAVED REQUESTS ====================
        async function loadSavedRequests() {
            const { data, error } = await Layout.db
                .from('purchase_requests')
                .select('*, items:purchase_request_items(*, products(*, product_categories(*)))')
                .eq('location_id', locationId)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading saved requests:', error);
                return;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫—É–ø—â–∏–∫–∞ –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ buyers
            savedRequests = (data || []).map(req => ({
                ...req,
                buyer: req.buyer_id ? buyers.find(b => b.id === req.buyer_id) : null
            }));
            renderSavedRequests();
            renderArchivedRequests();
        }

        function renderRequestCard(req, isArchived = false) {
            const itemsCount = req.items?.length || 0;
            const locale = Layout.currentLang === 'ru' ? 'ru-RU' : 'en-US';

            // Period (only for requests generated from menu)
            const hasPeriod = req.period_from && req.period_to;
            const periodFrom = hasPeriod ? new Date(req.period_from).toLocaleDateString(locale) : '';
            const periodTo = hasPeriod ? new Date(req.period_to).toLocaleDateString(locale) : '';

            // Created at with time
            const createdDate = new Date(req.created_at);
            const createdAtStr = createdDate.toLocaleDateString(locale) + ' ' + createdDate.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit' });

            // Calculate total sum
            let totalSum = 0;
            let hasAllPrices = true;
            (req.items || []).forEach(item => {
                if (item.price && item.quantity) {
                    totalSum += (item.quantity / 1000) * item.price;
                } else {
                    hasAllPrices = false;
                }
            });
            const sumDisplay = totalSum > 0 ? (hasAllPrices ? '' : '‚âà ') + '‚Çπ' + Math.round(totalSum).toLocaleString() : '';

            // Items list preview
            const itemsList = (req.items || []).map(item => {
                const product = item.products;
                const grams = item.quantity || 0;
                const display = fromGrams(grams);
                const name = Layout.getName(product);
                const qty = formatQty(display.value);
                const unit = localizeUnit(display.unit);
                return `${name} ${qty}${unit}`;
            }).join(', ');

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏
            const isHighlighted = req.id === highlightRequestId;
            const isInProgress = req.status === 'in_progress';
            let cardStyle = '';
            if (isInProgress) {
                cardStyle = 'background-color: rgba(59, 130, 246, 0.1); border: 2px solid #3b82f6;';
            } else if (isHighlighted) {
                cardStyle = 'background-color: rgba(var(--current-color-rgb, 234, 179, 8), 0.15); border: 2px solid var(--current-color);';
            }

            return `
                <div class="bg-base-100 rounded-lg p-4 shadow-sm" style="${cardStyle}" ${isHighlighted ? 'id="highlightedRequest"' : ''}>
                    ${isInProgress ? `<div class="text-sm font-medium text-blue-600 mb-4 flex items-center gap-2 flex-wrap">
                        <span class="flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                            ${tr('request_in_progress', '–ó–∞—è–≤–∫–∞ –≤ —Ä–∞–±–æ—Ç–µ')}
                        </span>
                        <select class="select select-bordered select-sm" onchange="updateRequestBuyer('${req.id}', this.value)">
                            <option value="">${tr('select_buyer', '–í—ã–±—Ä–∞—Ç—å –∑–∞–∫—É–ø—â–∏–∫–∞')}</option>
                            ${buyers.map(b => `<option value="${b.id}" ${req.buyer_id === b.id ? 'selected' : ''}>${Layout.getName(b)}</option>`).join('')}
                        </select>
                    </div>` : ''}
                    <div class="flex flex-col md:flex-row md:items-center gap-4">
                        <div class="min-w-0 flex-shrink-0">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="font-semibold">${tr('request', '–ó–∞—è–≤–∫–∞')} #${formatNumberWithYear(req.number)}</span>
                                <span class="badge badge-sm badge border-base-300 md:hidden">${itemsCount} ${tr('items_short', '–ø–æ–∑.')}</span>
                                ${sumDisplay ? `<span class="badge badge-sm badge border-base-300">${sumDisplay}</span>` : ''}
                            </div>
                            ${hasPeriod ? `<div class="text-sm opacity-60 mt-1">${tr('period', '–ü–µ—Ä–∏–æ–¥')}: ${periodFrom} ‚Äî ${periodTo}</div>` : ''}
                            <div class="text-xs opacity-40 mt-1">
                                ${tr('created', '–°–æ–∑–¥–∞–Ω–æ')}: ${createdAtStr}
                            </div>
                        </div>

                        ${itemsList ? `<div class="hidden md:block flex-1 text-sm opacity-60 line-clamp-3 px-4 self-start">${itemsList}</div>` : ''}

                        <div class="flex items-center gap-1 flex-shrink-0">
                            <button class="btn btn-ghost btn-sm" onclick="viewSavedRequest('${req.id}')" title="${tr('view', '–ü—Ä–æ—Å–º–æ—Ç—Ä')}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </button>
                            <button class="btn btn-ghost btn-sm" onclick="printSavedRequest('${req.id}')" title="${tr('print', '–ü–µ—á–∞—Ç—å')}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                </svg>
                            </button>
                            ${!isArchived ? `
                                <button class="btn btn-ghost btn-sm ${isInProgress ? 'text-blue-600' : 'text-blue-400'}" onclick="toggleInProgress('${req.id}')" title="${tr('in_progress', '–í —Ä–∞–±–æ—Ç–µ')}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="${isInProgress ? '2.5' : '2'}">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                </button>
                                <button class="btn btn-ghost btn-sm text-warning" onclick="archiveRequest('${req.id}')" title="${tr('to_archive', '–í –∞—Ä—Ö–∏–≤')}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                                    </svg>
                                </button>
                            ` : `
                                <button class="btn btn-ghost btn-sm text-success" onclick="restoreRequest('${req.id}')" title="${tr('restore', '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å')}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                                    </svg>
                                </button>
                            `}
                            <button class="btn btn-ghost btn-sm text-error" onclick="deleteRequest('${req.id}')" title="${tr('delete', '–£–¥–∞–ª–∏—Ç—å')}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSavedRequests() {
            const container = Layout.$('#savedRequestsList');
            const filtered = savedRequests.filter(r => r.status !== 'archived');

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 opacity-50">
                        <div class="text-4xl mb-2">üìã</div>
                        <div>${tr('no_active_requests', '–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫')}</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(req => renderRequestCard(req, false)).join('');

            // –°–∫—Ä–æ–ª–ª –∫ –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω–æ–π –∑–∞—è–≤–∫–µ –∏ —Å–Ω—è—Ç–∏–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            if (highlightRequestId) {
                const highlighted = Layout.$('#highlightedRequest');
                if (highlighted) {
                    highlighted.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => {
                        highlighted.style.backgroundColor = '';
                        highlighted.style.border = '';
                        highlightRequestId = null;
                    }, 3000);
                }
            }
        }

        function renderArchivedRequests() {
            const container = Layout.$('#archivedRequestsList');
            const filtered = savedRequests.filter(r => r.status === 'archived');

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 opacity-50">
                        <div class="text-4xl mb-2">üì¶</div>
                        <div>${tr('archive_empty', '–ù–µ—Ç –∑–∞—è–≤–æ–∫ –≤ –∞—Ä—Ö–∏–≤–µ')}</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(req => renderRequestCard(req, true)).join('');
        }

        async function updateRequestBuyer(id, buyerId) {
            const { error } = await Layout.db
                .from('purchase_requests')
                .update({ buyer_id: buyerId || null })
                .eq('id', id);

            if (error) {
                console.error('Error updating buyer:', error);
                showAlert(tr('save_error', '–û—à–∏–±–∫–∞'));
                return;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
            const req = savedRequests.find(r => r.id === id);
            if (req) {
                req.buyer_id = buyerId || null;
                req.buyer = buyers.find(b => b.id === buyerId) || null;
            }
        }

        async function toggleInProgress(id) {
            const req = savedRequests.find(r => r.id === id);
            if (!req) return;

            const newStatus = req.status === 'in_progress' ? 'pending' : 'in_progress';

            const { error } = await Layout.db
                .from('purchase_requests')
                .update({ status: newStatus })
                .eq('id', id);

            if (error) {
                console.error('Error updating request status:', error);
                showAlert(tr('save_error', '–û—à–∏–±–∫–∞'));
                return;
            }

            await loadSavedRequests();
        }

        async function archiveRequest(id) {
            if (!await showConfirm(tr('archive_confirm', '–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –∞—Ä—Ö–∏–≤?'))) return;

            const { error } = await Layout.db
                .from('purchase_requests')
                .update({ status: 'archived' })
                .eq('id', id);

            if (error) {
                console.error('Error archiving request:', error);
                showAlert(tr('save_error', '–û—à–∏–±–∫–∞'));
                return;
            }

            await loadSavedRequests();
        }

        async function restoreRequest(id) {
            const { error } = await Layout.db
                .from('purchase_requests')
                .update({ status: 'pending' })
                .eq('id', id);

            if (error) {
                console.error('Error restoring request:', error);
                showAlert(tr('save_error', '–û—à–∏–±–∫–∞'));
                return;
            }

            await loadSavedRequests();
        }

        async function deleteRequest(id) {
            if (!await showConfirm(tr('permanent_delete_confirm', '–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞–≤—Å–µ–≥–¥–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!'))) return;

            // –£–¥–∞–ª—è–µ–º items
            await Layout.db.from('purchase_request_items').delete().eq('request_id', id);

            // –£–¥–∞–ª—è–µ–º –∑–∞—è–≤–∫—É
            const { error } = await Layout.db
                .from('purchase_requests')
                .delete()
                .eq('id', id);

            if (error) {
                console.error('Error deleting request:', error);
                showAlert(tr('save_error', '–û—à–∏–±–∫–∞'));
                return;
            }

            await loadSavedRequests();
        }

        function viewSavedRequest(id) {
            const req = savedRequests.find(r => r.id === id);
            if (!req) return;

            viewingRequest = req;

            // Convert items from grams to display format
            viewingItems = (req.items || []).map(item => {
                const product = item.products;
                const grams = item.quantity || 0;
                const display = fromGrams(grams);
                const lastPrice = item.price || null;

                return {
                    id: item.id,
                    product_id: item.product_id,
                    product,
                    quantity: display.value,
                    unit: display.unit,
                    last_price: lastPrice,
                    est_sum: lastPrice ? (grams / 1000) * lastPrice : null
                };
            });

            // Update modal header
            const periodFrom = new Date(req.period_from).toLocaleDateString('ru-RU');
            const periodTo = new Date(req.period_to).toLocaleDateString('ru-RU');

            Layout.$('#viewRequestTitle').textContent = `${tr('request', '–ó–∞—è–≤–∫–∞')} #${formatNumberWithYear(req.number)}`;
            Layout.$('#viewRequestPeriod').textContent = `${tr('period', '–ü–µ—Ä–∏–æ–¥')}: ${periodFrom} ‚Äî ${periodTo}`;

            // Print container header
            Layout.$('#printContainerTitle').textContent = `${tr('request', '–ó–∞—è–≤–∫–∞')} #${formatNumberWithYear(req.number)}`;
            Layout.$('#printContainerPeriod').textContent = `${tr('period', '–ü–µ—Ä–∏–æ–¥')}: ${periodFrom} ‚Äî ${periodTo}`;

            // Get location name and set kitchen banner
            const loc = Layout.locations?.find(l => l.slug === Layout.currentLocation);
            if (loc) {
                const kitchenBanner = Layout.$('#printKitchenBanner');
                const kitchenName = Layout.$('#printKitchenName');
                kitchenName.textContent = Layout.getName(loc);

                // –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç –ª–æ–∫–∞—Ü–∏–∏ –∏–∑ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
                const colors = {
                    main: '#f49800',  // –æ—Ä–∞–Ω–∂–µ–≤—ã–π
                    cafe: '#10b981',  // –∑–µ–ª—ë–Ω—ã–π
                    guest: '#3b82f6'  // —Å–∏–Ω–∏–π
                };
                const color = colors[Layout.currentLocation] || '#f49800';
                kitchenBanner.style.backgroundColor = color;
            }

            renderViewedRequest();
            viewRequestModal.showModal();
        }

        function renderViewedRequest() {
            const tbody = Layout.$('#viewRequestItems');

            let totalSum = 0;
            let hasAllPrices = true;

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            const grouped = {};
            viewingItems.forEach((item, index) => {
                const cat = item.product?.product_categories;
                const catId = cat?.id || 'uncategorized';
                if (!grouped[catId]) {
                    grouped[catId] = { cat, items: [] };
                }
                grouped[catId].items.push({ ...item, originalIndex: index });
            });

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ sort_order
            const sortedGroups = Object.values(grouped).sort((a, b) =>
                (a.cat?.sort_order || 999) - (b.cat?.sort_order || 999)
            );

            let html = '';
            sortedGroups.forEach(group => {
                const cat = group.cat;
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                html += `<tr class="print-category-header"><td colspan="4" class="font-semibold" style="background-color: ${cat?.color || '#999'}15;">${cat?.emoji || ''} ${Layout.getName(cat) || tr('uncategorized', '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏')}</td></tr>`;

                group.items.forEach(item => {
                    const index = item.originalIndex;
                    const product = item.product;
                    const unit = localizeUnit(item.unit);
                    const estSum = item.est_sum !== null ? '‚Çπ' + Math.round(item.est_sum).toLocaleString() : '‚Äî';

                    if (item.est_sum !== null) {
                        totalSum += item.est_sum;
                    } else {
                        hasAllPrices = false;
                    }

                    const translit = product?.translit || Layout.transliterateHindi(product?.name_hi);

                    html += `
                        <tr>
                            <td colspan="2">
                                <div class="font-medium">${Layout.getName(product)}</div>
                                ${translit ? `<div class="text-xs opacity-50 italic">${translit}</div>` : ''}
                            </td>
                            <td class="text-right">
                                <div class="join no-print">
                                    <input type="number"
                                        class="input input-bordered input-sm join-item w-20 text-right font-bold"
                                        style="color: var(--current-color)"
                                        value="${formatQty(item.quantity)}"
                                        min="0"
                                        step="1"
                                        onchange="updateViewedItemQty(${index}, this.value)"
                                    />
                                    <span class="btn btn-sm join-item no-animation pointer-events-none bg-base-200">${unit}</span>
                                </div>
                                <span class="hidden print:inline font-bold" style="color: var(--current-color)">${formatQty(item.quantity)} ${unit}</span>
                            </td>
                            <td class="text-right opacity-70 no-print">${estSum}</td>
                            <td class="no-print">
                                <button class="btn btn-ghost btn-sm btn-square text-error/60 hover:text-error hover:bg-error/10" onclick="removeViewedItem(${index})">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            });

            tbody.innerHTML = html;

            // –ü–µ—á–∞—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è (–¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏) - –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
            let printHtml = '';
            sortedGroups.forEach(group => {
                const cat = group.cat;
                printHtml += `<div class="print-category">`;
                printHtml += `<div class="print-category-title">${cat?.emoji || ''} ${Layout.getName(cat) || tr('uncategorized', '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏')}</div>`;
                group.items.forEach(item => {
                    const product = item.product;
                    const unit = localizeUnit(item.unit);
                    printHtml += `<div class="print-item">
                        <span class="print-item-name">${Layout.getName(product)}</span>
                        <span class="print-item-qty">${formatQty(item.quantity)} ${unit}</span>
                    </div>`;
                });
                printHtml += `</div>`;
            });
            Layout.$('#printContainerItems').innerHTML = printHtml;
            Layout.$('#printContainerCount').textContent = viewingItems.length;

            Layout.$('#viewRequestCount').textContent = viewingItems.length;
            Layout.$('#viewRequestTotal').textContent = totalSum > 0
                ? (hasAllPrices ? '' : '‚âà ') + '‚Çπ' + Math.round(totalSum).toLocaleString()
                : '‚Äî';
        }

        function updateViewedItemQty(index, value) {
            const qty = parseFloat(value) || 0;
            viewingItems[index].quantity = qty;

            // Recalculate sum
            const item = viewingItems[index];
            if (item.last_price) {
                const grams = item.unit === 'kg' ? qty * 1000 : qty;
                item.est_sum = (grams / 1000) * item.last_price;
            }

            renderViewedRequest();
        }

        function removeViewedItem(index) {
            viewingItems.splice(index, 1);
            renderViewedRequest();
        }

        async function saveViewedRequest() {
            if (!viewingRequest) return;

            // Delete old items and insert new ones
            await Layout.db.from('purchase_request_items').delete().eq('request_id', viewingRequest.id);

            const items = viewingItems.map(i => ({
                request_id: viewingRequest.id,
                product_id: i.product_id,
                quantity: toGrams(i.quantity, i.unit),
                price: i.last_price
            }));

            if (items.length > 0) {
                await Layout.db.from('purchase_request_items').insert(items);
            }

            viewRequestModal.close();
            await loadSavedRequests();
        }

        function printViewedRequest() {
            window.print();
        }

        function printSavedRequest(id) {
            viewSavedRequest(id);
            setTimeout(() => window.print(), 300);
        }

        // ==================== EVENT LISTENERS ====================
        Layout.$('#periodFrom')?.addEventListener('change', clearPeriodButtons);
        Layout.$('#periodTo')?.addEventListener('change', clearPeriodButtons);

        window.onLanguageChange = function() {
            Layout.updateAllTranslations();
            if (requestItems.length > 0) renderResults();
            if (savedRequests.length > 0) {
                renderSavedRequests();
                renderArchivedRequests();
            }
        };

        // –ö–æ–ª–±—ç–∫ –ø—Ä–∏ —Å–º–µ–Ω–µ –ª–æ–∫–∞—Ü–∏–∏
        window.onLocationChange = async function() {
            await loadLocationId();
            await loadStockItems();
            await loadSavedRequests();
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –∑–∞—è–≤–∫—É –ø—Ä–∏ —Å–º–µ–Ω–µ –ª–æ–∫–∞—Ü–∏–∏
            requestItems = [];
            savedRequestId = null;
            Layout.$('#resultsSection').classList.add('hidden');
            Layout.$('#requestChoiceSection').classList.remove('hidden');
            renderSavedRequests();
            renderArchivedRequests();
        };

        // ==================== PRODUCT MODAL ====================
        function openProductModalForViewing() {
            openProductModal(true);
        }

        function openProductModal(forViewing = false) {
            selectedProduct = null;
            currentProductCategory = 'all';
            addingToViewedRequest = forViewing;

            // Reset modal
            Layout.$('#productSearch').value = '';
            Layout.$('#productDropdown').classList.add('hidden');
            Layout.$('#selectedProductDisplay').classList.add('hidden');
            Layout.$('#productQuantitySection').classList.add('hidden');
            Layout.$('#saveProductBtn').disabled = true;

            // Reset tabs
            Layout.$('#tabProductSearch').classList.add('tab-active');
            Layout.$('#tabProductBrowse').classList.remove('tab-active');
            Layout.$('#productSearchTab').classList.remove('hidden');
            Layout.$('#productBrowseTab').classList.add('hidden');

            // Build category buttons
            buildProductCategoryButtons();

            productModal.showModal();
        }

        function buildProductCategoryButtons() {
            const container = Layout.$('#productCategoryButtons');
            container.innerHTML = `
                <button type="button" class="btn btn-sm filter-btn ${currentProductCategory === 'all' ? 'active' : ''}" data-cat="all" onclick="filterProductsByCategory('all')">${t('all') || '–í—Å–µ'}</button>
                ${productCategories.map(cat => `
                    <button type="button" class="btn btn-sm filter-btn ${currentProductCategory === cat.slug ? 'active' : ''}" data-cat="${cat.slug}" onclick="filterProductsByCategory('${cat.slug}')">${cat.emoji || ''} ${Layout.getName(cat)}</button>
                `).join('')}
            `;
        }

        function switchProductTab(tab) {
            if (tab === 'search') {
                Layout.$('#productSearchTab').classList.remove('hidden');
                Layout.$('#productBrowseTab').classList.add('hidden');
                Layout.$('#tabProductSearch').classList.add('tab-active');
                Layout.$('#tabProductBrowse').classList.remove('tab-active');
            } else {
                Layout.$('#productSearchTab').classList.add('hidden');
                Layout.$('#productBrowseTab').classList.remove('hidden');
                Layout.$('#tabProductSearch').classList.remove('tab-active');
                Layout.$('#tabProductBrowse').classList.add('tab-active');
                filterProductsByCategory(currentProductCategory);
            }
        }

        function filterProducts(query) {
            const dropdown = Layout.$('#productDropdown');

            if (query.length < 1) {
                dropdown.classList.add('hidden');
                return;
            }

            const q = query.toLowerCase();
            const filtered = products.filter(p =>
                p.name_ru?.toLowerCase().includes(q) ||
                p.name_en?.toLowerCase().includes(q) ||
                p.name_hi?.includes(query)
            ).slice(0, 10);

            if (filtered.length === 0) {
                dropdown.innerHTML = `<div class="p-3 text-sm opacity-50">${t('nothing_found') || '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}</div>`;
            } else {
                dropdown.innerHTML = filtered.map(p => {
                    const cat = p.product_categories;
                    return `
                        <div class="p-3 hover:bg-base-200 cursor-pointer border-b border-base-200 last:border-0" onclick="selectProduct('${p.id}')">
                            <div class="font-medium">${Layout.getName(p)}</div>
                            <div class="text-xs opacity-50">${p.name_en || ''} ¬∑ ${Layout.getName(cat) || ''}</div>
                        </div>
                    `;
                }).join('');
            }

            dropdown.classList.remove('hidden');
        }

        function showProductDropdown() {
            const input = Layout.$('#productSearch');
            if (input.value.length >= 1) {
                filterProducts(input.value);
            }
        }

        function filterProductsByCategory(category) {
            currentProductCategory = category;
            const list = Layout.$('#productCategoryList');

            // Update buttons
            Layout.$$('#productCategoryButtons .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.cat === category);
            });

            let filtered = products;
            if (category !== 'all') {
                filtered = products.filter(p => p.product_categories?.slug === category);
            }

            if (filtered.length === 0) {
                list.innerHTML = `<div class="p-3 text-sm opacity-50 text-center">${t('nothing_found') || '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}</div>`;
            } else {
                list.innerHTML = filtered.map(p => {
                    const cat = p.product_categories;
                    return `
                        <div class="p-3 hover:bg-base-200 cursor-pointer border-b border-base-200 last:border-0" onclick="selectProduct('${p.id}')">
                            <div class="font-medium">${Layout.getName(p)}</div>
                            <div class="text-xs opacity-50">${p.name_en || ''} ¬∑ ${Layout.getName(cat) || ''}</div>
                        </div>
                    `;
                }).join('');
            }
        }

        function selectProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            // Check if already in request (check correct list)
            const itemsList = addingToViewedRequest ? viewingItems : requestItems;
            if (itemsList.some(i => i.product_id === productId)) {
                showAlert(tr('product_already_added', '–≠—Ç–æ—Ç –ø—Ä–æ–¥—É–∫—Ç —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∑–∞—è–≤–∫—É'));
                return;
            }

            selectedProduct = product;

            Layout.$('#productSearchTab').classList.add('hidden');
            Layout.$('#productBrowseTab').classList.add('hidden');
            Layout.$('#productDropdown').classList.add('hidden');
            Layout.$('#selectedProductDisplay').classList.remove('hidden');
            Layout.$('#productQuantitySection').classList.remove('hidden');
            Layout.$('#selectedProductName').textContent = Layout.getName(product);
            Layout.$('#selectedProductNameEn').textContent = product.name_en || '';

            // Set default quantity and unit
            Layout.$('#productQuantity').value = 1;
            Layout.$('#productUnit').textContent = localizeUnit(product.unit || 'kg');

            Layout.$('#saveProductBtn').disabled = false;
        }

        function clearSelectedProduct() {
            selectedProduct = null;

            if (Layout.$('#tabProductSearch').classList.contains('tab-active')) {
                Layout.$('#productSearchTab').classList.remove('hidden');
                Layout.$('#productSearch').value = '';
            } else {
                Layout.$('#productBrowseTab').classList.remove('hidden');
            }
            Layout.$('#selectedProductDisplay').classList.add('hidden');
            Layout.$('#productQuantitySection').classList.add('hidden');
            Layout.$('#saveProductBtn').disabled = true;
        }

        function addProductToRequest() {
            if (!selectedProduct) return;

            const quantity = parseFloat(Layout.$('#productQuantity').value) || 1;
            const unit = selectedProduct.unit || 'kg';
            const stock = stockItems.find(s => s.product_id === selectedProduct.id);
            const lastPrice = stock?.last_price || null;
            const quantityGrams = toGrams(quantity, unit);

            if (addingToViewedRequest) {
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º—É—é –∑–∞—è–≤–∫—É
                viewingItems.push({
                    id: null, // –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
                    product_id: selectedProduct.id,
                    product: selectedProduct,
                    quantity: quantity,
                    unit: unit,
                    last_price: lastPrice,
                    est_sum: lastPrice ? (quantityGrams / 1000) * lastPrice : null
                });

                productModal.close();
                addingToViewedRequest = false;
                renderViewedRequest();
            } else {
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É
                requestItems.push({
                    product_id: selectedProduct.id,
                    product: selectedProduct,
                    needed: quantity,
                    in_stock: 0,
                    to_purchase: quantity,
                    unit: unit,
                    last_price: lastPrice,
                    est_sum: lastPrice ? (quantityGrams / 1000) * lastPrice : null
                });

                // Mark as unsaved
                if (savedRequestId) {
                    savedRequestId = null;
                    Layout.$('#savedBadge').classList.add('hidden');
                    Layout.$('#saveBtn').disabled = false;
                    Layout.$('#saveBtn').classList.remove('btn-disabled');
                }

                productModal.close();
                renderResults();
            }
        }

        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
            const dropdown = Layout.$('#productDropdown');
            const input = Layout.$('#productSearch');
            if (dropdown && input && !dropdown.contains(e.target) && e.target !== input) {
                dropdown.classList.add('hidden');
            }
        });

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
        document.addEventListener('DOMContentLoaded', () => {
            Layout.$('#productModal')?.addEventListener('close', () => {
                addingToViewedRequest = false;
            });
        });

        // ==================== ITEM EDITING ====================
        function updateItemQuantity(index, value) {
            const newQty = parseFloat(value) || 0;
            if (newQty <= 0) {
                removeItem(index);
                return;
            }

            const item = requestItems[index];
            item.to_purchase = newQty;

            // –î–ª—è —Ä—É—á–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π (in_stock = 0) –æ–±–Ω–æ–≤–ª—è–µ–º –∏ "–Ω—É–∂–Ω–æ"
            if (item.in_stock === 0) {
                item.needed = newQty;
            }

            // Recalculate estimated sum
            const quantityGrams = toGrams(newQty, item.unit);
            item.est_sum = item.last_price ? (quantityGrams / 1000) * item.last_price : null;

            // Mark as unsaved
            if (savedRequestId) {
                savedRequestId = null;
                Layout.$('#savedBadge').classList.add('hidden');
                Layout.$('#saveBtn').disabled = false;
                Layout.$('#saveBtn').classList.remove('btn-disabled');
            }

            renderResults();
        }

        function removeItem(index) {
            requestItems.splice(index, 1);

            // Mark as unsaved
            if (savedRequestId) {
                savedRequestId = null;
                Layout.$('#savedBadge').classList.add('hidden');
                Layout.$('#saveBtn').disabled = false;
                Layout.$('#saveBtn').classList.remove('btn-disabled');
            }

            renderResults();
        }

        // ==================== INIT ====================
        async function init() {
            await Layout.init({ menuId: 'stock', itemId: 'requests' });
            await loadLocationId();
            await Promise.all([loadProducts(), loadProductCategories(), loadStock(), loadRecipes(), loadBuyers()]);
            selectPeriod('today');
            Layout.updateAllTranslations();
        }

        init();
    </script>

    <style>
        /* –£–±–∏—Ä–∞–µ–º —Å—Ç—Ä–µ–ª–∫–∏ —É —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* –ê–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–± –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ü–≤–µ—Ç –ª–æ–∫–∞—Ü–∏–∏ */
        .tab.tab-active {
            background-color: var(--current-color) !important;
            color: white !important;
        }

        /* –ü–µ—á–∞—Ç—å */
        @media print {
            body > *:not(#printContainer) {
                display: none !important;
            }
            #printContainer {
                display: block !important;
                position: static !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            .no-print {
                display: none !important;
            }
            .print-columns {
                column-count: 2;
                column-gap: 1.5rem;
                font-size: 11px;
            }
            .print-category {
                break-inside: avoid;
                margin-bottom: 0.5rem;
            }
            .print-category-title {
                font-weight: 600;
                font-size: 12px;
                padding: 2px 4px;
                margin-bottom: 2px;
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .print-item {
                display: flex;
                justify-content: space-between;
                padding: 1px 4px;
                border-bottom: 1px dotted #ddd;
            }
            .print-item-name {
                flex: 1;
            }
            .print-item-qty {
                font-weight: 600;
                white-space: nowrap;
                margin-left: 8px;
            }
        }

        .btn-current-color {
            background-color: var(--current-color);
            border-color: var(--current-color);
            color: white;
        }
        .btn-current-color:hover {
            background-color: var(--current-color);
            border-color: var(--current-color);
            opacity: 0.9;
        }
        .filter-btn.active {
            background-color: var(--current-color) !important;
            color: white !important;
            border-color: var(--current-color) !important;
        }
        .tabs-boxed .tab.tab-active {
            background-color: var(--current-color) !important;
            color: white !important;
        }

        /* Line clamp for items list */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</body>
</html>
