<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script>(function(){var c={kitchen:'#f49800',housing:'#8b5cf6'};var m=localStorage.getItem('srsk_module')||'kitchen';document.documentElement.style.setProperty('--current-color',c[m]||c.kitchen);})();</script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–¥–∞–Ω–∏—è ‚Äî –®–†–°–ö</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 flex-1">

        <!-- Page Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <h1 class="text-2xl font-bold" data-i18n="buildings_title">–ó–¥–∞–Ω–∏—è</h1>
            <button class="btn btn-primary gap-2" onclick="openBuildingModal()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <span data-i18n="add_building">–î–æ–±–∞–≤–∏—Ç—å –∑–¥–∞–Ω–∏–µ</span>
            </button>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6" id="statsCards">
            <!-- Generated by JS -->
        </div>

        <!-- Buildings List -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="buildingsList">
            <!-- Will be generated by JS -->
        </div>

        <div id="noBuildings" class="hidden text-center py-12 opacity-50">
            <div class="text-4xl mb-2">üè¢</div>
            <p data-i18n="no_buildings">–ó–¥–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
        </div>

    </main>

    <div id="footer-placeholder"></div>

    <!-- Add/Edit Building Modal -->
    <dialog id="buildingModal" class="modal">
        <div class="modal-box max-w-lg relative">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeBuildingModal()">‚úï</button>
            <h3 class="font-bold text-lg mb-4" id="buildingModalTitle" data-i18n="add_building">–î–æ–±–∞–≤–∏—Ç—å –∑–¥–∞–Ω–∏–µ</h3>

            <form id="buildingForm" class="space-y-4">
                <input type="hidden" name="id" />

                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="building_name">–ù–∞–∑–≤–∞–Ω–∏–µ</span><span class="text-error ml-1">*</span></label>
                    <input type="text" name="name_ru" class="input input-bordered w-full" required />
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label"><span class="label-text font-medium">Name (EN)</span></label>
                        <input type="text" name="name_en" class="input input-bordered w-full" />
                    </div>
                    <div>
                        <label class="label"><span class="label-text font-medium">‡§®‡§æ‡§Æ (HI)</span></label>
                        <input type="text" name="name_hi" class="input input-bordered w-full" />
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="building_type">–¢–∏–ø –∑–¥–∞–Ω–∏—è</span></label>
                        <select name="building_type_id" id="buildingTypeSelect" class="select select-bordered w-full">
                            <option value="">‚Äî</option>
                        </select>
                    </div>
                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="building_floors">–≠—Ç–∞–∂–µ–π</span></label>
                        <input type="number" name="floors" class="input input-bordered w-full" min="1" value="1" />
                    </div>
                </div>

                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="building_address">–ê–¥—Ä–µ—Å</span></label>
                    <input type="text" name="address" class="input input-bordered w-full" />
                </div>

                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="description">–û–ø–∏—Å–∞–Ω–∏–µ</span></label>
                    <textarea name="description_ru" rows="2" class="textarea textarea-bordered w-full"></textarea>
                </div>

                <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-2">
                        <input type="checkbox" name="is_active" class="checkbox checkbox-primary" checked />
                        <span class="label-text" data-i18n="active">–ê–∫—Ç–∏–≤–Ω–æ</span>
                    </label>
                </div>

                <!-- –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ -->
                <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-2">
                        <input type="checkbox" name="is_temporary" id="isTemporaryCheckbox" class="checkbox checkbox-warning" />
                        <span class="label-text" data-i18n="temporary_building">–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ</span>
                    </label>
                </div>

                <div id="temporaryDatesSection" class="hidden">
                    <label class="label"><span class="label-text font-medium" data-i18n="rental_period">–ü–µ—Ä–∏–æ–¥ –∞—Ä–µ–Ω–¥—ã</span><span class="text-error ml-1">*</span></label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <input type="date" name="available_from" class="input input-bordered w-full" />
                        </div>
                        <div>
                            <input type="date" name="available_until" class="input input-bordered w-full" />
                        </div>
                    </div>
                </div>

                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" onclick="closeBuildingModal()" data-i18n="cancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary" data-i18n="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>

            <!-- Delete button -->
            <div id="deleteBuildingSection" class="hidden border-t border-base-200 mt-4 pt-4">
                <button type="button" class="btn btn-ghost btn-error btn-sm gap-1" onclick="deleteBuilding()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    <span data-i18n="delete_building">–£–¥–∞–ª–∏—Ç—å –∑–¥–∞–Ω–∏–µ</span>
                </button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <script src="../js/layout.js"></script>
    <script>
        // ==================== STATE ====================
        let buildings = [];
        let buildingTypes = [];
        let roomCounts = {};
        let occupancyByType = {};  // { guesthouse: { occupied: 30, capacity: 72 }, team_house: { ... } }
        let todayEvents = { arrivals: 0, departures: 0 };
        let tomorrowEvents = { arrivals: 0, departures: 0 };
        let editingBuildingId = null;

        const t = key => Layout.t(key);
        const today = new Date().toISOString().split('T')[0];
        const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];

        function formatDate(dateStr) {
            if (!dateStr) return '‚Äî';
            const date = new Date(dateStr);
            return date.toLocaleDateString(Layout.currentLang === 'hi' ? 'hi-IN' : Layout.currentLang === 'en' ? 'en-US' : 'ru-RU', {
                day: 'numeric', month: 'short'
            });
        }

        // ==================== DATA ====================
        async function loadBuildingTypes() {
            const { data } = await Layout.db.from('building_types').select('*').order('sort_order');
            return data || [];
        }

        async function loadBuildings() {
            const { data } = await Layout.db
                .from('buildings')
                .select('*, building_types(id, slug, name_ru, name_en, name_hi, color)')
                .order('sort_order');
            return data || [];
        }

        async function loadRoomCounts() {
            const { data } = await Layout.db
                .from('rooms')
                .select('building_id')
                .eq('is_active', true);

            const counts = {};
            (data || []).forEach(r => {
                counts[r.building_id] = (counts[r.building_id] || 0) + 1;
            });
            return counts;
        }

        async function loadOccupancyByType() {
            // –ü–æ–ª—É—á–∞–µ–º –∑–∞–Ω—è—Ç–æ—Å—Ç—å –≤—Å–µ—Ö –∫–æ–º–Ω–∞—Ç
            const { data: occupancy } = await Layout.db.rpc('get_room_occupancy', { target_date: today });

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ç–∏–ø—É –∑–¥–∞–Ω–∏—è
            const result = {};
            (occupancy || []).forEach(item => {
                const building = buildings.find(b => b.id === item.building_id);
                const slug = building?.building_types?.slug;
                if (slug) {
                    if (!result[slug]) result[slug] = { occupied: 0, capacity: 0 };
                    result[slug].occupied += item.occupied || 0;
                    result[slug].capacity += item.capacity || 0;
                }
            });
            return result;
        }

        async function loadEvents(date) {
            const { data } = await Layout.db.rpc('get_arrivals_departures', { target_date: date });
            const arrivals = (data || []).filter(d => d.event_type === 'arrival').length;
            const departures = (data || []).filter(d => d.event_type === 'departure').length;
            return { arrivals, departures };
        }

        // ==================== RENDER ====================
        function renderStats() {
            const gh = occupancyByType.guesthouse || { occupied: 0, capacity: 0 };
            const th = occupancyByType.team_house || { occupied: 0, capacity: 0 };

            const ghPercent = gh.capacity > 0 ? Math.round((gh.occupied / gh.capacity) * 100) : 0;
            const thPercent = th.capacity > 0 ? Math.round((th.occupied / th.capacity) * 100) : 0;

            const ghType = buildingTypes.find(bt => bt.slug === 'guesthouse');
            const thType = buildingTypes.find(bt => bt.slug === 'team_house');

            Layout.$('#statsCards').innerHTML = `
                <div class="bg-base-100 rounded-lg p-4 shadow-sm" style="border-left: 4px solid ${ghType?.color || '#8b5cf6'}">
                    <div class="flex items-baseline gap-2 mb-1">
                        <span class="text-2xl font-bold">${gh.occupied}</span>
                        <span class="text-sm opacity-60">–∏–∑ ${gh.capacity}</span>
                    </div>
                    <div class="text-sm opacity-60 mb-2">${ghType ? Layout.getName(ghType) : '–ì–æ—Å—Ç–µ–≤–æ–π –¥–æ–º'}</div>
                    <progress class="progress progress-primary w-full h-2" value="${ghPercent}" max="100"></progress>
                </div>
                <div class="bg-base-100 rounded-lg p-4 shadow-sm" style="border-left: 4px solid ${thType?.color || '#10b981'}">
                    <div class="flex items-baseline gap-2 mb-1">
                        <span class="text-2xl font-bold">${th.occupied}</span>
                        <span class="text-sm opacity-60">–∏–∑ ${th.capacity}</span>
                    </div>
                    <div class="text-sm opacity-60 mb-2">${thType ? Layout.getName(thType) : '–î–æ–º–∞ –∫–æ–º–∞–Ω–¥—ã'}</div>
                    <progress class="progress progress-success w-full h-2" value="${thPercent}" max="100"></progress>
                </div>
                <div class="bg-base-100 rounded-lg p-4 shadow-sm">
                    <div class="flex items-baseline gap-2 mb-1">
                        <span class="text-2xl font-bold text-green-600">+${todayEvents.arrivals}</span>
                        <span class="text-2xl font-bold text-orange-500">‚àí${todayEvents.departures}</span>
                    </div>
                    <div class="text-sm opacity-60">${t('today') || '–°–µ–≥–æ–¥–Ω—è'}</div>
                </div>
                <div class="bg-base-100 rounded-lg p-4 shadow-sm">
                    <div class="flex items-baseline gap-2 mb-1">
                        <span class="text-2xl font-bold text-green-600">+${tomorrowEvents.arrivals}</span>
                        <span class="text-2xl font-bold text-orange-500">‚àí${tomorrowEvents.departures}</span>
                    </div>
                    <div class="text-sm opacity-60">${t('tomorrow') || '–ó–∞–≤—Ç—Ä–∞'}</div>
                </div>
            `;
        }

        function renderBuildings() {
            const list = Layout.$('#buildingsList');
            const noBuildings = Layout.$('#noBuildings');

            if (buildings.length === 0) {
                list.innerHTML = '';
                noBuildings.classList.remove('hidden');
                return;
            }

            noBuildings.classList.add('hidden');

            list.innerHTML = buildings.map(building => {
                const type = building.building_types;
                const roomCount = roomCounts[building.id] || 0;

                return `
                    <div class="bg-base-100 rounded-lg shadow-sm overflow-hidden ${!building.is_active ? 'opacity-50' : ''}" style="border-left: 4px solid ${type?.color || '#6366f1'}">
                        <div class="p-4">
                            <div class="flex items-start justify-between gap-2 mb-2">
                                <div>
                                    <h3 class="font-semibold text-lg">${Layout.getName(building)}</h3>
                                    <div class="flex flex-wrap gap-1 mt-1">
                                        ${type ? `<span class="badge badge-sm" style="background-color: ${type.color}20; color: ${type.color}; border-color: ${type.color}">${Layout.getName(type)}</span>` : ''}
                                        ${building.is_temporary ? `<span class="badge badge-warning badge-sm">${t('temporary') || '–í—Ä–µ–º–µ–Ω–Ω–æ–µ'}</span>` : ''}
                                    </div>
                                </div>
                                <button class="btn btn-ghost btn-sm btn-square" onclick="openBuildingModal('${building.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                            </div>

                            <div class="grid grid-cols-2 gap-2 text-sm opacity-70">
                                <div class="flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                    </svg>
                                    ${building.floors} ${t('building_floors')}
                                </div>
                                <div class="flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                                    </svg>
                                    ${roomCount} ${t('building_rooms_count')}
                                </div>
                            </div>

                            ${building.is_temporary && building.available_from && building.available_until ? `
                                            <div class="text-sm opacity-70 mt-2 flex items-center gap-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                </svg>
                                                ${formatDate(building.available_from)} ‚Äî ${formatDate(building.available_until)}
                                            </div>
                                        ` : ''}
                            ${building.description_ru ? `<p class="text-sm opacity-60 mt-2">${building['description_' + Layout.currentLang] || building.description_ru}</p>` : ''}

                            <div class="mt-3 flex gap-2">
                                <a href="rooms.html?building=${building.id}" class="btn btn-ghost btn-sm gap-1">
                                    ${t('nav_rooms')}
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                    </svg>
                                </a>
                                <a href="floor-plan.html?building=${building.id}" class="btn btn-ghost btn-sm gap-1">
                                    ${t('btn_view_plan') || '–ü–ª–∞–Ω'}
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== BUILDING MODAL ====================
        function populateBuildingTypeSelect() {
            const select = Layout.$('#buildingTypeSelect');
            select.innerHTML = `<option value="">‚Äî</option>` +
                buildingTypes.map(bt => `<option value="${bt.id}">${Layout.getName(bt)}</option>`).join('');
        }

        function toggleTemporaryDates() {
            const isTemporary = Layout.$('#isTemporaryCheckbox').checked;
            const section = Layout.$('#temporaryDatesSection');
            const form = Layout.$('#buildingForm');

            if (isTemporary) {
                section.classList.remove('hidden');
                form.available_from.required = true;
                form.available_until.required = true;
            } else {
                section.classList.add('hidden');
                form.available_from.required = false;
                form.available_until.required = false;
            }
        }

        function openBuildingModal(buildingId = null) {
            editingBuildingId = buildingId;
            const form = Layout.$('#buildingForm');
            const title = Layout.$('#buildingModalTitle');
            const deleteSection = Layout.$('#deleteBuildingSection');

            form.reset();
            populateBuildingTypeSelect();

            if (buildingId) {
                const building = buildings.find(b => b.id === buildingId);
                if (building) {
                    title.textContent = t('edit_building');
                    form.id.value = building.id;
                    form.name_ru.value = building.name_ru || '';
                    form.name_en.value = building.name_en || '';
                    form.name_hi.value = building.name_hi || '';
                    form.building_type_id.value = building.building_type_id || '';
                    form.floors.value = building.floors || 1;
                    form.address.value = building.address || '';
                    form.description_ru.value = building.description_ru || '';
                    form.is_active.checked = building.is_active !== false;
                    form.is_temporary.checked = building.is_temporary || false;
                    form.available_from.value = building.available_from || '';
                    form.available_until.value = building.available_until || '';
                    deleteSection.classList.remove('hidden');
                }
            } else {
                title.textContent = t('add_building');
                deleteSection.classList.add('hidden');
            }

            toggleTemporaryDates();
            Layout.setupAutoTranslate('#buildingForm', ['name']);
            Layout.$('#buildingModal').showModal();
        }

        function closeBuildingModal() {
            Layout.$('#buildingModal').close();
            editingBuildingId = null;
        }

        async function saveBuilding(e) {
            e.preventDefault();
            const form = Layout.$('#buildingForm');
            const isTemporary = form.is_temporary.checked;

            const data = {
                name_ru: form.name_ru.value.trim(),
                name_en: form.name_en.value.trim() || null,
                name_hi: form.name_hi.value.trim() || null,
                building_type_id: form.building_type_id.value || null,
                floors: parseInt(form.floors.value) || 1,
                address: form.address.value.trim() || null,
                description_ru: form.description_ru.value.trim() || null,
                is_active: form.is_active.checked,
                is_temporary: isTemporary,
                available_from: isTemporary ? form.available_from.value : null,
                available_until: isTemporary ? form.available_until.value : null
            };

            try {
                if (editingBuildingId) {
                    const { error } = await Layout.db.from('buildings').update(data).eq('id', editingBuildingId);
                    if (error) throw error;
                } else {
                    const { error } = await Layout.db.from('buildings').insert(data);
                    if (error) throw error;
                }

                closeBuildingModal();
                buildings = await loadBuildings();
                render();
            } catch (err) {
                console.error('Error saving building:', err);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + err.message);
            }
        }

        async function deleteBuilding() {
            if (!editingBuildingId) return;
            if (!confirm(t('delete_building_confirm'))) return;

            try {
                const { error } = await Layout.db.from('buildings').delete().eq('id', editingBuildingId);
                if (error) throw error;

                closeBuildingModal();
                buildings = await loadBuildings();
                roomCounts = await loadRoomCounts();
                render();
            } catch (err) {
                console.error('Error deleting building:', err);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + err.message);
            }
        }

        // ==================== RENDER ====================
        function render() {
            renderStats();
            renderBuildings();
        }

        function updateUI() {
            Layout.updateAllTranslations();
            render();
        }

        window.onLanguageChange = () => updateUI();

        // ==================== INIT ====================
        async function init() {
            await Layout.init({ module: 'housing', menuId: 'settings', itemId: 'buildings' });
            Layout.showLoader();

            // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            [buildingTypes, buildings, roomCounts] = await Promise.all([
                loadBuildingTypes(),
                loadBuildings(),
                loadRoomCounts()
            ]);

            // –ó–∞—Ç–µ–º –¥–∞–Ω–Ω—ã–µ, –∑–∞–≤–∏—Å—è—â–∏–µ –æ—Ç buildings
            [occupancyByType, todayEvents, tomorrowEvents] = await Promise.all([
                loadOccupancyByType(),
                loadEvents(today),
                loadEvents(tomorrow)
            ]);

            // Forms
            Layout.$('#buildingForm').addEventListener('submit', saveBuilding);
            Layout.$('#isTemporaryCheckbox').addEventListener('change', toggleTemporaryDates);

            updateUI();
            Layout.hideLoader();
        }

        init();
    </script>
</body>
</html>
