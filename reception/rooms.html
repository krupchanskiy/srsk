<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script src="../js/color-init.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="rooms_page_title">–ö–æ–º–Ω–∞—Ç—ã ‚Äî –®–†–°–ö</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 flex-1">

        <!-- Page Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <h1 class="text-2xl font-bold" data-i18n="rooms_title">–ö–æ–º–Ω–∞—Ç—ã</h1>
            <div class="flex gap-2">
                <button class="btn btn-outline gap-2" onclick="openBulkRoomModal()" data-permission="create_room">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span data-i18n="add_multiple_rooms">–î–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–º–Ω–∞—Ç</span>
                </button>
                <button class="btn btn-primary gap-2" onclick="openRoomModal()" data-permission="create_room">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    <span data-i18n="add_room">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É</span>
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="flex flex-col sm:flex-row sm:items-center gap-4 mb-6">
            <div class="flex-1 max-w-xs">
                <select id="buildingFilter" class="select select-bordered w-full">
                    <option value="" data-i18n="all_buildings">–í—Å–µ –∑–¥–∞–Ω–∏—è</option>
                </select>
            </div>
            <div class="flex-1 max-w-xs">
                <select id="floorFilter" class="select select-bordered w-full">
                    <option value="" data-i18n="all_floors">–í—Å–µ —ç—Ç–∞–∂–∏</option>
                </select>
            </div>
        </div>

        <!-- Rooms List -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="roomsList">
            <!-- Will be generated by JS -->
        </div>

        <div id="noRooms" class="hidden text-center py-12 opacity-50">
            <div class="text-4xl mb-2">üö™</div>
            <p data-i18n="no_rooms">–ö–æ–º–Ω–∞—Ç –ø–æ–∫–∞ –Ω–µ—Ç</p>
        </div>

    </main>

    <div id="footer-placeholder"></div>

    <!-- Add/Edit Room Modal -->
    <dialog id="roomModal" class="modal">
        <div class="modal-box max-w-lg relative">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeRoomModal()">‚úï</button>
            <h3 class="font-bold text-lg mb-4" id="roomModalTitle" data-i18n="add_room">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É</h3>

            <form id="roomForm" class="space-y-4">
                <input type="hidden" name="id" />

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="room_building">–ó–¥–∞–Ω–∏–µ</span><span class="text-error ml-1">*</span></label>
                        <select name="building_id" id="buildingSelect" class="select select-bordered w-full" required>
                            <option value="">‚Äî</option>
                        </select>
                    </div>
                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="room_number">–ù–æ–º–µ—Ä</span><span class="text-error ml-1">*</span></label>
                        <input type="text" name="number" class="input input-bordered w-full" required />
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="room_type">–¢–∏–ø –∫–æ–º–Ω–∞—Ç—ã</span></label>
                        <select name="room_type_id" id="roomTypeSelect" class="select select-bordered w-full">
                            <option value="">‚Äî</option>
                        </select>
                    </div>
                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="room_floor">–≠—Ç–∞–∂</span></label>
                        <input type="number" name="floor" class="input input-bordered w-full" min="1" value="1" />
                    </div>
                </div>

                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="room_capacity">–ú–µ—Å—Ç</span></label>
                    <input type="number" name="capacity" class="input input-bordered w-full" min="1" value="1" />
                </div>

                <!-- Amenities -->
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="room_amenities">–£–¥–æ–±—Å—Ç–≤–∞</span></label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="label cursor-pointer justify-start gap-2">
                            <input type="checkbox" name="has_bathroom" class="checkbox checkbox-sm checkbox-primary" />
                            <span class="label-text" data-i18n="has_bathroom">–°–∞–Ω—É–∑–µ–ª</span>
                        </label>
                        <label class="label cursor-pointer justify-start gap-2">
                            <input type="checkbox" name="has_ac" class="checkbox checkbox-sm checkbox-primary" />
                            <span class="label-text" data-i18n="has_ac">–ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä</span>
                        </label>
                        <label class="label cursor-pointer justify-start gap-2">
                            <input type="checkbox" name="has_kitchen" class="checkbox checkbox-sm checkbox-primary" />
                            <span class="label-text" data-i18n="has_kitchen">–ö—É—Ö–Ω—è</span>
                        </label>
                        <label class="label cursor-pointer justify-start gap-2">
                            <input type="checkbox" name="has_wifi" class="checkbox checkbox-sm checkbox-primary" checked />
                            <span class="label-text" data-i18n="has_wifi">Wi-Fi</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="description">–û–ø–∏—Å–∞–Ω–∏–µ</span></label>
                    <textarea name="description_ru" rows="2" class="textarea textarea-bordered w-full"></textarea>
                </div>

                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="room_status">–°—Ç–∞—Ç—É—Å –∫–æ–º–Ω–∞—Ç—ã</span></label>
                    <select name="status" class="select select-bordered w-full">
                        <option value="active" data-i18n="room_status_active">–ê–∫—Ç–∏–≤–Ω–∞</option>
                        <option value="maintenance" data-i18n="room_status_maintenance">–ù–∞ —Ä–µ–º–æ–Ω—Ç–µ</option>
                        <option value="mothballed" data-i18n="room_status_mothballed">–ó–∞–∫–æ–Ω—Å–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∞</option>
                    </select>
                </div>

                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" onclick="closeRoomModal()" data-i18n="cancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary" data-permission="create_room" data-i18n="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>

            <!-- Delete button -->
            <div id="deleteRoomSection" class="hidden border-t border-base-200 mt-4 pt-4">
                <button type="button" class="btn btn-ghost btn-error btn-sm gap-1" onclick="deleteRoom()" data-permission="delete_room">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    <span data-i18n="delete_room">–£–¥–∞–ª–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É</span>
                </button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Bulk Add Rooms Modal -->
    <dialog id="bulkRoomModal" class="modal">
        <div class="modal-box max-w-4xl relative">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeBulkRoomModal()">‚úï</button>
            <h3 class="font-bold text-lg mb-4" data-i18n="add_multiple_rooms">–î–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–º–Ω–∞—Ç</h3>

            <form id="bulkRoomForm" class="space-y-4">
                <!-- –ó–¥–∞–Ω–∏–µ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–Ω–∞—Ç -->
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="room_building">–ó–¥–∞–Ω–∏–µ</span><span class="text-error ml-1">*</span></label>
                    <select id="bulkBuildingSelect" class="select select-bordered w-full max-w-xs" required>
                        <option value="">‚Äî</option>
                    </select>
                </div>

                <div class="divider"></div>

                <!-- –¢–∞–±–ª–∏—Ü–∞ —Å –∫–æ–º–Ω–∞—Ç–∞–º–∏ -->
                <div class="overflow-x-auto">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th class="w-20" data-i18n="room_floor">–≠—Ç–∞–∂</th>
                                <th data-i18n="room_number">–ù–æ–º–µ—Ä (–Ω–∞–∑–≤–∞–Ω–∏–µ)</th>
                                <th class="w-24" data-i18n="room_capacity">–ú–µ—Å—Ç</th>
                                <th class="w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="bulkRoomsTable">
                            <!-- –°—Ç—Ä–æ–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
                        </tbody>
                    </table>
                </div>

                <button type="button" class="btn btn-ghost btn-sm gap-2" onclick="addBulkRoomRow()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    <span data-i18n="add_row">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</span>
                </button>

                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" onclick="closeBulkRoomModal()" data-i18n="cancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary" data-i18n="save_all">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <script src="../js/config.js"></script>
    <script src="../js/auth-check.js?v=3"></script>
    <script src="../js/permissions-ui.js?v=2"></script>
    <script src="../js/cache.js"></script>
    <script src="../js/utils.js?v=2"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/date-utils.js"></script>
    <script src="../js/layout.js?v=5"></script>
    <script>
        // ==================== STATE ====================
        let rooms = [];
        let buildings = [];
        let roomTypes = [];
        let currentBuildingFilter = '';
        let currentFloorFilter = '';
        let editingRoomId = null;

        const t = key => Layout.t(key);

        // ==================== DATA ====================
        async function loadBuildings() {
            const data = await Cache.getOrLoad('buildings', async () => {
                const { data, error } = await Layout.db.from('buildings').select('*').eq('is_active', true).order('sort_order');
                if (error) { console.error('Error loading buildings:', error); return null; }
                return data;
            });
            return data || [];
        }

        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –¥–æ—Å—Ç—É–ø–Ω–æ –ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–¥–∞–Ω–∏–µ —Å–µ–π—á–∞—Å
        function isTemporaryBuildingAvailable(building) {
            if (!building.is_temporary) return true;
            const today = DateUtils.toISO(new Date());
            return building.available_from <= today && building.available_until >= today;
        }

        async function loadRoomTypes() {
            const result = await Cache.getOrLoad('room_types', async () => {
                const { data } = await Layout.db.from('room_types').select('*').order('sort_order');
                return data;
            });
            return result || [];
        }

        // –ù–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ (1, 2, 10, 11 –≤–º–µ—Å—Ç–æ 1, 10, 11, 2)
        function naturalSort(a, b) {
            return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
        }

        async function loadRooms() {
            const { data } = await Layout.db
                .from('rooms')
                .select('*, buildings(id, name_ru, name_en, name_hi), room_types(id, name_ru, name_en, name_hi, color)')
                .order('building_id')
                .order('floor')
                .order('sort_order');
            return (data || []).sort((a, b) => {
                if (a.building_id !== b.building_id) return 0; // —É–∂–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ
                if (a.floor !== b.floor) return a.floor - b.floor;
                if (a.sort_order !== b.sort_order) return (a.sort_order || 0) - (b.sort_order || 0);
                return naturalSort(a.number, b.number);
            });
        }

        // ==================== FILTERS ====================
        function populateFilters() {
            // Building filter (—Å –º–µ—Ç–∫–æ–π –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–¥–∞–Ω–∏–π)
            const buildingFilter = Layout.$('#buildingFilter');
            buildingFilter.innerHTML = `<option value="">${t('all_buildings')}</option>` +
                buildings.map(b => {
                    const label = Layout.getName(b);
                    const tempMark = b.is_temporary ? ' ‚è±' : '';
                    return `<option value="${b.id}">${label}${tempMark}</option>`;
                }).join('');
            buildingFilter.value = currentBuildingFilter;

            // Floor filter
            const floors = [...new Set(rooms.map(r => r.floor))].sort((a, b) => a - b);
            const floorFilter = Layout.$('#floorFilter');
            floorFilter.innerHTML = `<option value="">${t('all_floors')}</option>` +
                floors.map(f => `<option value="${f}">${t('floor_n')} ${f}</option>`).join('');
            floorFilter.value = currentFloorFilter;
        }

        // ==================== RENDER ====================
        function renderRooms() {
            const list = Layout.$('#roomsList');
            const noRooms = Layout.$('#noRooms');

            let filtered = rooms.filter(r => {
                if (currentBuildingFilter && r.building_id !== currentBuildingFilter) return false;
                if (currentFloorFilter && r.floor !== parseInt(currentFloorFilter)) return false;
                return true;
            });

            if (filtered.length === 0) {
                list.innerHTML = '';
                noRooms.classList.remove('hidden');
                return;
            }

            noRooms.classList.add('hidden');

            list.innerHTML = filtered.map(room => {
                const building = room.buildings;
                const roomType = room.room_types;
                const amenities = [];
                if (room.has_bathroom) amenities.push('üöø');
                if (room.has_ac) amenities.push('‚ùÑÔ∏è');
                if (room.has_kitchen) amenities.push('üç≥');
                if (room.has_wifi) amenities.push('üì∂');

                const statusBadge = room.status === 'maintenance'
                    ? `<span class="badge badge-warning badge-sm">${t('room_status_maintenance')}</span>`
                    : room.status === 'mothballed'
                    ? `<span class="badge badge-error badge-sm">${t('room_status_mothballed')}</span>`
                    : '';

                return `
                    <div class="bg-base-100 rounded-lg shadow-sm p-4 ${room.status !== 'active' ? 'opacity-60' : ''}" style="border-left: 4px solid ${roomType?.color || '#6366f1'}">
                        <div class="flex items-start justify-between gap-2 mb-2">
                            <div>
                                <h3 class="font-bold text-xl">${room.number}</h3>
                                <div class="text-sm opacity-60">
                                    ${Layout.getName(building)}
                                    ${building.is_temporary ? '<span class="badge badge-warning badge-xs ml-1">‚è±</span>' : ''}
                                </div>
                            </div>
                            <button class="btn btn-ghost btn-sm btn-square" onclick="openRoomModal('${room.id}')" data-permission="edit_room">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                        </div>

                        <div class="flex flex-wrap gap-2 mb-2">
                            ${statusBadge}
                            ${roomType ? `<span class="badge badge-sm" style="background-color: ${roomType.color}20; color: ${roomType.color}; border-color: ${roomType.color}">${Layout.getName(roomType)}</span>` : ''}
                            <span class="badge badge-outline badge-sm">${t('floor_n')} ${room.floor}</span>
                            <span class="badge badge-outline badge-sm">${room.capacity} ${t('beds')}</span>
                        </div>

                        ${amenities.length > 0 ? `<div class="text-lg">${amenities.join(' ')}</div>` : ''}
                    </div>
                `;
            }).join('');

            // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∞–≤ –∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–∞–º
            if (window.applyPermissions) {
                window.applyPermissions();
            }
        }

        // ==================== ROOM MODAL ====================
        function populateRoomSelects() {
            const buildingSelect = Layout.$('#buildingSelect');
            buildingSelect.innerHTML = `<option value="">‚Äî</option>` +
                buildings.map(b => `<option value="${b.id}">${Layout.getName(b)}</option>`).join('');

            const roomTypeSelect = Layout.$('#roomTypeSelect');
            roomTypeSelect.innerHTML = `<option value="">‚Äî</option>` +
                roomTypes.map(rt => `<option value="${rt.id}">${Layout.getName(rt)}</option>`).join('');
        }

        function openRoomModal(roomId = null) {
            editingRoomId = roomId;
            const form = Layout.$('#roomForm');
            const title = Layout.$('#roomModalTitle');
            const deleteSection = Layout.$('#deleteRoomSection');

            form.reset();
            populateRoomSelects();

            // Pre-select building from filter
            if (!roomId && currentBuildingFilter) {
                form.building_id.value = currentBuildingFilter;
            }

            if (roomId) {
                const room = rooms.find(r => r.id === roomId);
                if (room) {
                    title.textContent = t('edit_room');
                    form.id.value = room.id;
                    form.building_id.value = room.building_id || '';
                    form.number.value = room.number || '';
                    form.room_type_id.value = room.room_type_id || '';
                    form.floor.value = room.floor || 1;
                    form.capacity.value = room.capacity || 1;
                    form.has_bathroom.checked = room.has_bathroom;
                    form.has_ac.checked = room.has_ac;
                    form.has_kitchen.checked = room.has_kitchen;
                    form.has_wifi.checked = room.has_wifi;
                    form.description_ru.value = room.description_ru || '';
                    form.status.value = room.status || 'active';
                    deleteSection.classList.remove('hidden');
                }
            } else {
                title.textContent = t('add_room');
                deleteSection.classList.add('hidden');
            }

            Layout.$('#roomModal').showModal();
        }

        function closeRoomModal() {
            Layout.$('#roomModal').close();
            editingRoomId = null;
        }

        async function saveRoom(e) {
            e.preventDefault();
            const form = Layout.$('#roomForm');

            const data = {
                building_id: form.building_id.value,
                number: form.number.value.trim(),
                room_type_id: form.room_type_id.value || null,
                floor: parseInt(form.floor.value) || 1,
                capacity: parseInt(form.capacity.value) || 1,
                has_bathroom: form.has_bathroom.checked,
                has_ac: form.has_ac.checked,
                has_kitchen: form.has_kitchen.checked,
                has_wifi: form.has_wifi.checked,
                description_ru: form.description_ru.value.trim() || null,
                status: form.status.value,
                is_active: form.status.value === 'active'
            };

            try {
                if (editingRoomId) {
                    const { error } = await Layout.db.from('rooms').update(data).eq('id', editingRoomId);
                    if (error) throw error;
                } else {
                    const { error } = await Layout.db.from('rooms').insert(data);
                    if (error) throw error;
                }

                Cache.invalidate('rooms'); Cache.invalidate('buildings_with_rooms');
                closeRoomModal();
                rooms = await loadRooms();
                populateFilters();
                renderRooms();
            } catch (err) {
                console.error('Error saving room:', err);
                Layout.showNotification(t('save_error') + ': ' + err.message, 'error');
            }
        }

        async function deleteRoom() {
            if (!editingRoomId) return;
            if (!confirm(t('delete_room_confirm'))) return;

            try {
                const { error } = await Layout.db.from('rooms').delete().eq('id', editingRoomId);
                if (error) throw error;

                Cache.invalidate('rooms'); Cache.invalidate('buildings_with_rooms');
                closeRoomModal();
                rooms = await loadRooms();
                populateFilters();
                renderRooms();
            } catch (err) {
                console.error('Error deleting room:', err);
                Layout.showNotification(t('delete_error') + ': ' + err.message, 'error');
            }
        }

        // ==================== RENDER ====================
        function updateUI() {
            Layout.updateAllTranslations();
            populateFilters();
            renderRooms();
        }

        window.onLanguageChange = () => updateUI();

        // ==================== BULK ADD ROOMS ====================
        function openBulkRoomModal() {
            // –ó–∞–ø–æ–ª–Ω–∏—Ç—å –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∑–¥–∞–Ω–∏–π
            const buildingSelect = Layout.$('#bulkBuildingSelect');
            buildingSelect.innerHTML = '<option value="">‚Äî</option>';
            buildings.forEach(b => {
                buildingSelect.innerHTML += `<option value="${b.id}">${Layout.getName(b)}</option>`;
            });

            // –û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –∏ –¥–æ–±–∞–≤–∏—Ç—å 10 –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫
            const tbody = Layout.$('#bulkRoomsTable');
            tbody.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                addBulkRoomRow();
            }

            Layout.$('#bulkRoomModal').showModal();
        }

        function closeBulkRoomModal() {
            Layout.$('#bulkRoomModal').close();
            Layout.$('#bulkRoomForm').reset();
        }

        function addBulkRoomRow() {
            const tbody = Layout.$('#bulkRoomsTable');
            const rowIndex = tbody.children.length;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="number" class="input input-xs input-bordered w-full" name="floor_${rowIndex}" min="1" value="1" /></td>
                <td><input type="text" class="input input-xs input-bordered w-full" name="number_${rowIndex}" placeholder="${t('room_number_placeholder')}" /></td>
                <td><input type="number" class="input input-xs input-bordered w-full" name="capacity_${rowIndex}" min="1" value="1" /></td>
                <td>
                    <button type="button" class="btn btn-ghost btn-xs btn-circle" onclick="removeBulkRoomRow(this)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        }

        function removeBulkRoomRow(btn) {
            const row = btn.closest('tr');
            row.remove();
        }

        async function saveBulkRooms(e) {
            e.preventDefault();

            const buildingId = Layout.$('#bulkBuildingSelect').value;
            if (!buildingId) {
                Layout.showNotification(t('select_building_required') || '–í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ', 'warning');
                return;
            }

            // –°–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
            const tbody = Layout.$('#bulkRoomsTable');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const roomsToAdd = [];

            rows.forEach((row, index) => {
                const floorInput = row.querySelector(`input[name="floor_${index}"]`);
                const numberInput = row.querySelector(`input[name="number_${index}"]`);
                const capacityInput = row.querySelector(`input[name="capacity_${index}"]`);

                const number = numberInput?.value.trim();
                if (!number) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏

                roomsToAdd.push({
                    building_id: buildingId,
                    number: number,
                    floor: parseInt(floorInput?.value) || 1,
                    capacity: parseInt(capacityInput?.value) || 1,
                    status: 'active',
                    is_active: true,
                    has_wifi: true // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
                });
            });

            if (roomsToAdd.length === 0) {
                Layout.showNotification(t('no_rooms_to_add') || '–ù–µ—Ç –∫–æ–º–Ω–∞—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è', 'warning');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã –Ω–æ–º–µ—Ä–æ–≤ –≤–Ω—É—Ç—Ä–∏ —Å–ø–∏—Å–∫–∞
            const numberCounts = {};
            const duplicates = [];
            roomsToAdd.forEach(room => {
                numberCounts[room.number] = (numberCounts[room.number] || 0) + 1;
                if (numberCounts[room.number] > 1 && !duplicates.includes(room.number)) {
                    duplicates.push(room.number);
                }
            });

            if (duplicates.length > 0) {
                Layout.showNotification(
                    `${t('duplicate_room_numbers') || '–î—É–±–ª–∏–∫–∞—Ç—ã –Ω–æ–º–µ—Ä–æ–≤'}: ${duplicates.join(', ')}`,
                    'warning'
                );
                return;
            }

            try {
                Layout.showLoader();

                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–Ω–∞—Ç—ã
                const numbers = roomsToAdd.map(r => r.number);
                const { data: existing } = await Layout.db
                    .from('rooms')
                    .select('number')
                    .eq('building_id', buildingId)
                    .in('number', numbers);

                if (existing && existing.length > 0) {
                    const existingNumbers = existing.map(r => r.number).join(', ');
                    Layout.showNotification(
                        `${t('rooms_already_exist') || '–ö–æ–º–Ω–∞—Ç—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç'}: ${existingNumbers}`,
                        'warning'
                    );
                    Layout.hideLoader();
                    return;
                }

                const { error } = await Layout.db.from('rooms').insert(roomsToAdd);
                if (error) throw error;

                Layout.showNotification(`${t('added') || '–î–æ–±–∞–≤–ª–µ–Ω–æ'}: ${roomsToAdd.length} ${Layout.pluralize(roomsToAdd.length, {ru: ['–∫–æ–º–Ω–∞—Ç–∞', '–∫–æ–º–Ω–∞—Ç—ã', '–∫–æ–º–Ω–∞—Ç'], en: ['room', 'rooms'], hi: '‡§ï‡§Æ‡§∞‡•á'})}`, 'success');

                Cache.invalidate('rooms'); Cache.invalidate('buildings_with_rooms');
                closeBulkRoomModal();
                rooms = await loadRooms();
                populateFilters();
                renderRooms();
            } catch (err) {
                Layout.handleError(err, '–ú–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç');
            } finally {
                Layout.hideLoader();
            }
        }

        // ==================== INIT ====================
        async function init() {
            await Layout.init({ module: 'housing', menuId: 'settings', itemId: 'rooms' });
            Layout.showLoader();

            // Get building filter from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentBuildingFilter = urlParams.get('building') || '';

            [buildings, roomTypes, rooms] = await Promise.all([
                loadBuildings(),
                loadRoomTypes(),
                loadRooms()
            ]);

            // Filter events
            Layout.$('#buildingFilter').addEventListener('change', e => {
                currentBuildingFilter = e.target.value;
                renderRooms();
            });

            Layout.$('#floorFilter').addEventListener('change', e => {
                currentFloorFilter = e.target.value;
                renderRooms();
            });

            // Forms
            Layout.$('#roomForm').addEventListener('submit', saveRoom);
            Layout.$('#bulkRoomForm').addEventListener('submit', saveBulkRooms);

            updateUI();
            Layout.hideLoader();
        }

        init();
    </script>
</body>
</html>
