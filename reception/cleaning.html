<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script src="../js/color-init.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="cleaning_page_title">Уборка — ШРСК</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        .calendar-day {
            min-height: 44px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.15s;
        }
        .calendar-day.other-month {
            opacity: 0.3;
        }
        .calendar-day.today {
            ring: 2px;
            ring-offset: 1px;
            box-shadow: 0 0 0 2px oklch(var(--p));
        }
        .calendar-day.level-1 {
            background: oklch(var(--wa) / 0.7);
            color: oklch(var(--wac));
        }
        .calendar-day.level-2 {
            background: #fb923c;
            color: white;
        }
        .calendar-day.level-3 {
            background: oklch(var(--er) / 0.9);
            color: oklch(var(--erc));
        }
        .calendar-day.completed-1 {
            background: oklch(var(--su) / 0.4);
        }
        .calendar-day.completed-2 {
            background: oklch(var(--su) / 0.6);
        }
        .calendar-day.completed-3 {
            background: oklch(var(--su) / 0.85);
            color: oklch(var(--suc));
        }
        .cleaning-count {
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
        }
        .cleaning-actions {
            display: flex;
            gap: 0.5rem;
        }
        .cleaning-action-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .cleaning-action-btn:hover {
            transform: scale(1.05);
        }
        .cleaning-action-btn:active {
            transform: scale(0.95);
        }
        .cleaning-action-btn.complete {
            background: oklch(var(--su) / 0.15);
            color: oklch(var(--su));
        }
        .cleaning-action-btn.complete:hover {
            background: oklch(var(--su) / 0.25);
        }
        .cleaning-action-btn.extend {
            background: oklch(var(--in) / 0.15);
            color: oklch(var(--in));
        }
        .cleaning-action-btn.extend:hover {
            background: oklch(var(--in) / 0.25);
        }
        .cleaning-action-btn.delete {
            background: oklch(var(--er) / 0.15);
            color: oklch(var(--er));
        }
        .cleaning-action-btn.delete:hover {
            background: oklch(var(--er) / 0.25);
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 flex-1">

        <!-- Page Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div class="flex items-center gap-4 flex-wrap">
                <h1 class="text-2xl font-bold" data-i18n="cleaning_title">Уборка</h1>
                <!-- Mode toggle: upcoming/completed -->
                <div class="tabs tabs-boxed bg-base-100">
                    <button class="tab tab-active" id="modeUpcomingBtn" onclick="setMode('upcoming')">
                        <span data-i18n="cleaning_upcoming_tab">Предстоящие</span>
                    </button>
                    <button class="tab" id="modeCompletedBtn" onclick="setMode('completed')">
                        <span data-i18n="cleaning_completed_tab">Законченные</span>
                    </button>
                </div>
                <!-- View toggle: list/calendar -->
                <div class="tabs tabs-boxed bg-base-100">
                    <button class="tab tab-active gap-2" id="viewListBtn" onclick="setView('list')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                        </svg>
                        <span data-i18n="view_list">Список</span>
                    </button>
                    <button class="tab gap-2" id="viewCalendarBtn" onclick="setView('calendar')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span data-i18n="view_calendar">Календарь</span>
                    </button>
                </div>
            </div>
            <!-- Add buttons -->
            <div id="addButtons" class="flex gap-2" data-permission="manage_cleaning">
                <button class="btn btn-primary gap-2" onclick="openCleaningModal('cleaning')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    <span data-i18n="add_cleaning">Уборка</span>
                </button>
                <button class="btn btn-neutral gap-2" onclick="openCleaningModal('linen')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    <span data-i18n="add_linen">Постельное</span>
                </button>
            </div>
        </div>

        <!-- Stats -->
        <div id="statsSection" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
            <div class="bg-error/10 border border-error/30 rounded-lg p-4">
                <div class="text-3xl font-bold text-error" id="statOverdue">0</div>
                <div class="text-sm opacity-60" data-i18n="cleaning_overdue">Просрочено</div>
            </div>
            <div class="bg-warning/10 border border-warning/30 rounded-lg p-4">
                <div class="text-3xl font-bold text-warning" id="statToday">0</div>
                <div class="text-sm opacity-60" data-i18n="cleaning_today">Сегодня</div>
            </div>
            <div class="bg-info/10 border border-info/30 rounded-lg p-4">
                <div class="text-3xl font-bold text-info" id="statTomorrow">0</div>
                <div class="text-sm opacity-60" data-i18n="cleaning_tomorrow">Завтра</div>
            </div>
            <div class="bg-base-100 rounded-lg p-4">
                <div class="text-3xl font-bold" id="statWeek">0</div>
                <div class="text-sm opacity-60" data-i18n="cleaning_week">На неделе</div>
            </div>
        </div>

        <!-- List View -->
        <div id="listView" class="space-y-6">
            <!-- Overdue -->
            <div class="bg-base-100 rounded-lg shadow-sm overflow-hidden hidden" id="listOverdue">
                <div class="p-4 border-b border-base-200 bg-error/10">
                    <h2 class="font-semibold text-lg flex items-center gap-2">
                        <span class="text-error" data-i18n="cleaning_overdue">Просрочено</span>
                        <span class="badge badge-error" id="countOverdue">0</span>
                    </h2>
                </div>
                <div class="divide-y divide-base-200" id="roomsOverdue">
                    <!-- Rooms will be rendered here -->
                </div>
            </div>

            <!-- Today -->
            <div class="bg-base-100 rounded-lg shadow-sm overflow-hidden" id="listToday">
                <div class="p-4 border-b border-base-200 bg-warning/10">
                    <h2 class="font-semibold text-lg flex items-center gap-2">
                        <span class="text-warning" data-i18n="cleaning_today">Сегодня</span>
                        <span class="badge badge-warning" id="countToday">0</span>
                    </h2>
                </div>
                <div class="divide-y divide-base-200" id="roomsToday">
                    <!-- Skeleton loader -->
                    <div class="p-4 flex items-center justify-between skeleton-row"><div class="flex items-center gap-4"><div class="skeleton w-12 h-12 rounded-lg"></div><div><div class="skeleton h-5 w-24 mb-1"></div><div class="skeleton h-3 w-16"></div></div></div><div class="skeleton h-10 w-24"></div></div>
                    <div class="p-4 flex items-center justify-between skeleton-row"><div class="flex items-center gap-4"><div class="skeleton w-12 h-12 rounded-lg"></div><div><div class="skeleton h-5 w-20 mb-1"></div><div class="skeleton h-3 w-20"></div></div></div><div class="skeleton h-10 w-24"></div></div>
                </div>
            </div>

            <!-- Tomorrow -->
            <div class="bg-base-100 rounded-lg shadow-sm overflow-hidden" id="listTomorrow">
                <div class="p-4 border-b border-base-200 bg-info/10">
                    <h2 class="font-semibold text-lg flex items-center gap-2">
                        <span class="text-info" data-i18n="cleaning_tomorrow">Завтра</span>
                        <span class="badge badge-info" id="countTomorrow">0</span>
                    </h2>
                </div>
                <div class="divide-y divide-base-200" id="roomsTomorrow">
                    <!-- Rooms will be rendered here -->
                </div>
            </div>

            <!-- Next days -->
            <div class="bg-base-100 rounded-lg shadow-sm overflow-hidden" id="listUpcoming">
                <div class="p-4 border-b border-base-200">
                    <h2 class="font-semibold text-lg flex items-center gap-2">
                        <span data-i18n="cleaning_upcoming">Ближайшие дни</span>
                        <span class="badge" id="countUpcoming">0</span>
                    </h2>
                </div>
                <div class="divide-y divide-base-200" id="roomsUpcoming">
                    <!-- Rooms will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Calendar View -->
        <div id="calendarView" class="hidden">
            <!-- Calendar navigation -->
            <div class="bg-base-100 rounded-lg shadow-sm p-3 mb-4 flex items-center justify-between">
                <button class="btn btn-ghost btn-sm" onclick="prevMonth()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <div class="flex items-center gap-4">
                    <!-- Legend -->
                    <div class="flex items-center gap-3 text-xs">
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-warning"></span> 1-5</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-orange-400"></span> 6-10</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-error"></span> >10</span>
                    </div>
                </div>
                <button class="btn btn-ghost btn-sm" onclick="nextMonth()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>

            <!-- Two calendars side by side -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- First month -->
                <div class="bg-base-100 rounded-lg shadow-sm overflow-hidden">
                    <div class="p-3 border-b border-base-200 text-center">
                        <h3 class="font-semibold" id="calendarTitle1">Январь 2025</h3>
                    </div>
                    <div class="p-3">
                        <div class="grid grid-cols-7 gap-0.5 mb-1 text-xs">
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_mon">Пн</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_tue">Вт</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_wed">Ср</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_thu">Чт</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_fri">Пт</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_sat">Сб</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_sun">Вс</div>
                        </div>
                        <div class="grid grid-cols-7 gap-0.5" id="calendarGrid1"></div>
                    </div>
                </div>

                <!-- Second month -->
                <div class="bg-base-100 rounded-lg shadow-sm overflow-hidden">
                    <div class="p-3 border-b border-base-200 text-center">
                        <h3 class="font-semibold" id="calendarTitle2">Февраль 2025</h3>
                    </div>
                    <div class="p-3">
                        <div class="grid grid-cols-7 gap-0.5 mb-1 text-xs">
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_mon">Пн</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_tue">Вт</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_wed">Ср</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_thu">Чт</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_fri">Пт</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_sat">Сб</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_sun">Вс</div>
                        </div>
                        <div class="grid grid-cols-7 gap-0.5" id="calendarGrid2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Completed List View -->
        <div id="completedListView" class="hidden space-y-4">
            <div class="bg-base-100 rounded-lg shadow-sm overflow-hidden">
                <div class="p-4 border-b border-base-200 bg-success/10">
                    <h2 class="font-semibold text-lg flex items-center gap-2">
                        <span class="text-success" data-i18n="cleaning_completed_title">Законченные уборки</span>
                        <span class="badge badge-success" id="countCompleted">0</span>
                    </h2>
                </div>
                <div class="divide-y divide-base-200" id="roomsCompleted">
                    <!-- Completed rooms will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Completed Calendar View -->
        <div id="completedCalendarView" class="hidden">
            <!-- Calendar navigation -->
            <div class="bg-base-100 rounded-lg shadow-sm p-3 mb-4 flex items-center justify-between">
                <button class="btn btn-ghost btn-sm" onclick="prevMonth()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-3 text-xs">
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-success/50"></span> 1-5</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-success/70"></span> 6-10</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-success"></span> >10</span>
                    </div>
                </div>
                <button class="btn btn-ghost btn-sm" onclick="nextMonth()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>

            <!-- Two calendars side by side -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- First month -->
                <div class="bg-base-100 rounded-lg shadow-sm overflow-hidden">
                    <div class="p-3 border-b border-base-200 text-center">
                        <h3 class="font-semibold" id="completedCalendarTitle1">Январь 2025</h3>
                    </div>
                    <div class="p-3">
                        <div class="grid grid-cols-7 gap-0.5 mb-1 text-xs">
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_mon">Пн</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_tue">Вт</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_wed">Ср</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_thu">Чт</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_fri">Пт</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_sat">Сб</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_sun">Вс</div>
                        </div>
                        <div class="grid grid-cols-7 gap-0.5" id="completedCalendarGrid1"></div>
                    </div>
                </div>

                <!-- Second month -->
                <div class="bg-base-100 rounded-lg shadow-sm overflow-hidden">
                    <div class="p-3 border-b border-base-200 text-center">
                        <h3 class="font-semibold" id="completedCalendarTitle2">Февраль 2025</h3>
                    </div>
                    <div class="p-3">
                        <div class="grid grid-cols-7 gap-0.5 mb-1 text-xs">
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_mon">Пн</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_tue">Вт</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_wed">Ср</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_thu">Чт</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_fri">Пт</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_sat">Сб</div>
                            <div class="text-center opacity-60 py-1" data-i18n="weekday_sun">Вс</div>
                        </div>
                        <div class="grid grid-cols-7 gap-0.5" id="completedCalendarGrid2"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="footer-placeholder"></div>

    <!-- Day Details Modal -->
    <dialog id="dayModal" class="modal">
        <div class="modal-box max-w-lg relative">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeDayModal()">✕</button>
            <h3 class="font-bold text-lg mb-4" id="dayModalTitle" data-i18n="cleaning_title">Уборка</h3>

            <div id="dayModalContent" class="space-y-3">
                <!-- Rooms will be rendered here -->
            </div>

            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="closeDayModal()" data-i18n="close">Закрыть</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Extend Cleaning Modal -->
    <dialog id="extendModal" class="modal">
        <div class="modal-box max-w-sm relative">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeExtendModal()">✕</button>
            <h3 class="font-bold text-lg mb-4" data-i18n="extend_cleaning">Перенести уборку</h3>

            <input type="hidden" id="extendTaskId" />

            <div class="form-control mb-4">
                <label class="label py-1">
                    <span class="label-text font-medium" data-i18n="new_date">Новая дата</span>
                </label>
                <input type="date" id="extendDateInput" class="input input-bordered" />
            </div>

            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="closeExtendModal()" data-i18n="cancel">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveExtendCleaning()" data-i18n="save">Сохранить</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Add Cleaning Modal (Multi-select) -->
    <dialog id="cleaningModal" class="modal">
        <div class="modal-box max-w-lg relative">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeCleaningModal()">✕</button>
            <h3 class="font-bold text-lg mb-2 flex items-center gap-2" id="cleaningModalTitle">
                <svg class="w-5 h-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                </svg>
                <span data-i18n="cleaning_assign">Назначить уборку</span>
            </h3>

            <input type="hidden" id="cleaningTypeInput" value="cleaning" />

            <!-- Date -->
            <div class="form-control mb-4">
                <label class="label py-1">
                    <span class="label-text font-medium" id="cleaningDateLabel" data-i18n="cleaning_date">Дата уборки</span>
                </label>
                <input type="date" id="cleaningDateInput" class="input input-bordered input-sm" />
            </div>

            <!-- Room selection -->
            <div class="text-sm text-gray-500 mb-2" data-i18n="select_rooms">Выберите номера:</div>
            <div class="max-h-64 overflow-y-auto space-y-2 mb-4" id="bulkRoomsList"></div>

            <!-- Selected count -->
            <div class="text-sm text-gray-500 mb-4">
                <span data-i18n="selected">Выбрано</span>: <span id="bulkSelectedCount" class="font-medium">0</span>
            </div>

            <!-- Notes -->
            <div class="form-control mb-4">
                <label class="label py-1">
                    <span class="label-text font-medium" data-i18n="notes">Примечание</span>
                </label>
                <input type="text" id="cleaningNotesInput" class="input input-bordered input-sm w-full" />
            </div>

            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="closeCleaningModal()" data-i18n="cancel">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveBulkCleaning()" data-i18n="add">Добавить</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <script src="../js/config.js"></script>
    <script src="../js/auth-check.js?v=3"></script>
    <script src="../js/cache.js"></script>
    <script src="../js/utils.js?v=2"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/date-utils.js"></script>
    <script src="../js/layout.js?v=5"></script>
    <script>
        // ==================== STATE ====================
        let cleaningData = []; // { date, rooms: [...] } - upcoming
        let completedData = []; // { date, rooms: [...] } - completed
        let manualCleanings = []; // Manual cleaning tasks
        let buildings = [];
        let allRoomsData = []; // All rooms with buildings
        let currentView = 'list';
        let currentMode = 'upcoming'; // 'upcoming' | 'completed'
        let calendarYear = new Date().getFullYear();
        let calendarMonth = new Date().getMonth();
        let bulkSelectedRooms = new Set();

        const t = key => Layout.t(key);
        const e = str => Layout.escapeHtml(str);
        const today = DateUtils.toISO(new Date());
        const tomorrow = DateUtils.toISO(new Date(Date.now() + 86400000));

        // ==================== DATA ====================
        async function loadCleaningSchedule() {
            // Загружаем выезды: просроченные (30 дней назад) + будущие (60 дней вперёд)
            const overdueStart = DateUtils.toISO(new Date(Date.now() - 30 * 86400000));
            const endDate = DateUtils.toISO(new Date(Date.now() + 60 * 86400000));

            const { data, error } = await Layout.db
                .from('residents')
                .select(`
                    id, check_out, guest_name, cleaning_done, cleaning_skipped,
                    rooms(id, number, floor, buildings(id, name_ru, name_en)),
                    vaishnavas(id, first_name, spiritual_name),
                    bookings(id, name, contact_name)
                `)
                .eq('status', 'active')
                .gte('check_out', overdueStart)
                .lte('check_out', endDate)
                .neq('cleaning_done', true)
                .neq('cleaning_skipped', true)
                .order('check_out');

            if (error) {
                console.error('Error loading cleaning schedule:', error);
                return;
            }

            // Группируем по дате
            const byDate = {};
            (data || []).forEach(resident => {
                const date = resident.check_out;
                if (!byDate[date]) {
                    byDate[date] = [];
                }
                byDate[date].push(resident);
            });

            // Преобразуем в массив
            cleaningData = Object.entries(byDate).map(([date, rooms]) => ({ date, rooms }));
            cleaningData.sort((a, b) => a.date.localeCompare(b.date));

            // Загружаем ручные уборки
            await loadManualCleanings();

            // Объединяем данные
            mergeCleaningData();

            updateStats();
            render();
        }

        async function loadManualCleanings() {
            const overdueStart = DateUtils.toISO(new Date(Date.now() - 30 * 86400000));
            const endDate = DateUtils.toISO(new Date(Date.now() + 60 * 86400000));

            const { data, error } = await Layout.db
                .from('room_cleanings')
                .select(`
                    id, start_date, end_date, notes, completed, type,
                    rooms(id, number, floor, buildings(id, name_ru, name_en))
                `)
                .eq('completed', false)
                .gte('start_date', overdueStart)
                .lte('start_date', endDate)
                .order('start_date');

            if (error) {
                manualCleanings = [];
                return;
            }

            manualCleanings = data || [];
        }

        function mergeCleaningData() {
            // Добавляем ручные уборки в cleaningData
            manualCleanings.forEach(task => {
                const date = task.start_date;
                let dayData = cleaningData.find(d => d.date === date);

                if (!dayData) {
                    dayData = { date, rooms: [] };
                    cleaningData.push(dayData);
                }

                // Добавляем как "виртуального резидента" для единообразия отображения
                dayData.rooms.push({
                    id: task.id,
                    check_out: date,
                    rooms: task.rooms,
                    isManual: true,
                    cleaningType: task.type || 'cleaning',
                    notes: task.notes,
                    cleaningTaskId: task.id
                });
            });

            // Пересортируем по дате
            cleaningData.sort((a, b) => a.date.localeCompare(b.date));

            // Сортируем комнаты внутри каждого дня по зданию и номеру
            cleaningData.forEach(day => {
                day.rooms.sort((a, b) => {
                    const buildingA = a.rooms?.buildings?.name_ru || '';
                    const buildingB = b.rooms?.buildings?.name_ru || '';
                    if (buildingA !== buildingB) {
                        return buildingA.localeCompare(buildingB, 'ru');
                    }
                    // Натуральная сортировка номеров (1, 2, 10, 11 вместо 1, 10, 11, 2)
                    const numA = parseInt(a.rooms?.number) || 0;
                    const numB = parseInt(b.rooms?.number) || 0;
                    return numA - numB;
                });
            });
        }

        async function loadCompletedCleanings() {
            // Загружаем законченные уборки за последние 30 дней
            const startDate = DateUtils.toISO(new Date(Date.now() - 30 * 86400000));

            // 1. Авто-уборки (после выезда) с cleaning_done=true
            const { data: autoData, error: autoError } = await Layout.db
                .from('residents')
                .select(`
                    id, check_out, guest_name, cleaning_done,
                    rooms(id, number, floor, buildings(id, name_ru, name_en)),
                    vaishnavas(id, first_name, spiritual_name),
                    bookings(id, name, contact_name)
                `)
                .eq('cleaning_done', true)
                .gte('check_out', startDate)
                .order('check_out', { ascending: false });

            // 2. Ручные уборки с completed=true
            const { data: manualData, error: manualError } = await Layout.db
                .from('room_cleanings')
                .select(`
                    id, start_date, end_date, notes, completed, completed_at, type,
                    rooms(id, number, floor, buildings(id, name_ru, name_en))
                `)
                .eq('completed', true)
                .gte('start_date', startDate)
                .order('start_date', { ascending: false });

            // Группируем по дате
            const byDate = {};

            // Добавляем авто-уборки
            (autoData || []).forEach(resident => {
                const date = resident.check_out;
                if (!byDate[date]) byDate[date] = [];
                byDate[date].push({
                    ...resident,
                    isManual: false,
                    isCompleted: true
                });
            });

            // Добавляем ручные уборки
            (manualData || []).forEach(task => {
                const date = task.start_date;
                if (!byDate[date]) byDate[date] = [];
                byDate[date].push({
                    id: task.id,
                    check_out: date,
                    rooms: task.rooms,
                    isManual: true,
                    isCompleted: true,
                    cleaningType: task.type || 'cleaning',
                    notes: task.notes,
                    completed_at: task.completed_at
                });
            });

            // Преобразуем в массив и сортируем по дате (новые сверху)
            completedData = Object.entries(byDate)
                .map(([date, rooms]) => ({ date, rooms }))
                .sort((a, b) => b.date.localeCompare(a.date));

            // Сортируем комнаты внутри каждого дня
            completedData.forEach(day => {
                day.rooms.sort((a, b) => {
                    const buildingA = a.rooms?.buildings?.name_ru || '';
                    const buildingB = b.rooms?.buildings?.name_ru || '';
                    if (buildingA !== buildingB) {
                        return buildingA.localeCompare(buildingB, 'ru');
                    }
                    const numA = parseInt(a.rooms?.number) || 0;
                    const numB = parseInt(b.rooms?.number) || 0;
                    return numA - numB;
                });
            });
        }

        async function loadBuildings() {
            const data = await Cache.getOrLoad('buildings', async () => {
                const { data, error } = await Layout.db
                    .from('buildings')
                    .select('*, building_types(color)')
                    .eq('is_active', true)
                    .order('sort_order');
                if (error) { console.error('Error loading buildings:', error); return null; }
                return data;
            });
            return data || [];
        }

        async function loadRooms(buildingId) {
            const { data } = await Layout.db
                .from('rooms')
                .select('*')
                .eq('building_id', buildingId)
                .eq('is_active', true)
                .order('floor');

            const rooms = data || [];

            // Числовая сортировка по номеру комнаты
            rooms.sort((a, b) => {
                if (a.floor !== b.floor) return a.floor - b.floor;
                const numA = parseInt(a.number) || 0;
                const numB = parseInt(b.number) || 0;
                return numA - numB;
            });

            return rooms;
        }

        // ==================== STATS ====================
        function updateStats() {
            // Overdue: before today
            const overdueData = cleaningData.filter(d => d.date < today);
            const overdueCount = overdueData.reduce((sum, d) => sum + d.rooms.length, 0);

            const todayData = cleaningData.find(d => d.date === today);
            const tomorrowData = cleaningData.find(d => d.date === tomorrow);

            // Week: next 7 days
            const weekEnd = DateUtils.toISO(new Date(Date.now() + 7 * 86400000));
            const weekData = cleaningData.filter(d => d.date >= today && d.date < weekEnd);
            const weekCount = weekData.reduce((sum, d) => sum + d.rooms.length, 0);

            Layout.$('#statOverdue').textContent = overdueCount;
            Layout.$('#statToday').textContent = todayData?.rooms.length || 0;
            Layout.$('#statTomorrow').textContent = tomorrowData?.rooms.length || 0;
            Layout.$('#statWeek').textContent = weekCount;
        }

        // ==================== RENDER ====================
        async function setMode(mode) {
            currentMode = mode;

            Layout.$('#modeUpcomingBtn').classList.toggle('tab-active', mode === 'upcoming');
            Layout.$('#modeCompletedBtn').classList.toggle('tab-active', mode === 'completed');

            // Скрыть/показать статистику и кнопки добавления
            Layout.$('#statsSection').classList.toggle('hidden', mode === 'completed');
            Layout.$('#addButtons').classList.toggle('hidden', mode === 'completed');

            // Загружаем законченные уборки при первом переключении
            if (mode === 'completed' && completedData.length === 0) {
                await loadCompletedCleanings();
            }

            render();
        }

        function setView(view) {
            currentView = view;

            Layout.$('#viewListBtn').classList.toggle('tab-active', view === 'list');
            Layout.$('#viewCalendarBtn').classList.toggle('tab-active', view === 'calendar');

            render();
        }

        function render() {
            const isUpcoming = currentMode === 'upcoming';

            // Скрываем/показываем нужные контейнеры
            Layout.$('#listView').classList.toggle('hidden', currentView !== 'list' || !isUpcoming);
            Layout.$('#calendarView').classList.toggle('hidden', currentView !== 'calendar' || !isUpcoming);
            Layout.$('#completedListView').classList.toggle('hidden', currentView !== 'list' || isUpcoming);
            Layout.$('#completedCalendarView').classList.toggle('hidden', currentView !== 'calendar' || isUpcoming);

            if (currentView === 'list') {
                if (isUpcoming) {
                    renderListView();
                } else {
                    renderCompletedListView();
                }
            } else {
                if (isUpcoming) {
                    renderCalendarView();
                } else {
                    renderCompletedCalendarView();
                }
            }
        }

        function getResidentName(resident) {
            if (resident.vaishnavas) {
                const tm = resident.vaishnavas;
                const name = tm.spiritual_name || tm.first_name || '';
                const displayName = Layout.currentLang === 'ru' ? name : Layout.transliterate(name);
                return e(displayName);
            }
            if (resident.guest_name) {
                return e(resident.guest_name);
            }
            if (resident.bookings) {
                return `${t('booking_placeholder') || 'Бронь'}: ${e(resident.bookings.name || resident.bookings.contact_name)}`;
            }
            return '—';
        }

        function renderRoomCard(resident, showDate = false) {
            const room = resident.rooms;
            const building = room?.buildings;
            const isManual = resident.isManual;
            const cleaningType = resident.cleaningType || 'cleaning';
            const taskId = resident.cleaningTaskId;

            // Badge for cleaning type
            let badge;
            if (isManual) {
                if (cleaningType === 'bedding') {
                    badge = `<span class="badge badge-sm" style="background: #06b6d4; color: white;">${t('bedding') || 'Бельё'}</span>`;
                } else {
                    badge = `<span class="badge badge-primary badge-sm">${t('cleaning_manual') || 'Назначена вручную'}</span>`;
                }
            } else {
                badge = `<span class="badge badge-warning badge-sm">${t('cleaning_after_checkout') || 'После выезда'}</span>`;
            }

            // Action buttons for all cleanings
            // Для ручных уборок: taskId = cleaningTaskId
            // Для авто (после выезда): residentId = resident.id
            const itemId = isManual ? taskId : resident.id;
            const itemType = isManual ? 'manual' : 'auto';
            const roomId = room?.id || '';

            // Проверяем права на управление уборкой
            const canManageCleaning = window.hasPermission && window.hasPermission('manage_cleaning');
            const actionButtons = canManageCleaning ? `
                <div class="cleaning-actions">
                    <button class="cleaning-action-btn complete" onclick="event.stopPropagation(); completeCleaning('${itemId}', '${itemType}')" title="${t('mark_done') || 'Выполнено'}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                        </svg>
                    </button>
                    <button class="cleaning-action-btn extend" onclick="event.stopPropagation(); openExtendModal('${itemId}', '${resident.check_out}', '${itemType}', '${roomId}')" title="${t('extend_cleaning') || 'Перенести'}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 11v4l2 2" />
                        </svg>
                    </button>
                    <button class="cleaning-action-btn delete" onclick="event.stopPropagation(); deleteCleaning('${itemId}', '${itemType}')" title="${t('delete') || 'Удалить'}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            ` : '';

            return `
                <div class="flex items-center justify-between p-4 hover:bg-base-200/50 transition-colors">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-medium">${building ? Layout.getName(building) : ''} / ${room?.number || '—'}</span>
                            ${badge}
                        </div>
                        <div class="text-sm opacity-60">
                            ${isManual
                                ? (resident.notes || '')
                                : getResidentName(resident)
                            }
                        </div>
                        ${showDate ? `<div class="text-xs opacity-50 mt-1">${formatDate(resident.check_out)}</div>` : ''}
                    </div>
                    <div class="flex items-center gap-3 ml-3">
                        <div class="text-right">
                            <div class="text-xs opacity-60">${t('floor_plan_floor') || 'Этаж'} ${room?.floor || '—'}</div>
                        </div>
                        ${actionButtons}
                    </div>
                </div>
            `;
        }

        function renderListView() {
            const overdueData = cleaningData.filter(d => d.date < today);
            const todayData = cleaningData.find(d => d.date === today);
            const tomorrowData = cleaningData.find(d => d.date === tomorrow);
            const upcomingData = cleaningData.filter(d => d.date > tomorrow);

            // Overdue
            const overdueCount = overdueData.reduce((sum, d) => sum + d.rooms.length, 0);
            Layout.$('#countOverdue').textContent = overdueCount;
            Layout.$('#listOverdue').classList.toggle('hidden', overdueCount === 0);
            if (overdueCount > 0) {
                Layout.$('#roomsOverdue').innerHTML = overdueData.map(day => `
                    <div class="border-b border-base-200 last:border-b-0">
                        <div class="text-sm font-medium px-4 py-2 bg-error/5 text-error">${formatDate(day.date)}</div>
                        <div class="divide-y divide-base-200">
                            ${day.rooms.map(r => renderRoomCard(r, true)).join('')}
                        </div>
                    </div>
                `).join('');
            }

            // Today
            Layout.$('#countToday').textContent = todayData?.rooms.length || 0;
            Layout.$('#roomsToday').innerHTML = todayData?.rooms.length > 0
                ? todayData.rooms.map(r => renderRoomCard(r)).join('')
                : `<div class="text-center py-4 opacity-50">${t('cleaning_no_rooms') || 'Нет комнат для уборки'}</div>`;

            // Tomorrow
            Layout.$('#countTomorrow').textContent = tomorrowData?.rooms.length || 0;
            Layout.$('#roomsTomorrow').innerHTML = tomorrowData?.rooms.length > 0
                ? tomorrowData.rooms.map(r => renderRoomCard(r)).join('')
                : `<div class="text-center py-4 opacity-50">${t('cleaning_no_rooms') || 'Нет комнат для уборки'}</div>`;

            // Upcoming (next 14 days)
            const upcomingLimit = DateUtils.toISO(new Date(Date.now() + 14 * 86400000));
            const limitedUpcoming = upcomingData.filter(d => d.date <= upcomingLimit);
            const upcomingCount = limitedUpcoming.reduce((sum, d) => sum + d.rooms.length, 0);

            Layout.$('#countUpcoming').textContent = upcomingCount;
            Layout.$('#roomsUpcoming').innerHTML = upcomingCount > 0
                ? limitedUpcoming.map(day => `
                    <div class="border-b border-base-200 last:border-b-0">
                        <div class="text-sm font-medium px-4 py-2 bg-base-200/30">${formatDate(day.date)}</div>
                        <div class="divide-y divide-base-200">
                            ${day.rooms.map(r => renderRoomCard(r)).join('')}
                        </div>
                    </div>
                `).join('')
                : `<div class="text-center py-4 opacity-50">${t('cleaning_no_rooms') || 'Нет комнат для уборки'}</div>`;
        }

        function renderCalendarView() {
            // Render both months
            renderMonthGrid(calendarYear, calendarMonth, '#calendarTitle1', '#calendarGrid1');

            // Second month
            let month2 = calendarMonth + 1;
            let year2 = calendarYear;
            if (month2 > 11) {
                month2 = 0;
                year2++;
            }
            renderMonthGrid(year2, month2, '#calendarTitle2', '#calendarGrid2');

            updateStats();
        }

        function renderMonthGrid(year, month, titleSelector, gridSelector) {
            const title = new Date(year, month).toLocaleDateString(
                Layout.currentLang === 'en' ? 'en-US' : 'ru-RU',
                { month: 'long', year: 'numeric' }
            );
            Layout.$(titleSelector).textContent = title.charAt(0).toUpperCase() + title.slice(1);

            const grid = Layout.$(gridSelector);
            const firstDay = new Date(year, month, 1);

            // Get first Monday before or on firstDay
            let startDay = new Date(firstDay);
            const dayOfWeek = startDay.getDay();
            const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            startDay.setDate(startDay.getDate() - diff);

            // Generate 6 weeks of days
            const days = [];
            const current = new Date(startDay);
            for (let i = 0; i < 42; i++) {
                days.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }

            grid.innerHTML = days.map(day => {
                const dateStr = DateUtils.toISO(day);
                const isOtherMonth = day.getMonth() !== month;
                const isToday = dateStr === today;
                const dayData = cleaningData.find(d => d.date === dateStr);
                const roomCount = dayData?.rooms.length || 0;

                // Level based on count: 1-5 yellow, 6-10 orange, >10 red
                let levelClass = '';
                if (roomCount > 0) {
                    if (roomCount <= 5) levelClass = 'level-1';
                    else if (roomCount <= 10) levelClass = 'level-2';
                    else levelClass = 'level-3';
                }

                return `
                    <div class="calendar-day ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''} ${levelClass} ${roomCount > 0 ? 'cursor-pointer hover:opacity-80' : ''}"
                         ${roomCount > 0 ? `onclick="openDayModal('${dateStr}')"` : ''}>
                        <div class="text-xs font-medium">${day.getDate()}</div>
                        ${roomCount > 0 ? `<div class="cleaning-count">${roomCount}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // ==================== COMPLETED VIEW ====================
        function renderCompletedListView() {
            const totalCount = completedData.reduce((sum, d) => sum + d.rooms.length, 0);
            Layout.$('#countCompleted').textContent = totalCount;

            if (totalCount === 0) {
                Layout.$('#roomsCompleted').innerHTML = `<div class="text-center py-4 opacity-50">${t('cleaning_no_completed') || 'Нет законченных уборок'}</div>`;
                return;
            }

            Layout.$('#roomsCompleted').innerHTML = completedData.map(day => `
                <div class="border-b border-base-200 last:border-b-0">
                    <div class="text-sm font-medium px-4 py-2 bg-success/5 text-success flex items-center justify-between">
                        <span>${formatDate(day.date)}</span>
                        <span class="badge badge-success badge-sm">${day.rooms.length}</span>
                    </div>
                    <div class="divide-y divide-base-200">
                        ${day.rooms.map(r => renderCompletedRoomCard(r)).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderCompletedRoomCard(resident) {
            const room = resident.rooms;
            const building = room?.buildings;
            const isManual = resident.isManual;
            const cleaningType = resident.cleaningType || 'cleaning';

            let badge;
            if (isManual) {
                if (cleaningType === 'bedding') {
                    badge = `<span class="badge badge-sm" style="background: #06b6d4; color: white;">${t('bedding') || 'Бельё'}</span>`;
                } else {
                    badge = `<span class="badge badge-primary badge-sm">${t('cleaning_manual') || 'Вручную'}</span>`;
                }
            } else {
                badge = `<span class="badge badge-warning badge-sm">${t('cleaning_after_checkout') || 'После выезда'}</span>`;
            }

            return `
                <div class="flex items-center justify-between p-4 hover:bg-base-200/50 transition-colors">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                            </svg>
                            <span class="font-medium">${building ? Layout.getName(building) : ''} / ${room?.number || '—'}</span>
                            ${badge}
                        </div>
                        <div class="text-sm opacity-60">
                            ${isManual ? e(resident.notes || '') : getResidentName(resident)}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs opacity-60">${t('floor_plan_floor') || 'Этаж'} ${room?.floor || '—'}</div>
                    </div>
                </div>
            `;
        }

        function renderCompletedCalendarView() {
            // Render both months
            renderCompletedMonthGrid(calendarYear, calendarMonth, '#completedCalendarTitle1', '#completedCalendarGrid1');

            // Second month
            let month2 = calendarMonth + 1;
            let year2 = calendarYear;
            if (month2 > 11) {
                month2 = 0;
                year2++;
            }
            renderCompletedMonthGrid(year2, month2, '#completedCalendarTitle2', '#completedCalendarGrid2');
        }

        function renderCompletedMonthGrid(year, month, titleSelector, gridSelector) {
            const title = new Date(year, month).toLocaleDateString(
                Layout.currentLang === 'en' ? 'en-US' : 'ru-RU',
                { month: 'long', year: 'numeric' }
            );
            Layout.$(titleSelector).textContent = title.charAt(0).toUpperCase() + title.slice(1);

            const grid = Layout.$(gridSelector);
            const firstDay = new Date(year, month, 1);

            let startDay = new Date(firstDay);
            const dayOfWeek = startDay.getDay();
            const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            startDay.setDate(startDay.getDate() - diff);

            const days = [];
            const current = new Date(startDay);
            for (let i = 0; i < 42; i++) {
                days.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }

            grid.innerHTML = days.map(day => {
                const dateStr = DateUtils.toISO(day);
                const isOtherMonth = day.getMonth() !== month;
                const isToday = dateStr === today;
                const dayData = completedData.find(d => d.date === dateStr);
                const roomCount = dayData?.rooms.length || 0;

                let levelClass = '';
                if (roomCount > 0) {
                    if (roomCount <= 5) levelClass = 'completed-1';
                    else if (roomCount <= 10) levelClass = 'completed-2';
                    else levelClass = 'completed-3';
                }

                return `
                    <div class="calendar-day ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''} ${levelClass} ${roomCount > 0 ? 'cursor-pointer hover:opacity-80' : ''}"
                         ${roomCount > 0 ? `onclick="openCompletedDayModal('${dateStr}')"` : ''}>
                        <div class="text-xs font-medium">${day.getDate()}</div>
                        ${roomCount > 0 ? `<div class="cleaning-count">${roomCount}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function openCompletedDayModal(dateStr) {
            const dayData = completedData.find(d => d.date === dateStr);
            if (!dayData) return;

            Layout.$('#dayModalTitle').textContent = `${t('cleaning_completed_title') || 'Законченные'} — ${formatDate(dateStr)}`;

            Layout.$('#dayModalContent').innerHTML = dayData.rooms.length > 0
                ? dayData.rooms.map(r => renderCompletedRoomCard(r)).join('')
                : `<div class="text-center py-4 opacity-50">${t('cleaning_no_completed') || 'Нет уборок'}</div>`;

            Layout.$('#dayModal').showModal();
        }

        function formatDate(dateStr) {
            const date = DateUtils.parseDate(dateStr);
            if (dateStr === today) return t('cleaning_today') || 'Сегодня';
            if (dateStr === tomorrow) return t('cleaning_tomorrow') || 'Завтра';
            return date.toLocaleDateString(Layout.currentLang === 'en' ? 'en-US' : 'ru-RU', {
                weekday: 'short',
                day: 'numeric',
                month: 'short'
            });
        }

        // ==================== CALENDAR NAVIGATION ====================
        function prevMonth() {
            calendarMonth--;
            if (calendarMonth < 0) {
                calendarMonth = 11;
                calendarYear--;
            }
            renderCalendarView();
        }

        function nextMonth() {
            calendarMonth++;
            if (calendarMonth > 11) {
                calendarMonth = 0;
                calendarYear++;
            }
            renderCalendarView();
        }

        // ==================== DAY MODAL ====================
        function openDayModal(dateStr) {
            const dayData = cleaningData.find(d => d.date === dateStr);
            if (!dayData) return;

            Layout.$('#dayModalTitle').textContent = `${t('cleaning_title') || 'Уборка'} — ${formatDate(dateStr)}`;

            Layout.$('#dayModalContent').innerHTML = dayData.rooms.length > 0
                ? dayData.rooms.map(r => renderRoomCard(r)).join('')
                : `<div class="text-center py-4 opacity-50">${t('cleaning_no_rooms') || 'Нет комнат'}</div>`;

            Layout.$('#dayModal').showModal();
        }

        function closeDayModal() {
            Layout.$('#dayModal').close();
        }

        // ==================== CLEANING MODAL (MULTI-SELECT) ====================
        async function loadAllRoomsData() {
            if (buildings.length > 0) return; // Already loaded

            // Load buildings
            buildings = await loadBuildings();

            // Load all rooms with building info
            const { data } = await Layout.db
                .from('rooms')
                .select('*, buildings(id, name_ru, name_en)')
                .eq('is_active', true)
                .order('floor');

            allRoomsData = data || [];

            // Числовая сортировка по номеру комнаты
            allRoomsData.sort((a, b) => {
                if (a.floor !== b.floor) return a.floor - b.floor;
                const numA = parseInt(a.number) || 0;
                const numB = parseInt(b.number) || 0;
                return numA - numB;
            });
        }

        async function openCleaningModal(type = 'cleaning') {
            bulkSelectedRooms.clear();

            // Ensure data is loaded
            await loadAllRoomsData();

            Layout.$('#cleaningTypeInput').value = type;

            // Update title and labels based on type
            if (type === 'linen') {
                Layout.$('#cleaningModalTitle').innerHTML = `
                    <svg class="w-5 h-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                    </svg>
                    ${t('add_linen_title') || 'Смена постельного белья'}`;
                Layout.$('#cleaningDateLabel').textContent = t('linen_date') || 'Дата смены белья';
            } else {
                Layout.$('#cleaningModalTitle').innerHTML = `
                    <svg class="w-5 h-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                    </svg>
                    ${t('add_cleaning_title') || 'Назначить уборку'}`;
                Layout.$('#cleaningDateLabel').textContent = t('cleaning_date') || 'Дата уборки';
            }

            // Set default date to today
            Layout.$('#cleaningDateInput').value = today;
            Layout.$('#cleaningNotesInput').value = '';

            // Render rooms list
            renderBulkRoomsList();
            updateBulkSelectedCount();

            Layout.$('#cleaningModal').showModal();
        }

        function closeCleaningModal() {
            Layout.$('#cleaningModal').close();
        }

        function renderBulkRoomsList() {
            const roomsList = Layout.$('#bulkRoomsList');

            if (buildings.length === 0) {
                roomsList.innerHTML = `<div class="text-center py-4 text-gray-500">${t('no_rooms') || 'Нет номеров'}</div>`;
                return;
            }

            let html = '';
            buildings.forEach(building => {
                const buildingRooms = allRoomsData.filter(r => r.building_id === building.id);
                if (buildingRooms.length === 0) return;

                const allRoomIds = buildingRooms.map(r => r.id);
                const allSelected = allRoomIds.every(id => bulkSelectedRooms.has(id));

                html += `<div class="collapse collapse-arrow bg-base-200 rounded-lg">
                    <input type="checkbox" checked />
                    <div class="collapse-title font-medium py-2 flex items-center justify-between pr-12">
                        <span>${Layout.getName(building)}</span>
                        <button type="button" class="btn btn-xs btn-ghost" onclick="event.stopPropagation(); toggleBulkBuilding('${building.id}')">
                            ${allSelected ? (t('deselect_all') || 'Снять все') : (t('select_all') || 'Выбрать все')}
                        </button>
                    </div>
                    <div class="collapse-content p-0">
                        <div class="grid grid-cols-4 gap-1 p-2">`;

                buildingRooms.forEach(room => {
                    const isSelected = bulkSelectedRooms.has(room.id);
                    const btnClass = isSelected ? 'btn-primary' : 'btn-outline';

                    html += `<button type="button" class="btn btn-sm ${btnClass}"
                        onclick="toggleBulkRoom('${room.id}')">
                        ${room.number}
                    </button>`;
                });

                html += `</div></div></div>`;
            });

            roomsList.innerHTML = html;
        }

        function toggleBulkRoom(roomId) {
            if (bulkSelectedRooms.has(roomId)) {
                bulkSelectedRooms.delete(roomId);
            } else {
                bulkSelectedRooms.add(roomId);
            }
            renderBulkRoomsList();
            updateBulkSelectedCount();
        }

        function toggleBulkBuilding(buildingId) {
            const buildingRooms = allRoomsData.filter(r => r.building_id === buildingId);
            const roomIds = buildingRooms.map(r => r.id);
            const allSelected = roomIds.every(id => bulkSelectedRooms.has(id));

            if (allSelected) {
                roomIds.forEach(id => bulkSelectedRooms.delete(id));
            } else {
                roomIds.forEach(id => bulkSelectedRooms.add(id));
            }

            renderBulkRoomsList();
            updateBulkSelectedCount();
        }

        function updateBulkSelectedCount() {
            Layout.$('#bulkSelectedCount').textContent = bulkSelectedRooms.size;
        }

        async function saveBulkCleaning() {
            const cleaningDate = Layout.$('#cleaningDateInput').value;
            const type = Layout.$('#cleaningTypeInput').value || 'cleaning';
            const notes = Layout.$('#cleaningNotesInput').value.trim();

            if (!cleaningDate) {
                Layout.showNotification(t('select_date') || 'Выберите дату', 'warning');
                return;
            }

            if (bulkSelectedRooms.size === 0) {
                Layout.showNotification(t('select_at_least_one') || 'Выберите хотя бы один номер', 'warning');
                return;
            }

            try {
                // Create records for each room (using room_cleanings table like timeline.html)
                const records = Array.from(bulkSelectedRooms).map(roomId => ({
                    room_id: roomId,
                    start_date: cleaningDate,
                    end_date: cleaningDate,
                    type: type,
                    notes: notes || null,
                    completed: false
                }));

                const { error } = await Layout.db
                    .from('room_cleanings')
                    .insert(records);

                if (error) throw error;

                closeCleaningModal();
                await loadCleaningSchedule();

            } catch (err) {
                console.error('Error saving cleaning:', err);
                Layout.showNotification((t('error_saving') || 'Ошибка сохранения') + ': ' + err.message, 'error');
            }
        }

        async function completeCleaning(itemId, itemType) {
            try {
                if (itemType === 'auto') {
                    // Для авто-уборки — ставим флаг cleaning_done в residents
                    const { error } = await Layout.db
                        .from('residents')
                        .update({ cleaning_done: true })
                        .eq('id', itemId);

                    if (error) throw error;
                } else {
                    // Для ручной уборки — помечаем как выполненную
                    const { error } = await Layout.db
                        .from('room_cleanings')
                        .update({ completed: true, completed_at: new Date().toISOString() })
                        .eq('id', itemId);

                    if (error) throw error;
                }

                await loadCleaningSchedule();

            } catch (err) {
                console.error('Error completing cleaning:', err);
                Layout.showNotification(t('error') + ': ' + err.message, 'error');
            }
        }

        // ==================== EXTEND MODAL ====================
        function openExtendModal(itemId, currentDate, itemType, roomId) {
            Layout.$('#extendTaskId').value = itemId;
            Layout.$('#extendDateInput').value = currentDate;
            Layout.$('#extendModal').dataset.itemType = itemType;
            Layout.$('#extendModal').dataset.roomId = roomId;
            Layout.$('#extendModal').showModal();
        }

        function closeExtendModal() {
            Layout.$('#extendModal').close();
        }

        async function saveExtendCleaning() {
            const itemId = Layout.$('#extendTaskId').value;
            const newDate = Layout.$('#extendDateInput').value;
            const itemType = Layout.$('#extendModal').dataset.itemType;
            const roomId = Layout.$('#extendModal').dataset.roomId;

            if (!newDate) {
                Layout.showNotification(t('select_date') || 'Выберите дату', 'warning');
                return;
            }

            try {
                if (itemType === 'auto') {
                    // Для авто-уборки — создаём новую запись в room_cleanings
                    const { error } = await Layout.db
                        .from('room_cleanings')
                        .insert({
                            room_id: roomId,
                            start_date: newDate,
                            end_date: newDate,
                            type: 'cleaning',
                            completed: false
                        });

                    if (error) throw error;

                    // Помечаем исходную авто-уборку как пропущенную
                    const { error: skipError } = await Layout.db
                        .from('residents')
                        .update({ cleaning_skipped: true })
                        .eq('id', itemId);

                    if (skipError) throw skipError;
                } else {
                    // Для ручной уборки — обновляем существующую запись
                    const { error } = await Layout.db
                        .from('room_cleanings')
                        .update({ start_date: newDate, end_date: newDate })
                        .eq('id', itemId);

                    if (error) throw error;
                }

                closeExtendModal();
                await loadCleaningSchedule();

            } catch (err) {
                console.error('Error extending cleaning:', err);
                Layout.showNotification(t('error') + ': ' + err.message, 'error');
            }
        }

        // ==================== DELETE CLEANING ====================
        async function deleteCleaning(itemId, itemType) {
            if (!confirm(t('confirm_delete') || 'Удалить эту уборку?')) {
                return;
            }

            try {
                if (itemType === 'auto') {
                    // Для авто-уборки — помечаем как пропущенную (скрываем)
                    const { error } = await Layout.db
                        .from('residents')
                        .update({ cleaning_skipped: true })
                        .eq('id', itemId);

                    if (error) throw error;
                } else {
                    // Для ручной уборки — удаляем из БД
                    const { error } = await Layout.db
                        .from('room_cleanings')
                        .delete()
                        .eq('id', itemId);

                    if (error) throw error;
                }

                await loadCleaningSchedule();

            } catch (err) {
                console.error('Error deleting cleaning:', err);
                Layout.showNotification(t('error') + ': ' + err.message, 'error');
            }
        }

        // ==================== INIT ====================
        function updateUI() {
            Layout.updateAllTranslations();
        }

        window.onLanguageChange = () => {
            updateUI();
            render();
        };

        async function init() {
            await Layout.init({ module: 'housing', menuId: 'reception', itemId: 'cleaning' });
            Layout.showLoader();
            updateUI();
            await loadCleaningSchedule();
            Layout.hideLoader();

            // Realtime: автообновление при изменениях
            subscribeToRealtime();
        }

        // Realtime подписка
        function subscribeToRealtime() {
            Layout.db.channel('cleaning-realtime')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'room_cleanings' },
                    handleRealtimeChange
                )
                .subscribe();
        }

        let realtimeTimeout = null;
        function handleRealtimeChange(payload) {
            if (realtimeTimeout) clearTimeout(realtimeTimeout);
            realtimeTimeout = setTimeout(async () => {
                await loadCleaningSchedule();
                render();
                Layout.showNotification('Данные обновлены', 'info');
            }, 500);
        }

        init();
    </script>
</body>
</html>
