<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script src="../js/color-init.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="retreats_page_title">–†–µ—Ç—Ä–∏—Ç—ã ‚Äî –®–†–°–ö</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        .calendar-day {
            min-height: 80px;
            position: relative;
        }
        .calendar-day.other-month {
            opacity: 0.3;
        }
        .calendar-day.today {
            background-color: rgba(var(--p), 0.1);
        }
        .retreat-bar {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            margin-bottom: 2px;
        }
        .retreat-bar:hover {
            filter: brightness(0.9);
        }
        .color-option {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.15s;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.selected {
            border-color: #333;
        }
        .translate-btn {
            padding: 2px 8px;
            font-size: 11px;
            border-radius: 4px;
            background: #e5e7eb;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.15s;
        }
        .translate-btn:hover {
            background: var(--current-color);
            color: white;
        }
        .translate-btn.loading {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 flex-1">

        <!-- Page Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-bold" data-i18n="retreats_title">–†–µ—Ç—Ä–∏—Ç—ã</h1>
                <!-- View Toggle -->
                <div class="join border border-base-300 rounded-lg">
                    <button class="join-item btn btn-sm view-btn bg-white border-0" data-view="list">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                        </svg>
                        <span class="hidden sm:inline ml-1" data-i18n="view_list">–°–ø–∏—Å–æ–∫</span>
                    </button>
                    <button class="join-item btn btn-sm btn-ghost view-btn border-0" data-view="calendar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span class="hidden sm:inline ml-1" data-i18n="view_calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
                    </button>
                </div>
            </div>
            <!-- Add Button -->
            <button class="btn btn-primary gap-2" onclick="openModal()" data-permission="create_retreat">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <span data-i18n="add_retreat">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ç—Ä–∏—Ç</span>
            </button>
        </div>

        <!-- Filter Tabs (List view) -->
        <div id="listFilters" class="flex flex-wrap gap-2 mb-6">
            <!-- Generated by JS -->
        </div>

        <!-- List View -->
        <div id="listView">
            <div id="retreatsList" class="space-y-3">
                <!-- Will be populated by JS -->
            </div>
            <div id="noRetreats" class="hidden text-center py-12 opacity-50">
                <div class="text-4xl mb-2">üìÖ</div>
                <p data-i18n="no_retreats">–ù–µ—Ç —Ä–µ—Ç—Ä–∏—Ç–æ–≤</p>
            </div>
        </div>

        <!-- Calendar View -->
        <div id="calendarView" class="hidden">
            <!-- Calendar Navigation -->
            <div class="flex items-center justify-between mb-4 bg-base-100 rounded-xl p-4">
                <button class="btn btn-ghost btn-sm" onclick="changeMonth(-1)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 class="text-xl font-bold" id="calendarTitle">–Ø–Ω–≤–∞—Ä—å 2025</h2>
                <div class="flex gap-2">
                    <button class="btn btn-ghost btn-sm" onclick="goToToday()" data-i18n="today">–°–µ–≥–æ–¥–Ω—è</button>
                    <button class="btn btn-ghost btn-sm" onclick="changeMonth(1)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Calendar Grid -->
            <div class="bg-base-100 rounded-xl overflow-hidden">
                <!-- Weekday Headers -->
                <div class="grid grid-cols-7 border-b border-base-200" id="weekdayHeaders">
                    <!-- Generated by JS -->
                </div>
                <!-- Calendar Days -->
                <div class="grid grid-cols-7" id="calendarGrid">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>

    </main>

    <div id="footer-placeholder"></div>

    <!-- Add/Edit Modal -->
    <dialog id="retreatModal" class="modal">
        <div class="modal-box max-w-lg relative">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="retreatModal.close()">‚úï</button>
            <h3 class="font-bold text-lg mb-4" id="modalTitle" data-i18n="add_retreat">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ç—Ä–∏—Ç</h3>
            <form id="retreatForm" class="space-y-4">
                <input type="hidden" name="id" />

                <!-- Name RU -->
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="retreats_name_ru">–ù–∞–∑–≤–∞–Ω–∏–µ (RU) *</span></label>
                    <input type="text" name="name_ru" class="input input-bordered w-full" required />
                </div>

                <!-- Name EN -->
                <div>
                    <label class="label">
                        <span class="label-text font-medium" data-i18n="retreats_name_en">Name (EN)</span>
                        <button type="button" class="translate-btn" onclick="autoTranslate('name_ru', 'name_en', 'ru', 'en', this)">üåê Auto</button>
                    </label>
                    <input type="text" name="name_en" class="input input-bordered w-full" />
                </div>

                <!-- Description RU -->
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="retreats_description_ru">–û–ø–∏—Å–∞–Ω–∏–µ (RU)</span></label>
                    <textarea name="description_ru" rows="2" class="textarea textarea-bordered w-full"></textarea>
                </div>

                <!-- Description EN -->
                <div>
                    <label class="label">
                        <span class="label-text font-medium" data-i18n="retreats_description_en">Description (EN)</span>
                        <button type="button" class="translate-btn" onclick="autoTranslate('description_ru', 'description_en', 'ru', 'en', this)">üåê Auto</button>
                    </label>
                    <textarea name="description_en" rows="2" class="textarea textarea-bordered w-full"></textarea>
                </div>

                <!-- Dates -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="retreat_start">–ù–∞—á–∞–ª–æ *</span></label>
                        <input type="date" name="start_date" class="input input-bordered w-full" required />
                    </div>
                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="retreat_end">–û–∫–æ–Ω—á–∞–Ω–∏–µ *</span></label>
                        <input type="date" name="end_date" class="input input-bordered w-full" required />
                    </div>
                </div>

                <!-- Participants -->
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="expected_participants">–û–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª-–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span></label>
                    <input type="number" name="expected_participants" min="0" class="input input-bordered w-full" value="0" />
                </div>

                <!-- Color -->
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="retreat_color">–¶–≤–µ—Ç</span></label>
                    <div class="flex gap-2 flex-wrap" id="colorPicker">
                        <!-- Generated by JS -->
                    </div>
                    <input type="hidden" name="color" value="#6366f1" />
                </div>

                <!-- Registration Settings -->
                <div class="divider text-sm opacity-50" data-i18n="retreats_registration">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>

                <!-- Registration Toggle -->
                <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-3">
                        <input type="checkbox" name="registration_open" class="toggle toggle-primary" />
                        <span class="label-text font-medium" data-i18n="retreats_registration_open">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞</span>
                    </label>
                </div>

                <!-- Registration Dates -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="retreats_registration_start">–ù–∞—á–∞–ª–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</span></label>
                        <input type="date" name="registration_start" class="input input-bordered w-full input-sm" />
                    </div>
                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="retreats_registration_end">–û–∫–æ–Ω—á–∞–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</span></label>
                        <input type="date" name="registration_end" class="input input-bordered w-full input-sm" />
                    </div>
                </div>

                <!-- Slug -->
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="retreats_slug">URL-slug (–ª–∞—Ç–∏–Ω–∏—Ü–µ–π)</span></label>
                    <div class="join w-full">
                        <span class="join-item btn btn-sm no-animation">/retreat.html?slug=</span>
                        <input type="text" name="slug" class="input input-bordered input-sm join-item flex-1" placeholder="vrindavan-2025" pattern="[a-z0-9\-]+" />
                    </div>
                    <p class="text-xs opacity-50 mt-1" data-i18n="retreats_slug_hint">–¢–æ–ª—å–∫–æ —Å—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –¥–µ—Ñ–∏—Å</p>
                </div>

                <!-- Public Link (only when editing) -->
                <div id="publicLinkSection" class="hidden">
                    <label class="label"><span class="label-text font-medium" data-i18n="retreats_public_link">–ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞</span></label>
                    <div class="join w-full">
                        <input type="text" id="publicLinkInput" class="input input-bordered input-sm join-item flex-1 bg-base-200" readonly />
                        <button type="button" class="btn btn-sm join-item btn-primary" onclick="copyPublicLink()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                            </svg>
                            <span data-i18n="retreats_copy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
                        </button>
                    </div>
                </div>

                <div class="divider text-sm opacity-50" data-i18n="retreats_media">–ú–µ–¥–∏–∞</div>

                <!-- Image -->
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="retreats_image">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</span></label>
                    <div class="flex items-start gap-4">
                        <!-- Preview -->
                        <div id="imagePreview" class="w-24 h-24 rounded-lg bg-base-200 flex items-center justify-center overflow-hidden border border-base-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <!-- Upload controls -->
                        <div class="flex-1">
                            <input type="file" name="image_file" id="imageInput" accept="image/*" class="file-input file-input-bordered file-input-sm w-full" />
                            <p class="text-xs opacity-50 mt-1" data-i18n="retreats_image_hint">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä: 800x400 px</p>
                            <button type="button" id="removeImageBtn" class="btn btn-ghost btn-xs text-error mt-1 hidden" onclick="removeImage()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                                <span data-i18n="retreats_remove_image">–£–¥–∞–ª–∏—Ç—å</span>
                            </button>
                        </div>
                    </div>
                    <input type="hidden" name="image_url" />
                </div>

                <!-- Actions -->
                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" onclick="closeModal()" data-i18n="cancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary" data-i18n="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>

            <!-- Delete button (only for editing) -->
            <div id="deleteSection" class="hidden border-t border-base-200 mt-4 pt-4">
                <button type="button" class="btn btn-ghost btn-error btn-sm gap-1" onclick="deleteRetreat()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    <span data-i18n="delete_retreat">–£–¥–∞–ª–∏—Ç—å —Ä–µ—Ç—Ä–∏—Ç</span>
                </button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <script src="../js/config.js"></script>
    <script src="../js/auth-check.js?v=3"></script>
    <script src="../js/permissions-ui.js?v=2"></script>
    <script src="../js/cache.js"></script>
    <script src="../js/utils.js?v=2"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/date-utils.js"></script>
    <script src="../js/layout.js?v=5"></script>
    <script>
        // ==================== STATE ====================
        let retreats = [];
        let holidays = [];
        let currentView = 'list';
        let currentFilter = 'upcoming';
        let currentMonth = new Date();
        let editingId = null;

        const t = key => Layout.t(key);

        // ==================== HOLIDAY HELPERS ====================
        function isEkadashi(dateStr) {
            return holidays.some(h => h.date === dateStr && h.type === 'ekadashi');
        }

        function getMajorFestival(dateStr) {
            return holidays.find(h => h.date === dateStr && h.type === 'major');
        }

        function getAcharyaEvents(dateStr) {
            return holidays.filter(h => h.date === dateStr && (h.type === 'appearance' || h.type === 'disappearance'));
        }
        const retreatForm = () => document.getElementById('retreatForm');

        // ==================== AUTO-TRANSLATE ====================
        async function autoTranslate(fromField, toField, fromLang, toLang, btn) {
            const fromEl = retreatForm()[fromField];
            const toEl = retreatForm()[toField];
            if (!fromEl || !toEl) return;

            const text = fromEl.value.trim();
            if (!text) {
                toEl.focus();
                return;
            }

            btn.classList.add('loading');
            btn.textContent = '...';

            try {
                const translated = await Layout.translate(text, fromLang, toLang);
                toEl.value = translated;
            } catch (e) {
                console.error('Translation error:', e);
            }

            btn.classList.remove('loading');
            btn.textContent = 'üåê Auto';
        }

        const COLORS = [
            '#6366f1', '#8b5cf6', '#ec4899', '#f43f5e',
            '#f59e0b', '#10b981', '#14b8a6', '#3b82f6',
            '#6b7280', '#84cc16'
        ];

        const MONTHS = ['month_jan', 'month_feb', 'month_mar', 'month_apr', 'month_may', 'month_jun',
                        'month_jul', 'month_aug', 'month_sep', 'month_oct', 'month_nov', 'month_dec'];
        const WEEKDAYS = ['weekday_mon', 'weekday_tue', 'weekday_wed', 'weekday_thu', 'weekday_fri', 'weekday_sat', 'weekday_sun'];

        // ==================== DATA ====================
        async function loadRetreats() {
            const { data, error } = await Layout.db
                .from('retreats')
                .select('*')
                .order('start_date', { ascending: true });

            if (error) {
                console.error('Error loading retreats:', error);
                return [];
            }
            return data || [];
        }

        async function loadHolidays() {
            const { data, error } = await Layout.db
                .from('holidays')
                .select('*');

            if (error) {
                console.error('Error loading holidays:', error);
                return [];
            }
            return data || [];
        }

        // ==================== LIST VIEW ====================
        function filterRetreats() {
            const today = DateUtils.toISO(new Date());

            return retreats.filter(r => {
                if (currentFilter === 'upcoming') return r.end_date >= today;
                if (currentFilter === 'past') return r.end_date < today;
                return true;
            });
        }

        function formatDateRange(start, end) {
            return DateUtils.formatRange(start, end);
        }

        function getDaysCount(start, end) {
            const s = DateUtils.parseDate(start);
            const e = DateUtils.parseDate(end);
            return Math.ceil((e - s) / (1000 * 60 * 60 * 24)) + 1;
        }

        function renderList() {
            const filtered = filterRetreats();
            const list = document.getElementById('retreatsList');
            const noRetreats = document.getElementById('noRetreats');

            if (filtered.length === 0) {
                list.innerHTML = '';
                noRetreats.classList.remove('hidden');
                return;
            }

            noRetreats.classList.add('hidden');
            const lang = Layout.currentLang;

            list.innerHTML = filtered.map(r => {
                const name = Layout.getName(r);
                const desc = r[`description_${lang}`] || r.description_ru || '';
                const days = getDaysCount(r.start_date, r.end_date);
                const today = DateUtils.toISO(new Date());
                const isActive = r.start_date <= today && r.end_date >= today;
                const isPast = r.end_date < today;

                // Image or color bar
                const imageBlock = r.image_url
                    ? `<div class="w-16 h-16 rounded-lg overflow-hidden flex-shrink-0">
                           <img src="${r.image_url}" class="w-full h-full object-cover" alt="${name}" />
                       </div>`
                    : `<div class="w-1 self-stretch rounded-full" style="background-color: ${r.color}"></div>`;

                return `
                    <div class="bg-base-100 rounded-xl p-4 shadow-sm flex gap-4 items-start cursor-pointer hover:shadow-md transition-shadow ${isPast ? 'opacity-60' : ''}"
                         onclick="openModal('${r.id}')">
                        ${imageBlock}
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-bold text-lg">${name}</h3>
                                ${isActive ? `<span class="badge badge-sm" style="background-color: ${r.color}; color: white;">–°–µ–π—á–∞—Å</span>` : ''}
                                ${r.registration_open ? `<span class="badge badge-sm badge-success">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>` : ''}
                            </div>
                            ${desc ? `<p class="text-sm opacity-60 mb-2 line-clamp-2">${desc}</p>` : ''}
                            <div class="flex flex-wrap gap-3 text-sm opacity-70">
                                <span class="flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    ${formatDateRange(r.start_date, r.end_date)}
                                </span>
                                <span class="flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    ${days} ${t('days')}
                                </span>
                                ${r.expected_participants ? `
                                    <span class="flex items-center gap-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        ${r.expected_participants} ${t('participants_short')}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <a href="../retreat.html?id=${r.id}" target="_blank" class="btn btn-ghost btn-sm gap-1" onclick="event.stopPropagation()" title="–û—Ç–∫—Ä—ã—Ç—å –ø—É–±–ª–∏—á–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                                <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞</span>
                            </a>
                            <a href="../vaishnavas/retreat-guests.html?id=${r.id}" class="btn btn-ghost btn-sm gap-1" onclick="event.stopPropagation()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                <span data-i18n="guests">–ì–æ—Å—Ç–∏</span>
                            </a>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== CALENDAR VIEW ====================
        function renderCalendar() {
            const lang = Layout.currentLang;
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            // Title
            document.getElementById('calendarTitle').textContent = `${t(MONTHS[month])} ${year}`;

            // Weekday headers
            const headers = document.getElementById('weekdayHeaders');
            headers.innerHTML = WEEKDAYS.map(w =>
                `<div class="p-2 text-center text-sm font-medium opacity-60">${t(w)}</div>`
            ).join('');

            // Calendar grid
            const grid = document.getElementById('calendarGrid');
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            // Start from Monday
            let startOffset = firstDay.getDay() - 1;
            if (startOffset < 0) startOffset = 6;

            const today = DateUtils.toISO(new Date());
            let html = '';

            // Previous month days
            const prevMonth = new Date(year, month, 0);
            for (let i = startOffset - 1; i >= 0; i--) {
                const day = prevMonth.getDate() - i;
                html += `<div class="calendar-day other-month border-b border-r border-base-200 p-1">
                    <div class="text-xs opacity-50">${day}</div>
                </div>`;
            }

            // Current month days
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateStr === today;
                const isEkadashiDay = isEkadashi(dateStr);
                const majorFestival = getMajorFestival(dateStr);
                const acharyaEvents = getAcharyaEvents(dateStr);

                // Find retreats for this day
                const dayRetreats = retreats.filter(r => r.start_date <= dateStr && r.end_date >= dateStr);

                // Background style for holidays
                let bgStyle = '';
                if (majorFestival) {
                    bgStyle = 'background-color: #FEF9C3;';
                } else if (isEkadashiDay) {
                    bgStyle = 'background-color: #FFFBEB;';
                }

                // Holiday indicator
                let holidayIndicator = '';
                if (majorFestival) {
                    holidayIndicator = '<span class="text-xs font-medium text-yellow-700 ml-1">‚òÖ</span>';
                } else if (isEkadashiDay) {
                    holidayIndicator = '<span class="text-xs font-medium text-amber-600 ml-1">—ç</span>';
                }

                // Holiday name lines
                let holidayLines = '';
                if (majorFestival) {
                    holidayLines += `<div class="text-xs font-medium text-yellow-700 truncate" title="${Layout.getName(majorFestival)}">${Layout.getName(majorFestival)}</div>`;
                }
                if (acharyaEvents.length > 0) {
                    holidayLines += acharyaEvents.map(e =>
                        `<div class="text-xs opacity-60 truncate" title="${Layout.getName(e)}">${Layout.getName(e)}</div>`
                    ).join('');
                }

                html += `<div class="calendar-day ${isToday ? 'today' : ''} border-b border-r border-base-200 p-1" style="${bgStyle}">
                    <div class="flex items-center">
                        <span class="text-xs font-medium ${isToday ? 'text-primary' : ''}">${day}</span>
                        ${holidayIndicator}
                    </div>
                    ${holidayLines}
                    <div class="mt-1 space-y-0.5">
                        ${dayRetreats.slice(0, 3).map(r => {
                            const name = Layout.getName(r);
                            return `<div class="retreat-bar" style="background-color: ${r.color}; color: white;"
                                         onclick="event.stopPropagation(); openModal('${r.id}')"
                                         title="${name}">${name}</div>`;
                        }).join('')}
                        ${dayRetreats.length > 3 ? `<div class="text-xs opacity-50">+${dayRetreats.length - 3}</div>` : ''}
                    </div>
                </div>`;
            }

            // Next month days
            const totalCells = startOffset + lastDay.getDate();
            const remaining = (7 - (totalCells % 7)) % 7;
            for (let i = 1; i <= remaining; i++) {
                html += `<div class="calendar-day other-month border-b border-r border-base-200 p-1">
                    <div class="text-xs opacity-50">${i}</div>
                </div>`;
            }

            grid.innerHTML = html;
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        function goToToday() {
            currentMonth = new Date();
            renderCalendar();
        }

        // ==================== MODAL ====================
        function renderColorPicker(selected = COLORS[0]) {
            const picker = document.getElementById('colorPicker');
            picker.innerHTML = COLORS.map(c =>
                `<div class="color-option ${c === selected ? 'selected' : ''}"
                      style="background-color: ${c}"
                      onclick="selectColor('${c}')"></div>`
            ).join('');
            document.querySelector('input[name="color"]').value = selected;
        }

        function selectColor(color) {
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
            document.querySelector(`.color-option[style*="${color}"]`).classList.add('selected');
            document.querySelector('input[name="color"]').value = color;
        }

        function openModal(id = null) {
            editingId = id;
            const modal = document.getElementById('retreatModal');
            const form = document.getElementById('retreatForm');
            const title = document.getElementById('modalTitle');
            const deleteSection = document.getElementById('deleteSection');
            const publicLinkSection = document.getElementById('publicLinkSection');

            form.reset();
            resetImagePreview();

            if (id) {
                const retreat = retreats.find(r => r.id === id);
                if (retreat) {
                    title.textContent = t('edit_retreat');
                    form.name_ru.value = retreat.name_ru || '';
                    form.name_en.value = retreat.name_en || '';
                    form.description_ru.value = retreat.description_ru || '';
                    form.description_en.value = retreat.description_en || '';
                    form.start_date.value = retreat.start_date;
                    form.end_date.value = retreat.end_date;
                    form.expected_participants.value = retreat.expected_participants || 0;
                    renderColorPicker(retreat.color || COLORS[0]);
                    deleteSection.classList.remove('hidden');

                    // Registration fields
                    form.registration_open.checked = retreat.registration_open || false;
                    form.registration_start.value = retreat.registration_start || '';
                    form.registration_end.value = retreat.registration_end || '';
                    form.slug.value = retreat.slug || '';

                    // Show public link
                    publicLinkSection.classList.remove('hidden');
                    const publicUrl = retreat.slug
                        ? `https://in.rupaseva.com/retreat.html?slug=${retreat.slug}`
                        : `https://in.rupaseva.com/retreat.html?id=${retreat.id}`;
                    document.getElementById('publicLinkInput').value = publicUrl;

                    // Show existing image
                    if (retreat.image_url) {
                        showImagePreview(retreat.image_url);
                        form.image_url.value = retreat.image_url;
                    }
                }
            } else {
                title.textContent = t('add_retreat');
                // Random default color
                renderColorPicker(COLORS[Math.floor(Math.random() * COLORS.length)]);
                deleteSection.classList.add('hidden');
                publicLinkSection.classList.add('hidden');
            }

            Layout.setupAutoTranslate('#retreatForm', ['name', 'description']);
            modal.showModal();
        }

        function copyPublicLink() {
            const input = document.getElementById('publicLinkInput');
            navigator.clipboard.writeText(input.value).then(() => {
                Layout.showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞', 'success');
            });
        }

        // ==================== IMAGE HANDLING ====================
        function resetImagePreview() {
            const preview = document.getElementById('imagePreview');
            const removeBtn = document.getElementById('removeImageBtn');
            const input = document.getElementById('imageInput');

            preview.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            `;
            removeBtn.classList.add('hidden');
            input.value = '';
            document.querySelector('input[name="image_url"]').value = '';
        }

        function showImagePreview(url) {
            const preview = document.getElementById('imagePreview');
            const removeBtn = document.getElementById('removeImageBtn');

            preview.innerHTML = `<img src="${url}" class="w-full h-full object-cover" alt="Preview" />`;
            removeBtn.classList.remove('hidden');
        }

        function removeImage() {
            resetImagePreview();
        }

        // Handle file selection
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('imageInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        showImagePreview(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        async function uploadRetreatImage(file, retreatId) {
            const ext = file.name.split('.').pop().toLowerCase();
            const fileName = `${retreatId}.${ext}`;
            const filePath = `retreats/${fileName}`;

            // Upload to Supabase Storage
            const { error: uploadError } = await Layout.db.storage
                .from('retreat-images')
                .upload(filePath, file, {
                    cacheControl: '3600',
                    upsert: true
                });

            if (uploadError) {
                console.error('Upload error:', uploadError);
                throw uploadError;
            }

            // Get public URL with cache buster
            const { data: { publicUrl } } = Layout.db.storage
                .from('retreat-images')
                .getPublicUrl(filePath);

            return `${publicUrl}?t=${Date.now()}`;
        }

        function closeModal() {
            document.getElementById('retreatModal').close();
            editingId = null;
        }

        async function saveRetreat(e) {
            e.preventDefault();
            const form = document.getElementById('retreatForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            const imageInput = document.getElementById('imageInput');

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span>';

            const data = {
                name_ru: form.name_ru.value.trim(),
                name_en: form.name_en.value.trim() || null,
                description_ru: form.description_ru.value.trim() || null,
                description_en: form.description_en.value.trim() || null,
                start_date: form.start_date.value,
                end_date: form.end_date.value,
                expected_participants: parseInt(form.expected_participants.value) || 0,
                color: form.color.value,
                image_url: form.image_url.value || null,
                registration_open: form.registration_open.checked,
                registration_start: form.registration_start.value || null,
                registration_end: form.registration_end.value || null,
                slug: form.slug.value.trim().toLowerCase() || null
            };

            try {
                let retreatId = editingId;

                // If new retreat, create first to get ID
                if (!editingId) {
                    const { data: newRetreat, error } = await Layout.db
                        .from('retreats')
                        .insert(data)
                        .select('id')
                        .single();
                    if (error) throw error;
                    retreatId = newRetreat.id;
                }

                // Upload new image if selected
                if (imageInput.files.length > 0) {
                    const imageUrl = await uploadRetreatImage(imageInput.files[0], retreatId);
                    data.image_url = imageUrl;
                }

                // Update retreat with image URL (if new image or editing)
                if (editingId || imageInput.files.length > 0) {
                    const { error } = await Layout.db
                        .from('retreats')
                        .update(data)
                        .eq('id', retreatId);
                    if (error) throw error;
                }

                Cache.invalidate('retreats'); Cache.invalidate('all_retreats');
                closeModal();
                retreats = await loadRetreats();
                render();
            } catch (err) {
                console.error('Error saving retreat:', err);
                Layout.showNotification(t('error_saving') + ': ' + err.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = t('save');
            }
        }

        async function deleteRetreat() {
            if (!editingId) return;
            if (!confirm(t('delete_retreat_confirm'))) return;

            try {
                const { error } = await Layout.db.from('retreats').delete().eq('id', editingId);
                if (error) throw error;

                Cache.invalidate('retreats'); Cache.invalidate('all_retreats');
                closeModal();
                retreats = await loadRetreats();
                render();
            } catch (err) {
                console.error('Error deleting retreat:', err);
                Layout.showNotification(t('error_deleting') + ': ' + err.message, 'error');
            }
        }

        // ==================== VIEW SWITCHING ====================
        function setView(view) {
            currentView = view;

            document.querySelectorAll('.view-btn').forEach(btn => {
                const isActive = btn.dataset.view === view;
                btn.classList.toggle('bg-white', isActive);
                btn.classList.toggle('btn-ghost', !isActive);
            });

            document.getElementById('listView').classList.toggle('hidden', view !== 'list');
            document.getElementById('listFilters').classList.toggle('hidden', view !== 'list');
            document.getElementById('calendarView').classList.toggle('hidden', view !== 'calendar');

            if (view === 'calendar') {
                renderCalendar();
            }
        }

        function renderFilters() {
            const container = document.getElementById('listFilters');
            const today = DateUtils.toISO(new Date());

            const counts = {
                upcoming: retreats.filter(r => r.end_date >= today).length,
                past: retreats.filter(r => r.end_date < today).length,
                all: retreats.length
            };

            const filters = [
                { key: 'upcoming', label: t('upcoming_retreats') },
                { key: 'past', label: t('past_retreats') },
                { key: 'all', label: t('all_retreats') }
            ];

            container.innerHTML = filters.map(f => {
                const isActive = currentFilter === f.key;
                return `<button class="btn btn-sm filter-btn ${isActive ? 'active btn-neutral' : 'btn-ghost'}" data-filter="${f.key}">${f.label}<sup class="ml-1 opacity-60">${counts[f.key]}</sup></button>`;
            }).join('');

            container.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => setFilter(btn.dataset.filter));
            });
        }

        function setFilter(filter) {
            currentFilter = filter;
            renderFilters();
            renderList();
        }

        // ==================== RENDER ====================
        function render() {
            renderFilters();
            if (currentView === 'list') {
                renderList();
            } else {
                renderCalendar();
            }
        }

        function updateUI() {
            Layout.updateAllTranslations();
            render();
        }

        window.onLanguageChange = () => updateUI();

        // ==================== INIT ====================
        // –ñ–¥—ë–º —Å–æ–±—ã—Ç–∏–µ authReady –æ—Ç auth-check.js
        function waitForAuth(maxWait = 3000) {
            return new Promise(resolve => {
                if (window.currentUser) {
                    resolve();
                    return;
                }
                const handler = () => resolve();
                window.addEventListener('authReady', handler, { once: true });
                setTimeout(() => {
                    window.removeEventListener('authReady', handler);
                    resolve();
                }, maxWait);
            });
        }

        async function init() {
            await Layout.init({ module: 'admin', menuId: 'ashram', itemId: 'retreats' });
            await waitForAuth();

            // –ú–æ–¥—É–ª—å admin —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            if (!window.currentUser?.is_superuser) {
                window.location.href = '../index.html';
                return;
            }

            Layout.showLoader();

            // Load retreats and holidays in parallel
            const [retreatsData, holidaysData] = await Promise.all([
                loadRetreats(),
                loadHolidays()
            ]);
            retreats = retreatsData;
            holidays = holidaysData;

            // Event listeners
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => setView(btn.dataset.view));
            });

            document.getElementById('retreatForm').addEventListener('submit', saveRetreat);

            updateUI();
            Layout.hideLoader();
        }

        init();
    </script>
</body>
</html>
