<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script src="../js/color-init.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–µ—Å—Ç–∏–≤–∞–ª–∏ ‚Äî –®–†–°–ö</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        .type-major { background-color: #FEF9C3; border-left: 4px solid #EAB308; }
        .type-ekadashi { background-color: #FFFBEB; border-left: 4px solid #F59E0B; }
        .type-appearance { border-left: 4px solid #10B981; }
        .type-disappearance { border-left: 4px solid #6B7280; }
        .translate-btn {
            padding: 2px 8px;
            font-size: 11px;
            border-radius: 4px;
            background: #e5e7eb;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.15s;
        }
        .translate-btn:hover {
            background: var(--current-color);
            color: white;
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 flex-1">

        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold" data-i18n="holidays_title">–ü—Ä–∞–∑–¥–Ω–∏–∫–∏</h1>
                <p class="text-sm opacity-60" id="holidaysCount">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <button class="btn btn-primary gap-2" data-permission="edit_festivals" onclick="openModal()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <span data-i18n="add_holiday">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–∑–¥–Ω–∏–∫</span>
            </button>
        </div>

        <!-- Filters -->
        <div class="flex flex-col sm:flex-row gap-4 mb-4">
            <div class="flex-1 max-w-md relative">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." class="input input-bordered w-full pr-10" />
                <button type="button" id="clearSearch" class="absolute right-3 top-1/2 -translate-y-1/2 text-base-content/40 hover:text-base-content hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <select id="yearFilter" class="select select-bordered w-auto">
                <!-- Generated by JS -->
            </select>
        </div>

        <!-- Type Tabs -->
        <div class="flex flex-wrap gap-2 mb-6" id="typeFilters">
            <!-- Generated by JS -->
        </div>

        <!-- Holidays Table -->
        <div class="bg-base-100 rounded-lg shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr class="bg-base-200">
                            <th class="w-32" data-i18n="date">–î–∞—Ç–∞</th>
                            <th data-i18n="holiday_name">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th class="w-40" data-i18n="type">–¢–∏–ø</th>
                            <th class="w-20"></th>
                        </tr>
                    </thead>
                    <tbody id="holidaysTableBody">
                        <tr><td colspan="4" class="text-center py-8 opacity-50">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <div id="footer-placeholder"></div>

    <!-- Add/Edit Modal -->
    <dialog id="holidayModal" class="modal">
        <div class="modal-box max-w-lg relative">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeModal()">‚úï</button>
            <h3 class="font-bold text-lg mb-4" id="modalTitle" data-i18n="add_holiday">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–∑–¥–Ω–∏–∫</h3>

            <form id="holidayForm" class="space-y-4">
                <input type="hidden" name="id" />

                <!-- Type -->
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="type">–¢–∏–ø *</span></label>
                    <select name="type" class="select select-bordered w-full" required>
                        <option value="major">–§–µ—Å—Ç–∏–≤–∞–ª—å</option>
                        <option value="ekadashi">–≠–∫–∞–¥–∞—à–∏</option>
                        <option value="appearance">–Ø–≤–ª–µ–Ω–∏–µ –∞—á–∞—Ä—å–∏</option>
                        <option value="disappearance">–£—Ö–æ–¥ –∞—á–∞—Ä—å–∏</option>
                    </select>
                </div>

                <!-- Date -->
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="date">–î–∞—Ç–∞ *</span></label>
                    <input type="date" name="date" class="input input-bordered w-full" required />
                </div>

                <!-- Name RU -->
                <div>
                    <label class="label"><span class="label-text font-medium">–ù–∞–∑–≤–∞–Ω–∏–µ (RU) *</span></label>
                    <input type="text" name="name_ru" class="input input-bordered w-full" required />
                </div>

                <!-- Name EN -->
                <div>
                    <label class="label">
                        <span class="label-text font-medium">Name (EN)</span>
                        <button type="button" class="translate-btn" onclick="autoTranslate('name_ru', 'name_en', 'ru', 'en', this)">üåê Auto</button>
                    </label>
                    <input type="text" name="name_en" class="input input-bordered w-full" />
                </div>

                <!-- Name HI -->
                <div>
                    <label class="label">
                        <span class="label-text font-medium">‡§®‡§æ‡§Æ (HI)</span>
                        <button type="button" class="translate-btn" onclick="autoTranslate('name_ru', 'name_hi', 'ru', 'hi', this)">üåê Auto</button>
                    </label>
                    <input type="text" name="name_hi" class="input input-bordered w-full" />
                </div>

                <!-- Actions -->
                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" onclick="closeModal()" data-i18n="cancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary" data-i18n="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>

            <!-- Delete button -->
            <div id="deleteSection" class="hidden border-t border-base-200 mt-4 pt-4">
                <button type="button" class="btn btn-ghost btn-error btn-sm gap-1" onclick="deleteHoliday()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    <span data-i18n="delete">–£–¥–∞–ª–∏—Ç—å</span>
                </button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <script src="../js/config.js"></script>
    <script src="../js/auth-check.js?v=3"></script>
    <script src="../js/cache.js"></script>
    <script src="../js/utils.js?v=2"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/date-utils.js"></script>
    <script src="../js/layout.js?v=5"></script>
    <script>
        // ==================== STATE ====================
        let holidays = [];
        let currentType = 'all';
        let currentYear = new Date().getFullYear();
        let searchQuery = '';
        let editingId = null;

        const t = key => Layout.t(key);

        const HOLIDAY_TYPES = {
            major: { ru: '–§–µ—Å—Ç–∏–≤–∞–ª—å', en: 'Festival', hi: '‡§§‡•ç‡§Ø‡•ã‡§π‡§æ‡§∞', color: '#EAB308' },
            ekadashi: { ru: '–≠–∫–∞–¥–∞—à–∏', en: 'Ekadashi', hi: '‡§è‡§ï‡§æ‡§¶‡§∂‡•Ä', color: '#F59E0B' },
            appearance: { ru: '–Ø–≤–ª–µ–Ω–∏–µ', en: 'Appearance', hi: '‡§Ü‡§µ‡§ø‡§∞‡•ç‡§≠‡§æ‡§µ', color: '#10B981' },
            disappearance: { ru: '–£—Ö–æ–¥', en: 'Disappearance', hi: '‡§§‡§ø‡§∞‡•ã‡§≠‡§æ‡§µ', color: '#6B7280' }
        };

        const ITEM_FORMS = {
            ru: ['–ø—Ä–∞–∑–¥–Ω–∏–∫', '–ø—Ä–∞–∑–¥–Ω–∏–∫–∞', '–ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤'],
            en: ['holiday', 'holidays'],
            hi: '‡§§‡•ç‡§Ø‡•ã‡§π‡§æ‡§∞'
        };

        // ==================== DATA LOADING ====================
        async function loadHolidays() {
            const { data, error } = await Layout.db
                .from('holidays')
                .select('*')
                .order('date', { ascending: true });

            if (error) {
                console.error('Error loading holidays:', error);
                return;
            }

            holidays = data || [];
            buildYearFilter();
            renderTypeFilters();
            renderHolidays();
        }

        // ==================== AUTO-TRANSLATE ====================
        async function autoTranslate(fromField, toField, fromLang, toLang, btn) {
            const form = document.getElementById('holidayForm');
            const fromEl = form[fromField];
            const toEl = form[toField];
            if (!fromEl || !toEl) return;

            const text = fromEl.value.trim();
            if (!text) {
                toEl.focus();
                return;
            }

            btn.classList.add('opacity-50');
            btn.textContent = '...';

            try {
                const translated = await Layout.translate(text, fromLang, toLang);
                toEl.value = translated;
            } catch (e) {
                console.error('Translation error:', e);
            }

            btn.classList.remove('opacity-50');
            btn.textContent = 'üåê Auto';
        }

        // ==================== RENDERING ====================
        function buildYearFilter() {
            const select = Layout.$('#yearFilter');
            const years = [...new Set(holidays.map(h => DateUtils.parseDate(h.date).getFullYear()))].sort((a, b) => b - a);

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –≥–æ–¥ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if (!years.includes(currentYear)) {
                years.unshift(currentYear);
                years.sort((a, b) => b - a);
            }

            select.innerHTML = years.map(y =>
                `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`
            ).join('');
        }

        function renderTypeFilters() {
            const container = Layout.$('#typeFilters');
            const counts = { all: 0 };

            // –°—á–∏—Ç–∞–µ–º –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ –ø–æ —Ç–∏–ø–∞–º –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –≥–æ–¥–∞
            holidays.forEach(h => {
                const year = DateUtils.parseDate(h.date).getFullYear();
                if (year === currentYear) {
                    counts.all++;
                    counts[h.type] = (counts[h.type] || 0) + 1;
                }
            });

            const lang = Layout.currentLang;
            let html = `<button class="btn btn-sm ${currentType === 'all' ? '' : 'btn-ghost'}" data-type="all" style="${currentType === 'all' ? 'background-color: var(--current-color); border-color: var(--current-color); color: white;' : ''}">–í—Å–µ<sup class="ml-1 opacity-60">${counts.all || 0}</sup></button>`;

            Object.entries(HOLIDAY_TYPES).forEach(([type, info]) => {
                const isActive = currentType === type;
                const label = info[lang] || info.ru;
                html += `<button class="btn btn-sm ${isActive ? '' : 'btn-ghost'}" data-type="${type}" style="${isActive ? `background-color: ${info.color}; border-color: ${info.color}; color: white;` : ''}">${label}<sup class="ml-1 opacity-60">${counts[type] || 0}</sup></button>`;
            });

            container.innerHTML = html;
            container.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentType = btn.dataset.type;
                    renderTypeFilters();
                    renderHolidays();
                });
            });
        }

        function renderHolidays() {
            const tbody = Layout.$('#holidaysTableBody');
            const lang = Layout.currentLang;

            let filtered = holidays.filter(h => {
                const year = DateUtils.parseDate(h.date).getFullYear();
                if (year !== currentYear) return false;
                if (currentType !== 'all' && h.type !== currentType) return false;
                if (searchQuery) {
                    const q = searchQuery.toLowerCase();
                    const matches = h.name_ru?.toLowerCase().includes(q) ||
                                    h.name_en?.toLowerCase().includes(q) ||
                                    h.name_hi?.includes(searchQuery);
                    if (!matches) return false;
                }
                return true;
            });

            Layout.$('#holidaysCount').textContent = Layout.pluralize(filtered.length, ITEM_FORMS);

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 opacity-50">–ù–µ—Ç –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤</td></tr>';
                return;
            }

            const canEdit = window.hasPermission && window.hasPermission('edit_festivals');
            tbody.innerHTML = filtered.map(h => {
                const typeInfo = HOLIDAY_TYPES[h.type] || HOLIDAY_TYPES.major;
                const typeLabel = typeInfo[lang] || typeInfo.ru;
                const date = DateUtils.parseDate(h.date);
                const dateStr = date.toLocaleDateString(lang === 'ru' ? 'ru-RU' : lang === 'hi' ? 'hi-IN' : 'en-US', {
                    day: 'numeric',
                    month: 'short',
                    weekday: 'short'
                });

                return `
                    <tr class="type-${h.type}">
                        <td class="font-medium">${dateStr}</td>
                        <td>
                            <div class="font-medium">${Layout.getName(h)}</div>
                            ${h.name_en && lang !== 'en' ? `<div class="text-xs opacity-50">${h.name_en}</div>` : ''}
                        </td>
                        <td>
                            <span class="badge badge-sm" style="background-color: ${typeInfo.color}20; color: ${typeInfo.color}; border-color: ${typeInfo.color}40;">
                                ${typeLabel}
                            </span>
                        </td>
                        <td>
                            ${canEdit ? `<div class="flex gap-1">
                                <button class="btn btn-ghost btn-sm btn-square" onclick="editHoliday('${h.id}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                            </div>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ==================== MODAL ====================
        function openModal() {
            editingId = null;
            const form = document.getElementById('holidayForm');
            form.reset();

            Layout.$('#modalTitle').textContent = t('add_holiday') || '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–∑–¥–Ω–∏–∫';
            Layout.$('#deleteSection').classList.add('hidden');

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - —Å–µ–≥–æ–¥–Ω—è
            form.date.value = DateUtils.toISO(new Date());

            Layout.setupAutoTranslate('#holidayForm', ['name']);
            holidayModal.showModal();
        }

        function editHoliday(id) {
            const holiday = holidays.find(h => h.id === id);
            if (!holiday) return;

            editingId = id;
            const form = document.getElementById('holidayForm');

            Layout.$('#modalTitle').textContent = t('edit_holiday') || '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–∑–¥–Ω–∏–∫';
            Layout.$('#deleteSection').classList.remove('hidden');

            form.type.value = holiday.type;
            form.date.value = holiday.date;
            form.name_ru.value = holiday.name_ru || '';
            form.name_en.value = holiday.name_en || '';
            form.name_hi.value = holiday.name_hi || '';

            Layout.setupAutoTranslate('#holidayForm', ['name']);
            holidayModal.showModal();
        }

        function closeModal() {
            holidayModal.close();
            editingId = null;
        }

        async function saveHoliday(e) {
            e.preventDefault();
            const form = document.getElementById('holidayForm');

            const data = {
                type: form.type.value,
                date: form.date.value,
                name_ru: form.name_ru.value.trim(),
                name_en: form.name_en.value.trim() || null,
                name_hi: form.name_hi.value.trim() || null
            };

            if (!data.name_ru) {
                Layout.showNotification(t('enter_festival_name'), 'warning');
                return;
            }

            let error;
            if (editingId) {
                ({ error } = await Layout.db.from('holidays').update(data).eq('id', editingId));
            } else {
                ({ error } = await Layout.db.from('holidays').insert(data));
            }

            if (error) {
                console.error('Error saving holiday:', error);
                Layout.showNotification(t('error_saving') + ': ' + error.message, 'error');
                return;
            }

            closeModal();
            await loadHolidays();
        }

        async function deleteHoliday() {
            if (!editingId) return;
            if (!confirm(t('confirm_delete_festival'))) return;

            const { error } = await Layout.db.from('holidays').delete().eq('id', editingId);
            if (error) {
                console.error('Error deleting holiday:', error);
                Layout.showNotification(t('error_deleting') + ': ' + error.message, 'error');
                return;
            }

            closeModal();
            await loadHolidays();
        }

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = Layout.$('#searchInput');
            const clearBtn = Layout.$('#clearSearch');
            const yearFilter = Layout.$('#yearFilter');

            searchInput?.addEventListener('input', e => {
                searchQuery = e.target.value;
                clearBtn?.classList.toggle('hidden', !e.target.value);
                renderHolidays();
            });

            clearBtn?.addEventListener('click', () => {
                searchInput.value = '';
                searchQuery = '';
                clearBtn.classList.add('hidden');
                renderHolidays();
                searchInput.focus();
            });

            yearFilter?.addEventListener('change', e => {
                currentYear = parseInt(e.target.value);
                renderTypeFilters();
                renderHolidays();
            });

            document.getElementById('holidayForm').addEventListener('submit', saveHoliday);
        });

        window.onLanguageChange = function(lang) {
            Layout.updateAllTranslations();
            renderTypeFilters();
            renderHolidays();
        };

        // ==================== INIT ====================
        // –ñ–¥—ë–º —Å–æ–±—ã—Ç–∏–µ authReady –æ—Ç auth-check.js
        function waitForAuth(maxWait = 3000) {
            return new Promise(resolve => {
                if (window.currentUser) {
                    resolve();
                    return;
                }
                const handler = () => resolve();
                window.addEventListener('authReady', handler, { once: true });
                setTimeout(() => {
                    window.removeEventListener('authReady', handler);
                    resolve();
                }, maxWait);
            });
        }

        async function init() {
            await Layout.init({ module: 'admin', menuId: 'ashram', itemId: 'festivals' });
            await waitForAuth();

            // –ú–æ–¥—É–ª—å admin —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            if (!window.currentUser?.is_superuser) {
                window.location.href = '../index.html';
                return;
            }

            await loadHolidays();
        }

        init();
    </script>
</body>
</html>
