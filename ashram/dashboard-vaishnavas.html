<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <script src="../js/color-init.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="ashram_dashboard_vaishnavas_title">Вайшнавы — Дашборд — ШРСК</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        .bento-card {
            border-radius: 20px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        .bento-card:hover {
            transform: translateY(-2px);
        }
        .bento-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            opacity: 0.7;
            margin-bottom: 0.5rem;
        }
        .bento-value {
            font-size: 1.25rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            line-height: 1.1;
            white-space: nowrap;
        }
        .metric-card-compact {
            padding: 1rem 1.25rem;
        }
        .bento-subtitle {
            font-size: 0.875rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }

        .collapsible-card {
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .collapsible-header {
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            user-select: none;
        }
        .collapsible-header:hover {
            opacity: 0.85;
        }
        .collapsible-header .chevron {
            transition: transform 0.3s ease;
        }
        .collapsible-header.collapsed .chevron {
            transform: rotate(-90deg);
        }
        .collapsible-body {
            padding: 0 1.5rem 1.5rem;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .collapsible-body.collapsed {
            max-height: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            opacity: 0;
        }

        .section-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .section-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .resident-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        .resident-table th {
            text-align: left;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.5rem 0.75rem;
            opacity: 0.6;
            font-weight: 600;
            white-space: nowrap;
        }
        .resident-table th:hover {
            opacity: 1;
        }
        .resident-table td {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            border-top: 1px solid rgba(0,0,0,0.06);
            vertical-align: middle;
        }
        .resident-table tr:first-child td {
            border-top: none;
        }
        .resident-table a {
            color: inherit;
            font-weight: 500;
            text-decoration: none;
        }
        .resident-table a:hover {
            text-decoration: underline;
        }

        .meal-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 10px;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .meal-badge.yes {
            background: white;
            color: #065F46;
            border: 1px solid #6ee7b7;
        }
        .meal-badge.no {
            background: white;
            color: #9CA3AF;
            border: 1px solid #E5E7EB;
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

<div id="header-placeholder"></div>

<main class="container mx-auto px-4 py-6 flex-1">
    <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
        <div>
            <h1 class="text-2xl font-bold" data-i18n="nav_dashboard_vaishnavas">Вайшнавы</h1>
            <p class="text-base-content/50 text-sm mt-1" data-i18n="dashboard_present_now">Присутствуют</p>
        </div>
        <div class="relative w-full sm:w-64">
            <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 opacity-40" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
            <input type="text" id="searchInput" class="input input-bordered input-sm w-full pl-9 pr-8"
                   placeholder="Поиск по имени..." data-i18n-placeholder="search_placeholder"
                   oninput="applySearch()" />
            <button type="button" id="searchClear" class="absolute right-2 top-1/2 -translate-y-1/2 opacity-40 hover:opacity-100 hidden" onclick="clearSearch()">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Bento Grid -->
    <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 mb-4">
        <div class="bento-card metric-card-compact" style="background: white;">
            <div>
                <div class="bento-label" style="color: #888;" data-i18n="dashboard_present_now">Присутствуют</div>
                <div class="bento-value" style="color: #333;" id="metricTotal">-</div>
                <div class="bento-subtitle" style="color: #888;" id="metricTotalSub"></div>
            </div>
        </div>
        <div class="bento-card metric-card-compact" style="background: #10b981;">
            <div>
                <div class="bento-label text-white/70" data-i18n="ashram_category_team">Команда</div>
                <div class="bento-value text-white" id="metricTeam">-</div>
                <div class="bento-subtitle text-white/70" id="metricTeamSub"></div>
            </div>
        </div>
        <div class="bento-card metric-card-compact" style="background: #f59e0b;">
            <div>
                <div class="bento-label text-white/70" data-i18n="ashram_category_volunteers">Волонтёры</div>
                <div class="bento-value text-white" id="metricVolunteer">-</div>
                <div class="bento-subtitle text-white/70" id="metricVolunteerSub"></div>
            </div>
        </div>
        <div class="bento-card metric-card-compact" style="background: #ef4444;">
            <div>
                <div class="bento-label text-white/70" data-i18n="ashram_category_vip">ВИП</div>
                <div class="bento-value text-white" id="metricVip">-</div>
                <div class="bento-subtitle text-white/70" id="metricVipSub"></div>
            </div>
        </div>
        <div class="bento-card metric-card-compact" style="background: #3b82f6;">
            <div>
                <div class="bento-label text-white/70" data-i18n="ashram_category_guests">Гости</div>
                <div class="bento-value text-white" id="metricGuest">-</div>
                <div class="bento-subtitle text-white/70" id="metricGuestSub"></div>
            </div>
        </div>
    </div>

    <!-- Kitchen totals (unhoused guests + groups) -->
    <div id="kitchenTotals" class="hidden text-sm text-base-content/60 mb-4 px-1"></div>

    <!-- Category sections -->
    <div class="flex flex-col gap-4" id="categorySections">
        <div class="text-center py-8"><span class="loading loading-spinner loading-lg"></span></div>
    </div>
</main>

<div id="footer-placeholder"></div>

<script src="../js/config.js"></script>
<script src="../js/auth-check.js"></script>
<script src="../js/cache.js"></script>
<script src="../js/utils.js?v=2"></script>
<script src="../js/layout.js"></script>
<script src="../js/date-utils.js"></script>
<script src="../js/eating-utils.js"></script>

<script>
const t = key => Layout.t(key);
const e = str => Layout.escapeHtml(str);

// ==================== COLLAPSE ====================
const COLLAPSED_KEY = 'vaishnavas_dashboard_collapsed';

function getCollapsedSections() {
    try {
        return JSON.parse(localStorage.getItem(COLLAPSED_KEY)) || {};
    } catch {
        return {};
    }
}

function saveCollapsedSections(collapsed) {
    try {
        localStorage.setItem(COLLAPSED_KEY, JSON.stringify(collapsed));
    } catch { /* ignore */ }
}

function toggleSection(sectionId) {
    const collapsed = getCollapsedSections();
    collapsed[sectionId] = !collapsed[sectionId];
    saveCollapsedSections(collapsed);
    applyCollapsedState(sectionId, collapsed[sectionId]);
}

function applyCollapsedState(sectionId, isCollapsed) {
    const header = document.querySelector(`.collapsible-header[data-section="${sectionId}"]`);
    const body = document.querySelector(`.collapsible-body[data-section="${sectionId}"]`);
    if (header && body) {
        if (isCollapsed) {
            header.classList.add('collapsed');
            body.classList.add('collapsed');
        } else {
            header.classList.remove('collapsed');
            body.classList.remove('collapsed');
        }
    }
}

function restoreCollapsedStates() {
    const collapsed = getCollapsedSections();
    Object.entries(collapsed).forEach(([id, val]) => {
        if (val) applyCollapsedState(id, true);
    });
}

// ==================== CATEGORY CONFIG ====================
const CATEGORY_CONFIG = {
    team:      { bg: '#D1FAE5', icon: '#10b981', text: '#065F46' },
    volunteer: { bg: '#FEF3C7', icon: '#f59e0b', text: '#92400E' },
    vip:       { bg: '#FEE2E2', icon: '#ef4444', text: '#991B1B' },
    guest:     { bg: '#DBEAFE', icon: '#3b82f6', text: '#1E40AF' }
};

const CATEGORY_ORDER = ['team', 'volunteer', 'vip', 'guest'];

const CATEGORY_ICONS = {
    team: '<path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />',
    volunteer: '<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />',
    vip: '<path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />',
    guest: '<path stroke-linecap="round" stroke-linejoin="round" d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M2.25 21h1.5m18 0h-18M2.25 9l4.5-1.636M18.75 3l-1.5.545m0 6.205l3 1m1.5.5l-1.5-.5M6.75 7.364V3h-3v18m3-13.636l10.5-3.819" />'
};

// ==================== DATA ====================
function getDisplayName(resident) {
    const v = resident.vaishnavas;
    if (v) {
        return v.spiritual_name || [v.first_name, v.last_name].filter(Boolean).join(' ') || '—';
    }
    return resident.guest_name || '—';
}

function getProfileLink(resident) {
    const v = resident.vaishnavas;
    if (v) {
        return `../vaishnavas/person.html?id=${encodeURIComponent(v.id)}`;
    }
    return null;
}

function getRoomText(resident) {
    const room = resident.rooms;
    if (!room) return '—';
    const building = room.buildings;
    const bName = building ? Layout.getName(building) : '';
    return bName ? `${e(bName)} → ${e(room.number)}` : e(room.number);
}

function formatShortDate(str) {
    if (!str) return '?';
    const d = DateUtils.parseDate(str);
    const dd = String(d.getDate()).padStart(2, '0');
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    return `${dd}.${mm}`;
}

function formatDateRange(resident) {
    return `${formatShortDate(resident.check_in)} — ${formatShortDate(resident.check_out)}`;
}

// Хранилище данных и состояния сортировки по категориям
const groupedData = {};
const sortState = {};

const SORT_COLUMNS = [
    { key: 'name',  label: () => t('col_name')  || 'Имя' },
    { key: 'dates', label: () => t('col_dates') || 'Даты' },
    { key: 'room',  label: () => t('col_room')  || 'Комната' },
    { key: 'meals', label: () => t('col_meals') || 'Питание' }
];

function getSortValue(r, key) {
    switch (key) {
        case 'name':  return getDisplayName(r).toLowerCase();
        case 'dates': return r.check_in || '';
        case 'room':  return getRoomText(r).toLowerCase();
        case 'meals': return r.has_meals ? 0 : 1;
    }
}

function sortResidents(slug, colKey) {
    const prev = sortState[slug];
    if (prev && prev.key === colKey) {
        prev.asc = !prev.asc;
    } else {
        sortState[slug] = { key: colKey, asc: true };
    }
    rerenderTable(slug);
}

function rerenderTable(slug) {
    const container = document.querySelector(`.collapsible-body[data-section="${slug}"] .table-wrapper`);
    if (!container) return;
    const residents = [...(groupedData[slug] || [])];
    const st = sortState[slug];
    if (st) {
        residents.sort((a, b) => {
            const va = getSortValue(a, st.key);
            const vb = getSortValue(b, st.key);
            const cmp = va < vb ? -1 : va > vb ? 1 : 0;
            return st.asc ? cmp : -cmp;
        });
    }
    container.innerHTML = buildTable(residents, slug);
}

function buildTable(residents, slug) {
    if (!residents.length) {
        return `<div class="text-center py-4 opacity-50">${t('no_data') || 'Нет данных'}</div>`;
    }

    const st = sortState[slug];
    const headers = SORT_COLUMNS.map(col => {
        const arrow = st && st.key === col.key ? (st.asc ? ' ↑' : ' ↓') : '';
        return `<th data-action="sort" data-slug="${slug}" data-col="${col.key}" style="cursor:pointer;">${col.label()}${arrow}</th>`;
    }).join('');

    const rows = residents.map(r => {
        const name = e(getDisplayName(r));
        const link = getProfileLink(r);
        const nameHtml = link ? `<a href="${link}">${name}</a>` : name;
        const dates = formatDateRange(r);
        const room = getRoomText(r);
        const mealBadge = r.has_meals
            ? `<span class="meal-badge yes">${t('dashboard_eating') || 'Питаются'}</span>`
            : `<span class="meal-badge no">${t('dashboard_not_eating') || 'Нет'}</span>`;

        return `<tr>
            <td>${nameHtml}</td>
            <td class="whitespace-nowrap">${dates}</td>
            <td>${room}</td>
            <td>${mealBadge}</td>
        </tr>`;
    }).join('');

    return `<table class="resident-table">
        <thead><tr>${headers}</tr></thead>
        <tbody>${rows}</tbody>
    </table>`;
}

function renderCategorySection(slug, catName, residents) {
    const cfg = CATEGORY_CONFIG[slug] || CATEGORY_CONFIG.guest;
    const icon = CATEGORY_ICONS[slug] || CATEGORY_ICONS.guest;
    const housing = residents.filter(r => r.rooms).length;
    const eating = residents.filter(r => r.has_meals).length;
    const subtitle = `${residents.length} всего / ${housing} живут / ${eating} едят`;

    groupedData[slug] = residents;

    return `<div class="collapsible-card" style="background: ${cfg.bg};">
        <div class="collapsible-header" data-section="${slug}" onclick="toggleSection('${slug}')">
            <div class="section-icon" style="background: ${cfg.icon};">
                <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    ${icon}
                </svg>
            </div>
            <span class="section-title flex-1" style="color: ${cfg.text};">
                ${e(catName)} — <span class="font-normal">${subtitle}</span>
            </span>
            <svg class="w-5 h-5 chevron" style="color: ${cfg.text};" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
        </div>
        <div class="collapsible-body" data-section="${slug}">
            <div class="overflow-x-auto table-wrapper">${buildTable(residents, slug)}</div>
        </div>
    </div>`;
}

// ==================== LOAD ====================
let allPresent = []; // все присутствующие (без фильтра поиска)

async function loadDashboard() {
    const { data, error } = await Layout.db
        .from('residents')
        .select(`
            id, vaishnava_id, guest_name, check_in, check_out, has_meals, has_housing, notes, status,
            resident_categories!inner(slug, name_ru, name_en, name_hi, color, sort_order),
            vaishnavas:vaishnava_id(id, spiritual_name, first_name, last_name),
            rooms:room_id(number, buildings:building_id(name_ru, name_en, name_hi))
        `)
        .eq('status', 'confirmed');

    if (error) { Layout.handleError(error); return; }

    const today = DateUtils.toISO(new Date());

    allPresent = data.filter(r => {
        const cat = r.resident_categories;
        if (!cat || cat.sort_order >= 999) return false;
        return r.check_in <= today && (!r.check_out || r.check_out >= today);
    });

    renderDashboard(allPresent);
    loadKitchenTotals();
}

async function loadKitchenTotals() {
    const today = DateUtils.toISO(new Date());
    const counts = await EatingUtils.loadCounts(today, today);
    const day = counts[today];
    if (!day) return;

    const container = document.getElementById('kitchenTotals');
    const bf = day.breakfast;
    const ln = day.lunch;
    if (!bf && !ln) return;

    const sum = mc => (mc.team || 0) + (mc.volunteers || 0) + (mc.vips || 0) + (mc.guests || 0) + (mc.groups || 0);
    const bfTotal = bf ? sum(bf) : 0;
    const lnTotal = ln ? sum(ln) : 0;
    if (bfTotal === 0 && lnTotal === 0) return;

    // Подробная разбивка
    const fmtParts = (mc) => {
        if (!mc) return '';
        const items = [];
        if (mc.team) items.push(`${t('status_team') || 'команда'} ${mc.team}`);
        if (mc.volunteers) items.push(`${t('category_volunteer') || 'волонтёры'} ${mc.volunteers}`);
        if (mc.vips) items.push(`${t('category_vip') || 'ВИП'} ${mc.vips}`);
        if (mc.guests) items.push(`${t('status_guest') || 'гости'} ${mc.guests}`);
        if (mc.groups) items.push(`${t('nav_groups') || 'группы'} ${mc.groups}`);
        return items.join(', ');
    };

    const cookIcon = `<svg class="w-4 h-4 inline -mt-0.5 mr-1 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 003 2.48z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 18a3.75 3.75 0 00.495-7.467 5.99 5.99 0 00-1.925 3.546 5.974 5.974 0 01-2.133-1A3.75 3.75 0 0012 18z" /></svg>`;

    let html = cookIcon;
    html += `${t('kitchen_total') || 'Кухня на сегодня'}: `;

    if (bfTotal === lnTotal) {
        html += `<b>${bfTotal}</b> (${fmtParts(bf)})`;
    } else {
        html += `${t('breakfast') || 'завтрак'} <b>${bfTotal}</b>, ${t('lunch') || 'обед'} <b>${lnTotal}</b>`;
        html += ` <span class="opacity-60">(${fmtParts(bf || ln)})</span>`;
    }

    container.innerHTML = html;
    container.classList.remove('hidden');
}

function applySearch() {
    const input = document.getElementById('searchInput');
    const query = input.value.trim().toLowerCase();
    document.getElementById('searchClear').classList.toggle('hidden', !query);
    if (!query) {
        renderDashboard(allPresent);
        return;
    }
    const filtered = allPresent.filter(r => getDisplayName(r).toLowerCase().includes(query));
    renderDashboard(filtered);
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('searchClear').classList.add('hidden');
    renderDashboard(allPresent);
}

function renderDashboard(present) {
    // Group by category slug
    const groups = {};
    present.forEach(r => {
        const slug = r.resident_categories.slug;
        if (!groups[slug]) groups[slug] = [];
        groups[slug].push(r);
    });

    // Sort each group by name
    Object.values(groups).forEach(arr => {
        arr.sort((a, b) => getDisplayName(a).localeCompare(getDisplayName(b)));
    });

    // Metrics — всегда от полного набора
    function setMetric(idPrefix, arr) {
        const total = arr.length;
        const eating = arr.filter(r => r.has_meals).length;
        const housing = arr.filter(r => r.rooms).length;
        document.getElementById(idPrefix).textContent = `${total} / ${housing} / ${eating}`;
        document.getElementById(idPrefix + 'Sub').textContent = 'всего / живут / едят';
    }

    setMetric('metricTotal', allPresent);

    const allGroups = {};
    allPresent.forEach(r => {
        const slug = r.resident_categories.slug;
        if (!allGroups[slug]) allGroups[slug] = [];
        allGroups[slug].push(r);
    });

    setMetric('metricTeam', allGroups.team || []);
    setMetric('metricVolunteer', allGroups.volunteer || []);
    setMetric('metricVip', allGroups.vip || []);
    setMetric('metricGuest', allGroups.guest || []);

    // Render sections (отфильтрованные)
    const container = document.getElementById('categorySections');
    const sections = CATEGORY_ORDER
        .filter(slug => (groups[slug] || []).length > 0)
        .map(slug => {
            const list = groups[slug];
            const cat = list[0].resident_categories;
            const catName = Layout.getName(cat);
            return renderCategorySection(slug, catName, list);
        });

    if (sections.length === 0) {
        container.innerHTML = `<div class="text-center py-8 opacity-50">${t('no_data') || 'Нет данных'}</div>`;
    } else {
        container.innerHTML = sections.join('');
    }

    restoreCollapsedStates();
}

// ==================== INIT ====================
// ==================== EVENT DELEGATION ====================
document.addEventListener('click', (ev) => {
    const btn = ev.target.closest('[data-action="sort"]');
    if (!btn) return;
    sortResidents(btn.dataset.slug, btn.dataset.col);
});

// ==================== INIT ====================
async function init() {
    await Layout.init({
        module: 'admin',
        menuId: 'dashboards',
        itemId: 'dashboard_vaishnavas'
    });

    await loadDashboard();
}

init();
</script>

</body>
</html>
