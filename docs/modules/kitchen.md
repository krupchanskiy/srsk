# Модуль Kitchen (Кухня)

## Обзор

Модуль управления кухней ашрама: рецепты, меню, продукты, склад.

- **Цвет модуля**: `#f49800` (оранжевый)
- **Layout.init**: `module: 'kitchen'`

---

## Структура файлов

```
kitchen/
├── recipes.html          # Список рецептов (карточки)
├── recipe.html           # Просмотр рецепта
├── recipe-edit.html      # Редактирование рецепта
├── menu.html             # Меню на неделю
├── menu-templates.html   # Шаблоны меню
├── products.html         # Справочник продуктов
└── dictionaries.html     # Справочники (категории, единицы)

stock/
├── stock.html            # Остатки на складе
├── requests.html         # Заявки на закупку
├── receive.html          # Поступление товаров
├── issue.html            # Выдача со склада
├── inventory.html        # Инвентаризация
└── stock-settings.html   # Настройки склада
```

---

## Страницы

### recipes.html — Список рецептов

**Функционал:**
- Карточки рецептов с фото
- Фильтрация по категориям
- Поиск по названию
- Сортировка: название, категория, время приготовления
- Переключатель показа фото
- Пагинация (50 на страницу)

**Таблицы БД:**
- `recipes` — рецепты
- `recipe_categories` — категории
- `units` — единицы измерения

**Особенности:**
- Локация сохраняется в `localStorage.recipes_category`
- Карточки с hover-эффектом

---

### recipe.html — Просмотр рецепта

**URL параметры:** `?id={recipe_id}`

**Функционал:**
- Информация о рецепте
- Список ингредиентов с количествами
- Пошаговые инструкции
- Фото рецепта
- Кнопка редактирования

**Таблицы БД:**
- `recipes`
- `recipe_ingredients`
- `products`

---

### recipe-edit.html — Редактор рецепта

**URL параметры:** `?id={recipe_id}` (для редактирования) или без параметра (новый)

**Функционал:**
- Форма редактирования рецепта
- Добавление/удаление ингредиентов
- Автоперевод названия (ru → en, hi)
- Загрузка фото
- Выбор категории и локации

**Таблицы БД:**
- `recipes`
- `recipe_ingredients`
- `recipe_categories`
- `products`
- `units`

---

### menu.html — Меню на неделю

**Функционал:**
- Сетка меню: дни × приёмы пищи
- Добавление блюд из рецептов
- Указание количества порций
- Автоматический расчёт ингредиентов
- Копирование из шаблонов

**Таблицы БД:**
- `menu_days`
- `menu_meals`
- `menu_dishes`
- `recipes`

---

### menu-templates.html — Шаблоны меню

**Функционал:**
- Создание шаблонов меню
- Копирование шаблона в меню
- Редактирование шаблонов

**Таблицы БД:**
- `menu_templates`
- `menu_template_meals`
- `menu_template_dishes`

---

### products.html — Справочник продуктов

**Функционал:**
- Таблица продуктов
- Фильтрация по категориям
- Поиск по названию
- Добавление/редактирование продуктов
- Указание единицы измерения
- Флаг "Подходит для экадаши"
- Процент отходов (waste_percent)

**Таблицы БД:**
- `products`
- `product_categories`
- `units`

**Права:** `data-permission="edit_products"`

---

### dictionaries.html — Справочники кухни

**Функционал:**
- Категории рецептов
- Категории продуктов
- Единицы измерения
- Плотности продуктов (для конвертации)

**Таблицы БД:**
- `recipe_categories`
- `product_categories`
- `units`
- `product_densities`

---

## Склад

### stock.html — Остатки

**Функционал:**
- Текущие остатки по продуктам
- Фильтрация по категориям
- Поиск
- Индикация минимального запаса

**Таблицы БД:**
- `stock`
- `products`

**Realtime:** Подписка на изменения `stock`

---

### requests.html — Заявки на закупку

**Функционал:**
- Список заявок
- Создание заявки из меню (авторасчёт)
- Ручное добавление продуктов
- Учёт waste_percent (процент отходов)
- Статусы: черновик, отправлено, закуплено

**Формула waste_percent:**
```javascript
// Если waste_percent = 20%, то для 1 кг очищенного нужно:
quantityToPurchase = neededQuantity / (1 - wastePercent / 100);
// 1 / 0.8 = 1.25 кг
```

**Таблицы БД:**
- `stock_requests`
- `stock_request_items`
- `products`

---

### receive.html — Поступление

**Функционал:**
- Приёмка товаров от поставщика
- Указание цены и количества
- Привязка к заявке
- История поступлений

**Таблицы БД:**
- `stock_receipts`
- `stock_receipt_items`
- `stock`

---

### issue.html — Выдача

**Функционал:**
- Выдача продуктов со склада
- Указание получателя (vaishnava)
- Учёт waste_percent
- История выдач

**Таблицы БД:**
- `stock_issuances`
- `stock_issuance_items`
- `vaishnavas`
- `stock`

---

### inventory.html — Инвентаризация

**Функционал:**
- Создание инвентаризации
- Ввод фактических остатков
- Расчёт расхождений
- Причины расхождений
- Применение корректировок

**Таблицы БД:**
- `stock_inventories`
- `stock_inventory_items`
- `stock`

---

### stock-settings.html — Настройки склада

**Функционал:**
- Минимальные запасы
- Закупщики
- Поставщики

**Таблицы БД:**
- `buyers`
- `products` (min_purchase_qty)

---

## Ключевые функции

### Расчёт ингредиентов меню

```javascript
// Автоматический расчёт нужного количества продуктов из меню
async function calculateMenuIngredients(menuDayIds) {
    // 1. Получить все блюда меню
    // 2. Получить ингредиенты рецептов
    // 3. Умножить на количество порций
    // 4. Сгруппировать по продуктам
    // 5. Учесть waste_percent
}
```

### Конвертация единиц

```javascript
// Конвертация между единицами через плотность
// г → мл, кг → л и т.д.
function convertUnit(quantity, fromUnit, toUnit, density) {
    if (fromUnit === toUnit) return quantity;
    // Используем product_densities для конвертации
}
```

---

## Связанная документация

- [Архитектура](../architecture.md)
- [Утилиты](../utilities.md)
- [База данных](../database.md)
