# Photo Gallery & Face Search ‚Äî –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

**–í–µ—Ä—Å–∏—è**: 1.6 (—É–±—Ä–∞–Ω HEIC, —É–±—Ä–∞–Ω–æ –∞–≤—Ç–æ-—Å–∂–∞—Ç–∏–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ, —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ —Å–∂–∏–º–∞–µ—Ç —Å–∞–º; Telegram-–±–æ—Ç –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞)
**–î–∞—Ç–∞**: 2026-02-08
**–ò—Å—Ç–æ—á–Ω–∏–∫**: Photo-gallery-business-logic Short (PDF) + PLAN-dev-and-photos.md
**–°—Ç–∞—Ç—É—Å**: –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ

---

## –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Ç—Ä–∏—Ç–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ –¥–µ–ª–∞–µ—Ç —Å–æ—Ç–Ω–∏ —Ñ–æ—Ç–æ. –°–µ–π—á–∞—Å —Ñ–æ—Ç–æ —Ä–∞–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ Google Drive –∏–ª–∏ —á–∞—Ç ‚Äî —Ö–∞–æ—Ç–∏—á–Ω–æ, –±–µ–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã. –ì–æ—Å—Ç–∏ –Ω–µ –º–æ–≥—É—Ç –±—ã—Å—Ç—Ä–æ –Ω–∞–π—Ç–∏ —Ñ–æ—Ç–æ —Å —Å–æ–±–æ–π —Å—Ä–µ–¥–∏ 700 —Å–Ω–∏–º–∫–æ–≤. –ß–∞—Å—Ç—å –≥–æ—Å—Ç–µ–π –≤–æ–æ–±—â–µ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —Ñ–æ—Ç–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–µ –≤–∏–¥–∏—Ç —Å—Å—ã–ª–∫—É –≤ —á–∞—Ç–µ.

## –†–µ—à–µ–Ω–∏–µ

–í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Ñ–æ—Ç–æ-–≥–∞–ª–µ—Ä–µ—è –≤ —Å–∏—Å—Ç–µ–º–µ –∞—à—Ä–∞–º–∞ —Å AI-–ø–æ–∏—Å–∫–æ–º –ª–∏—Ü. –§–æ—Ç–æ–≥—Ä–∞—Ñ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–æ—Ç–æ –≤ –∞–¥–º–∏–Ω–∫–µ, –≥–æ—Å—Ç–∏ –≤–∏–¥—è—Ç –≥–∞–ª–µ—Ä–µ—é –≤ Guest Portal –∏ –Ω–∞—Ö–æ–¥—è—Ç —Å–µ–±—è –∑–∞ 2 —Å–µ–∫—É–Ω–¥—ã –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π. Telegram-–±–æ—Ç —É–≤–µ–¥–æ–º–ª—è–µ—Ç –∫–æ–≥–¥–∞ –ø–æ—è–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ —Ñ–æ—Ç–æ.

## –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –¶–µ–ª—å | –ö–∞–∫ –∏–∑–º–µ—Ä—è–µ–º |
|---------|------|-------------|
| –î–æ–ª—è –≥–æ—Å—Ç–µ–π, –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–≤—à–∏—Ö —Ñ–æ—Ç–æ | > 70% | face_search_log / retreat_registrations |
| –î–æ–ª—è –≥–æ—Å—Ç–µ–π, –Ω–∞—à–µ–¥—à–∏—Ö —Å–µ–±—è | > 40% | face_tags COUNT DISTINCT vaishnava_id |
| –í—Ä–µ–º—è –æ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ | < 5 –º–∏–Ω | uploaded_at ‚Üí –ø–µ—Ä–≤—ã–π SELECT –ø–æ retreat_id |
| –í—Ä–µ–º—è –ø–æ–∏—Å–∫–∞ ¬´–ù–∞–π—Ç–∏ —Å–µ–±—è¬ª | < 3 —Å–µ–∫ | search-face response time |
| –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Telegram-–±–æ—Ç–∞ | > 50% | vaishnavas WHERE telegram_chat_id IS NOT NULL |

---

## –ê–∫—Ç–æ—Ä—ã

| –†–æ–ª—å | –ö—Ç–æ —ç—Ç–æ | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –≤ —Å–∏—Å—Ç–µ–º–µ |
|------|---------|---------------------|
| **–§–æ—Ç–æ–≥—Ä–∞—Ñ** | –ß–µ–ª–æ–≤–µ–∫ —Å –∫–∞–º–µ—Ä–æ–π –Ω–∞ —Ä–µ—Ç—Ä–∏—Ç–µ. –ò–º–µ–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é —Ä–æ–ª—å (`upload_photos`). –ù–µ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å | –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–æ—Ç–æ –ø–∞—á–∫–∞–º–∏, —É–¥–∞–ª—è–µ—Ç –Ω–µ—É–¥–∞—á–Ω—ã–µ, —Å–ª–µ–¥–∏—Ç –∑–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–µ–π |
| **–ì–æ—Å—Ç—å** | –£—á–∞—Å—Ç–Ω–∏–∫ —Ä–µ—Ç—Ä–∏—Ç–∞. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ Guest Portal | –°–º–æ—Ç—Ä–∏—Ç –≤—Å–µ —Ñ–æ—Ç–æ, –∏—â–µ—Ç —Å–µ–±—è, —Å–∫–∞—á–∏–≤–∞–µ—Ç, –ø–æ–¥–∫–ª—é—á–∞–µ—Ç Telegram |
| **–°–∏—Å—Ç–µ–º–∞** | –ë—ç–∫–µ–Ω–¥ (Edge Functions + AWS Rekognition + Telegram Bot) | –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç –ª–∏—Ü–∞, –∏—â–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è |
| **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä** | –°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∏—Å—Ç–µ–º—ã | –£–ø—Ä–∞–≤–ª—è–µ—Ç permission —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∞, –≤–∏–¥–∏—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ–∏—Å–∫–æ–≤ |

---

## User Stories

### US-1: –§–æ—Ç–æ–≥—Ä–∞—Ñ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–æ—Ç–æ —Å —Ä–µ—Ç—Ä–∏—Ç–∞

```
–ö–∞–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ,
—è —Ö–æ—á—É –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞—á–∫—É —Ñ–æ—Ç–æ –∑–∞ –æ–¥–∏–Ω —Ä–∞–∑,
—á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É –ø–æ –æ–¥–Ω–æ–º—É.

Acceptance Criteria:
- Given —è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –∏ –≤—ã–±—Ä–∞–ª —Ä–µ—Ç—Ä–∏—Ç
- When —è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—é 100 —Ñ–æ—Ç–æ –≤ –∑–æ–Ω—É –∑–∞–≥—Ä—É–∑–∫–∏
- Then —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–≤—å—é –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
  AND —è –≤–∏–∂—É –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ (34/100, —Å–∫–æ—Ä–æ—Å—Ç—å, —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª)
  AND —Ñ–∞–π–ª—ã —Å –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º (–Ω–µ JPEG/PNG) –ø–æ–º–µ—á–µ–Ω—ã —Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º
  AND —Ñ–∞–π–ª—ã > 25 –ú–ë –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º: ¬´–°–æ–∂–º–∏—Ç–µ —Ñ–∞–π–ª –¥–æ 25 –ú–ë¬ª
  AND –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ª–∏—Ü
  AND —è –º–æ–≥—É –∑–∞–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É ‚Äî –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è –ø–æ–∑–∂–µ
```

### US-2: –ì–æ—Å—Ç—å –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—é

```
–ö–∞–∫ –≥–æ—Å—Ç—å —Ä–µ—Ç—Ä–∏—Ç–∞,
—è —Ö–æ—á—É –≤–∏–¥–µ—Ç—å –≤—Å–µ —Ñ–æ—Ç–æ —Å –º–æ–µ–≥–æ —Ä–µ—Ç—Ä–∏—Ç–∞,
—á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è.

Acceptance Criteria:
- Given —è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –≤ Guest Portal –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Ä–µ—Ç—Ä–∏—Ç
- When —è –æ—Ç–∫—Ä—ã–≤–∞—é —Ä–∞–∑–¥–µ–ª ¬´–§–æ—Ç–æ¬ª
- Then —è –≤–∏–∂—É –≤—Å–µ —Ñ–æ—Ç–æ —Ä–µ—Ç—Ä–∏—Ç–∞ –≤ –≤–∏–¥–µ —Å–µ—Ç–∫–∏ —Å –º–∏–Ω–∏–∞—Ç—é—Ä–∞–º–∏
  AND —Ñ–æ—Ç–æ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –¥–Ω—è–º
  AND –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è
  AND —è –º–æ–≥—É —Å–∫–∞—á–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ
  AND —è –≤–∏–∂—É –∫–Ω–æ–ø–∫—É ¬´–ù–∞–π—Ç–∏ —Å–µ–±—è¬ª
```

### US-3: –ì–æ—Å—Ç—å –∏—â–µ—Ç —Å–µ–±—è –Ω–∞ —Ñ–æ—Ç–æ

```
–ö–∞–∫ –≥–æ—Å—Ç—å —Ä–µ—Ç—Ä–∏—Ç–∞,
—è —Ö–æ—á—É –Ω–∞–π—Ç–∏ –≤—Å–µ —Ñ–æ—Ç–æ, –≥–¥–µ —è –µ—Å—Ç—å,
—á—Ç–æ–±—ã –Ω–µ –ª–∏—Å—Ç–∞—Ç—å 700 —Å–Ω–∏–º–∫–æ–≤ –≤—Ä—É—á–Ω—É—é.

Acceptance Criteria:
- Given —è –≤ –≥–∞–ª–µ—Ä–µ–µ —Ä–µ—Ç—Ä–∏—Ç–∞ –∏ —É –º–µ–Ω—è –µ—Å—Ç—å —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è
- When —è –Ω–∞–∂–∏–º–∞—é ¬´–ù–∞–π—Ç–∏ —Å–µ–±—è¬ª
- Then –∑–∞ 1-3 —Å–µ–∫—É–Ω–¥—ã —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ —Ñ–æ—Ç–æ, –≥–¥–µ —è –Ω–∞–π–¥–µ–Ω
  AND —Ä—è–¥–æ–º —Å –∫–∞–∂–¥—ã–º —Ñ–æ—Ç–æ ‚Äî –ø—Ä–æ—Ü–µ–Ω—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
  AND –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è —Ñ–∏–ª—å—Ç—Ä ¬´–§–æ—Ç–æ —Å–æ –º–Ω–æ–π¬ª
  AND —è –º–æ–≥—É —Å–∫–∞—á–∞—Ç—å –≤—Å–µ —Å–≤–æ–∏ —Ñ–æ—Ç–æ

- Given —É –º–µ–Ω—è –ù–ï–¢ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è
- When —è –Ω–∞–∂–∏–º–∞—é ¬´–ù–∞–π—Ç–∏ —Å–µ–±—è¬ª
- Then —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å–¥–µ–ª–∞—Ç—å —Å–µ–ª—Ñ–∏ (–º–æ–±–∏–ª—å–Ω—ã–π) –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
  AND –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ ‚Äî –ø–æ–∏—Å–∫ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

- Given –ø–æ–∏—Å–∫ –Ω–µ –Ω–∞—à—ë–ª —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
- When —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî 0 —Ñ–æ—Ç–æ
- Then —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∫—É: ¬´–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ (–∫—Ä—É–ø–Ω—ã–π –ø–ª–∞–Ω, —Ö–æ—Ä–æ—à–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ)¬ª
```

### US-4: –ì–æ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–∞–µ—Ç Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```
–ö–∞–∫ –≥–æ—Å—Ç—å —Ä–µ—Ç—Ä–∏—Ç–∞,
—è —Ö–æ—á—É –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram –∫–æ–≥–¥–∞ –ø–æ—è–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ —Ñ–æ—Ç–æ,
—á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–∞–π—Ç –≤—Ä—É—á–Ω—É—é.

Acceptance Criteria:
- Given —è –≤ Guest Portal
- When —è –Ω–∞–∂–∏–º–∞—é ¬´–ü–æ–¥–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è¬ª
- Then –≤–∏–∂—É –∫–Ω–æ–ø–∫—É/—Å—Å—ã–ª–∫—É –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ Telegram-–±–æ—Ç–∞
  AND –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ /start TOKEN –≤ –±–æ—Ç–µ ‚Äî –ø–æ–ª—É—á–∞—é –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
  AND –≤ Guest Portal —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ ¬´–ü–æ–¥–∫–ª—é—á–µ–Ω–æ¬ª

- Given —è –ø–æ–¥–∫–ª—é—á–∏–ª –±–æ—Ç–∞ –∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ –∑–∞–≥—Ä—É–∑–∏–ª –Ω–æ–≤—ã–µ —Ñ–æ—Ç–æ
- When –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
- Then —è –ø–æ–ª—É—á–∞—é —Å–æ–æ–±—â–µ–Ω–∏–µ: ¬´–ù–æ–≤—ã–µ —Ñ–æ—Ç–æ —Å —Ä–µ—Ç—Ä–∏—Ç–∞! –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å ‚Üí¬ª

- Given —è —Ö–æ—á—É –æ—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- When —è –æ—Ç–ø—Ä–∞–≤–ª—è—é /stop –±–æ—Ç—É –ò–õ–ò –Ω–∞–∂–∏–º–∞—é ¬´–û—Ç–∫–ª—é—á–∏—Ç—å¬ª –≤ Guest Portal
- Then —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–µ–∫—Ä–∞—â–∞—é—Ç—Å—è
```

### US-5: –§–æ—Ç–æ–≥—Ä–∞—Ñ —É–¥–∞–ª—è–µ—Ç –Ω–µ—É–¥–∞—á–Ω—ã–µ —Ñ–æ—Ç–æ

```
–ö–∞–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ,
—è —Ö–æ—á—É —É–¥–∞–ª–∏—Ç—å –Ω–µ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ,
—á—Ç–æ–±—ã –≥–æ—Å—Ç–∏ –≤–∏–¥–µ–ª–∏ —Ç–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–∏–µ —Å–Ω–∏–º–∫–∏.

Acceptance Criteria:
- Given —è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ
- When —è –≤—ã–±–∏—Ä–∞—é –æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ –∏ –Ω–∞–∂–∏–º–∞—é ¬´–£–¥–∞–ª–∏—Ç—å¬ª
- Then —Å–∏—Å—Ç–µ–º–∞ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: ¬´–£–¥–∞–ª–∏—Ç—å N —Ñ–æ—Ç–æ? –ù–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å¬ª
  AND –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ‚Äî —Ñ–æ—Ç–æ, —Ñ–∞–π–ª—ã –∏ –¥–∞–Ω–Ω—ã–µ –æ –ª–∏—Ü–∞—Ö —É–¥–∞–ª–µ–Ω—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é
  AND —É–¥–∞–ª—ë–Ω–Ω—ã–µ –ª–∏—Ü–∞ –Ω–µ –≤—Å–ø–ª—ã–≤–∞—é—Ç –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞
```

### US-6: –ì–æ—Å—Ç—å –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ —Ä–µ—Ç—Ä–∏—Ç –Ω–µ –≤–∏–¥–∏—Ç —Ñ–æ—Ç–æ

```
–ö–∞–∫ —Å–∏—Å—Ç–µ–º–∞,
—è —Ö–æ—á—É –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ñ–æ—Ç–æ —Ç–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º —Ä–µ—Ç—Ä–∏—Ç–∞,
—á—Ç–æ–±—ã –æ–±–µ—Å–ø–µ—á–∏—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å.

Acceptance Criteria:
- Given –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ –¥–∞–Ω–Ω—ã–π —Ä–µ—Ç—Ä–∏—Ç
- When –æ–Ω –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—å –≥–∞–ª–µ—Ä–µ—é —ç—Ç–æ–≥–æ —Ä–µ—Ç—Ä–∏—Ç–∞
- Then –æ–Ω –Ω–µ –≤–∏–¥–∏—Ç —Ñ–æ—Ç–æ (RLS –±–ª–æ–∫–∏—Ä—É–µ—Ç)
  AND –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ: ¬´–§–æ—Ç–æ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º —Ä–µ—Ç—Ä–∏—Ç–∞¬ª
```

---

## User Flows

### Flow 1: –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è —Ñ–æ—Ç–æ (–§–æ—Ç–æ–≥—Ä–∞—Ñ)

```
–§–æ—Ç–æ–≥—Ä–∞—Ñ                          –°–∏—Å—Ç–µ–º–∞                         AWS Rekognition
    ‚îÇ                                 ‚îÇ                                 ‚îÇ
    ‚îú‚îÄ‚Üí –û—Ç–∫—Ä—ã–≤–∞–µ—Ç photos/upload.html  ‚îÇ                                 ‚îÇ
    ‚îú‚îÄ‚Üí –í—ã–±–∏—Ä–∞–µ—Ç —Ä–µ—Ç—Ä–∏—Ç              ‚îÇ                                 ‚îÇ
    ‚îú‚îÄ‚Üí –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ—Ç 100 —Ñ–æ—Ç–æ       ‚îÇ                                 ‚îÇ
    ‚îÇ                                 ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îå‚îÄ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ ‚îÄ‚îê  ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ –§–æ—Ä–º–∞—Ç: JPEG/PNG?       ‚îÇ  ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ ‚ùå 2 —Ñ–∞–π–ª–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π    ‚îÇ  ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ    —Ñ–æ—Ä–º–∞—Ç (HEIC,BMP,..) ‚îÇ  ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ ‚ùå 1 —Ñ–∞–π–ª > 25 –ú–ë ‚Üí    ‚îÇ  ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ    –æ—Ç–∫–ª–æ–Ω—ë–Ω             ‚îÇ  ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ ‚úÖ 97 —Ñ–∞–π–ª–æ–≤ –≥–æ—Ç–æ–≤—ã     ‚îÇ  ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ                                 ‚îÇ
    ‚îÇ                                 ‚îÇ                                 ‚îÇ
    ‚îú‚îÄ‚Üí –ù–∞–∂–∏–º–∞–µ—Ç ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å¬ª         ‚îÇ                                 ‚îÇ
    ‚îÇ                                 ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îå‚îÄ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π upload ‚îÄ‚îê ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ –§–∞–π–ª 1/97 ‚Üí Storage      ‚îú‚îÄ‚î§‚îÄ‚Üí INSERT retreat_photos         ‚îÇ
    ‚îÇ   ‚îÇ –§–∞–π–ª 2/97 ‚Üí Storage      ‚îú‚îÄ‚î§‚îÄ‚Üí INSERT retreat_photos         ‚îÇ
    ‚îÇ   ‚îÇ ...                       ‚îÇ ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë] 34/97       ‚îÇ ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ –§–∞–π–ª 97/97 ‚Üí Storage     ‚îú‚îÄ‚î§‚îÄ‚Üí INSERT retreat_photos         ‚îÇ
    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ                                 ‚îÇ
    ‚îÇ                                 ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îå‚îÄ –ê–≤—Ç–æ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –±–∞—Ç—á–∞–º–∏ ‚îÄ‚îÄ‚îê ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ Batch 1 (—Ñ–æ—Ç–æ 1-20)      ‚îú‚îÄ‚î§‚îÄ‚Üí Edge Function index-faces ‚îÄ‚îÄ‚Üí‚îú‚îÄ‚Üí IndexFaces √ó20
    ‚îÇ   ‚îÇ Batch 2 (—Ñ–æ—Ç–æ 21-40)     ‚îú‚îÄ‚î§‚îÄ‚Üí Edge Function index-faces ‚îÄ‚îÄ‚Üí‚îú‚îÄ‚Üí IndexFaces √ó20
    ‚îÇ   ‚îÇ ...                       ‚îÇ ‚îÇ   (—Ä–µ—Å–∞–π–∑ >4.5 –ú–ë)             ‚îÇ
    ‚îÇ   ‚îÇ [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë] 60/97        ‚îÇ ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ Batch 5 (—Ñ–æ—Ç–æ 81-97)     ‚îú‚îÄ‚î§‚îÄ‚Üí Edge Function index-faces ‚îÄ‚îÄ‚Üí‚îú‚îÄ‚Üí IndexFaces √ó17
    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ                                 ‚îÇ
    ‚îÇ                                 ‚îÇ                                 ‚îÇ
    ‚îÇ                                 ‚îú‚îÄ‚Üí Telegram: ¬´–ù–æ–≤—ã–µ —Ñ–æ—Ç–æ!¬ª ‚îÄ‚îÄ‚Üí –≥–æ—Å—Ç—è–º
    ‚îÇ                                 ‚îÇ                                 ‚îÇ
    ‚úÖ –ì–æ—Ç–æ–≤–æ: 97 —Ñ–æ—Ç–æ, 247 –ª–∏—Ü      ‚îÇ                                 ‚îÇ
```

### Flow 2: –ü–æ–∏—Å–∫ —Å–µ–±—è –Ω–∞ —Ñ–æ—Ç–æ (–ì–æ—Å—Ç—å)

```
–ì–æ—Å—Ç—å                              –°–∏—Å—Ç–µ–º–∞                         AWS Rekognition
    ‚îÇ                                 ‚îÇ                                 ‚îÇ
    ‚îú‚îÄ‚Üí –û—Ç–∫—Ä—ã–≤–∞–µ—Ç Guest Portal        ‚îÇ                                 ‚îÇ
    ‚îú‚îÄ‚Üí –†–∞–∑–¥–µ–ª ¬´–§–æ—Ç–æ¬ª               ‚îÇ                                 ‚îÇ
    ‚îÇ                                 ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îå‚îÄ –ì–∞–ª–µ—Ä–µ—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ üì∑üì∑üì∑üì∑üì∑üì∑üì∑üì∑    ‚îÇ   ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ üì∑üì∑üì∑üì∑üì∑üì∑üì∑üì∑    ‚îÇ   ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ –î–µ–Ω—å 1 ¬∑ –î–µ–Ω—å 2 ¬∑ ...  ‚îÇ   ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ                        ‚îÇ   ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ    [üîç –ù–∞–π—Ç–∏ —Å–µ–±—è]     ‚îÇ   ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ                                 ‚îÇ
    ‚îÇ                                 ‚îÇ                                 ‚îÇ
    ‚îú‚îÄ‚Üí –ù–∞–∂–∏–º–∞–µ—Ç ¬´–ù–∞–π—Ç–∏ —Å–µ–±—è¬ª        ‚îÇ                                 ‚îÇ
    ‚îÇ                                 ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îå‚îÄ –ï—Å—Ç—å —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è? ‚îÄ‚îÄ‚îê    ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ –î–ê ‚Üí –±–µ—Ä—ë–º –∏–∑ Storage  ‚îÇ    ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ –ù–ï–¢ ‚Üí –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º:     ‚îÇ    ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ   üì± –°–¥–µ–ª–∞—Ç—å —Å–µ–ª—Ñ–∏     ‚îÇ    ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ   üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª    ‚îÇ    ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ                                 ‚îÇ
    ‚îÇ                                 ‚îÇ                                 ‚îÇ
    ‚îÇ                                 ‚îú‚îÄ‚Üí Edge Function search-face     ‚îÇ
    ‚îÇ                                 ‚îÇ   1. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –≥–æ—Å—Ç—è      ‚îÇ
    ‚îÇ                                 ‚îÇ   2. –†–µ—Å–∞–π–∑ –µ—Å–ª–∏ > 4.5 –ú–ë     ‚îÇ
    ‚îÇ                                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí  ‚îÇ
    ‚îÇ                                 ‚îÇ   SearchFacesByImage            ‚îÇ
    ‚îÇ                                 ‚îÇ   (1 –≤—ã–∑–æ–≤, 1-2 —Å–µ–∫)           ‚îÇ
    ‚îÇ                                 ‚îÇ  ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
    ‚îÇ                                 ‚îÇ   3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å face_tags       ‚îÇ
    ‚îÇ                                 ‚îÇ   4. –í–µ—Ä–Ω—É—Ç—å photo_ids         ‚îÇ
    ‚îÇ                                 ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îå‚îÄ –†–µ–∑—É–ª—å—Ç–∞—Ç ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ ¬´–ù–∞–π–¥–µ–Ω–æ 23 —Ñ–æ—Ç–æ!¬ª    ‚îÇ    ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ                        ‚îÇ    ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ [‚úÖ –§–æ—Ç–æ —Å–æ –º–Ω–æ–π]      ‚îÇ    ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ üü¢üì∑ üü¢üì∑ üü¢üì∑ üì∑    ‚îÇ    ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ üü¢üì∑ üì∑ üü¢üì∑ üì∑ üì∑   ‚îÇ    ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ                        ‚îÇ    ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îÇ üü¢ = —Å –≤–∞–º–∏ (95%)     ‚îÇ    ‚îÇ                                 ‚îÇ
    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ                                 ‚îÇ
    ‚îÇ                                 ‚îÇ                                 ‚îÇ
    ‚îú‚îÄ‚Üí –°–∫–∞—á–∏–≤–∞–µ—Ç ¬´–í—Å–µ –º–æ–∏ —Ñ–æ—Ç–æ¬ª     ‚îÇ                                 ‚îÇ
    ‚úÖ                                ‚îÇ                                 ‚îÇ
```

### Flow 3: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–ì–æ—Å—Ç—å)

```
–ì–æ—Å—Ç—å                    Guest Portal              Edge Function           Telegram
  ‚îÇ                          ‚îÇ                          ‚îÇ                      ‚îÇ
  ‚îú‚îÄ‚Üí ¬´–ü–æ–¥–∫–ª—é—á–∏—Ç—å            ‚îÇ                          ‚îÇ                      ‚îÇ
  ‚îÇ    —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è¬ª          ‚îÇ                          ‚îÇ                      ‚îÇ
  ‚îÇ                          ‚îú‚îÄ‚Üí –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç TOKEN       ‚îÇ                      ‚îÇ
  ‚îÇ                          ‚îÇ   (UUID, TTL 15 –º–∏–Ω)     ‚îÇ                      ‚îÇ
  ‚îÇ                          ‚îÇ                          ‚îÇ                      ‚îÇ
  ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ                          ‚îÇ                      ‚îÇ
  ‚îÇ   ‚îÇ –ü–æ–¥–∫–ª—é—á–∏—Ç—å –¢–ì:   ‚îÇ   ‚îÇ                          ‚îÇ                      ‚îÇ
  ‚îÇ   ‚îÇ [–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞ ‚Üí] ‚îÇ   ‚îÇ                          ‚îÇ                      ‚îÇ
  ‚îÇ   ‚îÇ t.me/rupaseva_bot‚îÇ   ‚îÇ                          ‚îÇ                      ‚îÇ
  ‚îÇ   ‚îÇ ?start=abc123... ‚îÇ   ‚îÇ                          ‚îÇ                      ‚îÇ
  ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ                          ‚îÇ                      ‚îÇ
  ‚îÇ                          ‚îÇ                          ‚îÇ                      ‚îÇ
  ‚îú‚îÄ‚Üí –ù–∞–∂–∏–º–∞–µ—Ç —Å—Å—ã–ª–∫—É ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí Telegram
  ‚îÇ                          ‚îÇ                          ‚îÇ                      ‚îÇ
  ‚îú‚îÄ‚Üí /start abc123...  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí webhook
  ‚îÇ                          ‚îÇ                          ‚îÇ                      ‚îÇ
  ‚îÇ                          ‚îÇ                          ‚îú‚îÄ‚Üí –í–∞–ª–∏–¥–∞—Ü–∏—è TOKEN    ‚îÇ
  ‚îÇ                          ‚îÇ                          ‚îÇ   ‚úÖ –≤–∞–ª–∏–¥–µ–Ω         ‚îÇ
  ‚îÇ                          ‚îÇ                          ‚îÇ                      ‚îÇ
  ‚îÇ                          ‚îÇ                          ‚îú‚îÄ‚Üí UPDATE vaishnavas  ‚îÇ
  ‚îÇ                          ‚îÇ                          ‚îÇ   SET telegram_chat_id
  ‚îÇ                          ‚îÇ                          ‚îÇ                      ‚îÇ
  ‚îÇ                          ‚îÇ                          ‚îú‚îÄ‚Üí –û—Ç–≤–µ—Ç –±–æ—Ç–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ‚îÇ
  ‚îÇ                          ‚îÇ                          ‚îÇ   ¬´–ü—Ä–∏–≤–µ—Ç, –†–∞–¥—Ö–∞!    ‚îÇ
  ‚îÇ  ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è       ‚îÇ
  ‚îÇ   ¬´–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è                                     ‚îÇ    –ø–æ–¥–∫–ª—é—á–µ–Ω—ã ‚úì¬ª     ‚îÇ
  ‚îÇ    –ø–æ–¥–∫–ª—é—á–µ–Ω—ã ‚úì¬ª         ‚îÇ                          ‚îÇ                      ‚îÇ
  ‚îÇ                          ‚îÇ                          ‚îÇ                      ‚îÇ
  ‚îÇ   ... –ø–æ–∑–∂–µ ...          ‚îÇ                          ‚îÇ                      ‚îÇ
  ‚îÇ                          ‚îÇ                          ‚îÇ                      ‚îÇ
  ‚îÇ                          ‚îÇ   –§–æ—Ç–æ–≥—Ä–∞—Ñ –∑–∞–≥—Ä—É–∑–∏–ª      ‚îÇ                      ‚îÇ
  ‚îÇ                          ‚îÇ   –Ω–æ–≤—ã–µ —Ñ–æ—Ç–æ             ‚îÇ                      ‚îÇ
  ‚îÇ                          ‚îÇ                          ‚îú‚îÄ‚Üí send-notification  ‚îÇ
  ‚îÇ  ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ¬´–ù–æ–≤—ã–µ —Ñ–æ—Ç–æ —Å        ‚îÇ
  ‚îÇ   push –≤ Telegram        ‚îÇ                          ‚îÇ  —Ä–µ—Ç—Ä–∏—Ç–∞! ‚Üí¬ª        ‚îÇ
  ‚úÖ                         ‚îÇ                          ‚îÇ                      ‚îÇ
```

### Flow 4: –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ (–§–æ—Ç–æ–≥—Ä–∞—Ñ)

```
–§–æ—Ç–æ–≥—Ä–∞—Ñ                       –°–∏—Å—Ç–µ–º–∞                      AWS Rekognition
    ‚îÇ                              ‚îÇ                              ‚îÇ
    ‚îú‚îÄ‚Üí photos/manage.html         ‚îÇ                              ‚îÇ
    ‚îú‚îÄ‚Üí –í—ã–±–∏—Ä–∞–µ—Ç 5 —Ñ–æ—Ç–æ           ‚îÇ                              ‚îÇ
    ‚îú‚îÄ‚Üí ¬´–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (5)¬ª   ‚îÇ                              ‚îÇ
    ‚îÇ                              ‚îÇ                              ‚îÇ
    ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ                              ‚îÇ
    ‚îÇ   ‚îÇ –£–¥–∞–ª–∏—Ç—å 5 —Ñ–æ—Ç–æ?   ‚îÇ     ‚îÇ                              ‚îÇ
    ‚îÇ   ‚îÇ –ù–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.  ‚îÇ     ‚îÇ                              ‚îÇ
    ‚îÇ   ‚îÇ [–û—Ç–º–µ–Ω–∞] [–£–¥–∞–ª–∏—Ç—å]‚îÇ     ‚îÇ                              ‚îÇ
    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ                              ‚îÇ
    ‚îÇ                              ‚îÇ                              ‚îÇ
    ‚îú‚îÄ‚Üí –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç               ‚îÇ                              ‚îÇ
    ‚îÇ                              ‚îú‚îÄ‚Üí Edge Function delete-photos ‚îÇ
    ‚îÇ                              ‚îÇ   1. –ü–æ–ª—É—á–∏—Ç—å face_ids       ‚îÇ
    ‚îÇ                              ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí   ‚îÇ
    ‚îÇ                              ‚îÇ   DeleteFaces(face_ids)      ‚îÇ
    ‚îÇ                              ‚îÇ  ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
    ‚îÇ                              ‚îÇ   2. DELETE face_tags        ‚îÇ
    ‚îÇ                              ‚îÇ   3. DELETE photo_faces      ‚îÇ
    ‚îÇ                              ‚îÇ   4. DELETE retreat_photos   ‚îÇ
    ‚îÇ                              ‚îÇ   5. Storage.remove(paths)   ‚îÇ
    ‚îÇ                              ‚îÇ                              ‚îÇ
    ‚úÖ ¬´5 —Ñ–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ¬ª           ‚îÇ                              ‚îÇ
```

---

## BPMN-–¥–∏–∞–≥—Ä–∞–º–º—ã (Mermaid)

### –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ

```mermaid
flowchart TD
    A([–§–æ—Ç–æ–≥—Ä–∞—Ñ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç upload.html]) --> B[–í—ã–±–∏—Ä–∞–µ—Ç —Ä–µ—Ç—Ä–∏—Ç]
    B --> C[–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ]
    C --> D{–§–æ—Ä–º–∞—Ç JPEG/PNG?}
    D -->|–ù–µ—Ç| F[Inline-–æ—à–∏–±–∫–∞: ¬´–§–æ—Ä–º–∞—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ JPEG¬ª]
    D -->|–î–∞| D2{–†–∞–∑–º–µ—Ä > 25 –ú–ë?}
    D2 -->|–î–∞| D3[–û—Ç–∫–ª–æ–Ω—ë–Ω: ¬´–°–æ–∂–º–∏—Ç–µ —Ñ–∞–π–ª –¥–æ 25 –ú–ë¬ª]
    D2 -->|–ù–µ—Ç| E[–§–∞–π–ª –≥–æ—Ç–æ–≤ –∫ –∑–∞–≥—Ä—É–∑–∫–µ]
    E --> G[–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π upload –≤ Storage]
    G --> H[INSERT retreat_photos status=pending]
    H --> I{–í—Å–µ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã?}
    I -->|–ù–µ—Ç| G
    I -->|–î–∞| J[–ó–∞–ø—É—Å–∫ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –±–∞—Ç—á–∞–º–∏ –ø–æ 20]
    J --> K[Edge Function: index-faces]
    K --> L{file_size > 4.5 –ú–ë?}
    L -->|–î–∞| M[–†–µ—Å–∞–π–∑ –¥–æ 2048px]
    L -->|–ù–µ—Ç| N[–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞–∫ –µ—Å—Ç—å]
    M --> N
    N --> O[Rekognition.IndexFaces]
    O --> P{–£—Å–ø–µ—Ö?}
    P -->|–î–∞| Q[status = indexed, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å face_ids]
    P -->|–û—à–∏–±–∫–∞ Throttle| R[Retry —Å backoff]
    R --> O
    P -->|–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞| S[status = failed]
    Q --> T{–ï—â—ë –±–∞—Ç—á–∏?}
    S --> T
    T -->|–î–∞| J
    T -->|–ù–µ—Ç| U[Telegram: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≥–æ—Å—Ç—è–º]
    U --> V([–ì–æ—Ç–æ–≤–æ])
```

### –ü—Ä–æ—Ü–µ—Å—Å –ø–æ–∏—Å–∫–∞ —Å–µ–±—è

```mermaid
flowchart TD
    A([–ì–æ—Å—Ç—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –≥–∞–ª–µ—Ä–µ—é]) --> B[–í–∏–¥–∏—Ç –≤—Å–µ —Ñ–æ—Ç–æ —Ä–µ—Ç—Ä–∏—Ç–∞]
    B --> C{–ù–∞–∂–∏–º–∞–µ—Ç ¬´–ù–∞–π—Ç–∏ —Å–µ–±—è¬ª}
    C --> D{–ï—Å—Ç—å —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è?}
    D -->|–î–∞| G[–ë–µ—Ä—ë–º —Ñ–æ—Ç–æ –∏–∑ Storage]
    D -->|–ù–µ—Ç| E{–ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã}
    E -->|–°–µ–ª—Ñ–∏| F1[–û—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É]
    E -->|–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª| F2[–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª]
    E -->|–û—Ç–º–µ–Ω–∞| Z([–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–∞–ª–µ—Ä–µ—é])
    F1 --> G
    F2 --> G
    G --> H[Edge Function: search-face]
    H --> I[Rekognition.SearchFacesByImage]
    I --> J{–ù–∞–π–¥–µ–Ω—ã —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è?}
    J -->|–î–∞, N —Ñ–æ—Ç–æ| K[UPSERT face_tags]
    K --> L[–ü–æ–∫–∞–∑–∞—Ç—å: ¬´–ù–∞–π–¥–µ–Ω–æ N —Ñ–æ—Ç–æ!¬ª]
    L --> M[–§–∏–ª—å—Ç—Ä ¬´–§–æ—Ç–æ —Å–æ –º–Ω–æ–π¬ª –∞–∫—Ç–∏–≤–µ–Ω]
    M --> N[–ì–æ—Å—Ç—å –º–æ–∂–µ—Ç —Å–∫–∞—á–∞—Ç—å –≤—Å–µ —Å–≤–æ–∏ —Ñ–æ—Ç–æ]
    J -->|–ù–µ—Ç| O[–ü–æ–¥—Å–∫–∞–∑–∫–∞: ¬´–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ¬ª]
    O --> Z
    N --> Z
```

### –ü—Ä–æ—Ü–µ—Å—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Telegram

```mermaid
flowchart TD
    A([–ì–æ—Å—Ç—å –≤ Guest Portal]) --> B{–ù–∞–∂–∏–º–∞–µ—Ç ¬´–ü–æ–¥–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è¬ª}
    B --> C[–ì–µ–Ω–µ—Ä–∞—Ü–∏—è TOKEN, TTL 15 –º–∏–Ω]
    C --> D[–ü–æ–∫–∞–∑ —Å—Å—ã–ª–∫–∏: t.me/rupaseva_bot?start=TOKEN]
    D --> E[–ì–æ—Å—Ç—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ Telegram]
    E --> F[–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç /start TOKEN]
    F --> G[Webhook: Edge Function telegram-webhook]
    G --> H{–¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω?}
    H -->|–î–∞: —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω, –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω| I[UPDATE vaishnavas SET telegram_chat_id]
    H -->|–ü—Ä–æ—Å—Ä–æ—á–µ–Ω| J[–ë–æ—Ç: ¬´–°—Å—ã–ª–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∞, –ø–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—É—é –≤ –ø–æ—Ä—Ç–∞–ª–µ¬ª]
    H -->|–£–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω| K[–ë–æ—Ç: ¬´–¢–æ–∫–µ–Ω –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω, –ø–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–π¬ª]
    I --> L[–ë–æ—Ç: ¬´–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω—ã!¬ª]
    L --> M[Guest Portal: —Å—Ç–∞—Ç—É—Å ¬´–ü–æ–¥–∫–ª—é—á–µ–Ω–æ¬ª]
    M --> N([–ì–æ—Ç–æ–≤–æ])

    O([–ì–æ—Å—Ç—å —Ö–æ—á–µ—Ç –æ—Ç–∫–ª—é—á–∏—Ç—å]) --> P{–ö–∞–∫ –æ—Ç–∫–ª—é—á–∞–µ—Ç?}
    P -->|/stop –≤ –±–æ—Ç–µ| Q[SET telegram_chat_id = NULL]
    P -->|–ö–Ω–æ–ø–∫–∞ –≤ Portal| Q
    Q --> R[–ë–æ—Ç: ¬´–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã¬ª]
```

---

## –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è (MoSCoW)

**–í —Ä–∞–±–æ—Ç—É –±–µ—Ä—ë–º: Must Have + Should Have. Could Have ‚Äî –ø–æ—Å–ª–µ MVP.**

### Must Have

- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –ø–∞—á–∫–æ–π (drag & drop + –∞–≤—Ç–æ-—Å–∂–∞—Ç–∏–µ)
- –ü—Ä–æ—Å–º–æ—Ç—Ä –≥–∞–ª–µ—Ä–µ–∏ —Å –º–∏–Ω–∏–∞—Ç—é—Ä–∞–º–∏
- –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ (—Å –∫–∞—Å–∫–∞–¥–æ–º Rekognition + Storage + –ë–î)
- –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ª–∏—Ü (IndexFaces, –±–∞—Ç—á–∏ –ø–æ 20)
- –ü–æ–∏—Å–∫ —Å–µ–±—è (SearchFacesByImage, –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π)
- RLS: —Ñ–æ—Ç–æ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–∏ —Ä–µ—Ç—Ä–∏—Ç–∞
- –†–æ–ª—å ¬´–§–æ—Ç–æ–≥—Ä–∞—Ñ¬ª (permission `upload_photos`)

### Should Have

- Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–±–æ—Ç + –ø—Ä–∏–≤—è–∑–∫–∞ + /start /stop)
- Fallback: –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è –≥–æ—Å—Ç–µ–π –±–µ–∑ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è
- Bulk delete —Å –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–æ–º

### Could Have (–ø–æ—Å–ª–µ MVP)

- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ñ–æ—Ç–æ –ø–æ –¥–Ω—è–º —Ä–µ—Ç—Ä–∏—Ç–∞
- –ü—Ä–æ–≥—Ä–µ—Å—Å–±–∞—Ä –∑–∞–≥—Ä—É–∑–∫–∏ (—Å–∫–æ—Ä–æ—Å—Ç—å, ETA, –ø–∞—É–∑–∞/–æ—Ç–º–µ–Ω–∞)
- –ö–Ω–æ–ø–∫–∞ ¬´–ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å¬ª (–ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏)
- –ü—Ä–æ–≥—Ä–µ—Å—Å–±–∞—Ä –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–≤–æ–∏—Ö —Ñ–æ—Ç–æ zip-–∞—Ä—Ö–∏–≤–æ–º
- –ü–æ–¥–ø–∏—Å–∏ –∫ —Ñ–æ—Ç–æ (caption)
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–∏—Å–∫–æ–≤ (face_search_log)
- QR-–∫–æ–¥ –¥–ª—è Telegram –Ω–∞ —Ä–µ—Å–µ–ø—à–µ–Ω–µ

### Won't Have

- –í–∏–¥–µ–æ
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Ñ–æ—Ç–æ
- –õ–∞–π–∫–∏ / –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
- –ü–æ–∏—Å–∫ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —Ä–µ—Ç—Ä–∏—Ç–∞–º
- Telegram –∫–∞–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–∏—Å–∫–∞ (—Ç–æ–ª—å–∫–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)

---

## –ù–µ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ |
|----------|-----------|
| –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≥–∞–ª–µ—Ä–µ–∏ | < 3 —Å–µ–∫ (thumbnails —á–µ—Ä–µ–∑ CDN) |
| –ü–æ–∏—Å–∫ ¬´–ù–∞–π—Ç–∏ —Å–µ–±—è¬ª | < 3 —Å–µ–∫ (–æ–¥–∏–Ω –≤—ã–∑–æ–≤ Rekognition) |
| Upload 100 —Ñ–æ—Ç–æ | –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, —Å retry |
| –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è 100 —Ñ–æ—Ç–æ | ~50-75 —Å–µ–∫ (5 –±–∞—Ç—á–µ–π –ø–æ 20) |

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è |
|----------|-----------|
| –î–æ—Å—Ç—É–ø –∫ —Ñ–æ—Ç–æ | RLS: —Ç–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–∏ —Ä–µ—Ç—Ä–∏—Ç–∞ |
| –ó–∞–≥—Ä—É–∑–∫–∞/—É–¥–∞–ª–µ–Ω–∏–µ | Permission `upload_photos` |
| AI-—Ç–∞–±–ª–∏—Ü—ã (photo_faces, face_tags) | –ó–∞–ø–∏—Å—å: —Ç–æ–ª—å–∫–æ service_role (Edge Functions) |
| Telegram-–ø—Ä–∏–≤—è–∑–∫–∞ | –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π TOKEN —Å TTL 15 –º–∏–Ω |
| AWS –∫–ª—é—á–∏ | Supabase Edge Function Secrets |

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|---------|
| –ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ | 25 –ú–ë (–±–æ–ª—å—à–µ ‚Äî –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è, —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ —Å–∂–∏–º–∞–µ—Ç —Å–∞–º) |
| –§–æ—Ä–º–∞—Ç—ã | JPEG, PNG (–æ—Å—Ç–∞–ª—å–Ω—ã–µ, –≤–∫–ª—é—á–∞—è HEIC, –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è —Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º) |
| –ú–∞–∫—Å. –ª–∏—Ü –Ω–∞ —Ñ–æ—Ç–æ (Rekognition) | –ò–Ω–¥–µ–∫—Å–∏—Ä—É—é—Ç—Å—è –≤—Å–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ |
| –ú–∏–Ω. —Ä–∞–∑–º–µ—Ä –ª–∏—Ü–∞ (Rekognition) | 80√ó80 px |
| –ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ–∏—Å–∫–∞ | 80% |
| TTL Telegram-—Ç–æ–∫–µ–Ω–∞ | 15 –º–∏–Ω—É—Ç |

---

## –§–∞–∑–∞ 1. –ì–∞–ª–µ—Ä–µ—è (–±–µ–∑ AI)

### 1.1 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (DB)

**–¢–∞–±–ª–∏—Ü–∞ `retreat_photos`:**

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID PK | |
| retreat_id | UUID FK ‚Üí retreats | –†–µ—Ç—Ä–∏—Ç |
| storage_path | TEXT | –ü—É—Ç—å –≤ Supabase Storage: `{retreat_id}/{uuid}.jpg` |
| uploaded_by | UUID FK ‚Üí profiles | –ö—Ç–æ –∑–∞–≥—Ä—É–∑–∏–ª |
| uploaded_at | TIMESTAMPTZ | –ö–æ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–æ |
| width | INT | –®–∏—Ä–∏–Ω–∞ (px) |
| height | INT | –í—ã—Å–æ—Ç–∞ (px) |
| file_size | INT | –†–∞–∑–º–µ—Ä (–±–∞–π—Ç—ã) |
| day_number | INT | –î–µ–Ω—å —Ä–µ—Ç—Ä–∏—Ç–∞ (–¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏) |
| caption | TEXT | –ü–æ–¥–ø–∏—Å—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |
| index_status | TEXT | `pending` / `processing` / `indexed` / `failed` |
| index_error | TEXT | –¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ failed |

**RLS-–ø–æ–ª–∏—Ç–∏–∫–∏:**

- SELECT: —É—á–∞—Å—Ç–Ω–∏–∫–∏ —Ä–µ—Ç—Ä–∏—Ç–∞ (retreat_registrations.status IN ('guest', 'team'))
- INSERT/DELETE: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å permission `upload_photos`
- –°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–±—Ö–æ–¥—è—Ç RLS

### 1.2 Storage (bucket `retreat-photos`)

- Public bucket –≤ Supabase Storage
- –ö–æ–Ω–≤–µ–Ω—Ü–∏—è –ø—É—Ç–µ–π: `{retreat_id}/{uuid}.jpg`
- Thumbnails: CDN Image Transforms (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ –ª–µ—Ç—É, –±–µ–∑ —Ö—Ä–∞–Ω–µ–Ω–∏—è)
- –ö—ç—à: `Cache-Control: max-age=31536000` (1 –≥–æ–¥, —Ñ–æ—Ç–æ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è)

### 1.3 –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ (frontend + Edge Function)

**–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–ü–ï–†–ï–î upload):**

- –î–æ–ø—É—Å—Ç–∏–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPEG, PNG
  - HTML: `<input type="file" accept="image/jpeg,image/png" multiple>`
- –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã (HEIC, BMP, TIFF, GIF, WebP –∏ –ø—Ä.):
  - –§–∞–π–ª –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫—Ä–∞—Å–Ω—ã–º —Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º: ¬´–§–æ—Ä–º–∞—Ç {ext} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ JPEG¬ª
  - –ò—Å–∫–ª—é—á–∞–µ—Ç—Å—è –∏–∑ –∑–∞–≥—Ä—É–∑–∫–∏
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞: **25 –ú–ë** –Ω–∞ —Ñ–∞–π–ª
  - –§–∞–π–ª—ã > 25 –ú–ë –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è —Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º: ¬´{name} —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π ({size} –ú–ë). –°–æ–∂–º–∏—Ç–µ –¥–æ 25 –ú–ë¬ª
  - –§–æ—Ç–æ–≥—Ä–∞—Ñ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —Å–∂–∏–º–∞–µ—Ç —Ñ–æ—Ç–æ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π (Lightroom export, –∫–∞—á–µ—Å—Ç–≤–æ 85-90%)
  - –ö–ª–∏–µ–Ω—Ç—Å–∫–æ–µ —Å–∂–∞—Ç–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è ‚Äî —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –ù–ï –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏

**–ó–∞–≥—Ä—É–∑–∫–∞:**

- –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è (–ø–æ –æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—É ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ –Ω–∞ –ø–ª–æ—Ö–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ)
- –ü—Ä–æ—Å—Ç–æ–π —Å—á—ë—Ç—á–∏–∫: ¬´–ó–∞–≥—Ä—É–∂–µ–Ω–æ 34/100¬ª
- Retry –¥–æ 3 —Ä–∞–∑ —Å exponential backoff –ø—Ä–∏ –æ—à–∏–±–∫–µ
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ –ë–î (width, height, file_size)

**–†–æ–ª—å ¬´–§–æ—Ç–æ–≥—Ä–∞—Ñ¬ª:**

- –û—Ç–¥–µ–ª—å–Ω–∞—è permission `upload_photos` –≤ —Ç–∞–±–ª–∏—Ü–µ permissions
- –ù–µ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî —Ç–æ–ª—å–∫–æ –∑–∞–≥—Ä—É–∑–∫–∞/—É–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ

### 1.4 –ü—Ä–æ—Å–º–æ—Ç—Ä –≥–∞–ª–µ—Ä–µ–∏

- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–æ—Ç–æ –ø–æ retreat_id
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–µ—Ç–∫–æ–π (thumbnails —á–µ—Ä–µ–∑ CDN Image Transforms: width=400)
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–æ –∫–ª–∏–∫—É (–ø–æ–ª–Ω—ã–π —Ä–∞–∑–º–µ—Ä)
- –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ñ–æ—Ç–æ

### 1.5 –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ (–∞–¥–º–∏–Ω)

**–°–ø–æ—Å–æ–± —É–¥–∞–ª–µ–Ω–∏—è: –∂—ë—Å—Ç–∫–æ–µ (hard delete)**

–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: soft delete (deleted_at) —É—Å–ª–æ–∂–Ω—è–µ—Ç –∫–∞—Å–∫–∞–¥ —Å Rekognition –∏ –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–º—ã—Å–ª–∞ –¥–ª—è —Ñ–æ—Ç–æ —Ä–µ—Ç—Ä–∏—Ç–∞. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

**UI:**

- –ö–Ω–æ–ø–∫–∞ ¬´–£–¥–∞–ª–∏—Ç—å¬ª –Ω–∞ —Ñ–æ—Ç–æ + –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
- Bulk delete: –≤—ã–±–æ—Ä –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ ‚Üí ¬´–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (N)¬ª

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤:** permission `upload_photos` (backend, RLS)

**–ö–∞—Å–∫–∞–¥ —É–¥–∞–ª–µ–Ω–∏—è (Edge Function `delete-photos`):**

1. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ face_id –∏–∑ photo_faces –¥–ª—è —É–¥–∞–ª—è–µ–º—ã—Ö —Ñ–æ—Ç–æ
2. Rekognition.DeleteFaces(CollectionId, FaceIds) ‚Äî —É–¥–∞–ª–∏—Ç—å –ª–∏—Ü–∞ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
3. DELETE FROM face_tags WHERE photo_id = ...
4. DELETE FROM photo_faces WHERE photo_id = ... (–∏–ª–∏ CASCADE)
5. DELETE FROM retreat_photos WHERE id = ...
6. supabase.storage.from('retreat-photos').remove([storage_path])

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è:**

- –ï—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ —É–¥–∞–ª—ë–Ω –≤ Storage ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º (—É–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –ë–î, –ª–æ–≥–∏—Ä—É–µ–º warning)
- –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ Storage ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: ¬´–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª {name} –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞. –ó–∞–ø–∏—Å—å –≤ –±–∞–∑–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É¬ª
- –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ Rekognition.DeleteFaces ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º (–ª–∏—Ü–∞-¬´—Å–∏—Ä–æ—Ç—ã¬ª –±–µ–∑–≤—Ä–µ–¥–Ω—ã, –Ω–µ –≤–µ—Ä–Ω—É—Ç—Å—è –≤ –ø–æ–∏—Å–∫ –±–µ–∑ —Ñ–æ—Ç–æ)
- –ö–∞—Å–∫–∞–¥ –ù–ï –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –æ–¥–Ω–æ–≥–æ —à–∞–≥–∞ ‚Äî best-effort cleanup

### –ß–µ–∫–ª–∏—Å—Ç –§–∞–∑—ã 1

**Must Have:**

- [ ] –†–æ–ª—å ¬´–§–æ—Ç–æ–≥—Ä–∞—Ñ¬ª (permission `upload_photos`)
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è: —Ç–∞–±–ª–∏—Ü–∞ `retreat_photos`
- [ ] Supabase Storage bucket `retreat-photos` + RLS
- [ ] RLS –Ω–∞ retreat_photos (—É—á–∞—Å—Ç–Ω–∏–∫–∏ —á–∏—Ç–∞—é—Ç, —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ –ø–∏—à–µ—Ç)
- [ ] Admin: upload.html ‚Äî drag & drop, –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞/—Ä–∞–∑–º–µ—Ä–∞, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å retry
- [ ] Admin: manage.html ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ (–∫–∞—Å–∫–∞–¥ Storage + –ë–î)
- [ ] Guest Portal: –≥–∞–ª–µ—Ä–µ—è —Ñ–æ—Ç–æ —Ä–µ—Ç—Ä–∏—Ç–∞
- [ ] Thumbnails —á–µ—Ä–µ–∑ CDN Image Transforms

**Should Have:**

- [ ] Bulk delete: –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä —Ñ–æ—Ç–æ + ¬´–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (N)¬ª
- [ ] –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ñ–æ—Ç–æ

### –û—Ü–µ–Ω–∫–∞ –§–∞–∑—ã 1

| # | –ó–∞–¥–∞—á–∞ | –¢–∏–ø | –û–±—ã—á–Ω–∞—è (—á) | –ö–∞—Ç. | –ú—É–ª—å—Ç | H+C (—á) | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|---|--------|-----|-------------|------|-------|---------|-------------|
| **Must Have** | | | | | | | |
| 1.1 | Permission `upload_photos` (–º–∏–≥—Ä–∞—Ü–∏—è + JS-–ø—Ä–æ–≤–µ—Ä–∫–∞) | DB+JS | 1.0 | A | 5x | 0.20 | –ü–∞—Ç—Ç–µ—Ä–Ω –ø—Ä–æ–µ–∫—Ç–∞ (Layout.hasPermission) |
| 1.2 | –ú–∏–≥—Ä–∞—Ü–∏—è `retreat_photos` (11 –ø–æ–ª–µ–π, FK, –∏–Ω–¥–µ–∫—Å—ã) | DB | 1.5 | A | 6x | 0.25 | SQL-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –∑–Ω–∞–∫–æ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ |
| 1.3 | Storage bucket `retreat-photos` (Dashboard + policies) | DevOps | 1.5 | D | 1x | 1.50 | –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ Supabase Dashboard |
| 1.4 | RLS –Ω–∞ `retreat_photos` (SELECT —É—á–∞—Å—Ç–Ω–∏–∫–∏, INSERT/DELETE —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ) | DB | 1.5 | A | 5x | 0.30 | SQL policies, –ø–∞—Ç—Ç–µ—Ä–Ω –ø—Ä–æ–µ–∫—Ç–∞ |
| 1.5 | upload.html: drag&drop + –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤/—Ä–∞–∑–º–µ—Ä–∞ (25 –ú–ë) + sequential upload + retry 3x + –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ | Frontend | 3.5 | B | 3x | 1.17 | –ë–µ–∑ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∂–∞—Ç–∏—è ‚Äî —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–∞—Ü–∏—è + upload logic |
| 1.6 | manage.html: UI —Å–µ—Ç–∫–∞ + –æ–¥–∏–Ω–æ—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ + confirm + –∫–∞—Å–∫–∞–¥ (DB + Storage) | Full-stack | 3.0 | B | 3.5x | 0.86 | CRUD + Storage cleanup, –±–µ–∑ Rekognition |
| 1.7 | Guest Portal: –≥–∞–ª–µ—Ä–µ—è (grid + lightbox + —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ä–µ—Ç—Ä–∏—Ç—É) | Frontend | 3.0 | A | 5x | 0.60 | DaisyUI grid, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω |
| 1.8 | CDN Image Transforms (thumbnail –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è + –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è) | DevOps+FE | 1.0 | B | 4x | 0.25 | Supabase CDN ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–∏—á–∞ |
| **Should Have** | | | | | | | |
| 1.9 | Bulk delete: —á–µ–∫–±–æ–∫—Å—ã + toolbar + ¬´–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (N)¬ª | Full-stack | 2.0 | B | 3.5x | 0.57 | UI –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä + batch delete |
| 1.10 | –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ñ–æ—Ç–æ (–∫–Ω–æ–ø–∫–∞ download) | Frontend | 0.5 | A | 8x | 0.06 | –¢—Ä–∏–≤–∏–∞–ª—å–Ω–æ |
| | **–ò—Ç–æ–≥–æ –§–∞–∑–∞ 1** | | **18.5** | | | **4.73** | |
| | **+ 15% overhead (—Ä–µ–≤—å—é, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)** | | | | | **5.4** | |

**–ò—Ç–æ–≥–æ –§–∞–∑–∞ 1: ~18.5 —á–∞—Å–æ–≤ (–æ–±—ã—á–Ω—ã–π dev, 6 –¥–Ω–µ–π) / ~5.4 —á–∞—Å–æ–≤ (Human+Claude, 2 –¥–Ω—è)**

---

## –§–∞–∑–∞ 2. –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ª–∏—Ü (AI)

### 2.1 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è AWS Rekognition

- AWS SDK –≤ Edge Functions (Deno)
- –ö–ª—é—á–∏: Supabase Edge Function Secrets (AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_REGION=ap-south-1)
- IAM user: `srsk-rekognition` (policy: `SrskRekognitionOnly`)
- –°—Ç–∞—Ç—É—Å: **–ì–û–¢–û–í–û** (–Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ 07.02.2026)

### 2.2 –ö–æ–ª–ª–µ–∫—Ü–∏–∏ –ª–∏—Ü –ø–æ —Ä–µ—Ç—Ä–∏—Ç–∞–º

- –û–¥–Ω–∞ –∫–æ–ª–ª–µ–∫—Ü–∏—è –Ω–∞ —Ä–µ—Ç—Ä–∏—Ç: `retreat_{retreat_id}`
- –°–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ index-faces –¥–ª—è —Ä–µ—Ç—Ä–∏—Ç–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è: try CreateCollection, catch AlreadyExists
- AI –≤–∫–ª—é—á—ë–Ω –¥–ª—è –≤—Å–µ—Ö —Ä–µ—Ç—Ä–∏—Ç–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–±–µ–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è)
  - –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: toggle ¬´–≤–∫–ª—é—á–∏—Ç—å AI¬ª —É—Å–ª–æ–∂–Ω—è–µ—Ç UX –±–µ–∑ –ø–æ–ª—å–∑—ã. –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ ‚Äî –µ—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, AI –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### 2.3 –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è —Ñ–æ—Ç–æ (IndexFaces)

**–¢—Ä–∏–≥–≥–µ—Ä:** —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –≤—ã–∑—ã–≤–∞–µ—Ç Edge Function –ø–æ—Å–ª–µ batch upload (–∏–ª–∏ –∫–Ω–æ–ø–∫–∞ ¬´–ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è¬ª –¥–ª—è pending —Ñ–æ—Ç–æ).

**–†–µ—Å–∞–π–∑ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ Rekognition:**

- AWS Rekognition –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º **5 –ú–ë** –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- Edge Function `index-faces` –û–ë–Ø–ó–ê–ù–ê —Ä–µ—Å–∞–π–∑–∏—Ç—å —Ñ–æ—Ç–æ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π:
  1. –°–∫–∞—á–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª –∏–∑ Storage
  2. –ï—Å–ª–∏ file_size > 4.5 –ú–ë ‚Äî —Ä–µ—Å–∞–π–∑–∏—Ç—å –¥–æ max 2048px –ø–æ –¥–ª–∏–Ω–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ (–∫–∞—á–µ—Å—Ç–≤–æ 85%)
  3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ—Å–∞–π–∑–Ω—É—Ç–æ–µ –≤ Rekognition
  4. –û—Ä–∏–≥–∏–Ω–∞–ª –≤ Storage –ù–ï —Ç—Ä–æ–≥–∞—Ç—å (—Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å)
- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–µ—Å–∞–π–∑–∞ –≤ Deno: `sharp` (—á–µ—Ä–µ–∑ npm:sharp) –∏–ª–∏ `imagescript`

**–ë–∞—Ç—á–∏–Ω–≥:**

- –ë–∞—Ç—á–∏ –ø–æ 20 —Ñ–æ—Ç–æ (Sequential, –Ω–µ Parallel)
- –ö–∞–∂–¥—ã–π –±–∞—Ç—á ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ Edge Function (~10-15 —Å–µ–∫)
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ –≤—ã–∑—ã–≤–∞–µ—Ç –≤ —Ü–∏–∫–ª–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å
- –§–æ—Ç–æ–≥—Ä–∞—Ñ –ù–ï –æ–±—è–∑–∞–Ω –∂–¥–∞—Ç—å ‚Äî –º–æ–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É

**Retry + backoff –¥–ª—è Rekognition API:**

- –ü—Ä–∏ –æ—à–∏–±–∫–µ AWS (ThrottlingException, InternalServerError) ‚Äî retry –¥–æ 3 —Ä–∞–∑
- Backoff: 1—Å ‚Üí 2—Å ‚Üí 4—Å (exponential)
- –ü—Ä–∏ ProvisionedThroughputExceededException ‚Äî backoff 5—Å ‚Üí 10—Å ‚Üí 20—Å
- –ü—Ä–∏ InvalidImageFormatException ‚Äî –ø–æ–º–µ—Ç–∏—Ç—å —Ñ–æ—Ç–æ –∫–∞–∫ `failed`, –Ω–µ —Ä–µ—Ç—Ä–∞–∏—Ç—å

**–ß—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º:**

| –¢–∞–±–ª–∏—Ü–∞ | –ü–æ–ª—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|------|----------|
| photo_faces | photo_id, rekognition_face_id, bbox_x/y/w/h | –°–≤—è–∑—å —Ñ–æ—Ç–æ ‚Üî –ª–∏—Ü–æ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ |
| retreat_photos.index_status | pending ‚Üí processing ‚Üí indexed / failed | –°—Ç–∞—Ç—É—Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ |
| retreat_photos.index_error | TEXT | –¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ failed |

### 2.4 –ü–æ–∏—Å–∫ —Å–µ–±—è (SearchFacesByImage)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:**

–ù–∞–∂–∏–º–∞–µ—Ç ¬´–ù–∞–π—Ç–∏ —Å–µ–±—è¬ª –≤ Guest Portal.

**–ò—Å—Ç–æ—á–Ω–∏–∫ —Ñ–æ—Ç–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ ‚Äî 3 —É—Ä–æ–≤–Ω—è fallback:**

1. **–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è** (vaishnava-photos bucket) ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
2. **–°–µ–ª—Ñ–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å** ‚Äî –µ—Å–ª–∏ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ—Ç:
   - –ú–æ–±–∏–ª—å–Ω—ã–π: `<input type="file" accept="image/*" capture="user">`
   - –î–µ—Å–∫—Ç–æ–ø: –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
   - –§–æ—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ (–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª—å, –µ—Å–ª–∏ –≥–æ—Å—Ç—å –Ω–µ —Ö–æ—á–µ—Ç)
3. **–ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏** ‚Äî –∫–Ω–æ–ø–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞, –ø–æ–¥—Å–∫–∞–∑–∫–∞: ¬´–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è, —á—Ç–æ–±—ã AI –º–æ–≥ –Ω–∞–π—Ç–∏ –≤–∞—Å –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è—Ö —Ä–µ—Ç—Ä–∏—Ç–∞¬ª

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞ (Edge Function `search-face`):**

1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–æ—Ç–æ –≥–æ—Å—Ç—è –∏–∑ Storage (–∏–ª–∏ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ —Å–µ–ª—Ñ–∏)
2. –†–µ—Å–∞–π–∑ –µ—Å–ª–∏ > 4.5 –ú–ë (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ index-faces)
3. Rekognition.SearchFacesByImage(CollectionId=retreat_{id}, FaceMatchThreshold=80, MaxFaces=100)
4. –ü–æ FaceId ‚Üí JOIN photo_faces ‚Üí photo_id
5. UPSERT –≤ face_tags (ON CONFLICT DO UPDATE SET confidence)
6. INSERT –≤ face_search_log
7. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç { matched_photo_ids, total }

**–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:** 1-2 —Å–µ–∫—É–Ω–¥—ã (–æ–¥–∏–Ω –≤—ã–∑–æ–≤ Rekognition)

**–ü—Ä–∏ 0 —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π:** –ø–æ–¥—Å–∫–∞–∑–∫–∞ ¬´–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ (–∫—Ä—É–ø–Ω—ã–π –ø–ª–∞–Ω –ª–∏—Ü–∞, —Ö–æ—Ä–æ—à–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ)¬ª

### 2.5 –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (face_tags)

**–¢–∞–±–ª–∏—Ü–∞ `face_tags`:**

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID PK | |
| photo_id | UUID FK ‚Üí retreat_photos | –§–æ—Ç–æ |
| vaishnava_id | UUID FK ‚Üí vaishnavas | –ì–æ—Å—Ç—å |
| confidence | FLOAT | –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å AI (0-1) |
| bbox_x, bbox_y, bbox_w, bbox_h | FLOAT | –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ª–∏—Ü–∞ (%) |
| created_at | TIMESTAMPTZ | |
| UNIQUE | (photo_id, vaishnava_id) | –û–¥–∏–Ω —á–µ–ª–æ–≤–µ–∫ –Ω–∞ —Ñ–æ—Ç–æ = –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å |

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **upsert** (ON CONFLICT DO UPDATE SET confidence)
- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–∏—Å–∫–µ ‚Äî —Å–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–ø–∏—Å—å
- –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è confidence

### –ß–µ–∫–ª–∏—Å—Ç –§–∞–∑—ã 2

**Must Have:**

- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è: —Ç–∞–±–ª–∏—Ü—ã `photo_faces`, `face_tags`
- [ ] Edge Function `index-faces` (—Ä–µ—Å–∞–π–∑ >4.5 –ú–ë, –±–∞—Ç—á–∏ –ø–æ 20, retry —Å backoff)
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–π `retreat_{id}` (auto-create –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ)
- [ ] Edge Function `search-face` (SearchFacesByImage, threshold 80%)
- [ ] UPSERT face_tags (ON CONFLICT DO UPDATE SET confidence)
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ¬´–ù–∞–π—Ç–∏ —Å–µ–±—è¬ª –≤ Guest Portal (–æ—Å–Ω–æ–≤–Ω–æ–π flow: —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è)
- [ ] –ö–∞—Å–∫–∞–¥ —É–¥–∞–ª–µ–Ω–∏—è: DeleteFaces –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ

**Should Have:**

- [ ] Fallback: –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è –≥–æ—Å—Ç–µ–π –±–µ–∑ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è

### –û—Ü–µ–Ω–∫–∞ –§–∞–∑—ã 2

| # | –ó–∞–¥–∞—á–∞ | –¢–∏–ø | –û–±—ã—á–Ω–∞—è (—á) | –ö–∞—Ç. | –ú—É–ª—å—Ç | H+C (—á) | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|---|--------|-----|-------------|------|-------|---------|-------------|
| **Must Have** | | | | | | | |
| 2.1 | –ú–∏–≥—Ä–∞—Ü–∏—è `photo_faces` + `face_tags` (2 —Ç–∞–±–ª–∏—Ü—ã, FK, UNIQUE) | DB | 1.5 | A | 6x | 0.25 | SQL-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è |
| 2.2 | EF `index-faces` (—Å–∫–∞—á–∞—Ç—å ‚Üí —Ä–µ—Å–∞–π–∑ sharp ‚Üí IndexFaces √ó 20 ‚Üí retry backoff ‚Üí status update) | Backend | 5.0 | B | 3x | 1.67 | –°–∞–º–∞—è —Å–ª–æ–∂–Ω–∞—è EF: resize + AWS + retry + batch |
| 2.3 | –ö–æ–ª–ª–µ–∫—Ü–∏–∏ `retreat_{id}` (CreateCollection, catch AlreadyExists) | Backend | 1.0 | A | 6x | 0.17 | –¢—Ä–∏–≤–∏–∞–ª—å–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞ |
| 2.4 | EF `search-face` (–∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ ‚Üí —Ä–µ—Å–∞–π–∑ ‚Üí SearchFacesByImage ‚Üí JOIN ‚Üí upsert) | Backend | 3.5 | B | 3x | 1.17 | AWS –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è + DB upsert |
| 2.5 | UPSERT face_tags (ON CONFLICT –º–∏–≥—Ä–∞—Ü–∏—è) | DB | 0.5 | A | 6x | 0.08 | –û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ SQL |
| 2.6 | Guest Portal ¬´–ù–∞–π—Ç–∏ —Å–µ–±—è¬ª (–∫–Ω–æ–ø–∫–∞ ‚Üí –≤—ã–∑–æ–≤ EF ‚Üí –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Üí —Ñ–∏–ª—å—Ç—Ä) | Frontend | 3.0 | B | 3.5x | 0.86 | UI + API + —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è |
| 2.7 | –ö–∞—Å–∫–∞–¥: –¥–æ–±–∞–≤–∏—Ç—å DeleteFaces –≤ EF `delete-photos` | Backend | 1.5 | B | 4x | 0.38 | –î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π EF |
| **Should Have** | | | | | | | |
| 2.8 | Fallback: –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ (input file, temp upload, –ø–æ–∏—Å–∫) | Frontend | 1.0 | A | 5x | 0.20 | –ü—Ä–æ—Å—Ç–æ–π input + fetch –∫ search-face |
| | **–ò—Ç–æ–≥–æ –§–∞–∑–∞ 2** | | **17.0** | | | **3.98** | |
| | **+ 15% overhead** | | | | | **4.6** | |

**–ò—Ç–æ–≥–æ –§–∞–∑–∞ 2: ~17 —á–∞—Å–æ–≤ (–æ–±—ã—á–Ω—ã–π dev, 6 –¥–Ω–µ–π) / ~4.6 —á–∞—Å–æ–≤ (Human+Claude, 1.5 –¥–Ω—è)**

---

## –§–∞–∑–∞ 3. Telegram (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è) ‚Äî Should Have

### 3.1 Telegram-–±–æ—Ç –∏ webhook

- –ë–æ—Ç: @rupaseva_bot (–∏–ª–∏ –∞–Ω–∞–ª–æ–≥), —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ @BotFather
- Webhook: Edge Function `telegram-webhook`
- –ö–æ–º–∞–Ω–¥—ã: `/start TOKEN`, `/stop`
- **–†–µ—Ñ–µ—Ä–µ–Ω—Å –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤:** Claude Code skill `telegram-bot` (skills/telegram-bot/SKILL.md) ‚Äî send_with_retry, deep link token, broadcast —Å rate limiting, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ 403/429, splitting –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è LLM-–∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è, –∞–≤—Ç–æ–æ–±—É—á–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º

### 3.2 –ü—Ä–∏–≤—è–∑–∫–∞ Telegram –∫ –≥–æ—Å—Ç—é (/start TOKEN)

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–∏–≤—è–∑–∫–∏: –ø–æ–ª–µ –≤ vaishnavas (–Ω–µ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞)**

–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `telegram_links` (–∏–∑ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –§–¢) –∏–∑–±—ã—Ç–æ—á–Ω–∞ –¥–ª—è MVP. –û–¥–∏–Ω –≥–æ—Å—Ç—å = –æ–¥–∏–Ω Telegram-—á–∞—Ç. –ü–æ–ª–µ `vaishnavas.telegram_chat_id` –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.

–ï—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è: –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–æ—Ç–æ–≤, –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–∏–≤—è–∑–æ–∫, is_active/linked_at ‚Äî —Ç–æ–≥–¥–∞ –≤—ã–Ω–æ—Å–∏—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É.

**–ù–æ–≤–æ–µ –ø–æ–ª–µ:**

```sql
ALTER TABLE vaishnavas ADD COLUMN telegram_chat_id BIGINT;
```

**–¢–∞–±–ª–∏—Ü–∞ —Ç–æ–∫–µ–Ω–æ–≤ `telegram_link_tokens`:**

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID PK | |
| token | UUID UNIQUE | –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π —Ç–æ–∫–µ–Ω |
| vaishnava_id | UUID FK ‚Üí vaishnavas | –ö–æ–º—É –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç |
| expires_at | TIMESTAMPTZ | TTL 15 –º–∏–Ω—É—Ç |
| used | BOOLEAN | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ª–∏ |
| used_at | TIMESTAMPTZ | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω (–¥–ª—è –∞—É–¥–∏—Ç–∞) |
| created_at | TIMESTAMPTZ | |

**Flow:**

1. –ì–æ—Å—Ç—å –≤ Guest Portal –Ω–∞–∂–∏–º–∞–µ—Ç ¬´–ü–æ–¥–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è¬ª
2. –§—Ä–æ–Ω—Ç–µ–Ω–¥ —Å–æ–∑–¥–∞—ë—Ç —Ç–æ–∫–µ–Ω (INSERT INTO telegram_link_tokens, expires_at = now() + 15 –º–∏–Ω)
3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Å—ã–ª–∫—É: `https://t.me/rupaseva_bot?start=TOKEN`
4. –ì–æ—Å—Ç—å –Ω–∞–∂–∏–º–∞–µ—Ç ‚Üí Telegram ‚Üí `/start TOKEN`
5. Webhook (Edge Function):
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç telegram_user_id, chat_id, username, —Ç–µ–∫—Å—Ç `/start TOKEN`
   - –í–∞–ª–∏–¥–∞—Ü–∏—è: —Ç–æ–∫–µ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç AND expires_at > now() AND used = false
   - –ï—Å–ª–∏ –≤–∞–ª–∏–¥–µ–Ω: UPDATE vaishnavas SET telegram_chat_id = chat_id; UPDATE tokens SET used = true, used_at = now()
   - –û—Ç–≤–µ—Ç –±–æ—Ç–∞: ¬´–ü—Ä–∏–≤–µ—Ç, {spiritual_name}! –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω—ã¬ª
6. Guest Portal –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç ¬´–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω—ã¬ª (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç telegram_chat_id IS NOT NULL)

**–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:**

- –ü–æ–≤—Ç–æ—Ä–Ω—ã–π `/start` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º ‚Üí ¬´–≠—Ç–æ—Ç —Ç–æ–∫–µ–Ω —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ—Ä—Ç–∞–ª –¥–ª—è –Ω–æ–≤–æ–π —Å—Å—ã–ª–∫–∏¬ª
- –ì–æ—Å—Ç—å —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω + –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω ‚Üí –ø–µ—Ä–µ–ø—Ä–∏–≤—è–∑–∫–∞ (–æ–±–Ω–æ–≤–ª—è–µ–º chat_id), –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º
- –û–¥–∏–Ω Telegram ‚Üí –¥–≤–∞ –≥–æ—Å—Ç—è ‚Üí —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–ø—Ä–∏–≤—è–∑–∫—É (–ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–æ–∫–µ–Ω –ø–æ–±–µ–∂–¥–∞–µ—Ç), –ª–æ–≥–∏—Ä—É–µ–º

### 3.3 –û—Ç–ø–∏—Å–∫–∞ (/stop)

- –ì–æ—Å—Ç—å –ø–∏—à–µ—Ç `/stop` –±–æ—Ç—É ‚Üí UPDATE vaishnavas SET telegram_chat_id = NULL
- –ò–ª–∏ –≤ Guest Portal: –∫–Ω–æ–ø–∫–∞ ¬´–û—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è¬ª ‚Üí —Ç–æ—Ç –∂–µ UPDATE
- –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç: ¬´–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã. –í—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∏—Ö —Å–Ω–æ–≤–∞ –≤ Guest Portal¬ª

### 3.4 –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–¢–∏–ø—ã:**

1. ¬´–ù–æ–≤—ã–µ —Ñ–æ—Ç–æ —Å —Ä–µ—Ç—Ä–∏—Ç–∞!¬ª ‚Äî –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–æ–º (–ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è upload)
2. ¬´–ú—ã –Ω–∞—à–ª–∏ –≤–∞—Å –Ω–∞ N —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è—Ö! –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å ‚Üí¬ª ‚Äî –ø–æ—Å–ª–µ SearchFacesByImage (–µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è)

**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:** —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ + —Å—Å—ã–ª–∫–∞ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é –≤ Guest Portal

**Edge Function `send-notification`:**

- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç: retreat_id, —Ç–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —Å–ø–∏—Å–æ–∫ chat_id
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ Telegram Bot API (sendMessage)
- Rate limit: –Ω–µ –±–æ–ª–µ–µ 30 —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫ (–ª–∏–º–∏—Ç Telegram)

### 3.5 –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω ‚Üí –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- `/start` –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ ‚Üí ¬´–î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Guest Portal¬ª
- Telegram API rate limit ‚Üí retry —Å backoff (1—Å ‚Üí 2—Å ‚Üí 4—Å)
- Chat not found (–≥–æ—Å—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞) ‚Üí –ø–æ–º–µ—Ç–∏—Ç—å telegram_chat_id = NULL, –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å

### –ß–µ–∫–ª–∏—Å—Ç –§–∞–∑—ã 3

**Should Have (–≤—Å—è —Ñ–∞–∑–∞):**

- [ ] –ë–æ—Ç @rupaseva_bot: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ @BotFather, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∞–Ω–¥
- [ ] Edge Function `telegram-webhook` (webhook –ø—Ä–∏—ë–º + –≤–∞–ª–∏–¥–∞—Ü–∏—è)
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è: –ø–æ–ª–µ `vaishnavas.telegram_chat_id`, —Ç–∞–±–ª–∏—Ü–∞ `telegram_link_tokens`
- [ ] /start TOKEN ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞, deep link, –ø—Ä–∏–≤—è–∑–∫–∞ chat_id
- [ ] /stop ‚Äî –æ—Ç–ø–∏—Å–∫–∞ (SET telegram_chat_id = NULL)
- [ ] Edge Function `send-notification` (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π, rate limit 30/—Å–µ–∫)
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ¬´–ù–æ–≤—ã–µ —Ñ–æ—Ç–æ!¬ª –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏, ¬´–ù–∞–π–¥–µ–Ω—ã —Ñ–æ—Ç–æ —Å –≤–∞–º–∏!¬ª –ø–æ—Å–ª–µ –ø–æ–∏—Å–∫–∞
- [ ] Guest Portal: –∫–Ω–æ–ø–∫–∏ ¬´–ü–æ–¥–∫–ª—é—á–∏—Ç—å¬ª / ¬´–û—Ç–∫–ª—é—á–∏—Ç—å¬ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫: –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π/–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–æ—Ç

### –û—Ü–µ–Ω–∫–∞ –§–∞–∑—ã 3

| # | –ó–∞–¥–∞—á–∞ | –¢–∏–ø | –û–±—ã—á–Ω–∞—è (—á) | –ö–∞—Ç. | –ú—É–ª—å—Ç | H+C (—á) | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|---|--------|-----|-------------|------|-------|---------|-------------|
| **Should Have (–≤—Å—è —Ñ–∞–∑–∞)** | | | | | | | |
| 3.1 | –ë–æ—Ç @rupaseva_bot (BotFather, –∫–æ–º–∞–Ω–¥—ã, webhook URL) | DevOps | 1.0 | D | 1x | 1.00 | –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ Telegram |
| 3.2 | EF `telegram-webhook` (–ø–∞—Ä—Å–∏–Ω–≥ update, —Ä–æ—É—Ç–∏–Ω–≥ /start /stop) | Backend | 1.5 | B | 3.5x | 0.43 | –ü–∞—Ç—Ç–µ—Ä–Ω webhook –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ |
| 3.3 | –ú–∏–≥—Ä–∞—Ü–∏—è: `telegram_chat_id` + `telegram_link_tokens` | DB | 1.0 | A | 6x | 0.17 | SQL-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è |
| 3.4 | /start TOKEN (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –≤–∞–ª–∏–¥–∞—Ü–∏—è TTL, –ø—Ä–∏–≤—è–∑–∫–∞, –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, edge cases) | Backend | 2.5 | B | 3x | 0.83 | Token flow, –Ω–æ –±–æ—Ç-–ø–∞—Ç—Ç–µ—Ä–Ω –≥–æ—Ç–æ–≤ |
| 3.5 | /stop –æ—Ç–ø–∏—Å–∫–∞ (SET telegram_chat_id = NULL) | Backend | 0.5 | A | 6x | 0.08 | –¢—Ä–∏–≤–∏–∞–ª—å–Ω–æ |
| 3.6 | EF `send-notification` (sendMessage, rate limit 30/—Å–µ–∫, batch) | Backend | 1.5 | B | 3.5x | 0.43 | sendMessage –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ + throttling |
| 3.7 | –¢—Ä–∏–≥–≥–µ—Ä—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å index-faces –∏ search-face) | Backend | 1.5 | B | 3x | 0.50 | –í—ã–∑–æ–≤ send-notification –∏–∑ –¥—Ä—É–≥–∏—Ö EF |
| 3.8 | Guest Portal: ¬´–ü–æ–¥–∫–ª—é—á–∏—Ç—å¬ª / ¬´–û—Ç–∫–ª—é—á–∏—Ç—å¬ª (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞, deep link, —Å—Ç–∞—Ç—É—Å) | Frontend | 2.0 | B | 3.5x | 0.57 | UI + API –≤—ã–∑–æ–≤—ã |
| 3.9 | –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π/–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω, blocked bot, retry) | Backend | 1.5 | C | 2x | 0.75 | –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ edge cases |
| | **–ò—Ç–æ–≥–æ –§–∞–∑–∞ 3** | | **12.0** | | | **4.54** | |
| | **+ 15% overhead** | | | | | **5.2** | |

**–ò—Ç–æ–≥–æ –§–∞–∑–∞ 3: ~12 —á–∞—Å–æ–≤ (–æ–±—ã—á–Ω—ã–π dev, 4 –¥–Ω—è) / ~5.2 —á–∞—Å–æ–≤ (Human+Claude, 2 –¥–Ω—è)**

---

## –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ (Must Have + Should Have)

**–ú–µ—Ç–æ–¥–∏–∫–∞:** –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –ø–æ –∑–∞–¥–∞—á–∞–º ‚Üí –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ AI-–ø—Ä–∏–≥–æ–¥–Ω–æ—Å—Ç–∏ (A/B/C/D) ‚Üí –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä—ã ‚Üí overhead 15%

| –§–∞–∑–∞ | –ó–∞–¥–∞—á | –û–±—ã—á–Ω—ã–π dev | Human + Claude | –ú—É–ª—å—Ç | –î–Ω–µ–π (3 —á/–¥–µ–Ω—å) |
|------|-------|-----------|----------------|-------|-----------------|
| –§–∞–∑–∞ 1 ‚Äî –ì–∞–ª–µ—Ä–µ—è | 10 | 18.5 —á | 5.4 —á | 3.4x | 6 / 2 |
| –§–∞–∑–∞ 2 ‚Äî Face Recognition | 8 | 17.0 —á | 4.6 —á | 3.7x | 6 / 1.5 |
| –§–∞–∑–∞ 3 ‚Äî Telegram | 9 | 12.0 —á | 5.2 —á | 2.3x | 4 / 2 |
| **–ò—Ç–æ–≥–æ** | **27** | **47.5 —á** | **15.2 —á** | **3.1x** | **16 / 5** |

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π –æ—Ü–µ–Ω–∫–∏

| | v1.3 | v1.4 | v1.5 | v1.6 (—Ç–µ–∫—É—â–∞—è) |
|--|------|------|------|----------------|
| –û–±—ã—á–Ω—ã–π dev | 35‚Äì47 —á | 61.5 —á | 52.5 —á | 47.5 —á |
| Human + Claude | 14.8 —á | 23.3 —á | 16.9 —á | **15.2 —á** |
| –î–Ω–µ–π (H+C, 3 —á/–¥–µ–Ω—å) | ~5 | 7.5-8.5 | ~5.5 | **~5** |

### –ß—Ç–æ —É–ø—Ä–æ—â–µ–Ω–æ –≤ v1.5 (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ v1.4)

1. **–£–±—Ä–∞–Ω–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–Ω—è–º** ‚Üí Could Have (—Ñ–æ—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å–ø–∏—Å–∫–æ–º, –≥–æ—Å—Ç–∏ –∏—â—É—Ç —Å–µ–±—è —á–µ—Ä–µ–∑ AI)
2. **–£–±—Ä–∞–Ω –ø—Ä–æ–≥—Ä–µ—Å—Å–±–∞—Ä –∑–∞–≥—Ä—É–∑–∫–∏** ‚Üí –ø—Ä–æ—Å—Ç–æ–π —Å—á—ë—Ç—á–∏–∫ ¬´34/100¬ª –≤ —Å–æ—Å—Ç–∞–≤–µ upload.html
3. **–£–±—Ä–∞–Ω–∞ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è** ‚Üí Could Have (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ‚Äî —Ä—É–∫–∞–º–∏ —á–µ—Ä–µ–∑ SQL/API)
4. **–£–±—Ä–∞–Ω –ø—Ä–æ–≥—Ä–µ—Å—Å–±–∞—Ä –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏** ‚Üí Could Have (—Å—Ç–∞—Ç—É—Å –≤–∏–¥–Ω–æ –≤ manage.html)
5. **–£–ø—Ä–æ—â—ë–Ω fallback-—Å–µ–ª—Ñ–∏** ‚Üí –ø—Ä–æ—Å—Ç–æ `<input type="file">` –±–µ–∑ –∫–∞–º–µ—Ä—ã
6. **–ê–≤—Ç–æ-—Å–∂–∞—Ç–∏–µ –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è** ‚Üí —Å–∂–∏–º–∞–µ—Ç –º–æ–ª—á–∞, –Ω–µ —Å–∂–∞–ª–æ—Å—å ‚Üí –æ—Ç–∫–ª–æ–Ω—è–µ—Ç
7. **Overhead —Å–Ω–∏–∂–µ–Ω —Å 20% –¥–æ 15%** ‚Äî –æ–¥–∏–Ω –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å, –±–µ–∑ –≤–Ω–µ—à–Ω–µ–≥–æ —Ä–µ–≤—å—é

### –ß—Ç–æ —É–ø—Ä–æ—â–µ–Ω–æ –≤ v1.6 (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ v1.5)

1. **–£–±—Ä–∞–Ω HEIC** ‚Üí —Ç–æ–ª—å–∫–æ JPEG/PNG. HEIC —Ç—Ä–µ–±—É–µ—Ç polyfill –¥–ª—è Canvas API, –Ω–µ —Å—Ç–æ–∏—Ç —É—Å–∏–ª–∏–π
2. **–£–±—Ä–∞–Ω–æ –∞–≤—Ç–æ-—Å–∂–∞—Ç–∏–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ** ‚Üí —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ —Å–∂–∏–º–∞–µ—Ç —Å–∞–º (Lightroom export 85-90%). –õ–∏–º–∏—Ç –ø–æ–¥–Ω—è—Ç –¥–æ 25 –ú–ë
3. **Telegram-–±–æ—Ç –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞** ‚Üí –ø–∞—Ç—Ç–µ—Ä–Ω webhook + sendMessage –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–µ –ø–∏—à–µ—Ç—Å—è —Å –Ω—É–ª—è
4. **Supabase Pro –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω** ‚Üí CDN Image Transforms –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã

### –î–æ–ø—É—â–µ–Ω–∏—è

1. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –∑–Ω–∞–∫–æ–º —Å–æ —Å—Ç–µ–∫–æ–º –ø—Ä–æ–µ–∫—Ç–∞ (Supabase, Vanilla JS, DaisyUI)
2. AWS Rekognition SDK –∏ –∫–ª—é—á–∏ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: 07.02.2026)
3. –î–æ—Å—Ç—É–ø—ã –∫ Supabase Dashboard, AWS Console, Telegram BotFather –ø–æ–ª—É—á–µ–Ω—ã
4. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã (—ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç), scope –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è
5. Code review –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç —Ç—Ä–µ—Ç—å–∏—Ö –ª–∏—Ü

### –ß—Ç–æ –ù–ï –≤—Ö–æ–¥–∏—Ç –≤ –æ—Ü–µ–Ω–∫—É

- –û–±—â–µ–Ω–∏–µ —Å –∑–∞–∫–∞–∑—á–∏–∫–æ–º –∏ —É—Ç–æ—á–Ω–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
- –û–∂–∏–¥–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–≤ –∏ –∫–ª—é—á–µ–π –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- –†–µ–≤—å—é –æ—Ç –¥—Ä—É–≥–∏—Ö —á–ª–µ–Ω–æ–≤ –∫–æ–º–∞–Ω–¥—ã
- –î–∏–∑–∞–π–Ω UI (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å—Ç–∏–ª—å –ø—Ä–æ–µ–∫—Ç–∞ DaisyUI)
- E2E —Ç–µ—Å—Ç—ã (Playwright)

### –†–∏—Å–∫–∏

| –†–∏—Å–∫ | –í–ª–∏—è–Ω–∏–µ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|---------|-----------|
| –õ–∏–º–∏—Ç—ã AWS Rekognition (free tier: 5000 IndexFaces/–º–µ—Å) | –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –æ–ø–ª–∞—Ç–∞ –ø—Ä–∏ >5 —Ä–µ—Ç—Ä–∏—Ç–∞—Ö/–º–µ—Å | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç—ã –∑–∞—Ä–∞–Ω–µ–µ, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ usage |
| sharp –≤ Deno Edge Functions | –ú–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω—É–∂–Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ | –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: imagescript –∏–ª–∏ Canvas API –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ |
| Telegram rate limits (30 msg/sec) | –ó–∞–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏ >30 –ø–æ–¥–ø–∏—Å—á–∏–∫–∞—Ö | –û—á–µ—Ä–µ–¥—å + throttling –≤ send-notification |
| –ë–æ–ª—å—à–∏–µ —Ñ–æ—Ç–æ (>25 –ú–ë, RAW) | –§–æ—Ç–æ–≥—Ä–∞—Ñ –∑–∞–±—É–¥–µ—Ç —Å–∂–∞—Ç—å | –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ + –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—É: ¬´–≠–∫—Å–ø–æ—Ä—Ç –∏–∑ Lightroom, –∫–∞—á–µ—Å—Ç–≤–æ 85-90%¬ª |
| –ù–µ—Ç–æ—á–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ (confidence <80%) | –ñ–∞–ª–æ–±—ã –≥–æ—Å—Ç–µ–π ¬´–º–µ–Ω—è –Ω–µ –Ω–∞—à–ª–∏¬ª | –ü–æ–¥—Å–∫–∞–∑–∫–∞ ¬´–¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ¬ª, –∫–Ω–æ–ø–∫–∞ ¬´—ç—Ç–æ –Ω–µ —è¬ª (Could Have) |

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ A. Supabase Storage ‚Äî –¥–µ—Ç–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### A.1 Bucket `retreat-photos`

**–¢–∏–ø:** Public bucket (—Ñ–æ—Ç–æ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–µ, –∫–æ–Ω—Ç—Ä–æ–ª—å —á–µ—Ä–µ–∑ RLS –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ `retreat_photos`)

**–°–æ–∑–¥–∞–Ω–∏–µ bucket (Supabase Dashboard ‚Üí Storage ‚Üí New Bucket):**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|---------|
| Name | `retreat-photos` |
| Public | Yes |
| File size limit | 25 MB (25600000 bytes) |
| Allowed MIME types | `image/jpeg, image/png` |

**–ö–æ–Ω–≤–µ–Ω—Ü–∏—è –ø—É—Ç–µ–π:**

```
retreat-photos/
  {retreat_id}/
    {uuid}.jpg        ‚Üê –æ—Ä–∏–≥–∏–Ω–∞–ª (–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–æ–º)
```

–ü—Ä–∏–º–µ—Ä: `retreat-photos/a1b2c3d4-e5f6-7890-abcd-ef1234567890/f47ac10b-58cc-4372-a567-0e02b2c3d479.jpg`

### A.2 Storage RLS Policies

**–í–∞–∂–Ω–æ:** Public bucket –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç SELECT (—á—Ç–µ–Ω–∏–µ) –±–µ–∑ RLS. –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É —Ñ–æ—Ç–æ ‚Äî —á–µ—Ä–µ–∑ RLS –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ `retreat_photos` (—É—á–∞—Å—Ç–Ω–∏–∫–∏ —Ä–µ—Ç—Ä–∏—Ç–∞). Storage RLS –Ω—É–∂–µ–Ω –¥–ª—è –∑–∞–ø–∏—Å–∏/—É–¥–∞–ª–µ–Ω–∏—è.

```sql
-- –ü–æ–ª–∏—Ç–∏–∫–∞: –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ (INSERT)
-- –¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å permission upload_photos
CREATE POLICY "–§–æ—Ç–æ–≥—Ä–∞—Ñ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–æ—Ç–æ"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'retreat-photos'
  AND EXISTS (
    SELECT 1 FROM permissions
    WHERE user_id = auth.uid()
    AND permission = 'upload_photos'
  )
);

-- –ü–æ–ª–∏—Ç–∏–∫–∞: —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ (DELETE)
-- –¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å permission upload_photos
CREATE POLICY "–§–æ—Ç–æ–≥—Ä–∞—Ñ —É–¥–∞–ª—è–µ—Ç —Ñ–æ—Ç–æ"
ON storage.objects FOR DELETE
TO authenticated
USING (
  bucket_id = 'retreat-photos'
  AND EXISTS (
    SELECT 1 FROM permissions
    WHERE user_id = auth.uid()
    AND permission = 'upload_photos'
  )
);
```

### A.3 CDN Image Transforms (thumbnails)

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** Supabase Pro Plan (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω)

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:** Supabase –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –ª–µ—Ç—É –ø–æ –ø–µ—Ä–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É, –¥–∞–ª–µ–µ –∫–µ—à–∏—Ä—É–µ—Ç –≤ CDN (285+ –≥–æ—Ä–æ–¥–æ–≤).

**–ü–æ–ª—É—á–µ–Ω–∏–µ URL –º–∏–Ω–∏–∞—Ç—é—Ä—ã (JS SDK):**

```javascript
// Thumbnail 400px –¥–ª—è —Å–µ—Ç–∫–∏ –≥–∞–ª–µ—Ä–µ–∏
const { data } = Layout.db.storage
  .from('retreat-photos')
  .getPublicUrl(`${retreatId}/${photoUuid}.jpg`, {
    transform: {
      width: 400,
      quality: 80,
      resize: 'cover'
    }
  });
// data.publicUrl ‚Üí https://{project}.supabase.co/storage/v1/render/image/public/retreat-photos/{path}?width=400&quality=80&resize=cover

// –ü–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω–æ–µ —Ñ–æ—Ç–æ (–±–µ–∑ transform)
const { data: full } = Layout.db.storage
  .from('retreat-photos')
  .getPublicUrl(`${retreatId}/${photoUuid}.jpg`);
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã transform:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|---------|----------|
| `width` | 400 | –®–∏—Ä–∏–Ω–∞ thumbnail (px) |
| `quality` | 80 | –ö–∞—á–µ—Å—Ç–≤–æ JPEG (1-100) |
| `resize` | `cover` | –†–µ–∂–∏–º: `cover` (–æ–±—Ä–µ–∑–∫–∞), `contain` (–≤–ø–∏—Å–∞—Ç—å), `fill` (—Ä–∞—Å—Ç—è–Ω—É—Ç—å) |

**–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:** `Cache-Control: public, max-age=31536000` (1 –≥–æ–¥). –§–æ—Ç–æ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏.

### A.4 Upload –≤ Storage (JS)

```javascript
// –ó–∞–≥—Ä—É–∑–∫–∞ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ Storage
const filePath = `${retreatId}/${crypto.randomUUID()}.jpg`;
const { data, error } = await Layout.db.storage
  .from('retreat-photos')
  .upload(filePath, file, {
    contentType: file.type,
    cacheControl: '31536000',  // 1 –≥–æ–¥
    upsert: false              // –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å
  });

if (error) throw error;
// data.path ‚Üí –ø—É—Ç—å –≤ bucket
```

**–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤:**

```javascript
// –£–¥–∞–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
const { error } = await Layout.db.storage
  .from('retreat-photos')
  .remove([`${retreatId}/${uuid1}.jpg`, `${retreatId}/${uuid2}.jpg`]);
```

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ B. AWS Rekognition ‚Äî API reference –¥–ª—è Edge Functions

### B.0 SDK –≤ Deno Edge Functions

AWS SDK v3 –º–æ–¥—É–ª—å–Ω—ã–π ‚Äî –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ `@aws-sdk/client-rekognition` —á–µ—Ä–µ–∑ `npm:` —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ç–æ—Ä (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ Deno runtime). –ê–≤—Ç–æ–ø–æ–¥–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤, retry, —Ç–∏–ø–∏–∑–∞—Ü–∏—è ‚Äî –∏–∑ –∫–æ—Ä–æ–±–∫–∏.

```typescript
// supabase/functions/_shared/rekognition.ts
import {
  RekognitionClient,
  CreateCollectionCommand,
  IndexFacesCommand,
  SearchFacesByImageCommand,
  DeleteFacesCommand,
} from 'npm:@aws-sdk/client-rekognition@3';

export const rekognition = new RekognitionClient({
  region: Deno.env.get('AWS_REGION')!,           // ap-south-1
  credentials: {
    accessKeyId: Deno.env.get('AWS_ACCESS_KEY_ID')!,
    secretAccessKey: Deno.env.get('AWS_SECRET_ACCESS_KEY')!,
  },
});
```

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è** (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ Supabase Edge Function Secrets):

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ |
|-----------|---------|
| `AWS_ACCESS_KEY_ID` | –ö–ª—é—á IAM user `srsk-rekognition` |
| `AWS_SECRET_ACCESS_KEY` | –°–µ–∫—Ä–µ—Ç IAM user `srsk-rekognition` |
| `AWS_REGION` | `ap-south-1` |

### B.1 CreateCollection ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Ä–µ—Ç—Ä–∏—Ç–∞

```typescript
import { CreateCollectionCommand } from 'npm:@aws-sdk/client-rekognition@3';
import { rekognition } from '../_shared/rekognition.ts';

async function ensureCollection(retreatId: string): Promise<void> {
  try {
    await rekognition.send(new CreateCollectionCommand({
      CollectionId: `retreat_${retreatId}`,
    }));
    console.log(`Collection retreat_${retreatId} created`);
  } catch (err: any) {
    if (err.name === 'ResourceAlreadyExistsException') {
      // –ö–æ–ª–ª–µ–∫—Ü–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –û–ö
      return;
    }
    throw err;
  }
}
```

**CollectionId —Ñ–æ—Ä–º–∞—Ç:** `retreat_{retreat_uuid}` (—Ç–æ–ª—å–∫–æ `[a-zA-Z0-9_.\-]+`)

### B.2 IndexFaces ‚Äî –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ª–∏—Ü –Ω–∞ —Ñ–æ—Ç–æ

```typescript
import { IndexFacesCommand } from 'npm:@aws-sdk/client-rekognition@3';

const response = await rekognition.send(new IndexFacesCommand({
  CollectionId: `retreat_${retreatId}`,
  Image: {
    Bytes: imageBytes,  // Uint8Array, –º–∞–∫—Å 5 –ú–ë
  },
  ExternalImageId: photoId,  // UUID —Ñ–æ—Ç–æ –∏–∑ retreat_photos
  MaxFaces: 100,              // –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ª–∏—Ü–∞
  QualityFilter: 'AUTO',      // –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º—ã—Ç—ã–µ/—Ç—ë–º–Ω—ã–µ
  DetectionAttributes: ['DEFAULT'],
}));

// response.FaceRecords ‚Äî –º–∞—Å—Å–∏–≤ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–∏—Ü
for (const record of response.FaceRecords ?? []) {
  const face = record.Face!;
  // face.FaceId        ‚Äî UUID –ª–∏—Ü–∞ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ photo_faces)
  // face.BoundingBox   ‚Äî { Width, Height, Left, Top } (–¥–æ–ª–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —Ñ–æ—Ç–æ)
  // face.Confidence    ‚Äî —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å —á—Ç–æ —ç—Ç–æ –ª–∏—Ü–æ (0-100)
  // face.ExternalImageId ‚Äî –Ω–∞—à photoId
}

// response.UnindexedFaces ‚Äî –ª–∏—Ü–∞ –Ω–µ –ø—Ä–æ—à–µ–¥—à–∏–µ —Ñ–∏–ª—å—Ç—Ä –∫–∞—á–µ—Å—Ç–≤–∞
```

**–õ–∏–º–∏—Ç—ã:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|---------|
| –ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä Image.Bytes | 5 –ú–ë |
| –ú–∞–∫—Å. –ª–∏—Ü –Ω–∞ —Ñ–æ—Ç–æ | 100 |
| –§–æ—Ä–º–∞—Ç | JPEG, PNG |
| –ú–∏–Ω. —Ä–∞–∑–º–µ—Ä –ª–∏—Ü–∞ | 80x80 px |

**–†–µ—Å–∞–π–∑ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π:** –µ—Å–ª–∏ `file_size > 4.5 –ú–ë` ‚Äî —Ä–µ—Å–∞–π–∑–∏—Ç—å –¥–æ max 2048px –ø–æ –¥–ª–∏–Ω–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ. –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞: `npm:sharp` (–∏–ª–∏ `npm:jimp` –∫–∞–∫ fallback –µ—Å–ª–∏ sharp –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Deno).

### B.3 SearchFacesByImage ‚Äî –ø–æ–∏—Å–∫ –≥–æ—Å—Ç—è –Ω–∞ —Ñ–æ—Ç–æ

```typescript
import { SearchFacesByImageCommand } from 'npm:@aws-sdk/client-rekognition@3';

const response = await rekognition.send(new SearchFacesByImageCommand({
  CollectionId: `retreat_${retreatId}`,
  Image: {
    Bytes: selfieBytes,  // Uint8Array —Ñ–æ—Ç–æ –≥–æ—Å—Ç—è
  },
  FaceMatchThreshold: 80,  // –º–∏–Ω. —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å 80%
  MaxFaces: 100,
}));

// response.FaceMatches ‚Äî –º–∞—Å—Å–∏–≤ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ Similarity (desc)
for (const match of response.FaceMatches ?? []) {
  const faceId = match.Face!.FaceId;           // UUID –ª–∏—Ü–∞ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
  const photoId = match.Face!.ExternalImageId;  // –Ω–∞—à photoId –∏–∑ IndexFaces
  const similarity = match.Similarity;           // 80-100
}

// response.SearchedFaceBoundingBox ‚Äî bbox –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –ª–∏—Ü–∞ –Ω–∞ –≤—Ö–æ–¥–Ω–æ–º —Ñ–æ—Ç–æ
// response.SearchedFaceConfidence  ‚Äî —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å —á—Ç–æ –≤—Ö–æ–¥–Ω–æ–µ —Ñ–æ—Ç–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏—Ü–æ
```

**–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:** 1-2 —Å–µ–∫—É–Ω–¥—ã (–æ–¥–∏–Ω –≤—ã–∑–æ–≤ API)

### B.4 DeleteFaces ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ –ª–∏—Ü –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏

```typescript
import { DeleteFacesCommand } from 'npm:@aws-sdk/client-rekognition@3';

const response = await rekognition.send(new DeleteFacesCommand({
  CollectionId: `retreat_${retreatId}`,
  FaceIds: ['face-uuid-1', 'face-uuid-2'],  // –∏–∑ photo_faces.rekognition_face_id
}));

// response.DeletedFaces ‚Äî —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω–Ω—ã–µ face_id
// response.UnsuccessfulFaceDeletions ‚Äî –µ—Å–ª–∏ –∫–∞–∫–∏–µ-—Ç–æ –Ω–µ —É–¥–∞–ª–∏–ª–∏—Å—å
```

**–ú–∞–∫—Å. FaceIds –∑–∞ –æ–¥–∏–Ω –≤—ã–∑–æ–≤:** 4096

### B.5 –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ Rekognition

```typescript
// –û–±—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω retry —Å backoff
async function withRetry<T>(fn: () => Promise<T>, maxRetries = 3): Promise<T> {
  for (let attempt = 0; attempt <= maxRetries; attempt++) {
    try {
      return await fn();
    } catch (err: any) {
      const retryable = [
        'ThrottlingException',
        'ProvisionedThroughputExceededException',
        'InternalServerError',
      ];
      if (!retryable.includes(err.name) || attempt === maxRetries) throw err;

      const delay = err.name === 'ProvisionedThroughputExceededException'
        ? 5000 * (2 ** attempt)   // 5—Å ‚Üí 10—Å ‚Üí 20—Å
        : 1000 * (2 ** attempt);  // 1—Å ‚Üí 2—Å ‚Üí 4—Å
      await new Promise(r => setTimeout(r, delay));
    }
  }
  throw new Error('unreachable');
}
```

**–ù–µ —Ä–µ—Ç—Ä–∞–∏—Ç—å:**

| –û—à–∏–±–∫–∞ | –î–µ–π—Å—Ç–≤–∏–µ |
|--------|---------|
| `InvalidImageFormatException` | –ü–æ–º–µ—Ç–∏—Ç—å —Ñ–æ—Ç–æ `status = failed`, –Ω–µ —Ä–µ—Ç—Ä–∞–∏—Ç—å |
| `ResourceNotFoundException` | –ö–æ–ª–ª–µ–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ ‚Äî —Å–æ–∑–¥–∞—Ç—å —á–µ—Ä–µ–∑ CreateCollection, –ø–æ–≤—Ç–æ—Ä–∏—Ç—å |
| `ImageTooLargeException` | –†–µ—Å–∞–π–∑–∏—Ç—å –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å |

### B.6 –°—Ç–æ–∏–º–æ—Å—Ç—å (AWS Free Tier)

| API | Free Tier (12 –º–µ—Å) | –ü–æ—Å–ª–µ Free Tier |
|-----|-------------------|-----------------|
| IndexFaces | 5,000 / –º–µ—Å | $0.001 / –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ |
| SearchFacesByImage | 5,000 / –º–µ—Å | $0.001 / –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ |
| Face Storage | 1,000 –ª–∏—Ü / –º–µ—Å –±–µ—Å–ø–ª–∞—Ç–Ω–æ | $0.00001 / –ª–∏—Ü–æ / –º–µ—Å |

**–ü—Ä–∏–º–µ—Ä:** —Ä–µ—Ç—Ä–∏—Ç 700 —Ñ–æ—Ç–æ, 50 –≥–æ—Å—Ç–µ–π ‚Üí 700 IndexFaces + 50 SearchFaces = 750 –≤—ã–∑–æ–≤–æ–≤/–º–µ—Å. –í —Ä–∞–º–∫–∞—Ö Free Tier.

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ C. Drag & Drop Upload ‚Äî –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è vanilla JS + DaisyUI

### C.1 HTML-—Ä–∞–∑–º–µ—Ç–∫–∞

```html
<!-- photos/upload.html -->
<div id="upload-section">
  <!-- –í—ã–±–æ—Ä —Ä–µ—Ç—Ä–∏—Ç–∞ -->
  <div class="form-control mb-4">
    <label class="label"><span class="label-text">–†–µ—Ç—Ä–∏—Ç</span></label>
    <select id="retreat-select" class="select select-bordered w-full">
      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ç—Ä–∏—Ç...</option>
    </select>
  </div>

  <!-- –ó–æ–Ω–∞ drag & drop -->
  <div id="drop-zone"
       class="border-2 border-dashed border-base-300 rounded-xl p-12
              text-center cursor-pointer transition-colors
              hover:border-primary hover:bg-base-200/50"
       role="button" tabindex="0"
       aria-label="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞">

    <svg class="mx-auto mb-4 w-12 h-12 text-base-content/40" xmlns="http://www.w3.org/2000/svg"
         fill="none" viewBox="0 0 24 24" stroke-width="1.25" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
    </svg>

    <p class="text-lg font-medium">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ —Å—é–¥–∞</p>
    <p class="text-sm text-base-content/60 mt-1">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤</p>
    <p class="text-xs text-base-content/40 mt-2">JPEG, PNG ¬∑ –¥–æ 25 –ú–ë</p>

    <input type="file" id="file-input" class="hidden"
           accept="image/jpeg,image/png" multiple />
  </div>

  <!-- –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞) -->
  <div id="file-list" class="mt-4 space-y-2 hidden"></div>

  <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ -->
  <div id="upload-progress" class="mt-4 hidden">
    <div class="flex justify-between items-center mb-2">
      <span id="upload-status" class="text-sm font-medium">–ó–∞–≥—Ä—É–∂–µ–Ω–æ 0/0</span>
      <span id="upload-errors" class="text-sm text-error hidden">0 –æ—à–∏–±–æ–∫</span>
    </div>
    <progress id="upload-bar" class="progress progress-primary w-full" value="0" max="100"></progress>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
  <button id="upload-btn" class="btn btn-primary mt-4 hidden" disabled>
    –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
  </button>
</div>
```

### C.2 JavaScript ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ drag & drop

```javascript
// js/pages/photo-upload.js

const MAX_FILE_SIZE = 25 * 1024 * 1024; // 25 –ú–ë
const ALLOWED_TYPES = ['image/jpeg', 'image/png'];

const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const fileList = document.getElementById('file-list');
const uploadBtn = document.getElementById('upload-btn');

let selectedFiles = []; // { file, status: 'ready'|'error', errorMsg? }

// --- Drag & Drop ---

dropZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropZone.classList.add('border-primary', 'bg-base-200');
});

dropZone.addEventListener('dragleave', () => {
  dropZone.classList.remove('border-primary', 'bg-base-200');
});

dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('border-primary', 'bg-base-200');
  handleFiles(e.dataTransfer.files);
});

dropZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', () => handleFiles(fileInput.files));

// --- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ ---

function handleFiles(fileListObj) {
  selectedFiles = [];

  for (const file of fileListObj) {
    const entry = { file, status: 'ready', errorMsg: null };

    if (!ALLOWED_TYPES.includes(file.type)) {
      const ext = file.name.split('.').pop().toUpperCase();
      entry.status = 'error';
      entry.errorMsg = `–§–æ—Ä–º–∞—Ç ${ext} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ JPEG`;
    } else if (file.size > MAX_FILE_SIZE) {
      const sizeMB = (file.size / 1024 / 1024).toFixed(1);
      entry.status = 'error';
      entry.errorMsg = `${file.name} —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (${sizeMB} –ú–ë). –°–æ–∂–º–∏—Ç–µ –¥–æ 25 –ú–ë`;
    }

    selectedFiles.push(entry);
  }

  renderFileList();
}

// --- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ (–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ DOM-–º–µ—Ç–æ–¥—ã) ---

function renderFileList() {
  const ready = selectedFiles.filter(f => f.status === 'ready');
  const errors = selectedFiles.filter(f => f.status === 'error');

  fileList.classList.remove('hidden');
  fileList.replaceChildren(); // –æ—á–∏—Å—Ç–∫–∞ –±–µ–∑ innerHTML

  // –û—à–∏–±–∫–∏ ‚Äî —Å–≤–µ—Ä—Ö—É, –∫—Ä–∞—Å–Ω—ã–º
  for (const entry of errors) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-error py-2 text-sm';

    const span = document.createElement('span');
    span.textContent = entry.errorMsg; // textContent ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ—Ç XSS
    alert.appendChild(span);

    fileList.appendChild(alert);
  }

  // –ì–æ—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã ‚Äî –∫—Ä–∞—Ç–∫–æ
  if (ready.length > 0) {
    const info = document.createElement('div');
    info.className = 'text-sm text-base-content/60';
    const totalMB = (ready.reduce((s, f) => s + f.file.size, 0) / 1024 / 1024).toFixed(1);
    info.textContent = `${ready.length} —Ñ–∞–π–ª(–æ–≤) –≥–æ—Ç–æ–≤–æ –∫ –∑–∞–≥—Ä—É–∑–∫–µ (${totalMB} –ú–ë)`;
    fileList.appendChild(info);
  }

  // –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
  uploadBtn.classList.toggle('hidden', ready.length === 0);
  uploadBtn.disabled = ready.length === 0;
  uploadBtn.textContent = `–ó–∞–≥—Ä—É–∑–∏—Ç—å ${ready.length} —Ñ–æ—Ç–æ`;
}
```

### C.3 JavaScript ‚Äî –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å retry

```javascript
// –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ js/pages/photo-upload.js

const uploadProgress = document.getElementById('upload-progress');
const uploadStatus = document.getElementById('upload-status');
const uploadBar = document.getElementById('upload-bar');

uploadBtn.addEventListener('click', startUpload);

async function startUpload() {
  const retreatId = document.getElementById('retreat-select').value;
  if (!retreatId) { Layout.showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ç—Ä–∏—Ç', 'warning'); return; }

  const readyFiles = selectedFiles.filter(f => f.status === 'ready');
  if (readyFiles.length === 0) return;

  uploadBtn.disabled = true;
  uploadProgress.classList.remove('hidden');

  let uploaded = 0;
  let failed = 0;
  const photoIds = [];

  for (const entry of readyFiles) {
    uploadStatus.textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${uploaded}/${readyFiles.length}`;
    uploadBar.value = (uploaded / readyFiles.length) * 100;

    try {
      const photoId = await uploadOneFile(retreatId, entry.file);
      photoIds.push(photoId);
      uploaded++;
    } catch (err) {
      console.error(`Upload failed: ${entry.file.name}`, err);
      failed++;
    }
  }

  uploadBar.value = 100;
  uploadStatus.textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${uploaded}/${readyFiles.length}` +
    (failed > 0 ? ` (${failed} –æ—à–∏–±–æ–∫)` : '');

  if (photoIds.length > 0) {
    Layout.showToast(`${photoIds.length} —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ`, 'success');
    // –ó–∞–ø—É—Å–∫ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –ª–∏—Ü (–§–∞–∑–∞ 2)
    // await startIndexing(retreatId, photoIds);
  }
}

async function uploadOneFile(retreatId, file, retries = 3) {
  const uuid = crypto.randomUUID();
  const ext = file.type === 'image/png' ? 'png' : 'jpg';
  const storagePath = `${retreatId}/${uuid}.${ext}`;

  for (let attempt = 0; attempt < retries; attempt++) {
    try {
      // 1. Upload –≤ Storage
      const { error: storageError } = await Layout.db.storage
        .from('retreat-photos')
        .upload(storagePath, file, {
          contentType: file.type,
          cacheControl: '31536000',
          upsert: false,
        });
      if (storageError) throw storageError;

      // 2. –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (width, height) —á–µ—Ä–µ–∑ Image API
      const dimensions = await getImageDimensions(file);

      // 3. INSERT –≤ retreat_photos
      const { data, error: dbError } = await Layout.db
        .from('retreat_photos')
        .insert({
          retreat_id: retreatId,
          storage_path: storagePath,
          uploaded_by: window.currentUser.id,
          width: dimensions.width,
          height: dimensions.height,
          file_size: file.size,
          index_status: 'pending',
        })
        .select('id')
        .single();
      if (dbError) throw dbError;

      return data.id;

    } catch (err) {
      if (attempt === retries - 1) throw err;
      await new Promise(r => setTimeout(r, 1000 * (2 ** attempt))); // 1—Å ‚Üí 2—Å ‚Üí 4—Å
    }
  }
}

function getImageDimensions(file) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      resolve({ width: img.naturalWidth, height: img.naturalHeight });
      URL.revokeObjectURL(img.src);
    };
    img.onerror = () => resolve({ width: 0, height: 0 });
    img.src = URL.createObjectURL(file);
  });
}
```

### C.4 UX-—Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–æ–Ω—ã –∑–∞–≥—Ä—É–∑–∫–∏

| –°–æ—Å—Ç–æ—è–Ω–∏–µ | –í–∏–∑—É–∞–ª | –î–µ–π—Å—Ç–≤–∏–µ |
|-----------|--------|---------|
| **–ü—É—Å—Ç–∞—è** | –ü—É–Ω–∫—Ç–∏—Ä–Ω–∞—è —Ä–∞–º–∫–∞, –∏–∫–æ–Ω–∫–∞ upload, —Ç–µ–∫—Å—Ç ¬´–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ —Å—é–¥–∞¬ª | –ö–ª–∏–∫ –∏–ª–∏ drag |
| **Hover (drag over)** | –†–∞–º–∫–∞ `border-primary`, —Ñ–æ–Ω `bg-base-200` | ‚Äî |
| **–§–∞–π–ª—ã –≤—ã–±—Ä–∞–Ω—ã** | –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ + –æ—à–∏–±–∫–∏ + –∫–Ω–æ–ø–∫–∞ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å N —Ñ–æ—Ç–æ¬ª | –ö–ª–∏–∫ –∫–Ω–æ–ø–∫–∏ |
| **–ó–∞–≥—Ä—É–∑–∫–∞** | Progress bar, —Å—á—ë—Ç—á–∏–∫ ¬´–ó–∞–≥—Ä—É–∂–µ–Ω–æ 34/100¬ª, –∫–Ω–æ–ø–∫–∞ disabled | –û–∂–∏–¥–∞–Ω–∏–µ |
| **–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞** | `alert alert-error` —Å —Ç–µ–∫—Å—Ç–æ–º (inline, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å—Ç–∞–ª—å–Ω—ã–µ) | ‚Äî |
| **–ì–æ—Ç–æ–≤–æ** | Toast ¬´N —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ¬ª, –ø–µ—Ä–µ—Ö–æ–¥ –∫ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ | ‚Äî |

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ D. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

### D.1 –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**Frontend (–Ω–µ—Ç npm-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ‚Äî –≤—Å—ë —á–µ—Ä–µ–∑ CDN):**

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç vanilla JS –±–µ–∑ —Å–±–æ—Ä–∫–∏. –í—Å–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `<script>` / `<link>` –≤ HTML:

| –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ | –í–µ—Ä—Å–∏—è | CDN | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|--------|-----|-----------|
| Tailwind CSS | 3.x | CDN play | –°—Ç–∏–ª–∏ |
| DaisyUI | 4.x | CDN | UI-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã |
| Supabase JS | 2.x | CDN (`@supabase/supabase-js`) | –ö–ª–∏–µ–Ω—Ç –ë–î + Storage |

–ù–∏—á–µ–≥–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —á–µ—Ä–µ–∑ npm –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –Ω–µ –Ω—É–∂–Ω–æ.

**Edge Functions (Deno, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `npm:` —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ç–æ—Ä):**

| –ü–∞–∫–µ—Ç | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-------|--------|-----------|
| `npm:@supabase/supabase-js@2` | 2.x | Supabase –∫–ª–∏–µ–Ω—Ç (service_role) |
| `npm:@aws-sdk/client-rekognition@3` | 3.x | AWS Rekognition SDK (IndexFaces, SearchFaces, DeleteFaces) |
| `npm:sharp@0.33` (–∏–ª–∏ `npm:jimp@1`) | 0.33.x | –†–µ—Å–∞–π–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–µ—Ä–µ–¥ Rekognition (> 4.5 –ú–ë ‚Üí 2048px) |

–ü—Ä–∏–º–µ—Ä import –≤ Edge Function:

```typescript
import { createClient } from 'npm:@supabase/supabase-js@2';
import { RekognitionClient, IndexFacesCommand } from 'npm:@aws-sdk/client-rekognition@3';
import sharp from 'npm:sharp@0.33';
```

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞:**

| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç | –í–µ—Ä—Å–∏—è | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|--------|-----------|-----------|
| Node.js | >= 18 | `brew install node` | –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä, —Ç–µ—Å—Ç—ã |
| Supabase CLI | >= 2.75.0 | `brew install supabase/tap/supabase` | –ú–∏–≥—Ä–∞—Ü–∏–∏, –¥–µ–ø–ª–æ–π Edge Functions |
| Playwright | (–≤ devDependencies) | `npm install` | E2E —Ç–µ—Å—Ç—ã |

### D.2 –ß—Ç–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –≤ —ç—Ç–æ–º –ø–æ—Ä—è–¥–∫–µ)

| # | –î–æ–∫—É–º–µ–Ω—Ç | –ó–∞—á–µ–º |
|---|----------|-------|
| 1 | **–≠—Ç–æ—Ç —Ñ–∞–π–ª** (`docs/photo-gallery-feature-spec.md`) | –ü–æ–ª–Ω–æ–µ –¢–ó: user stories, flows, DB schema, –æ—Ü–µ–Ω–∫–∏ |
| 2 | `docs/architecture.md` | –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞, Layout.*, Utils.*, init() |
| 3 | `docs/patterns.md` | –ü–∞—Ç—Ç–µ—Ä–Ω—ã: —Ñ–æ—Ä–º—ã, —Ç–∞–±–ª–∏—Ü—ã, –º–æ–¥–∞–ª–∫–∏, RLS |
| 4 | `docs/auth.md` | –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, permissions, `upload_photos` |
| 5 | `docs/modules/housing.md` | Guest Portal, retreat_registrations ‚Äî –Ω—É–∂–Ω–æ –¥–ª—è RLS |
| 6 | `CLAUDE.md` (–∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞) | –í—Å–µ –∫–æ–Ω–≤–µ–Ω—Ü–∏–∏: –¥–∞—Ç—ã, –∏–º–µ–Ω–∞, XSS, –∏–∫–æ–Ω–∫–∏ |
| 7 | –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è A-C —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ | Storage config, Rekognition API, drag-and-drop –ø–∞—Ç—Ç–µ—Ä–Ω |

### D.3 –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω–≤–µ–Ω—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞

- **Stack:** Vanilla JS + DaisyUI + Tailwind CSS + Supabase. **–ë–µ–∑ —Å–±–æ—Ä–∫–∏** (–Ω–µ—Ç webpack/vite)
- **–ë–î:** Supabase (PostgreSQL + RLS). Prod project: `llttmftapmwebidgevmg`
- **Edge Functions:** TypeScript + Deno. –î–µ–ø–ª–æ–π: `supabase functions deploy <name> --project-ref llttmftapmwebidgevmg --no-verify-jwt`
- **–ò–∫–æ–Ω–∫–∏:** Inline SVG (Heroicons-—Å—Ç–∏–ª—å), stroke-width 1.25. **–ù–µ —ç–º–æ–¥–∑–∏!**
- **–î–∞—Ç—ã:** **–í—Å–µ–≥–¥–∞ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è**, –Ω–∏–∫–æ–≥–¥–∞ UTC. –°–º. CLAUDE.md
- **XSS:** `Layout.escapeHtml()` –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö, `textContent` –≤–º–µ—Å—Ç–æ `innerHTML`
- **i18n:** `Layout.t('key')` –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤

### D.4 –ö–∞–∫ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É

**–ü–æ—Ä—è–¥–æ–∫ —Ä–∞–±–æ—Ç—ã –ø–æ —Ñ–∞–∑–∞–º:**

```
–§–∞–∑–∞ 1 (–ì–∞–ª–µ—Ä–µ—è)     ‚Üí –§–∞–∑–∞ 2 (AI/Rekognition) ‚Üí –§–∞–∑–∞ 3 (Telegram)
~5.4 —á (H+Claude)      ~4.6 —á                      ~5.2 —á
```

**–®–∞–≥ 1: –§–∞–∑–∞ 1 ‚Äî –Ω–∞—á–∞—Ç—å —Å –º–∏–≥—Ä–∞—Ü–∏–π –∏ Storage**

```bash
# 1.1 –ú–∏–≥—Ä–∞—Ü–∏—è: permission upload_photos
supabase migration new 108_photo_gallery_permission

# 1.2 –ú–∏–≥—Ä–∞—Ü–∏—è: —Ç–∞–±–ª–∏—Ü–∞ retreat_photos
supabase migration new 109_retreat_photos_table

# 1.3 –°–æ–∑–¥–∞—Ç—å bucket retreat-photos (Dashboard ‚Üí Storage ‚Üí New Bucket)
# –°–º. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ A.1

# 1.4 RLS policies –Ω–∞ Storage –∏ retreat_photos
supabase migration new 110_photo_gallery_rls

# 1.5 –î–µ–ø–ª–æ–π –º–∏–≥—Ä–∞—Ü–∏–π
supabase db push --project-ref llttmftapmwebidgevmg
```

**–®–∞–≥ 2: Frontend ‚Äî upload.html –∏ manage.html**

```bash
# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤:
photos/
  upload.html       # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ (drag & drop)
  manage.html       # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ (—É–¥–∞–ª–µ–Ω–∏–µ)
js/pages/
  photo-upload.js   # –õ–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ C)
  photo-manage.js   # –õ–æ–≥–∏–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```

**–®–∞–≥ 3: Guest Portal ‚Äî –≥–∞–ª–µ—Ä–µ—è**

```bash
# –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª ¬´–§–æ—Ç–æ¬ª –≤ Guest Portal
guest/
  photos.html       # –ì–∞–ª–µ—Ä–µ—è + ¬´–ù–∞–π—Ç–∏ —Å–µ–±—è¬ª (–§–∞–∑–∞ 2)
```

### D.5 –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ PR

- [ ] –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –Ω–∞ dev: `supabase db push --project-ref vzuiwpeovnzfokekdetq`
- [ ] RLS —Ä–∞–±–æ—Ç–∞–µ—Ç: –≥–æ—Å—Ç—å –≤–∏–¥–∏—Ç —Ñ–æ—Ç–æ —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–≥–æ —Ä–µ—Ç—Ä–∏—Ç–∞
- [ ] Permission: —Ç–æ–ª—å–∫–æ `upload_photos` –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å/—É–¥–∞–ª—è—Ç—å
- [ ] Thumbnails —á–µ—Ä–µ–∑ CDN Image Transforms —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] XSS: –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ `Layout.escapeHtml()` / `textContent`
- [ ] –î–∞—Ç—ã: –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è (–Ω–µ UTC)
- [ ] –ò–∫–æ–Ω–∫–∏: SVG, –Ω–µ —ç–º–æ–¥–∑–∏
- [ ] Cache busting: –æ–±–Ω–æ–≤–∏—Ç—å `?v=N` –≤ script-—Ç–µ–≥–∞—Ö

### D.6 –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
npm run serve

# –¢–µ—Å—Ç—ã
npm test

# –î–µ–ø–ª–æ–π Edge Function
supabase functions deploy index-faces --project-ref llttmftapmwebidgevmg --no-verify-jwt

# –õ–æ–≥–∏ Edge Function
supabase functions logs index-faces --project-ref llttmftapmwebidgevmg

# SQL –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
supabase db execute --project-ref llttmftapmwebidgevmg "SELECT count(*) FROM retreat_photos"
```

---

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –§–¢ (PDF)

| # | –ë—ã–ª–æ (PDF) | –°—Ç–∞–ª–æ | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|---|-----------|-------|-------------|
| 1 | –õ–∏–º–∏—Ç —Ñ–∞–π–ª–∞ 5 –ú–ë, –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ | **–õ–∏–º–∏—Ç 25 –ú–ë, —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ —Å–∂–∏–º–∞–µ—Ç —Å–∞–º** | –ö–∞–º–µ—Ä—ã –¥–∞—é—Ç 7-15 –ú–ë, –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ 20+ –ú–ë. –§–æ—Ç–æ–≥—Ä–∞—Ñ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –∏–∑ Lightroom —Å –∫–∞—á–µ—Å—Ç–≤–æ–º 85-90% |
| 2 | –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (deleted_at) | **–ñ—ë—Å—Ç–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ + –∫–∞—Å–∫–∞–¥** | Soft delete —É—Å–ª–æ–∂–Ω—è–µ—Ç –∫–∞—Å–∫–∞–¥ —Å Rekognition, –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è —Ñ–æ—Ç–æ |
| 3 | –û—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ telegram_links | **–ü–æ–ª–µ vaishnavas.telegram_chat_id** | –ü—Ä–æ—â–µ –¥–ª—è MVP, –æ–¥–∏–Ω –≥–æ—Å—Ç—å = –æ–¥–∏–Ω —á–∞—Ç |
| 4 | –ù–µ—Ç —Ä–µ—Å–∞–π–∑–∞ –ø–µ—Ä–µ–¥ Rekognition | **–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ä–µ—Å–∞–π–∑ >4.5 –ú–ë** | Rekognition API –ª–∏–º–∏—Ç 5 –ú–ë –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ |
| 5 | –ù–µ—Ç UX –æ—à–∏–±–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞/—Ä–∞–∑–º–µ—Ä–∞ | **Inline —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏** | –Ø–≤–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∏–∑ –§–¢, –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ |
| 6 | –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å ¬´–≤–∫–ª—é—á–∏—Ç—å AI¬ª | **AI –≤–∫–ª—é—á—ë–Ω –≤—Å–µ–≥–¥–∞** | Toggle —É—Å–ª–æ–∂–Ω—è–µ—Ç UX –±–µ–∑ –ø–æ–ª—å–∑—ã, –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ |
| 7 | used_at –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ç–æ–∫–µ–Ω–∞—Ö | **–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ used_at** | –î–ª—è –∞—É–¥–∏—Ç–∞, –∫–æ–≥–¥–∞ –±—ã–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Ç–æ–∫–µ–Ω |
| 8 | –§–æ—Ä–º–∞—Ç—ã JPEG/PNG/HEIC | **–¢–æ–ª—å–∫–æ JPEG/PNG** | HEIC —Ç—Ä–µ–±—É–µ—Ç polyfill –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–Ω–æ–≥–æ Canvas API, –Ω–µ –æ–∫—É–ø–∞–µ—Ç—Å—è |
| 9 | –ê–≤—Ç–æ-—Å–∂–∞—Ç–∏–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (Canvas API) | **–§–æ—Ç–æ–≥—Ä–∞—Ñ —Å–∂–∏–º–∞–µ—Ç —Å–∞–º** | –£–±—Ä–∞–Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ —Å–∂–∞—Ç–∏—è, –ª–∏–º–∏—Ç –ø–æ–¥–Ω—è—Ç –¥–æ 25 –ú–ë |
| 10 | Telegram-–±–æ—Ç —Å –Ω—É–ª—è | **–ü–∞—Ç—Ç–µ—Ä–Ω –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞** | Webhook + sendMessage –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |
