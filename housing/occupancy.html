<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script>(function(){var c={kitchen:'#f49800',housing:'#8b5cf6'};var m=localStorage.getItem('srsk_module')||'kitchen';document.documentElement.style.setProperty('--current-color',c[m]||c.kitchen);})();</script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Заселение — ШРСК</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        /* Цвета статусов комнат теперь задаются inline */

        /* План этажа */
        .floor-plan-container {
            position: relative;
            display: block;
            width: 100%;
        }
        .floor-plan-container img {
            width: 100%;
            height: auto;
            display: block;
        }
        .floor-plan-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .room-label {
            fill: white;
            font-weight: 600;
            font-size: 3px;
            text-anchor: middle;
            dominant-baseline: central;
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 flex-1">

        <!-- Page Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <h1 class="text-2xl font-bold" data-i18n="occupancy_title">Заселение</h1>
            <div class="flex gap-2">
                <button class="btn btn-outline btn-warning gap-2" onclick="openBookingModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span data-i18n="add_booking">Забронировать</span>
                </button>
                <button class="btn btn-primary gap-2" onclick="openResidentModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    <span data-i18n="add_resident">Заселить</span>
                </button>
            </div>
        </div>

        <!-- Stats + Chart -->
        <div class="flex gap-2 mb-6" id="statsBlock">
            <!-- Expanded view -->
            <div class="flex-1 flex flex-col sm:flex-row gap-4" id="statsExpanded">
                <!-- Mini stats (arrivals/departures) -->
                <div class="bg-base-100 rounded-lg px-4 py-3 shadow-sm flex-shrink-0" id="statsCards">
                    <!-- Generated by JS -->
                </div>
                <!-- Occupancy Chart -->
                <div class="flex-1 bg-base-100 rounded-lg shadow-sm p-3">
                    <div class="flex items-center justify-between">
                        <button type="button" onclick="shiftWeek(-1)" class="btn btn-ghost btn-xs btn-circle">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <span class="text-sm font-medium opacity-60" id="chartWeekLabel"></span>
                        <button type="button" onclick="shiftWeek(1)" class="btn btn-ghost btn-xs btn-circle">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                    <div class="h-28 mt-2" id="chartContainer">
                        <canvas id="occupancyChart"></canvas>
                    </div>
                </div>
            </div>
            <!-- Collapsed view -->
            <div class="hidden flex-1 bg-base-100 rounded-lg px-4 py-2 shadow-sm cursor-pointer hover:bg-base-200/50 transition-colors" id="statsCollapsed" onclick="toggleStats()">
                <div class="flex items-center gap-4 text-sm">
                    <span class="font-medium opacity-60" data-i18n="summary">Сводка:</span>
                    <span id="statsCollapsedContent" class="flex items-center gap-4"></span>
                </div>
            </div>
            <!-- Toggle button -->
            <button type="button" onclick="toggleStats()" class="bg-base-100 rounded-lg shadow-sm px-2 flex items-center justify-center hover:bg-base-200 transition-colors" id="statsToggleBtn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                </svg>
            </button>
        </div>

        <!-- Legend -->
        <div class="flex flex-wrap items-center gap-4 mb-4 text-sm" id="statusLegend">
            <span class="opacity-60" data-i18n="legend">Легенда:</span>
            <div class="flex items-center gap-1">
                <span class="w-3 h-3 rounded-full" style="background-color: #10b981"></span>
                <span data-i18n="status_available">Свободно</span>
            </div>
            <div class="flex items-center gap-1">
                <span class="w-3 h-3 rounded-full" style="background-color: #eab308"></span>
                <span data-i18n="status_booked">Забронировано</span>
            </div>
            <div class="flex items-center gap-1">
                <span class="w-3 h-3 rounded-full" style="background-color: #f59e0b"></span>
                <span data-i18n="status_partial">Частично заселено</span>
            </div>
            <div class="flex items-center gap-1">
                <span class="w-3 h-3 rounded-full" style="background-color: #8b5cf6"></span>
                <span data-i18n="status_occupied">Заселено</span>
            </div>
            <div class="flex items-center gap-1">
                <span class="w-3 h-3 rounded-full" style="background-color: #ef4444"></span>
                <span data-i18n="status_cleaning">Уборка</span>
            </div>
        </div>

        <!-- Search + Date + Tabs -->
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
            <!-- Search -->
            <div class="flex-1 max-w-md relative">
                <input type="text" id="searchInput" placeholder="Поиск гостя..." class="input input-bordered w-full pl-10" data-i18n-placeholder="search_guest" />
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 -translate-y-1/2 opacity-40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>

            <!-- Date Selector -->
            <div class="flex items-center gap-1 bg-base-100 rounded-lg px-1 h-10">
                <button type="button" onclick="shiftDate(-1)" class="btn btn-ghost btn-xs btn-circle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <button type="button" onclick="goToToday()" class="text-sm font-medium px-2 hover:text-primary transition-colors" id="currentDateLabel"></button>
                <button type="button" onclick="shiftDate(1)" class="btn btn-ghost btn-xs btn-circle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>

            <!-- View Tabs -->
            <div class="tabs tabs-boxed bg-base-100">
                <button class="tab tab-active" data-view="rooms" onclick="switchView('rooms')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                    </svg>
                    <span data-i18n="view_rooms">Комнаты</span>
                </button>
                <button class="tab" data-view="guests" onclick="switchView('guests')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span data-i18n="view_guests">Гости</span>
                </button>
                <button class="tab" data-view="plan" onclick="switchView('plan')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                    </svg>
                    <span data-i18n="view_plan">План</span>
                </button>
            </div>
        </div>

        <!-- Building Filter (чипы для вида комнат и гостей) -->
        <div id="buildingFilterRow" class="mb-6">
            <!-- Generated by JS (building chips) -->
        </div>

        <!-- View: Rooms -->
        <div id="viewRooms" class="space-y-6">
            <!-- Will be generated by JS -->
        </div>

        <!-- View: Guests -->
        <div id="viewGuests" class="hidden space-y-3">
            <!-- Will be generated by JS -->
        </div>

        <!-- View: Plan -->
        <div id="viewPlan" class="hidden space-y-6">
            <!-- Generated by JS -->
        </div>

    </main>

    <div id="footer-placeholder"></div>

    <!-- Add/Edit Resident Modal -->
    <dialog id="residentModal" class="modal">
        <div class="modal-box max-w-lg relative">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeResidentModal()">✕</button>
            <h3 class="font-bold text-lg mb-4" id="residentModalTitle" data-i18n="add_resident">Заселить</h3>

            <form id="residentForm" class="space-y-4">
                <input type="hidden" name="id" />

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="select_room">Комната</span><span class="text-error ml-1">*</span></label>
                        <select name="room_id" id="roomSelect" class="select select-bordered w-full" required>
                            <option value="">—</option>
                        </select>
                    </div>
                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="resident_category">Категория</span></label>
                        <select name="category_id" id="categorySelect" class="select select-bordered w-full">
                            <option value="">—</option>
                        </select>
                    </div>
                </div>

                <!-- Team Member Selection -->
                <div id="teamMemberSection">
                    <label class="label"><span class="label-text font-medium" data-i18n="select_team_member">Выбрать из команды</span></label>
                    <select name="team_member_id" id="teamMemberSelect" class="select select-bordered w-full">
                        <option value="">— Гость (ввести данные ниже) —</option>
                    </select>
                </div>

                <!-- Guest Data -->
                <div id="guestDataSection">
                    <div class="divider text-sm opacity-60" data-i18n="or_enter_guest">Или введите данные гостя</div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="guest_name">Имя гостя</span></label>
                            <input type="text" name="guest_name" class="input input-bordered w-full" />
                        </div>
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="guest_phone">Телефон</span></label>
                            <input type="tel" name="guest_phone" class="input input-bordered w-full" />
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="guest_country">Страна</span></label>
                            <input type="text" name="guest_country" class="input input-bordered w-full" />
                        </div>
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="guest_email">Email</span></label>
                            <input type="email" name="guest_email" class="input input-bordered w-full" />
                        </div>
                    </div>
                </div>

                <!-- Dates -->
                <div class="divider text-sm opacity-60"></div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="check_in">Заезд</span><span class="text-error ml-1">*</span></label>
                        <input type="date" name="check_in" class="input input-bordered w-full" required />
                    </div>
                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="check_out">Выезд</span></label>
                        <input type="date" name="check_out" class="input input-bordered w-full" />
                    </div>
                </div>

                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="notes">Примечания</span></label>
                    <textarea name="notes" rows="2" class="textarea textarea-bordered w-full"></textarea>
                </div>

                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" onclick="closeResidentModal()" data-i18n="cancel">Отмена</button>
                    <button type="submit" class="btn btn-primary" data-i18n="save">Сохранить</button>
                </div>
            </form>

            <!-- Delete button -->
            <div id="deleteResidentSection" class="hidden border-t border-base-200 mt-4 pt-4">
                <button type="button" class="btn btn-ghost btn-error btn-sm gap-1" onclick="deleteResident()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    <span data-i18n="delete_resident">Удалить запись</span>
                </button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Booking Modal -->
    <dialog id="bookingModal" class="modal">
        <div class="modal-box max-w-4xl relative">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeBookingModal()">✕</button>
            <h3 class="font-bold text-lg mb-4" id="bookingModalTitle" data-i18n="booking_title">Новая бронь</h3>

            <!-- Steps indicator -->
            <div class="flex items-center justify-center gap-4 mb-6">
                <div class="flex items-center gap-2" id="bookingStep1Indicator">
                    <span class="w-8 h-8 rounded-full bg-primary text-primary-content flex items-center justify-center font-bold">1</span>
                    <span class="font-medium" data-i18n="booking_step_1">Данные брони</span>
                </div>
                <div class="w-12 h-px bg-base-300"></div>
                <div class="flex items-center gap-2 opacity-40" id="bookingStep2Indicator">
                    <span class="w-8 h-8 rounded-full bg-base-300 flex items-center justify-center font-bold">2</span>
                    <span class="font-medium" data-i18n="booking_step_2">Выбор комнат</span>
                </div>
            </div>

            <!-- Step 1: Booking Data -->
            <div id="bookingStep1">
                <form id="bookingForm" class="space-y-4">
                    <input type="hidden" name="id" />

                    <!-- Booking Name (optional) -->
                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="booking_name">Название брони</span></label>
                        <input type="text" name="name" class="input input-bordered w-full" data-i18n-placeholder="booking_name_placeholder" placeholder="Например: Группа из Москвы" />
                    </div>

                    <!-- Contact Person -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="booking_contact_name">Контактное лицо</span><span class="text-error ml-1">*</span></label>
                            <input type="text" name="contact_name" class="input input-bordered w-full" required />
                        </div>
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="booking_contact_phone">Телефон</span></label>
                            <input type="tel" name="contact_phone" class="input input-bordered w-full" />
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="booking_contact_email">Email</span></label>
                            <input type="email" name="contact_email" class="input input-bordered w-full" />
                        </div>
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="booking_contact_country">Страна</span></label>
                            <input type="text" name="contact_country" class="input input-bordered w-full" />
                        </div>
                    </div>

                    <div class="divider"></div>

                    <!-- Booking Details -->
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="booking_beds_count">Количество мест</span><span class="text-error ml-1">*</span></label>
                            <input type="number" name="beds_count" min="1" max="200" value="1" class="input input-bordered w-full" required />
                        </div>
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="check_in">Заезд</span><span class="text-error ml-1">*</span></label>
                            <input type="date" name="check_in" class="input input-bordered w-full" required />
                        </div>
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="check_out">Выезд</span><span class="text-error ml-1">*</span></label>
                            <input type="date" name="check_out" class="input input-bordered w-full" required />
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="booking_buildings">Где размещаем</span><span class="text-error ml-1">*</span></label>
                            <select name="building_scope" id="bookingBuildingScope" class="select select-bordered w-full" required>
                                <!-- Заполняется динамически -->
                            </select>
                        </div>
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="booking_retreat">Ретрит</span></label>
                            <select name="retreat_id" id="bookingRetreatSelect" class="select select-bordered w-full">
                                <option value="">—</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="booking_notes">Примечания</span></label>
                        <input type="text" name="notes" class="input input-bordered w-full" />
                    </div>
                </form>

                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" onclick="closeBookingModal()" data-i18n="cancel">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="goToBookingStep2()" data-i18n="booking_next">Далее</button>
                </div>
            </div>

            <!-- Step 2: Room Selection -->
            <div id="bookingStep2" class="hidden">
                <!-- Building selector -->
                <div class="flex items-center justify-between mb-4">
                    <select id="bookingBuildingSelect" class="select select-bordered" onchange="renderBookingPlan()">
                        <!-- Buildings will be populated -->
                    </select>
                    <div class="badge badge-lg badge-warning gap-2">
                        <span data-i18n="booking_selected">Выбрано</span>
                        <span id="bookingSelectedCount">0</span>
                        <span data-i18n="booking_of">из</span>
                        <span id="bookingTotalCount">1</span>
                    </div>
                </div>

                <!-- Legend -->
                <div class="flex flex-wrap gap-3 items-center mb-4 text-sm">
                    <div class="flex items-center gap-1">
                        <span class="w-3 h-3 rounded" style="background-color: #10b981"></span>
                        <span data-i18n="floor_plan_available">Свободно</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="w-3 h-3 rounded" style="background-color: #8b5cf6"></span>
                        <span data-i18n="floor_plan_occupied">Заселена</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="w-3 h-3 rounded" style="background-color: #eab308"></span>
                        <span data-i18n="floor_plan_booked">Забронировано</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="w-3 h-3 rounded ring-2 ring-primary" style="background-color: #10b981"></span>
                        <span>Выбрано для брони</span>
                    </div>
                </div>

                <!-- Floor plans grid -->
                <div id="bookingPlanContainer" class="grid grid-cols-2 gap-4 max-h-96 overflow-y-auto">
                    <!-- Plans will be rendered here -->
                </div>

                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" onclick="goToBookingStep1()" data-i18n="booking_back">Назад</button>
                    <button type="button" class="btn btn-primary" id="bookingSaveBtn" onclick="saveBooking()" disabled data-i18n="booking_save">Сохранить</button>
                </div>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Check-in from Booking Modal -->
    <dialog id="checkinBookingModal" class="modal">
        <div class="modal-box max-w-md relative">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeCheckinBookingModal()">✕</button>
            <h3 class="font-bold text-lg mb-4" data-i18n="booking_checkin_title">Заселить гостя</h3>

            <div class="bg-warning/20 rounded-lg p-3 mb-4">
                <div class="text-sm font-medium" data-i18n="booking_checkin_from_booking">Из брони:</div>
                <div id="checkinBookingInfo" class="text-sm opacity-70"></div>
            </div>

            <form id="checkinBookingForm" class="space-y-4">
                <input type="hidden" name="resident_id" />

                <!-- Team Member Selection -->
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="select_team_member">Выбрать из команды</span></label>
                    <select name="team_member_id" id="checkinTeamMemberSelect" class="select select-bordered w-full">
                        <option value="">— Гость (ввести данные ниже) —</option>
                    </select>
                </div>

                <!-- Guest Data -->
                <div id="checkinGuestDataSection">
                    <div class="divider text-sm opacity-60" data-i18n="or_enter_guest">Или введите данные гостя</div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="guest_name">Имя гостя</span></label>
                            <input type="text" name="guest_name" class="input input-bordered w-full" />
                        </div>
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="guest_phone">Телефон</span></label>
                            <input type="tel" name="guest_phone" class="input input-bordered w-full" />
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="guest_country">Страна</span></label>
                            <input type="text" name="guest_country" class="input input-bordered w-full" />
                        </div>
                        <div>
                            <label class="label"><span class="label-text font-medium" data-i18n="guest_email">Email</span></label>
                            <input type="email" name="guest_email" class="input input-bordered w-full" />
                        </div>
                    </div>
                </div>

                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" onclick="closeCheckinBookingModal()" data-i18n="cancel">Отмена</button>
                    <button type="submit" class="btn btn-primary" data-i18n="save">Сохранить</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <script src="../js/layout.js"></script>
    <script>
        // ==================== STATE ====================
        let occupancy = [];
        let occupancyWithBookings = [];
        let buildings = [];
        let buildingTypes = [];
        let rooms = [];
        let categories = [];
        let teamMembers = [];
        let residents = [];
        let retreats = [];
        let arrivals = [];
        let departures = [];
        let tomorrowArrivals = [];
        let tomorrowDepartures = [];
        let occupancyByType = {};
        let currentBuildingFilter = '';
        let floorPlans = [];
        let currentView = 'rooms';
        let searchQuery = '';
        let editingResidentId = null;
        let selectedRoomId = null;
        let weekForecast = [];
        let weekResidentsCache = [];
        let weekOffset = 0; // 0 = текущая неделя, 1 = следующая, -1 = прошлая
        let occupancyChart = null;
        let statsCollapsed = localStorage.getItem('srsk_stats_collapsed') !== 'false';

        // Booking state
        let bookingStep = 1;
        let bookingSelectedBeds = new Set(); // Set of room_id + '_' + bed_index
        let bookingBuildingId = null;
        let editingBookingId = null;

        const t = key => Layout.t(key);
        const today = new Date().toISOString().split('T')[0];
        const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
        let selectedDate = today;

        // ==================== DATA ====================
        async function loadBuildingTypes() {
            const { data } = await Layout.db.from('building_types').select('*').order('sort_order');
            return data || [];
        }

        async function loadBuildings() {
            const { data } = await Layout.db.from('buildings').select('*, building_types(id, slug, color, name_ru, name_en, name_hi)').eq('is_active', true).order('sort_order');
            return data || [];
        }

        // Натуральная сортировка (1, 2, 10, 11 вместо 1, 10, 11, 2)
        function naturalSort(a, b) {
            return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
        }

        async function loadRooms() {
            const { data } = await Layout.db
                .from('rooms')
                .select('*, buildings(id, name_ru, name_en, name_hi), room_types(id, name_ru, name_en, name_hi)')
                .eq('is_active', true)
                .order('building_id')
                .order('floor');
            return (data || []).sort((a, b) => {
                if (a.building_id !== b.building_id) return 0;
                if (a.floor !== b.floor) return a.floor - b.floor;
                return naturalSort(a.number, b.number);
            });
        }

        async function loadFloorPlans() {
            const { data } = await Layout.db
                .from('floor_plans')
                .select('*')
                .order('building_id')
                .order('floor');
            return data || [];
        }

        async function loadCategories() {
            const { data } = await Layout.db.from('resident_categories').select('*').order('sort_order');
            return data || [];
        }

        async function loadTeamMembers() {
            const { data } = await Layout.db.from('team_members').select('*').order('spiritual_name');
            return data || [];
        }

        async function loadOccupancy(date = selectedDate) {
            const { data } = await Layout.db.rpc('get_room_occupancy', { target_date: date });
            return data || [];
        }

        async function loadEvents(date) {
            const { data } = await Layout.db.rpc('get_arrivals_departures', { target_date: date });
            const arr = [];
            const dep = [];
            (data || []).forEach(item => {
                if (item.event_type === 'arrival') arr.push(item);
                else dep.push(item);
            });
            return [arr, dep];
        }

        async function loadResidents(date = selectedDate) {
            const { data } = await Layout.db
                .from('residents')
                .select(`*, rooms(id, number, floor, buildings(id, name_ru, name_en, name_hi)),
                         resident_categories(id, name_ru, name_en, name_hi, color),
                         team_members(id, first_name, last_name, spiritual_name),
                         bookings(id, contact_name, contact_phone, check_in, check_out)`)
                .eq('status', 'active')
                .lte('check_in', date)
                .or(`check_out.is.null,check_out.gte.${date}`)
                .order('check_in', { ascending: false });
            return data || [];
        }

        async function loadResident(residentId) {
            const { data } = await Layout.db
                .from('residents')
                .select('*')
                .eq('id', residentId)
                .single();
            return data;
        }

        async function loadRetreats() {
            const { data } = await Layout.db
                .from('retreats')
                .select('*')
                .gte('end_date', today)
                .order('start_date');
            return data || [];
        }

        async function loadOccupancyWithBookings(date = selectedDate) {
            const { data } = await Layout.db.rpc('get_room_occupancy_with_bookings', { target_date: date });
            return data || [];
        }

        function calcOccupancyByType() {
            const result = {};
            occupancy.forEach(item => {
                const building = buildings.find(b => b.id === item.building_id);
                const slug = building?.building_types?.slug;
                if (slug) {
                    if (!result[slug]) result[slug] = { occupied: 0, capacity: 0 };
                    result[slug].occupied += item.occupied || 0;
                    result[slug].capacity += item.capacity || 0;
                }
            });
            return result;
        }

        // Загружаем резидентов для прогноза (расширенный диапазон для листания)
        async function loadWeekResidents() {
            // Загружаем данные на 4 недели назад и 8 недель вперёд
            const rangeStart = new Date(Date.now() - 28 * 86400000).toISOString().split('T')[0];
            const rangeEnd = new Date(Date.now() + 56 * 86400000).toISOString().split('T')[0];
            const { data } = await Layout.db
                .from('residents')
                .select('id, room_id, check_in, check_out, status')
                .eq('status', 'active')
                .lte('check_in', rangeEnd)
                .or(`check_out.is.null,check_out.gte.${rangeStart}`);
            return data || [];
        }

        // Рассчитываем загруженность на каждый день недели
        function calcWeekForecast(weekResidents, offset = 0) {
            const forecast = [];
            const capacityByType = {};

            // Считаем общую вместимость по типам зданий
            rooms.forEach(room => {
                const building = buildings.find(b => b.id === room.building_id);
                const slug = building?.building_types?.slug;
                if (slug) {
                    if (!capacityByType[slug]) capacityByType[slug] = 0;
                    capacityByType[slug] += room.capacity || 0;
                }
            });

            // Создаём map room_id -> building_type_slug для быстрого поиска
            const roomToType = {};
            rooms.forEach(room => {
                const building = buildings.find(b => b.id === room.building_id);
                roomToType[room.id] = building?.building_types?.slug || 'other';
            });

            // Начало недели с учётом offset
            const startDay = offset * 7;

            // Для каждого дня недели
            for (let i = 0; i < 7; i++) {
                const date = new Date(Date.now() + (startDay + i) * 86400000);
                const dateStr = date.toISOString().split('T')[0];
                const dayData = {
                    date: dateStr,
                    label: date.toLocaleDateString(Layout.currentLang === 'en' ? 'en-US' : 'ru-RU', { weekday: 'short', day: 'numeric' }),
                    guesthouse: 0,
                    team_house: 0,
                    capacity: capacityByType
                };

                // Считаем сколько резидентов будет в этот день
                weekResidents.forEach(r => {
                    if (r.check_in <= dateStr && (!r.check_out || r.check_out >= dateStr)) {
                        const type = roomToType[r.room_id];
                        if (type === 'guesthouse') dayData.guesthouse++;
                        else if (type === 'team_house') dayData.team_house++;
                    }
                });

                forecast.push(dayData);
            }

            return forecast;
        }

        function shiftWeek(direction) {
            weekOffset += direction;
            // Ограничиваем: не более 4 недель назад и 8 вперёд
            weekOffset = Math.max(-4, Math.min(8, weekOffset));
            weekForecast = calcWeekForecast(weekResidentsCache, weekOffset);
            renderChart();
        }

        // ==================== DATE NAVIGATION ====================
        function formatSelectedDate() {
            const date = new Date(selectedDate);
            const isToday = selectedDate === today;
            const isTomorrow = selectedDate === tomorrow;
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            const isYesterday = selectedDate === yesterday;

            let prefix = '';
            if (isToday) prefix = (t('today') || 'Сегодня') + ', ';
            else if (isTomorrow) prefix = (t('tomorrow') || 'Завтра') + ', ';
            else if (isYesterday) prefix = (t('yesterday') || 'Вчера') + ', ';

            const formatted = date.toLocaleDateString(Layout.currentLang === 'en' ? 'en-US' : 'ru-RU', {
                day: 'numeric',
                month: 'long'
            });

            return prefix + formatted;
        }

        function updateDateLabel() {
            const label = Layout.$('#currentDateLabel');
            if (label) {
                label.textContent = formatSelectedDate();
                // Подсветим если не сегодня
                label.classList.toggle('text-primary', selectedDate !== today);
            }
        }

        async function shiftDate(direction) {
            const date = new Date(selectedDate);
            date.setDate(date.getDate() + direction);
            selectedDate = date.toISOString().split('T')[0];
            updateDateLabel();
            await refreshDateData();
        }

        async function goToToday() {
            if (selectedDate === today) return;
            selectedDate = today;
            updateDateLabel();
            await refreshDateData();
        }

        async function refreshDateData() {
            // Перезагружаем данные для выбранной даты
            [occupancy, occupancyWithBookings, residents] = await Promise.all([
                loadOccupancy(selectedDate),
                loadOccupancyWithBookings(selectedDate),
                loadResidents(selectedDate)
            ]);
            occupancyByType = calcOccupancyByType();
            renderCurrentView();
        }

        function toggleStats() {
            statsCollapsed = !statsCollapsed;
            localStorage.setItem('srsk_stats_collapsed', statsCollapsed);
            applyStatsCollapsed();
        }

        function applyStatsCollapsed() {
            const expandedView = Layout.$('#statsExpanded');
            const collapsedView = Layout.$('#statsCollapsed');
            const collapsedContent = Layout.$('#statsCollapsedContent');
            const toggleBtn = Layout.$('#statsToggleBtn');

            if (statsCollapsed) {
                expandedView?.classList.add('hidden');
                collapsedView?.classList.remove('hidden');

                // Заполняем краткую информацию
                const gh = occupancyByType.guesthouse || { occupied: 0, capacity: 0 };
                const th = occupancyByType.team_house || { occupied: 0, capacity: 0 };
                const ghType = buildingTypes.find(bt => bt.slug === 'guesthouse');
                const thType = buildingTypes.find(bt => bt.slug === 'team_house');
                const ghColor = ghType?.color || '#8b5cf6';
                const thColor = '#3b82f6';

                const ghName = ghType ? Layout.getName(ghType) : (t('guesthouse') || 'Гостевой дом');
                const thName = thType ? Layout.getName(thType) : (t('team_houses') || 'Дома команды');

                collapsedContent.innerHTML = `
                    <span>${ghName} <strong style="color: ${ghColor}">${gh.occupied}/${gh.capacity}</strong>, ${thName.toLowerCase()} <strong style="color: ${thColor}">${th.occupied}/${th.capacity}</strong>.</span>
                    <span>${t('today') || 'Сегодня'}: <strong class="text-green-600">↓${arrivals.length}</strong> <strong class="text-orange-500">↑${departures.length}</strong></span>
                `;

                toggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>`;
            } else {
                expandedView?.classList.remove('hidden');
                collapsedView?.classList.add('hidden');
                toggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                </svg>`;
            }
        }

        // ==================== RENDER ====================
        function renderStats() {
            Layout.$('#statsCards').innerHTML = `
                <div class="text-sm font-medium opacity-60 mb-2">${t('arrivals_departures') || 'Заезд / выезд'}</div>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <div class="text-xs opacity-60 mb-1">${t('today') || 'Сегодня'}</div>
                        <div class="flex items-center justify-center gap-2">
                            <span class="font-bold text-green-600">↓${arrivals.length}</span>
                            <span class="font-bold text-orange-500">↑${departures.length}</span>
                        </div>
                    </div>
                    <div>
                        <div class="text-xs opacity-60 mb-1">${t('tomorrow') || 'Завтра'}</div>
                        <div class="flex items-center justify-center gap-2">
                            <span class="font-bold text-green-600">↓${tomorrowArrivals.length}</span>
                            <span class="font-bold text-orange-500">↑${tomorrowDepartures.length}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderChart() {
            const ctx = Layout.$('#occupancyChart');
            if (!ctx) return;

            const ghType = buildingTypes.find(bt => bt.slug === 'guesthouse');
            const thType = buildingTypes.find(bt => bt.slug === 'team_house');
            const ghColor = ghType?.color || '#8b5cf6';
            // Используем синий для команды вместо зелёного (чтобы не путать со "свободно")
            const thColor = '#3b82f6';

            const labels = weekForecast.map(d => d.label);
            const ghData = weekForecast.map(d => d.guesthouse);
            const thData = weekForecast.map(d => d.team_house);

            // Обновляем лейбл недели
            const weekLabel = Layout.$('#chartWeekLabel');
            if (weekLabel && weekForecast.length > 0) {
                const first = weekForecast[0];
                const last = weekForecast[weekForecast.length - 1];
                const formatDate = d => new Date(d.date).toLocaleDateString(Layout.currentLang === 'en' ? 'en-US' : 'ru-RU', { day: 'numeric', month: 'short' });
                weekLabel.textContent = `${formatDate(first)} — ${formatDate(last)}`;
            }

            // Уничтожаем предыдущий график если есть
            if (occupancyChart) {
                occupancyChart.destroy();
            }

            occupancyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: ghType ? Layout.getName(ghType) : 'Гостевой дом',
                            data: ghData,
                            backgroundColor: ghColor + '99',
                            borderColor: ghColor,
                            borderWidth: 1,
                            borderRadius: 3
                        },
                        {
                            label: thType ? Layout.getName(thType) : 'Дома команды',
                            data: thData,
                            backgroundColor: thColor + '99',
                            borderColor: thColor,
                            borderWidth: 1,
                            borderRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const dayData = weekForecast[context.dataIndex];
                                    const type = context.datasetIndex === 0 ? 'guesthouse' : 'team_house';
                                    const typeName = context.datasetIndex === 0
                                        ? (ghType ? Layout.getName(ghType) : 'Гостевой')
                                        : (thType ? Layout.getName(thType) : 'Команда');
                                    const capacity = dayData.capacity[type] || 0;
                                    return `${typeName}: ${context.raw} / ${capacity}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 10 } }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 10, font: { size: 10 } },
                            grid: { color: '#e5e7eb40' }
                        }
                    }
                }
            });
        }

        // Фильтр зданий (чипы с возможностью множественного выбора)
        let selectedBuildings = new Set(); // пустой = все

        function renderBuildingChips() {
            const container = Layout.$('#buildingFilterRow');
            const allSelected = selectedBuildings.size === 0;

            container.innerHTML = `
                <div class="flex flex-wrap gap-2">
                    <button type="button" onclick="selectAllBuildings()" class="badge badge-lg transition-all ${allSelected ? 'badge-neutral' : 'badge-outline opacity-40'}">
                        ${t('all') || 'Все'}
                    </button>
                    ${buildings.map(b => {
                        const color = b.building_types?.color || '#6366f1';
                        const isSelected = allSelected || selectedBuildings.has(b.id);
                        return `
                            <button type="button" onclick="toggleBuilding('${b.id}')" class="badge badge-lg gap-1 transition-all ${isSelected ? '' : 'opacity-40'}" style="background-color: ${isSelected ? color + '20' : 'transparent'}; border-color: ${color}; color: ${isSelected ? color : 'inherit'}">
                                <span class="w-2 h-2 rounded-full" style="background-color: ${color}"></span>
                                ${Layout.getName(b)}
                            </button>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function selectAllBuildings() {
            selectedBuildings.clear();
            renderBuildingChips();
            renderCurrentView();
        }

        function toggleBuilding(buildingId) {
            if (selectedBuildings.has(buildingId)) {
                selectedBuildings.delete(buildingId);
            } else {
                selectedBuildings.add(buildingId);
            }
            // Если все выбраны — сбрасываем (показываем все)
            if (selectedBuildings.size === buildings.length) {
                selectedBuildings.clear();
            }
            renderBuildingChips();
            renderCurrentView();
        }

        function isBuildingVisible(buildingId) {
            return selectedBuildings.size === 0 || selectedBuildings.has(buildingId);
        }

        // ==================== VIEWS ====================
        function switchView(view) {
            currentView = view;
            // Update tabs
            Layout.$$('.tabs-boxed .tab').forEach(tab => {
                tab.classList.toggle('tab-active', tab.dataset.view === view);
            });
            // Show/hide views
            Layout.$('#viewRooms').classList.toggle('hidden', view !== 'rooms');
            Layout.$('#viewGuests').classList.toggle('hidden', view !== 'guests');
            Layout.$('#viewPlan').classList.toggle('hidden', view !== 'plan');
            // Show/hide building filter (only for rooms view)
            Layout.$('#buildingFilterRow').classList.toggle('hidden', view === 'plan');

            renderCurrentView();
        }

        function renderCurrentView() {
            if (currentView === 'rooms') renderRooms();
            else if (currentView === 'guests') renderGuests();
            else if (currentView === 'plan') renderPlanView();
        }

        function renderRooms() {
            const list = Layout.$('#viewRooms');

            // Если есть поиск — находим комнаты где живёт найденный гость
            let matchingRoomIds = null;
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                matchingRoomIds = new Set(
                    residents
                        .filter(r => getDisplayName(r).toLowerCase().includes(query))
                        .map(r => r.room_id)
                );
            }

            // Group by building
            const byBuilding = {};
            occupancy.forEach(room => {
                if (!isBuildingVisible(room.building_id)) return;
                // Фильтр по поиску
                if (matchingRoomIds && !matchingRoomIds.has(room.room_id)) return;
                if (!byBuilding[room.building_id]) {
                    byBuilding[room.building_id] = {
                        name: room.building_name_ru,
                        name_en: room.building_name_en,
                        rooms: []
                    };
                }
                byBuilding[room.building_id].rooms.push(room);
            });

            if (Object.keys(byBuilding).length === 0) {
                list.innerHTML = `<div class="text-center py-8 opacity-50">${searchQuery ? 'Ничего не найдено' : 'Нет данных'}</div>`;
                return;
            }

            list.innerHTML = Object.entries(byBuilding).map(([buildingId, building]) => {
                const buildingObj = buildings.find(b => b.id === buildingId);
                const color = buildingObj?.building_types?.color || '#6366f1';

                // Сортируем комнаты по номеру (натуральная сортировка: 1, 2, 3, ..., 10, 11)
                building.rooms.sort((a, b) => naturalSort(a.room_number, b.room_number));

                return `
                    <div class="bg-base-100 rounded-lg shadow-sm overflow-hidden" style="border-left: 4px solid ${color}">
                        <div class="p-4 border-b border-base-200">
                            <h2 class="font-semibold text-lg">${Layout.currentLang === 'ru' ? building.name : building.name_en || building.name}</h2>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 p-4">
                            ${building.rooms.map(room => {
                                // Получаем данные с разделением occupied/booked/needs_cleaning
                                const roomWithBookings = occupancyWithBookings.find(r => r.room_id === room.room_id);
                                const occupied = roomWithBookings?.occupied ?? room.occupied ?? 0;
                                const booked = roomWithBookings?.booked ?? 0;
                                const needsCleaning = roomWithBookings?.needs_cleaning ?? 0;
                                const capacity = room.capacity || 1;

                                let statusIcon = '🟢';
                                let borderColor = '#10b981'; // green
                                let statusLabel = '';

                                if (needsCleaning > 0) {
                                    // Требует уборки (выезд сегодня) - КРАСНЫЙ, важно!
                                    statusIcon = '🧹';
                                    borderColor = '#ef4444'; // red
                                    statusLabel = `<div class="text-xs text-error font-medium">${t('needs_cleaning') || 'Уборка'}</div>`;
                                } else if (occupied >= capacity) {
                                    // Полностью заселено
                                    statusIcon = '🟣';
                                    borderColor = '#8b5cf6'; // purple
                                } else if (occupied > 0) {
                                    // Частично заселено
                                    statusIcon = '🟠';
                                    borderColor = '#f59e0b'; // orange
                                } else if (booked > 0) {
                                    // Только забронировано (не заселено)
                                    statusIcon = '🟡';
                                    borderColor = '#eab308'; // yellow
                                }

                                // Формируем текст занятости
                                let occupancyText = `${occupied}/${capacity}`;
                                if (booked > 0) {
                                    occupancyText = `${occupied}+${booked}/${capacity}`;
                                }

                                return `
                                    <div class="bg-base-200/50 rounded-lg p-3 cursor-pointer hover:bg-base-200 transition-colors"
                                         style="border-left: 4px solid ${borderColor}"
                                         onclick="openRoomModal('${room.room_id}')">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="font-bold">${room.room_number}</span>
                                            <span class="text-xs">${statusIcon}</span>
                                        </div>
                                        <div class="text-sm opacity-60">
                                            ${occupancyText} ${t('beds')}
                                        </div>
                                        ${statusLabel}
                                        ${!statusLabel && room.room_type_name_ru ? `
                                            <div class="text-xs opacity-40 mt-1">${Layout.currentLang === 'ru' ? room.room_type_name_ru : room.room_type_name_en || room.room_type_name_ru}</div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getDisplayName(resident) {
            if (resident.team_members) {
                const tm = resident.team_members;
                const name = tm.spiritual_name || `${tm.first_name} ${tm.last_name || ''}`.trim();
                return Layout.currentLang === 'ru' ? name : Layout.transliterate(name);
            }
            return resident.guest_name || '—';
        }

        function renderGuests() {
            const list = Layout.$('#viewGuests');

            // Filter by search and buildings
            let filtered = residents.filter(r => {
                // Building filter
                if (!isBuildingVisible(r.rooms?.buildings?.id)) return false;
                // Search filter
                if (searchQuery) {
                    const name = getDisplayName(r).toLowerCase();
                    if (!name.includes(searchQuery.toLowerCase())) return false;
                }
                return true;
            });

            if (filtered.length === 0) {
                list.innerHTML = `<div class="text-center py-8 opacity-50">${searchQuery ? 'Ничего не найдено' : 'Нет проживающих'}</div>`;
                return;
            }

            list.innerHTML = filtered.map(resident => {
                const room = resident.rooms;
                const building = room?.buildings;
                const category = resident.resident_categories;
                const displayName = getDisplayName(resident);

                return `
                    <div class="bg-base-100 rounded-lg shadow-sm overflow-hidden border-l-4 cursor-pointer hover:shadow-md transition-shadow"
                         style="border-color: ${category?.color || '#6366f1'}"
                         onclick="openRoomModal('${room?.id}')">
                        <div class="p-4 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                            <div class="flex items-center gap-3">
                                <div class="avatar placeholder">
                                    <div class="bg-primary text-primary-content rounded-full w-10 h-10">
                                        <span class="text-lg">${displayName.charAt(0)}</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="font-semibold">${displayName}</div>
                                    <div class="text-sm opacity-60">${building ? Layout.getName(building) : ''} / ${room?.number || '—'}</div>
                                </div>
                            </div>
                            <div class="flex flex-wrap items-center gap-2">
                                ${category ? `<span class="badge badge-sm" style="background-color: ${category.color}20; color: ${category.color}; border-color: ${category.color}">${Layout.getName(category)}</span>` : ''}
                                <span class="text-sm opacity-60">до ${resident.check_out ? new Date(resident.check_out).toLocaleDateString() : '∞'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Цвета статусов для плана
        const statusColors = {
            available: '#10b981',    // Зелёный - свободно
            occupied: '#8b5cf6',     // Фиолетовый - заселено
            booked: '#eab308',       // Жёлтый - забронировано
            cleaning: '#ef4444',     // Красный - требует уборки (выезд сегодня)
            maintenance: '#6b7280',  // Серый - на ремонте
            mothballed: '#9ca3af'    // Светло-серый - законсервировано
        };

        function renderPlanView() {
            const container = Layout.$('#viewPlan');

            // Группируем планы по зданиям
            const plansByBuilding = {};
            floorPlans.forEach(plan => {
                if (!plansByBuilding[plan.building_id]) {
                    plansByBuilding[plan.building_id] = [];
                }
                plansByBuilding[plan.building_id].push(plan);
            });

            // Фильтруем здания по выбранным чипам
            const visibleBuildings = buildings.filter(b => isBuildingVisible(b.id));

            if (visibleBuildings.length === 0) {
                container.innerHTML = '<div class="text-center py-8 opacity-50">Нет данных</div>';
                return;
            }

            container.innerHTML = visibleBuildings.map(building => {
                const color = building.building_types?.color || '#6366f1';
                const plans = (plansByBuilding[building.id] || []).sort((a, b) => a.floor - b.floor);

                if (plans.length === 0) {
                    return `
                        <div class="bg-base-100 rounded-lg shadow-sm overflow-hidden" style="border-left: 4px solid ${color}">
                            <div class="p-4 border-b border-base-200">
                                <h2 class="font-semibold text-lg">${Layout.getName(building)}</h2>
                            </div>
                            <div class="p-8 text-center opacity-50">
                                <p>${t('floor_plan_no_plan') || 'Планы этажей не загружены'}</p>
                                <a href="floor-plan.html?building=${building.id}" class="btn btn-sm btn-outline mt-2">${t('floor_plan_upload') || 'Загрузить'}</a>
                            </div>
                        </div>
                    `;
                }

                // Сетка на 3 колонки
                return `
                    <div class="bg-base-100 rounded-lg shadow-sm overflow-hidden" style="border-left: 4px solid ${color}">
                        <div class="p-3 border-b border-base-200 flex items-center justify-between">
                            <h2 class="font-semibold">${Layout.getName(building)}</h2>
                            <a href="floor-plan.html?building=${building.id}" class="btn btn-ghost btn-xs gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                                ${t('edit') || 'Ред.'}
                            </a>
                        </div>
                        <div class="grid grid-cols-3 gap-px bg-base-200">
                            ${plans.map(plan => `
                                <div class="bg-base-100 p-2">
                                    <div class="text-xs font-medium mb-1 opacity-60">${t('floor_plan_floor') || 'Этаж'} ${plan.floor}</div>
                                    <div class="floor-plan-container" data-building="${building.id}" data-floor="${plan.floor}">
                                        <img src="${plan.image_url}" alt="Этаж ${plan.floor}" onload="renderPlanMarkers('${building.id}', ${plan.floor})" />
                                        <svg class="floor-plan-svg" id="planSvg_${building.id}_${plan.floor}" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
                                    </div>
                                </div>
                            `).join('')}
                            ${plans.length < 3 ? `<div class="bg-base-100"></div>`.repeat(3 - plans.length) : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPlanMarkers(buildingId, floor) {
            const svg = Layout.$(`#planSvg_${buildingId}_${floor}`);
            if (!svg) return;

            svg.innerHTML = '';

            // Находим комнаты этого этажа
            const floorRooms = rooms.filter(r =>
                r.building_id === buildingId &&
                r.floor === floor &&
                r.plan_x != null &&
                r.plan_y != null
            );

            floorRooms.forEach(room => {
                const roomOcc = occupancyWithBookings.find(o => o.room_id === room.id);
                const occupied = roomOcc?.occupied || 0;
                const booked = roomOcc?.booked || 0;
                const needsCleaning = roomOcc?.needs_cleaning || 0;
                const capacity = roomOcc?.capacity || room.capacity || 1;

                const x = parseFloat(room.plan_x);
                const y = parseFloat(room.plan_y);
                const w = parseFloat(room.plan_width) || 8;
                const h = parseFloat(room.plan_height) || 8;

                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('data-room-id', room.id);
                g.style.cursor = 'pointer';
                g.onclick = () => openRoomModal(room.id);

                // Проверяем особые статусы (приоритет: уборка > ремонт > консервация)
                const baseStatus = needsCleaning > 0 ? 'cleaning' :
                                   room.status === 'maintenance' ? 'maintenance' :
                                   room.status === 'mothballed' ? 'mothballed' : null;

                if (baseStatus) {
                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', x);
                    rect.setAttribute('y', y);
                    rect.setAttribute('width', w);
                    rect.setAttribute('height', h);
                    rect.setAttribute('fill', statusColors[baseStatus]);
                    g.appendChild(rect);
                } else if (capacity === 2) {
                    const halfW = w / 2;
                    for (let i = 0; i < 2; i++) {
                        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        rect.setAttribute('x', x + i * halfW);
                        rect.setAttribute('y', y);
                        rect.setAttribute('width', halfW);
                        rect.setAttribute('height', h);
                        // Сначала занятые, потом забронированные, потом свободные
                        const bedStatus = i < occupied ? 'occupied' : (i < occupied + booked ? 'booked' : 'available');
                        rect.setAttribute('fill', statusColors[bedStatus]);
                        rect.setAttribute('stroke', '#e5e7eb');
                        rect.setAttribute('stroke-width', '0.15');
                        g.appendChild(rect);
                    }
                } else if (capacity === 3) {
                    const thirdW = w / 3;
                    for (let i = 0; i < 3; i++) {
                        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        rect.setAttribute('x', x + i * thirdW);
                        rect.setAttribute('y', y);
                        rect.setAttribute('width', thirdW);
                        rect.setAttribute('height', h);
                        const bedStatus = i < occupied ? 'occupied' : (i < occupied + booked ? 'booked' : 'available');
                        rect.setAttribute('fill', statusColors[bedStatus]);
                        rect.setAttribute('stroke', '#e5e7eb');
                        rect.setAttribute('stroke-width', '0.15');
                        g.appendChild(rect);
                    }
                } else if (capacity === 4) {
                    const halfW = w / 2;
                    const halfH = h / 2;
                    const positions = [[0, 0], [1, 0], [0, 1], [1, 1]];
                    for (let i = 0; i < 4; i++) {
                        const [px, py] = positions[i];
                        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        rect.setAttribute('x', x + px * halfW);
                        rect.setAttribute('y', y + py * halfH);
                        rect.setAttribute('width', halfW);
                        rect.setAttribute('height', halfH);
                        const bedStatus = i < occupied ? 'occupied' : (i < occupied + booked ? 'booked' : 'available');
                        rect.setAttribute('fill', statusColors[bedStatus]);
                        rect.setAttribute('stroke', '#e5e7eb');
                        rect.setAttribute('stroke-width', '0.15');
                        g.appendChild(rect);
                    }
                } else {
                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', x);
                    rect.setAttribute('y', y);
                    rect.setAttribute('width', w);
                    rect.setAttribute('height', h);
                    const bedStatus = occupied > 0 ? 'occupied' : (booked > 0 ? 'booked' : 'available');
                    rect.setAttribute('fill', statusColors[bedStatus]);
                    g.appendChild(rect);
                }

                // Номер комнаты
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x + w / 2);
                text.setAttribute('y', y + h / 2);
                text.classList.add('room-label');
                text.textContent = room.number;

                g.appendChild(text);
                svg.appendChild(g);
            });
        }

        // ==================== ROOM MODAL ====================
        async function openRoomModal(roomId) {
            selectedRoomId = roomId;
            const room = occupancyWithBookings.find(r => r.room_id === roomId) || occupancy.find(r => r.room_id === roomId);
            if (!room) return;

            // Находим жильцов комнаты (включая placeholder от броней)
            const roomResidents = residents.filter(r => r.room_id === roomId);

            // Разделяем на заселённых и забронированных
            const checkedIn = roomResidents.filter(r => r.team_member_id || r.guest_name);
            const bookedPlaceholders = roomResidents.filter(r => r.booking_id && !r.team_member_id && !r.guest_name);

            const modalHtml = `
                <dialog id="roomModal" class="modal modal-open">
                    <div class="modal-box max-w-md relative">
                        <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeRoomModal()">✕</button>
                        <h3 class="font-bold text-lg mb-4">${t('room_number')} ${room.room_number}</h3>

                        <div class="space-y-4">
                            <div class="bg-base-200 rounded-lg p-4">
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div class="opacity-60">${t('room_building')}</div>
                                    <div class="font-medium">${room.building_name_ru}</div>
                                    <div class="opacity-60">${t('room_floor')}</div>
                                    <div class="font-medium">${room.floor}</div>
                                    <div class="opacity-60">${t('stat_occupied')}</div>
                                    <div class="font-medium">${room.occupied || 0} / ${room.capacity}</div>
                                    ${(room.booked || 0) > 0 ? `
                                        <div class="opacity-60">${t('floor_plan_booked') || 'Забронировано'}</div>
                                        <div class="font-medium text-warning">${room.booked}</div>
                                    ` : ''}
                                </div>
                            </div>

                            ${checkedIn.length > 0 ? `
                                <div>
                                    <h4 class="font-medium mb-2">${t('room_residents') || 'Проживающие'}</h4>
                                    <div class="space-y-2">
                                        ${checkedIn.map(r => `
                                            <div class="flex items-center justify-between p-2 bg-base-200 rounded">
                                                <div class="font-medium">${getDisplayName(r)}</div>
                                                <div class="text-xs opacity-60">до ${r.check_out ? new Date(r.check_out).toLocaleDateString() : '∞'}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${bookedPlaceholders.length > 0 ? `
                                <div>
                                    <h4 class="font-medium mb-2 text-warning">${t('floor_plan_booked') || 'Забронировано'}</h4>
                                    <div class="space-y-2">
                                        ${bookedPlaceholders.map(r => `
                                            <div class="flex items-center justify-between p-2 bg-warning/20 rounded border border-warning/30 cursor-pointer hover:bg-warning/30 transition-colors" onclick="closeRoomModal(); openCheckinBookingModal('${r.id}')">
                                                <div class="flex items-center gap-2">
                                                    <span class="badge badge-warning badge-sm">${t('booking_placeholder') || 'Бронь'}</span>
                                                    <span class="text-sm opacity-70">до ${r.check_out ? new Date(r.check_out).toLocaleDateString() : '∞'}</span>
                                                </div>
                                                <div class="text-xs text-primary font-medium">${t('booking_checkin_title') || 'Заселить'} →</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${checkedIn.length === 0 && bookedPlaceholders.length === 0 ? `
                                <div class="text-center py-4 opacity-50">${t('room_no_residents') || 'Комната свободна'}</div>
                            ` : ''}
                        </div>

                        <div class="modal-action">
                            <button type="button" class="btn btn-primary gap-1" onclick="closeRoomModal(); openResidentModal(null, '${roomId}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                ${t('add_resident')}
                            </button>
                            <button type="button" class="btn btn-ghost" onclick="closeRoomModal()">${t('close') || 'Закрыть'}</button>
                        </div>
                    </div>
                    <form method="dialog" class="modal-backdrop"><button onclick="closeRoomModal()">close</button></form>
                </dialog>
            `;

            // Удаляем старую модалку если есть
            const oldModal = Layout.$('#roomModal');
            if (oldModal) oldModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeRoomModal() {
            const modal = Layout.$('#roomModal');
            if (modal) modal.remove();
            selectedRoomId = null;
        }

        // ==================== RESIDENT MODAL ====================
        function populateResidentSelects() {
            // Rooms grouped by building
            const roomSelect = Layout.$('#roomSelect');
            roomSelect.innerHTML = `<option value="">— ${t('select_room')} —</option>`;
            const byBuilding = {};
            rooms.forEach(r => {
                if (!byBuilding[r.building_id]) byBuilding[r.building_id] = [];
                byBuilding[r.building_id].push(r);
            });
            Object.entries(byBuilding).forEach(([buildingId, bldgRooms]) => {
                const building = buildings.find(b => b.id === buildingId);
                const optgroup = document.createElement('optgroup');
                optgroup.label = Layout.getName(building);
                bldgRooms.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r.id;
                    opt.textContent = `${r.number} (${r.floor} ${t('floor_n')})`;
                    optgroup.appendChild(opt);
                });
                roomSelect.appendChild(optgroup);
            });

            // Categories
            const categorySelect = Layout.$('#categorySelect');
            categorySelect.innerHTML = `<option value="">—</option>` +
                categories.map(c => `<option value="${c.id}">${Layout.getName(c)}</option>`).join('');

            // Team members
            const teamMemberSelect = Layout.$('#teamMemberSelect');
            teamMemberSelect.innerHTML = `<option value="">— ${t('or_enter_guest')} —</option>` +
                teamMembers.map(m => {
                    const name = m.spiritual_name || `${m.first_name} ${m.last_name || ''}`.trim();
                    return `<option value="${m.id}">${Layout.currentLang === 'ru' ? name : Layout.transliterate(name)}</option>`;
                }).join('');
        }

        async function openResidentModal(residentId = null, preselectedRoomId = null) {
            editingResidentId = residentId;
            const form = Layout.$('#residentForm');
            const title = Layout.$('#residentModalTitle');
            const deleteSection = Layout.$('#deleteResidentSection');

            form.reset();
            populateResidentSelects();

            // Set default date to today
            form.check_in.value = today;

            // Pre-select room if provided
            if (preselectedRoomId) {
                form.room_id.value = preselectedRoomId;
            }

            if (residentId) {
                // Загружаем данные резидента для редактирования
                const resident = await loadResident(residentId);
                if (resident) {
                    form.id.value = resident.id;
                    form.room_id.value = resident.room_id || '';
                    form.category_id.value = resident.category_id || '';
                    form.team_member_id.value = resident.team_member_id || '';
                    form.guest_name.value = resident.guest_name || '';
                    form.guest_phone.value = resident.guest_phone || '';
                    form.guest_email.value = resident.guest_email || '';
                    form.guest_country.value = resident.guest_country || '';
                    form.check_in.value = resident.check_in || '';
                    form.check_out.value = resident.check_out || '';
                    form.notes.value = resident.notes || '';
                }
                title.textContent = t('edit_resident');
                deleteSection.classList.remove('hidden');
            } else {
                title.textContent = t('add_resident');
                deleteSection.classList.add('hidden');
            }

            // Toggle guest data based on team member selection
            Layout.$('#teamMemberSelect').addEventListener('change', toggleGuestData);
            toggleGuestData();

            Layout.$('#residentModal').showModal();
        }

        function toggleGuestData() {
            const teamMemberId = Layout.$('#teamMemberSelect').value;
            const guestSection = Layout.$('#guestDataSection');
            if (teamMemberId) {
                guestSection.classList.add('opacity-50');
                guestSection.querySelectorAll('input').forEach(i => i.disabled = true);
            } else {
                guestSection.classList.remove('opacity-50');
                guestSection.querySelectorAll('input').forEach(i => i.disabled = false);
            }
        }

        function closeResidentModal() {
            Layout.$('#residentModal').close();
            editingResidentId = null;
        }

        async function saveResident(e) {
            e.preventDefault();
            const form = Layout.$('#residentForm');

            const teamMemberId = form.team_member_id.value;
            const guestName = form.guest_name.value.trim();

            if (!teamMemberId && !guestName) {
                alert('Выберите члена команды или введите имя гостя');
                return;
            }

            const data = {
                room_id: form.room_id.value,
                category_id: form.category_id.value || null,
                team_member_id: teamMemberId || null,
                guest_name: teamMemberId ? null : guestName,
                guest_phone: teamMemberId ? null : form.guest_phone.value.trim() || null,
                guest_email: teamMemberId ? null : form.guest_email.value.trim() || null,
                guest_country: teamMemberId ? null : form.guest_country.value.trim() || null,
                check_in: form.check_in.value,
                check_out: form.check_out.value || null,
                notes: form.notes.value.trim() || null,
                status: 'active'
            };

            try {
                if (editingResidentId) {
                    const { error } = await Layout.db.from('residents').update(data).eq('id', editingResidentId);
                    if (error) throw error;
                } else {
                    const { error } = await Layout.db.from('residents').insert(data);
                    if (error) throw error;
                }

                closeResidentModal();
                await refreshData();
            } catch (err) {
                console.error('Error saving resident:', err);
                alert('Ошибка сохранения: ' + err.message);
            }
        }

        async function deleteResident() {
            if (!editingResidentId) return;
            if (!confirm(t('delete_resident_confirm'))) return;

            try {
                const { error } = await Layout.db.from('residents').delete().eq('id', editingResidentId);
                if (error) throw error;

                closeResidentModal();
                await refreshData();
            } catch (err) {
                console.error('Error deleting resident:', err);
                alert('Ошибка удаления: ' + err.message);
            }
        }

        // ==================== BOOKING MODAL ====================
        function openBookingModal(bookingId = null) {
            editingBookingId = bookingId;
            bookingStep = 1;
            bookingSelectedBeds.clear();

            const form = Layout.$('#bookingForm');
            const title = Layout.$('#bookingModalTitle');

            form.reset();
            form.check_in.value = today;
            form.check_out.value = '';

            // Populate retreat select
            const retreatSelect = Layout.$('#bookingRetreatSelect');
            retreatSelect.innerHTML = `<option value="">—</option>` +
                retreats.map(r => `<option value="${r.id}">${Layout.getName(r)}</option>`).join('');

            // Populate building select for step 2
            const buildingSelect = Layout.$('#bookingBuildingSelect');
            buildingSelect.innerHTML = buildings.map(b =>
                `<option value="${b.id}">${Layout.getName(b)}</option>`
            ).join('');
            bookingBuildingId = buildings[0]?.id;

            // Populate building scope select for step 1
            const guesthouse = buildings.find(b => b.name_ru === 'Гостевой дом' || b.name_en === 'Guest House');
            const buildingScopeSelect = Layout.$('#bookingBuildingScope');
            buildingScopeSelect.innerHTML =
                (guesthouse ? `<option value="${guesthouse.id}">${Layout.getName(guesthouse)}</option>` : '') +
                `<option value="all">${t('booking_all_buildings') || 'Все здания'}</option>` +
                buildings.filter(b => b.id !== guesthouse?.id).map(b =>
                    `<option value="${b.id}">${Layout.getName(b)}</option>`
                ).join('');

            if (bookingId) {
                title.textContent = t('booking_edit');
                // TODO: Load existing booking data
            } else {
                title.textContent = t('booking_title');
            }

            updateBookingStepIndicators();
            Layout.$('#bookingStep1').classList.remove('hidden');
            Layout.$('#bookingStep2').classList.add('hidden');

            Layout.$('#bookingModal').showModal();
        }

        function closeBookingModal() {
            Layout.$('#bookingModal').close();
            editingBookingId = null;
            bookingSelectedBeds.clear();
        }

        function updateBookingStepIndicators() {
            const step1 = Layout.$('#bookingStep1Indicator');
            const step2 = Layout.$('#bookingStep2Indicator');

            if (bookingStep === 1) {
                step1.classList.remove('opacity-40');
                step1.querySelector('span:first-child').classList.add('bg-primary', 'text-primary-content');
                step1.querySelector('span:first-child').classList.remove('bg-base-300');
                step2.classList.add('opacity-40');
                step2.querySelector('span:first-child').classList.remove('bg-primary', 'text-primary-content');
                step2.querySelector('span:first-child').classList.add('bg-base-300');
            } else {
                step1.classList.add('opacity-40');
                step1.querySelector('span:first-child').classList.remove('bg-primary', 'text-primary-content');
                step1.querySelector('span:first-child').classList.add('bg-base-300');
                step2.classList.remove('opacity-40');
                step2.querySelector('span:first-child').classList.add('bg-primary', 'text-primary-content');
                step2.querySelector('span:first-child').classList.remove('bg-base-300');
            }
        }

        async function goToBookingStep2() {
            const form = Layout.$('#bookingForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const bedsCount = parseInt(form.beds_count.value) || 1;
            const checkIn = form.check_in.value;
            const checkOut = form.check_out.value;
            const buildingScope = form.building_scope.value;

            // Определяем building_ids для проверки
            const buildingIds = buildingScope === 'all' ? null : [buildingScope];

            // Проверяем доступность на весь период
            const { data: problemDates, error } = await Layout.db.rpc('check_booking_availability', {
                p_check_in: checkIn,
                p_check_out: checkOut,
                p_beds_needed: bedsCount,
                p_building_ids: buildingIds
            });

            if (error) {
                console.error('Error checking availability:', error);
            } else if (problemDates && problemDates.length > 0) {
                // Форматируем даты для показа пользователю
                const dateFormatter = new Intl.DateTimeFormat('ru-RU', { day: 'numeric', month: 'long' });
                const problemDatesStr = problemDates.map(d => {
                    const date = new Date(d.problem_date);
                    return `${dateFormatter.format(date)} (свободно ${d.available_beds} из ${d.total_capacity})`;
                }).join('\n');

                const buildingName = buildingScope === 'all'
                    ? (t('booking_all_buildings') || 'Все здания')
                    : buildings.find(b => b.id === buildingScope)?.name_ru || '';

                alert(`Бронирование невозможно!\n\n${buildingName}: на следующие даты недостаточно свободных мест:\n${problemDatesStr}\n\nТребуется: ${bedsCount} мест`);
                return;
            }

            bookingStep = 2;
            updateBookingStepIndicators();
            Layout.$('#bookingStep1').classList.add('hidden');
            Layout.$('#bookingStep2').classList.remove('hidden');

            // Устанавливаем выбранное здание для отображения плана (или первое, если "все")
            const buildingSelect = Layout.$('#bookingBuildingSelect');
            if (buildingScope !== 'all') {
                buildingSelect.value = buildingScope;
                bookingBuildingId = buildingScope;
            }

            // Update total count
            Layout.$('#bookingTotalCount').textContent = bedsCount;
            Layout.$('#bookingSelectedCount').textContent = bookingSelectedBeds.size;

            renderBookingPlan();
        }

        function goToBookingStep1() {
            bookingStep = 1;
            updateBookingStepIndicators();
            Layout.$('#bookingStep1').classList.remove('hidden');
            Layout.$('#bookingStep2').classList.add('hidden');
        }

        async function renderBookingPlan() {
            const container = Layout.$('#bookingPlanContainer');
            const buildingSelect = Layout.$('#bookingBuildingSelect');
            bookingBuildingId = buildingSelect.value;

            const form = Layout.$('#bookingForm');
            const checkIn = form.check_in.value;
            const checkOut = form.check_out.value;

            // Load occupancy for the booking dates
            const { data: bookingOccupancy } = await Layout.db.rpc('get_room_occupancy_with_bookings', { target_date: checkIn });

            // Get floor plans for selected building
            const buildingPlans = floorPlans.filter(p => p.building_id === bookingBuildingId).sort((a, b) => a.floor - b.floor);
            const buildingRooms = rooms.filter(r => r.building_id === bookingBuildingId);

            if (buildingPlans.length === 0) {
                container.innerHTML = `<div class="col-span-2 text-center py-8 opacity-50">${t('floor_plan_no_plan') || 'Планы этажей не загружены'}</div>`;
                return;
            }

            container.innerHTML = buildingPlans.map(plan => `
                <div class="bg-base-200 rounded-lg p-2">
                    <div class="text-xs font-medium mb-1 opacity-60">${t('floor_plan_floor') || 'Этаж'} ${plan.floor}</div>
                    <div class="floor-plan-container relative">
                        <img src="${plan.image_url}" alt="Этаж ${plan.floor}" class="w-full" />
                        <svg class="floor-plan-svg absolute top-0 left-0 w-full h-full" id="bookingPlanSvg_${plan.floor}" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
                    </div>
                </div>
            `).join('');

            // Render markers for each floor
            buildingPlans.forEach(plan => {
                renderBookingPlanMarkers(plan.floor, buildingRooms, bookingOccupancy || []);
            });
        }

        function renderBookingPlanMarkers(floor, buildingRooms, bookingOccupancy) {
            const svg = Layout.$(`#bookingPlanSvg_${floor}`);
            if (!svg) return;

            svg.innerHTML = '';

            const floorRooms = buildingRooms.filter(r =>
                r.floor === floor &&
                r.plan_x != null &&
                r.plan_y != null &&
                r.status !== 'maintenance' &&
                r.status !== 'mothballed'
            );

            floorRooms.forEach(room => {
                const roomOcc = bookingOccupancy.find(o => o.room_id === room.id);
                const occupied = roomOcc?.occupied || 0;
                const booked = roomOcc?.booked || 0;
                const capacity = roomOcc?.capacity || room.capacity || 1;

                const x = parseFloat(room.plan_x);
                const y = parseFloat(room.plan_y);
                const w = parseFloat(room.plan_width) || 8;
                const h = parseFloat(room.plan_height) || 8;

                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('data-room-id', room.id);

                // Render beds based on capacity
                if (capacity === 2) {
                    const halfW = w / 2;
                    for (let i = 0; i < 2; i++) {
                        const bedKey = `${room.id}_${i}`;
                        const isOccupied = i < occupied;
                        const isBooked = i >= occupied && i < occupied + booked;
                        const isSelected = bookingSelectedBeds.has(bedKey);
                        const isAvailable = !isOccupied && !isBooked;

                        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        rect.setAttribute('x', x + i * halfW);
                        rect.setAttribute('y', y);
                        rect.setAttribute('width', halfW);
                        rect.setAttribute('height', h);

                        if (isSelected) {
                            rect.setAttribute('fill', statusColors.available);
                            rect.setAttribute('stroke', '#6366f1');
                            rect.setAttribute('stroke-width', '0.5');
                        } else if (isOccupied) {
                            rect.setAttribute('fill', statusColors.occupied);
                        } else if (isBooked) {
                            rect.setAttribute('fill', statusColors.booked);
                        } else {
                            rect.setAttribute('fill', statusColors.available);
                        }

                        if (isAvailable || isSelected) {
                            rect.style.cursor = 'pointer';
                            rect.onclick = () => toggleBookingBed(room.id, i, capacity);
                        }

                        g.appendChild(rect);
                    }
                } else if (capacity === 3) {
                    const thirdW = w / 3;
                    for (let i = 0; i < 3; i++) {
                        const bedKey = `${room.id}_${i}`;
                        const isOccupied = i < occupied;
                        const isBooked = i >= occupied && i < occupied + booked;
                        const isSelected = bookingSelectedBeds.has(bedKey);
                        const isAvailable = !isOccupied && !isBooked;

                        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        rect.setAttribute('x', x + i * thirdW);
                        rect.setAttribute('y', y);
                        rect.setAttribute('width', thirdW);
                        rect.setAttribute('height', h);

                        if (isSelected) {
                            rect.setAttribute('fill', statusColors.available);
                            rect.setAttribute('stroke', '#6366f1');
                            rect.setAttribute('stroke-width', '0.5');
                        } else if (isOccupied) {
                            rect.setAttribute('fill', statusColors.occupied);
                        } else if (isBooked) {
                            rect.setAttribute('fill', statusColors.booked);
                        } else {
                            rect.setAttribute('fill', statusColors.available);
                        }

                        if (isAvailable || isSelected) {
                            rect.style.cursor = 'pointer';
                            rect.onclick = () => toggleBookingBed(room.id, i, capacity);
                        }

                        g.appendChild(rect);
                    }
                } else if (capacity === 4) {
                    const halfW = w / 2;
                    const halfH = h / 2;
                    const positions = [[0, 0], [1, 0], [0, 1], [1, 1]];
                    for (let i = 0; i < 4; i++) {
                        const [px, py] = positions[i];
                        const bedKey = `${room.id}_${i}`;
                        const isOccupied = i < occupied;
                        const isBooked = i >= occupied && i < occupied + booked;
                        const isSelected = bookingSelectedBeds.has(bedKey);
                        const isAvailable = !isOccupied && !isBooked;

                        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        rect.setAttribute('x', x + px * halfW);
                        rect.setAttribute('y', y + py * halfH);
                        rect.setAttribute('width', halfW);
                        rect.setAttribute('height', halfH);

                        if (isSelected) {
                            rect.setAttribute('fill', statusColors.available);
                            rect.setAttribute('stroke', '#6366f1');
                            rect.setAttribute('stroke-width', '0.5');
                        } else if (isOccupied) {
                            rect.setAttribute('fill', statusColors.occupied);
                        } else if (isBooked) {
                            rect.setAttribute('fill', statusColors.booked);
                        } else {
                            rect.setAttribute('fill', statusColors.available);
                        }

                        if (isAvailable || isSelected) {
                            rect.style.cursor = 'pointer';
                            rect.onclick = () => toggleBookingBed(room.id, i, capacity);
                        }

                        g.appendChild(rect);
                    }
                } else {
                    // Single bed room
                    const bedKey = `${room.id}_0`;
                    const isOccupied = occupied > 0;
                    const isBooked = booked > 0;
                    const isSelected = bookingSelectedBeds.has(bedKey);
                    const isAvailable = !isOccupied && !isBooked;

                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', x);
                    rect.setAttribute('y', y);
                    rect.setAttribute('width', w);
                    rect.setAttribute('height', h);

                    if (isSelected) {
                        rect.setAttribute('fill', statusColors.available);
                        rect.setAttribute('stroke', '#6366f1');
                        rect.setAttribute('stroke-width', '0.5');
                    } else if (isOccupied) {
                        rect.setAttribute('fill', statusColors.occupied);
                    } else if (isBooked) {
                        rect.setAttribute('fill', statusColors.booked);
                    } else {
                        rect.setAttribute('fill', statusColors.available);
                    }

                    if (isAvailable || isSelected) {
                        rect.style.cursor = 'pointer';
                        rect.onclick = () => toggleBookingBed(room.id, 0, capacity);
                    }

                    g.appendChild(rect);
                }

                // Room number label
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x + w / 2);
                text.setAttribute('y', y + h / 2);
                text.classList.add('room-label');
                text.textContent = room.number;
                text.style.pointerEvents = 'none';

                g.appendChild(text);
                svg.appendChild(g);
            });
        }

        function toggleBookingBed(roomId, bedIndex, capacity) {
            const bedKey = `${roomId}_${bedIndex}`;
            const form = Layout.$('#bookingForm');
            const maxBeds = parseInt(form.beds_count.value) || 1;

            if (bookingSelectedBeds.has(bedKey)) {
                bookingSelectedBeds.delete(bedKey);
            } else {
                if (bookingSelectedBeds.size >= maxBeds) {
                    // Already selected max beds
                    return;
                }
                bookingSelectedBeds.add(bedKey);
            }

            // Update counter
            Layout.$('#bookingSelectedCount').textContent = bookingSelectedBeds.size;

            // Enable/disable save button
            const saveBtn = Layout.$('#bookingSaveBtn');
            saveBtn.disabled = bookingSelectedBeds.size !== maxBeds;

            // Re-render plan to show selection
            renderBookingPlan();
        }

        async function saveBooking() {
            const form = Layout.$('#bookingForm');
            const bedsCount = parseInt(form.beds_count.value) || 1;

            if (bookingSelectedBeds.size !== bedsCount) {
                alert(`Выберите ${bedsCount} мест на плане`);
                return;
            }

            try {
                // Create booking
                const bookingData = {
                    name: form.name.value.trim() || null,
                    contact_name: form.contact_name.value.trim(),
                    contact_phone: form.contact_phone.value.trim() || null,
                    contact_email: form.contact_email.value.trim() || null,
                    contact_country: form.contact_country.value.trim() || null,
                    beds_count: bedsCount,
                    check_in: form.check_in.value,
                    check_out: form.check_out.value,
                    retreat_id: form.retreat_id.value || null,
                    notes: form.notes.value.trim() || null,
                    status: 'active'
                };

                const { data: booking, error: bookingError } = await Layout.db
                    .from('bookings')
                    .insert(bookingData)
                    .select()
                    .single();

                if (bookingError) throw bookingError;

                // Create placeholder residents for each selected bed
                const residentsData = [];
                bookingSelectedBeds.forEach(bedKey => {
                    const [roomId] = bedKey.split('_');
                    residentsData.push({
                        room_id: roomId,
                        booking_id: booking.id,
                        check_in: form.check_in.value,
                        check_out: form.check_out.value,
                        status: 'active'
                    });
                });

                const { error: residentsError } = await Layout.db
                    .from('residents')
                    .insert(residentsData);

                if (residentsError) throw residentsError;

                closeBookingModal();
                await refreshData();

            } catch (err) {
                console.error('Error saving booking:', err);
                alert('Ошибка сохранения: ' + err.message);
            }
        }

        // ==================== CHECKIN FROM BOOKING ====================
        let checkinResidentId = null;

        async function openCheckinBookingModal(residentId) {
            checkinResidentId = residentId;

            // Load resident with booking info
            const { data: resident } = await Layout.db
                .from('residents')
                .select('*, bookings(*), rooms(number, buildings(name_ru, name_en))')
                .eq('id', residentId)
                .single();

            if (!resident || !resident.bookings) return;

            const booking = resident.bookings;
            const room = resident.rooms;

            // Show booking info
            Layout.$('#checkinBookingInfo').innerHTML = `
                <strong>${booking.name || booking.contact_name}</strong> — ${room?.buildings ? Layout.getName(room.buildings) : ''} / ${room?.number || ''}
                <br>${new Date(booking.check_in).toLocaleDateString()} — ${new Date(booking.check_out).toLocaleDateString()}
            `;

            // Populate team member select
            const teamMemberSelect = Layout.$('#checkinTeamMemberSelect');
            teamMemberSelect.innerHTML = `<option value="">— ${t('or_enter_guest')} —</option>` +
                teamMembers.map(m => {
                    const name = m.spiritual_name || `${m.first_name} ${m.last_name || ''}`.trim();
                    return `<option value="${m.id}">${Layout.currentLang === 'ru' ? name : Layout.transliterate(name)}</option>`;
                }).join('');

            const form = Layout.$('#checkinBookingForm');
            form.reset();
            form.resident_id.value = residentId;

            // Pre-fill from booking contact
            form.guest_name.value = booking.contact_name || '';
            form.guest_phone.value = booking.contact_phone || '';
            form.guest_country.value = booking.contact_country || '';

            // Toggle guest data based on team member selection
            teamMemberSelect.onchange = () => {
                const guestSection = Layout.$('#checkinGuestDataSection');
                if (teamMemberSelect.value) {
                    guestSection.classList.add('opacity-50');
                    guestSection.querySelectorAll('input').forEach(i => i.disabled = true);
                } else {
                    guestSection.classList.remove('opacity-50');
                    guestSection.querySelectorAll('input').forEach(i => i.disabled = false);
                }
            };

            Layout.$('#checkinBookingModal').showModal();
        }

        function closeCheckinBookingModal() {
            Layout.$('#checkinBookingModal').close();
            checkinResidentId = null;
        }

        async function saveCheckinFromBooking(e) {
            e.preventDefault();
            if (!checkinResidentId) return;

            const form = Layout.$('#checkinBookingForm');
            const teamMemberId = form.team_member_id.value;
            const guestName = form.guest_name.value.trim();

            if (!teamMemberId && !guestName) {
                alert('Выберите члена команды или введите имя гостя');
                return;
            }

            try {
                const updateData = {
                    team_member_id: teamMemberId || null,
                    guest_name: teamMemberId ? null : guestName,
                    guest_phone: teamMemberId ? null : form.guest_phone.value.trim() || null,
                    guest_email: teamMemberId ? null : form.guest_email?.value?.trim() || null,
                    guest_country: teamMemberId ? null : form.guest_country.value.trim() || null
                };

                const { error } = await Layout.db
                    .from('residents')
                    .update(updateData)
                    .eq('id', checkinResidentId);

                if (error) throw error;

                closeCheckinBookingModal();
                await refreshData();

            } catch (err) {
                console.error('Error saving checkin:', err);
                alert('Ошибка сохранения: ' + err.message);
            }
        }

        async function refreshData() {
            const [occ, occWithBookings, res, evToday, evTomorrow, weekRes, rets] = await Promise.all([
                loadOccupancy(),
                loadOccupancyWithBookings(),
                loadResidents(),
                loadEvents(today),
                loadEvents(tomorrow),
                loadWeekResidents(),
                loadRetreats()
            ]);
            occupancy = occ;
            occupancyWithBookings = occWithBookings;
            residents = res;
            retreats = rets;
            [arrivals, departures] = evToday;
            [tomorrowArrivals, tomorrowDepartures] = evTomorrow;
            occupancyByType = calcOccupancyByType();
            weekResidentsCache = weekRes;
            weekForecast = calcWeekForecast(weekResidentsCache, weekOffset);
            render();
        }

        // ==================== RENDER ====================
        function render() {
            updateDateLabel();
            renderStats();
            renderChart();
            applyStatsCollapsed();
            renderBuildingChips();
            renderCurrentView();
        }

        function updateUI() {
            Layout.updateAllTranslations();
            render();
        }

        window.onLanguageChange = () => updateUI();

        // ==================== INIT ====================
        async function init() {
            await Layout.init({ module: 'housing', menuId: 'housing', itemId: 'occupancy' });

            // Загружаем базовые данные
            [buildingTypes, buildings, rooms, categories, teamMembers, retreats] = await Promise.all([
                loadBuildingTypes(),
                loadBuildings(),
                loadRooms(),
                loadCategories(),
                loadTeamMembers(),
                loadRetreats()
            ]);

            // Загружаем данные, зависящие от buildings
            const [occ, occWithBookings, res, plans, evToday, evTomorrow, weekRes] = await Promise.all([
                loadOccupancy(),
                loadOccupancyWithBookings(),
                loadResidents(),
                loadFloorPlans(),
                loadEvents(today),
                loadEvents(tomorrow),
                loadWeekResidents()
            ]);
            occupancy = occ;
            occupancyWithBookings = occWithBookings;
            residents = res;
            floorPlans = plans;
            [arrivals, departures] = evToday;
            [tomorrowArrivals, tomorrowDepartures] = evTomorrow;
            occupancyByType = calcOccupancyByType();
            weekResidentsCache = weekRes;
            weekForecast = calcWeekForecast(weekResidentsCache, weekOffset);

            // Search
            const searchInput = Layout.$('#searchInput');
            searchInput?.addEventListener('input', Layout.debounce(e => {
                searchQuery = e.target.value;
                renderCurrentView();
            }, 200));

            // Forms
            Layout.$('#residentForm').addEventListener('submit', saveResident);
            Layout.$('#checkinBookingForm').addEventListener('submit', saveCheckinFromBooking);

            updateUI();

            // Проверяем URL параметры
            const params = new URLSearchParams(window.location.search);
            const editId = params.get('edit');
            const roomId = params.get('room');

            if (editId) {
                openResidentModal(editId);
            } else if (roomId) {
                openRoomModal(roomId);
            }
        }

        init();
    </script>
</body>
</html>
