<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–∞—Ö–º–∞—Ç–∫–∞ ‚Äî –®–†–°–ö</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        /* –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ */
        .timeline-table {
            border-collapse: separate;
            border-spacing: 0;
            table-layout: fixed;
        }

        .timeline-table th,
        .timeline-table td {
            padding: 0;
            height: 32px;
            vertical-align: middle;
        }

        /* –ì—Ä–∞–Ω–∏—Ü—ã: —Ç–æ–ª—å–∫–æ –ø—Ä–∞–≤–∞—è –∏ –Ω–∏–∂–Ω—è—è —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω—ã—Ö –ª–∏–Ω–∏–π */
        .timeline-table th,
        .timeline-table td {
            border: none;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
        }

        /* –¢—ë–º–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ —Å–ª–µ–≤–∞ —É –ø–µ—Ä–≤–æ–π –ø–æ–ª–æ–≤–∏–Ω—ã –¥–Ω—è (–Ω–∞—á–∞–ª–æ –¥–Ω—è) */
        .day-start {
            border-left: 2px solid #9ca3af !important;
        }

        /* –®–∏—Ä–∏–Ω–∞ —è—á–µ–π–∫–∏ = –ø–æ–ª–æ–≤–∏–Ω–∞ –¥–Ω—è */
        .half-day {
            width: 24px;
            min-width: 24px;
            max-width: 24px;
        }

        /* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞ */
        .sticky-col {
            position: sticky;
            left: 0;
            background: white;
            z-index: 10;
            width: 160px;
            min-width: 160px;
            padding: 0 12px;
            text-align: left;
            white-space: nowrap;
            border-right: 2px solid #9ca3af;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã - –∑–∞–∫—Ä–µ–ø–ª—ë–Ω —Å–≤–µ—Ä—Ö—É */
        .timeline-table thead {
            position: sticky;
            top: 0;
            z-index: 15;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .timeline-table thead th {
            background: #f3f4f6;
            border-color: #d1d5db !important;
        }

        .timeline-table thead th.sticky-col {
            z-index: 20;
            background: #f3f4f6;
        }

        /* –í—ã—Ö–æ–¥–Ω—ã–µ –∏ —Å–µ–≥–æ–¥–Ω—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ */
        .timeline-table thead th.weekend {
            background: #fef2f2;
        }

        .timeline-table thead th.today {
            background: #dbeafe;
        }

        /* –°—Ç—Ä–æ–∫–∞ —Å —á–∏—Å–ª–∞–º–∏ */
        .row-dates th {
            font-weight: 600;
            font-size: 13px;
            text-align: center;
        }

        /* –°—Ç—Ä–æ–∫–∞ —Å –¥–Ω—è–º–∏ –Ω–µ–¥–µ–ª–∏ */
        .row-weekdays th {
            font-weight: 400;
            font-size: 10px;
            color: #6b7280;
            text-transform: uppercase;
            text-align: center;
        }

        /* –°—Ç—Ä–æ–∫–∞ —Ä–µ—Ç—Ä–∏—Ç–æ–≤ */
        .row-retreats th {
            background: #f9fafb !important;
            height: 34px;
            padding: 3px !important;
        }

        .row-retreats th.weekend {
            background: #fef2f2 !important;
        }

        .row-retreats th.today {
            background: #dbeafe !important;
        }

        .retreat-bar {
            position: absolute;
            top: 3px;
            left: 2px;
            background: #10b981;
            color: white;
            font-size: 14px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 26px;
            line-height: 18px;
            z-index: 5;
        }

        .row-retreats th {
            position: relative;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–¥–∞–Ω–∏—è */
        .row-building td {
            background: #d1d5db !important;
            font-weight: 600;
            font-size: 14px;
        }

        .row-building .sticky-col {
            background: #d1d5db !important;
            cursor: pointer;
            user-select: none;
        }

        .row-building .sticky-col:hover {
            background: #c0c5cc !important;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–º–µ—Ä–∞ */
        .row-room td {
            background: #e5e7eb !important;
            font-weight: 500;
            font-size: 13px;
        }

        .row-room .sticky-col {
            background: #e5e7eb !important;
            cursor: pointer;
            user-select: none;
            padding-left: 20px;
        }

        .row-room .sticky-col:hover {
            background: #d6d9dc !important;
        }

        /* –°—Ç—Ä–æ–∫–∞ –º–µ—Å—Ç–∞ */
        .row-bed .sticky-col {
            padding-left: 36px;
            font-size: 13px;
            color: #374151;
        }

        /* –ü–æ–ª–æ—Å–∫–∞ –≥–æ—Å—Ç—è ‚Äî –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ */
        .guest-bar {
            position: absolute;
            top: 3px;
            left: 1px;
            background: #fef08a;
            border: 1px solid #facc15;
            height: 24px;
            border-radius: 4px;
            font-size: 11px;
            padding: 0 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            z-index: 5;
            cursor: pointer;
        }

        /* –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —à—Ç—Ä–∏—Ö–æ–≤–∫–∞ */
        .guest-bar.booking {
            background: repeating-linear-gradient(
                45deg,
                var(--bar-color),
                var(--bar-color) 4px,
                rgba(255,255,255,0.5) 4px,
                rgba(255,255,255,0.5) 8px
            );
            border-style: dashed;
        }

        /* –£–±–æ—Ä–∫–∞ */
        .cleaning-bar {
            position: absolute;
            top: 3px;
            left: 1px;
            background: #9ca3af;
            height: 24px;
            border-radius: 4px;
            font-size: 10px;
            padding: 0 4px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4;
            color: white;
        }

        .row-bed td {
            position: relative;
        }

        /* –í—ã—Ö–æ–¥–Ω—ã–µ –¥–Ω–∏ */
        .weekend {
            background: #fef2f2 !important;
        }

        /* –°–µ–≥–æ–¥–Ω—è */
        .today {
            background: #dbeafe !important;
        }

        /* –°–∫—Ä—ã—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ (—Å–≤—ë—Ä–Ω—É—Ç—ã–µ) */
        .collapsed {
            display: none;
        }

        /* –ö–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ - –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º–∞, –Ω–æ –±–µ–∑ –≤—ã—Å–æ—Ç—ã */
        .row-calibration {
            height: 0 !important;
            visibility: collapse;
        }
        .row-calibration td {
            height: 0 !important;
            padding: 0 !important;
            border: none !important;
        }

        /* –°—Ç—Ä–µ–ª–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è */
        .toggle-arrow {
            display: inline-block;
            width: 16px;
            transition: transform 0.2s;
        }

        .toggle-arrow.collapsed {
            transform: rotate(-90deg);
        }

        /* –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã */
        .row-bed td.clickable {
            cursor: pointer;
        }
        .row-bed td.clickable:hover {
            background: #e0f2fe !important;
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen">

    <div id="header-placeholder"></div>

    <main class="px-4 py-6">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold">–®–∞—Ö–º–∞—Ç–∫–∞</h1>
            <!-- –õ–µ–≥–µ–Ω–¥–∞ -->
            <div class="flex items-center gap-4" id="legend"></div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–∞–±–ª–∏—Ü—ã -->
        <div class="overflow-auto bg-white rounded-lg shadow" style="max-height: calc(100vh - 180px);">
            <table class="timeline-table" id="timelineTable">
                <!-- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </table>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π -->
    <dialog id="actionModal" class="modal">
        <div class="modal-box max-w-lg">
            <!-- –≠–∫—Ä–∞–Ω 1: –í—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è -->
            <div id="actionScreen">
                <h3 class="font-bold text-lg mb-4">–î–µ–π—Å—Ç–≤–∏–µ</h3>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–µ -->
                <div class="text-sm text-gray-500 mb-4" id="modalLocation"></div>

                <!-- –î–∞—Ç—ã -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">–ó–∞–µ–∑–¥</span>
                        </label>
                        <input type="date" id="modalCheckIn" class="input input-bordered" />
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">–í—ã–µ–∑–¥</span>
                        </label>
                        <input type="date" id="modalCheckOut" class="input input-bordered" />
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                <div class="grid grid-cols-2 gap-3">
                    <button class="btn btn-primary" onclick="showCheckinForm()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                        </svg>
                        –ó–∞—Å–µ–ª–∏—Ç—å
                    </button>
                    <button class="btn btn-info" onclick="showBookingForm()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button class="btn btn-warning" onclick="handleAction('cleaning')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                        </svg>
                        –£–±–æ—Ä–∫–∞
                    </button>
                    <button class="btn btn-error" onclick="handleAction('repair')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                        </svg>
                        –ó–∞–∫—Ä—ã—Ç—å –Ω–∞ —Ä–µ–º–æ–Ω—Ç
                    </button>
                </div>

                <div class="modal-action">
                    <form method="dialog">
                        <button class="btn">–û—Ç–º–µ–Ω–∞</button>
                    </form>
                </div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω 2: –§–æ—Ä–º–∞ –∑–∞—Å–µ–ª–µ–Ω–∏—è -->
            <div id="checkinScreen" class="hidden">
                <div class="flex items-center gap-2 mb-4">
                    <button class="btn btn-ghost btn-sm btn-circle" onclick="showActionScreen()">‚Üê</button>
                    <h3 class="font-bold text-lg">–ó–∞—Å–µ–ª–µ–Ω–∏–µ</h3>
                </div>

                <div class="text-sm text-gray-500 mb-4" id="checkinLocation"></div>

                <form id="checkinForm" onsubmit="saveCheckin(event)">
                    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
                    <div class="form-control mb-3">
                        <label class="label">
                            <span class="label-text font-medium">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                        </label>
                        <select name="category_id" id="checkinCategory" class="select select-bordered w-full">
                            <option value="">‚Äî</option>
                        </select>
                    </div>

                    <!-- –í—ã–±–æ—Ä –∏–∑ –∫–æ–º–∞–Ω–¥—ã -->
                    <div class="form-control mb-3">
                        <label class="label">
                            <span class="label-text font-medium">–ß–ª–µ–Ω –∫–æ–º–∞–Ω–¥—ã</span>
                        </label>
                        <select name="team_member_id" id="checkinTeamMember" class="select select-bordered w-full" onchange="toggleGuestFields()">
                            <option value="">‚Äî –ì–æ—Å—Ç—å (–≤–≤–µ—Å—Ç–∏ –∏–º—è –Ω–∏–∂–µ) ‚Äî</option>
                        </select>
                    </div>

                    <!-- –î–∞–Ω–Ω—ã–µ –≥–æ—Å—Ç—è -->
                    <div id="guestFields">
                        <div class="divider text-sm opacity-60">–ò–ª–∏ –¥–∞–Ω–Ω—ã–µ –≥–æ—Å—Ç—è</div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text">–ò–º—è</span>
                                </label>
                                <input type="text" name="guest_name" id="checkinGuestName" class="input input-bordered input-sm w-full" />
                            </div>
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text">–¢–µ–ª–µ—Ñ–æ–Ω</span>
                                </label>
                                <input type="tel" name="guest_phone" class="input input-bordered input-sm w-full" />
                            </div>
                        </div>
                    </div>

                    <!-- –î–∞—Ç—ã -->
                    <div class="divider text-sm opacity-60"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">–ó–∞–µ–∑–¥</span>
                            </label>
                            <input type="date" name="check_in" id="checkinDateIn" class="input input-bordered input-sm w-full" required />
                            <label class="label cursor-pointer justify-start gap-2 py-1">
                                <input type="checkbox" name="early_checkin" class="checkbox checkbox-sm checkbox-primary" />
                                <span class="label-text text-sm">–†–∞–Ω–Ω–∏–π –∑–∞–µ–∑–¥</span>
                            </label>
                        </div>
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">–í—ã–µ–∑–¥</span>
                            </label>
                            <input type="date" name="check_out" id="checkinDateOut" class="input input-bordered input-sm w-full" />
                            <label class="label cursor-pointer justify-start gap-2 py-1">
                                <input type="checkbox" name="late_checkout" class="checkbox checkbox-sm checkbox-primary" />
                                <span class="label-text text-sm">–ü–æ–∑–¥–Ω–∏–π –≤—ã–µ–∑–¥</span>
                            </label>
                        </div>
                    </div>

                    <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏—è -->
                    <div class="form-control mt-3">
                        <label class="label py-1">
                            <span class="label-text">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</span>
                        </label>
                        <textarea name="notes" rows="2" class="textarea textarea-bordered textarea-sm w-full"></textarea>
                    </div>

                    <div class="modal-action">
                        <button type="button" class="btn btn-ghost" onclick="showActionScreen()">–ù–∞–∑–∞–¥</button>
                        <button type="submit" class="btn btn-primary">–ó–∞—Å–µ–ª–∏—Ç—å</button>
                    </div>
                </form>
            </div>

            <!-- –≠–∫—Ä–∞–Ω 3: –§–æ—Ä–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
            <div id="bookingScreen" class="hidden">
                <div class="flex items-center gap-2 mb-4">
                    <button class="btn btn-ghost btn-sm btn-circle" onclick="showActionScreen()">‚Üê</button>
                    <h3 class="font-bold text-lg">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                </div>

                <div class="text-sm text-gray-500 mb-4" id="bookingLocation"></div>

                <form id="bookingForm" onsubmit="saveBooking(event)">
                    <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –±—Ä–æ–Ω–∏ -->
                    <div class="form-control mb-3">
                        <label class="label py-1">
                            <span class="label-text font-medium">–ù–∞–∑–≤–∞–Ω–∏–µ –±—Ä–æ–Ω–∏</span>
                        </label>
                        <input type="text" name="name" class="input input-bordered input-sm w-full" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ì—Ä—É–ø–ø–∞ –∏–∑ –ú–æ—Å–∫–≤—ã" />
                    </div>

                    <!-- –ö–æ–Ω—Ç–∞–∫—Ç -->
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</span>
                            </label>
                            <input type="text" name="contact_name" class="input input-bordered input-sm w-full" required />
                        </div>
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">–¢–µ–ª–µ—Ñ–æ–Ω</span>
                            </label>
                            <input type="tel" name="contact_phone" class="input input-bordered input-sm w-full" />
                        </div>
                    </div>

                    <!-- –î–∞—Ç—ã -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">–ó–∞–µ–∑–¥</span>
                            </label>
                            <input type="date" name="check_in" id="bookingDateIn" class="input input-bordered input-sm w-full" required />
                            <label class="label cursor-pointer justify-start gap-2 py-1">
                                <input type="checkbox" name="early_checkin" class="checkbox checkbox-sm checkbox-info" />
                                <span class="label-text text-sm">–†–∞–Ω–Ω–∏–π –∑–∞–µ–∑–¥</span>
                            </label>
                        </div>
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">–í—ã–µ–∑–¥</span>
                            </label>
                            <input type="date" name="check_out" id="bookingDateOut" class="input input-bordered input-sm w-full" required />
                            <label class="label cursor-pointer justify-start gap-2 py-1">
                                <input type="checkbox" name="late_checkout" class="checkbox checkbox-sm checkbox-info" />
                                <span class="label-text text-sm">–ü–æ–∑–¥–Ω–∏–π –≤—ã–µ–∑–¥</span>
                            </label>
                        </div>
                    </div>

                    <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç -->
                    <div class="form-control mt-3">
                        <label class="label py-1">
                            <span class="label-text font-medium">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç</span>
                        </label>
                        <input type="number" name="beds_count" min="1" value="1" class="input input-bordered input-sm w-full" required />
                    </div>

                    <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏—è -->
                    <div class="form-control mt-3">
                        <label class="label py-1">
                            <span class="label-text">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</span>
                        </label>
                        <textarea name="notes" rows="2" class="textarea textarea-bordered textarea-sm w-full"></textarea>
                    </div>

                    <div class="modal-action">
                        <button type="button" class="btn btn-ghost" onclick="showActionScreen()">–ù–∞–∑–∞–¥</button>
                        <button type="submit" class="btn btn-info">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <script src="../js/layout.js"></script>
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const DAYS_TO_SHOW = 90; // 3 –º–µ—Å—è—Ü–∞
        const CELL_WIDTH = 24;   // —à–∏—Ä–∏–Ω–∞ –ø–æ–ª–æ–≤–∏–Ω—ã –¥–Ω—è

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
        const collapsedBuildings = new Set();
        const collapsedRooms = new Set();

        // –î–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
        let timelineData = {
            retreats: [],
            buildings: []
        };

        // –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –¥–ª—è —Ñ–æ—Ä–º
        let categories = [];
        let teamMembers = [];

        // –ë–∞–∑–æ–≤–∞—è –¥–∞—Ç–∞ (—Å–µ–≥–æ–¥–Ω—è –º–∏–Ω—É—Å 2 –¥–Ω—è)
        const baseDate = new Date();
        baseDate.setHours(0, 0, 0, 0);
        baseDate.setDate(baseDate.getDate() - 2);

        // –ò–Ω–¥–µ–∫—Å —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ baseDate
        const TODAY_INDEX = 2;

        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –¥–∞—Ç—É –≤ dayIndex –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ baseDate
        function dateToDayIndex(dateStr) {
            const date = new Date(dateStr);
            date.setHours(0, 0, 0, 0);
            const diff = date - baseDate;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î
        async function loadTimelineData() {
            const endDate = new Date(baseDate);
            endDate.setDate(endDate.getDate() + DAYS_TO_SHOW);
            const startDateStr = baseDate.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
            const [buildingsRes, roomsRes, residentsRes, retreatsRes] = await Promise.all([
                Layout.db.from('buildings')
                    .select('*, building_types(id, slug, color, name_ru, name_en, name_hi)')
                    .eq('is_active', true)
                    .order('sort_order'),
                Layout.db.from('rooms')
                    .select('*')
                    .eq('is_active', true)
                    .order('building_id')
                    .order('floor')
                    .order('number'),
                Layout.db.from('residents')
                    .select(`*,
                        resident_categories(id, name_ru, name_en, name_hi, color),
                        team_members(id, first_name, last_name, spiritual_name),
                        bookings(id, name, contact_name)`)
                    .eq('status', 'active')
                    .lte('check_in', endDateStr)
                    .or(`check_out.is.null,check_out.gte.${startDateStr}`),
                Layout.db.from('retreats')
                    .select('*')
                    .lte('start_date', endDateStr)
                    .gte('end_date', startDateStr)
                    .order('start_date')
            ]);

            const buildings = buildingsRes.data || [];
            const rooms = roomsRes.data || [];
            const residents = residentsRes.data || [];
            const retreats = retreatsRes.data || [];

            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ä–µ—Ç—Ä–∏—Ç—ã
            timelineData.retreats = retreats.map(r => {
                const rawStartDay = dateToDayIndex(r.start_date);
                const rawEndDay = dateToDayIndex(r.end_date);
                return {
                    name: Layout.getName(r),
                    startDay: Math.max(0, rawStartDay),
                    endDay: Math.min(DAYS_TO_SHOW - 1, rawEndDay),
                    rawStartDay,
                    rawEndDay
                };
            }).filter(r => r.rawStartDay <= DAYS_TO_SHOW - 1 && r.rawEndDay >= 0);

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–æ–º–Ω–∞—Ç—ã –ø–æ –∑–¥–∞–Ω–∏—è–º
            const roomsByBuilding = {};
            rooms.forEach(room => {
                if (!roomsByBuilding[room.building_id]) {
                    roomsByBuilding[room.building_id] = [];
                }
                roomsByBuilding[room.building_id].push(room);
            });

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ä–µ–∑–∏–¥–µ–Ω—Ç–æ–≤ –ø–æ –∫–æ–º–Ω–∞—Ç–∞–º
            const residentsByRoom = {};
            residents.forEach(res => {
                if (!residentsByRoom[res.room_id]) {
                    residentsByRoom[res.room_id] = [];
                }
                residentsByRoom[res.room_id].push(res);
            });

            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
            timelineData.buildings = buildings.map(building => {
                const buildingRooms = roomsByBuilding[building.id] || [];

                return {
                    id: building.id,
                    name: Layout.getName(building),
                    rooms: buildingRooms.map(room => {
                        const capacity = room.capacity || 1;
                        const roomResidents = residentsByRoom[room.id] || [];

                        // –°–æ–∑–¥–∞—ë–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–µ—Å—Ç–∞
                        const beds = [];
                        for (let i = 0; i < capacity; i++) {
                            beds.push({
                                name: capacity === 1 ? '' : `${i + 1}`,
                                roomId: room.id,
                                bedIndex: i,
                                guests: []
                            });
                        }

                        // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∑–∏–¥–µ–Ω—Ç–æ–≤ –ø–æ –º–µ—Å—Ç–∞–º
                        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –∑–∞—Å–µ–ª–µ–Ω–∏—è
                        roomResidents.sort((a, b) => new Date(a.check_in) - new Date(b.check_in));

                        roomResidents.forEach(res => {
                            const startDay = Math.max(0, dateToDayIndex(res.check_in));
                            const endDay = res.check_out
                                ? Math.min(DAYS_TO_SHOW - 1, dateToDayIndex(res.check_out))
                                : DAYS_TO_SHOW - 1;

                            if (startDay > DAYS_TO_SHOW - 1 || endDay < 0) return;

                            // –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ä–µ–∑–∏–¥–µ–Ω—Ç–∞
                            let guestName = res.guest_name || '';
                            if (res.team_members) {
                                const tm = res.team_members;
                                guestName = tm.spiritual_name || `${tm.first_name} ${tm.last_name}`.trim();
                            }
                            // –ï—Å–ª–∏ —ç—Ç–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –±—Ä–æ–Ω–∏ –∏–ª–∏ –∏–º—è –∫–æ–Ω—Ç–∞–∫—Ç–∞
                            if (!guestName && res.bookings) {
                                guestName = res.bookings.name || res.bookings.contact_name || '';
                            }

                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —ç—Ç–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –∑–∞—Å–µ–ª–µ–Ω–∏–µ
                            // –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ = –µ—Å—Ç—å booking_id, –Ω–æ –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≥–æ—Å—Ç—è (team_member –∏–ª–∏ guest_name)
                            const isBooking = res.booking_id && !res.team_member_id && !res.guest_name;

                            // –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                            const category = res.resident_categories;
                            const color = category?.color || '#fef08a';
                            // –î–µ–ª–∞–µ–º border —Ç–µ–º–Ω–µ–µ
                            const border = color;

                            // –†–∞–Ω–Ω–∏–π –∑–∞–µ–∑–¥ = –æ–±–µ –ø–æ–ª–æ–≤–∏–Ω—ã –¥–Ω—è –∑–∞–µ–∑–¥–∞ (startHalf = 0)
                            // –û–±—ã—á–Ω—ã–π –∑–∞–µ–∑–¥ = —Ç–æ–ª—å–∫–æ –≤—Ç–æ—Ä–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ (startHalf = 1)
                            // –ü–æ–∑–¥–Ω–∏–π –≤—ã–µ–∑–¥ = –æ–±–µ –ø–æ–ª–æ–≤–∏–Ω—ã –¥–Ω—è –≤—ã–µ–∑–¥–∞ (endHalf = 1)
                            // –û–±—ã—á–Ω—ã–π –≤—ã–µ–∑–¥ = —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ (endHalf = 0)
                            let startHalf = res.early_checkin === true ? 0 : 1;
                            let endHalf = res.late_checkout === true ? 1 : 0;

                            // –ï—Å–ª–∏ –∑–∞–µ–∑–¥ –∏ –≤—ã–µ–∑–¥ –≤ –æ–¥–∏–Ω –¥–µ–Ω—å, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —á—Ç–æ–±—ã span –±—ã–ª –º–∏–Ω–∏–º—É–º 1
                            if (startDay === endDay && startHalf > endHalf) {
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–ª–æ–≤–∏–Ω—É
                                endHalf = startHalf;
                            }

                            const guest = {
                                id: res.id,
                                name: guestName || '‚Äî',
                                startDay,
                                startHalf,
                                endDay,
                                endHalf,
                                color,
                                border,
                                isBooking
                            };

                            // –£–±–æ—Ä–∫–∞ –ø–æ—Å–ª–µ –≤—ã–µ–∑–¥–∞
                            // –û–±—ã—á–Ω—ã–π –≤—ã–µ–∑–¥ (endHalf=0): —É–±–æ—Ä–∫–∞ —Å–æ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω—ã –¥–Ω—è –≤—ã–µ–∑–¥–∞
                            // –ü–æ–∑–¥–Ω–∏–π –≤—ã–µ–∑–¥ (endHalf=1): —É–±–æ—Ä–∫–∞ —Å –ø–µ—Ä–≤–æ–π –ø–æ–ª–æ–≤–∏–Ω—ã –°–õ–ï–î–£–Æ–©–ï–ì–û –¥–Ω—è
                            let cleaningEntry = null;
                            if (res.check_out) {
                                let cleaningStartDay, cleaningStartHalf, cleaningEndDay, cleaningEndHalf;

                                if (endHalf === 0) {
                                    // –û–±—ã—á–Ω—ã–π –≤—ã–µ–∑–¥ ‚Äî —É–±–æ—Ä–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤–æ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –¥–Ω—è –≤—ã–µ–∑–¥–∞
                                    cleaningStartDay = endDay;
                                    cleaningStartHalf = 1;
                                    cleaningEndDay = endDay + 1;
                                    cleaningEndHalf = 0;
                                } else {
                                    // –ü–æ–∑–¥–Ω–∏–π –≤—ã–µ–∑–¥ ‚Äî —É–±–æ—Ä–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
                                    cleaningStartDay = endDay + 1;
                                    cleaningStartHalf = 0;
                                    cleaningEndDay = endDay + 1;
                                    cleaningEndHalf = 1;
                                }

                                // –ï—Å–ª–∏ —É–±–æ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –¥–∏–∞–ø–∞–∑–æ–Ω –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                                if (cleaningStartDay < DAYS_TO_SHOW) {
                                    cleaningEntry = {
                                        id: 'cleaning-' + res.id,
                                        name: 'üßπ',
                                        startDay: cleaningStartDay,
                                        startHalf: cleaningStartHalf,
                                        endDay: Math.min(cleaningEndDay, DAYS_TO_SHOW - 1),
                                        endHalf: cleaningEndDay >= DAYS_TO_SHOW ? 1 : cleaningEndHalf,
                                        isCleaning: true
                                    };
                                }
                            }

                            // –ò—â–µ–º —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è —ç—Ç–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
                            let placed = false;
                            let placedBed = null;
                            for (const bed of beds) {
                                const hasOverlap = bed.guests.some(g => {
                                    if (g.isCleaning) return false; // –£–±–æ—Ä–∫–∞ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç
                                    const gStart = g.startDay * 2 + g.startHalf;
                                    const gEnd = g.endDay * 2 + g.endHalf;
                                    const rStart = guest.startDay * 2 + guest.startHalf;
                                    const rEnd = guest.endDay * 2 + guest.endHalf;
                                    return !(rEnd < gStart || rStart > gEnd);
                                });

                                if (!hasOverlap) {
                                    bed.guests.push(guest);
                                    placedBed = bed;
                                    placed = true;
                                    break;
                                }
                            }

                            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –º–µ—Å—Ç–æ, –¥–æ–±–∞–≤–ª—è–µ–º –≤ –ø–µ—Ä–≤–æ–µ (–±—É–¥–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –Ω–∞–ª–æ–∂–µ–Ω–∏–µ)
                            if (!placed && beds.length > 0) {
                                beds[0].guests.push(guest);
                                placedBed = beds[0];
                            }

                            // –î–æ–±–∞–≤–ª—è–µ–º —É–±–æ—Ä–∫—É –Ω–∞ —Ç–æ –∂–µ –º–µ—Å—Ç–æ
                            if (cleaningEntry && placedBed) {
                                placedBed.guests.push(cleaningEntry);
                            }
                        });

                        return {
                            id: room.id,
                            name: room.number,
                            beds
                        };
                    })
                };
            }).filter(b => b.rooms.length > 0);
        }

        // –ü–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É –¥–ª—è –¥–Ω—è
        function getDateForDay(dayIndex) {
            const date = new Date(baseDate);
            date.setDate(baseDate.getDate() + dayIndex);
            return date;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ
        function isWeekend(dayIndex) {
            const date = getDateForDay(dayIndex);
            const day = date.getDay();
            return day === 0 || day === 6;
        }

        // –ü–æ–ª—É—á–∏—Ç—å –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
        function getWeekdayName(dayIndex) {
            const days = ['–≤—Å', '–ø–Ω', '–≤—Ç', '—Å—Ä', '—á—Ç', '–ø—Ç', '—Å–±'];
            const date = getDateForDay(dayIndex);
            return days[date.getDay()];
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –∑–¥–∞–Ω–∏—è
        function toggleBuilding(buildingId) {
            if (collapsedBuildings.has(buildingId)) {
                collapsedBuildings.delete(buildingId);
            } else {
                collapsedBuildings.add(buildingId);
            }
            renderTable();
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞
        function toggleRoom(roomId) {
            if (collapsedRooms.has(roomId)) {
                collapsedRooms.delete(roomId);
            } else {
                collapsedRooms.add(roomId);
            }
            renderTable();
        }

        // –¢–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–æ–¥–∞–ª–∫–∏
        let modalContext = null;

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—É –¥–ª—è input[type="date"]
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –¥–µ–π—Å—Ç–≤–∏–π
        function openActionModal(dayIndex, roomId, buildingName, roomName, bedName) {
            const checkInDate = getDateForDay(dayIndex);
            const checkOutDate = getDateForDay(dayIndex + 1);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            modalContext = { dayIndex, roomId, buildingName, roomName, bedName };

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
            const location = bedName
                ? `${buildingName} ‚Üí ${roomName} ‚Üí –ú–µ—Å—Ç–æ ${bedName}`
                : `${buildingName} ‚Üí ${roomName}`;
            document.getElementById('modalLocation').textContent = location;
            document.getElementById('modalCheckIn').value = formatDateForInput(checkInDate);
            document.getElementById('modalCheckOut').value = formatDateForInput(checkOutDate);

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
            document.getElementById('actionModal').showModal();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤
        async function loadDictionaries() {
            const [catRes, teamRes] = await Promise.all([
                Layout.db.from('resident_categories').select('*').order('sort_order'),
                Layout.db.from('team_members').select('*').order('spiritual_name')
            ]);
            categories = catRes.data || [];
            teamMembers = teamRes.data || [];

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç—ã
            const catSelect = document.getElementById('checkinCategory');
            catSelect.innerHTML = '<option value="">‚Äî</option>' +
                categories.map(c => `<option value="${c.id}">${Layout.getName(c)}</option>`).join('');

            const teamSelect = document.getElementById('checkinTeamMember');
            teamSelect.innerHTML = '<option value="">‚Äî –ì–æ—Å—Ç—å (–≤–≤–µ—Å—Ç–∏ –∏–º—è –Ω–∏–∂–µ) ‚Äî</option>' +
                teamMembers.map(t => {
                    const name = t.spiritual_name || `${t.first_name} ${t.last_name}`.trim();
                    return `<option value="${t.id}">${name}</option>`;
                }).join('');

            // –†–µ–Ω–¥–µ—Ä–∏–º –ª–µ–≥–µ–Ω–¥—É
            renderLegend();
        }

        // –õ–µ–≥–µ–Ω–¥–∞ —Ü–≤–µ—Ç–æ–≤
        function renderLegend() {
            const legend = document.getElementById('legend');

            // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞—Å–µ–ª–µ–Ω–∏–π
            const categoriesHtml = categories.map(c => {
                const color = c.color || '#fef08a';
                return `<div class="flex items-center gap-1.5">
                    <span class="w-4 h-4 rounded" style="background: ${color}; border: 1px solid rgba(0,0,0,0.15);"></span>
                    <span class="text-sm text-gray-600">${Layout.getName(c)}</span>
                </div>`;
            }).join('');

            // –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (—à—Ç—Ä–∏—Ö–æ–≤–∫–∞)
            const bookingHtml = `<div class="flex items-center gap-1.5">
                <span class="w-4 h-4 rounded" style="background: repeating-linear-gradient(45deg, #fef08a, #fef08a 2px, rgba(255,255,255,0.5) 2px, rgba(255,255,255,0.5) 4px); border: 1px dashed rgba(0,0,0,0.3);"></span>
                <span class="text-sm text-gray-600">–ë—Ä–æ–Ω—å</span>
            </div>`;

            // –£–±–æ—Ä–∫–∞
            const cleaningHtml = `<div class="flex items-center gap-1.5">
                <span class="w-4 h-4 rounded" style="background: #9ca3af;"></span>
                <span class="text-sm text-gray-600">–£–±–æ—Ä–∫–∞</span>
            </div>`;

            legend.innerHTML = categoriesHtml + bookingHtml + cleaningHtml;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
        function showActionScreen() {
            document.getElementById('actionScreen').classList.remove('hidden');
            document.getElementById('checkinScreen').classList.add('hidden');
            document.getElementById('bookingScreen').classList.add('hidden');
        }

        function showCheckinForm() {
            document.getElementById('actionScreen').classList.add('hidden');
            document.getElementById('checkinScreen').classList.remove('hidden');
            document.getElementById('bookingScreen').classList.add('hidden');

            // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            document.getElementById('checkinLocation').textContent =
                document.getElementById('modalLocation').textContent;
            document.getElementById('checkinDateIn').value =
                document.getElementById('modalCheckIn').value;
            document.getElementById('checkinDateOut').value =
                document.getElementById('modalCheckOut').value;

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('checkinForm').reset();
            document.getElementById('checkinDateIn').value =
                document.getElementById('modalCheckIn').value;
            document.getElementById('checkinDateOut').value =
                document.getElementById('modalCheckOut').value;
            toggleGuestFields();
        }

        function showBookingForm() {
            document.getElementById('actionScreen').classList.add('hidden');
            document.getElementById('checkinScreen').classList.add('hidden');
            document.getElementById('bookingScreen').classList.remove('hidden');

            // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            document.getElementById('bookingLocation').textContent =
                document.getElementById('modalLocation').textContent;
            document.getElementById('bookingDateIn').value =
                document.getElementById('modalCheckIn').value;
            document.getElementById('bookingDateOut').value =
                document.getElementById('modalCheckOut').value;

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('bookingForm').reset();
            document.getElementById('bookingDateIn').value =
                document.getElementById('modalCheckIn').value;
            document.getElementById('bookingDateOut').value =
                document.getElementById('modalCheckOut').value;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª–µ–π –≥–æ—Å—Ç—è
        function toggleGuestFields() {
            const teamMemberId = document.getElementById('checkinTeamMember').value;
            const guestFields = document.getElementById('guestFields');
            if (teamMemberId) {
                guestFields.classList.add('hidden');
                document.getElementById('checkinGuestName').value = '';
            } else {
                guestFields.classList.remove('hidden');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞—Å–µ–ª–µ–Ω–∏—è
        async function saveCheckin(e) {
            e.preventDefault();
            const form = e.target;

            const data = {
                room_id: modalContext.roomId,
                category_id: form.category_id.value || null,
                team_member_id: form.team_member_id.value || null,
                guest_name: form.guest_name.value || null,
                guest_phone: form.guest_phone?.value || null,
                check_in: form.check_in.value,
                check_out: form.check_out.value || null,
                early_checkin: form.early_checkin.checked,
                late_checkout: form.late_checkout.checked,
                notes: form.notes.value || null,
                status: 'active'
            };

            // –ü—Ä–æ–≤–µ—Ä–∫–∞: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ª–∏–±–æ —á–ª–µ–Ω –∫–æ–º–∞–Ω–¥—ã, –ª–∏–±–æ –∏–º—è –≥–æ—Å—Ç—è
            if (!data.team_member_id && !data.guest_name) {
                alert('–£–∫–∞–∂–∏—Ç–µ —á–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥—ã –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –≥–æ—Å—Ç—è');
                return;
            }

            const { error } = await Layout.db.from('residents').insert(data);

            if (error) {
                console.error('Error saving checkin:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞—Å–µ–ª–µ–Ω–∏–∏: ' + error.message);
                return;
            }

            document.getElementById('actionModal').close();
            showActionScreen();
            await loadTimelineData();
            renderTable();
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        async function saveBooking(e) {
            e.preventDefault();
            const form = e.target;

            const bedsCount = parseInt(form.beds_count.value) || 1;

            // –°–æ–∑–¥–∞—ë–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            const earlyCheckin = form.early_checkin.checked;
            const lateCheckout = form.late_checkout.checked;
            const bookingName = form.name.value.trim() || null;

            const bookingData = {
                name: bookingName,
                contact_name: form.contact_name.value,
                contact_phone: form.contact_phone.value || null,
                check_in: form.check_in.value,
                check_out: form.check_out.value,
                beds_count: bedsCount,
                early_checkin: earlyCheckin,
                late_checkout: lateCheckout,
                notes: form.notes.value || null,
                status: 'confirmed'
            };

            const { data: booking, error: bookingError } = await Layout.db
                .from('bookings')
                .insert(bookingData)
                .select()
                .single();

            if (bookingError) {
                console.error('Error saving booking:', bookingError);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏: ' + bookingError.message);
                return;
            }

            // –°–æ–∑–¥–∞—ë–º placeholder —Ä–µ–∑–∏–¥–µ–Ω—Ç–æ–≤ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            const residents = [];
            for (let i = 0; i < bedsCount; i++) {
                residents.push({
                    room_id: modalContext.roomId,
                    booking_id: booking.id,
                    check_in: form.check_in.value,
                    check_out: form.check_out.value,
                    early_checkin: earlyCheckin,
                    late_checkout: lateCheckout,
                    status: 'active'
                });
            }

            const { error: residentsError } = await Layout.db.from('residents').insert(residents);

            if (residentsError) {
                console.error('Error saving booking residents:', residentsError);
            }

            document.getElementById('actionModal').close();
            showActionScreen();
            await loadTimelineData();
            renderTable();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥—Ä—É–≥–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
        function handleAction(action) {
            const checkIn = document.getElementById('modalCheckIn').value;
            const checkOut = document.getElementById('modalCheckOut').value;

            console.log('Action:', action);
            console.log('Context:', modalContext);
            console.log('Check-in:', checkIn);
            console.log('Check-out:', checkOut);

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
            document.getElementById('actionModal').close();

            // TODO: –£–±–æ—Ä–∫–∞ –∏ —Ä–µ–º–æ–Ω—Ç
        }

        // –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ã
        function renderTable() {
            const table = document.getElementById('timelineTable');

            let html = '<thead>';

            // –°—Ç—Ä–æ–∫–∞ —Ä–µ—Ç—Ä–∏—Ç–æ–≤ ‚Äî —Ç–∞ –∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —á—Ç–æ –∏ —Å—Ç—Ä–æ–∫–∞ –¥–∞—Ç (colspan=2 –Ω–∞ –¥–µ–Ω—å)
            html += '<tr class="row-retreats"><th class="sticky-col"></th>';
            const renderedRetreats = new Set();
            for (let day = 0; day < DAYS_TO_SHOW; day++) {
                const weekend = isWeekend(day) ? 'weekend' : '';
                const today = day === TODAY_INDEX ? 'today' : '';

                // –ò—â–µ–º —Ä–µ—Ç—Ä–∏—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å
                const retreat = timelineData.retreats.find(r =>
                    !renderedRetreats.has(r.name) && r.startDay === day
                );

                if (retreat) {
                    renderedRetreats.add(retreat.name);
                    const spanDays = retreat.endDay - retreat.startDay + 1;
                    const width = spanDays * CELL_WIDTH * 2 - 4; // 2 —è—á–µ–π–∫–∏ –Ω–∞ –¥–µ–Ω—å, –º–∏–Ω—É—Å –æ—Ç—Å—Ç—É–ø—ã
                    html += `<th colspan="2" class="day-start ${weekend} ${today}"><span class="retreat-bar" style="width: ${width}px;">${retreat.name}</span></th>`;
                } else {
                    html += `<th colspan="2" class="day-start ${weekend} ${today}"></th>`;
                }
            }
            html += '</tr>';

            // –°—Ç—Ä–æ–∫–∞ —Å —á–∏—Å–ª–∞–º–∏
            html += '<tr class="row-dates"><th class="sticky-col"></th>';
            for (let day = 0; day < DAYS_TO_SHOW; day++) {
                const date = getDateForDay(day);
                const weekend = isWeekend(day) ? 'weekend' : '';
                const today = day === TODAY_INDEX ? 'today' : '';
                html += `<th colspan="2" class="day-start ${weekend} ${today}">${date.getDate()}</th>`;
            }
            html += '</tr>';

            // –°—Ç—Ä–æ–∫–∞ —Å –¥–Ω—è–º–∏ –Ω–µ–¥–µ–ª–∏
            html += '<tr class="row-weekdays"><th class="sticky-col"></th>';
            for (let day = 0; day < DAYS_TO_SHOW; day++) {
                const weekend = isWeekend(day) ? 'weekend' : '';
                const today = day === TODAY_INDEX ? 'today' : '';
                html += `<th colspan="2" class="day-start ${weekend} ${today}">${getWeekdayName(day)}</th>`;
            }
            html += '</tr>';

            html += '</thead><tbody>';

            // –ö–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ —à–∏—Ä–∏–Ω—ã –∫–æ–ª–æ–Ω–æ–∫
            html += '<tr class="row-calibration"><td class="sticky-col"></td>';
            for (let col = 0; col < DAYS_TO_SHOW * 2; col++) {
                html += '<td class="half-day"></td>';
            }
            html += '</tr>';

            // –ó–¥–∞–Ω–∏—è
            timelineData.buildings.forEach(building => {
                const buildingCollapsed = collapsedBuildings.has(building.id);
                const arrowClass = buildingCollapsed ? 'collapsed' : '';

                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–¥–∞–Ω–∏—è
                html += `<tr class="row-building">`;
                html += `<td class="sticky-col" onclick="toggleBuilding('${building.id}')">`;
                html += `<span class="toggle-arrow ${arrowClass}">‚ñº</span> ${building.name}</td>`;
                for (let col = 0; col < DAYS_TO_SHOW * 2; col++) {
                    const dayIndex = Math.floor(col / 2);
                    const isFirstHalf = col % 2 === 0;
                    const dayStart = isFirstHalf ? 'day-start' : '';
                    html += `<td class="${dayStart}"></td>`;
                }
                html += '</tr>';

                // –ù–æ–º–µ—Ä–∞ (—Å–∫—Ä—ã—Ç—ã –µ—Å–ª–∏ –∑–¥–∞–Ω–∏–µ —Å–≤—ë—Ä–Ω—É—Ç–æ)
                building.rooms.forEach(room => {
                    const roomCollapsed = collapsedRooms.has(room.id);
                    const roomArrowClass = roomCollapsed ? 'collapsed' : '';
                    const hiddenClass = buildingCollapsed ? 'collapsed' : '';

                    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–º–µ—Ä–∞
                    html += `<tr class="row-room ${hiddenClass}">`;
                    html += `<td class="sticky-col" onclick="toggleRoom('${room.id}')">`;
                    html += `<span class="toggle-arrow ${roomArrowClass}">‚ñº</span> –ù–æ–º–µ—Ä ${room.name}</td>`;
                    for (let col = 0; col < DAYS_TO_SHOW * 2; col++) {
                        const dayIndex = Math.floor(col / 2);
                        const isFirstHalf = col % 2 === 0;
                        const dayStart = isFirstHalf ? 'day-start' : '';
                        html += `<td class="${dayStart}"></td>`;
                    }
                    html += '</tr>';

                    // –ú–µ—Å—Ç–∞ (—Å–∫—Ä—ã—Ç—ã –µ—Å–ª–∏ –∑–¥–∞–Ω–∏–µ –∏–ª–∏ –Ω–æ–º–µ—Ä —Å–≤—ë—Ä–Ω—É—Ç—ã)
                    const bedsHiddenClass = (buildingCollapsed || roomCollapsed) ? 'collapsed' : '';

                    room.beds.forEach(bed => {
                        const bedLabel = bed.name ? `–ú–µ—Å—Ç–æ ${bed.name}` : '';
                        html += `<tr class="row-bed ${bedsHiddenClass}"><td class="sticky-col">${bedLabel}</td>`;

                        // –í—Å–µ–≥–¥–∞ —Ä–µ–Ω–¥–µ—Ä–∏–º –≤—Å–µ —è—á–µ–π–∫–∏ (DAYS_TO_SHOW * 2)
                        for (let col = 0; col < DAYS_TO_SHOW * 2; col++) {
                            const dayIndex = Math.floor(col / 2);
                            const halfIndex = col % 2;
                            const isFirstHalf = halfIndex === 0;
                            const dayStart = isFirstHalf ? 'day-start' : '';
                            const weekend = isWeekend(dayIndex) ? 'weekend' : '';
                            const today = dayIndex === TODAY_INDEX ? 'today' : '';

                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –≥–æ—Å—Ç—å –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è –∑–¥–µ—Å—å
                            const guest = bed.guests.find(g =>
                                g.startDay === dayIndex && g.startHalf === halfIndex
                            );

                            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏ –≤ –∏–º–µ–Ω–∞—Ö
                            const bName = building.name.replace(/'/g, "\\'");
                            const rName = room.name.replace(/'/g, "\\'");
                            const bedName = bed.name.replace(/'/g, "\\'");

                            html += `<td class="half-day clickable ${dayStart} ${weekend} ${today}" onclick="openActionModal(${dayIndex}, '${room.id}', '${bName}', '${rName}', '${bedName}')">`;

                            // –ï—Å–ª–∏ –∑–¥–µ—Å—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≥–æ—Å—Ç—å ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞—à–∫—É
                            if (guest) {
                                const startCol = guest.startDay * 2 + guest.startHalf;
                                const endCol = guest.endDay * 2 + guest.endHalf;
                                const spanCells = Math.max(1, endCol - startCol + 1);
                                const width = spanCells * CELL_WIDTH - 2; // –º–∏–Ω—É—Å –æ—Ç—Å—Ç—É–ø—ã

                                if (guest.isCleaning) {
                                    // –£–±–æ—Ä–∫–∞
                                    html += `<div class="cleaning-bar" style="width: ${width}px;">${guest.name}</div>`;
                                } else if (guest.isBooking) {
                                    // –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —à—Ç—Ä–∏—Ö–æ–≤–∫–∞
                                    const bgColor = guest.color || '#fef08a';
                                    html += `<div class="guest-bar booking" style="width: ${width}px; --bar-color: ${bgColor}; border-color: ${bgColor};">${guest.name}</div>`;
                                } else {
                                    // –û–±—ã—á–Ω–æ–µ –∑–∞—Å–µ–ª–µ–Ω–∏–µ
                                    const bgColor = guest.color || '#fef08a';
                                    const borderColor = guest.border || '#facc15';
                                    html += `<div class="guest-bar" style="width: ${width}px; background: ${bgColor}; border-color: ${borderColor};">${guest.name}</div>`;
                                }
                            }

                            html += '</td>';
                        }

                        html += '</tr>';
                    });
                });
            });

            html += '</tbody>';
            table.innerHTML = html;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            await Layout.init({ module: 'housing', menuId: 'housing', itemId: 'timeline' });
            await Promise.all([
                loadTimelineData(),
                loadDictionaries()
            ]);
            renderTable();
        }

        init();
    </script>
</body>
</html>
