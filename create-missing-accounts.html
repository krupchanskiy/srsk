<!DOCTYPE html>
<html lang="ru" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Создание недостающих аккаунтов — ШРСК</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-base-200 min-h-screen flex items-center justify-center p-4">
    <div class="card bg-base-100 shadow-xl max-w-2xl w-full">
        <div class="card-body">
            <h2 class="card-title">Создание 8 недостающих аккаунтов</h2>
            <p class="text-sm opacity-60">Пароль для всех: <code class="bg-base-200 px-2 py-1 rounded">rupaseva</code>
            </p>

            <div class="alert alert-info">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div class="text-sm">
                    <p class="font-bold">Будут созданы:</p>
                    <ul class="list-disc list-inside mt-1">
                        <li>Диана Полякова (piterpetro@mail.ru)</li>
                        <li>Ниламани-прия деви даси (nilamanipriyadd@gmail.com)</li>
                        <li>Садху-санга дас (stan.farafonov@gmail.com)</li>
                        <li>Ачинтья дас (newvmccoy@gmail.com)</li>
                        <li>Акшара дас (akshara.das.hariboll@gmail.com)</li>
                        <li>Олег Карпов (karpov.olega@gmail.com)</li>
                        <li>Ванамали Гопал дас (jivjago@yandex.ru)</li>
                        <li>Нитья-виласини деви даси (sazonenko.natali@gmail.com)</li>
                    </ul>
                </div>
            </div>

            <div class="alert alert-error" id="serviceKeyAlert">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div>
                    <p class="font-bold">Нужен Service Role Key!</p>
                    <p class="text-sm">Откройте файл в редакторе и вставьте ключ в строку 66</p>
                    <p class="text-sm mt-1">Supabase Dashboard → Settings → API → Legacy → service_role</p>
                </div>
            </div>

            <div id="status" class="mt-4"></div>

            <div class="card-actions justify-end mt-4 gap-2">
                <button class="btn btn-primary" id="createBtn" onclick="createAccounts()">
                    Создать 8 аккаунтов
                </button>
                <button class="btn btn-secondary" id="resetBtn" onclick="resetPasswords()">
                    Сбросить пароли
                </button>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        const SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxsdHRtZnRhcG13ZWJpZGdldm1nIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODg3NDcxOSwiZXhwIjoyMDg0NDUwNzE5fQ.X_0QWDbsWce8WonT6eDnnlNDOhPaY9YpQEHODjHG8zM'; // ← ВСТАВЬТЕ СЮДА Service Role Key

        // Список пользователей для создания
        const USERS_TO_CREATE = [
            { name: 'Диана Полякова', email: 'piterpetro@mail.ru' },
            { name: 'Ниламани-прия деви даси', email: 'nilamanipriyadd@gmail.com' },
            { name: 'Садху-санга дас', email: 'stan.farafonov@gmail.com' },
            { name: 'Ачинтья дас', email: 'newvmccoy@gmail.com' },
            { name: 'Акшара дас', email: 'akshara.das.hariboll@gmail.com' },
            { name: 'Олег Карпов', email: 'karpov.olega@gmail.com' },
            { name: 'Ванамали Гопал дас', email: 'jivjago@yandex.ru' },
            { name: 'Нитья-виласини деви даси', email: 'sazonenko.natali@gmail.com' }
        ];

        const PASSWORD = 'rupaseva';

        if (!SERVICE_ROLE_KEY) {
            alert('❌ Нужно вставить Service Role Key в строку 66!');
        }

        const db = window.supabase.createClient(CONFIG.SUPABASE_URL, SERVICE_ROLE_KEY);

        // Проверка наличия ключа при загрузке
        window.addEventListener('DOMContentLoaded', () => {
            const alertDiv = document.getElementById('serviceKeyAlert');
            const btn = document.getElementById('createBtn');

            if (!SERVICE_ROLE_KEY || SERVICE_ROLE_KEY.length < 50) {
                alertDiv.classList.remove('hidden');
                btn.disabled = true;
                btn.textContent = 'Сначала добавьте Service Role Key';
            } else {
                alertDiv.classList.add('hidden');
                btn.disabled = false;
            }
        });

        function log(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const alertClass = type === 'error' ? 'alert-error' : type === 'success' ? 'alert-success' : 'alert-info';
            statusDiv.innerHTML += `<div class="alert ${alertClass} mb-2"><span>${message}</span></div>`;
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }

        async function createAccounts() {
            if (!SERVICE_ROLE_KEY || SERVICE_ROLE_KEY.length < 50) {
                alert('❌ Нужно вставить Service Role Key!');
                return;
            }

            const btn = document.getElementById('createBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading loading-spinner"></span> Создаю аккаунты...';

            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '';

            try {
                log(`Создаю ${USERS_TO_CREATE.length} аккаунтов...`);

                let created = 0;
                let errors = 0;
                let skipped = 0;

                for (const user of USERS_TO_CREATE) {
                    log(`Создаю аккаунт для ${user.name} (${user.email})...`);

                    try {
                        const { data, error } = await db.auth.admin.createUser({
                            email: user.email,
                            password: PASSWORD,
                            email_confirm: true,
                            user_metadata: {
                                name: user.name
                            }
                        });

                        if (error) {
                            if (error.message.includes('already registered') || error.message.includes('already been registered')) {
                                log(`⚠️ ${user.name}: аккаунт уже существует`, 'warning');
                                skipped++;
                            } else {
                                log(`❌ ${user.name}: ${error.message}`, 'error');
                                errors++;
                            }
                        } else {
                            log(`✅ ${user.name}: аккаунт создан`, 'success');
                            created++;
                        }
                    } catch (err) {
                        log(`❌ ${user.name}: ${err.message}`, 'error');
                        errors++;
                    }

                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                log(`\n=== ИТОГО ===`, 'success');
                log(`✅ Создано: ${created}`, 'success');
                log(`⚠️ Пропущено (уже существуют): ${skipped}`, 'warning');
                log(`❌ Ошибок: ${errors}`, 'error');

                if (created > 0) {
                    log(`\n⚠️ НЕ ЗАБУДЬ УДАЛИТЬ Service Role Key из файла!`, 'error');
                }

            } catch (err) {
                log(`Критическая ошибка: ${err.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Создать 8 аккаунтов';
            }
        }

        async function resetPasswords() {
            if (!SERVICE_ROLE_KEY || SERVICE_ROLE_KEY.length < 50) {
                alert('❌ Нужно вставить Service Role Key!');
                return;
            }

            const btn = document.getElementById('resetBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading loading-spinner"></span> Сбрасываю пароли...';

            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '';

            try {
                log(`Сбрасываю пароли для ${USERS_TO_CREATE.length} пользователей...`);

                // Получаем всех пользователей из Auth
                const { data: { users }, error: usersError } = await db.auth.admin.listUsers();

                if (usersError) {
                    log(`Ошибка загрузки пользователей: ${usersError.message}`, 'error');
                    return;
                }

                let reset = 0;
                let notFound = 0;
                let errors = 0;

                for (const userData of USERS_TO_CREATE) {
                    // Ищем пользователя по email
                    const user = users.find(u => u.email === userData.email);

                    if (!user) {
                        log(`⚠️ ${userData.name} (${userData.email}): пользователь не найден`, 'warning');
                        notFound++;
                        continue;
                    }

                    log(`Сбрасываю пароль для ${userData.name} (${userData.email})...`);

                    try {
                        const { error } = await db.auth.admin.updateUserById(user.id, {
                            password: PASSWORD
                        });

                        if (error) {
                            log(`❌ ${userData.name}: ${error.message}`, 'error');
                            errors++;
                        } else {
                            log(`✅ ${userData.name}: пароль сброшен на "rupaseva"`, 'success');
                            reset++;
                        }
                    } catch (err) {
                        log(`❌ ${userData.name}: ${err.message}`, 'error');
                        errors++;
                    }

                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                log(`\n=== ИТОГО ===`, 'success');
                log(`✅ Пароли сброшены: ${reset}`, 'success');
                log(`⚠️ Не найдено: ${notFound}`, 'warning');
                log(`❌ Ошибок: ${errors}`, 'error');

                if (reset > 0) {
                    log(`\n⚠️ НЕ ЗАБУДЬ УДАЛИТЬ Service Role Key из файла!`, 'error');
                }

            } catch (err) {
                log(`Критическая ошибка: ${err.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Сбросить пароли';
            }
        }
    </script>
</body>

</html>