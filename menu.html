<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Меню — ШРСК</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/common.css">
    <style>
        .view-btn.active {
            background-color: var(--current-color) !important;
            color: white !important;
        }
        .meal-empty {
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .meal-empty:hover {
            background-color: rgba(0,0,0,0.03);
        }
        /* Ring color for today */
        .ring-2 {
            --tw-ring-color: var(--current-color) !important;
        }
        /* Tabs active state */
        .tabs-boxed .tab.tab-active {
            background-color: var(--current-color) !important;
            color: white !important;
        }
        /* Filter buttons */
        .filter-btn.active {
            background-color: var(--current-color) !important;
            color: white !important;
            border-color: var(--current-color) !important;
        }
        @page {
            margin: 10mm;
            size: auto;
        }
        @media print {
            header, footer, .no-print { display: none !important; }
            .print-only { display: flex !important; }
            main { padding: 0 !important; }
            .shadow-sm { box-shadow: none !important; }
            .bg-base-200, .bg-white\/70, .bg-base-100 { background: white !important; }
            #dayView .rounded-xl { box-shadow: none !important; border: none !important; }
            .print-header {
                display: flex !important;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20pt !important;
                padding-bottom: 12pt;
                border-bottom: 2px solid #000;
            }
            .print-header-left { display: flex; align-items: center; gap: 12pt; }
            .print-header-logo { width: 20pt; height: auto; }
            .print-header-title { font-size: 14pt; font-weight: bold; line-height: 1.2; }
            .print-header-location { font-size: 11pt; opacity: 0.7; }
            .print-header-right { text-align: right; }
            .print-header-menu { font-size: 20pt; font-weight: bold; }
            .print-header-date { font-size: 12pt; opacity: 0.7; }
            .print-meal-info { font-size: 11pt; margin-bottom: 8pt; padding: 4pt 0; border-bottom: 1px solid #ccc; }
            #weekView .rounded-xl, #monthView .rounded { border: 1px solid #ccc !important; }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 flex-1">

        <!-- Navigation Row -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 no-print">
            <div class="flex items-center gap-2">
                <!-- Day nav (active) -->
                <div id="dayNav" class="join border border-base-300 rounded-lg bg-white">
                    <button class="join-item btn btn-sm bg-white border-0" onclick="prevPeriod()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <button class="join-item btn btn-sm bg-white border-0 font-bold view-btn active" data-view="day" onclick="setView('day')" data-i18n="today">Сегодня</button>
                    <button class="join-item btn btn-sm bg-white border-0" onclick="nextPeriod()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
                <button id="dayBtn" class="btn btn-sm btn-ghost view-btn hidden" data-view="day" onclick="setView('day')" data-i18n="today">Сегодня</button>

                <!-- Week nav -->
                <div id="weekNav" class="join border border-base-300 rounded-lg bg-white hidden">
                    <button class="join-item btn btn-sm bg-white border-0" onclick="prevPeriod()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <button class="join-item btn btn-sm bg-white border-0 font-bold view-btn active" data-view="week" data-i18n="week">Неделя</button>
                    <button class="join-item btn btn-sm bg-white border-0" onclick="nextPeriod()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
                <button id="weekBtn" class="btn btn-sm btn-ghost view-btn" data-view="week" onclick="setView('week')" data-i18n="week">Неделя</button>

                <!-- Month nav -->
                <div id="monthNav" class="join border border-base-300 rounded-lg bg-white hidden">
                    <button class="join-item btn btn-sm bg-white border-0" onclick="prevPeriod()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <button class="join-item btn btn-sm bg-white border-0 font-bold view-btn active" data-view="month" data-i18n="month">Месяц</button>
                    <button class="join-item btn btn-sm bg-white border-0" onclick="nextPeriod()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
                <button id="monthBtn" class="btn btn-sm btn-ghost view-btn" data-view="month" onclick="setView('month')" data-i18n="month">Месяц</button>
            </div>

            <div class="flex items-center gap-2">
                <h1 class="text-2xl font-bold">
                    <span data-i18n="menu_title">Меню</span>
                    <span class="opacity-60 ml-2 font-normal text-lg" id="periodRange"></span>
                </h1>
            </div>

            <button class="btn btn-ghost btn-sm gap-2 no-print" onclick="window.print()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                </svg>
                <span data-i18n="print_menu">Распечатать</span>
            </button>
        </div>

        <!-- Day View -->
        <div id="dayView">
            <div class="max-w-2xl mx-auto" id="dayContent">
                <!-- Generated by JS -->
            </div>
        </div>

        <!-- Week View -->
        <div id="weekView" class="hidden">
            <div class="print-only print-header" id="weekPrintHeader"></div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="weekGrid">
                <!-- Generated by JS -->
            </div>
        </div>

        <!-- Month View -->
        <div id="monthView" class="hidden">
            <div class="print-only print-header" id="monthPrintHeader"></div>
            <div class="grid grid-cols-7 gap-1 mb-1" id="monthDayNames">
                <!-- Day names -->
            </div>
            <div class="grid grid-cols-7 gap-1" id="monthGrid">
                <!-- Generated by JS -->
            </div>
        </div>

    </main>

    <div id="footer-placeholder"></div>

    <!-- Add Dish Modal -->
    <dialog id="dishModal" class="modal">
        <div class="modal-box max-w-lg relative">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="dishModal.close()">✕</button>
            <h3 class="font-bold text-lg mb-4" id="dishModalTitle">Добавить блюдо</h3>

            <div class="space-y-4">
                <!-- Tabs -->
                <div class="tabs tabs-boxed">
                    <a class="tab tab-active" id="tabSearch" onclick="switchRecipeTab('search')" data-i18n="search_recipe">Поиск</a>
                    <a class="tab" id="tabBrowse" onclick="switchRecipeTab('browse')" data-i18n="by_category">По категории</a>
                </div>

                <!-- Search Tab -->
                <div id="searchTab">
                    <div class="relative">
                        <input type="text"
                               id="recipeSearch"
                               class="input input-bordered w-full"
                               placeholder="Начните вводить название..."
                               autocomplete="off"
                               oninput="filterRecipes(this.value)"
                               onfocus="showRecipeDropdown()"
                        />
                        <div id="recipeDropdown" class="absolute z-50 w-full bg-base-100 border border-base-300 rounded-lg shadow-lg mt-1 max-h-64 overflow-y-auto hidden">
                        </div>
                    </div>
                </div>

                <!-- Browse Tab -->
                <div id="browseTab" class="hidden">
                    <div class="flex flex-wrap gap-2 mb-3" id="categoryButtons">
                        <!-- Generated by JS -->
                    </div>
                    <div id="categoryRecipeList" class="max-h-64 overflow-y-auto border border-base-300 rounded-lg">
                    </div>
                </div>

                <!-- Selected Recipe -->
                <div id="selectedRecipeDisplay" class="hidden">
                    <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg border-2" style="border-color: var(--current-color);">
                        <div>
                            <div class="font-medium" id="selectedRecipeName"></div>
                            <div class="text-sm opacity-50" id="selectedRecipeNameEn"></div>
                        </div>
                        <button type="button" class="btn btn-ghost btn-sm btn-square" onclick="clearSelectedRecipe()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Portion Size -->
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="portion_size">Размер порции</span></label>
                    <div class="join w-full">
                        <input type="number" id="portionSize" class="input input-bordered join-item w-full" value="200" min="1" />
                        <span id="portionUnit" class="btn join-item no-animation pointer-events-none bg-base-200">г</span>
                    </div>
                </div>

                <div class="text-lg font-semibold" id="totalCalculation">—</div>
            </div>

            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="dishModal.close()" data-i18n="cancel">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveDishBtn" onclick="saveDish()" data-i18n="save">Сохранить</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <script src="js/layout.js"></script>
    <script>
        // ==================== STATE ====================
        let currentView = 'day';
        let currentDate = new Date();
        let currentWeekStart = getWeekStart(new Date());
        let currentMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);

        let recipes = [];
        let categories = [];
        let units = [];
        let menuData = {}; // { 'YYYY-MM-DD': { breakfast: {...}, lunch: {...}, dinner: {...} } }
        let retreats = [];
        let holidays = [];
        let cooks = [];

        let selectedDate = null;
        let selectedMealType = null;
        let selectedRecipe = null;
        let currentCategory = 'all';

        const mealTypes = ['breakfast', 'lunch', 'dinner'];

        // ==================== SHORTCUTS ====================
        const t = key => Layout.t(key);
        const getName = (item, lang) => Layout.getName(item, lang || Layout.currentLang);
        const getPersonName = person => Layout.getPersonName(person, Layout.currentLang);

        // ==================== CONSTANTS ====================
        const LOGO_SVG = `<svg class="print-header-logo" viewBox="0 0 122.03 312.54" xmlns="http://www.w3.org/2000/svg">
            <path fill="currentColor" d="M102,15.99h-15.18v81.89c0,6.21.12,11.58-.88,15.98-1.01,4.45-2.6,7.98-4.77,10.58-2.02,2.81-4.85,4.83-8.51,6.05-2.38,1-5.08,1.62-8.1,1.83-1.01.21-2.02.32-3.02.32h-.64c-3.81-.21-7.23-.83-10.25-1.83-3.81-1.22-7.02-3.13-9.62-5.73-2.65-2.81-4.56-6.44-5.73-10.89-1.22-4.4-1.83-9.83-1.83-16.3V15.99h-15.1v89.12c0,13.68,3.81,23.94,11.45,30.77,3.81,3.44,8.56,5.96,14.23,7.55,1.17.42,2.57.74,4.21.96-13.89,5.03-23.35,11.87-28.38,20.51-7.05,10.65-7.26,24.14-.64,40.46l41.34,100.45,39.91-100.45c6.41-16.32,6.2-29.82-.64-40.46-4.82-8.48-13.97-15.21-27.43-20.2,1.59-.43,3.18-.85,4.77-1.27,5.25-1.59,9.67-4.19,13.27-7.79,3.82-3.66,6.65-8.18,8.51-13.59,2.02-5.62,3.02-12.27,3.02-19.95V15.99M87.45,172.46c4.03,7.26,3.84,16.4-.56,27.43l-26.31,68.13-27.75-68.13c-4.61-11.03-4.8-20.17-.55-27.43,4.61-7.47,13.76-13.01,27.43-16.62,13.67,3.61,22.93,9.15,27.75,16.62"/>
        </svg>`;

        // ==================== HELPERS ====================
        // Названия месяцев
        const getMonthNames = () => [
            t('month_jan'), t('month_feb'), t('month_mar'), t('month_apr'),
            t('month_may'), t('month_jun'), t('month_jul'), t('month_aug'),
            t('month_sep'), t('month_oct'), t('month_nov'), t('month_dec')
        ];

        // Названия дней недели (с воскресенья, для getDay())
        const getDayNames = () => [
            t('weekday_sun'), t('weekday_mon'), t('weekday_tue'), t('weekday_wed'),
            t('weekday_thu'), t('weekday_fri'), t('weekday_sat')
        ];

        // Названия дней недели (с понедельника, для календаря)
        const getDayNamesMon = () => [
            t('weekday_mon'), t('weekday_tue'), t('weekday_wed'), t('weekday_thu'),
            t('weekday_fri'), t('weekday_sat'), t('weekday_sun')
        ];

        // Текущая локация (объект)
        const getCurrentLocation = () => Layout.locations?.find(l => l.slug === Layout.currentLocation);

        // Перевод единицы измерения
        function getUnitShort(unitCode) {
            if (!unitCode) return '';
            const unit = units.find(u => u.code === unitCode || u.short_ru === unitCode || u.short_en === unitCode);
            return unit ? (unit[`short_${Layout.currentLang}`] || unit.short_ru || unitCode) : unitCode;
        }

        // Стили фона для дня (ретрит/праздник/экадаши)
        function getDayStyles(retreat, majorFestival, isEkadashiDay) {
            if (retreat) return { bg: `background-color: ${retreat.color}20;`, header: `background-color: ${retreat.color}30; border-left: 4px solid ${retreat.color};` };
            if (majorFestival) return { bg: 'background-color: #FEF9C3;', header: 'background-color: #FDE047; border-left: 4px solid #EAB308;' };
            if (isEkadashiDay) return { bg: 'background-color: #FFFBEB;', header: 'background-color: #FEF3C7;' };
            return { bg: 'background-color: white;', header: '' };
        }

        // Форматирование даты для отображения
        function formatDateDisplay(date) {
            const m = getMonthNames(), d = getDayNames();
            return `${date.getDate()} ${m[date.getMonth()]} ${date.getFullYear()}, ${d[date.getDay()]}`;
        }

        // Шапка для печати
        function getPrintHeader(dateText, extraInfo = '') {
            const loc = getCurrentLocation();
            return `
                <div class="print-header-left">
                    ${LOGO_SVG}
                    <div>
                        <div class="print-header-title">${t('app_name')}</div>
                        <div class="print-header-location">${loc ? getName(loc) : ''}</div>
                    </div>
                </div>
                <div class="print-header-right">
                    <div class="print-header-menu">${t('menu_title')}</div>
                    <div class="print-header-date">${dateText}${extraInfo ? ' · ' + extraInfo : ''}</div>
                </div>
            `;
        }

        // ==================== DATE HELPERS ====================
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function getMealTypeName(type) {
            return t(type) || type;
        }

        function isEkadashi(dateStr) {
            return holidays.some(h => h.date === dateStr && h.type === 'ekadashi');
        }

        function getMajorFestival(dateStr) {
            return holidays.find(h => h.date === dateStr && h.type === 'major');
        }

        function getAcharyaEvents(dateStr) {
            return holidays.filter(h => h.date === dateStr && (h.type === 'appearance' || h.type === 'disappearance'));
        }

        function getHoliday(dateStr) {
            return holidays.find(h => h.date === dateStr);
        }

        function getRetreat(dateStr) {
            return retreats.find(r => {
                return dateStr >= r.start_date && dateStr <= r.end_date;
            });
        }

        function getCook(id) {
            return cooks.find(c => c.id === id);
        }

        // ==================== DATA LOADING ====================
        async function loadData() {
            const locationId = getCurrentLocation()?.id;

            // Load recipes with categories
            const { data: recipesData } = await Layout.db
                .from('recipes')
                .select('*, category:recipe_categories(*)');
            recipes = recipesData || [];

            // Load categories
            const { data: categoriesData } = await Layout.db
                .from('recipe_categories')
                .select('*')
                .order('sort_order');
            categories = categoriesData || [];

            // Load retreats
            const { data: retreatsData } = await Layout.db
                .from('retreats')
                .select('*');
            retreats = retreatsData || [];

            // Load holidays
            const { data: holidaysData } = await Layout.db
                .from('holidays')
                .select('*');
            holidays = holidaysData || [];

            // Load cooks (team members from Kitchen department only)
            const { data: cooksData } = await Layout.db
                .from('team_members')
                .select('*, department:departments!inner(*)');
            cooks = (cooksData || []).filter(m => m.department?.name_en === 'Kitchen');

            // Load units
            const { data: unitsData } = await Layout.db
                .from('units')
                .select('*');
            units = unitsData || [];

            // Load menu for current period
            await loadMenuData();
        }

        async function loadMenuData() {
            const locationId = getCurrentLocation()?.id;
            if (!locationId) {
                menuData = {};
                render();
                return;
            }

            // Calculate date range based on view
            let startDate, endDate;
            if (currentView === 'day') {
                startDate = endDate = formatDate(currentDate);
            } else if (currentView === 'week') {
                startDate = formatDate(currentWeekStart);
                const weekEnd = new Date(currentWeekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                endDate = formatDate(weekEnd);
            } else {
                startDate = formatDate(new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1));
                endDate = formatDate(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0));
            }

            // Load meals with dishes
            const { data: mealsData } = await Layout.db
                .from('menu_meals')
                .select(`
                    *,
                    cook:team_members(*),
                    dishes:menu_dishes(*, recipe:recipes(*))
                `)
                .eq('location_id', locationId)
                .gte('date', startDate)
                .lte('date', endDate);

            // Organize by date and meal_type
            menuData = {};
            (mealsData || []).forEach(meal => {
                if (!menuData[meal.date]) {
                    menuData[meal.date] = {};
                }
                menuData[meal.date][meal.meal_type] = {
                    id: meal.id,
                    portions: meal.portions,
                    cook_id: meal.cook_id,
                    cook: meal.cook,
                    dishes: (meal.dishes || []).map(d => ({
                        id: d.id,
                        recipe_id: d.recipe_id,
                        recipe: d.recipe,
                        portion_size: d.portion_size,
                        portion_unit: d.portion_unit
                    }))
                };
            });

            render();
        }

        // ==================== RENDERING ====================
        function render() {
            if (currentView === 'day') {
                renderDay();
            } else if (currentView === 'week') {
                renderWeek();
            } else {
                renderMonth();
            }
            updatePeriodRange();
        }

        function updatePeriodRange() {
            const m = getMonthNames();
            let text = '';

            if (currentView === 'day') {
                text = `${currentDate.getDate()} ${m[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            } else if (currentView === 'week') {
                const end = new Date(currentWeekStart);
                end.setDate(end.getDate() + 6);
                text = `${currentWeekStart.getDate()} – ${end.getDate()} ${m[end.getMonth()]} ${end.getFullYear()}`;
            } else {
                text = `${m[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
            }

            Layout.$('#periodRange').textContent = text;
        }

        function renderDay() {
            const container = Layout.$('#dayContent');
            const dateStr = formatDate(currentDate);
            const dayMenu = menuData[dateStr] || {};
            const retreat = getRetreat(dateStr);
            const majorFestival = getMajorFestival(dateStr);
            const acharyaEvents = getAcharyaEvents(dateStr);
            const isEkadashiDay = isEkadashi(dateStr);
            const isToday = dateStr === formatDate(new Date());
            const styles = getDayStyles(retreat, majorFestival, isEkadashiDay);
            const m = getMonthNames();
            const d = getDayNames();

            const dateText = formatDateDisplay(currentDate);
            const extraInfo = [retreat ? getName(retreat) : '', majorFestival ? getName(majorFestival) : '', isEkadashiDay ? t('ekadashi') : ''].filter(Boolean).join(' · ');

            // Build holiday banner
            let holidayBanner = '';
            if (majorFestival) {
                holidayBanner = `<div class="bg-yellow-200 text-yellow-800 text-center py-2 font-medium no-print">${getName(majorFestival)}</div>`;
            } else if (isEkadashiDay) {
                holidayBanner = `<div class="bg-amber-100 text-amber-700 text-center py-2 font-medium no-print">${t('ekadashi')}</div>`;
            }

            // Acharya events (appearance/disappearance) - show names without highlight
            let acharyaBanner = '';
            if (acharyaEvents.length > 0) {
                const acharyaNames = acharyaEvents.map(e => getName(e)).join(' · ');
                acharyaBanner = `<div class="text-center py-1.5 text-sm opacity-70 border-b border-base-200/50 no-print">${acharyaNames}</div>`;
            }

            container.innerHTML = `
                <div class="print-only print-header">${getPrintHeader(dateText, extraInfo)}</div>
                <div class="rounded-xl shadow-sm overflow-hidden ${isToday ? 'ring-2 ring-offset-2' : ''}" style="${styles.bg}">
                    ${holidayBanner}
                    ${acharyaBanner}

                    <div class="p-4 border-b border-base-200/50 no-print" style="${retreat ? `border-left: 4px solid ${retreat.color};` : (majorFestival ? 'border-left: 4px solid #EAB308;' : '')}">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-lg font-semibold">${currentDate.getDate()} ${m[currentDate.getMonth()]} ${currentDate.getFullYear()}</div>
                                <div class="text-sm opacity-60">${d[currentDate.getDay()]}</div>
                            </div>
                            ${retreat ? `<div class="text-sm font-bold uppercase tracking-wide" style="color: ${retreat.color};">${getName(retreat)}</div>` : `<div class="text-sm opacity-40">${t('no_retreat')}</div>`}
                        </div>
                    </div>

                    <div class="p-4 space-y-4">
                        ${mealTypes.map((mt, i) => renderMealSection(dateStr, mt, i, dayMenu[mt], isEkadashiDay)).join('')}
                    </div>
                </div>
            `;
        }

        function renderMealSection(dateStr, mealType, index, mealData, isEkadashiDay) {
            const dishes = mealData?.dishes || [];
            const portions = mealData?.portions || 50;
            const cook = mealData?.cook;

            // Calculate totals
            let totalG = 0, totalMl = 0, totalPcs = 0;
            dishes.forEach(d => {
                const u = d.portion_unit?.toLowerCase();
                if (u === 'г' || u === 'g') totalG += parseFloat(d.portion_size) || 0;
                else if (u === 'мл' || u === 'ml') totalMl += parseFloat(d.portion_size) || 0;
                else if (u === 'шт' || u === 'pcs') totalPcs += parseFloat(d.portion_size) || 0;
            });
            const totals = [
                totalG > 0 ? `${totalG} ${getUnitShort('g')}` : '',
                totalMl > 0 ? `${totalMl} ${getUnitShort('ml')}` : '',
                totalPcs > 0 ? `${totalPcs} ${getUnitShort('pcs')}` : ''
            ].filter(Boolean).join(' · ');

            if (dishes.length === 0) {
                return `
                    <div class="p-4 rounded-lg bg-white/40 meal-empty no-print" onclick="openDishModal('${dateStr}', '${mealType}')">
                        <div class="flex items-center justify-center py-8">
                            <div class="flex items-center gap-3 opacity-40">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                <span class="text-xl font-medium">${index + 1}. ${getMealTypeName(mealType)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="p-4 rounded-lg bg-white/70">
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-base-300/50">
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-xl">${index + 1}. ${getMealTypeName(mealType)}</span>
                            ${totals ? `<span class="text-base opacity-60">${totals}</span>` : ''}
                        </div>
                        <button class="btn btn-ghost btn-md btn-square opacity-50 hover:opacity-100 no-print" onclick="openDishModal('${dateStr}', '${mealType}')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                        </button>
                    </div>

                    <div class="flex items-center gap-4 mb-3 p-2 bg-base-100 rounded-lg no-print">
                        <div class="flex items-center gap-2 flex-1">
                            <span class="text-sm opacity-60">${t('cook')}:</span>
                            <select class="select select-sm select-bordered flex-1" onchange="updateMealCook('${dateStr}', '${mealType}', this.value)">
                                <option value="">— ${t('select_cook')} —</option>
                                ${cooks.map(c => `<option value="${c.id}" ${mealData?.cook_id === c.id ? 'selected' : ''}>${getPersonName(c)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex items-center gap-1">
                            <input type="number"
                                   class="input input-sm input-bordered w-20 text-center"
                                   value="${portions}"
                                   min="1"
                                   onchange="updateMealPortions('${dateStr}', '${mealType}', this.value)"
                            />
                            <span class="text-sm opacity-60">${t('persons')}</span>
                        </div>
                    </div>
                    <div class="print-only print-meal-info">
                        ${t('cook')}:&nbsp;<strong>${getPersonName(cook) || '—'}</strong> · ${t('portions')}:&nbsp;<strong>${portions}</strong>
                    </div>

                    <div class="space-y-2">
                        ${dishes.map(dish => {
                            const recipe = dish.recipe;
                            if (!recipe) return '';
                            const portionInfo = dish.portion_size ? `${dish.portion_size} ${getUnitShort(dish.portion_unit)}` : '';
                            const notEkadashiWarning = isEkadashiDay && !recipe.ekadashi;
                            const categoryName = recipe.category ? getName(recipe.category) : '';

                            return `
                                <div class="flex justify-between items-center py-2 border-b border-base-300 last:border-0 ${notEkadashiWarning ? 'bg-error/10 -mx-2 px-2 rounded' : ''}">
                                    <div>
                                        <a href="recipe.html?id=${recipe.id}" class="hover:text-primary font-medium text-base">${getName(recipe)}</a>
                                        <span class="text-xs opacity-40 ml-2">${categoryName}</span>
                                        ${notEkadashiWarning ? `<span class="text-xs text-error ml-2">⚠ ${t('ekadashi_warning')}</span>` : ''}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="badge badge-lg">${portionInfo}</span>
                                        <button class="btn btn-ghost btn-sm btn-square text-error/60 hover:text-error hover:bg-error/10 no-print" onclick="removeDish('${dateStr}', '${mealType}', '${dish.id}')">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderWeek() {
            const grid = Layout.$('#weekGrid');
            const today = formatDate(new Date());
            const m = getMonthNames();
            const d = getDayNames();

            // Генерируем массив дней недели
            const days = Array.from({ length: 7 }, (_, i) => {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                return date;
            });

            // Print header
            const weekEnd = days[6];
            const printHeader = Layout.$('#weekPrintHeader');
            if (printHeader) {
                printHeader.innerHTML = getPrintHeader(`${currentWeekStart.getDate()} – ${weekEnd.getDate()} ${m[weekEnd.getMonth()]} ${weekEnd.getFullYear()}`);
            }

            grid.innerHTML = days.map(date => {
                const dateStr = formatDate(date);
                const dayMenu = menuData[dateStr] || {};
                const isEkadashiDay = isEkadashi(dateStr);
                const majorFestival = getMajorFestival(dateStr);
                const acharyaEvents = getAcharyaEvents(dateStr);
                const retreat = getRetreat(dateStr);
                const isToday = dateStr === today;
                const styles = getDayStyles(retreat, majorFestival, isEkadashiDay);

                // Holiday label for header
                let holidayLabel = '';
                if (majorFestival) {
                    holidayLabel = ` <span class="text-yellow-700 font-normal">· ${getName(majorFestival)}</span>`;
                } else if (isEkadashiDay) {
                    holidayLabel = ` <span class="text-amber-600 font-normal">· ${t('ekadashi')}</span>`;
                }

                // Acharya events
                let acharyaLine = '';
                if (acharyaEvents.length > 0) {
                    acharyaLine = `<div class="mt-1 text-xs opacity-60 truncate">${acharyaEvents.map(e => getName(e)).join(' · ')}</div>`;
                }

                return `
                    <div class="rounded-xl shadow-sm overflow-hidden flex flex-col ${isToday ? 'ring-2 ring-offset-2' : ''}" style="${styles.bg}">
                        <div class="p-3 border-b border-base-200" style="${styles.header}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-semibold">${date.getDate()} ${m[date.getMonth()]}${holidayLabel}</div>
                                    <div class="text-sm opacity-60">${d[date.getDay()]}</div>
                                </div>
                                <button class="btn btn-ghost btn-sm btn-square opacity-50 hover:opacity-100 no-print" onclick="openDayDetail('${dateStr}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                            </div>
                            ${retreat ? `<div class="mt-1 text-xs font-bold uppercase tracking-wide" style="color: ${retreat.color};">${getName(retreat)}</div>` : ''}
                            ${acharyaLine}
                        </div>

                        <div class="p-3 space-y-2 mt-auto">
                            ${mealTypes.map((mt, i) => {
                                const meal = dayMenu[mt];
                                if (!meal?.dishes?.length) {
                                    return `<div class="flex items-center text-sm opacity-30 py-1 no-print"><span class="w-4 text-center">${i + 1}.</span><span class="ml-1">${getMealTypeName(mt)}</span></div>`;
                                }
                                const dishesText = meal.dishes.map(d => {
                                    const name = getName(d.recipe);
                                    const portion = d.portion_size ? `${d.portion_size}${getUnitShort(d.portion_unit)}` : '';
                                    return portion ? `${name} (${portion})` : name;
                                }).join(', ');
                                return `
                                    <div class="text-sm py-1">
                                        <div class="flex items-center">
                                            <span class="w-4 text-center font-medium">${i + 1}.</span>
                                            <span class="ml-1 flex-1 truncate font-medium">${getPersonName(meal.cook) || '—'}</span>
                                            <span class="text-xs opacity-60 ml-2">${meal.portions}</span>
                                        </div>
                                        <div class="text-xs opacity-60 ml-5 leading-tight">${dishesText}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderMonth() {
            const grid = Layout.$('#monthGrid');
            const dayNamesContainer = Layout.$('#monthDayNames');
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const m = getMonthNames();
            const d = getDayNamesMon();
            const today = formatDate(new Date());

            // Print header
            const printHeader = Layout.$('#monthPrintHeader');
            if (printHeader) {
                printHeader.innerHTML = getPrintHeader(`${m[month]} ${year}`);
            }

            // Названия дней недели
            dayNamesContainer.innerHTML = d.map(name => `<div class="text-center text-sm font-medium opacity-60 py-2">${name}</div>`).join('');

            // Рассчитываем дни месяца
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            let startDayOfWeek = firstDay.getDay();
            startDayOfWeek = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1;

            // Пустые ячейки + дни месяца
            const days = [
                ...Array(startDayOfWeek).fill(null),
                ...Array.from({ length: lastDay.getDate() }, (_, i) => new Date(year, month, i + 1))
            ];

            grid.innerHTML = days.map(date => {
                if (!date) return '<div class="min-h-20 bg-base-200/20 rounded"></div>';

                const dateStr = formatDate(date);
                const isEkadashiDay = isEkadashi(dateStr);
                const majorFestival = getMajorFestival(dateStr);
                const acharyaEvents = getAcharyaEvents(dateStr);
                const retreat = getRetreat(dateStr);
                const isToday = dateStr === today;
                const dayMenu = menuData[dateStr] || {};

                // Background styles: retreat > major festival > ekadashi > default
                let bgStyle = 'background-color: white;';
                let borderStyle = '';
                if (retreat) {
                    bgStyle = `background-color: ${retreat.color}20;`;
                    borderStyle = `border-left: 3px solid ${retreat.color};`;
                } else if (majorFestival) {
                    bgStyle = 'background-color: #FEF9C3;';
                    borderStyle = 'border-left: 3px solid #EAB308;';
                } else if (isEkadashiDay) {
                    bgStyle = 'background-color: #FFFBEB;';
                }

                // Holiday indicator
                let holidayIndicator = '';
                if (majorFestival) {
                    holidayIndicator = '<span class="text-xs font-medium text-yellow-700">★</span>';
                } else if (isEkadashiDay) {
                    holidayIndicator = '<span class="text-xs font-medium text-amber-600">э</span>';
                }

                const mealLines = mealTypes.map((mt, i) => {
                    const meal = dayMenu[mt];
                    if (!meal?.dishes?.length) return null;
                    const cookName = getPersonName(meal.cook).split(' ')[0];
                    return `<div class="text-xs truncate"><span class="opacity-50">${i + 1}.</span> <span class="no-print">${cookName} – </span>${meal.portions}</div>`;
                }).filter(Boolean).join('');

                // Holiday/acharya names
                let holidayName = '';
                if (majorFestival) {
                    holidayName = `<div class="text-xs font-bold truncate leading-tight mb-0.5 text-yellow-700">${getName(majorFestival)}</div>`;
                }
                let acharyaName = '';
                if (acharyaEvents.length > 0) {
                    acharyaName = `<div class="text-xs truncate leading-tight mb-0.5 opacity-60">${acharyaEvents.map(e => getName(e)).join(', ')}</div>`;
                }

                return `
                    <div class="min-h-20 rounded shadow-sm p-1.5 ${isToday ? 'ring-2' : ''} cursor-pointer hover:opacity-80 flex flex-col" style="${bgStyle} ${borderStyle}" onclick="openDayDetail('${dateStr}')">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-bold text-sm ${isToday ? 'text-primary' : ''}">${date.getDate()}</span>
                            ${holidayIndicator}
                        </div>
                        ${retreat ? `<div class="text-xs font-bold truncate leading-tight mb-1" style="color: ${retreat.color};">${getName(retreat)}</div>` : ''}
                        ${holidayName}
                        ${acharyaName}
                        <div class="flex-1 space-y-0.5">${mealLines}</div>
                    </div>
                `;
            }).join('');
        }

        // ==================== VIEW NAVIGATION ====================
        function setView(view) {
            currentView = view;

            // Show/hide nav groups and buttons
            Layout.$('#dayNav').classList.toggle('hidden', view !== 'day');
            Layout.$('#dayBtn').classList.toggle('hidden', view === 'day');
            Layout.$('#weekNav').classList.toggle('hidden', view !== 'week');
            Layout.$('#weekBtn').classList.toggle('hidden', view === 'week');
            Layout.$('#monthNav').classList.toggle('hidden', view !== 'month');
            Layout.$('#monthBtn').classList.toggle('hidden', view === 'month');

            // Show/hide views
            Layout.$('#dayView').classList.toggle('hidden', view !== 'day');
            Layout.$('#weekView').classList.toggle('hidden', view !== 'week');
            Layout.$('#monthView').classList.toggle('hidden', view !== 'month');

            loadMenuData();
        }

        function prevPeriod() {
            if (currentView === 'day') {
                currentDate.setDate(currentDate.getDate() - 1);
            } else if (currentView === 'week') {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            } else {
                currentMonth.setMonth(currentMonth.getMonth() - 1);
            }
            loadMenuData();
        }

        function nextPeriod() {
            if (currentView === 'day') {
                currentDate.setDate(currentDate.getDate() + 1);
            } else if (currentView === 'week') {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            } else {
                currentMonth.setMonth(currentMonth.getMonth() + 1);
            }
            loadMenuData();
        }

        function openDayDetail(dateStr) {
            currentDate = new Date(dateStr);
            setView('day');
        }

        // ==================== MEAL EDITING ====================
        async function updateMealPortions(dateStr, mealType, value) {
            const portions = parseInt(value);
            if (portions < 1) return;

            const locationId = getCurrentLocation()?.id;
            if (!locationId) return;

            const mealData = menuData[dateStr]?.[mealType];

            if (mealData?.id) {
                await Layout.db
                    .from('menu_meals')
                    .update({ portions })
                    .eq('id', mealData.id);
            } else {
                const { data } = await Layout.db
                    .from('menu_meals')
                    .upsert({
                        location_id: locationId,
                        date: dateStr,
                        meal_type: mealType,
                        portions
                    }, { onConflict: 'location_id,date,meal_type' })
                    .select()
                    .single();

                if (data) {
                    if (!menuData[dateStr]) menuData[dateStr] = {};
                    if (!menuData[dateStr][mealType]) menuData[dateStr][mealType] = { dishes: [] };
                    menuData[dateStr][mealType].id = data.id;
                    menuData[dateStr][mealType].portions = portions;
                }
            }
        }

        async function updateMealCook(dateStr, mealType, cookId) {
            const locationId = getCurrentLocation()?.id;
            if (!locationId) return;

            const mealData = menuData[dateStr]?.[mealType];

            if (mealData?.id) {
                await Layout.db
                    .from('menu_meals')
                    .update({ cook_id: cookId || null })
                    .eq('id', mealData.id);

                mealData.cook_id = cookId || null;
                mealData.cook = getCook(cookId);
            }

            render();
        }

        async function removeDish(dateStr, mealType, dishId) {
            await Layout.db
                .from('menu_dishes')
                .delete()
                .eq('id', dishId);

            const mealData = menuData[dateStr]?.[mealType];
            if (mealData) {
                mealData.dishes = mealData.dishes.filter(d => d.id !== dishId);
            }

            render();
        }

        // ==================== DISH MODAL ====================
        function openDishModal(dateStr, mealType) {
            selectedDate = dateStr;
            selectedMealType = mealType;
            selectedRecipe = null;

            const date = new Date(dateStr);
            const m = getMonthNames();
            const d = getDayNames();

            Layout.$('#dishModalTitle').textContent = `${getMealTypeName(mealType)} · ${d[date.getDay()]}, ${date.getDate()} ${m[date.getMonth()]}`;

            // Reset form
            Layout.$('#recipeSearch').value = '';
            Layout.$('#recipeDropdown').classList.add('hidden');
            Layout.$('#selectedRecipeDisplay').classList.add('hidden');
            Layout.$('#portionSize').value = 200;
            Layout.$('#portionUnit').textContent = 'г';
            Layout.$('#saveDishBtn').disabled = true;
            Layout.$('#totalCalculation').textContent = '—';

            // Reset tabs
            Layout.$('#tabSearch').classList.add('tab-active');
            Layout.$('#tabBrowse').classList.remove('tab-active');
            Layout.$('#searchTab').classList.remove('hidden');
            Layout.$('#browseTab').classList.add('hidden');
            currentCategory = 'all';

            // Build category buttons
            buildCategoryButtons();

            dishModal.showModal();
        }

        function buildCategoryButtons() {
            const container = Layout.$('#categoryButtons');
            container.innerHTML = `
                <button type="button" class="btn btn-sm filter-btn ${currentCategory === 'all' ? 'active' : ''}" data-cat="all" onclick="filterByCategory('all')">${t('filter_all') || 'Все'}</button>
                ${categories.map(cat => `
                    <button type="button" class="btn btn-sm filter-btn ${currentCategory === cat.slug ? 'active' : ''}" data-cat="${cat.slug}" style="--cat-color: ${cat.color};" onclick="filterByCategory('${cat.slug}')">${getName(cat)}</button>
                `).join('')}
            `;
        }

        function switchRecipeTab(tab) {
            if (tab === 'search') {
                Layout.$('#searchTab').classList.remove('hidden');
                Layout.$('#browseTab').classList.add('hidden');
                Layout.$('#tabSearch').classList.add('tab-active');
                Layout.$('#tabBrowse').classList.remove('tab-active');
            } else {
                Layout.$('#searchTab').classList.add('hidden');
                Layout.$('#browseTab').classList.remove('hidden');
                Layout.$('#tabSearch').classList.remove('tab-active');
                Layout.$('#tabBrowse').classList.add('tab-active');
                filterByCategory(currentCategory);
            }
        }

        function filterRecipes(query) {
            const dropdown = Layout.$('#recipeDropdown');

            if (query.length < 1) {
                dropdown.classList.add('hidden');
                return;
            }

            const q = query.toLowerCase();
            const isEkadashiDay = isEkadashi(selectedDate);

            const filtered = recipes.filter(r =>
                r.name_ru?.toLowerCase().includes(q) ||
                r.name_en?.toLowerCase().includes(q) ||
                r.name_hi?.includes(query) ||
                r.translit?.toLowerCase().includes(q)
            ).slice(0, 8);

            if (filtered.length === 0) {
                dropdown.innerHTML = `<div class="p-3 text-sm opacity-50">${t('nothing_found')}</div>`;
            } else {
                dropdown.innerHTML = filtered.map(r => `
                    <div class="p-3 hover:bg-base-200 cursor-pointer border-b border-base-200 last:border-0 ${isEkadashiDay && !r.ekadashi ? 'opacity-50' : ''}" onclick="selectRecipe('${r.id}')">
                        <div class="font-medium flex items-center gap-2">
                            ${getName(r)}
                            ${r.ekadashi ? '<span class="text-xs text-amber-600">э</span>' : ''}
                            ${isEkadashiDay && !r.ekadashi ? '<span class="text-xs text-error">⚠</span>' : ''}
                        </div>
                        <div class="text-xs opacity-50">${r.name_en || ''}</div>
                    </div>
                `).join('');
            }

            dropdown.classList.remove('hidden');
        }

        function showRecipeDropdown() {
            const input = Layout.$('#recipeSearch');
            if (input.value.length >= 1) {
                filterRecipes(input.value);
            }
        }

        function filterByCategory(category) {
            currentCategory = category;
            const list = Layout.$('#categoryRecipeList');
            const isEkadashiDay = isEkadashi(selectedDate);

            // Update buttons
            Layout.$$('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.cat === category);
            });

            let filtered = recipes;
            if (category !== 'all') {
                filtered = recipes.filter(r => r.category?.slug === category);
            }

            if (isEkadashiDay) {
                filtered = [...filtered].sort((a, b) => (b.ekadashi ? 1 : 0) - (a.ekadashi ? 1 : 0));
            }

            if (filtered.length === 0) {
                list.innerHTML = `<div class="p-3 text-sm opacity-50 text-center">${t('nothing_found')}</div>`;
            } else {
                list.innerHTML = filtered.map(r => `
                    <div class="p-3 hover:bg-base-200 cursor-pointer border-b border-base-200 last:border-0 ${isEkadashiDay && !r.ekadashi ? 'opacity-50' : ''}" onclick="selectRecipe('${r.id}')">
                        <div class="font-medium flex items-center gap-2">
                            ${getName(r)}
                            ${r.ekadashi ? '<span class="text-xs text-amber-600">э</span>' : ''}
                            ${isEkadashiDay && !r.ekadashi ? '<span class="text-xs text-error">⚠</span>' : ''}
                        </div>
                        <div class="text-xs opacity-50">${r.name_en || ''} · ${r.category ? getName(r.category) : ''}</div>
                    </div>
                `).join('');
            }
        }

        function selectRecipe(recipeId) {
            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) {
                console.error('Recipe not found:', recipeId);
                return;
            }

            selectedRecipe = recipe;

            Layout.$('#searchTab').classList.add('hidden');
            Layout.$('#browseTab').classList.add('hidden');
            Layout.$('#recipeDropdown').classList.add('hidden');
            Layout.$('#selectedRecipeDisplay').classList.remove('hidden');
            Layout.$('#selectedRecipeName').textContent = getName(recipe);
            Layout.$('#selectedRecipeNameEn').textContent = recipe.name_en || '';

            // Set portion size from recipe
            Layout.$('#portionSize').value = recipe.portion_amount || 200;
            Layout.$('#portionUnit').textContent = getUnitShort(recipe.portion_unit || 'g');

            const saveBtn = document.getElementById('saveDishBtn');
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.removeAttribute('disabled');
                saveBtn.classList.remove('btn-disabled');
                saveBtn.style.pointerEvents = 'auto';
                saveBtn.style.opacity = '1';
            }
            updateTotalCalculation();
        }

        function clearSelectedRecipe() {
            selectedRecipe = null;

            if (Layout.$('#tabSearch').classList.contains('tab-active')) {
                Layout.$('#searchTab').classList.remove('hidden');
                Layout.$('#recipeSearch').value = '';
            } else {
                Layout.$('#browseTab').classList.remove('hidden');
            }
            Layout.$('#selectedRecipeDisplay').classList.add('hidden');
            Layout.$('#saveDishBtn').disabled = true;
        }

        function updateTotalCalculation() {
            const size = parseInt(Layout.$('#portionSize').value) || 0;
            const unit = Layout.$('#portionUnit').textContent;
            Layout.$('#totalCalculation').textContent = `${size} ${unit} ${t('per_person')}`;
        }

        Layout.$('#portionSize')?.addEventListener('input', updateTotalCalculation);

        async function saveDish() {
            if (!selectedRecipe) return;

            const portionSize = parseInt(Layout.$('#portionSize').value) || 200;
            const portionUnit = Layout.$('#portionUnit').textContent;
            const locationId = getCurrentLocation()?.id;

            if (!locationId) return;

            // Check ekadashi warning
            if (isEkadashi(selectedDate) && !selectedRecipe.ekadashi) {
                if (!confirm(`⚠️ ${selectedDate} — ${t('confirm_ekadashi')}`)) {
                    return;
                }
            }

            // Check if already added
            const mealData = menuData[selectedDate]?.[selectedMealType];
            if (mealData?.dishes?.some(d => d.recipe_id === selectedRecipe.id)) {
                alert(t('already_added'));
                return;
            }

            // Ensure meal exists
            let mealId = mealData?.id;
            if (!mealId) {
                const { data: newMeal } = await Layout.db
                    .from('menu_meals')
                    .upsert({
                        location_id: locationId,
                        date: selectedDate,
                        meal_type: selectedMealType,
                        portions: 50
                    }, { onConflict: 'location_id,date,meal_type' })
                    .select()
                    .single();

                if (!newMeal) {
                    alert('Error creating meal');
                    return;
                }
                mealId = newMeal.id;
            }

            // Add dish
            const { data: newDish, error } = await Layout.db
                .from('menu_dishes')
                .insert({
                    meal_id: mealId,
                    recipe_id: selectedRecipe.id,
                    portion_size: portionSize,
                    portion_unit: portionUnit
                })
                .select('*, recipe:recipes(*)')
                .single();

            if (error) {
                console.error('Error adding dish:', error);
                alert('Error adding dish');
                return;
            }

            // Update local data
            if (!menuData[selectedDate]) menuData[selectedDate] = {};
            if (!menuData[selectedDate][selectedMealType]) {
                menuData[selectedDate][selectedMealType] = { id: mealId, portions: 50, dishes: [] };
            }
            menuData[selectedDate][selectedMealType].dishes.push({
                id: newDish.id,
                recipe_id: newDish.recipe_id,
                recipe: newDish.recipe,
                portion_size: newDish.portion_size,
                portion_unit: newDish.portion_unit
            });

            dishModal.close();
            render();
        }

        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
            const dropdown = Layout.$('#recipeDropdown');
            const input = Layout.$('#recipeSearch');
            if (dropdown && input && !dropdown.contains(e.target) && e.target !== input) {
                dropdown.classList.add('hidden');
            }
        });

        // ==================== INIT ====================
        async function init() {
            await Layout.init({ menuId: 'kitchen', itemId: 'menu' });
            await loadData();
        }

        window.onLanguageChange = () => {
            Layout.updateAllTranslations();
            render();
        };
        window.onLocationChange = () => loadMenuData();

        init();
    </script>
</body>
</html>
