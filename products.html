<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–¥—É–∫—Ç—ã ‚Äî –®–†–°–ö</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/common.css">
    <style>
        .product-row:hover { background-color: rgba(0,0,0,0.02); }
        .translate-btn {
            padding: 2px 8px;
            font-size: 11px;
            border-radius: 4px;
            background: #e5e7eb;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.15s;
        }
        .translate-btn:hover {
            background: var(--current-color);
            color: white;
        }
        .translate-btn.loading {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 flex-1">

        <!-- Page Title -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold" data-i18n="products_title">–ü—Ä–æ–¥—É–∫—Ç—ã</h1>
                <p class="text-sm opacity-60" id="productsCount">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <button class="btn btn-primary gap-2" onclick="openAddModal()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <span data-i18n="add_product">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</span>
            </button>
        </div>

        <!-- Search + Filters -->
        <div class="flex flex-col sm:flex-row gap-4 mb-4">
            <div class="flex-1 max-w-md relative">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." class="input input-bordered w-full pr-10" data-i18n-placeholder="search_placeholder" />
                <button type="button" id="clearSearch" class="absolute right-3 top-1/2 -translate-y-1/2 text-base-content/40 hover:text-base-content hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <select id="sortSelect" class="select select-bordered w-full sm:w-auto">
                <option value="name_asc" data-i18n="sort_name_asc">–ê ‚Üí –Ø</option>
                <option value="name_desc" data-i18n="sort_name_desc">–Ø ‚Üí –ê</option>
                <option value="category" data-i18n="sort_category">–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
            </select>
        </div>

        <!-- Category Filters -->
        <div class="flex flex-wrap gap-2 mb-6" id="categoryFilters">
            <div class="skeleton h-8 w-20"></div>
            <div class="skeleton h-8 w-24"></div>
            <div class="skeleton h-8 w-20"></div>
        </div>

        <!-- Products Table -->
        <div class="bg-base-100 rounded-xl shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="table w-full">
                    <thead>
                        <tr class="border-b border-base-200">
                            <th class="bg-base-100" data-i18n="col_name">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th class="bg-base-100 hidden sm:table-cell" data-i18n="col_category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th class="bg-base-100 w-24" data-i18n="col_unit">–ï–¥. –∏–∑–º.</th>
                            <th class="bg-base-100 w-20"></th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                        <!-- Skeleton rows -->
                        <tr><td colspan="4"><div class="skeleton h-6 w-full my-2"></div></td></tr>
                        <tr><td colspan="4"><div class="skeleton h-6 w-full my-2"></div></td></tr>
                        <tr><td colspan="4"><div class="skeleton h-6 w-full my-2"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <div id="footer-placeholder"></div>

    <!-- Add/Edit Modal -->
    <dialog id="editModal" class="modal">
        <div class="modal-box relative">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="editModal.close()">‚úï</button>
            <h3 class="font-bold text-lg mb-4" id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h3>
            <form id="editForm" class="space-y-4">
                <input type="hidden" name="id" />

                <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="col_category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span></label>
                    <select name="category_id" class="select select-bordered w-full" required id="categorySelect"></select>
                </div>

                <!-- –†—É—Å—Å–∫–∏–π –∏ English -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="col_russian">–†—É—Å—Å–∫–∏–π</span></label>
                        <input type="text" name="name_ru" class="input input-bordered w-full" required placeholder="–†–∏—Å" />
                    </div>
                    <div>
                        <label class="label">
                            <span class="label-text font-medium" data-i18n="col_english">English</span>
                            <button type="button" class="translate-btn" onclick="autoTranslate('name_ru', 'name_en', 'ru', 'en', this)">üåê Auto</button>
                        </label>
                        <input type="text" name="name_en" class="input input-bordered w-full" required placeholder="Rice" />
                    </div>
                </div>

                <!-- –•–∏–Ω–¥–∏ + –¢—Ä–∞–Ω—Å–ª–∏—Ç -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="label">
                            <span class="label-text font-medium" data-i18n="col_hindi">‡§π‡§ø‡§Ç‡§¶‡•Ä</span>
                            <button type="button" class="translate-btn" onclick="autoTranslate('name_ru', 'name_hi', 'ru', 'hi', this)">üåê Auto</button>
                        </label>
                        <input type="text" name="name_hi" id="hindiInput" class="input input-bordered w-full" required placeholder="‡§ö‡§æ‡§µ‡§≤" />
                    </div>
                    <div>
                        <label class="label"><span class="label-text font-medium">IAST</span></label>
                        <input type="text" name="translit" id="translitInput" class="input input-bordered w-full" placeholder="cƒÅval" />
                        <label class="label"><span class="label-text-alt opacity-60">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —Ö–∏–Ω–¥–∏</span></label>
                    </div>
                </div>

                <!-- –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è -->
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="col_unit">–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</span></label>
                    <select name="unit" class="select select-bordered w-full" required id="unitSelect"></select>
                </div>

                <!-- % –Ω–∞ –æ—á–∏—Å—Ç–∫—É (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–≤–æ—â–µ–π –∏ —Ñ—Ä—É–∫—Ç–æ–≤) -->
                <div id="wastePercentField" class="hidden">
                    <label class="label"><span class="label-text font-medium" data-i18n="waste_percent">% –Ω–∞ –æ—á–∏—Å—Ç–∫—É</span></label>
                    <div class="join w-full">
                        <input type="number" name="waste_percent" class="input input-bordered join-item w-full" min="0" max="99" step="1" placeholder="20" />
                        <span class="btn btn-disabled join-item">%</span>
                    </div>
                    <label class="label"><span class="label-text-alt opacity-60" data-i18n="waste_percent_hint">–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç—Ö–æ–¥–æ–≤ –ø—Ä–∏ —á–∏—Å—Ç–∫–µ</span></label>
                </div>

                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" onclick="editModal.close()" data-i18n="cancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary" data-i18n="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Confirm Modal -->
    <dialog id="confirmModal" class="modal">
        <div class="modal-box max-w-sm">
            <p id="confirmMessage" class="py-4 text-center text-lg"></p>
            <div class="modal-action justify-center gap-2">
                <button type="button" class="btn btn-ghost" onclick="confirmNo()" data-i18n="cancel">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-error" onclick="confirmYes()" data-i18n="delete">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <script src="js/layout.js"></script>
    <script>
        // ==================== STATE ====================
        let currentCategory = 'all';
        let searchQuery = '';
        let currentSort = 'name_asc';
        let products = [];
        let categories = [];
        let units = [];

        const t = key => Layout.t(key);
        const editForm = () => document.getElementById('editForm');

        // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ "% –Ω–∞ –æ—á–∏—Å—Ç–∫—É"
        const WASTE_CATEGORIES = ['vegetables', 'fruits'];

        // ==================== CONFIRM MODAL ====================
        let confirmResolve = null;

        function showConfirm(message, itemName = '') {
            return new Promise(resolve => {
                confirmResolve = resolve;
                const msgEl = Layout.$('#confirmMessage');
                if (itemName) {
                    msgEl.innerHTML = message + '<br><strong class="text-error">' + itemName + '</strong>';
                } else {
                    msgEl.textContent = message;
                }
                confirmModal.showModal();
            });
        }

        function confirmYes() {
            confirmModal.close();
            if (confirmResolve) confirmResolve(true);
            confirmResolve = null;
        }

        function confirmNo() {
            confirmModal.close();
            if (confirmResolve) confirmResolve(false);
            confirmResolve = null;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª–µ waste_percent –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function toggleWastePercentField(categoryId) {
            const field = Layout.$('#wastePercentField');
            if (!field) return;

            const category = categories.find(c => c.id === categoryId);
            const shouldShow = category && WASTE_CATEGORIES.includes(category.slug);

            field.classList.toggle('hidden', !shouldShow);

            // –ï—Å–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º, –æ—á–∏—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
            if (!shouldShow) {
                const input = Layout.$('input[name="waste_percent"]');
                if (input) input.value = '';
            }
        }

        // ==================== AUTO-TRANSLATE ====================
        async function autoTranslate(fromField, toField, fromLang, toLang, btn) {
            const fromEl = editForm()[fromField];
            const toEl = editForm()[toField];
            if (!fromEl || !toEl) return;

            const text = fromEl.value.trim();
            if (!text) {
                toEl.focus();
                return;
            }

            btn.classList.add('loading');
            btn.textContent = '...';

            try {
                const translated = await Layout.translate(text, fromLang, toLang);
                toEl.value = translated;
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–∞–Ω—Å–ª–∏—Ç –µ—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º –Ω–∞ —Ö–∏–Ω–¥–∏
                if (toField === 'name_hi') {
                    toEl.dispatchEvent(new Event('input'));
                }
            } catch (e) {
                console.error('Translation error:', e);
            }

            btn.classList.remove('loading');
            btn.textContent = 'üåê Auto';
        }

        const PRODUCT_FORMS = {
            ru: ['–ø—Ä–æ–¥—É–∫—Ç', '–ø—Ä–æ–¥—É–∫—Ç–∞', '–ø—Ä–æ–¥—É–∫—Ç–æ–≤'],
            en: ['product', 'products'],
            hi: '‡§â‡§§‡•ç‡§™‡§æ‡§¶'
        };

        // ==================== –¢–†–ê–ù–°–õ–ò–¢–ï–†–ê–¶–ò–Ø ====================
        function transliterate(hindi) {
            if (!hindi) return '';

            const CONSONANTS = {
                '‡§ï': 'k', '‡§ñ': 'kh', '‡§ó': 'g', '‡§ò': 'gh', '‡§ô': '·πÖ',
                '‡§ö': 'c', '‡§õ': 'ch', '‡§ú': 'j', '‡§ù': 'jh', '‡§û': '√±',
                '‡§ü': '·π≠', '‡§†': '·π≠h', '‡§°': '·∏ç', '‡§¢': '·∏çh', '‡§£': '·πá',
                '‡§§': 't', '‡§•': 'th', '‡§¶': 'd', '‡§ß': 'dh', '‡§®': 'n',
                '‡§™': 'p', '‡§´': 'ph', '‡§¨': 'b', '‡§≠': 'bh', '‡§Æ': 'm',
                '‡§Ø': 'y', '‡§∞': 'r', '‡§≤': 'l', '‡§µ': 'v',
                '‡§∂': '≈õ', '‡§∑': '·π£', '‡§∏': 's', '‡§π': 'h'
            };
            const VOWELS = { '‡§Ö': 'a', '‡§Ü': 'ƒÅ', '‡§á': 'i', '‡§à': 'ƒ´', '‡§â': 'u', '‡§ä': '≈´', '‡§ã': '·πõ', '‡§è': 'e', '‡§ê': 'ai', '‡§ì': 'o', '‡§î': 'au' };
            const MATRAS = { '‡§æ': 'ƒÅ', '‡§ø': 'i', '‡•Ä': 'ƒ´', '‡•Å': 'u', '‡•Ç': '≈´', '‡•É': '·πõ', '‡•á': 'e', '‡•à': 'ai', '‡•ã': 'o', '‡•å': 'au' };
            const NUKTA_MAP = { '‡§ï': 'q', '‡§ñ': 'kh', '‡§ó': 'ƒ°', '‡§ú': 'z', '‡§´': 'f', '‡§°': '·πõ', '‡§¢': '·πõh' };

            // –ê–Ω—É—Å–≤–∞—Ä–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–ª–µ–¥—É—é—â–µ–π —Å–æ–≥–ª–∞—Å–Ω–æ–π
            const ANUSVARA_MAP = {
                '‡§ï': '·πÖ', '‡§ñ': '·πÖ', '‡§ó': '·πÖ', '‡§ò': '·πÖ', '‡§ô': '·πÖ',  // –≤–µ–ª—è—Ä–Ω—ã–µ
                '‡§ö': '√±', '‡§õ': '√±', '‡§ú': '√±', '‡§ù': '√±', '‡§û': '√±',  // –ø–∞–ª–∞—Ç–∞–ª—å–Ω—ã–µ
                '‡§ü': '·πá', '‡§†': '·πá', '‡§°': '·πá', '‡§¢': '·πá', '‡§£': '·πá',  // —Ä–µ—Ç—Ä–æ—Ñ–ª–µ–∫—Å–Ω—ã–µ
                '‡§§': 'n', '‡§•': 'n', '‡§¶': 'n', '‡§ß': 'n', '‡§®': 'n',  // –¥–µ–Ω—Ç–∞–ª—å–Ω—ã–µ
                '‡§™': 'm', '‡§´': 'm', '‡§¨': 'm', '‡§≠': 'm', '‡§Æ': 'm'   // –ª–∞–±–∏–∞–ª—å–Ω—ã–µ
            };

            const text = hindi.normalize('NFC');
            let result = '';
            let i = 0;

            while (i < text.length) {
                const char = text[i];
                const next = text[i + 1];

                // –ù–µ–∑–∞–≤–∏—Å–∏–º–∞—è –≥–ª–∞—Å–Ω–∞—è
                if (VOWELS[char]) {
                    result += VOWELS[char];
                    i++;
                    continue;
                }

                // –°–æ–≥–ª–∞—Å–Ω–∞—è
                if (CONSONANTS[char]) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∫—Ç—É
                    if (next === '‡§º') {
                        result += NUKTA_MAP[char] || CONSONANTS[char];
                        i += 2;
                    } else {
                        result += CONSONANTS[char];
                        i++;
                    }

                    // –ß—Ç–æ –ø–æ—Å–ª–µ —Å–æ–≥–ª–∞—Å–Ω–æ–π?
                    const after = text[i];
                    if (after === '‡•ç') {
                        // –í–∏—Ä–∞–º–∞ ‚Äî –±–µ–∑ 'a'
                        i++;
                    } else if (MATRAS[after]) {
                        // –ú–∞—Ç—Ä–∞
                        result += MATRAS[after];
                        i++;
                    } else if (after === '‡§Ç') {
                        // –ê–Ω—É—Å–≤–∞—Ä–∞ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º 'a', –ø–æ—Ç–æ–º –æ–±—Ä–∞–±–æ—Ç–∞–µ–º –∞–Ω—É—Å–≤–∞—Ä—É
                        result += 'a';
                    } else if (after === '‡§É') {
                        result += 'a·∏•';
                        i++;
                    } else if (after === '‡§Å') {
                        result += 'amÃê';
                        i++;
                    } else if (!CONSONANTS[after] && !VOWELS[after] && after !== undefined) {
                        // –°–ª–µ–¥—É—é—â–∏–π —Å–∏–º–≤–æ–ª –Ω–µ –¥–µ–≤–∞–Ω–∞–≥–∞—Ä–∏ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º 'a'
                        result += 'a';
                    } else if (after === undefined) {
                        // –ö–æ–Ω–µ—Ü —Å–ª–æ–≤–∞ ‚Äî –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º 'a' (schwa deletion –≤ —Ö–∏–Ω–¥–∏)
                    } else {
                        // –ü–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π —Å–æ–≥–ª–∞—Å–Ω–æ–π/–≥–ª–∞—Å–Ω–æ–π ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º 'a'
                        result += 'a';
                    }
                    continue;
                }

                // –ê–Ω—É—Å–≤–∞—Ä–∞
                if (char === '‡§Ç') {
                    const nextCons = text[i + 1];
                    result += ANUSVARA_MAP[nextCons] || '·πÉ';
                    i++;
                    continue;
                }

                // –í–∏—Å–∞—Ä–≥–∞
                if (char === '‡§É') {
                    result += '·∏•';
                    i++;
                    continue;
                }

                // –ß–∞–Ω–¥—Ä–∞–±–∏–Ω–¥—É
                if (char === '‡§Å') {
                    result += 'mÃê';
                    i++;
                    continue;
                }

                // –ú–∞—Ç—Ä–∞ –æ—Ç–¥–µ–ª—å–Ω–æ (—Ä–µ–¥–∫–æ)
                if (MATRAS[char]) {
                    result += MATRAS[char];
                    i++;
                    continue;
                }

                // –í–∏—Ä–∞–º–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
                if (char === '‡•ç') {
                    i++;
                    continue;
                }

                // –ù—É–∫—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
                if (char === '‡§º') {
                    i++;
                    continue;
                }

                // –û—Å—Ç–∞–ª—å–Ω–æ–µ (–ø—Ä–æ–±–µ–ª—ã, —Ü–∏—Ñ—Ä—ã)
                result += char;
                i++;
            }
            return result;
        }

        // ==================== DATA LOADING ====================
        async function loadCategories() {
            const { data, error } = await Layout.db.from('product_categories').select('*').order('sort_order');
            if (error) { console.error('Error loading categories:', error); return; }
            categories = data;
            renderCategoryFilters();
            renderCategorySelect();
        }

        async function loadUnits() {
            const { data, error } = await Layout.db.from('units').select('*').order('sort_order');
            if (error) { console.error('Error loading units:', error); return; }
            units = data;
            renderUnitSelect();
        }

        async function loadProducts() {
            const { data, error } = await Layout.db
                .from('products')
                .select('*, product_categories(slug, name_ru, name_en, name_hi)')
                .order('name_ru');
            if (error) { console.error('Error loading products:', error); return; }
            products = data;
            renderProducts();
        }

        // ==================== SORTING ====================
        function sortProducts(items) {
            const lang = Layout.currentLang;
            const nameKey = `name_${lang}`;

            return [...items].sort((a, b) => {
                switch (currentSort) {
                    case 'name_asc':
                        return (a[nameKey] || a.name_ru || '').localeCompare(b[nameKey] || b.name_ru || '', lang);
                    case 'name_desc':
                        return (b[nameKey] || b.name_ru || '').localeCompare(a[nameKey] || a.name_ru || '', lang);
                    case 'category':
                        const catA = a.product_categories ? Layout.getName(a.product_categories) : '';
                        const catB = b.product_categories ? Layout.getName(b.product_categories) : '';
                        const catCompare = catA.localeCompare(catB, lang);
                        if (catCompare !== 0) return catCompare;
                        // Within same category, sort by name
                        return (a[nameKey] || a.name_ru || '').localeCompare(b[nameKey] || b.name_ru || '', lang);
                    default:
                        return 0;
                }
            });
        }

        // ==================== RENDERING ====================
        function renderCategoryFilters() {
            const container = Layout.$('#categoryFilters');
            const counts = { all: products.length };
            products.forEach(p => {
                const slug = p.product_categories?.slug;
                if (slug) counts[slug] = (counts[slug] || 0) + 1;
            });

            let html = `<button class="btn btn-sm filter-btn ${currentCategory === 'all' ? 'active btn-neutral' : 'btn-ghost'}" data-category="all">${t('all')}<sup class="ml-1 opacity-60">${counts.all}</sup></button>`;

            categories.forEach(cat => {
                const isActive = currentCategory === cat.slug;
                html += `<button class="btn btn-sm filter-btn ${isActive ? 'active btn-neutral' : 'btn-ghost'}" data-category="${cat.slug}">${Layout.getName(cat)}<sup class="ml-1 opacity-60">${counts[cat.slug] || 0}</sup></button>`;
            });

            container.innerHTML = html;
            container.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentCategory = btn.dataset.category;
                    renderCategoryFilters();
                    renderProducts();
                });
            });
        }

        function renderCategorySelect() {
            const select = Layout.$('#categorySelect');
            select.innerHTML = categories.map(cat =>
                `<option value="${cat.id}">${Layout.getName(cat)}</option>`
            ).join('');
        }

        function renderUnitSelect() {
            const select = Layout.$('#unitSelect');
            select.innerHTML = units.map(u =>
                `<option value="${u.code}">${Layout.getName(u)} (${u['short_' + Layout.currentLang] || u.short_ru})</option>`
            ).join('');
        }

        function renderProducts() {
            const tbody = Layout.$('#productsTable');
            const countEl = Layout.$('#productsCount');
            const lang = Layout.currentLang;

            let filtered = products.filter(product => {
                const matchesCategory = currentCategory === 'all' || product.product_categories?.slug === currentCategory;
                const matchesSearch = searchQuery === '' ||
                    product.name_ru?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    product.name_en?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    product.name_hi?.includes(searchQuery);
                return matchesCategory && matchesSearch;
            });

            // Apply sorting
            filtered = sortProducts(filtered);

            countEl.textContent = Layout.pluralize(filtered.length, PRODUCT_FORMS);

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-12 opacity-50">
                    <div class="text-4xl mb-2">üì¶</div>
                    <div>${t('no_products') || '–ü—Ä–æ–¥—É–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'}</div>
                </td></tr>`;
                return;
            }

            tbody.innerHTML = filtered.map(product => {
                const cat = product.product_categories;
                const unit = units.find(u => u.code === product.unit);
                const unitShort = unit ? (unit['short_' + lang] || unit.short_ru) : product.unit;

                // –°–æ–±–∏—Ä–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —è–∑—ã–∫–∏ (–≤—Å–µ –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ)
                const otherNames = [];
                if (lang !== 'ru' && product.name_ru) otherNames.push(product.name_ru);
                if (lang !== 'en' && product.name_en) otherNames.push(product.name_en);
                if (lang !== 'hi' && product.name_hi) {
                    otherNames.push(product.name_hi + (product.translit ? ' ¬∑ ' + product.translit : ''));
                }

                return `
                    <tr class="product-row border-b border-base-200" data-id="${product.id}">
                        <td>
                            <div class="flex flex-col desktop:flex-row desktop:items-baseline desktop:gap-4">
                                <div class="font-medium">${Layout.getName(product)}</div>
                                ${otherNames.map(name => `<div class="text-xs desktop:text-base opacity-50">${name}</div>`).join('')}
                            </div>
                        </td>
                        <td class="hidden sm:table-cell">
                            <span class="badge badge-ghost">${Layout.getName(cat) || '‚Äî'}</span>
                        </td>
                        <td>
                            <div class="flex items-center gap-2">
                                <span>${unitShort}</span>
                                ${product.waste_percent ? `<span class="badge badge-ghost badge-sm" title="${t('waste_percent')}">${product.waste_percent}%</span>` : ''}
                            </div>
                        </td>
                        <td>
                            <div class="flex gap-1">
                                <button class="btn btn-ghost btn-sm btn-square" onclick="openEditModal('${product.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                                <button class="btn btn-ghost btn-sm btn-square text-error" onclick="deleteProduct('${product.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ==================== MODAL ====================
        function openAddModal() {
            Layout.$('#modalTitle').textContent = t('add_product');
            Layout.$('#editForm').reset();
            Layout.$('input[name="id"]').value = '';
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const categorySelect = Layout.$('#categorySelect');
            if (categorySelect && categorySelect.value) {
                toggleWastePercentField(categorySelect.value);
            } else {
                Layout.$('#wastePercentField')?.classList.add('hidden');
            }
            editModal.showModal();
        }

        function openEditModal(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            Layout.$('#modalTitle').textContent = t('edit') + ' ‚Äî ' + Layout.getName(product);
            Layout.$('input[name="id"]').value = id;
            Layout.$('select[name="category_id"]').value = product.category_id || '';
            Layout.$('input[name="name_ru"]').value = product.name_ru || '';
            Layout.$('input[name="name_en"]').value = product.name_en || '';
            Layout.$('input[name="name_hi"]').value = product.name_hi || '';
            Layout.$('input[name="translit"]').value = product.translit || '';
            Layout.$('select[name="unit"]').value = product.unit || '';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ waste_percent
            toggleWastePercentField(product.category_id);
            Layout.$('input[name="waste_percent"]').value = product.waste_percent || '';

            editModal.showModal();
        }

        // ==================== CRUD ====================
        async function saveProduct(formData) {
            const id = formData.get('id');
            const isNew = !id;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å waste_percent
            const categoryId = formData.get('category_id');
            const category = categories.find(c => c.id === categoryId);
            const wastePercentValue = formData.get('waste_percent');
            const shouldSaveWaste = category && WASTE_CATEGORIES.includes(category.slug);

            const productData = {
                category_id: categoryId,
                name_ru: formData.get('name_ru'),
                name_en: formData.get('name_en'),
                name_hi: formData.get('name_hi'),
                translit: formData.get('translit') || null,
                unit: formData.get('unit'),
                waste_percent: shouldSaveWaste && wastePercentValue ? parseFloat(wastePercentValue) : null
            };

            let error;
            if (isNew) {
                const result = await Layout.db.from('products').insert(productData).select('*, product_categories(slug, name_ru, name_en, name_hi)');
                error = result.error;
                if (!error && result.data?.[0]) {
                    products.push(result.data[0]);
                }
            } else {
                const result = await Layout.db.from('products').update(productData).eq('id', id);
                error = result.error;
                if (!error) {
                    const idx = products.findIndex(p => p.id === id);
                    if (idx !== -1) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ, –≤–∫–ª—é—á–∞—è —Å–≤—è–∑–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                        const cat = categories.find(c => c.id === productData.category_id);
                        products[idx] = {
                            ...products[idx],
                            ...productData,
                            waste_percent: productData.waste_percent,
                            product_categories: cat ? { slug: cat.slug, name_ru: cat.name_ru, name_en: cat.name_en, name_hi: cat.name_hi } : null
                        };
                    }
                }
            }

            if (error) {
                alert(t('error') + ': ' + error.message);
                return false;
            }

            renderCategoryFilters();
            renderProducts();
            return true;
        }

        async function deleteProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            const confirmed = await showConfirm(t('confirm_delete'), Layout.getName(product));
            if (!confirmed) return;

            const { error } = await Layout.db.from('products').delete().eq('id', id);
            if (error) {
                alert(t('error') + ': ' + error.message);
                return;
            }

            products = products.filter(p => p.id !== id);
            renderCategoryFilters();
            renderProducts();
        }

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = Layout.$('#searchInput');
            const clearBtn = Layout.$('#clearSearch');
            const debouncedSearch = Layout.debounce(() => renderProducts(), 200);

            searchInput?.addEventListener('input', e => {
                searchQuery = e.target.value;
                clearBtn?.classList.toggle('hidden', !e.target.value);
                debouncedSearch();
            });

            clearBtn?.addEventListener('click', () => {
                searchInput.value = '';
                searchQuery = '';
                clearBtn.classList.add('hidden');
                renderProducts();
                searchInput.focus();
            });

            // Sort select
            Layout.$('#sortSelect')?.addEventListener('change', e => {
                currentSort = e.target.value;
                renderProducts();
            });

            Layout.$('#editForm')?.addEventListener('submit', async e => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const success = await saveProduct(formData);
                if (success) editModal.close();
            });

            // –ê–≤—Ç–æ—Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è —Ö–∏–Ω–¥–∏ ‚Üí IAST
            Layout.$('#hindiInput')?.addEventListener('input', e => {
                const translitInput = Layout.$('#translitInput');
                if (translitInput) {
                    translitInput.value = transliterate(e.target.value);
                }
            });

            // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –ø–æ–ª—è waste_percent –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            Layout.$('#categorySelect')?.addEventListener('change', e => {
                toggleWastePercentField(e.target.value);
            });
        });

        // ==================== LANGUAGE UPDATE ====================
        function renderSortSelect() {
            const select = Layout.$('#sortSelect');
            const options = [
                { value: 'name_asc', key: 'sort_name_asc', fallback: '–ê ‚Üí –Ø' },
                { value: 'name_desc', key: 'sort_name_desc', fallback: '–Ø ‚Üí –ê' },
                { value: 'category', key: 'sort_category', fallback: '–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏' }
            ];
            select.innerHTML = options.map(opt => {
                const translated = t(opt.key);
                const label = translated !== opt.key ? translated : opt.fallback;
                return `<option value="${opt.value}" ${currentSort === opt.value ? 'selected' : ''}>${label}</option>`;
            }).join('');
        }

        function updatePageUI() {
            Layout.updateAllTranslations();
            renderCategoryFilters();
            renderCategorySelect();
            renderUnitSelect();
            renderSortSelect();
            renderProducts();
        }

        window.onLanguageChange = () => updatePageUI();

        // ==================== INIT ====================
        async function init() {
            await Layout.init({ menuId: 'kitchen', itemId: 'products' });
            await Promise.all([loadCategories(), loadUnits()]);
            await loadProducts();
            updatePageUI();
        }

        init();
    </script>
</body>
</html>
