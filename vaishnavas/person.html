<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script src="../js/color-init.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вайшнав — ШРСК</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <!-- Cropper.js для редактирования фото -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css">
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>
    <style>
        .person-avatar-lg {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--current-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 3rem;
            flex-shrink: 0;
        }
        .avatar-wrapper {
            position: relative;
            width: 120px;
            height: 120px;
            flex-shrink: 0;
        }
        .avatar-wrapper img {
            cursor: pointer;
        }
        .edit-mode .avatar-wrapper {
            cursor: pointer;
        }
        .edit-mode .avatar-wrapper:hover .avatar-overlay {
            opacity: 1;
        }
        .avatar-overlay {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .avatar-overlay svg {
            width: 32px;
            height: 32px;
            color: white;
        }
        .avatar-uploading .avatar-overlay {
            opacity: 1;
        }
        .cropper-container {
            max-height: 400px;
        }
        .crop-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid var(--current-color);
        }
        .info-label {
            font-size: 0.75rem;
            opacity: 0.6;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }
        .info-value {
            font-weight: 500;
        }
        /* Editable fields */
        .editable-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid transparent;
            padding: 0.25rem 0;
            width: 100%;
            font-weight: 500;
            transition: border-color 0.2s;
        }
        .editable-input:hover {
            border-bottom-color: var(--current-color);
        }
        .editable-input:focus {
            outline: none;
            border-bottom-color: var(--current-color);
            background: rgba(139, 92, 246, 0.05);
        }
        .editable-input::placeholder {
            color: #999;
            font-weight: 400;
        }
        .editable-select {
            background: transparent;
            border: none;
            border-bottom: 1px solid transparent;
            padding: 0.25rem 0;
            font-weight: 500;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .editable-select:hover, .editable-select:focus {
            border-bottom-color: var(--current-color);
            outline: none;
        }
        .editable-textarea {
            background: transparent;
            border: 1px solid transparent;
            border-radius: 0.375rem;
            padding: 0.5rem;
            width: 100%;
            min-height: 80px;
            resize: vertical;
            font-size: 0.875rem;
            transition: border-color 0.2s, background 0.2s;
        }
        .editable-textarea:hover {
            border-color: #ddd;
        }
        .editable-textarea:focus {
            outline: none;
            border-color: var(--current-color);
            background: rgba(139, 92, 246, 0.05);
        }
        .name-input {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .spiritual-name-input {
            font-size: 1.125rem;
            opacity: 0.6;
        }
        /* View/Edit modes */
        .view-mode .edit-only { display: none !important; }
        .edit-mode .view-only { display: none !important; }
        .edit-mode .editable-input,
        .edit-mode .editable-select,
        .edit-mode .editable-textarea {
            background: rgba(139, 92, 246, 0.03);
            border-bottom-color: #ddd;
        }
        .view-mode .editable-input,
        .view-mode .editable-select {
            pointer-events: none;
        }
        .view-mode .editable-textarea {
            pointer-events: none;
            resize: none;
        }
        /* Section cards */
        .section-card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1rem;
        }
        .stay-card {
            border-left: 4px solid var(--current-color);
        }
        .stay-current {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }
        .stay-future {
            border-left-color: #6366f1;
        }
        .stay-past {
            border-left-color: #d1d5db;
            opacity: 0.7;
        }
        .retreat-card {
            border-left: 4px solid var(--current-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .retreat-card:hover {
            background-color: rgba(0,0,0,0.02);
        }
        .retreat-card .details {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        .retreat-card.expanded .details {
            display: block;
        }
        .retreat-card .chevron {
            transition: transform 0.2s;
        }
        .retreat-card.expanded .chevron {
            transform: rotate(180deg);
        }
        .detail-section {
            margin-bottom: 12px;
        }
        .detail-section:last-child {
            margin-bottom: 0;
        }
        .detail-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.5;
            margin-bottom: 4px;
        }
        .status-guest { color: #10b981; }
        .status-cancelled { color: #ef4444; }
        .status-team { color: #8b5cf6; }

        /* Status dropdown styles */
        select.status-guest { background: #d1fae5; color: #065f46; border-color: #6ee7b7; }
        select.status-team { background: #dbeafe; color: #1e40af; border-color: #93c5fd; }
        select.status-cancelled { background: #fee2e2; color: #991b1b; border-color: #fca5a5; }
        select.status-guest, select.status-team, select.status-cancelled {
            font-weight: 500;
            font-size: 0.75rem;
            height: 1.75rem;
            min-height: 1.75rem;
            padding-top: 0;
            padding-bottom: 0;
            padding-left: 0.5rem;
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 flex-1">

        <!-- Breadcrumb -->
        <div class="text-sm breadcrumbs mb-4">
            <ul>
                <li><a href="index.html" data-i18n="nav_vaishnavas">Вайшнавы</a></li>
                <li id="breadcrumbName">—</li>
            </ul>
        </div>

        <!-- Profile Container (view/edit mode) -->
        <div id="profileContainer" class="view-mode">

        <!-- Person Header -->
        <div id="personCard" class="bg-base-100 rounded-lg shadow-sm p-6 mb-6">
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Avatar -->
                <div class="flex justify-center md:justify-start items-start gap-2">
                    <div class="avatar-wrapper" id="avatarWrapper" onclick="onAvatarClick()">
                        <div id="personAvatar" class="person-avatar-lg">?</div>
                        <div class="avatar-overlay edit-only" id="avatarOverlay">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </div>
                    </div>
                    <!-- Кнопка удаления фото -->
                    <button type="button" id="deletePhotoBtn" class="btn btn-ghost btn-sm btn-circle edit-only hidden" onclick="deletePhoto()" title="Удалить фото">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-error" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                    <input type="file" id="photoInput" accept="image/*" class="hidden" onchange="uploadPhoto(this)">
                </div>

                <!-- Info -->
                <div class="flex-1">
                    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                        <div class="flex-1">
                            <!-- View mode -->
                            <div class="view-only">
                                <h1 class="text-2xl font-bold" id="viewName">—</h1>
                                <p class="text-lg opacity-60" id="viewSecondaryName"></p>
                            </div>
                            <!-- Edit mode -->
                            <div class="edit-only">
                                <div class="flex gap-2 items-baseline">
                                    <input type="text" id="editFirstName" class="editable-input name-input" data-i18n-placeholder="first_name" placeholder="Имя">
                                    <input type="text" id="editLastName" class="editable-input name-input" data-i18n-placeholder="last_name" placeholder="Фамилия">
                                </div>
                                <input type="text" id="editSpiritualName" class="editable-input spiritual-name-input mt-1" data-i18n-placeholder="spiritual_name" placeholder="Духовное имя">
                            </div>
                            <!-- Badges -->
                            <div class="flex flex-wrap gap-2 mt-2" id="personBadges"></div>
                        </div>
                        <div class="flex gap-2">
                            <!-- View mode buttons -->
                            <button class="btn btn-sm gap-2 view-only" style="background: #147D30; border-color: #147D30;" onclick="openGuestPortal()">
                                <span style="color: #FFBA47; font-weight: 500;">Общедоступный профиль</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" style="color: #FFBA47;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                            </button>
                            <button id="editPersonBtn" class="btn btn-outline btn-sm gap-2 view-only" onclick="enterEditMode()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                                <span data-i18n="edit">Редактировать</span>
                            </button>
                            <!-- Edit mode buttons -->
                            <button class="btn btn-ghost btn-sm edit-only" onclick="cancelEdit()" data-i18n="cancel">Отмена</button>
                            <button class="btn btn-primary btn-sm edit-only gap-2" onclick="savePerson()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                <span data-i18n="save">Сохранить</span>
                            </button>
                            <button id="deletePersonBtn" class="btn btn-error btn-outline btn-sm gap-2 view-only" onclick="deletePerson()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                <span data-i18n="delete">Удалить</span>
                            </button>
                        </div>
                    </div>

                    <!-- Contact info -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                        <div>
                            <div class="info-label" data-i18n="phone">Телефон</div>
                            <div class="view-only info-value" id="viewPhone">—</div>
                            <div class="edit-only flex items-center gap-2">
                                <input type="tel" id="editPhone" class="editable-input flex-1" placeholder="+7...">
                                <label class="flex items-center gap-1 cursor-pointer">
                                    <input type="checkbox" id="editHasWhatsapp" class="checkbox checkbox-xs checkbox-success">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                                </label>
                            </div>
                        </div>
                        <div>
                            <div class="info-label" data-i18n="email">Email</div>
                            <div class="view-only info-value" id="viewEmail">—</div>
                            <input type="email" id="editEmail" class="editable-input edit-only" placeholder="email@example.com">
                        </div>
                        <div>
                            <div class="info-label" data-i18n="telegram">Telegram</div>
                            <div class="view-only info-value" id="viewTelegram">—</div>
                            <input type="text" id="editTelegram" class="editable-input edit-only" placeholder="@username">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <div class="info-label" data-i18n="country">Страна</div>
                                <div class="view-only info-value" id="viewCountry">—</div>
                                <input type="text" id="editCountry" class="editable-input edit-only" list="countriesList">
                                <datalist id="countriesList"></datalist>
                            </div>
                            <div>
                                <div class="info-label" data-i18n="city">Город</div>
                                <div class="view-only info-value" id="viewCity">—</div>
                                <input type="text" id="editCity" class="editable-input edit-only">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Two columns layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">

            <!-- Left column: Details -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Personal Info -->
                <div class="section-card">
                    <h3 class="font-semibold mb-4" data-i18n="personal_info">Личная информация</h3>
                    <div class="space-y-3">
                        <div>
                            <div class="info-label" data-i18n="gender">Пол</div>
                            <div class="view-only info-value" id="viewGender">—</div>
                            <select id="editGender" class="editable-select w-full edit-only">
                                <option value="" data-i18n="not_specified">Не указан</option>
                                <option value="male" data-i18n="male">Мужской</option>
                                <option value="female" data-i18n="female">Женский</option>
                            </select>
                        </div>
                        <div>
                            <div class="info-label" data-i18n="birth_date">Дата рождения</div>
                            <div class="view-only info-value" id="viewBirthDate">—</div>
                            <input type="date" id="editBirthDate" class="editable-input edit-only">
                        </div>
                        <div>
                            <div class="info-label" data-i18n="spiritual_teacher">Духовный учитель</div>
                            <div class="view-only info-value" id="viewSpiritualTeacher">—</div>
                            <div class="relative edit-only">
                                <input type="text" id="editSpiritualTeacher" class="editable-input w-full"
                                       autocomplete="off"
                                       oninput="searchSpiritualTeachers(this.value)"
                                       onfocus="showSpiritualTeacherSuggestions()">
                                <div id="spiritualTeacherSuggestions" class="hidden absolute z-50 w-full bg-base-100 shadow-lg rounded-lg mt-1 max-h-32 overflow-y-auto border text-sm"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Team Section (only for team members) -->
                <div class="section-card" id="teamSection">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold" data-i18n="team_info">Член команды</h3>
                        <label class="flex items-center gap-2 cursor-pointer edit-only">
                            <input type="checkbox" id="editIsTeamMember" class="checkbox checkbox-sm checkbox-primary" onchange="toggleTeamFields()">
                        </label>
                        <span class="badge badge-primary view-only" id="teamBadgeView"></span>
                    </div>
                    <div id="teamFields" class="space-y-3">
                        <div>
                            <div class="info-label" data-i18n="department">Департамент</div>
                            <div class="view-only info-value" id="viewDepartment">—</div>
                            <select id="editDepartment" class="editable-select w-full edit-only">
                                <option value="">—</option>
                            </select>
                        </div>
                        <div>
                            <div class="info-label" data-i18n="service">Служение</div>
                            <div class="view-only info-value" id="viewService">—</div>
                            <input type="text" id="editService" class="editable-input edit-only">
                        </div>
                        <div>
                            <div class="info-label" data-i18n="senior">Старший</div>
                            <div class="view-only info-value" id="viewSenior">—</div>
                            <select id="editSenior" class="editable-select w-full edit-only">
                                <option value="">—</option>
                            </select>
                        </div>
                        <div>
                            <div class="info-label" data-i18n="passport">Паспорт</div>
                            <div class="view-only info-value" id="viewPassport">—</div>
                            <input type="text" id="editPassport" class="editable-input edit-only">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <div class="info-label" data-i18n="visa_type">Тип визы</div>
                                <div class="view-only info-value" id="viewVisaType">—</div>
                                <select id="editVisaType" class="editable-select w-full edit-only">
                                    <option value="">—</option>
                                    <option value="tourist">Туристическая</option>
                                    <option value="business">Бизнес</option>
                                    <option value="volunteer">Волонтёрская</option>
                                    <option value="religious">Религиозная</option>
                                    <option value="other">Другая</option>
                                </select>
                            </div>
                            <div>
                                <div class="info-label" data-i18n="visa_expiry">Виза до</div>
                                <div class="view-only info-value" id="viewVisaExpiry">—</div>
                                <input type="date" id="editVisaExpiry" class="editable-input edit-only">
                            </div>
                        </div>
                        <div>
                            <div class="info-label" data-i18n="indian_phone">Индийский телефон</div>
                            <div class="view-only info-value">
                                <span id="viewIndianPhone">—</span>
                                <span id="viewIndianPhoneWhatsapp" class="badge badge-sm badge-success ml-2 hidden">WhatsApp</span>
                            </div>
                            <div class="flex items-center gap-2 edit-only">
                                <span class="text-sm opacity-60">+91</span>
                                <input type="tel" id="editIndianPhone" class="editable-input flex-1" placeholder="98765 43210">
                                <label class="flex items-center gap-1 cursor-pointer whitespace-nowrap">
                                    <input type="checkbox" id="editIndianPhoneWhatsapp" class="checkbox checkbox-xs checkbox-success">
                                    <span class="text-xs">WhatsApp</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div class="section-card">
                    <h3 class="font-semibold mb-4" data-i18n="notes">Заметки</h3>
                    <div class="space-y-3">
                        <div id="indiaExperienceField">
                            <div class="info-label" data-i18n="india_experience">Опыт поездок в Индию</div>
                            <div class="view-only info-value" id="viewIndiaExperience">—</div>
                            <input type="text" id="editIndiaExperience" class="editable-input edit-only">
                        </div>
                        <div>
                            <div class="view-only text-sm opacity-70" id="viewNotes">—</div>
                            <textarea id="editNotes" class="editable-textarea edit-only" data-i18n-placeholder="notes_placeholder" placeholder="Заметки..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right column: History -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Retreat Registrations -->
                <div class="section-card" id="retreatsSection">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold" data-i18n="retreat_history">История ретритов</h3>
                        <div class="flex items-center gap-2">
                            <button class="btn btn-sm btn-outline gap-1" onclick="openAddRetreatModal()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                <span data-i18n="add">Добавить</span>
                            </button>
                            <span class="badge badge-lg" id="retreatsCount">0</span>
                        </div>
                    </div>
                    <div id="registrationsList" class="space-y-3"></div>
                    <div id="emptyRegistrations" class="hidden text-center py-6 opacity-60">
                        <p data-i18n="no_retreat_registrations">Нет регистраций на ретриты</p>
                    </div>
                </div>

                <!-- Children Section -->
                <div class="section-card" id="childrenSection">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold" data-i18n="children">Дети</h3>
                        <div class="flex items-center gap-2">
                            <button class="btn btn-sm btn-outline gap-1" data-action="open-add-child-modal">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                <span data-i18n="add">Добавить</span>
                            </button>
                            <span class="badge badge-lg" id="childrenCount">0</span>
                        </div>
                    </div>
                    <div id="childrenList" class="space-y-3"></div>
                    <div id="emptyChildren" class="hidden text-center py-6 opacity-60">
                        <p data-i18n="no_children">Нет привязанных детей</p>
                    </div>
                </div>

                <!-- Parent Link (shown when person has parent_id) -->
                <div class="section-card hidden" id="parentSection">
                    <div class="flex items-center gap-2">
                        <span class="text-sm opacity-60" data-i18n="parent">Родитель:</span>
                        <a id="parentLink" href="#" class="link link-primary font-medium"></a>
                    </div>
                    <button class="btn btn-sm btn-warning mt-3 gap-1" id="makeIndependentBtn" data-action="make-independent">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                        </svg>
                        <span data-i18n="make_independent">Сделать самостоятельным</span>
                    </button>
                </div>

                <!-- Team Stays (only for team members) -->
                <div class="section-card" id="staysSection">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold" data-i18n="stays_history">Периоды пребывания</h3>
                        <button class="btn btn-sm btn-outline gap-1" onclick="openStayModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            <span data-i18n="add">Добавить</span>
                        </button>
                    </div>
                    <div id="staysList" class="space-y-3"></div>
                    <div id="emptyStays" class="hidden text-center py-6 opacity-60">
                        <p data-i18n="no_stays">Нет запланированных периодов</p>
                    </div>
                </div>
            </div>

        </div>

        </div><!-- /profileContainer -->

    </main>

    <!-- Photo Crop Modal -->
    <dialog id="cropModal" class="modal">
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-lg mb-4" data-i18n="edit_photo">Редактирование фото</h3>
            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex-1">
                    <div class="bg-base-200 rounded-lg overflow-hidden" style="height: 300px;">
                        <img id="cropImage" src="" alt="" style="max-width: 100%; display: block;">
                    </div>
                    <div class="flex items-center justify-center gap-4 mt-4">
                        <button type="button" class="btn btn-sm btn-circle" onclick="cropper?.zoom(-0.1)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
                        </button>
                        <input type="range" id="zoomRange" min="0.1" max="3" step="0.1" value="1" class="range range-sm range-primary w-32" oninput="handleZoomRange(this.value)">
                        <button type="button" class="btn btn-sm btn-circle" onclick="cropper?.zoom(0.1)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                        </button>
                        <button type="button" class="btn btn-sm btn-circle" onclick="cropper?.rotate(-90)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                        </button>
                    </div>
                </div>
                <div class="flex flex-col items-center gap-2">
                    <div class="text-sm opacity-60" data-i18n="preview">Предпросмотр</div>
                    <div class="crop-preview" id="cropPreview"></div>
                </div>
            </div>
            <div class="modal-action">
                <button type="button" class="btn" onclick="closeCropModal()" data-i18n="cancel">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveCroppedPhoto()" data-i18n="save">Сохранить</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Stay Modal -->
    <dialog id="stayModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4" id="stayModalTitle" data-i18n="add_stay">Добавить период</h3>
            <form id="stayForm" onsubmit="saveStay(event)">
                <input type="hidden" name="stay_id" value="">

                <!-- Постоянное пребывание -->
                <div class="form-control mb-4">
                    <label class="label cursor-pointer justify-start gap-3">
                        <input type="checkbox" id="isPermanentStay" class="checkbox checkbox-success" onchange="togglePermanentStay(this.checked)">
                        <span class="label-text font-medium">Находится в ШРСК постоянно</span>
                    </label>
                </div>

                <div id="datesContainer">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="form-control">
                            <label class="label"><span class="label-text font-medium" data-i18n="arrival">Приезд</span></label>
                            <input type="date" name="start_date" id="stayStartDate" class="input input-bordered" required>
                        </div>
                        <div class="form-control">
                            <label class="label"><span class="label-text font-medium" data-i18n="departure">Отъезд</span></label>
                            <input type="date" name="end_date" id="stayEndDate" class="input input-bordered" required>
                        </div>
                    </div>
                </div>

                <!-- Ранний заезд / Поздний выезд -->
                <div class="flex gap-4 mb-4">
                    <label class="label cursor-pointer gap-2">
                        <input type="checkbox" name="early_checkin" class="checkbox checkbox-sm checkbox-primary" />
                        <span class="label-text text-sm">Ранний заезд</span>
                    </label>
                    <label class="label cursor-pointer gap-2">
                        <input type="checkbox" name="late_checkout" class="checkbox checkbox-sm checkbox-primary" />
                        <span class="label-text text-sm">Поздний выезд</span>
                    </label>
                </div>

                <div class="form-control mb-4">
                    <label class="label"><span class="label-text" data-i18n="comment">Комментарий</span></label>
                    <input type="text" name="comment" class="input input-bordered" placeholder="Например: Картика">
                </div>
                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" onclick="closeStayModal()" data-i18n="cancel">Отмена</button>
                    <button type="button" class="btn btn-error btn-outline edit-stay-only hidden" onclick="deleteStay()" data-i18n="delete">Удалить</button>
                    <button type="submit" class="btn btn-primary" data-i18n="save">Сохранить</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Add to Retreat Modal -->
    <dialog id="addRetreatModal" class="modal">
        <div class="modal-box">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeAddRetreatModal()">✕</button>
            <h3 class="font-bold text-lg mb-4" data-i18n="add_to_retreat">Добавить на ретрит</h3>
            <form id="addRetreatForm" onsubmit="saveRetreatRegistration(event)">
                <div class="form-control mb-4">
                    <label class="label"><span class="label-text font-medium" data-i18n="retreat">Ретрит</span></label>
                    <select id="retreatSelect" class="select select-bordered w-full" required>
                        <option value="" data-i18n="select_retreat">Выберите ретрит...</option>
                    </select>
                </div>
                <div class="form-control mb-4">
                    <label class="label"><span class="label-text font-medium" data-i18n="status">Статус</span></label>
                    <select id="retreatStatusSelect" class="select select-bordered w-full" required>
                        <option value="guest">Гость</option>
                        <option value="team">Команда</option>
                    </select>
                </div>
                <div class="form-control mb-4">
                    <label class="label"><span class="label-text" data-i18n="notes">Заметки</span></label>
                    <textarea id="retreatOrgNotes" class="textarea textarea-bordered" rows="2" placeholder="Организационные заметки..."></textarea>
                </div>
                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" onclick="closeAddRetreatModal()" data-i18n="cancel">Отмена</button>
                    <button type="submit" class="btn btn-primary" data-i18n="save">Сохранить</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Placement Modal -->
    <dialog id="placementModal" class="modal">
        <div class="modal-box max-w-2xl">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="placementModal.close()">✕</button>
            <h3 class="font-bold text-lg mb-4">Размещение гостя</h3>

            <div id="placementRetreatInfo" class="mb-4 p-3 bg-base-200 rounded-lg">
                <!-- Retreat info will be inserted here -->
            </div>

            <!-- Dates -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="form-control">
                    <label class="label"><span class="label-text font-medium">Заезд</span></label>
                    <input type="date" id="placementCheckIn" class="input input-bordered" onchange="updateRoomsList()" />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text font-medium">Выезд</span></label>
                    <input type="date" id="placementCheckOut" class="input input-bordered" onchange="updateRoomsList()" />
                </div>
            </div>

            <!-- Rooms List -->
            <div class="mb-4">
                <label class="label"><span class="label-text font-medium">Выберите комнату</span></label>
                <div id="roomsList" class="space-y-2 max-h-64 overflow-y-auto">
                    <div class="text-center py-4 opacity-50">Загрузка...</div>
                </div>
            </div>

            <!-- Legend -->
            <div class="flex flex-wrap gap-3 text-xs opacity-60 mb-4">
                <div class="flex items-center gap-1">
                    <span class="w-3 h-3 rounded bg-success"></span> Свободно
                </div>
                <div class="flex items-center gap-1">
                    <span class="w-3 h-3 rounded bg-warning"></span> Частично
                </div>
                <div class="flex items-center gap-1">
                    <span class="w-3 h-3 rounded bg-error opacity-50"></span> Занято
                </div>
            </div>

            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="placementModal.close()">Отмена</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Edit Registration Modal -->
    <dialog id="editRegModal" class="modal">
        <div class="modal-box max-w-2xl">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="editRegModal.close()">✕</button>
            <h3 class="font-bold text-lg mb-1">Редактирование регистрации</h3>
            <p id="editRegPersonName" class="text-sm opacity-60 mb-4"></p>
            <input type="hidden" id="editRegId" />

            <div class="space-y-4">
                <!-- Статус -->
                <div class="form-control">
                    <label class="label"><span class="label-text font-medium">Статус</span></label>
                    <select id="editRegStatus" class="select select-bordered">
                        <option value="guest" data-i18n="status_guest">Гость</option>
                        <option value="team" data-i18n="status_team">Команда</option>
                        <option value="cancelled" data-i18n="status_cancelled">Отказ</option>
                    </select>
                </div>

                <!-- Питание -->
                <div class="form-control">
                    <label class="label"><span class="label-text font-medium" data-i18n="meal_type">Питание</span></label>
                    <select id="editMealType" class="select select-bordered">
                        <option value="" data-i18n="not_specified">Не указано</option>
                        <option value="prasad" data-i18n="meal_type_prasad">С нами</option>
                        <option value="self" data-i18n="meal_type_self">Самостоятельно</option>
                        <option value="child" data-i18n="meal_type_child">Детское</option>
                    </select>
                </div>

                <!-- Прилёт -->
                <div class="border rounded-lg p-3">
                    <div class="font-medium mb-2">✈️ Прилёт</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="form-control">
                            <label class="label label-text text-xs">Дата и время рейса</label>
                            <input type="datetime-local" id="editArrivalDatetime" class="input input-bordered input-sm"
                                   onchange="updateCalcArrival()" />
                        </div>
                        <div class="form-control">
                            <label class="label label-text text-xs">Номер рейса</label>
                            <input type="text" id="editArrivalFlight" class="input input-bordered input-sm" placeholder="SU 123" />
                        </div>
                        <div class="form-control">
                            <label class="label label-text text-xs">Трансфер</label>
                            <select id="editArrivalTransfer" class="select select-bordered select-sm">
                                <option value="">Не указано</option>
                                <option value="yes">Нужен</option>
                                <option value="no">Не нужен</option>
                            </select>
                        </div>
                        <div class="form-control">
                            <label class="label label-text text-xs">Примечание</label>
                            <input type="text" id="editArrivalNotes" class="input input-bordered input-sm" placeholder="07.02.2025 в 08:00" />
                        </div>
                        <div class="col-span-2 mt-1">
                            <label class="label cursor-pointer justify-start gap-2 py-0">
                                <input type="checkbox" id="editDirectArrival" class="checkbox checkbox-xs checkbox-primary"
                                       onchange="toggleDirectArrival(this.checked)" checked />
                                <span class="label-text text-xs">Сразу на ретрит</span>
                            </label>
                            <div id="calcArrivalBlock" class="mt-2">
                                <span class="label-text text-xs text-base-content/60">Приезд в ШРСК (рейс + 4ч):</span>
                                <span id="calcArrivalTime" class="text-xs font-medium ml-1">—</span>
                            </div>
                            <div id="customArrivalBlock" class="hidden mt-2 grid grid-cols-3 gap-2">
                                <div class="col-span-2">
                                    <label class="label label-text text-xs">Время приезда в ШРСК</label>
                                    <input type="datetime-local" id="editArrivalAtAshram" class="input input-bordered input-sm w-full" />
                                </div>
                                <div>
                                    <label class="label label-text text-xs">Трансфер на ретрит</label>
                                    <select id="editArrivalRetreatTransfer" class="select select-bordered select-sm w-full">
                                        <option value="">Не указано</option>
                                        <option value="yes">Нужен</option>
                                        <option value="no">Не нужен</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Вылет -->
                <div class="border rounded-lg p-3">
                    <div class="font-medium mb-2">✈️ Вылет</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="form-control">
                            <label class="label label-text text-xs">Дата и время рейса</label>
                            <input type="datetime-local" id="editDepartureDatetime" class="input input-bordered input-sm"
                                   onchange="updateCalcDeparture()" />
                        </div>
                        <div class="form-control">
                            <label class="label label-text text-xs">Номер рейса</label>
                            <input type="text" id="editDepartureFlight" class="input input-bordered input-sm" placeholder="SU 456" />
                        </div>
                        <div class="form-control">
                            <label class="label label-text text-xs">Трансфер</label>
                            <select id="editDepartureTransfer" class="select select-bordered select-sm">
                                <option value="">Не указано</option>
                                <option value="yes">Нужен</option>
                                <option value="no">Не нужен</option>
                            </select>
                        </div>
                        <div class="form-control">
                            <label class="label label-text text-xs">Примечание</label>
                            <input type="text" id="editDepartureNotes" class="input input-bordered input-sm" placeholder="23.02.2025 в 13:00" />
                        </div>
                        <div class="col-span-2 mt-1">
                            <label class="label cursor-pointer justify-start gap-2 py-0">
                                <input type="checkbox" id="editDirectDeparture" class="checkbox checkbox-xs checkbox-primary"
                                       onchange="toggleDirectDeparture(this.checked)" checked />
                                <span class="label-text text-xs">С ретрита на самолёт</span>
                            </label>
                            <div id="calcDepartureBlock" class="mt-2">
                                <span class="label-text text-xs text-base-content/60">Отъезд из ШРСК (рейс − 7ч):</span>
                                <span id="calcDepartureTime" class="text-xs font-medium ml-1">—</span>
                            </div>
                            <div id="customDepartureBlock" class="hidden mt-2 grid grid-cols-3 gap-2">
                                <div class="col-span-2">
                                    <label class="label label-text text-xs">Время выезда из ШРСК</label>
                                    <input type="datetime-local" id="editDepartureFromAshram" class="input input-bordered input-sm w-full" />
                                </div>
                                <div>
                                    <label class="label label-text text-xs">Трансфер с ретрита</label>
                                    <select id="editDepartureRetreatTransfer" class="select select-bordered select-sm w-full">
                                        <option value="">Не указано</option>
                                        <option value="yes">Нужен</option>
                                        <option value="no">Не нужен</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Пожелания и доп. поля -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text font-medium">Пожелания по проживанию</span></label>
                        <input type="text" id="editAccommodationWishes" class="input input-bordered" />
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text font-medium">Семья / Спутники</span></label>
                        <input type="text" id="editCompanions" class="input input-bordered" />
                    </div>
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text font-medium">После ретрита</span></label>
                    <textarea id="editExtendedStay" class="textarea textarea-bordered" rows="2"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text font-medium">Оплата</span></label>
                        <input type="text" id="editPaymentNotes" class="input input-bordered" />
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text font-medium">Комментарий ОП</span></label>
                        <input type="text" id="editOrgNotes" class="input input-bordered" />
                    </div>
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text font-medium">Вопросы</span></label>
                    <textarea id="editGuestQuestions" class="textarea textarea-bordered" rows="2"></textarea>
                </div>
            </div>

            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="editRegModal.close()">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveRegistration()">Сохранить</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Add Child Modal -->
    <dialog id="addChildModal" class="modal">
        <div class="modal-box">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="addChildModal.close()">✕</button>
            <h3 class="font-bold text-lg mb-4" id="childModalTitle" data-i18n="add_child">Добавить ребёнка</h3>
            <form id="addChildForm" onsubmit="saveChild(event)">
                <input type="hidden" id="editChildId" value="">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text font-medium" data-i18n="first_name">Имя</span></label>
                        <input type="text" id="childFirstName" class="input input-bordered" required>
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text font-medium" data-i18n="last_name">Фамилия</span></label>
                        <input type="text" id="childLastName" class="input input-bordered">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text font-medium" data-i18n="gender">Пол</span></label>
                        <select id="childGender" class="select select-bordered">
                            <option value="" data-i18n="not_specified">Не указан</option>
                            <option value="male" data-i18n="male">Мужской</option>
                            <option value="female" data-i18n="female">Женский</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text font-medium" data-i18n="birth_date">Дата рождения</span></label>
                        <input type="date" id="childBirthDate" class="input input-bordered">
                    </div>
                </div>
                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" onclick="addChildModal.close()" data-i18n="cancel">Отмена</button>
                    <button type="submit" class="btn btn-primary" data-i18n="save">Сохранить</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <div id="footer-placeholder"></div>

    <script src="../js/config.js"></script>
    <script src="../js/auth-check.js?v=3"></script>
    <script src="../js/cache.js"></script>
    <script src="../js/utils.js?v=2"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/modal-utils.js"></script>
    <script src="../js/date-utils.js"></script>
    <script src="../js/layout.js?v=5"></script>
    <script src="../js/pages/person.js?v=6"></script>
</body>
</html>
