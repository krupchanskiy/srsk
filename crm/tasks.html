<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <script src="../js/color-init.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-title="crm_tasks_page_title">Мои задачи — CRM — ШРСК</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        .task-card { transition: all 0.2s; }
        .task-card:hover { transform: translateX(4px); }
        .task-card.completed { opacity: 0.6; }
        .task-card.overdue { border-left-color: #ef4444 !important; }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

<div id="header-placeholder"></div>

<main class="container mx-auto px-4 py-6 flex-1">
    <!-- Заголовок -->
    <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
        <h1 class="text-2xl font-bold" data-i18n="nav_crm_tasks">Мои задачи</h1>

        <div class="flex gap-3">
            <select id="filterStatus" class="select select-bordered select-sm" onchange="applyFilters()">
                <option value="active" data-i18n="crm_filter_active">Активные</option>
                <option value="all" data-i18n="all">Все</option>
                <option value="completed" data-i18n="crm_filter_completed">Завершённые</option>
            </select>

            <select id="filterPriority" class="select select-bordered select-sm" onchange="applyFilters()">
                <option value="" data-i18n="crm_all_priorities">Все приоритеты</option>
                <option value="urgent" data-i18n="crm_priority_urgent">Срочные</option>
                <option value="high" data-i18n="crm_priority_high">Высокие</option>
                <option value="normal" data-i18n="crm_priority_normal">Обычные</option>
                <option value="low" data-i18n="crm_priority_low">Низкие</option>
            </select>
        </div>
    </div>

    <!-- Статистика -->
    <div class="stats shadow mb-6">
        <div class="stat">
            <div class="stat-title" data-i18n="crm_stat_total">Всего</div>
            <div class="stat-value text-2xl" id="statTotal">—</div>
        </div>
        <div class="stat">
            <div class="stat-title" data-i18n="crm_stat_today">На сегодня</div>
            <div class="stat-value text-2xl text-primary" id="statToday">—</div>
        </div>
        <div class="stat">
            <div class="stat-title" data-i18n="crm_stat_overdue">Просрочено</div>
            <div class="stat-value text-2xl text-error" id="statOverdue">—</div>
        </div>
        <div class="stat">
            <div class="stat-title" data-i18n="crm_stat_done">Завершено</div>
            <div class="stat-value text-2xl text-success" id="statCompleted">—</div>
        </div>
    </div>

    <!-- Секции задач -->
    <div class="space-y-6">
        <!-- Просроченные -->
        <div id="sectionOverdue" class="hidden">
            <h2 class="text-lg font-bold text-error mb-3 flex items-center gap-2" id="headerOverdue" data-i18n="crm_section_overdue">Просроченные</h2>
            <div id="tasksOverdue" class="space-y-2"></div>
        </div>

        <!-- На сегодня -->
        <div id="sectionToday" class="hidden">
            <h2 class="text-lg font-bold text-primary mb-3 flex items-center gap-2" id="headerToday" data-i18n="crm_section_today">На сегодня</h2>
            <div id="tasksToday" class="space-y-2"></div>
        </div>

        <!-- На этой неделе -->
        <div id="sectionWeek" class="hidden">
            <h2 class="text-lg font-bold mb-3 flex items-center gap-2" id="headerWeek" data-i18n="crm_section_week">На этой неделе</h2>
            <div id="tasksWeek" class="space-y-2"></div>
        </div>

        <!-- Позже -->
        <div id="sectionLater" class="hidden">
            <h2 class="text-lg font-bold text-base-content/70 mb-3 flex items-center gap-2" id="headerLater" data-i18n="crm_section_later">Позже</h2>
            <div id="tasksLater" class="space-y-2"></div>
        </div>

        <!-- Без даты -->
        <div id="sectionNoDate" class="hidden">
            <h2 class="text-lg font-bold text-base-content/50 mb-3 flex items-center gap-2" id="headerNoDate" data-i18n="crm_section_no_date">Без даты</h2>
            <div id="tasksNoDate" class="space-y-2"></div>
        </div>

        <!-- Завершённые -->
        <div id="sectionCompleted" class="hidden">
            <h2 class="text-lg font-bold text-success mb-3 flex items-center gap-2" id="headerCompleted" data-i18n="crm_filter_completed">Завершённые</h2>
            <div id="tasksCompleted" class="space-y-2"></div>
        </div>
    </div>

    <!-- Пусто -->
    <div id="emptyState" class="text-center py-12 hidden">
        <div class="mb-4 text-success" id="emptyIcon"></div>
        <div class="text-xl font-medium" data-i18n="crm_no_active_tasks">Нет активных задач</div>
        <div class="text-base-content/50" data-i18n="crm_all_tasks_done">Все задачи выполнены!</div>
    </div>
</main>

<!-- Модалка подтверждения закрытия задачи -->
<dialog id="completeModal" class="modal">
    <div class="modal-box max-w-md">
        <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeCompleteModal()">✕</button>
        <h3 class="font-bold text-lg mb-4" data-i18n="crm_complete_task_confirm">Завершить задачу?</h3>

        <div id="completeTaskTitle" class="font-medium text-base-content/80 mb-4 p-3 bg-base-200 rounded-lg"></div>

        <div class="form-control mb-4">
            <label class="label">
                <span class="label-text" data-i18n="crm_comment_optional">Комментарий (опционально)</span>
            </label>
            <textarea id="completionComment" class="textarea textarea-bordered w-full"
                      rows="3" placeholder="Результат, заметки..." data-i18n-placeholder="crm_completion_placeholder"></textarea>
        </div>

        <div class="modal-action">
            <button type="button" class="btn btn-ghost" onclick="closeCompleteModal()" data-i18n="cancel">Отмена</button>
            <button type="button" class="btn btn-success" onclick="confirmCompleteTask()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                </svg>
                <span data-i18n="crm_complete">Завершить</span>
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>

<div id="footer-placeholder"></div>

<script src="../js/config.js"></script>
<script src="../js/auth-check.js"></script>
<script src="../js/cache.js"></script>
<script src="../js/utils.js?v=2"></script>
<script src="../js/layout.js"></script>
<script src="../js/crm-utils.js"></script>
<script src="../js/date-utils.js"></script>

<script>
const t = key => Layout.t(key);
const e = str => Layout.escapeHtml(str);

// ==================== STATE ====================
let tasks = [];
let filteredTasks = [];

// ==================== DATA ====================
async function loadTasks() {
    const currentUserId = window.currentUser?.vaishnava_id;

    let query = Layout.db
        .from('crm_tasks')
        .select(`
            *,
            deal:deal_id(
                id,
                vaishnavas:vaishnava_id(spiritual_name, first_name, last_name),
                retreats:retreat_id(name_ru, name_en, color)
            ),
            assignee:assignee_id(spiritual_name, first_name),
            completer:completed_by(spiritual_name, first_name)
        `)
        .order('due_date', { nullsFirst: false });

    // Фильтр по пользователю только если авторизован
    if (currentUserId) {
        query = query.or(`assignee_id.eq.${currentUserId},created_by.eq.${currentUserId}`);
    }

    const { data, error } = await query;

    if (error) {
        Layout.handleError(error, 'Загрузка задач');
        return;
    }

    tasks = data || [];
    applyFilters();
}

// ==================== FILTERS ====================
function applyFilters() {
    const status = document.getElementById('filterStatus').value;
    const priority = document.getElementById('filterPriority').value;

    filteredTasks = tasks.filter(task => {
        // Статус
        if (status === 'active' && task.completed_at) return false;
        if (status === 'completed' && !task.completed_at) return false;

        // Приоритет
        if (priority && task.priority !== priority) return false;

        return true;
    });

    renderTasks();
    renderStats();
}

// ==================== RENDER ====================
function renderStats() {
    const all = tasks.filter(t => !t.completed_at);
    const today = all.filter(t => isToday(t.due_date));
    const overdue = all.filter(t => CrmUtils.isTaskOverdue(t));
    const completed = tasks.filter(t => t.completed_at);

    document.getElementById('statTotal').textContent = all.length;
    document.getElementById('statToday').textContent = today.length;
    document.getElementById('statOverdue').textContent = overdue.length;
    document.getElementById('statCompleted').textContent = completed.length;
}

function renderTasks() {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const weekEnd = new Date(today);
    weekEnd.setDate(weekEnd.getDate() + 7);

    // Группируем задачи
    const groups = {
        overdue: [],
        today: [],
        week: [],
        later: [],
        noDate: [],
        completed: []
    };

    filteredTasks.forEach(task => {
        if (task.completed_at) {
            groups.completed.push(task);
        } else if (!task.due_date) {
            groups.noDate.push(task);
        } else {
            const dueDate = DateUtils.parseDate(task.due_date);
            if (dueDate < today) {
                groups.overdue.push(task);
            } else if (isToday(task.due_date)) {
                groups.today.push(task);
            } else if (dueDate <= weekEnd) {
                groups.week.push(task);
            } else {
                groups.later.push(task);
            }
        }
    });

    // Рендерим каждую группу
    renderSection('Overdue', groups.overdue);
    renderSection('Today', groups.today);
    renderSection('Week', groups.week);
    renderSection('Later', groups.later);
    renderSection('NoDate', groups.noDate);
    renderSection('Completed', groups.completed);

    // Показываем empty state
    const hasActive = groups.overdue.length + groups.today.length + groups.week.length + groups.later.length + groups.noDate.length > 0;
    document.getElementById('emptyState').classList.toggle('hidden', hasActive || groups.completed.length > 0);
}

function renderSection(name, tasks) {
    const section = document.getElementById(`section${name}`);
    const container = document.getElementById(`tasks${name}`);

    if (tasks.length === 0) {
        section.classList.add('hidden');
        return;
    }

    section.classList.remove('hidden');
    container.innerHTML = tasks.map(task => renderTaskCard(task)).join('');
}

function renderTaskCard(task) {
    const isOverdue = CrmUtils.isTaskOverdue(task);
    const isCompleted = !!task.completed_at;
    const guest = task.deal?.vaishnavas;
    const retreat = task.deal?.retreats;
    const priorityColor = CrmUtils.PRIORITY_COLORS[task.priority];

    // Информация о закрытии
    let completionInfo = '';
    if (isCompleted) {
        const completerName = task.completer
            ? (task.completer.spiritual_name || task.completer.first_name || '')
            : '';
        const completedDate = CrmUtils.formatDateTime(task.completed_at);

        completionInfo = `
            <div class="mt-3 pt-3 border-t border-base-300 text-xs text-base-content/60">
                <div class="flex items-center gap-1 mb-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-success">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                    </svg>
                    <span>Завершено ${completedDate}${completerName ? ` — ${e(completerName)}` : ''}</span>
                </div>
                ${task.completion_comment ? `
                    <div class="mt-1 pl-5 italic text-base-content/50">${e(task.completion_comment)}</div>
                ` : ''}
            </div>
        `;
    }

    return `
        <div class="task-card card bg-base-100 shadow-sm border-l-4 ${isCompleted ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}"
             style="border-left-color: ${priorityColor};">
            <div class="card-body p-4">
                <div class="flex items-start gap-3">
                    <input type="checkbox" class="checkbox checkbox-primary mt-1"
                           ${isCompleted ? 'checked' : ''}
                           onchange="toggleTask('${task.id}', this.checked)">
                    <div class="flex-1">
                        <div class="flex items-start justify-between gap-2">
                            <div class="font-medium ${isCompleted ? 'line-through text-base-content/50' : ''}">${e(task.title)}</div>
                            <span class="badge badge-sm shrink-0" style="background-color: ${priorityColor}; color: white;">
                                ${t('crm_priority_' + task.priority) || task.priority}
                            </span>
                        </div>

                        ${task.description ? `<div class="text-sm text-base-content/60 mt-1">${e(task.description)}</div>` : ''}

                        <div class="flex flex-wrap items-center gap-3 mt-2 text-xs">
                            ${task.due_date ? `
                                <span class="inline-flex items-center gap-1 ${isOverdue ? 'text-error font-medium' : 'text-base-content/50'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" /></svg>
                                    ${CrmUtils.formatDate(task.due_date)}
                                </span>
                            ` : ''}

                            ${guest ? `
                                <a href="deal.html?id=${task.deal_id}" class="link link-hover text-base-content/70 inline-flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>
                                    ${e(CrmUtils.getGuestShortName(guest))}
                                </a>
                            ` : ''}

                            ${retreat ? `
                                <span class="badge badge-xs" style="background-color: ${retreat.color}; color: white;">
                                    ${e(Layout.getName(retreat))}
                                </span>
                            ` : ''}
                        </div>

                        ${completionInfo}
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ==================== ACTIONS ====================
let pendingTaskId = null;

function openCompleteModal(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;

    pendingTaskId = taskId;
    document.getElementById('completeTaskTitle').textContent = task.title;
    document.getElementById('completionComment').value = '';
    document.getElementById('completeModal').showModal();
}

function closeCompleteModal() {
    document.getElementById('completeModal').close();
    pendingTaskId = null;
    // Сбрасываем чекбокс обратно
    applyFilters();
}

async function confirmCompleteTask() {
    if (!pendingTaskId) return;

    const comment = document.getElementById('completionComment').value.trim();
    const currentUserId = window.currentUser?.vaishnava_id;

    const { error } = await Layout.db
        .from('crm_tasks')
        .update({
            completed_at: new Date().toISOString(),
            completion_comment: comment || null,
            completed_by: currentUserId
        })
        .eq('id', pendingTaskId);

    if (error) {
        Layout.handleError(error, 'Завершение задачи');
        return;
    }

    // Обновляем локально
    const task = tasks.find(t => t.id === pendingTaskId);
    if (task) {
        task.completed_at = new Date().toISOString();
        task.completion_comment = comment || null;
        task.completed_by = currentUserId;
        // Для отображения имени
        task.completer = window.currentUser ? {
            spiritual_name: window.currentUser.spiritual_name,
            first_name: window.currentUser.first_name
        } : null;
    }

    document.getElementById('completeModal').close();
    pendingTaskId = null;
    applyFilters();
    Layout.showNotification('Задача завершена', 'success');
}

async function reopenTask(taskId) {
    const { error } = await Layout.db
        .from('crm_tasks')
        .update({
            completed_at: null,
            completion_comment: null,
            completed_by: null
        })
        .eq('id', taskId);

    if (error) {
        Layout.handleError(error, 'Восстановление задачи');
        return;
    }

    // Обновляем локально
    const task = tasks.find(t => t.id === taskId);
    if (task) {
        task.completed_at = null;
        task.completion_comment = null;
        task.completed_by = null;
        task.completer = null;
    }

    applyFilters();
    Layout.showNotification('Задача восстановлена', 'success');
}

function toggleTask(taskId, completed) {
    if (completed) {
        // Открываем модалку для подтверждения
        openCompleteModal(taskId);
    } else {
        // Восстанавливаем задачу сразу
        reopenTask(taskId);
    }
}

// ==================== HELPERS ====================
function isToday(dateStr) {
    if (!dateStr) return false;
    const date = DateUtils.parseDate(dateStr);
    const today = new Date();
    return date.getFullYear() === today.getFullYear() &&
           date.getMonth() === today.getMonth() &&
           date.getDate() === today.getDate();
}

// ==================== REALTIME ====================
function subscribeToChanges() {
    const channel = Layout.db.channel('crm-tasks-changes')
        .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'crm_tasks'
        }, payload => {
            loadTasks();
        })
        .subscribe();
}

// ==================== INIT ====================
function initIcons() {
    // Иконки заголовков секций
    const warningIcon = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg>';
    const calendarIcon = CrmUtils.UI_ICONS.calendar;
    const checkIcon = CrmUtils.UI_ICONS.checkCircle;
    const pinIcon = CrmUtils.UI_ICONS.pin;
    const trophyIcon = CrmUtils.UI_ICONS.trophy;

    document.getElementById('headerOverdue').innerHTML = warningIcon + ' Просроченные';
    document.getElementById('headerToday').innerHTML = calendarIcon + ' На сегодня';
    document.getElementById('headerWeek').innerHTML = calendarIcon + ' На этой неделе';
    document.getElementById('headerLater').innerHTML = calendarIcon + ' Позже';
    document.getElementById('headerNoDate').innerHTML = pinIcon + ' Без даты';
    document.getElementById('headerCompleted').innerHTML = checkIcon + ' Завершённые';
    document.getElementById('emptyIcon').innerHTML = trophyIcon;
}

// Ждём событие authReady от auth-check.js
function waitForAuth(maxWait = 3000) {
    return new Promise(resolve => {
        if (window.currentUser) {
            resolve();
            return;
        }
        const handler = () => resolve();
        window.addEventListener('authReady', handler, { once: true });
        setTimeout(() => {
            window.removeEventListener('authReady', handler);
            resolve();
        }, maxWait);
    });
}

async function init() {
    await Layout.init({
        module: 'crm',
        menuId: 'crm_sales',
        itemId: 'crm_tasks'
    });

    await waitForAuth();
    initIcons();
    await loadTasks();
    subscribeToChanges();
}

init();
</script>

</body>
</html>
