<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ—Ç—Ä–∏—Ç ‚Äî –®–†–°–ö</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans', sans-serif; }
        .step { display: none; }
        .step.active { display: block; }
        .step-indicator { transition: all 0.3s; }
        .step-indicator.completed { background-color: #10b981; color: white; }
        .step-indicator.active { background-color: #3b82f6; color: white; }
    </style>
</head>
<body class="bg-gradient-to-br from-emerald-50 to-teal-100 min-h-screen">

<div class="container mx-auto px-4 py-8 max-w-2xl">
    <!-- –õ–æ–≥–æ—Ç–∏–ø -->
    <div class="text-center mb-8">
        <img src="../img/logo.png" alt="–®–†–°–ö" class="h-16 mx-auto mb-4" onerror="this.style.display='none'">
        <h1 class="text-2xl font-bold text-gray-800" id="pageTitle">–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ—Ç—Ä–∏—Ç</h1>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —à–∞–≥–æ–≤ -->
    <div class="flex justify-center gap-2 mb-8" id="stepIndicators">
        <div class="step-indicator w-10 h-10 rounded-full flex items-center justify-center font-bold active" data-step="1">1</div>
        <div class="w-8 h-1 bg-gray-300 self-center rounded"></div>
        <div class="step-indicator w-10 h-10 rounded-full flex items-center justify-center font-bold bg-gray-300" data-step="2">2</div>
        <div class="w-8 h-1 bg-gray-300 self-center rounded"></div>
        <div class="step-indicator w-10 h-10 rounded-full flex items-center justify-center font-bold bg-gray-300" data-step="3">3</div>
    </div>

    <!-- –§–æ—Ä–º–∞ -->
    <form id="applicationForm" class="card bg-white shadow-xl">
        <div class="card-body">
            <!-- –®–ê–ì 1: –õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
            <div class="step active" data-step="1">
                <h2 class="text-xl font-bold mb-6 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg> –õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text">–î—É—Ö–æ–≤–Ω–æ–µ –∏–º—è</span></label>
                        <input type="text" name="spiritual_name" class="input input-bordered"
                               placeholder="–ï—Å–ª–∏ –µ—Å—Ç—å">
                    </div>

                    <div class="form-control">
                        <label class="label"><span class="label-text">–ò–º—è <span class="text-error">*</span></span></label>
                        <input type="text" name="first_name" class="input input-bordered" required>
                    </div>

                    <div class="form-control">
                        <label class="label"><span class="label-text">–§–∞–º–∏–ª–∏—è</span></label>
                        <input type="text" name="last_name" class="input input-bordered">
                    </div>

                    <div class="form-control">
                        <label class="label"><span class="label-text">–ü–æ–ª <span class="text-error">*</span></span></label>
                        <select name="gender" class="select select-bordered" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                            <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                            <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label"><span class="label-text">–¢–µ–ª–µ—Ñ–æ–Ω <span class="text-error">*</span></span></label>
                        <input type="tel" name="phone" class="input input-bordered"
                               placeholder="+7 999 123 45 67" required>
                    </div>

                    <div class="form-control">
                        <label class="label"><span class="label-text">Email</span></label>
                        <input type="email" name="email" class="input input-bordered"
                               placeholder="your@email.com">
                    </div>

                    <div class="form-control">
                        <label class="label"><span class="label-text">Telegram</span></label>
                        <input type="text" name="telegram" class="input input-bordered"
                               placeholder="@username">
                    </div>

                    <div class="form-control">
                        <label class="label"><span class="label-text">–ì–æ—Ä–æ–¥</span></label>
                        <input type="text" name="city" class="input input-bordered">
                    </div>
                </div>

                <div class="flex justify-end mt-6">
                    <button type="button" class="btn btn-primary" onclick="nextStep()">
                        –î–∞–ª–µ–µ ‚Üí
                    </button>
                </div>
            </div>

            <!-- –®–ê–ì 2: –†–µ—Ç—Ä–∏—Ç –∏ —É—Å–ª—É–≥–∏ -->
            <div class="step" data-step="2">
                <h2 class="text-xl font-bold mb-6">üèïÔ∏è –†–µ—Ç—Ä–∏—Ç</h2>

                <div class="form-control mb-4">
                    <label class="label"><span class="label-text">–†–µ—Ç—Ä–∏—Ç <span class="text-error">*</span></span></label>
                    <select name="retreat_id" id="retreatSelect" class="select select-bordered" required onchange="loadServices()">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                    </select>
                </div>

                <div id="retreatInfo" class="alert alert-info mb-4 hidden">
                    <div>
                        <div class="font-bold" id="retreatName"></div>
                        <div class="text-sm" id="retreatDates"></div>
                    </div>
                </div>

                <div class="form-control mb-4">
                    <label class="label"><span class="label-text">–¢–∏–ø —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</span></label>
                    <select name="room_type" id="roomTypeSelect" class="select select-bordered">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ç—Ä–∏—Ç —Å–Ω–∞—á–∞–ª–∞</option>
                    </select>
                </div>

                <div class="form-control mb-4">
                    <label class="label"><span class="label-text">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</span></label>
                    <div id="servicesContainer" class="space-y-2">
                        <div class="text-base-content/50 text-sm">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ç—Ä–∏—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—Å–ª—É–≥</div>
                    </div>
                </div>

                <div class="form-control mb-4">
                    <label class="label"><span class="label-text">–ü–∏—Ç–∞–Ω–∏–µ</span></label>
                    <div class="flex flex-wrap gap-4">
                        <label class="label cursor-pointer gap-2">
                            <input type="checkbox" name="needs_breakfast" class="checkbox checkbox-primary">
                            <span class="label-text">–ó–∞–≤—Ç—Ä–∞–∫</span>
                        </label>
                        <label class="label cursor-pointer gap-2">
                            <input type="checkbox" name="needs_lunch" class="checkbox checkbox-primary">
                            <span class="label-text">–û–±–µ–¥</span>
                        </label>
                        <label class="label cursor-pointer gap-2">
                            <input type="checkbox" name="needs_dinner" class="checkbox checkbox-primary">
                            <span class="label-text">–£–∂–∏–Ω</span>
                        </label>
                    </div>
                </div>

                <div class="flex justify-between mt-6">
                    <button type="button" class="btn btn-ghost" onclick="prevStep()">‚Üê –ù–∞–∑–∞–¥</button>
                    <button type="button" class="btn btn-primary" onclick="nextStep()">–î–∞–ª–µ–µ ‚Üí</button>
                </div>
            </div>

            <!-- –®–ê–ì 3: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ -->
            <div class="step" data-step="3">
                <h2 class="text-xl font-bold mb-6 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg> –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</h2>

                <!-- –î–µ—Ç–∏ -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <label class="label-text font-medium">üë∂ –î–µ—Ç–∏ (–¥–æ 14 –ª–µ—Ç)</label>
                        <button type="button" class="btn btn-sm btn-outline gap-1" onclick="addChildRow()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞
                        </button>
                    </div>
                    <div id="childrenRows" class="space-y-3"></div>
                </div>

                <div class="form-control mb-4">
                    <label class="label"><span class="label-text">–°–æ–ø—Ä–æ–≤–æ–∂–¥–∞—é—â–∏–µ (–∏–º–µ–Ω–∞)</span></label>
                    <textarea name="companions" class="textarea textarea-bordered" rows="2"
                              placeholder="–ò–º–µ–Ω–∞ –≤–∑—Ä–æ—Å–ª—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–µ–¥—É—Ç —Å –≤–∞–º–∏"></textarea>
                    <label class="label">
                        <span class="label-text-alt">–£–∫–∞–∂–∏—Ç–µ, –µ—Å–ª–∏ –ø–æ–¥–∞—ë—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ –≥—Ä—É–ø–ø—É</span>
                    </label>
                </div>

                <div class="form-control mb-4">
                    <label class="label"><span class="label-text">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</span></label>
                    <textarea name="notes" class="textarea textarea-bordered" rows="3"
                              placeholder="–û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è, –≤–æ–ø—Ä–æ—Å—ã, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –∑–¥–æ—Ä–æ–≤—å—é..."></textarea>
                </div>

                <div class="form-control mb-4">
                    <label class="label"><span class="label-text">–û—Ç–∫—É–¥–∞ —É–∑–Ω–∞–ª–∏ –æ —Ä–µ—Ç—Ä–∏—Ç–µ?</span></label>
                    <select name="source" class="select select-bordered">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                        <option value="instagram">Instagram</option>
                        <option value="telegram">Telegram</option>
                        <option value="youtube">YouTube</option>
                        <option value="facebook">Facebook</option>
                        <option value="friend">–û—Ç –¥—Ä—É–∑–µ–π</option>
                        <option value="website">–°–∞–π—Ç</option>
                        <option value="repeat">–ë—ã–ª(–∞) —Ä–∞–Ω—å—à–µ</option>
                        <option value="other">–î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>

                <div class="form-control mb-6">
                    <label class="label cursor-pointer justify-start gap-3">
                        <input type="checkbox" name="privacy_agreed" class="checkbox checkbox-primary" required>
                        <span class="label-text">
                            –Ø —Å–æ–≥–ª–∞—Å–µ–Ω(–∞) –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö <span class="text-error">*</span>
                        </span>
                    </label>
                </div>

                <div class="flex justify-between">
                    <button type="button" class="btn btn-ghost" onclick="prevStep()">‚Üê –ù–∞–∑–∞–¥</button>
                    <button type="submit" class="btn btn-success gap-2" id="submitBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
                    </button>
                </div>
            </div>
        </div>
    </form>

    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ -->
    <div id="successMessage" class="card bg-white shadow-xl hidden">
        <div class="card-body text-center py-12">
            <div class="text-success mb-4"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 0 1-.982-3.172M9.497 14.25a7.454 7.454 0 0 0 .981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 0 0 7.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 0 0 2.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492a46.32 46.32 0 0 1 2.916.52 6.003 6.003 0 0 1-5.395 4.972m0 0a6.726 6.726 0 0 1-2.749 1.35m0 0a6.772 6.772 0 0 1-2.752 0" /></svg></div>
            <h2 class="text-2xl font-bold text-success mb-2">–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!</h2>
            <p class="text-base-content/70 mb-6">
                –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É—á–∞—Å—Ç–∏—è.
            </p>
            <div class="alert alert-info">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω ‚Äî –º—ã –Ω–∞–ø–∏—à–µ–º –≤ WhatsApp –∏–ª–∏ Telegram</span>
            </div>
            <div class="mt-6">
                <a href="form.html" class="btn btn-outline">–ü–æ–¥–∞—Ç—å –µ—â—ë –æ–¥–Ω—É –∑–∞—è–≤–∫—É</a>
            </div>
        </div>
    </div>

    <!-- –û—à–∏–±–∫–∞ -->
    <div id="errorMessage" class="alert alert-error mt-4 hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <span id="errorText"></span>
    </div>
</div>

<script src="../js/date-utils.js"></script>
<script src="../js/config.js"></script>

<script>
// ==================== SUPABASE ====================
const db = window.supabaseClient || supabase.createClient(
    window.CONFIG.SUPABASE_URL,
    window.CONFIG.SUPABASE_ANON_KEY
);

// ==================== STATE ====================
let currentStep = 1;
let retreats = [];
let services = [];
let urlParams = {};

// ==================== URL PARAMS ====================
function parseUrlParams() {
    const params = new URLSearchParams(window.location.search);
    urlParams = {
        retreat: params.get('retreat'),
        utm_source: params.get('utm_source'),
        utm_medium: params.get('utm_medium'),
        utm_campaign: params.get('utm_campaign'),
        utm_content: params.get('utm_content'),
        ref: params.get('ref')
    };
}

// ==================== DATA LOADING ====================
async function loadRetreats() {
    const { data, error } = await db
        .from('retreats')
        .select('id, name_ru, name_en, slug, start_date, end_date, location, color')
        .gte('end_date', DateUtils.toISO(new Date()))
        .order('start_date', { ascending: true });

    if (error) {
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–µ—Ç—Ä–∏—Ç–æ–≤');
        return;
    }

    retreats = data || [];

    const select = document.getElementById('retreatSelect');
    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ç—Ä–∏—Ç</option>';

    retreats.forEach(r => {
        const dates = formatDateRange(r.start_date, r.end_date);
        select.insertAdjacentHTML('beforeend',
            `<option value="${r.id}" data-slug="${r.slug || ''}">${escapeHtml(r.name_ru)} (${dates})</option>`
        );
    });

    // –í—ã–±–∏—Ä–∞–µ–º —Ä–µ—Ç—Ä–∏—Ç –∏–∑ URL
    if (urlParams.retreat) {
        const retreat = retreats.find(r => r.slug === urlParams.retreat || r.id === urlParams.retreat);
        if (retreat) {
            select.value = retreat.id;
            loadServices();
        }
    }
}

async function loadServices() {
    const retreatId = document.getElementById('retreatSelect').value;

    if (!retreatId) {
        document.getElementById('roomTypeSelect').innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ç—Ä–∏—Ç —Å–Ω–∞—á–∞–ª–∞</option>';
        document.getElementById('servicesContainer').innerHTML = '<div class="text-base-content/50 text-sm">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ç—Ä–∏—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—Å–ª—É–≥</div>';
        document.getElementById('retreatInfo').classList.add('hidden');
        return;
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ –æ —Ä–µ—Ç—Ä–∏—Ç–µ
    const retreat = retreats.find(r => r.id === retreatId);
    if (retreat) {
        document.getElementById('retreatName').textContent = retreat.name_ru;
        document.getElementById('retreatDates').textContent =
            `${formatDateRange(retreat.start_date, retreat.end_date)} ‚Ä¢ ${retreat.location || ''}`;
        document.getElementById('retreatInfo').classList.remove('hidden');
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Å–ª—É–≥–∏
    const { data, error } = await db
        .from('crm_services')
        .select('*')
        .eq('is_active', true)
        .order('type', { ascending: true })
        .order('sort_order', { ascending: true });

    if (error) {
        console.error('Error loading services:', error);
        return;
    }

    services = data || [];

    // –¢–∏–ø—ã —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
    const roomTypes = services.filter(s => s.type === 'room');
    const roomSelect = document.getElementById('roomTypeSelect');
    roomSelect.innerHTML = '<option value="">–ë–µ–∑ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</option>';
    roomTypes.forEach(s => {
        roomSelect.insertAdjacentHTML('beforeend',
            `<option value="${s.id}">${escapeHtml(s.name_ru)} ‚Äî ${formatPrice(s.base_price_inr)}</option>`
        );
    });

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏
    const extras = services.filter(s => s.type === 'extra' || s.type === 'transport');
    const container = document.getElementById('servicesContainer');

    if (extras.length === 0) {
        container.innerHTML = '<div class="text-base-content/50 text-sm">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥ –Ω–µ—Ç</div>';
        return;
    }

    container.innerHTML = extras.map(s => `
        <label class="label cursor-pointer justify-start gap-3 bg-base-200 rounded-lg px-4">
            <input type="checkbox" name="service_${s.id}" value="${s.id}" class="checkbox checkbox-sm checkbox-primary">
            <span class="label-text flex-1">${escapeHtml(s.name_ru)}</span>
            <span class="text-sm font-mono">${formatPrice(s.base_price_inr)}</span>
        </label>
    `).join('');
}

// ==================== STEPS NAVIGATION ====================
function updateStepIndicators() {
    document.querySelectorAll('.step-indicator').forEach(el => {
        const step = parseInt(el.dataset.step);
        el.classList.remove('active', 'completed');
        if (step < currentStep) {
            el.classList.add('completed');
        } else if (step === currentStep) {
            el.classList.add('active');
        } else {
            el.classList.add('bg-gray-300');
        }
    });

    document.querySelectorAll('.step').forEach(el => {
        el.classList.toggle('active', parseInt(el.dataset.step) === currentStep);
    });
}

function nextStep() {
    if (!validateCurrentStep()) return;
    if (currentStep < 3) {
        currentStep++;
        updateStepIndicators();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function prevStep() {
    if (currentStep > 1) {
        currentStep--;
        updateStepIndicators();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function validateCurrentStep() {
    const step = document.querySelector(`.step[data-step="${currentStep}"]`);
    const requiredFields = step.querySelectorAll('[required]');

    for (const field of requiredFields) {
        if (!field.value) {
            field.focus();
            field.classList.add('input-error', 'select-error');
            setTimeout(() => field.classList.remove('input-error', 'select-error'), 2000);
            return false;
        }
    }

    return true;
}

// ==================== FORM SUBMISSION ====================
async function submitForm(e) {
    e.preventDefault();

    if (!validateCurrentStep()) return;

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> –û—Ç–ø—Ä–∞–≤–∫–∞...';
    hideError();

    try {
        const form = document.getElementById('applicationForm');
        const formData = new FormData(form);

        // 1. –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≥–æ—Å—Ç—è
        const guestData = {
            spiritual_name: formData.get('spiritual_name') || null,
            first_name: formData.get('first_name'),
            last_name: formData.get('last_name') || null,
            gender: formData.get('gender'),
            phone: normalizePhone(formData.get('phone')),
            email: formData.get('email') || null,
            telegram: formData.get('telegram') || null,
            city: formData.get('city') || null
        };

        // 2. –ò—â–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –≥–æ—Å—Ç—è
        let vaishnavaId = await findOrCreateVaishnava(guestData);

        // 3. –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏
        const retreatId = formData.get('retreat_id');

        // –ü–æ–ª—É—á–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —á–µ—Ä–µ–∑ round-robin
        const managerId = await getNextManager(retreatId);

        // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏
        const selectedServices = [];
        services.forEach(s => {
            if (formData.get(`service_${s.id}`)) {
                selectedServices.push(s.id);
            }
        });

        // UTM –¥–∞–Ω–Ω—ã–µ
        const utmData = {};
        if (urlParams.utm_source) utmData.utm_source = urlParams.utm_source;
        if (urlParams.utm_medium) utmData.utm_medium = urlParams.utm_medium;
        if (urlParams.utm_campaign) utmData.utm_campaign = urlParams.utm_campaign;
        if (urlParams.utm_content) utmData.utm_content = urlParams.utm_content;
        if (urlParams.ref) utmData.ref = urlParams.ref;

        // –ó–∞–º–µ—Ç–∫–∏
        let notes = formData.get('notes') || '';
        const companions = formData.get('companions');
        if (companions) {
            notes = `–°–æ–ø—Ä–æ–≤–æ–∂–¥–∞—é—â–∏–µ: ${companions}\n\n${notes}`;
        }

        const source = formData.get('source');
        const meal_prefs = [];
        if (formData.get('needs_breakfast')) meal_prefs.push('breakfast');
        if (formData.get('needs_lunch')) meal_prefs.push('lunch');
        if (formData.get('needs_dinner')) meal_prefs.push('dinner');

        const dealData = {
            vaishnava_id: vaishnavaId,
            retreat_id: retreatId,
            manager_id: managerId,
            status: 'lead',
            source: source || (urlParams.utm_source ? `utm:${urlParams.utm_source}` : 'form'),
            notes: notes.trim() || null,
            utm_data: Object.keys(utmData).length > 0 ? utmData : null,
            work_mode: 'active',
            group_size: companions ? countCompanions(companions) + 1 : 1,
            created_at: new Date().toISOString()
        };

        // 4. –°–æ–∑–¥–∞—ë–º —Å–¥–µ–ª–∫—É
        const { data: deal, error: dealError } = await db
            .from('crm_deals')
            .insert(dealData)
            .select('id')
            .single();

        if (dealError) throw dealError;

        // 5. –î–æ–±–∞–≤–ª—è–µ–º —É—Å–ª—É–≥–∏
        const roomType = formData.get('room_type');
        const dealServices = [];

        if (roomType) {
            const roomService = services.find(s => s.id === roomType);
            if (roomService) {
                dealServices.push({
                    deal_id: deal.id,
                    service_id: roomType,
                    quantity: 1,
                    unit_price_inr: roomService.base_price_inr,
                    notes: null
                });
            }
        }

        selectedServices.forEach(serviceId => {
            const service = services.find(s => s.id === serviceId);
            if (service) {
                dealServices.push({
                    deal_id: deal.id,
                    service_id: serviceId,
                    quantity: 1,
                    unit_price_inr: service.base_price_inr,
                    notes: null
                });
            }
        });

        if (dealServices.length > 0) {
            await db.from('crm_deal_services').insert(dealServices);
        }

        // 6. –°–æ–∑–¥–∞—ë–º –¥–µ—Ç–µ–π (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã)
        const formChildren = getChildrenFromForm();
        if (formChildren.length > 0) {
            for (const child of formChildren) {
                // –°–æ–∑–¥–∞—ë–º —Ä–µ–±—ë–Ω–∫–∞ –∫–∞–∫ vaishnava —Å parent_id
                const { data: childRecord, error: childError } = await db
                    .from('vaishnavas')
                    .insert({
                        first_name: child.first_name,
                        birth_date: child.birth_date,
                        gender: child.gender,
                        parent_id: vaishnavaId,
                        is_guest: true,
                        is_deleted: false
                    })
                    .select('id')
                    .single();

                if (childError) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–±—ë–Ω–∫–∞:', childError);
                    continue;
                }

                // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ä–µ–±—ë–Ω–∫–∞ –Ω–∞ —Ä–µ—Ç—Ä–∏—Ç —Å meal_type='child'
                await db.from('retreat_registrations').insert({
                    retreat_id: retreatId,
                    vaishnava_id: childRecord.id,
                    status: 'guest',
                    meal_type: 'child'
                });
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º group_size —Å —É—á—ë—Ç–æ–º –¥–µ—Ç–µ–π
            await db.from('crm_deals')
                .update({ group_size: dealData.group_size + formChildren.length })
                .eq('id', deal.id);
        }

        // 7. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
        document.getElementById('applicationForm').classList.add('hidden');
        document.getElementById('successMessage').classList.remove('hidden');

    } catch (error) {
        console.error('Submit error:', error);
        showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
    }
}

async function findOrCreateVaishnava(data) {
    // –ò—â–µ–º –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
    const { data: existing } = await db
        .from('vaishnavas')
        .select('id')
        .eq('phone', data.phone)
        .single();

    if (existing) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        await db.from('vaishnavas')
            .update({
                spiritual_name: data.spiritual_name || undefined,
                last_name: data.last_name || undefined,
                email: data.email || undefined,
                telegram: data.telegram || undefined,
                city: data.city || undefined
            })
            .eq('id', existing.id);
        return existing.id;
    }

    // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ
    const { data: created, error } = await db
        .from('vaishnavas')
        .insert({
            ...data,
            is_guest: true,
            is_deleted: false
        })
        .select('id')
        .single();

    if (error) throw error;
    return created.id;
}

async function getNextManager(retreatId) {
    // –ü–æ–ª—É—á–∞–µ–º –æ—á–µ—Ä–µ–¥—å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –¥–ª—è —Ä–µ—Ç—Ä–∏—Ç–∞
    const { data: queue } = await db
        .from('crm_manager_queue')
        .select('manager_id, current_position')
        .or(`retreat_id.eq.${retreatId},retreat_id.is.null`)
        .eq('is_active', true)
        .order('current_position', { ascending: true })
        .limit(1);

    if (!queue || queue.length === 0) {
        // –ë–µ—Ä—ë–º –ª—é–±–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        const { data: managers } = await db
            .from('crm_manager_queue')
            .select('manager_id')
            .eq('is_active', true)
            .limit(1);

        return managers?.[0]?.manager_id || null;
    }

    const manager = queue[0];

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ –æ—á–µ—Ä–µ–¥–∏
    await db
        .from('crm_manager_queue')
        .update({ current_position: manager.current_position + 1 })
        .eq('manager_id', manager.manager_id);

    return manager.manager_id;
}

// ==================== CHILDREN ====================

let childRowCounter = 0;

function addChildRow() {
    childRowCounter++;
    const container = document.getElementById('childrenRows');
    const row = document.createElement('div');
    row.className = 'flex items-end gap-2 p-3 bg-base-200 rounded-lg';
    row.dataset.childRow = childRowCounter;
    row.innerHTML = `
        <div class="form-control flex-1">
            <label class="label py-0"><span class="label-text text-xs">–ò–º—è *</span></label>
            <input type="text" class="input input-bordered input-sm child-name" required>
        </div>
        <div class="form-control w-36">
            <label class="label py-0"><span class="label-text text-xs">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</span></label>
            <input type="date" class="input input-bordered input-sm child-birth-date">
        </div>
        <div class="form-control w-28">
            <label class="label py-0"><span class="label-text text-xs">–ü–æ–ª</span></label>
            <select class="select select-bordered select-sm child-gender">
                <option value="">‚Äî</option>
                <option value="male">–ú</option>
                <option value="female">–ñ</option>
            </select>
        </div>
        <button type="button" class="btn btn-sm btn-ghost btn-circle text-error" onclick="this.closest('[data-child-row]').remove()">‚úï</button>
    `;
    container.appendChild(row);
}

function getChildrenFromForm() {
    const rows = document.querySelectorAll('[data-child-row]');
    const result = [];
    rows.forEach(row => {
        const name = row.querySelector('.child-name')?.value?.trim();
        if (!name) return;
        result.push({
            first_name: name,
            birth_date: row.querySelector('.child-birth-date')?.value || null,
            gender: row.querySelector('.child-gender')?.value || null
        });
    });
    return result;
}

// ==================== HELPERS ====================
function formatDateRange(start, end) {
    if (!start) return '';
    const s = DateUtils.parseDate(start);
    const e = end ? DateUtils.parseDate(end) : null;

    const months = ['—è–Ω–≤', '—Ñ–µ–≤', '–º–∞—Ä', '–∞–ø—Ä', '–º–∞—è', '–∏—é–Ω', '–∏—é–ª', '–∞–≤–≥', '—Å–µ–Ω', '–æ–∫—Ç', '–Ω–æ—è', '–¥–µ–∫'];

    if (e && s.getMonth() === e.getMonth()) {
        return `${s.getDate()}‚Äì${e.getDate()} ${months[s.getMonth()]}`;
    }

    if (e) {
        return `${s.getDate()} ${months[s.getMonth()]} ‚Äì ${e.getDate()} ${months[e.getMonth()]}`;
    }

    return `${s.getDate()} ${months[s.getMonth()]}`;
}

function formatPrice(amount) {
    if (!amount) return '‚Äî';
    return '‚Çπ' + amount.toLocaleString('ru-RU');
}

function normalizePhone(phone) {
    if (!phone) return null;
    return phone.replace(/[^\d+]/g, '');
}

function countCompanions(text) {
    if (!text) return 0;
    // –°—á–∏—Ç–∞–µ–º –ø–æ –∑–∞–ø—è—Ç—ã–º –∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞–º —Å—Ç—Ä–æ–∫
    return text.split(/[,\n]/).filter(s => s.trim()).length;
}

function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
}

function showError(message) {
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').classList.remove('hidden');
}

function hideError() {
    document.getElementById('errorMessage').classList.add('hidden');
}

// ==================== INIT ====================
async function init() {
    parseUrlParams();
    await loadRetreats();

    document.getElementById('applicationForm').addEventListener('submit', submitForm);
}

init();
</script>

</body>
</html>
