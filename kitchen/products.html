<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script>(function(){var c={kitchen:'#f49800',housing:'#8b5cf6'};var m=localStorage.getItem('srsk_module')||'kitchen';document.documentElement.style.setProperty('--current-color',c[m]||c.kitchen);})();</script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–¥—É–∫—Ç—ã ‚Äî –®–†–°–ö</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        .product-row:hover { background-color: rgba(0,0,0,0.02); }
        .translate-btn {
            padding: 2px 8px;
            font-size: 11px;
            border-radius: 4px;
            background: #e5e7eb;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.15s;
        }
        .translate-btn:hover {
            background: var(--current-color);
            color: white;
        }
        .translate-btn.loading {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 flex-1">

        <!-- Page Title -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold" data-i18n="products_title">–ü—Ä–æ–¥—É–∫—Ç—ã</h1>
                <p class="text-sm opacity-60" id="productsCount">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <button class="btn btn-primary gap-2" onclick="openAddModal()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <span data-i18n="add_product">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</span>
            </button>
        </div>

        <!-- Search -->
        <div class="flex flex-col sm:flex-row gap-4 mb-4">
            <div class="flex-1 max-w-md relative">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." class="input input-bordered w-full pr-10" data-i18n-placeholder="search_placeholder" />
                <button type="button" id="clearSearch" class="absolute right-3 top-1/2 -translate-y-1/2 text-base-content/40 hover:text-base-content hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Category Filters -->
        <div class="flex flex-wrap gap-2 mb-6" id="categoryFilters">
            <div class="skeleton h-8 w-20"></div>
            <div class="skeleton h-8 w-24"></div>
            <div class="skeleton h-8 w-20"></div>
        </div>

        <!-- Products Table -->
        <div class="bg-base-100 rounded-xl shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="table w-full">
                    <thead>
                        <tr class="border-b border-base-200">
                            <th class="bg-base-100 cursor-pointer select-none hover:bg-base-200 transition-colors" onclick="toggleSort('name')">
                                <div class="flex items-center gap-1">
                                    <span data-i18n="col_name">–ù–∞–∑–≤–∞–Ω–∏–µ</span>
                                    <span id="sort-icon-name" class="opacity-40">‚Üï</span>
                                </div>
                            </th>
                            <th class="bg-base-100 hidden sm:table-cell cursor-pointer select-none hover:bg-base-200 transition-colors" onclick="toggleSort('category')">
                                <div class="flex items-center gap-1">
                                    <span data-i18n="col_category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                                    <span id="sort-icon-category" class="opacity-40">‚Üï</span>
                                </div>
                            </th>
                            <th class="bg-base-100 w-24 cursor-pointer select-none hover:bg-base-200 transition-colors" onclick="toggleSort('unit')">
                                <div class="flex items-center gap-1">
                                    <span data-i18n="col_unit">–ï–¥. –∏–∑–º.</span>
                                    <span id="sort-icon-unit" class="opacity-40">‚Üï</span>
                                </div>
                            </th>
                            <th class="bg-base-100 w-20"></th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                        <!-- Skeleton rows -->
                        <tr><td colspan="4"><div class="skeleton h-6 w-full my-2"></div></td></tr>
                        <tr><td colspan="4"><div class="skeleton h-6 w-full my-2"></div></td></tr>
                        <tr><td colspan="4"><div class="skeleton h-6 w-full my-2"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <div id="footer-placeholder"></div>

    <!-- Add/Edit Modal -->
    <dialog id="editModal" class="modal">
        <div class="modal-box relative">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="editModal.close()">‚úï</button>
            <h3 class="font-bold text-lg mb-4" id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h3>
            <form id="editForm" class="space-y-4">
                <input type="hidden" name="id" />

                <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="col_category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span></label>
                    <select name="category_id" class="select select-bordered w-full" required id="categorySelect"></select>
                </div>

                <!-- –†—É—Å—Å–∫–∏–π –∏ English -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="label"><span class="label-text font-medium" data-i18n="col_russian">–†—É—Å—Å–∫–∏–π</span></label>
                        <input type="text" name="name_ru" class="input input-bordered w-full" required placeholder="–†–∏—Å" />
                    </div>
                    <div>
                        <label class="label">
                            <span class="label-text font-medium" data-i18n="col_english">English</span>
                            <button type="button" class="translate-btn" onclick="autoTranslate('name_ru', 'name_en', 'ru', 'en', this)">üåê Auto</button>
                        </label>
                        <input type="text" name="name_en" class="input input-bordered w-full" required placeholder="Rice" />
                    </div>
                </div>

                <!-- –•–∏–Ω–¥–∏ + –¢—Ä–∞–Ω—Å–ª–∏—Ç -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="label">
                            <span class="label-text font-medium" data-i18n="col_hindi">‡§π‡§ø‡§Ç‡§¶‡•Ä</span>
                            <button type="button" class="translate-btn" onclick="autoTranslate('name_ru', 'name_hi', 'ru', 'hi', this)">üåê Auto</button>
                        </label>
                        <input type="text" name="name_hi" id="hindiInput" class="input input-bordered w-full" required placeholder="‡§ö‡§æ‡§µ‡§≤" />
                    </div>
                    <div>
                        <label class="label"><span class="label-text font-medium">IAST</span></label>
                        <input type="text" name="translit" id="translitInput" class="input input-bordered w-full" placeholder="cƒÅval" />
                        <label class="label"><span class="label-text-alt opacity-60">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —Ö–∏–Ω–¥–∏</span></label>
                    </div>
                </div>

                <!-- –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è -->
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="col_unit">–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</span></label>
                    <select name="unit" class="select select-bordered w-full" required id="unitSelect"></select>
                </div>

                <!-- % –Ω–∞ –æ—á–∏—Å—Ç–∫—É (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–≤–æ—â–µ–π –∏ —Ñ—Ä—É–∫—Ç–æ–≤) -->
                <div id="wastePercentField" class="hidden">
                    <label class="label"><span class="label-text font-medium" data-i18n="waste_percent">% –Ω–∞ –æ—á–∏—Å—Ç–∫—É</span></label>
                    <div class="join w-full">
                        <input type="number" name="waste_percent" class="input input-bordered join-item w-full" min="0" max="99" step="1" placeholder="20" />
                        <span class="btn btn-disabled join-item">%</span>
                    </div>
                    <label class="label"><span class="label-text-alt opacity-60" data-i18n="waste_percent_hint">–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç—Ö–æ–¥–æ–≤ –ø—Ä–∏ —á–∏—Å—Ç–∫–µ</span></label>
                </div>

                <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–∫—É–ø–∫—É -->
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="purchase_url">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–∫—É–ø–∫—É</span></label>
                    <input type="url" name="purchase_url" class="input input-bordered w-full" placeholder="https://amazon.in/..." />
                    <label class="label"><span class="label-text-alt opacity-60" data-i18n="purchase_url_hint">Amazon, –º–∞–≥–∞–∑–∏–Ω –∏ —Ç.–¥.</span></label>
                </div>

                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" onclick="editModal.close()" data-i18n="cancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary" data-i18n="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Confirm Modal -->
    <dialog id="confirmModal" class="modal">
        <div class="modal-box max-w-sm">
            <p id="confirmMessage" class="py-4 text-center text-lg"></p>
            <div class="modal-action justify-center gap-2">
                <button type="button" class="btn btn-ghost" onclick="confirmNo()" data-i18n="cancel">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-error" onclick="confirmYes()" data-i18n="delete">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <script src="../js/layout.js"></script>
    <script>
        // ==================== STATE ====================
        let currentCategory = 'all';
        let searchQuery = '';
        let sortColumn = 'name';
        let sortDirection = 'asc';
        let products = [];
        let categories = [];
        let units = [];

        const t = key => Layout.t(key);
        const editForm = () => document.getElementById('editForm');

        // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ "% –Ω–∞ –æ—á–∏—Å—Ç–∫—É"
        const WASTE_CATEGORIES = ['vegetables', 'fruits'];

        // ==================== CONFIRM MODAL ====================
        let confirmResolve = null;

        function showConfirm(message, itemName = '') {
            return new Promise(resolve => {
                confirmResolve = resolve;
                const msgEl = Layout.$('#confirmMessage');
                if (itemName) {
                    msgEl.innerHTML = message + '<br><strong class="text-error">' + itemName + '</strong>';
                } else {
                    msgEl.textContent = message;
                }
                confirmModal.showModal();
            });
        }

        function confirmYes() {
            confirmModal.close();
            if (confirmResolve) confirmResolve(true);
            confirmResolve = null;
        }

        function confirmNo() {
            confirmModal.close();
            if (confirmResolve) confirmResolve(false);
            confirmResolve = null;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª–µ waste_percent –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function toggleWastePercentField(categoryId) {
            const field = Layout.$('#wastePercentField');
            if (!field) return;

            const category = categories.find(c => c.id === categoryId);
            const shouldShow = category && WASTE_CATEGORIES.includes(category.slug);

            field.classList.toggle('hidden', !shouldShow);

            // –ï—Å–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º, –æ—á–∏—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
            if (!shouldShow) {
                const input = Layout.$('input[name="waste_percent"]');
                if (input) input.value = '';
            }
        }

        // ==================== AUTO-TRANSLATE ====================
        async function autoTranslate(fromField, toField, fromLang, toLang, btn) {
            const fromEl = editForm()[fromField];
            const toEl = editForm()[toField];
            if (!fromEl || !toEl) return;

            const text = fromEl.value.trim();
            if (!text) {
                toEl.focus();
                return;
            }

            btn.classList.add('loading');
            btn.textContent = '...';

            try {
                const translated = await Layout.translate(text, fromLang, toLang);
                toEl.value = translated;
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–∞–Ω—Å–ª–∏—Ç –µ—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º –Ω–∞ —Ö–∏–Ω–¥–∏
                if (toField === 'name_hi') {
                    toEl.dispatchEvent(new Event('input'));
                }
            } catch (e) {
                console.error('Translation error:', e);
            }

            btn.classList.remove('loading');
            btn.textContent = 'üåê Auto';
        }

        const PRODUCT_FORMS = {
            ru: ['–ø—Ä–æ–¥—É–∫—Ç', '–ø—Ä–æ–¥—É–∫—Ç–∞', '–ø—Ä–æ–¥—É–∫—Ç–æ–≤'],
            en: ['product', 'products'],
            hi: '‡§â‡§§‡•ç‡§™‡§æ‡§¶'
        };

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—é –∏–∑ layout.js (—É–¥–∞–ª–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ ~130 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞)
        const transliterate = Layout.transliterateHindi;

        // ==================== DATA LOADING ====================
        async function loadCategories() {
            const { data, error } = await Layout.db.from('product_categories').select('*').order('name_ru');
            if (error) { console.error('Error loading categories:', error); return; }
            categories = data;
            renderCategoryFilters();
            renderCategorySelect();
        }

        async function loadUnits() {
            const { data, error } = await Layout.db.from('units').select('*').order('sort_order');
            if (error) { console.error('Error loading units:', error); return; }
            units = data;
            renderUnitSelect();
        }

        async function loadProducts() {
            const { data, error } = await Layout.db
                .from('products')
                .select('*, product_categories(slug, name_ru, name_en, name_hi)')
                .order('name_ru');
            if (error) { console.error('Error loading products:', error); return; }
            products = data;
            renderProducts();
        }

        // ==================== SORTING ====================
        function toggleSort(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            updateSortIcons();
            renderProducts();
        }

        function updateSortIcons() {
            const columns = ['name', 'category', 'unit'];
            columns.forEach(col => {
                const icon = Layout.$(`#sort-icon-${col}`);
                if (!icon) return;
                const isActive = sortColumn === col;
                icon.textContent = isActive ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : '‚Üï';
                icon.classList.toggle('opacity-40', !isActive);
                icon.classList.toggle('opacity-100', isActive);
            });
        }

        function sortProducts(items) {
            const lang = Layout.currentLang;
            const nameKey = `name_${lang}`;
            const mult = sortDirection === 'asc' ? 1 : -1;

            return [...items].sort((a, b) => {
                let cmp = 0;
                switch (sortColumn) {
                    case 'name':
                        cmp = (a[nameKey] || a.name_ru || '').localeCompare(b[nameKey] || b.name_ru || '', lang);
                        break;
                    case 'category':
                        const catA = a.product_categories ? Layout.getName(a.product_categories) : '';
                        const catB = b.product_categories ? Layout.getName(b.product_categories) : '';
                        cmp = catA.localeCompare(catB, lang);
                        break;
                    case 'unit':
                        const unitA = units.find(u => u.code === a.unit);
                        const unitB = units.find(u => u.code === b.unit);
                        const unitNameA = unitA ? Layout.getName(unitA) : a.unit || '';
                        const unitNameB = unitB ? Layout.getName(unitB) : b.unit || '';
                        cmp = unitNameA.localeCompare(unitNameB, lang);
                        break;
                }
                return cmp * mult;
            });
        }

        // ==================== RENDERING ====================
        function renderCategoryFilters() {
            const container = Layout.$('#categoryFilters');
            const counts = { all: products.length };
            products.forEach(p => {
                const slug = p.product_categories?.slug;
                if (slug) counts[slug] = (counts[slug] || 0) + 1;
            });

            let html = `<button class="btn btn-sm filter-btn ${currentCategory === 'all' ? 'active btn-neutral' : 'btn-ghost'}" data-category="all">${t('all')}<sup class="ml-1 opacity-60">${counts.all}</sup></button>`;

            categories.forEach(cat => {
                const isActive = currentCategory === cat.slug;
                html += `<button class="btn btn-sm filter-btn ${isActive ? 'active btn-neutral' : 'btn-ghost'}" data-category="${cat.slug}">${Layout.getName(cat)}<sup class="ml-1 opacity-60">${counts[cat.slug] || 0}</sup></button>`;
            });

            container.innerHTML = html;
            container.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentCategory = btn.dataset.category;
                    renderCategoryFilters();
                    renderProducts();
                });
            });
        }

        function renderCategorySelect() {
            const select = Layout.$('#categorySelect');
            select.innerHTML = categories.map(cat =>
                `<option value="${cat.id}">${Layout.getName(cat)}</option>`
            ).join('');
        }

        function renderUnitSelect() {
            const select = Layout.$('#unitSelect');
            select.innerHTML = units.map(u =>
                `<option value="${u.code}">${Layout.getName(u)} (${u['short_' + Layout.currentLang] || u.short_ru})</option>`
            ).join('');
        }

        function renderProducts() {
            const tbody = Layout.$('#productsTable');
            const countEl = Layout.$('#productsCount');
            const lang = Layout.currentLang;

            let filtered = products.filter(product => {
                const matchesCategory = currentCategory === 'all' || product.product_categories?.slug === currentCategory;
                const matchesSearch = searchQuery === '' ||
                    product.name_ru?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    product.name_en?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    product.name_hi?.includes(searchQuery);
                return matchesCategory && matchesSearch;
            });

            // Apply sorting
            filtered = sortProducts(filtered);

            countEl.textContent = Layout.pluralize(filtered.length, PRODUCT_FORMS);

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-12 opacity-50">
                    <div class="text-4xl mb-2">üì¶</div>
                    <div>${t('no_products') || '–ü—Ä–æ–¥—É–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'}</div>
                </td></tr>`;
                return;
            }

            tbody.innerHTML = filtered.map(product => {
                const cat = product.product_categories;
                const unit = units.find(u => u.code === product.unit);
                const unitShort = unit ? (unit['short_' + lang] || unit.short_ru) : product.unit;

                // –°–æ–±–∏—Ä–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —è–∑—ã–∫–∏ (–≤—Å–µ –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ)
                const otherNames = [];
                if (lang !== 'ru' && product.name_ru) otherNames.push(product.name_ru);
                if (lang !== 'en' && product.name_en) otherNames.push(product.name_en);
                if (lang !== 'hi' && product.name_hi) {
                    otherNames.push(product.name_hi + (product.translit ? ' ¬∑ ' + product.translit : ''));
                }

                return `
                    <tr class="product-row border-b border-base-200" data-id="${product.id}">
                        <td>
                            <div class="flex flex-col desktop:flex-row desktop:items-baseline desktop:gap-4">
                                <div class="font-medium">${Layout.getName(product)}</div>
                                ${otherNames.map(name => `<div class="text-xs desktop:text-base opacity-50">${name}</div>`).join('')}
                            </div>
                        </td>
                        <td class="hidden sm:table-cell">
                            <span class="badge badge border-base-300 whitespace-nowrap">${Layout.getName(cat) || '‚Äî'}</span>
                        </td>
                        <td>
                            <div class="flex items-center gap-2">
                                <span>${unitShort}</span>
                                ${product.waste_percent ? `<span class="badge badge border-base-300 badge-sm" title="${t('waste_percent')}">${product.waste_percent}%</span>` : ''}
                            </div>
                        </td>
                        <td>
                            <div class="flex gap-1">
                                <button class="btn btn-ghost btn-sm btn-square" onclick="openEditModal('${product.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                                <button class="btn btn-ghost btn-sm btn-square text-error" onclick="deleteProduct('${product.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ==================== MODAL ====================
        function openAddModal() {
            Layout.$('#modalTitle').textContent = t('add_product');
            Layout.$('#editForm').reset();
            Layout.$('input[name="id"]').value = '';
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const categorySelect = Layout.$('#categorySelect');
            if (categorySelect && categorySelect.value) {
                toggleWastePercentField(categorySelect.value);
            } else {
                Layout.$('#wastePercentField')?.classList.add('hidden');
            }
            Layout.setupAutoTranslate('#editForm', ['name']);
            editModal.showModal();
        }

        function openEditModal(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            Layout.$('#modalTitle').textContent = t('edit') + ' ‚Äî ' + Layout.getName(product);
            Layout.$('input[name="id"]').value = id;
            Layout.$('select[name="category_id"]').value = product.category_id || '';
            Layout.$('input[name="name_ru"]').value = product.name_ru || '';
            Layout.$('input[name="name_en"]').value = product.name_en || '';
            Layout.$('input[name="name_hi"]').value = product.name_hi || '';
            Layout.$('input[name="translit"]').value = product.translit || '';
            Layout.$('select[name="unit"]').value = product.unit || '';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ waste_percent
            toggleWastePercentField(product.category_id);
            Layout.$('input[name="waste_percent"]').value = product.waste_percent || '';
            Layout.$('input[name="purchase_url"]').value = product.purchase_url || '';

            Layout.setupAutoTranslate('#editForm', ['name']);
            editModal.showModal();
        }

        // ==================== CRUD ====================
        async function saveProduct(formData) {
            const id = formData.get('id');
            const isNew = !id;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å waste_percent
            const categoryId = formData.get('category_id');
            const category = categories.find(c => c.id === categoryId);
            const wastePercentValue = formData.get('waste_percent');
            const shouldSaveWaste = category && WASTE_CATEGORIES.includes(category.slug);

            const purchaseUrl = formData.get('purchase_url')?.trim();
            const productData = {
                category_id: categoryId,
                name_ru: formData.get('name_ru'),
                name_en: formData.get('name_en'),
                name_hi: formData.get('name_hi'),
                translit: formData.get('translit') || null,
                unit: formData.get('unit'),
                waste_percent: shouldSaveWaste && wastePercentValue ? parseFloat(wastePercentValue) : null,
                purchase_url: purchaseUrl || null
            };

            let error;
            if (isNew) {
                const result = await Layout.db.from('products').insert(productData).select('*, product_categories(slug, name_ru, name_en, name_hi)');
                error = result.error;
                if (!error && result.data?.[0]) {
                    products.push(result.data[0]);
                }
            } else {
                const result = await Layout.db.from('products').update(productData).eq('id', id);
                error = result.error;
                if (!error) {
                    const idx = products.findIndex(p => p.id === id);
                    if (idx !== -1) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ, –≤–∫–ª—é—á–∞—è —Å–≤—è–∑–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                        const cat = categories.find(c => c.id === productData.category_id);
                        products[idx] = {
                            ...products[idx],
                            ...productData,
                            product_categories: cat ? { slug: cat.slug, name_ru: cat.name_ru, name_en: cat.name_en, name_hi: cat.name_hi } : null
                        };
                    }
                }
            }

            if (error) {
                alert(t('error') + ': ' + error.message);
                return false;
            }

            renderCategoryFilters();
            renderProducts();
            return true;
        }

        async function deleteProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            const confirmed = await showConfirm(t('confirm_delete'), Layout.getName(product));
            if (!confirmed) return;

            const { error } = await Layout.db.from('products').delete().eq('id', id);
            if (error) {
                alert(t('error') + ': ' + error.message);
                return;
            }

            products = products.filter(p => p.id !== id);
            renderCategoryFilters();
            renderProducts();
        }

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = Layout.$('#searchInput');
            const clearBtn = Layout.$('#clearSearch');
            const debouncedSearch = Layout.debounce(() => renderProducts(), 200);

            searchInput?.addEventListener('input', e => {
                searchQuery = e.target.value;
                clearBtn?.classList.toggle('hidden', !e.target.value);
                debouncedSearch();
            });

            clearBtn?.addEventListener('click', () => {
                searchInput.value = '';
                searchQuery = '';
                clearBtn.classList.add('hidden');
                renderProducts();
                searchInput.focus();
            });

            Layout.$('#editForm')?.addEventListener('submit', async e => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const success = await saveProduct(formData);
                if (success) editModal.close();
            });

            // –ê–≤—Ç–æ—Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è —Ö–∏–Ω–¥–∏ ‚Üí IAST
            Layout.$('#hindiInput')?.addEventListener('input', e => {
                const translitInput = Layout.$('#translitInput');
                if (translitInput) {
                    translitInput.value = transliterate(e.target.value);
                }
            });

            // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –ø–æ–ª—è waste_percent –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            Layout.$('#categorySelect')?.addEventListener('change', e => {
                toggleWastePercentField(e.target.value);
            });
        });

        // ==================== LANGUAGE UPDATE ====================
        function updatePageUI() {
            Layout.updateAllTranslations();
            renderCategoryFilters();
            renderCategorySelect();
            renderUnitSelect();
            updateSortIcons();
            renderProducts();
        }

        window.onLanguageChange = () => updatePageUI();

        // ==================== INIT ====================
        async function init() {
            await Layout.init({ menuId: 'kitchen', itemId: 'products' });
            await Promise.all([loadCategories(), loadUnits()]);
            await loadProducts();
            updatePageUI();
        }

        init();
    </script>
</body>
</html>
