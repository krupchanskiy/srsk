<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script src="../js/color-init.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ—Ü–µ–ø—Ç—ã ‚Äî –®–†–°–ö</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        /* –°—Ç–∏–ª–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–µ—Ü–µ–ø—Ç–æ–≤ */
        .recipe-card { transition: all 0.2s ease; }
        .recipe-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px -5px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <!-- –•–µ–¥–µ—Ä (–≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∏–∑ layout.js) -->
    <div id="header-placeholder"></div>

    <!-- ==================== MAIN CONTENT ==================== -->
    <main class="container mx-auto px-4 py-6 flex-1">

        <!-- Page Title -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold" data-i18n="recipes_title">–†–µ—Ü–µ–ø—Ç—ã</h1>
                <p class="text-sm opacity-60" id="recipesCount">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <button class="btn btn-primary gap-2" onclick="window.location.href='recipe-edit.html'">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <span data-i18n="add_recipe">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç</span>
            </button>
        </div>

        <!-- Search + Sort + Toggle -->
        <div class="flex flex-col sm:flex-row gap-4 mb-4">
            <div class="flex-1 max-w-md relative">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." class="input input-bordered w-full pr-10" data-i18n-placeholder="search_placeholder" />
                <button type="button" id="clearSearch" class="absolute right-3 top-1/2 -translate-y-1/2 text-base-content/40 hover:text-base-content hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="flex items-center gap-1">
                <span class="text-sm opacity-60 mr-1" data-i18n="sort_by">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</span>
                <button class="btn btn-sm btn-ghost sort-btn" data-sort="name" onclick="toggleSort('name')">
                    <span data-i18n="col_name">–ù–∞–∑–≤–∞–Ω–∏–µ</span>
                    <span id="sort-icon-name" class="opacity-40">‚Üï</span>
                </button>
                <button class="btn btn-sm btn-ghost sort-btn" data-sort="category" onclick="toggleSort('category')">
                    <span data-i18n="col_category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                    <span id="sort-icon-category" class="opacity-40">‚Üï</span>
                </button>
                <button class="btn btn-sm btn-ghost sort-btn" data-sort="time" onclick="toggleSort('time')">
                    <span data-i18n="cooking_time">–í—Ä–µ–º—è</span>
                    <span id="sort-icon-time" class="opacity-40">‚Üï</span>
                </button>
            </div>
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="showPhotosToggle" class="toggle toggle-primary toggle-sm" checked />
                <span class="text-sm" data-i18n="show_photos">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ñ–æ—Ç–æ</span>
            </label>
        </div>

        <!-- Category Filters -->
        <div class="flex flex-wrap gap-2 mb-6" id="categoryFilters">
            <div class="skeleton h-8 w-20"></div>
            <div class="skeleton h-8 w-24"></div>
            <div class="skeleton h-8 w-20"></div>
            <div class="skeleton h-8 w-24"></div>
        </div>

        <!-- Recipes Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="recipesGrid">
            <!-- Skeleton cards -->
            <div class="card bg-base-100 shadow-md skeleton-card"><div class="skeleton h-32 w-full"></div><div class="card-body p-4"><div class="skeleton h-4 w-16 mb-2"></div><div class="skeleton h-6 w-full mb-1"></div><div class="skeleton h-3 w-3/4"></div></div></div>
            <div class="card bg-base-100 shadow-md skeleton-card"><div class="skeleton h-32 w-full"></div><div class="card-body p-4"><div class="skeleton h-4 w-16 mb-2"></div><div class="skeleton h-6 w-full mb-1"></div><div class="skeleton h-3 w-3/4"></div></div></div>
            <div class="card bg-base-100 shadow-md skeleton-card"><div class="skeleton h-32 w-full"></div><div class="card-body p-4"><div class="skeleton h-4 w-16 mb-2"></div><div class="skeleton h-6 w-full mb-1"></div><div class="skeleton h-3 w-3/4"></div></div></div>
            <div class="card bg-base-100 shadow-md skeleton-card"><div class="skeleton h-32 w-full"></div><div class="card-body p-4"><div class="skeleton h-4 w-16 mb-2"></div><div class="skeleton h-6 w-full mb-1"></div><div class="skeleton h-3 w-3/4"></div></div></div>
        </div>

        <!-- Pagination -->
        <div id="paginationContainer"></div>

    </main>

    <!-- –§—É—Ç–µ—Ä (–≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∏–∑ layout.js) -->
    <div id="footer-placeholder"></div>

    <script src="../js/config.js"></script>
    <script src="../js/auth-check.js?v=3"></script>
    <script src="../js/cache.js"></script>
    <script src="../js/utils.js?v=2"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/layout.js?v=5"></script>
    <script>
        // ==================== STATE ====================
        const PAGE_SIZE = 50;
        let currentCategory = localStorage.getItem('recipes_category') || 'all';
        let searchQuery = '';
        let showPhotos = true;
        let sortColumn = 'name';
        let sortDirection = 'asc';
        let recipes = [];
        let categories = [];
        let units = [];
        let locationId = null;
        let totalCount = 0;
        let currentPage = 1;

        // –ê–ª–∏–∞—Å—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
        const t = key => Layout.t(key);

        // –ü–æ–ª—É—á–∏—Ç—å –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü—ã
        function getUnitShort(code) {
            const unit = units.find(u => u.code === code);
            if (!unit) return code || '';
            return unit[`short_${Layout.currentLang}`] || unit.short_ru || code;
        }

        // –§–æ—Ä–º—ã —Å–∫–ª–æ–Ω–µ–Ω–∏—è –¥–ª—è —Å—á—ë—Ç—á–∏–∫–æ–≤
        const RECIPE_FORMS = {
            ru: ['—Ä–µ—Ü–µ–ø—Ç', '—Ä–µ—Ü–µ–ø—Ç–∞', '—Ä–µ—Ü–µ–ø—Ç–æ–≤'],
            en: ['recipe', 'recipes'],
            hi: '‡§µ‡•ç‡§Ø‡§Ç‡§ú‡§®'
        };

        // ==================== DATA LOADING ====================
        async function loadLocationId() {
            const { data } = await Layout.db
                .from('locations')
                .select('id')
                .eq('slug', Layout.currentLocation)
                .single();
            locationId = data?.id;
        }

        async function loadCategories() {
            categories = await Cache.getOrLoad('recipe_categories', async () => {
                const { data, error } = await Layout.db.from('recipe_categories').select('*').order('name_ru');
                if (error) { console.error('Error loading categories:', error); return null; }
                return data;
            });
            categories = categories || [];
        }

        async function loadUnits() {
            units = await Cache.getOrLoad('units', async () => {
                const { data, error } = await Layout.db.from('units').select('*').order('sort_order');
                if (error) { console.error('Error loading units:', error); return null; }
                return data;
            });
            units = units || [];
        }

        async function loadRecipes() {
            let query = Layout.db
                .from('recipes')
                .select('*, recipe_categories(slug, name_ru, name_en, name_hi, color, emoji)', { count: 'exact' });

            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ª–æ–∫–∞—Ü–∏–∏
            if (locationId) {
                query = query.eq('location_id', locationId);
            }

            // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Å–µ—Ä–≤–µ—Ä–Ω—ã–π)
            if (currentCategory !== 'all') {
                const cat = categories.find(c => c.slug === currentCategory);
                if (cat) {
                    query = query.eq('category_id', cat.id);
                }
            }

            // –°–µ—Ä–≤–µ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
            if (searchQuery) {
                const q = `%${searchQuery}%`;
                query = query.or(`name_ru.ilike.${q},name_en.ilike.${q},name_hi.ilike.${q}`);
            }

            // –°–µ—Ä–≤–µ—Ä–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            const SORT_MAP = { name: 'name_ru', category: 'category_id', time: 'cooking_time' };
            const dbField = SORT_MAP[sortColumn] || 'name_ru';
            query = query.order(dbField, { ascending: sortDirection === 'asc' });

            // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
            const from = (currentPage - 1) * PAGE_SIZE;
            const to = from + PAGE_SIZE - 1;
            query = query.range(from, to);

            const { data, error, count } = await query;
            if (error) { console.error('Error loading recipes:', error); return; }
            recipes = data || [];
            totalCount = count || 0;
            renderRecipes();
            renderCategoryFilters();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—á—ë—Ç—á–∏–∫–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        async function loadCategoryCounts() {
            let baseQuery = Layout.db.from('recipes').select('category_id');
            if (locationId) baseQuery = baseQuery.eq('location_id', locationId);
            if (searchQuery) {
                const q = `%${searchQuery}%`;
                baseQuery = baseQuery.or(`name_ru.ilike.${q},name_en.ilike.${q},name_hi.ilike.${q}`);
            }
            const { data } = await baseQuery;
            const counts = { all: (data || []).length };
            (data || []).forEach(r => {
                const cat = categories.find(c => c.id === r.category_id);
                if (cat) counts[cat.slug] = (counts[cat.slug] || 0) + 1;
            });
            return counts;
        }

        // ==================== SORTING ====================
        function toggleSort(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            updateSortIcons();
            currentPage = 1;
            loadRecipes();
        }

        function updateSortIcons() {
            const columns = ['name', 'category', 'time'];
            columns.forEach(col => {
                const icon = Layout.$(`#sort-icon-${col}`);
                if (!icon) return;
                const isActive = sortColumn === col;
                icon.textContent = isActive ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : '‚Üï';
                icon.classList.toggle('opacity-40', !isActive);
                icon.classList.toggle('opacity-100', isActive);
            });
        }

        // ==================== RENDERING ====================
        async function renderCategoryFilters() {
            const container = Layout.$('#categoryFilters');
            const counts = await loadCategoryCounts();

            let html = `<button class="btn btn-sm filter-btn ${currentCategory === 'all' ? 'active btn-neutral' : 'btn-ghost'}" data-category="all">${t('all')}<sup class="ml-1 opacity-60">${counts.all}</sup></button>`;

            categories.forEach(cat => {
                const isActive = currentCategory === cat.slug;
                html += `<button class="btn btn-sm filter-btn ${isActive ? 'active' : 'btn-ghost'}" data-category="${cat.slug}" style="${isActive ? `background-color: ${cat.color}; border-color: ${cat.color};` : ''}">${cat.emoji} ${Layout.getName(cat)}<sup class="ml-1 opacity-60">${counts[cat.slug] || 0}</sup></button>`;
            });

            container.innerHTML = html;
            container.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentCategory = btn.dataset.category;
                    localStorage.setItem('recipes_category', currentCategory);
                    currentPage = 1;
                    loadRecipes();
                });
            });
        }

        function renderRecipes() {
            const grid = Layout.$('#recipesGrid');
            const countEl = Layout.$('#recipesCount');
            const lang = Layout.currentLang;

            countEl.textContent = Layout.pluralize(totalCount, RECIPE_FORMS);

            if (recipes.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-12 opacity-50"><div class="text-4xl mb-2">üçΩÔ∏è</div><div>${t('no_recipes')}</div></div>`;
                document.getElementById('paginationContainer').innerHTML = '';
                return;
            }

            grid.innerHTML = recipes.map(recipe => {
                const cat = recipe.recipe_categories;
                const secondaryLang = lang === 'ru' ? 'en' : 'ru';
                const unitOutput = getUnitShort(recipe.output_unit);
                const unitPortion = getUnitShort(recipe.portion_unit);

                const photoHtml = showPhotos ? `
                    <figure class="h-32 bg-base-200 overflow-hidden">
                        ${recipe.photo_url
                            ? `<img src="${recipe.photo_url}" alt="${Layout.getName(recipe)}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'h-full w-full flex items-center justify-center text-4xl\\'>${cat?.emoji || 'üçΩÔ∏è'}</div>'" />`
                            : `<div class="h-full w-full flex items-center justify-center text-4xl">${cat?.emoji || 'üçΩÔ∏è'}</div>`
                        }
                    </figure>
                ` : '';

                return `
                    <div class="card bg-base-100 shadow-md recipe-card cursor-pointer hover:shadow-lg" onclick="openRecipe('${recipe.id}')">
                        ${photoHtml}
                        <div class="card-body p-4">
                            <div class="flex justify-between items-start mb-1">
                                <span class="category-badge badge text-white" style="background-color: ${cat?.color || '#999'}">${Layout.getName(cat) || '‚Äî'}</span>
                                ${recipe.cooking_time ? `<span class="text-xs opacity-50">${recipe.cooking_time} ${t('minutes')}</span>` : ''}
                            </div>
                            <h3 class="card-title text-base leading-tight mb-0">${Layout.getName(recipe)}</h3>
                            <p class="sub-text">${recipe[`name_${secondaryLang}`] || ''}</p>
                            ${lang !== 'hi' && (recipe.name_hi || recipe.translit) ? `<p class="sub-text">${[recipe.name_hi, recipe.translit].filter(Boolean).join(' ¬∑ ')}</p>` : ''}
                            ${recipe.output_amount || recipe.portion_amount ? `
                            <div class="flex gap-4 mt-2 text-sm">
                                ${recipe.output_amount ? `<div><span class="opacity-50">${t('output')}:</span> <span class="font-medium">${recipe.output_amount} ${unitOutput}</span></div>` : ''}
                                ${recipe.portion_amount ? `<div><span class="opacity-50">${t('portion')}:</span> <span class="font-medium">${recipe.portion_amount} ${unitPortion}</span></div>` : ''}
                            </div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
            renderRecipesPagination();
        }

        function renderRecipesPagination() {
            const container = document.getElementById('paginationContainer');
            const totalPages = Math.ceil(totalCount / PAGE_SIZE);
            if (totalPages <= 1) { container.innerHTML = ''; return; }

            let html = '<div class="flex justify-center py-4"><div class="join">';
            html += `<button class="join-item btn btn-sm ${currentPage <= 1 ? 'btn-disabled' : ''}" data-page="${currentPage - 1}">&laquo;</button>`;

            const maxVisible = 7;
            let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let end = Math.min(totalPages, start + maxVisible - 1);
            if (end - start < maxVisible - 1) start = Math.max(1, end - maxVisible + 1);

            if (start > 1) {
                html += `<button class="join-item btn btn-sm" data-page="1">1</button>`;
                if (start > 2) html += `<button class="join-item btn btn-sm btn-disabled">...</button>`;
            }
            for (let i = start; i <= end; i++) {
                html += `<button class="join-item btn btn-sm ${i === currentPage ? 'btn-active' : ''}" data-page="${i}">${i}</button>`;
            }
            if (end < totalPages) {
                if (end < totalPages - 1) html += `<button class="join-item btn btn-sm btn-disabled">...</button>`;
                html += `<button class="join-item btn btn-sm" data-page="${totalPages}">${totalPages}</button>`;
            }

            html += `<button class="join-item btn btn-sm ${currentPage >= totalPages ? 'btn-disabled' : ''}" data-page="${currentPage + 1}">&raquo;</button>`;
            html += '</div></div>';
            container.innerHTML = html;

            container.querySelectorAll('[data-page]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const p = parseInt(btn.dataset.page);
                    if (p >= 1 && p <= totalPages && p !== currentPage) {
                        currentPage = p;
                        loadRecipes();
                        document.getElementById('recipesGrid').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });
        }

        function updatePageLanguage() {
            Layout.updateAllTranslations();
            updateSortIcons();
            loadRecipes();
        }

        function openRecipe(id) {
            window.location.href = `recipe.html?id=${id}`;
        }

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = Layout.$('#searchInput');
            const clearBtn = Layout.$('#clearSearch');
            const debouncedSearch = Layout.debounce(() => {
                currentPage = 1;
                loadRecipes();
            }, 300);

            searchInput?.addEventListener('input', e => {
                searchQuery = e.target.value.trim();
                clearBtn?.classList.toggle('hidden', !searchQuery);
                debouncedSearch();
            });

            clearBtn?.addEventListener('click', () => {
                searchInput.value = '';
                searchQuery = '';
                clearBtn.classList.add('hidden');
                currentPage = 1;
                loadRecipes();
                searchInput.focus();
            });

            // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ñ–æ—Ç–æ
            Layout.$('#showPhotosToggle')?.addEventListener('change', e => {
                showPhotos = e.target.checked;
                renderRecipes();
            });
        });

        // –ö–æ–ª–±—ç–∫ –ø—Ä–∏ —Å–º–µ–Ω–µ —è–∑—ã–∫–∞
        window.onLanguageChange = function(lang) {
            updatePageLanguage();
        };

        // –ö–æ–ª–±—ç–∫ –ø—Ä–∏ —Å–º–µ–Ω–µ –ª–æ–∫–∞—Ü–∏–∏
        window.onLocationChange = async function() {
            await loadLocationId();
            currentPage = 1;
            await loadRecipes();
        };

        // ==================== INIT ====================
        async function init() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º layout (—Ö–µ–¥–µ—Ä, —Ñ—É—Ç–µ—Ä, –ª–æ–∫–∞—Ü–∏–∏)
            await Layout.init({ module: 'kitchen', menuId: 'kitchen', itemId: 'recipes' });

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            await loadLocationId();
            await Promise.all([loadUnits(), loadCategories()]);
            await loadRecipes();
            updateSortIcons();
        }

        init();
    </script>
</body>
</html>
