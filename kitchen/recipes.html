<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script>(function(){var c={kitchen:'#f49800',housing:'#8b5cf6'};var m=localStorage.getItem('srsk_module')||'kitchen';document.documentElement.style.setProperty('--current-color',c[m]||c.kitchen);})();</script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ—Ü–µ–ø—Ç—ã ‚Äî –®–†–°–ö</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        /* –°—Ç–∏–ª–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–µ—Ü–µ–ø—Ç–æ–≤ */
        .recipe-card { transition: all 0.2s ease; }
        .recipe-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px -5px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <!-- –•–µ–¥–µ—Ä (–≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∏–∑ layout.js) -->
    <div id="header-placeholder"></div>

    <!-- ==================== MAIN CONTENT ==================== -->
    <main class="container mx-auto px-4 py-6 flex-1">

        <!-- Page Title -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold" data-i18n="recipes_title">–†–µ—Ü–µ–ø—Ç—ã</h1>
                <p class="text-sm opacity-60" id="recipesCount">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <button class="btn btn-primary gap-2" onclick="window.location.href='recipe-edit.html'">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <span data-i18n="add_recipe">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç</span>
            </button>
        </div>

        <!-- Search + Sort + Toggle -->
        <div class="flex flex-col sm:flex-row gap-4 mb-4">
            <div class="flex-1 max-w-md relative">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." class="input input-bordered w-full pr-10" data-i18n-placeholder="search_placeholder" />
                <button type="button" id="clearSearch" class="absolute right-3 top-1/2 -translate-y-1/2 text-base-content/40 hover:text-base-content hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="flex items-center gap-1">
                <span class="text-sm opacity-60 mr-1" data-i18n="sort_by">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</span>
                <button class="btn btn-sm btn-ghost sort-btn" data-sort="name" onclick="toggleSort('name')">
                    <span data-i18n="col_name">–ù–∞–∑–≤–∞–Ω–∏–µ</span>
                    <span id="sort-icon-name" class="opacity-40">‚Üï</span>
                </button>
                <button class="btn btn-sm btn-ghost sort-btn" data-sort="category" onclick="toggleSort('category')">
                    <span data-i18n="col_category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                    <span id="sort-icon-category" class="opacity-40">‚Üï</span>
                </button>
                <button class="btn btn-sm btn-ghost sort-btn" data-sort="time" onclick="toggleSort('time')">
                    <span data-i18n="cooking_time">–í—Ä–µ–º—è</span>
                    <span id="sort-icon-time" class="opacity-40">‚Üï</span>
                </button>
            </div>
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="showPhotosToggle" class="toggle toggle-primary toggle-sm" checked />
                <span class="text-sm" data-i18n="show_photos">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ñ–æ—Ç–æ</span>
            </label>
        </div>

        <!-- Category Filters -->
        <div class="flex flex-wrap gap-2 mb-6" id="categoryFilters">
            <div class="skeleton h-8 w-20"></div>
            <div class="skeleton h-8 w-24"></div>
            <div class="skeleton h-8 w-20"></div>
            <div class="skeleton h-8 w-24"></div>
        </div>

        <!-- Recipes Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="recipesGrid">
            <!-- Skeleton cards -->
            <div class="card bg-base-100 shadow-md skeleton-card"><div class="skeleton h-32 w-full"></div><div class="card-body p-4"><div class="skeleton h-4 w-16 mb-2"></div><div class="skeleton h-6 w-full mb-1"></div><div class="skeleton h-3 w-3/4"></div></div></div>
            <div class="card bg-base-100 shadow-md skeleton-card"><div class="skeleton h-32 w-full"></div><div class="card-body p-4"><div class="skeleton h-4 w-16 mb-2"></div><div class="skeleton h-6 w-full mb-1"></div><div class="skeleton h-3 w-3/4"></div></div></div>
            <div class="card bg-base-100 shadow-md skeleton-card"><div class="skeleton h-32 w-full"></div><div class="card-body p-4"><div class="skeleton h-4 w-16 mb-2"></div><div class="skeleton h-6 w-full mb-1"></div><div class="skeleton h-3 w-3/4"></div></div></div>
            <div class="card bg-base-100 shadow-md skeleton-card"><div class="skeleton h-32 w-full"></div><div class="card-body p-4"><div class="skeleton h-4 w-16 mb-2"></div><div class="skeleton h-6 w-full mb-1"></div><div class="skeleton h-3 w-3/4"></div></div></div>
        </div>

    </main>

    <!-- –§—É—Ç–µ—Ä (–≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∏–∑ layout.js) -->
    <div id="footer-placeholder"></div>

    <script src="../js/layout.js"></script>
    <script>
        // ==================== STATE ====================
        let currentCategory = localStorage.getItem('recipes_category') || 'all';
        let searchQuery = '';
        let showPhotos = true;
        let sortColumn = 'name';
        let sortDirection = 'asc';
        let recipes = [];
        let categories = [];
        let units = [];
        let locationId = null;

        // –ê–ª–∏–∞—Å—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
        const t = key => Layout.t(key);

        // –ü–æ–ª—É—á–∏—Ç—å –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü—ã
        function getUnitShort(code) {
            const unit = units.find(u => u.code === code);
            if (!unit) return code || '';
            return unit[`short_${Layout.currentLang}`] || unit.short_ru || code;
        }

        // –§–æ—Ä–º—ã —Å–∫–ª–æ–Ω–µ–Ω–∏—è –¥–ª—è —Å—á—ë—Ç—á–∏–∫–æ–≤
        const RECIPE_FORMS = {
            ru: ['—Ä–µ—Ü–µ–ø—Ç', '—Ä–µ—Ü–µ–ø—Ç–∞', '—Ä–µ—Ü–µ–ø—Ç–æ–≤'],
            en: ['recipe', 'recipes'],
            hi: '‡§µ‡•ç‡§Ø‡§Ç‡§ú‡§®'
        };

        // ==================== DATA LOADING ====================
        async function loadLocationId() {
            const { data } = await Layout.db
                .from('locations')
                .select('id')
                .eq('slug', Layout.currentLocation)
                .single();
            locationId = data?.id;
        }

        async function loadCategories() {
            const { data, error } = await Layout.db.from('recipe_categories').select('*').order('name_ru');
            if (error) { console.error('Error loading categories:', error); return; }
            categories = data;
            renderCategoryFilters();
        }

        async function loadRecipes() {
            let query = Layout.db
                .from('recipes')
                .select('*, recipe_categories(slug, name_ru, name_en, name_hi, color, emoji)')
                .order('name_ru');

            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ª–æ–∫–∞—Ü–∏–∏, –µ—Å–ª–∏ location_id —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
            if (locationId) {
                query = query.eq('location_id', locationId);
            }

            const { data, error } = await query;
            if (error) { console.error('Error loading recipes:', error); return; }
            recipes = data;
            renderRecipes();
        }

        async function loadUnits() {
            const { data, error } = await Layout.db.from('units').select('*').order('sort_order');
            if (error) { console.error('Error loading units:', error); return; }
            units = data || [];
        }

        // ==================== SORTING ====================
        function toggleSort(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            updateSortIcons();
            renderRecipes();
        }

        function updateSortIcons() {
            const columns = ['name', 'category', 'time'];
            columns.forEach(col => {
                const icon = Layout.$(`#sort-icon-${col}`);
                if (!icon) return;
                const isActive = sortColumn === col;
                icon.textContent = isActive ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : '‚Üï';
                icon.classList.toggle('opacity-40', !isActive);
                icon.classList.toggle('opacity-100', isActive);
            });
        }

        function sortRecipes(items) {
            const lang = Layout.currentLang;
            const nameKey = `name_${lang}`;
            const mult = sortDirection === 'asc' ? 1 : -1;

            return [...items].sort((a, b) => {
                let cmp = 0;
                switch (sortColumn) {
                    case 'name':
                        cmp = (a[nameKey] || a.name_ru || '').localeCompare(b[nameKey] || b.name_ru || '', lang);
                        break;
                    case 'category':
                        const catA = a.recipe_categories ? Layout.getName(a.recipe_categories) : '';
                        const catB = b.recipe_categories ? Layout.getName(b.recipe_categories) : '';
                        cmp = catA.localeCompare(catB, lang);
                        break;
                    case 'time':
                        cmp = (a.cooking_time || 0) - (b.cooking_time || 0);
                        break;
                }
                return cmp * mult;
            });
        }

        // ==================== RENDERING ====================
        function renderCategoryFilters() {
            const container = Layout.$('#categoryFilters');
            const counts = { all: recipes.length };
            recipes.forEach(r => {
                const slug = r.recipe_categories?.slug;
                if (slug) counts[slug] = (counts[slug] || 0) + 1;
            });

            let html = `<button class="btn btn-sm filter-btn ${currentCategory === 'all' ? 'active btn-neutral' : 'btn-ghost'}" data-category="all">${t('all')}<sup class="ml-1 opacity-60">${counts.all}</sup></button>`;

            categories.forEach(cat => {
                const isActive = currentCategory === cat.slug;
                html += `<button class="btn btn-sm filter-btn ${isActive ? 'active' : 'btn-ghost'}" data-category="${cat.slug}" style="${isActive ? `background-color: ${cat.color}; border-color: ${cat.color};` : ''}">${cat.emoji} ${Layout.getName(cat)}<sup class="ml-1 opacity-60">${counts[cat.slug] || 0}</sup></button>`;
            });

            container.innerHTML = html;
            container.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentCategory = btn.dataset.category;
                    localStorage.setItem('recipes_category', currentCategory);
                    renderCategoryFilters();
                    renderRecipes();
                });
            });
        }

        function renderRecipes() {
            const grid = Layout.$('#recipesGrid');
            const countEl = Layout.$('#recipesCount');
            const lang = Layout.currentLang;

            let filtered = recipes.filter(recipe => {
                const matchesCategory = currentCategory === 'all' || recipe.recipe_categories?.slug === currentCategory;
                const matchesSearch = searchQuery === '' ||
                    recipe.name_ru.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    recipe.name_en.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    recipe.name_hi.includes(searchQuery);
                return matchesCategory && matchesSearch;
            });

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
            filtered = sortRecipes(filtered);

            countEl.textContent = Layout.pluralize(filtered.length, RECIPE_FORMS);

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-12 opacity-50"><div class="text-4xl mb-2">üçΩÔ∏è</div><div>${t('no_recipes')}</div></div>`;
                return;
            }

            grid.innerHTML = filtered.map(recipe => {
                const cat = recipe.recipe_categories;
                const secondaryLang = lang === 'ru' ? 'en' : 'ru';
                const unitOutput = getUnitShort(recipe.output_unit);
                const unitPortion = getUnitShort(recipe.portion_unit);

                const photoHtml = showPhotos ? `
                    <figure class="h-32 bg-base-200 overflow-hidden">
                        <img src="${recipe.photo_url}" alt="${Layout.getName(recipe)}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'h-full w-full flex items-center justify-center text-4xl\\'>${cat?.emoji || 'üçΩÔ∏è'}</div>'" />
                    </figure>
                ` : '';

                return `
                    <div class="card bg-base-100 shadow-md recipe-card cursor-pointer hover:shadow-lg" onclick="openRecipe('${recipe.id}')">
                        ${photoHtml}
                        <div class="card-body p-4">
                            <div class="flex justify-between items-start mb-1">
                                <span class="category-badge badge text-white" style="background-color: ${cat?.color || '#999'}">${Layout.getName(cat) || '‚Äî'}</span>
                                ${recipe.cooking_time ? `<span class="text-xs opacity-50">${recipe.cooking_time} ${t('minutes')}</span>` : ''}
                            </div>
                            <h3 class="card-title text-base leading-tight mb-0">${Layout.getName(recipe)}</h3>
                            <p class="sub-text">${recipe[`name_${secondaryLang}`] || ''}</p>
                            ${lang !== 'hi' && (recipe.name_hi || recipe.translit) ? `<p class="sub-text">${[recipe.name_hi, recipe.translit].filter(Boolean).join(' ¬∑ ')}</p>` : ''}
                            ${recipe.output_amount || recipe.portion_amount ? `
                            <div class="flex gap-4 mt-2 text-sm">
                                ${recipe.output_amount ? `<div><span class="opacity-50">${t('output')}:</span> <span class="font-medium">${recipe.output_amount} ${unitOutput}</span></div>` : ''}
                                ${recipe.portion_amount ? `<div><span class="opacity-50">${t('portion')}:</span> <span class="font-medium">${recipe.portion_amount} ${unitPortion}</span></div>` : ''}
                            </div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updatePageLanguage() {
            Layout.updateAllTranslations();
            renderCategoryFilters();
            updateSortIcons();
            renderRecipes();
        }

        function openRecipe(id) {
            window.location.href = `recipe.html?id=${id}`;
        }

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = Layout.$('#searchInput');
            const clearBtn = Layout.$('#clearSearch');
            const debouncedSearch = Layout.debounce(() => renderRecipes(), 200);

            searchInput?.addEventListener('input', e => {
                searchQuery = e.target.value;
                clearBtn?.classList.toggle('hidden', !e.target.value);
                debouncedSearch();
            });

            clearBtn?.addEventListener('click', () => {
                searchInput.value = '';
                searchQuery = '';
                clearBtn.classList.add('hidden');
                renderRecipes();
                searchInput.focus();
            });

            // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ñ–æ—Ç–æ
            Layout.$('#showPhotosToggle')?.addEventListener('change', e => {
                showPhotos = e.target.checked;
                renderRecipes();
            });
        });

        // –ö–æ–ª–±—ç–∫ –ø—Ä–∏ —Å–º–µ–Ω–µ —è–∑—ã–∫–∞
        window.onLanguageChange = function(lang) {
            updatePageLanguage();
        };

        // –ö–æ–ª–±—ç–∫ –ø—Ä–∏ —Å–º–µ–Ω–µ –ª–æ–∫–∞—Ü–∏–∏
        window.onLocationChange = async function() {
            await loadLocationId();
            await loadRecipes();
            renderCategoryFilters();
        };

        // ==================== INIT ====================
        async function init() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º layout (—Ö–µ–¥–µ—Ä, —Ñ—É—Ç–µ—Ä, –ª–æ–∫–∞—Ü–∏–∏)
            await Layout.init({ menuId: 'kitchen', itemId: 'recipes' });

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            await loadLocationId();
            await loadUnits();
            await loadCategories();
            await loadRecipes();
            updatePageLanguage();
        }

        init();
    </script>
</body>
</html>
