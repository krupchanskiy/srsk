# ШРСК — Техническая архитектура

> Эволюционное развитие на текущем стеке (Vanilla JS + Supabase)

**Версия:** 2.0
**Дата:** 31 января 2026

---

## Текущее состояние

**ШРСК — рабочая production-система**, а не прототип:

| Метрика | Значение |
|---------|----------|
| HTML страниц | 78 |
| SQL миграций | 107+ |
| Таблиц БД | 40+ |
| RLS политик | 82 (после консолидации) |
| JS файлов | 30 (~18,700 строк) |
| Модулей | 4 (Kitchen, Housing, CRM, Admin) |
| Языки | 3 (RU/EN/HI) |

---

## Текущий стек

### Frontend

| Компонент | Технология | Статус |
|-----------|------------|--------|
| **UI Framework** | Vanilla JS | Работает |
| **Components** | DaisyUI 4.x | Работает |
| **Styling** | Tailwind CSS (CDN) | Работает |
| **Icons** | Lucide Icons (strokeWidth: 1.25) | Работает |
| **Fonts** | Noto Sans + Noto Sans Devanagari | Работает |

### Backend (Supabase)

| Компонент | Технология | Статус |
|-----------|------------|--------|
| **Database** | PostgreSQL | Работает |
| **Auth** | Supabase Auth | Работает |
| **Storage** | Supabase Storage | Работает |
| **RLS** | Row Level Security | ✅ Консолидировано (82 политики) |
| **Realtime** | Supabase Realtime | ✅ Работает (timeline, preliminary, stock) |
| **Edge Functions** | Deno | Частично (send-invite) |

### Deployment

| Компонент | Технология |
|-----------|------------|
| **Hosting** | GitHub Pages |
| **CI/CD** | Auto-deploy from main |
| **Domain** | in.rupaseva.com |

---

## Архитектурные паттерны (что работает)

### 1. Layout.js — единая точка входа

```javascript
// Каждая страница инициализируется одинаково
await Layout.init({ module: 'housing', menuId: 'housing', itemId: 'timeline' });
```

Предоставляет:
- `Layout.db` — Supabase клиент
- `Layout.t(key)` — i18n переводы
- `Layout.getName(obj)` — локализованные имена
- `Layout.handleError()` — единая обработка ошибок
- `Layout.showNotification()` — toast-уведомления
- `Layout.showLoader()` / `hideLoader()` — прелоадер

### 2. Cache.js — клиентское кэширование

```javascript
const translations = await Cache.getOrLoad('translations', loadFromDB, TTL);
Cache.invalidate('translations'); // Сброс кэша
```

### 3. i18n через атрибуты

```html
<span data-i18n="nav_menu">Меню</span>
<input data-i18n-placeholder="search_placeholder">
```

### 4. Цвет модуля через CSS-переменную

```css
:root { --current-color: #f49800; } /* Kitchen */
:root { --current-color: #8b5cf6; } /* Housing */
```

### 5. XSS защита

```javascript
Layout.escapeHtml(userInput);
Utils.isValidColor(color); // Валидация перед style
```

---

## Технический долг

### ✅ Решено: RLS консолидация (февраль 2026)

**Было:** 163 RLS политики, хаос из-за итераций над авторизацией.

**Стало:** 82 политики после консолидации:
- 47 таблиц: 1 политика (ALL)
- 12 таблиц: 2 политики (ALL + SELECT для public)
- 4 таблицы с особыми правилами (vaishnavas, profiles, translations, price_history)
- Таблица `superusers` без RLS для избежания рекурсии

### ✅ Решено: Разделение HTML и JS (февраль 2026)

**Было:** Монолитные HTML файлы (timeline.html 2,600+ строк).

**Стало:** Логика вынесена в `js/pages/`:
- `timeline.js` (~84KB)
- `preliminary.js` (~99KB)
- `retreat-guests.js` (~76KB)
- `kitchen-menu.js` (~71KB)
- `person.js` (~66KB)
- `stock-requests.js` (~54KB)
- `bookings.js` (~39KB)
- `departures.js` (~38KB)

HTML файлы теперь содержат только разметку, JS подключается отдельно с cache busting (`?v=N`).

### 🟢 Низкий: Зависимость от CDN

**Проблема:** Tailwind, DaisyUI, Supabase грузятся из интернета.

**Решение:** Опционально — Vite + npm (~2-3 дня)

### 🟡 Средний: Playwright тесты

**Проблема:** E2E тесты начаты (`tests/`), но покрытие неполное.

**Решение:** Расширить покрытие критических путей

---

## Roadmap эволюционного развития

### ✅ Фаза 1: Стабилизация (выполнено)

| # | Задача | Статус |
|---|--------|--------|
| 1.1 | **Ревизия RLS** | ✅ 82 политики (было 163) |
| 1.2 | Разделение HTML/JS | ✅ js/pages/ создан |
| 1.3 | Документировать архитектуру | ✅ CLAUDE.md обновлён |

### Фаза 2: Quick Wins (частично)

| # | Задача | Время | Статус |
|---|--------|-------|--------|
| 2.1 | **Telegram-уведомления** | 3-4 часа | 🔜 Планируется |
| 2.2 | **Авторасчёт порций** | 1-2 часа | 🔜 Планируется |
| 2.3 | **Supabase Realtime** | — | ✅ Готово |

### Фаза 3: Vite + TypeScript (опционально, 2-3 дня)

**Цель:** Уход от CDN, нормальная сборка, типизация.

| # | Задача | Время |
|---|--------|-------|
| 3.1 | Инициализация Vite + TypeScript | 1-2 часа |
| 3.2 | npm install зависимостей | 30 мин |
| 3.3 | Перенос JS → TypeScript | 3-4 часа |
| 3.4 | Настройка сборки для GitHub Pages | 1-2 часа |
| 3.5 | Миграция HTML страниц | 1 день |

**Структура после миграции:**

```
srsk/
├── src/
│   ├── main.ts
│   ├── lib/
│   │   ├── layout.ts
│   │   ├── cache.ts
│   │   └── supabase.ts
│   ├── components/
│   │   ├── Header.ts
│   │   └── Table.ts
│   └── pages/
│       ├── kitchen/
│       └── housing/
├── public/
│   └── fonts/
├── package.json
├── vite.config.ts
└── tsconfig.json
```

### Фаза 4: Рефакторинг (в процессе Фазы 3)

| # | Задача | Когда |
|---|--------|-------|
| 4.1 | Event delegation | При переносе в TypeScript |
| 4.2 | Разбить timeline.html | При создании компонентов |
| 4.3 | Разбить menu.html | При создании компонентов |

### Фаза 5: Новый функционал (по запросам)

| Фича | Зависимости |
|------|-------------|
| Google Forms API | Фаза 1 |
| Публичное меню | Фаза 2.2 |
| AI-распределение комнат | Внешний API |

---

## Когда РЕАЛЬНО нужен Rails

Миграция на Rails оправдана **ТОЛЬКО** если выполняется хотя бы один критерий:

| Критерий | Текущий статус |
|----------|----------------|
| Сложная бизнес-логика не помещается в RLS/Edge Functions | ❌ Нет |
| Интеграции с оплатой (RazorPay, Stripe) | ❌ Нет |
| Команда >3 разработчиков | ❌ Нет |
| >100K пользователей | ❌ Нет |
| Background jobs сложнее Telegram-уведомлений | ❌ Нет |

**Вывод:** Ни один критерий не выполнен → Rails не нужен.

### Если когда-то понадобится Rails

Сохраняем план миграции для справки:

```
Этап 1: MVP без AI — ~8.5 дней
├── 0.1 Фундамент (1 день)
├── 0.2 Кухня (2 дня)
├── 0.3 Проживание (2 дня)
├── 0.4 Склад (1 день)
├── 0.5 Ретриты (1 день)
├── 0.6 Telegram (0.5 дня)
└── 1.0 Миграция данных (1 день)

Этап 2: AI Layer — ~3 дня
├── 1.1 AI Порции (0.5 дня)
├── 1.2 AI Комнаты (1 день)
└── 1.3 AI Меню + Склад (1.5 дня)
```

---

## Диаграмма текущей архитектуры

```
┌─────────────────────────────────────────────────────────────────┐
│                         КЛИЕНТЫ (Browser)                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ Ресепшен │  │  Повар   │  │Кладовщик │  │Организатор│        │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘        │
│  ┌──────────┐  ┌──────────┐                                     │
│  │ Менеджер │  │  Гость   │                                     │
│  │   CRM    │  │ (Portal) │                                     │
│  └────┬─────┘  └────┬─────┘                                     │
└───────┼─────────────┼───────────────────────────────────────────┘
        │             │
        ▼             ▼
┌─────────────────────────────────────────────────────────────────┐
│                     GITHUB PAGES (Static)                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                 HTML + Vanilla JS                        │    │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │    │
│  │  │ Kitchen │ │ Housing │ │   CRM   │ │  Admin  │       │    │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │    │
│  │  ┌─────────────────────────────────────────────┐       │    │
│  │  │             Guest Portal                     │       │    │
│  │  │       (отдельный дизайн Tailwind)           │       │    │
│  │  └─────────────────────────────────────────────┘       │    │
│  │  78 pages, 30 JS files (~18,700 LOC)                   │    │
│  └─────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                     JS Libraries                         │    │
│  │  js/layout.js  js/cache.js  js/auth-check.js            │    │
│  │  js/crm-utils.js  js/date-utils.js  js/modal-utils.js   │    │
│  │  js/pages/*.js (8 файлов, вынесенная логика)            │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     SUPABASE (BaaS)                              │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐   │
│  │ PostgreSQL │ │    Auth    │ │  Storage   │ │  Realtime  │   │
│  │  40+ tables│ │   Users    │ │   Photos   │ │  ✅ Active │   │
│  │  82 RLS    │ │   Roles    │ │   Files    │ │            │   │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘   │
│  ┌────────────────────────────────────────────────────────┐    │
│  │              Edge Functions (Deno)                      │    │
│  │              └── send-invite                            │    │
│  └────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   EXTERNAL (будущее)                             │
│  ┌────────────┐ ┌────────────┐                                  │
│  │  Telegram  │ │  OpenAI    │                                  │
│  │    Bot     │ │    API     │                                  │
│  │  (planned) │ │  (planned) │                                  │
│  └────────────┘ └────────────┘                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Сравнение подходов

| Аспект | Текущий (Vanilla + Supabase) | Rails миграция |
|--------|------------------------------|----------------|
| **Время до value** | Часы (инкрементально) | Недели (переписывание) |
| **Риск** | Низкий | Высокий |
| **Размер системы** | 78 страниц, 18K LOC JS | Нужно переписать всё |
| **Команда** | 1 разработчик достаточно | Желательно 2+ |
| **Инфраструктура** | GitHub Pages (бесплатно) | VPS ($20-50/мес) |
| **Realtime** | ✅ Supabase Realtime | Нужен ActionCable |
| **Auth** | ✅ Supabase Auth | Нужен Devise |

---

## Резюме для встречи с заказчиком

### Ключевые тезисы

1. **Система активно развивается** — 78 страниц, 40+ таблиц, production
2. **Добавлены новые модули** — CRM (продажи), Guest Portal (ЛК гостя), Admin
3. **Технический долг закрыт** — RLS консолидирован, код разделён на HTML/JS
4. **Realtime работает** — синхронизация между вкладками (timeline, preliminary, stock)
5. **Миграция на Rails НЕ НУЖНА** — текущий стек справляется

### Следующие шаги

- Telegram-уведомления (~3-4 часа)
- Авторасчёт порций (~1-2 часа)
- Расширение Playwright тестов

### Вопросы к заказчику

- Какие фичи приоритетны?
- Какие боли у команды ашрама сейчас?
- Планируется ли рост (больше ретритов, больше гостей)?

---

*Документ создан: 31 января 2026*
*Обновлён: 4 февраля 2026*
*Версия: 3.0*
