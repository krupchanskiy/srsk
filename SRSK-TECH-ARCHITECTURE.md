# ШРСК — Техническая архитектура

> Эволюционное развитие на текущем стеке (Vanilla JS + Supabase)

**Версия:** 2.0
**Дата:** 31 января 2026

---

## Текущее состояние

**ШРСК — рабочая production-система**, а не прототип:

| Метрика | Значение |
|---------|----------|
| HTML страниц | 45 |
| SQL миграций | 97+ |
| Таблиц БД | 34 |
| RLS политик | 163 |
| JS файлов | 11 (~2,141 строк) |
| Языки | 3 (RU/EN/HI) |

---

## Текущий стек

### Frontend

| Компонент | Технология | Статус |
|-----------|------------|--------|
| **UI Framework** | Vanilla JS | Работает |
| **Components** | DaisyUI 4.x | Работает |
| **Styling** | Tailwind CSS (CDN) | Работает |
| **Icons** | Lucide Icons (strokeWidth: 1.25) | Работает |
| **Fonts** | Noto Sans + Noto Sans Devanagari | Работает |

### Backend (Supabase)

| Компонент | Технология | Статус |
|-----------|------------|--------|
| **Database** | PostgreSQL | Работает |
| **Auth** | Supabase Auth | Работает |
| **Storage** | Supabase Storage | Работает |
| **RLS** | Row Level Security | ⚠️ Требует ревизии |
| **Realtime** | Supabase Realtime | Не используется |
| **Edge Functions** | Deno | Не используется |

### Deployment

| Компонент | Технология |
|-----------|------------|
| **Hosting** | GitHub Pages |
| **CI/CD** | Auto-deploy from main |
| **Domain** | in.rupaseva.com |

---

## Архитектурные паттерны (что работает)

### 1. Layout.js — единая точка входа

```javascript
// Каждая страница инициализируется одинаково
await Layout.init({ module: 'housing', menuId: 'housing', itemId: 'timeline' });
```

Предоставляет:
- `Layout.db` — Supabase клиент
- `Layout.t(key)` — i18n переводы
- `Layout.getName(obj)` — локализованные имена
- `Layout.handleError()` — единая обработка ошибок
- `Layout.showNotification()` — toast-уведомления
- `Layout.showLoader()` / `hideLoader()` — прелоадер

### 2. Cache.js — клиентское кэширование

```javascript
const translations = await Cache.getOrLoad('translations', loadFromDB, TTL);
Cache.invalidate('translations'); // Сброс кэша
```

### 3. i18n через атрибуты

```html
<span data-i18n="nav_menu">Меню</span>
<input data-i18n-placeholder="search_placeholder">
```

### 4. Цвет модуля через CSS-переменную

```css
:root { --current-color: #f49800; } /* Kitchen */
:root { --current-color: #8b5cf6; } /* Housing */
```

### 5. XSS защита

```javascript
Layout.escapeHtml(userInput);
Utils.isValidColor(color); // Валидация перед style
```

---

## Технический долг

### 🔴 Критический: RLS хаос

**Проблема:** 163 RLS политики, последние 50 миграций (072-097) — итерации над авторизацией. Признаки борьбы с рекурсией и SECURITY DEFINER костылями.

**Решение:** Ревизия и консолидация (~3-4 часа)

1. Аудит активных политик
2. Удаление дублирующих/конфликтующих
3. Единый подход (без SECURITY DEFINER где можно)
4. Документирование архитектуры прав

### 🟡 Средний: 756 inline onclick

**Проблема:** Нарушение event delegation паттерна.

```html
<!-- ПЛОХО -->
<button onclick="doSomething()">Click</button>

<!-- ХОРОШО -->
<button data-action="do-something">Click</button>
```

**Решение:** Рефакторинг на event delegation (~1 день)

### 🟡 Средний: Монолитные HTML

**Проблема:**
- `timeline.html` — 2,672 строк
- `menu.html` — 2,072 строк

**Решение:** Разбить на компоненты (~4-6 часов)

### 🟢 Низкий: Зависимость от CDN

**Проблема:** Tailwind, DaisyUI, Supabase грузятся из интернета.

**Решение:** Опционально — Vite + npm (~2-3 дня)

---

## Roadmap эволюционного развития

### Фаза 1: Стабилизация (1-2 дня)

**Цель:** Устранить технический долг, который блокирует развитие.

| # | Задача | Время | Результат |
|---|--------|-------|-----------|
| 1.1 | **Ревизия RLS** | 3-4 часа | Понятная система прав |
| 1.2 | Удалить supabase-config.js | 10 мин | Единая конфигурация |
| 1.3 | Документировать архитектуру | 1-2 часа | Onboarding для разработчиков |

### Фаза 2: Quick Wins (1 день)

**Цель:** Быстрые улучшения с максимальной пользой для пользователей.

| # | Задача | Время | Польза |
|---|--------|-------|--------|
| 2.1 | **Telegram-уведомления** | 3-4 часа | Ресепшен/кухня узнают сразу |
| 2.2 | **Авторасчёт порций** | 1-2 часа | Повар не считает вручную |
| 2.3 | **Supabase Realtime** | 2-3 часа | Синхронизация вкладок |

### Фаза 3: Vite + TypeScript (опционально, 2-3 дня)

**Цель:** Уход от CDN, нормальная сборка, типизация.

| # | Задача | Время |
|---|--------|-------|
| 3.1 | Инициализация Vite + TypeScript | 1-2 часа |
| 3.2 | npm install зависимостей | 30 мин |
| 3.3 | Перенос JS → TypeScript | 3-4 часа |
| 3.4 | Настройка сборки для GitHub Pages | 1-2 часа |
| 3.5 | Миграция HTML страниц | 1 день |

**Структура после миграции:**

```
srsk/
├── src/
│   ├── main.ts
│   ├── lib/
│   │   ├── layout.ts
│   │   ├── cache.ts
│   │   └── supabase.ts
│   ├── components/
│   │   ├── Header.ts
│   │   └── Table.ts
│   └── pages/
│       ├── kitchen/
│       └── housing/
├── public/
│   └── fonts/
├── package.json
├── vite.config.ts
└── tsconfig.json
```

### Фаза 4: Рефакторинг (в процессе Фазы 3)

| # | Задача | Когда |
|---|--------|-------|
| 4.1 | Event delegation | При переносе в TypeScript |
| 4.2 | Разбить timeline.html | При создании компонентов |
| 4.3 | Разбить menu.html | При создании компонентов |

### Фаза 5: Новый функционал (по запросам)

| Фича | Зависимости |
|------|-------------|
| Google Forms API | Фаза 1 |
| Публичное меню | Фаза 2.2 |
| AI-распределение комнат | Внешний API |

---

## Когда РЕАЛЬНО нужен Rails

Миграция на Rails оправдана **ТОЛЬКО** если выполняется хотя бы один критерий:

| Критерий | Текущий статус |
|----------|----------------|
| Сложная бизнес-логика не помещается в RLS/Edge Functions | ❌ Нет |
| Интеграции с оплатой (RazorPay, Stripe) | ❌ Нет |
| Команда >3 разработчиков | ❌ Нет |
| >100K пользователей | ❌ Нет |
| Background jobs сложнее Telegram-уведомлений | ❌ Нет |

**Вывод:** Ни один критерий не выполнен → Rails не нужен.

### Если когда-то понадобится Rails

Сохраняем план миграции для справки:

```
Этап 1: MVP без AI — ~8.5 дней
├── 0.1 Фундамент (1 день)
├── 0.2 Кухня (2 дня)
├── 0.3 Проживание (2 дня)
├── 0.4 Склад (1 день)
├── 0.5 Ретриты (1 день)
├── 0.6 Telegram (0.5 дня)
└── 1.0 Миграция данных (1 день)

Этап 2: AI Layer — ~3 дня
├── 1.1 AI Порции (0.5 дня)
├── 1.2 AI Комнаты (1 день)
└── 1.3 AI Меню + Склад (1.5 дня)
```

---

## Диаграмма текущей архитектуры

```
┌─────────────────────────────────────────────────────────────────┐
│                         КЛИЕНТЫ (Browser)                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ Ресепшен │  │  Повар   │  │Кладовщик │  │Организатор│        │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘        │
└───────┼─────────────┼─────────────┼─────────────┼───────────────┘
        │             │             │             │
        ▼             ▼             ▼             ▼
┌─────────────────────────────────────────────────────────────────┐
│                     GITHUB PAGES (Static)                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                 HTML + Vanilla JS                        │    │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │    │
│  │  │ Kitchen │ │ Housing │ │  Stock  │ │ Ashram  │       │    │
│  │  │ 45 pages│ │         │ │         │ │         │       │    │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │    │
│  └─────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                     JS Libraries                         │    │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │    │
│  │  │Layout.js│ │Cache.js │ │Utils.js │ │VaishUtils│       │    │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     SUPABASE (BaaS)                              │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐   │
│  │ PostgreSQL │ │    Auth    │ │  Storage   │ │  Realtime  │   │
│  │  34 tables │ │   Users    │ │   Photos   │ │  (unused)  │   │
│  │  163 RLS   │ │   Roles    │ │   Files    │ │            │   │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   EXTERNAL (будущее)                             │
│  ┌────────────┐ ┌────────────┐                                  │
│  │  Telegram  │ │  OpenAI    │                                  │
│  │    Bot     │ │    API     │                                  │
│  │  (planned) │ │  (planned) │                                  │
│  └────────────┘ └────────────┘                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Сравнение подходов

| Аспект | Текущий (Vanilla + Supabase) | Rails миграция |
|--------|------------------------------|----------------|
| **Время до value** | Часы (quick wins) | Недели (переписывание) |
| **Риск** | Низкий (инкрементальные изменения) | Высокий (полная миграция) |
| **Стоимость** | ~1 неделя всех улучшений | ~2-3 недели только MVP |
| **Команда** | 1 разработчик достаточно | Желательно 2+ |
| **Инфраструктура** | GitHub Pages (бесплатно) | VPS ($20-50/мес) |

---

## Резюме для встречи с заказчиком

### Ключевые тезисы

1. **Система УЖЕ рабочая** — 45 страниц, 34 таблицы, production
2. **Миграция на Rails НЕ НУЖНА** — текущий стек справляется
3. **Есть технический долг (RLS)** — ~4 часа на стабилизацию
4. **Quick wins** — Telegram, авторасчёт за 1 день
5. **Vite + TypeScript** — опционально, 2-3 дня

### Общий срок всех улучшений: ~1 неделя

(вместо 2-3 недель только на Rails MVP)

### Вопросы к заказчику

- Какие фичи приоритетны?
- Какие боли у команды ашрама сейчас?
- Планируется ли рост (больше ретритов, больше гостей)?

---

*Документ создан: 31 января 2026*
*Обновлён: 31 января 2026*
*Версия: 2.0*
