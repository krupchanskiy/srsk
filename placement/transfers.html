<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script src="../js/color-init.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="transfers_page_title">Трансферы — ШРСК</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        .transfer-card {
            transition: background 0.2s;
        }
        .urgency-critical {
            background: #fee2e2;
            border-left: 4px solid #dc2626;
        }
        .urgency-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }
        .urgency-normal {
            background: #f3f4f6;
            border-left: 4px solid #9ca3af;
        }
        .date-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: oklch(var(--b2));
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 flex-1">

        <!-- Page Header -->
        <div class="mb-6">
            <h1 class="text-2xl font-bold" data-i18n="transfers_title">Трансферы</h1>
            <p class="text-sm opacity-60 mt-1" data-i18n="transfers_subtitle">Заезды и выезды гостей</p>
        </div>

        <!-- Main Tabs -->
        <div class="tabs tabs-boxed bg-base-100 mb-4">
            <button class="tab tab-active" data-view="transfers" onclick="setView('transfers')" data-i18n="transfers_tab_transfers">Трансферы</button>
            <button class="tab" data-view="taxi" onclick="setView('taxi')"><span data-i18n="transfers_tab_taxi">Такси</span> <span id="taxiCountBadge" class="badge badge-warning badge-sm ml-1 hidden">0</span></button>
        </div>

        <!-- Search, Legend and Direction Filter -->
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-4">
            <!-- Search -->
            <div class="w-full lg:w-auto lg:flex-1 max-w-md">
                <input type="text" id="searchInput" class="input input-bordered w-full" placeholder="Поиск по имени, телефону, рейсу..." data-i18n-placeholder="transfers_search_placeholder" oninput="handleSearch()">
            </div>

            <!-- Legend -->
            <div class="flex gap-4 text-sm flex-shrink-0">
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded bg-red-200 border-l-4 border-red-600"></div>
                    <span>&lt; 24ч</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded bg-yellow-100 border-l-4 border-yellow-500"></div>
                    <span>&lt; 48ч</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded bg-gray-100 border-l-4 border-gray-400"></div>
                    <span>&gt; 48ч</span>
                </div>
            </div>

            <!-- Direction filter -->
            <div id="directionFilter" class="flex-shrink-0">
                <div class="tabs tabs-boxed bg-base-100">
                    <button class="tab tab-active" data-filter="all" onclick="setFilter('all')" data-i18n="transfers_filter_all">Все</button>
                    <button class="tab" data-filter="arrival" onclick="setFilter('arrival')" data-i18n="transfers_filter_arrivals">Заезды</button>
                    <button class="tab" data-filter="departure" onclick="setFilter('departure')" data-i18n="transfers_filter_departures">Выезды</button>
                </div>
            </div>
        </div>

        <!-- Transfers View -->
        <div id="transfersView">
            <!-- Transfers List -->
            <div class="bg-base-100 rounded-xl shadow" id="transfersList">
                <!-- Will be populated by JS -->
            </div>

            <div id="noTransfers" class="hidden text-center py-12 opacity-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mx-auto mb-2 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" />
                </svg>
                <p data-i18n="transfers_no_transfers">Нет трансферов</p>
            </div>
        </div>

        <!-- Taxi View -->
        <div id="taxiView" class="hidden">
            <div id="taxiCardsContainer">
                <!-- Will be populated by JS -->
            </div>
            <div id="noTaxi" class="hidden text-center py-12 opacity-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mx-auto mb-2 opacity-30" viewBox="0 0 103.07 59.75" fill="currentColor">
                    <path d="M5.75,53.47c-1.68-1.71-2.63-4.23-2.68-6.64,2.97-10.49,6.26-20.89,9.36-31.35,1.71-5.78,1.81-10.95,9.24-12.11h58.86c3.74.23,7.15,2.76,8.35,6.35.33,1,.31,1.98.58,2.89,3.38,11.42,6.9,22.8,10.18,34.25-.11,4.72-3.5,8.64-8.16,9.3H11.55c-2.09-.16-4.35-1.22-5.8-2.7ZM21.72,9.78c-2.2.69-1.86,2.64-2.36,4.28-3.3,10.95-6.61,21.9-9.85,32.87-.47,2.23,1.92,3.11,3.77,3.19h76.19c1.99-.17,3.63-.69,3.83-2.97-3.25-10.64-6.4-21.3-9.61-31.95-.48-1.59-.56-4.58-2.24-5.26l-59.73-.16Z"/>
                    <polygon points="60.75 20.68 63.64 26.16 67.25 20.68 72.58 20.68 66.57 29.82 72.29 38.86 66.96 38.86 63.64 33.67 61.04 38.86 55.27 38.86 60.98 29.81 55.27 20.68 60.75 20.68"/>
                    <path d="M37.96,38.86l6.09-18.15,4.45-.05,6.48,18.2h-4.76l-1.27-3.29-4.91-.14-.89,3.43h-5.19ZM48.06,31.93c-.5-1.5-.78-3.12-1.3-4.61-.1-.28-.03-.66-.42-.58l-1.45,5.19h3.17Z"/>
                    <polygon points="39.12 20.68 39.12 25.01 33.92 25.01 33.92 38.86 28.73 38.86 28.73 25.01 23.54 25.01 23.54 20.68 39.12 20.68"/>
                    <rect x="74.03" y="20.68" width="5.19" height="18.18"/>
                </svg>
                <p data-i18n="transfers_no_taxi">Нет такси</p>
            </div>
        </div>

    </main>

    <!-- Модалка заказа такси -->
    <dialog id="taxiModal" class="modal">
        <div class="modal-box max-w-sm">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>
            <h3 class="font-bold text-lg mb-4" data-i18n="transfers_taxi_order">Заказ такси</h3>
            <input type="hidden" id="taxiTransferId">
            <div class="form-control mb-3">
                <label class="label"><span class="label-text" data-i18n="transfers_driver_info">Информация о водителе</span></label>
                <textarea id="taxiDriverInfo" class="textarea textarea-bordered" rows="3" placeholder="Имя, телефон, марка авто..." data-i18n-placeholder="transfers_driver_info_placeholder"></textarea>
            </div>
            <div class="form-control mb-4">
                <label class="label"><span class="label-text" data-i18n="transfers_ordered_by">Кто заказал:</span></label>
                <input type="text" id="taxiOrderedBy" class="input input-bordered" placeholder="Кто заказывает" data-i18n-placeholder="transfers_ordered_by_placeholder">
            </div>
            <div class="modal-action">
                <button class="btn btn-primary" onclick="saveTaxiOrder()" data-i18n="transfers_order_btn">Заказать</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Модалка просмотра/редактирования информации о такси -->
    <dialog id="taxiDetailsModal" class="modal">
        <div class="modal-box max-w-sm">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-success" viewBox="0 0 103.07 59.75" fill="currentColor">
                    <path d="M5.75,53.47c-1.68-1.71-2.63-4.23-2.68-6.64,2.97-10.49,6.26-20.89,9.36-31.35,1.71-5.78,1.81-10.95,9.24-12.11h58.86c3.74.23,7.15,2.76,8.35,6.35.33,1,.31,1.98.58,2.89,3.38,11.42,6.9,22.8,10.18,34.25-.11,4.72-3.5,8.64-8.16,9.3H11.55c-2.09-.16-4.35-1.22-5.8-2.7ZM21.72,9.78c-2.2.69-1.86,2.64-2.36,4.28-3.3,10.95-6.61,21.9-9.85,32.87-.47,2.23,1.92,3.11,3.77,3.19h76.19c1.99-.17,3.63-.69,3.83-2.97-3.25-10.64-6.4-21.3-9.61-31.95-.48-1.59-.56-4.58-2.24-5.26l-59.73-.16Z"/>
                    <polygon points="60.75 20.68 63.64 26.16 67.25 20.68 72.58 20.68 66.57 29.82 72.29 38.86 66.96 38.86 63.64 33.67 61.04 38.86 55.27 38.86 60.98 29.81 55.27 20.68 60.75 20.68"/>
                    <path d="M37.96,38.86l6.09-18.15,4.45-.05,6.48,18.2h-4.76l-1.27-3.29-4.91-.14-.89,3.43h-5.19ZM48.06,31.93c-.5-1.5-.78-3.12-1.3-4.61-.1-.28-.03-.66-.42-.58l-1.45,5.19h3.17Z"/>
                    <polygon points="39.12 20.68 39.12 25.01 33.92 25.01 33.92 38.86 28.73 38.86 28.73 25.01 23.54 25.01 23.54 20.68 39.12 20.68"/>
                    <rect x="74.03" y="20.68" width="5.19" height="18.18"/>
                </svg>
                <span data-i18n="transfers_taxi_ordered">Такси заказано</span>
            </h3>
            <input type="hidden" id="taxiDetailsTransferId">
            <div class="form-control mb-3">
                <label class="label"><span class="label-text" data-i18n="transfers_driver_info">Информация о водителе</span></label>
                <textarea id="taxiDetailsDriver" class="textarea textarea-bordered" rows="3" placeholder="Имя, телефон, марка авто..." data-i18n-placeholder="transfers_driver_info_placeholder"></textarea>
            </div>
            <div class="form-control mb-4">
                <label class="label"><span class="label-text" data-i18n="transfers_ordered_by">Кто заказал:</span></label>
                <input type="text" id="taxiDetailsOrderedBy" class="input input-bordered" placeholder="Кто заказывает" data-i18n-placeholder="transfers_ordered_by_placeholder">
            </div>
            <div class="modal-action">
                <button class="btn btn-primary" onclick="saveEditedTaxiDetails()" data-i18n="save">Сохранить</button>
                <button class="btn btn-error btn-outline" onclick="cancelTaxiFromDetails()" data-i18n="transfers_cancel_taxi">Отменить такси</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <div id="footer-placeholder"></div>

    <script src="../js/config.js"></script>
    <script src="../js/auth-check.js?v=3"></script>
    <script src="../js/cache.js"></script>
    <script src="../js/utils.js?v=2"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/layout.js?v=5"></script>
    <script>
        let transfers = [];
        let residentsMap = new Map();
        let currentFilter = 'all';
        let currentView = 'transfers';
        let searchQuery = '';
        const t = key => Layout.t(key);
        const e = str => Layout.escapeHtml(str);

        function handleSearch() {
            searchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
            if (currentView === 'taxi') {
                renderTaxiCards();
            } else {
                renderTransfers();
            }
        }

        async function loadTransfers() {
            // Загружаем трансферы с данными о регистрации и вайшнаве
            const { data, error } = await Layout.db
                .from('guest_transfers')
                .select(`
                    *,
                    retreat_registrations (
                        id,
                        retreat_id,
                        retreats (id, name_ru, name_en, name_hi),
                        vaishnavas (id, first_name, last_name, spiritual_name, phone, telegram)
                    )
                `)
                .not('flight_datetime', 'is', null)
                .order('flight_datetime', { ascending: true });

            if (error) {
                console.error('Error loading transfers:', error);
                return;
            }

            transfers = data || [];

            // Загружаем размещения по vaishnava_id
            const vaishnavaIds = transfers
                .map(t => t.retreat_registrations?.vaishnavas?.id)
                .filter(Boolean);

            residentsMap = new Map();
            if (vaishnavaIds.length > 0) {
                const { data: resData } = await Layout.db
                    .from('residents')
                    .select('vaishnava_id, room_id, rooms(number, buildings(name_ru, name_en, name_hi))')
                    .in('vaishnava_id', vaishnavaIds)
                    .in('status', ['active', 'confirmed']);

                if (resData) {
                    resData.forEach(r => {
                        if (r.vaishnava_id) {
                            if (!r.room_id) {
                                // Self-accommodation (NULL room_id)
                                residentsMap.set(r.vaishnava_id, {
                                    roomNumber: null,
                                    buildingName: null,
                                    isSelfAccommodation: true
                                });
                            } else if (r.rooms) {
                                residentsMap.set(r.vaishnava_id, {
                                    roomNumber: r.rooms.number,
                                    buildingName: Layout.getName(r.rooms.buildings),
                                    isSelfAccommodation: false
                                });
                            }
                        }
                    });
                }
            }

            updateStats();
            renderTransfers();
        }

        function updateStats() {
            // Считаем такси, которые нужно заказать
            const cutoff = new Date(Date.now() - 6 * 60 * 60 * 1000);
            let taxiNeedsOrdering = 0;

            transfers.forEach(t => {
                const date = new Date(t.flight_datetime);
                if (t.needs_transfer === 'yes' && t.taxi_status !== 'ordered' && date >= cutoff) {
                    taxiNeedsOrdering++;
                }
            });

            // Обновляем badge на вкладке "Такси"
            const taxiBadge = document.getElementById('taxiCountBadge');
            if (taxiNeedsOrdering > 0) {
                taxiBadge.textContent = taxiNeedsOrdering;
                taxiBadge.classList.remove('hidden');
            } else {
                taxiBadge.classList.add('hidden');
            }
        }

        function setView(view) {
            currentView = view;

            // Сохраняем выбор в localStorage
            localStorage.setItem('srsk_transfers_view', view);

            // Update tab active state
            document.querySelectorAll('.tabs .tab[data-view]').forEach(btn => {
                btn.classList.toggle('tab-active', btn.dataset.view === view);
            });

            // Toggle views
            document.getElementById('transfersView').classList.toggle('hidden', view !== 'transfers');
            document.getElementById('taxiView').classList.toggle('hidden', view !== 'taxi');

            if (view === 'taxi') {
                renderTaxiCards();
            } else {
                renderTransfers();
            }
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.tabs .tab[data-filter]').forEach(btn => {
                btn.classList.toggle('tab-active', btn.dataset.filter === filter);
            });

            // Обновляем текущий вид
            if (currentView === 'taxi') {
                renderTaxiCards();
            } else {
                renderTransfers();
            }
        }

        function getUrgencyClass(datetime) {
            const now = new Date();
            const transferTime = new Date(datetime);
            const hoursUntil = (transferTime - now) / (1000 * 60 * 60);

            if (hoursUntil < 0) return 'urgency-normal'; // Прошедшие
            if (hoursUntil < 24) return 'urgency-critical';
            if (hoursUntil < 48) return 'urgency-warning';
            return 'urgency-normal';
        }

        function formatTime(datetime) {
            const date = new Date(datetime);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function getCheckoutTime(flightDatetime) {
            // Выезд = время вылета минус 7 часов
            const flight = new Date(flightDatetime);
            const checkout = new Date(flight.getTime() - 7 * 60 * 60 * 1000);
            return checkout;
        }

        function formatCheckoutTime(flightDatetime) {
            const checkout = getCheckoutTime(flightDatetime);
            return formatTime(checkout);
        }

        function formatDateHeader(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);

            const isToday = date.toDateString() === today.toDateString();
            const isTomorrow = date.toDateString() === tomorrow.toDateString();

            const weekdays = ['воскресенье', 'понедельник', 'вторник', 'среда', 'четверг', 'пятница', 'суббота'];
            const months = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня', 'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'];

            const dayName = weekdays[date.getDay()];
            const formatted = `${date.getDate()} ${months[date.getMonth()]}`;

            if (isToday) return `Сегодня, ${formatted}`;
            if (isTomorrow) return `Завтра, ${formatted}`;
            return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${formatted}`;
        }

        function renderTransfers() {
            // Фильтруем
            let filtered = transfers;
            if (currentFilter !== 'all') {
                filtered = transfers.filter(t => t.direction === currentFilter);
            }

            // Показываем только будущие и сегодняшние (с небольшим запасом в прошлое — 6 часов)
            const cutoff = new Date(Date.now() - 6 * 60 * 60 * 1000);
            filtered = filtered.filter(t => new Date(t.flight_datetime) >= cutoff);

            // Фильтруем по поиску
            if (searchQuery) {
                filtered = filtered.filter(t => {
                    const reg = t.retreat_registrations;
                    const v = reg?.vaishnavas;
                    const name = (v?.spiritual_name || `${v?.first_name || ''} ${v?.last_name || ''}`).toLowerCase();
                    const phone = (v?.phone || '').toLowerCase();
                    const telegram = (v?.telegram || '').toLowerCase();
                    const flightNumber = (t.flight_number || '').toLowerCase();
                    return name.includes(searchQuery) ||
                           phone.includes(searchQuery) ||
                           telegram.includes(searchQuery) ||
                           flightNumber.includes(searchQuery);
                });
            }

            const container = document.getElementById('transfersList');
            const noTransfers = document.getElementById('noTransfers');

            if (filtered.length === 0) {
                container.innerHTML = '';
                noTransfers.classList.remove('hidden');
                return;
            }

            noTransfers.classList.add('hidden');

            // Группируем по датам
            const grouped = {};
            filtered.forEach(t => {
                const dateKey = new Date(t.flight_datetime).toDateString();
                if (!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(t);
            });

            // Сортируем даты
            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(a) - new Date(b));

            let html = '';
            sortedDates.forEach(dateKey => {
                const items = grouped[dateKey];

                html += `
                    <div class="date-header px-4 py-3 font-semibold border-b">
                        ${formatDateHeader(dateKey)}
                        <span class="badge badge-sm ml-2">${items.length}</span>
                    </div>
                `;

                items.forEach(t => {
                    const reg = t.retreat_registrations;
                    const v = reg?.vaishnavas;
                    const retreat = reg?.retreats;

                    const name = e(v?.spiritual_name || `${v?.first_name || ''} ${v?.last_name || ''}`.trim() || '—');
                    const phone = e(v?.phone || '');
                    const telegram = v?.telegram ? e(v.telegram.replace('@', '')) : '';
                    const telegramLink = telegram ? `<a href="https://t.me/${telegram}" class="link link-primary" target="_blank" onclick="event.stopPropagation()">@${telegram}</a>` : '';
                    const retreatName = Layout.getName(retreat) || '';
                    const flightNumber = t.flight_number || '';
                    const needsTransfer = t.needs_transfer === 'yes';
                    const urgencyClass = getUrgencyClass(t.flight_datetime);
                    const directionIcon = t.direction === 'arrival' ? '✈️ →' : '← ✈️';
                    const directionLabel = t.direction === 'arrival' ? 'Заезд' : 'Выезд';
                    const accommodation = v ? residentsMap.get(v.id) : null;
                    const accommodationStr = accommodation?.isSelfAccommodation ? `<span class="text-error bg-error/20 px-2 py-1 rounded font-medium">${Layout.t('self_accommodation')}</span>` : (accommodation ? `${accommodation.buildingName}, ${accommodation.roomNumber}` : '');

                    // Для выездов показываем время выезда (вылет - 7 часов)
                    const isDeparture = t.direction === 'departure';
                    const checkoutTime = isDeparture ? formatCheckoutTime(t.flight_datetime) : null;

                    html += `
                        <div class="transfer-card ${urgencyClass} px-4 py-3 flex items-center gap-4 border-b last:border-b-0 cursor-pointer hover:bg-base-200/50"
                             onclick="window.location.href='../vaishnavas/person.html?id=${v?.id}'">
                            <div class="w-10 flex justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 ${t.direction === 'arrival' ? 'text-success' : 'text-error'}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    ${t.direction === 'arrival'
                                        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />'
                                        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />'
                                    }
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold truncate">${name}</div>
                                <div class="text-sm flex flex-wrap gap-x-3">
                                    ${phone ? `<span class="opacity-60">${phone}</span>` : ''}
                                    ${telegramLink ? `<span>${telegramLink}</span>` : ''}
                                    ${retreatName ? `<span class="opacity-60">${retreatName}</span>` : ''}
                                    ${accommodationStr ? `<span>${accommodationStr}</span>` : ''}
                                </div>
                            </div>
                            ${isDeparture ? `
                            <div class="text-right">
                                <div class="text-lg font-mono font-semibold text-error">${checkoutTime}</div>
                                <div class="text-xs opacity-60">Выезд</div>
                            </div>
                            ` : ''}
                            <div class="text-right">
                                <div class="text-lg font-mono font-semibold">${formatTime(t.flight_datetime)}</div>
                                <div class="text-xs opacity-60">${flightNumber || (isDeparture ? 'Вылет' : 'Прилёт')}</div>
                            </div>
                            ${needsTransfer ? '<div class="badge badge-primary gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" /></svg>Нужен трансфер</div>' : ''}
                            ${renderTaxiBadge(t)}
                        </div>
                    `;
                });
            });

            container.innerHTML = html;
        }

        // ==================== ТАКСИ ====================
        function renderTaxiBadge(transfer) {
            const taxiIcon = '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 103.07 59.75" fill="currentColor"><path d="M5.75,53.47c-1.68-1.71-2.63-4.23-2.68-6.64,2.97-10.49,6.26-20.89,9.36-31.35,1.71-5.78,1.81-10.95,9.24-12.11h58.86c3.74.23,7.15,2.76,8.35,6.35.33,1,.31,1.98.58,2.89,3.38,11.42,6.9,22.8,10.18,34.25-.11,4.72-3.5,8.64-8.16,9.3H11.55c-2.09-.16-4.35-1.22-5.8-2.7ZM21.72,9.78c-2.2.69-1.86,2.64-2.36,4.28-3.3,10.95-6.61,21.9-9.85,32.87-.47,2.23,1.92,3.11,3.77,3.19h76.19c1.99-.17,3.63-.69,3.83-2.97-3.25-10.64-6.4-21.3-9.61-31.95-.48-1.59-.56-4.58-2.24-5.26l-59.73-.16Z"/><polygon points="60.75 20.68 63.64 26.16 67.25 20.68 72.58 20.68 66.57 29.82 72.29 38.86 66.96 38.86 63.64 33.67 61.04 38.86 55.27 38.86 60.98 29.81 55.27 20.68 60.75 20.68"/><path d="M37.96,38.86l6.09-18.15,4.45-.05,6.48,18.2h-4.76l-1.27-3.29-4.91-.14-.89,3.43h-5.19ZM48.06,31.93c-.5-1.5-.78-3.12-1.3-4.61-.1-.28-.03-.66-.42-.58l-1.45,5.19h3.17Z"/><polygon points="39.12 20.68 39.12 25.01 33.92 25.01 33.92 38.86 28.73 38.86 28.73 25.01 23.54 25.01 23.54 20.68 39.12 20.68"/><rect x="74.03" y="20.68" width="5.19" height="18.18"/></svg>';
            const canManage = window.hasPermission && window.hasPermission('manage_transfers');
            if (transfer.taxi_status === 'ordered') {
                return canManage
                    ? `<div class="badge badge-success gap-1 cursor-pointer" onclick="event.stopPropagation(); showTaxiDetails('${transfer.id}')">${taxiIcon}Такси заказано</div>`
                    : `<div class="badge badge-success gap-1">${taxiIcon}Такси заказано</div>`;
            }
            return canManage
                ? `<button class="btn btn-xs btn-outline gap-1" onclick="event.stopPropagation(); openTaxiModal('${transfer.id}')">${taxiIcon}Заказать такси</button>`
                : '';
        }

        function renderTaxiCards() {
            // Фильтруем только те трансферы, где needs_transfer === 'yes' и статус не 'completed'
            const cutoff = new Date(Date.now() - 6 * 60 * 60 * 1000);
            let taxiTransfers = transfers.filter(t =>
                t.needs_transfer === 'yes' &&
                t.taxi_status !== 'completed' &&
                new Date(t.flight_datetime) >= cutoff
            );

            // Применяем фильтр направления
            if (currentFilter !== 'all') {
                taxiTransfers = taxiTransfers.filter(t => t.direction === currentFilter);
            }

            // Фильтруем по поиску
            if (searchQuery) {
                taxiTransfers = taxiTransfers.filter(t => {
                    const reg = t.retreat_registrations;
                    const v = reg?.vaishnavas;
                    const name = (v?.spiritual_name || `${v?.first_name || ''} ${v?.last_name || ''}`).toLowerCase();
                    const phone = (v?.phone || '').toLowerCase();
                    const telegram = (v?.telegram || '').toLowerCase();
                    const flightNumber = (t.flight_number || '').toLowerCase();
                    return name.includes(searchQuery) ||
                           phone.includes(searchQuery) ||
                           telegram.includes(searchQuery) ||
                           flightNumber.includes(searchQuery);
                });
            }

            const container = document.getElementById('taxiCardsContainer');
            const noTaxi = document.getElementById('noTaxi');

            if (taxiTransfers.length === 0) {
                container.innerHTML = '';
                noTaxi.classList.remove('hidden');
                return;
            }

            noTaxi.classList.add('hidden');

            // Группируем по датам (для выездов используем дату выезда, для заездов - дату прилёта)
            const grouped = {};
            taxiTransfers.forEach(t => {
                const relevantDate = t.direction === 'departure' ? getCheckoutTime(t.flight_datetime) : new Date(t.flight_datetime);
                const dateKey = relevantDate.toDateString();
                if (!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(t);
            });

            // Сортируем даты
            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(a) - new Date(b));

            // Обновляем badge на вкладке (показываем только незаказанные)
            const needsOrdering = taxiTransfers.filter(t => t.taxi_status !== 'ordered').length;
            const taxiBadge = document.getElementById('taxiCountBadge');
            if (needsOrdering > 0) {
                taxiBadge.textContent = needsOrdering;
                taxiBadge.classList.remove('hidden');
            } else {
                taxiBadge.classList.add('hidden');
            }

            // Рендерим карточки по датам
            let html = '';
            sortedDates.forEach(dateKey => {
                const items = grouped[dateKey];

                // Сортируем внутри дня по времени
                items.sort((a, b) => {
                    const timeA = a.direction === 'departure' ? getCheckoutTime(a.flight_datetime) : new Date(a.flight_datetime);
                    const timeB = b.direction === 'departure' ? getCheckoutTime(b.flight_datetime) : new Date(b.flight_datetime);
                    return timeA - timeB;
                });

                html += `
                    <div class="mb-6">
                        <div class="px-4 py-3 font-semibold bg-base-100 rounded-t-xl border-b">
                            ${formatDateHeader(dateKey)}
                            <span class="badge badge-sm ml-2">${items.length}</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
                            ${items.map(t => renderTaxiCard(t, t.taxi_status === 'ordered')).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderTaxiCard(transfer, isOrdered = false) {
            const canManage = window.hasPermission && window.hasPermission('manage_transfers');
            const reg = transfer.retreat_registrations;
            const v = reg?.vaishnavas;
            const retreat = reg?.retreats;

            const name = e(v?.spiritual_name || `${v?.first_name || ''} ${v?.last_name || ''}`.trim() || '—');
            const phone = e(v?.phone || '');
            const telegram = v?.telegram ? e(v.telegram.replace('@', '')) : '';
            const telegramLink = telegram ? `<a href="https://t.me/${telegram}" class="link link-primary text-xs" target="_blank" onclick="event.stopPropagation()">@${telegram}</a>` : '';
            const retreatName = Layout.getName(retreat) || '';
            const flightNumber = transfer.flight_number || '';
            const isDeparture = transfer.direction === 'departure';
            const directionLabel = isDeparture ? 'Выезд' : 'Заезд';
            const directionIcon = '✈️';
            const accommodation = v ? residentsMap.get(v.id) : null;
            const accommodationStr = accommodation?.isSelfAccommodation ? `<span class="text-xs text-error bg-error/20 px-1.5 py-0.5 rounded font-medium">${Layout.t('self_accommodation')}</span>` : (accommodation ? `<span class="text-xs opacity-60">${accommodation.buildingName}, ${accommodation.roomNumber}</span>` : '');

            // Определяем срочность
            const urgencyClass = getUrgencyClass(transfer.flight_datetime);
            let borderColor = 'border-gray-400';
            if (urgencyClass === 'urgency-critical') borderColor = 'border-red-600';
            else if (urgencyClass === 'urgency-warning') borderColor = 'border-yellow-500';

            // Формат даты и времени
            const flightDate = new Date(transfer.flight_datetime);
            const flightDateStr = flightDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
            const timeStr = formatTime(transfer.flight_datetime);

            // Для выездов показываем дату и время выезда
            let dateStr, checkoutTime, checkoutDateStr;
            if (isDeparture) {
                const checkoutDate = getCheckoutTime(transfer.flight_datetime);
                dateStr = checkoutDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
                checkoutDateStr = dateStr;
                checkoutTime = formatTime(checkoutDate);
            } else {
                dateStr = flightDateStr;
                checkoutTime = null;
                checkoutDateStr = null;
            }

            // Информация о такси
            const taxiInfo = transfer.taxi_driver_info ? `<p class="text-xs mt-2 opacity-70">${e(transfer.taxi_driver_info)}</p>` : '';
            const orderedByInfo = transfer.taxi_ordered_by ? `<p class="text-xs mt-1 opacity-50">Заказал: ${e(transfer.taxi_ordered_by)}</p>` : '';

            return `
                <div class="card bg-base-100 shadow-sm border-l-4 ${borderColor}">
                    <div class="card-body p-4 flex flex-col">
                        <div class="flex-1">
                        <!-- Header -->
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-lg">${directionIcon}</span>
                            <span class="badge badge-sm ${isDeparture ? 'badge-error' : 'badge-success'} badge-outline">${directionLabel}</span>
                        </div>

                        <!-- Name -->
                        <h3 class="font-semibold text-base truncate">
                            <a href="../vaishnavas/person.html?id=${v?.id}" class="link link-hover">${name}</a>
                        </h3>

                        <!-- Retreat & Accommodation -->
                        <div class="flex flex-col gap-1">
                            ${retreatName ? `<p class="text-xs opacity-60">${retreatName}</p>` : ''}
                            ${accommodationStr ? `<div>${accommodationStr}</div>` : ''}
                        </div>

                        <!-- Flight Info -->
                        <div class="flex items-center justify-between mt-2 pt-2 border-t border-base-300">
                            ${isDeparture ? `
                            <div>
                                <div class="text-sm opacity-60">${checkoutDateStr}</div>
                                <div class="text-lg font-mono font-semibold text-error">${checkoutTime}</div>
                                <div class="text-xs opacity-60">Выезд</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm opacity-60">${flightDateStr}</div>
                                <div class="text-lg font-mono font-semibold">${timeStr}</div>
                                <div class="text-xs opacity-60">${flightNumber || 'Вылет'}</div>
                            </div>
                            ` : `
                            <div>
                                <div class="text-sm opacity-60">${dateStr}</div>
                                <div class="text-lg font-mono font-semibold">${timeStr}</div>
                                <div class="text-xs opacity-60">${flightNumber || 'Прилёт'}</div>
                            </div>
                            `}
                        </div>

                        <!-- Contact Info -->
                        ${phone || telegram ? `
                        <div class="flex flex-wrap gap-x-3 gap-y-1 mt-2 text-xs">
                            ${phone ? `<span class="opacity-60">${phone}</span>` : ''}
                            ${telegramLink ? `<span>${telegramLink}</span>` : ''}
                        </div>
                        ` : ''}

                        <!-- Taxi Info (for ordered) -->
                        ${isOrdered ? `
                        <div class="mt-3 pt-3 border-t border-base-300">
                            ${taxiInfo}
                            ${orderedByInfo}
                        </div>
                        ` : ''}
                        </div>

                        <!-- Action Buttons -->
                        ${canManage ? `
                        <div class="card-actions mt-3 gap-2">
                            ${isOrdered
                                ? `<button class="btn btn-sm btn-success btn-outline flex-1 gap-1" onclick="event.stopPropagation(); showTaxiDetails('${transfer.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                    Редактировать
                                  </button>
                                  <button class="btn btn-sm btn-success flex-1 gap-1" onclick="event.stopPropagation(); completeTaxi('${transfer.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                    Завершено
                                  </button>`
                                : `<button class="btn btn-sm btn-warning w-full gap-1" onclick="event.stopPropagation(); openTaxiModal('${transfer.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 103.07 59.75" fill="currentColor">
                                        <path d="M5.75,53.47c-1.68-1.71-2.63-4.23-2.68-6.64,2.97-10.49,6.26-20.89,9.36-31.35,1.71-5.78,1.81-10.95,9.24-12.11h58.86c3.74.23,7.15,2.76,8.35,6.35.33,1,.31,1.98.58,2.89,3.38,11.42,6.9,22.8,10.18,34.25-.11,4.72-3.5,8.64-8.16,9.3H11.55c-2.09-.16-4.35-1.22-5.8-2.7ZM21.72,9.78c-2.2.69-1.86,2.64-2.36,4.28-3.3,10.95-6.61,21.9-9.85,32.87-.47,2.23,1.92,3.11,3.77,3.19h76.19c1.99-.17,3.63-.69,3.83-2.97-3.25-10.64-6.4-21.3-9.61-31.95-.48-1.59-.56-4.58-2.24-5.26l-59.73-.16Z"/>
                                        <polygon points="60.75 20.68 63.64 26.16 67.25 20.68 72.58 20.68 66.57 29.82 72.29 38.86 66.96 38.86 63.64 33.67 61.04 38.86 55.27 38.86 60.98 29.81 55.27 20.68 60.75 20.68"/>
                                        <path d="M37.96,38.86l6.09-18.15,4.45-.05,6.48,18.2h-4.76l-1.27-3.29-4.91-.14-.89,3.43h-5.19ZM48.06,31.93c-.5-1.5-.78-3.12-1.3-4.61-.1-.28-.03-.66-.42-.58l-1.45,5.19h3.17Z"/>
                                        <polygon points="39.12 20.68 39.12 25.01 33.92 25.01 33.92 38.86 28.73 38.86 28.73 25.01 23.54 25.01 23.54 20.68 39.12 20.68"/>
                                        <rect x="74.03" y="20.68" width="5.19" height="18.18"/>
                                    </svg>
                                    Заказать такси
                                  </button>`
                            }
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function openTaxiModal(transferId) {
            document.getElementById('taxiTransferId').value = transferId;
            document.getElementById('taxiDriverInfo').value = '';
            document.getElementById('taxiOrderedBy').value = localStorage.getItem('srsk_taxi_name') || '';
            document.getElementById('taxiModal').showModal();
        }

        function closeTaxiModal() {
            document.getElementById('taxiModal').close();
        }

        async function saveTaxiOrder() {
            const transferId = document.getElementById('taxiTransferId').value;
            const driverInfo = document.getElementById('taxiDriverInfo').value.trim();
            const orderedBy = document.getElementById('taxiOrderedBy').value.trim();

            if (!orderedBy) {
                Layout.showNotification(t('specify_your_name'), 'warning');
                return;
            }

            localStorage.setItem('srsk_taxi_name', orderedBy);

            const { error } = await Layout.db
                .from('guest_transfers')
                .update({
                    taxi_status: 'ordered',
                    taxi_driver_info: driverInfo || null,
                    taxi_ordered_by: orderedBy
                })
                .eq('id', transferId);

            if (error) {
                console.error('Error saving taxi order:', error);
                Layout.showNotification(t('error_saving') + ': ' + error.message, 'error');
                return;
            }

            closeTaxiModal();

            // Обновляем локальные данные
            const t = transfers.find(t => t.id == transferId);
            if (t) {
                t.taxi_status = 'ordered';
                t.taxi_driver_info = driverInfo || null;
                t.taxi_ordered_by = orderedBy;
            }

            // Обновляем текущий вид
            if (currentView === 'taxi') {
                renderTaxiCards();
            } else {
                renderTransfers();
            }
        }

        function showTaxiDetails(transferId) {
            const transfer = transfers.find(t => t.id == transferId);
            if (!transfer) return;
            document.getElementById('taxiDetailsTransferId').value = transferId;
            document.getElementById('taxiDetailsDriver').value = transfer.taxi_driver_info || '';
            document.getElementById('taxiDetailsOrderedBy').value = transfer.taxi_ordered_by || '';
            document.getElementById('taxiDetailsModal').showModal();
        }

        async function saveEditedTaxiDetails() {
            const transferId = document.getElementById('taxiDetailsTransferId').value;
            const driverInfo = document.getElementById('taxiDetailsDriver').value.trim();
            const orderedBy = document.getElementById('taxiDetailsOrderedBy').value.trim();

            if (!orderedBy) {
                Layout.showNotification(t('specify_your_name'), 'warning');
                return;
            }

            const { error } = await Layout.db
                .from('guest_transfers')
                .update({
                    taxi_driver_info: driverInfo || null,
                    taxi_ordered_by: orderedBy
                })
                .eq('id', transferId);

            if (error) {
                console.error('Error updating taxi details:', error);
                Layout.showNotification(t('error_saving') + ': ' + error.message, 'error');
                return;
            }

            document.getElementById('taxiDetailsModal').close();

            // Обновляем локальные данные
            const t = transfers.find(t => t.id == transferId);
            if (t) {
                t.taxi_driver_info = driverInfo || null;
                t.taxi_ordered_by = orderedBy;
            }

            // Обновляем текущий вид
            if (currentView === 'taxi') {
                renderTaxiCards();
            } else {
                renderTransfers();
            }
        }

        async function cancelTaxiFromDetails() {
            const transferId = document.getElementById('taxiDetailsTransferId').value;
            document.getElementById('taxiDetailsModal').close();
            await cancelTaxi(transferId);
        }

        async function cancelTaxi(transferId) {
            const { error } = await Layout.db
                .from('guest_transfers')
                .update({
                    taxi_status: null,
                    taxi_driver_info: null,
                    taxi_ordered_by: null
                })
                .eq('id', transferId);

            if (error) {
                console.error('Error cancelling taxi:', error);
                Layout.showNotification(t('cancel_error') + ': ' + error.message, 'error');
                return;
            }

            const t = transfers.find(t => t.id == transferId);
            if (t) {
                t.taxi_status = null;
                t.taxi_driver_info = null;
                t.taxi_ordered_by = null;
            }

            // Обновляем текущий вид
            if (currentView === 'taxi') {
                renderTaxiCards();
            } else {
                renderTransfers();
            }
        }

        async function completeTaxi(transferId) {
            const { error } = await Layout.db
                .from('guest_transfers')
                .update({
                    taxi_status: 'completed'
                })
                .eq('id', transferId);

            if (error) {
                console.error('Error completing taxi:', error);
                Layout.handleError(error);
                return;
            }

            const t = transfers.find(t => t.id == transferId);
            if (t) {
                t.taxi_status = 'completed';
            }

            // Обновляем текущий вид
            if (currentView === 'taxi') {
                renderTaxiCards();
            } else {
                renderTransfers();
            }

            Layout.showNotification('Такси завершено', 'success');
        }

        async function init() {
            await Layout.init({ module: 'housing', menuId: 'placement', itemId: 'transfers' });
            Layout.showLoader();

            await loadTransfers();

            // Восстанавливаем сохраненную вкладку
            const savedView = localStorage.getItem('srsk_transfers_view') || 'transfers';
            setView(savedView);

            Layout.hideLoader();
        }

        window.onLanguageChange = () => {
            Layout.updateAllTranslations();
            renderTransfers();
        };

        init();
    </script>
</body>
</html>
