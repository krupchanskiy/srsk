<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script src="../js/color-init.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–∞–Ω—Å—Ñ–µ—Ä—ã ‚Äî –®–†–°–ö</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        .transfer-card {
            transition: all 0.2s;
        }
        .transfer-card:hover {
            transform: translateX(4px);
        }
        .urgency-critical {
            background: #fee2e2;
            border-left: 4px solid #dc2626;
        }
        .urgency-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }
        .urgency-normal {
            background: #f3f4f6;
            border-left: 4px solid #9ca3af;
        }
        .date-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: oklch(var(--b2));
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 flex-1">

        <!-- Page Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold" data-i18n="transfers_title">–¢—Ä–∞–Ω—Å—Ñ–µ—Ä—ã</h1>
                <p class="text-sm opacity-60 mt-1" data-i18n="transfers_subtitle">–ó–∞–µ–∑–¥—ã –∏ –≤—ã–µ–∑–¥—ã –≥–æ—Å—Ç–µ–π</p>
            </div>
            <div class="flex items-center gap-4">
                <!-- Direction filter -->
                <div class="tabs tabs-boxed bg-base-100">
                    <button class="tab tab-active" data-filter="all" onclick="setFilter('all')">–í—Å–µ</button>
                    <button class="tab" data-filter="arrival" onclick="setFilter('arrival')">–ó–∞–µ–∑–¥—ã</button>
                    <button class="tab" data-filter="departure" onclick="setFilter('departure')">–í—ã–µ–∑–¥—ã</button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats shadow mb-6 w-full">
            <div class="stat">
                <div class="stat-title">–°–µ–≥–æ–¥–Ω—è</div>
                <div class="stat-value text-2xl" id="statToday">0</div>
            </div>
            <div class="stat">
                <div class="stat-title">–ó–∞–≤—Ç—Ä–∞</div>
                <div class="stat-value text-2xl" id="statTomorrow">0</div>
            </div>
            <div class="stat">
                <div class="stat-title">–ë–ª–∏–∂–∞–π—à–∏–µ 7 –¥–Ω–µ–π</div>
                <div class="stat-value text-2xl" id="statWeek">0</div>
            </div>
            <div class="stat">
                <div class="stat-title">–ù—É–∂–µ–Ω —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä</div>
                <div class="stat-value text-2xl text-primary" id="statNeedTransfer">0</div>
            </div>
        </div>

        <!-- Legend -->
        <div class="flex gap-4 mb-4 text-sm">
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded bg-red-200 border-l-4 border-red-600"></div>
                <span>–ú–µ–Ω–µ–µ 24 —á–∞—Å–æ–≤</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded bg-yellow-100 border-l-4 border-yellow-500"></div>
                <span>–ú–µ–Ω–µ–µ 48 —á–∞—Å–æ–≤</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded bg-gray-100 border-l-4 border-gray-400"></div>
                <span>–ë–æ–ª–µ–µ 48 —á–∞—Å–æ–≤</span>
            </div>
        </div>

        <!-- Transfers List -->
        <div class="bg-base-100 rounded-xl shadow" id="transfersList">
            <!-- Will be populated by JS -->
        </div>

        <div id="noTransfers" class="hidden text-center py-12 opacity-50">
            <div class="text-4xl mb-2">üöê</div>
            <p>–ù–µ—Ç —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–æ–≤</p>
        </div>

    </main>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –∑–∞–∫–∞–∑–∞ —Ç–∞–∫—Å–∏ -->
    <dialog id="taxiModal" class="modal">
        <div class="modal-box max-w-sm">
            <h3 class="font-bold text-lg mb-4">–ó–∞–∫–∞–∑ —Ç–∞–∫—Å–∏</h3>
            <input type="hidden" id="taxiTransferId">
            <div class="form-control mb-3">
                <label class="label"><span class="label-text">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–æ–¥–∏—Ç–µ–ª–µ</span></label>
                <textarea id="taxiDriverInfo" class="textarea textarea-bordered" rows="3" placeholder="–ò–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, –º–∞—Ä–∫–∞ –∞–≤—Ç–æ..."></textarea>
            </div>
            <div class="form-control mb-4">
                <label class="label"><span class="label-text">–í–∞—à–µ –∏–º—è</span></label>
                <input type="text" id="taxiOrderedBy" class="input input-bordered" placeholder="–ö—Ç–æ –∑–∞–∫–∞–∑—ã–≤–∞–µ—Ç">
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" onclick="closeTaxiModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="saveTaxiOrder()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–∞–∫—Å–∏ -->
    <dialog id="taxiDetailsModal" class="modal">
        <div class="modal-box max-w-sm">
            <h3 class="font-bold text-lg mb-4">üöï –¢–∞–∫—Å–∏ –∑–∞–∫–∞–∑–∞–Ω–æ</h3>
            <input type="hidden" id="taxiDetailsTransferId">
            <div class="space-y-3">
                <div>
                    <div class="text-xs opacity-50 mb-1">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–æ–¥–∏—Ç–µ–ª–µ</div>
                    <div id="taxiDetailsDriver" class="whitespace-pre-wrap">‚Äî</div>
                </div>
                <div>
                    <div class="text-xs opacity-50 mb-1">–ó–∞–∫–∞–∑–∞–ª</div>
                    <div id="taxiDetailsOrderedBy">‚Äî</div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" onclick="document.getElementById('taxiDetailsModal').close()">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button class="btn btn-error btn-outline" onclick="cancelTaxiFromDetails()">–û—Ç–º–µ–Ω–∏—Ç—å —Ç–∞–∫—Å–∏</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <div id="footer-placeholder"></div>

    <script src="../js/cache.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/layout.js"></script>
    <script>
        let transfers = [];
        let residentsMap = new Map();
        let currentFilter = 'all';
        const t = key => Layout.t(key);
        const e = str => Layout.escapeHtml(str);

        async function loadTransfers() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –≤–∞–π—à–Ω–∞–≤–µ
            const { data, error } = await Layout.db
                .from('guest_transfers')
                .select(`
                    *,
                    retreat_registrations (
                        id,
                        retreat_id,
                        retreats (id, name_ru, name_en, name_hi),
                        vaishnavas (id, first_name, last_name, spiritual_name, phone)
                    )
                `)
                .not('flight_datetime', 'is', null)
                .order('flight_datetime', { ascending: true });

            if (error) {
                console.error('Error loading transfers:', error);
                return;
            }

            transfers = data || [];

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –ø–æ vaishnava_id
            const vaishnavaIds = transfers
                .map(t => t.retreat_registrations?.vaishnavas?.id)
                .filter(Boolean);

            residentsMap = new Map();
            if (vaishnavaIds.length > 0) {
                const { data: resData } = await Layout.db
                    .from('residents')
                    .select('vaishnava_id, rooms(number, buildings(name_ru, name_en, name_hi))')
                    .in('vaishnava_id', vaishnavaIds)
                    .in('status', ['active', 'confirmed']);

                if (resData) {
                    resData.forEach(r => {
                        if (r.vaishnava_id && r.rooms) {
                            residentsMap.set(r.vaishnava_id, {
                                roomNumber: r.rooms.number,
                                buildingName: Layout.getName(r.rooms.buildings)
                            });
                        }
                    });
                }
            }

            updateStats();
            renderTransfers();
        }

        function updateStats() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
            const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);

            let statToday = 0, statTomorrow = 0, statWeek = 0, statNeedTransfer = 0;

            transfers.forEach(t => {
                const date = new Date(t.flight_datetime);
                const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());

                if (dateOnly.getTime() === today.getTime()) statToday++;
                if (dateOnly.getTime() === tomorrow.getTime()) statTomorrow++;
                if (date >= now && date < nextWeek) statWeek++;
                if (t.needs_transfer === 'yes') statNeedTransfer++;
            });

            document.getElementById('statToday').textContent = statToday;
            document.getElementById('statTomorrow').textContent = statTomorrow;
            document.getElementById('statWeek').textContent = statWeek;
            document.getElementById('statNeedTransfer').textContent = statNeedTransfer;
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.tabs .tab').forEach(btn => {
                btn.classList.toggle('tab-active', btn.dataset.filter === filter);
            });
            renderTransfers();
        }

        function getUrgencyClass(datetime) {
            const now = new Date();
            const transferTime = new Date(datetime);
            const hoursUntil = (transferTime - now) / (1000 * 60 * 60);

            if (hoursUntil < 0) return 'urgency-normal'; // –ü—Ä–æ—à–µ–¥—à–∏–µ
            if (hoursUntil < 24) return 'urgency-critical';
            if (hoursUntil < 48) return 'urgency-warning';
            return 'urgency-normal';
        }

        function formatTime(datetime) {
            const date = new Date(datetime);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function getCheckoutTime(flightDatetime) {
            // –í—ã–µ–∑–¥ = –≤—Ä–µ–º—è –≤—ã–ª–µ—Ç–∞ –º–∏–Ω—É—Å 7 —á–∞—Å–æ–≤
            const flight = new Date(flightDatetime);
            const checkout = new Date(flight.getTime() - 7 * 60 * 60 * 1000);
            return checkout;
        }

        function formatCheckoutTime(flightDatetime) {
            const checkout = getCheckoutTime(flightDatetime);
            return formatTime(checkout);
        }

        function formatDateHeader(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);

            const isToday = date.toDateString() === today.toDateString();
            const isTomorrow = date.toDateString() === tomorrow.toDateString();

            const weekdays = ['–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–≤—Ç–æ—Ä–Ω–∏–∫', '—Å—Ä–µ–¥–∞', '—á–µ—Ç–≤–µ—Ä–≥', '–ø—è—Ç–Ω–∏—Ü–∞', '—Å—É–±–±–æ—Ç–∞'];
            const months = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è', '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'];

            const dayName = weekdays[date.getDay()];
            const formatted = `${date.getDate()} ${months[date.getMonth()]}`;

            if (isToday) return `–°–µ–≥–æ–¥–Ω—è, ${formatted}`;
            if (isTomorrow) return `–ó–∞–≤—Ç—Ä–∞, ${formatted}`;
            return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${formatted}`;
        }

        function renderTransfers() {
            // –§–∏–ª—å—Ç—Ä—É–µ–º
            let filtered = transfers;
            if (currentFilter !== 'all') {
                filtered = transfers.filter(t => t.direction === currentFilter);
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –±—É–¥—É—â–∏–µ –∏ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ (—Å –Ω–µ–±–æ–ª—å—à–∏–º –∑–∞–ø–∞—Å–æ–º –≤ –ø—Ä–æ—à–ª–æ–µ ‚Äî 6 —á–∞—Å–æ–≤)
            const cutoff = new Date(Date.now() - 6 * 60 * 60 * 1000);
            filtered = filtered.filter(t => new Date(t.flight_datetime) >= cutoff);

            const container = document.getElementById('transfersList');
            const noTransfers = document.getElementById('noTransfers');

            if (filtered.length === 0) {
                container.innerHTML = '';
                noTransfers.classList.remove('hidden');
                return;
            }

            noTransfers.classList.add('hidden');

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–∞–º
            const grouped = {};
            filtered.forEach(t => {
                const dateKey = new Date(t.flight_datetime).toDateString();
                if (!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(t);
            });

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã
            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(a) - new Date(b));

            let html = '';
            sortedDates.forEach(dateKey => {
                const items = grouped[dateKey];

                html += `
                    <div class="date-header px-4 py-3 font-semibold border-b">
                        ${formatDateHeader(dateKey)}
                        <span class="badge badge-sm ml-2">${items.length}</span>
                    </div>
                `;

                items.forEach(t => {
                    const reg = t.retreat_registrations;
                    const v = reg?.vaishnavas;
                    const retreat = reg?.retreats;

                    const name = e(v?.spiritual_name || `${v?.first_name || ''} ${v?.last_name || ''}`.trim() || '‚Äî');
                    const phone = e(v?.phone || '');
                    const retreatName = Layout.getName(retreat) || '';
                    const flightNumber = t.flight_number || '';
                    const needsTransfer = t.needs_transfer === 'yes';
                    const urgencyClass = getUrgencyClass(t.flight_datetime);
                    const directionIcon = t.direction === 'arrival' ? '‚úàÔ∏è ‚Üí' : '‚Üê ‚úàÔ∏è';
                    const directionLabel = t.direction === 'arrival' ? '–ó–∞–µ–∑–¥' : '–í—ã–µ–∑–¥';
                    const accommodation = v ? residentsMap.get(v.id) : null;
                    const accommodationStr = accommodation ? `${accommodation.buildingName}, ${accommodation.roomNumber}` : '';

                    // –î–ª—è –≤—ã–µ–∑–¥–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º—è –≤—ã–µ–∑–¥–∞ (–≤—ã–ª–µ—Ç - 7 —á–∞—Å–æ–≤)
                    const isDeparture = t.direction === 'departure';
                    const checkoutTime = isDeparture ? formatCheckoutTime(t.flight_datetime) : null;

                    html += `
                        <div class="transfer-card ${urgencyClass} px-4 py-3 flex items-center gap-4 border-b last:border-b-0 cursor-pointer hover:bg-base-200/50"
                             onclick="window.location.href='../vaishnavas/person.html?id=${v?.id}'">
                            <div class="text-2xl w-12 text-center opacity-60">${directionIcon}</div>
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold truncate">${name}</div>
                                <div class="text-sm opacity-60 flex flex-wrap gap-x-3">
                                    ${phone ? `<span>üìû ${phone}</span>` : ''}
                                    ${retreatName ? `<span>${retreatName}</span>` : ''}
                                    ${accommodationStr ? `<span>üè† ${accommodationStr}</span>` : ''}
                                </div>
                            </div>
                            ${isDeparture ? `
                            <div class="text-right">
                                <div class="text-lg font-mono font-semibold text-error">${checkoutTime}</div>
                                <div class="text-xs opacity-60">–í—ã–µ–∑–¥</div>
                            </div>
                            ` : ''}
                            <div class="text-right">
                                <div class="text-lg font-mono font-semibold">${formatTime(t.flight_datetime)}</div>
                                <div class="text-xs opacity-60">${flightNumber || (isDeparture ? '–í—ã–ª–µ—Ç' : '–ü—Ä–∏–ª—ë—Ç')}</div>
                            </div>
                            ${needsTransfer ? '<div class="badge badge-primary">üöê</div>' : ''}
                            ${renderTaxiBadge(t)}
                        </div>
                    `;
                });
            });

            container.innerHTML = html;
        }

        // ==================== –¢–ê–ö–°–ò ====================
        function renderTaxiBadge(transfer) {
            if (transfer.taxi_status === 'ordered') {
                return `<div class="badge badge-success gap-1 cursor-pointer" onclick="event.stopPropagation(); showTaxiDetails('${transfer.id}')">üöï –¢–∞–∫—Å–∏ –∑–∞–∫–∞–∑–∞–Ω–æ</div>`;
            }
            return `<button class="btn btn-xs btn-outline gap-1" onclick="event.stopPropagation(); openTaxiModal('${transfer.id}')">üöï –¢–∞–∫—Å–∏</button>`;
        }

        function openTaxiModal(transferId) {
            document.getElementById('taxiTransferId').value = transferId;
            document.getElementById('taxiDriverInfo').value = '';
            document.getElementById('taxiOrderedBy').value = localStorage.getItem('srsk_taxi_name') || '';
            document.getElementById('taxiModal').showModal();
        }

        function closeTaxiModal() {
            document.getElementById('taxiModal').close();
        }

        async function saveTaxiOrder() {
            const transferId = document.getElementById('taxiTransferId').value;
            const driverInfo = document.getElementById('taxiDriverInfo').value.trim();
            const orderedBy = document.getElementById('taxiOrderedBy').value.trim();

            if (!orderedBy) {
                alert('–£–∫–∞–∂–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                return;
            }

            localStorage.setItem('srsk_taxi_name', orderedBy);

            const { error } = await Layout.db
                .from('guest_transfers')
                .update({
                    taxi_status: 'ordered',
                    taxi_driver_info: driverInfo || null,
                    taxi_ordered_by: orderedBy
                })
                .eq('id', transferId);

            if (error) {
                console.error('Error saving taxi order:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                return;
            }

            closeTaxiModal();

            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const t = transfers.find(t => t.id == transferId);
            if (t) {
                t.taxi_status = 'ordered';
                t.taxi_driver_info = driverInfo || null;
                t.taxi_ordered_by = orderedBy;
            }
            renderTransfers();
        }

        function showTaxiDetails(transferId) {
            const transfer = transfers.find(t => t.id == transferId);
            if (!transfer) return;
            document.getElementById('taxiDetailsTransferId').value = transferId;
            document.getElementById('taxiDetailsDriver').textContent = transfer.taxi_driver_info || '‚Äî';
            document.getElementById('taxiDetailsOrderedBy').textContent = transfer.taxi_ordered_by || '‚Äî';
            document.getElementById('taxiDetailsModal').showModal();
        }

        async function cancelTaxiFromDetails() {
            const transferId = document.getElementById('taxiDetailsTransferId').value;
            document.getElementById('taxiDetailsModal').close();
            await cancelTaxi(transferId);
        }

        async function cancelTaxi(transferId) {
            const { error } = await Layout.db
                .from('guest_transfers')
                .update({
                    taxi_status: null,
                    taxi_driver_info: null,
                    taxi_ordered_by: null
                })
                .eq('id', transferId);

            if (error) {
                console.error('Error cancelling taxi:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã');
                return;
            }

            const t = transfers.find(t => t.id == transferId);
            if (t) {
                t.taxi_status = null;
                t.taxi_driver_info = null;
                t.taxi_ordered_by = null;
            }
            renderTransfers();
        }

        async function init() {
            await Layout.init({ module: 'housing', menuId: 'placement', itemId: 'transfers' });
            Layout.showLoader();

            await loadTransfers();

            Layout.hideLoader();
        }

        window.onLanguageChange = () => {
            Layout.updateAllTranslations();
            renderTransfers();
        };

        init();
    </script>
</body>
</html>
