<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script src="../js/color-init.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Трансферы — ШРСК</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        .transfer-card {
            transition: background 0.2s;
        }
        .urgency-critical {
            background: #fee2e2;
            border-left: 4px solid #dc2626;
        }
        .urgency-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }
        .urgency-normal {
            background: #f3f4f6;
            border-left: 4px solid #9ca3af;
        }
        .date-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: oklch(var(--b2));
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 flex-1">

        <!-- Page Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold" data-i18n="transfers_title">Трансферы</h1>
                <p class="text-sm opacity-60 mt-1" data-i18n="transfers_subtitle">Заезды и выезды гостей</p>
            </div>
            <div class="flex items-center gap-4">
                <!-- Direction filter -->
                <div class="tabs tabs-boxed bg-base-100">
                    <button class="tab tab-active" data-filter="all" onclick="setFilter('all')">Все</button>
                    <button class="tab" data-filter="arrival" onclick="setFilter('arrival')">Заезды</button>
                    <button class="tab" data-filter="departure" onclick="setFilter('departure')">Выезды</button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats shadow mb-6 w-full">
            <div class="stat">
                <div class="stat-title">Сегодня</div>
                <div class="stat-value text-2xl" id="statToday">0</div>
            </div>
            <div class="stat">
                <div class="stat-title">Завтра</div>
                <div class="stat-value text-2xl" id="statTomorrow">0</div>
            </div>
            <div class="stat">
                <div class="stat-title">Ближайшие 7 дней</div>
                <div class="stat-value text-2xl" id="statWeek">0</div>
            </div>
            <div class="stat">
                <div class="stat-title">Нужен трансфер</div>
                <div class="stat-value text-2xl text-primary" id="statNeedTransfer">0</div>
            </div>
        </div>

        <!-- Legend -->
        <div class="flex gap-4 mb-4 text-sm">
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded bg-red-200 border-l-4 border-red-600"></div>
                <span>Менее 24 часов</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded bg-yellow-100 border-l-4 border-yellow-500"></div>
                <span>Менее 48 часов</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded bg-gray-100 border-l-4 border-gray-400"></div>
                <span>Более 48 часов</span>
            </div>
        </div>

        <!-- Transfers List -->
        <div class="bg-base-100 rounded-xl shadow" id="transfersList">
            <!-- Will be populated by JS -->
        </div>

        <div id="noTransfers" class="hidden text-center py-12 opacity-50">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mx-auto mb-2 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" />
            </svg>
            <p>Нет трансферов</p>
        </div>

    </main>

    <!-- Модалка заказа такси -->
    <dialog id="taxiModal" class="modal">
        <div class="modal-box max-w-sm">
            <h3 class="font-bold text-lg mb-4">Заказ такси</h3>
            <input type="hidden" id="taxiTransferId">
            <div class="form-control mb-3">
                <label class="label"><span class="label-text">Информация о водителе</span></label>
                <textarea id="taxiDriverInfo" class="textarea textarea-bordered" rows="3" placeholder="Имя, телефон, марка авто..."></textarea>
            </div>
            <div class="form-control mb-4">
                <label class="label"><span class="label-text">Кто заказал:</span></label>
                <input type="text" id="taxiOrderedBy" class="input input-bordered" placeholder="Кто заказывает">
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" onclick="closeTaxiModal()">Отмена</button>
                <button class="btn btn-primary" onclick="saveTaxiOrder()">Сохранить</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Модалка просмотра информации о такси -->
    <dialog id="taxiDetailsModal" class="modal">
        <div class="modal-box max-w-sm">
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-success" viewBox="0 0 103.07 59.75" fill="currentColor">
                    <path d="M5.75,53.47c-1.68-1.71-2.63-4.23-2.68-6.64,2.97-10.49,6.26-20.89,9.36-31.35,1.71-5.78,1.81-10.95,9.24-12.11h58.86c3.74.23,7.15,2.76,8.35,6.35.33,1,.31,1.98.58,2.89,3.38,11.42,6.9,22.8,10.18,34.25-.11,4.72-3.5,8.64-8.16,9.3H11.55c-2.09-.16-4.35-1.22-5.8-2.7ZM21.72,9.78c-2.2.69-1.86,2.64-2.36,4.28-3.3,10.95-6.61,21.9-9.85,32.87-.47,2.23,1.92,3.11,3.77,3.19h76.19c1.99-.17,3.63-.69,3.83-2.97-3.25-10.64-6.4-21.3-9.61-31.95-.48-1.59-.56-4.58-2.24-5.26l-59.73-.16Z"/>
                    <polygon points="60.75 20.68 63.64 26.16 67.25 20.68 72.58 20.68 66.57 29.82 72.29 38.86 66.96 38.86 63.64 33.67 61.04 38.86 55.27 38.86 60.98 29.81 55.27 20.68 60.75 20.68"/>
                    <path d="M37.96,38.86l6.09-18.15,4.45-.05,6.48,18.2h-4.76l-1.27-3.29-4.91-.14-.89,3.43h-5.19ZM48.06,31.93c-.5-1.5-.78-3.12-1.3-4.61-.1-.28-.03-.66-.42-.58l-1.45,5.19h3.17Z"/>
                    <polygon points="39.12 20.68 39.12 25.01 33.92 25.01 33.92 38.86 28.73 38.86 28.73 25.01 23.54 25.01 23.54 20.68 39.12 20.68"/>
                    <rect x="74.03" y="20.68" width="5.19" height="18.18"/>
                </svg>
                <span>Такси заказано</span>
            </h3>
            <input type="hidden" id="taxiDetailsTransferId">
            <div class="space-y-3">
                <div>
                    <div class="text-xs opacity-50 mb-1">Информация о водителе</div>
                    <div id="taxiDetailsDriver" class="whitespace-pre-wrap">—</div>
                </div>
                <div>
                    <div class="text-xs opacity-50 mb-1">Заказал</div>
                    <div id="taxiDetailsOrderedBy">—</div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" onclick="document.getElementById('taxiDetailsModal').close()">Закрыть</button>
                <button class="btn btn-error btn-outline" onclick="cancelTaxiFromDetails()">Отменить такси</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <div id="footer-placeholder"></div>

    <script src="../js/cache.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/layout.js"></script>
    <script>
        let transfers = [];
        let residentsMap = new Map();
        let currentFilter = 'all';
        const t = key => Layout.t(key);
        const e = str => Layout.escapeHtml(str);

        async function loadTransfers() {
            // Загружаем трансферы с данными о регистрации и вайшнаве
            const { data, error } = await Layout.db
                .from('guest_transfers')
                .select(`
                    *,
                    retreat_registrations (
                        id,
                        retreat_id,
                        retreats (id, name_ru, name_en, name_hi),
                        vaishnavas (id, first_name, last_name, spiritual_name, phone, telegram)
                    )
                `)
                .not('flight_datetime', 'is', null)
                .order('flight_datetime', { ascending: true });

            if (error) {
                console.error('Error loading transfers:', error);
                return;
            }

            transfers = data || [];

            // Загружаем размещения по vaishnava_id
            const vaishnavaIds = transfers
                .map(t => t.retreat_registrations?.vaishnavas?.id)
                .filter(Boolean);

            residentsMap = new Map();
            if (vaishnavaIds.length > 0) {
                const { data: resData } = await Layout.db
                    .from('residents')
                    .select('vaishnava_id, rooms(number, buildings(name_ru, name_en, name_hi))')
                    .in('vaishnava_id', vaishnavaIds)
                    .in('status', ['active', 'confirmed']);

                if (resData) {
                    resData.forEach(r => {
                        if (r.vaishnava_id && r.rooms) {
                            residentsMap.set(r.vaishnava_id, {
                                roomNumber: r.rooms.number,
                                buildingName: Layout.getName(r.rooms.buildings)
                            });
                        }
                    });
                }
            }

            updateStats();
            renderTransfers();
        }

        function updateStats() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
            const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);

            let statToday = 0, statTomorrow = 0, statWeek = 0, statNeedTransfer = 0;

            transfers.forEach(t => {
                const date = new Date(t.flight_datetime);
                const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());

                if (dateOnly.getTime() === today.getTime()) statToday++;
                if (dateOnly.getTime() === tomorrow.getTime()) statTomorrow++;
                if (date >= now && date < nextWeek) statWeek++;
                if (t.needs_transfer === 'yes') statNeedTransfer++;
            });

            document.getElementById('statToday').textContent = statToday;
            document.getElementById('statTomorrow').textContent = statTomorrow;
            document.getElementById('statWeek').textContent = statWeek;
            document.getElementById('statNeedTransfer').textContent = statNeedTransfer;
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.tabs .tab').forEach(btn => {
                btn.classList.toggle('tab-active', btn.dataset.filter === filter);
            });
            renderTransfers();
        }

        function getUrgencyClass(datetime) {
            const now = new Date();
            const transferTime = new Date(datetime);
            const hoursUntil = (transferTime - now) / (1000 * 60 * 60);

            if (hoursUntil < 0) return 'urgency-normal'; // Прошедшие
            if (hoursUntil < 24) return 'urgency-critical';
            if (hoursUntil < 48) return 'urgency-warning';
            return 'urgency-normal';
        }

        function formatTime(datetime) {
            const date = new Date(datetime);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function getCheckoutTime(flightDatetime) {
            // Выезд = время вылета минус 7 часов
            const flight = new Date(flightDatetime);
            const checkout = new Date(flight.getTime() - 7 * 60 * 60 * 1000);
            return checkout;
        }

        function formatCheckoutTime(flightDatetime) {
            const checkout = getCheckoutTime(flightDatetime);
            return formatTime(checkout);
        }

        function formatDateHeader(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);

            const isToday = date.toDateString() === today.toDateString();
            const isTomorrow = date.toDateString() === tomorrow.toDateString();

            const weekdays = ['воскресенье', 'понедельник', 'вторник', 'среда', 'четверг', 'пятница', 'суббота'];
            const months = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня', 'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'];

            const dayName = weekdays[date.getDay()];
            const formatted = `${date.getDate()} ${months[date.getMonth()]}`;

            if (isToday) return `Сегодня, ${formatted}`;
            if (isTomorrow) return `Завтра, ${formatted}`;
            return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${formatted}`;
        }

        function renderTransfers() {
            // Фильтруем
            let filtered = transfers;
            if (currentFilter !== 'all') {
                filtered = transfers.filter(t => t.direction === currentFilter);
            }

            // Показываем только будущие и сегодняшние (с небольшим запасом в прошлое — 6 часов)
            const cutoff = new Date(Date.now() - 6 * 60 * 60 * 1000);
            filtered = filtered.filter(t => new Date(t.flight_datetime) >= cutoff);

            const container = document.getElementById('transfersList');
            const noTransfers = document.getElementById('noTransfers');

            if (filtered.length === 0) {
                container.innerHTML = '';
                noTransfers.classList.remove('hidden');
                return;
            }

            noTransfers.classList.add('hidden');

            // Группируем по датам
            const grouped = {};
            filtered.forEach(t => {
                const dateKey = new Date(t.flight_datetime).toDateString();
                if (!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(t);
            });

            // Сортируем даты
            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(a) - new Date(b));

            let html = '';
            sortedDates.forEach(dateKey => {
                const items = grouped[dateKey];

                html += `
                    <div class="date-header px-4 py-3 font-semibold border-b">
                        ${formatDateHeader(dateKey)}
                        <span class="badge badge-sm ml-2">${items.length}</span>
                    </div>
                `;

                items.forEach(t => {
                    const reg = t.retreat_registrations;
                    const v = reg?.vaishnavas;
                    const retreat = reg?.retreats;

                    const name = e(v?.spiritual_name || `${v?.first_name || ''} ${v?.last_name || ''}`.trim() || '—');
                    const phone = e(v?.phone || '');
                    const telegram = v?.telegram ? e(v.telegram.replace('@', '')) : '';
                    const telegramLink = telegram ? `<a href="https://t.me/${telegram}" class="link link-primary" target="_blank" onclick="event.stopPropagation()">@${telegram}</a>` : '';
                    const retreatName = Layout.getName(retreat) || '';
                    const flightNumber = t.flight_number || '';
                    const needsTransfer = t.needs_transfer === 'yes';
                    const urgencyClass = getUrgencyClass(t.flight_datetime);
                    const directionIcon = t.direction === 'arrival' ? '✈️ →' : '← ✈️';
                    const directionLabel = t.direction === 'arrival' ? 'Заезд' : 'Выезд';
                    const accommodation = v ? residentsMap.get(v.id) : null;
                    const accommodationStr = accommodation ? `${accommodation.buildingName}, ${accommodation.roomNumber}` : '';

                    // Для выездов показываем время выезда (вылет - 7 часов)
                    const isDeparture = t.direction === 'departure';
                    const checkoutTime = isDeparture ? formatCheckoutTime(t.flight_datetime) : null;

                    html += `
                        <div class="transfer-card ${urgencyClass} px-4 py-3 flex items-center gap-4 border-b last:border-b-0 cursor-pointer hover:bg-base-200/50"
                             onclick="window.location.href='../vaishnavas/person.html?id=${v?.id}'">
                            <div class="w-10 flex justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 ${t.direction === 'arrival' ? 'text-success' : 'text-error'}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    ${t.direction === 'arrival'
                                        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />'
                                        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />'
                                    }
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold truncate">${name}</div>
                                <div class="text-sm flex flex-wrap gap-x-3">
                                    ${phone ? `<span class="opacity-60">${phone}</span>` : ''}
                                    ${telegramLink ? `<span>${telegramLink}</span>` : ''}
                                    ${retreatName ? `<span class="opacity-60">${retreatName}</span>` : ''}
                                    ${accommodationStr ? `<span>${accommodationStr}</span>` : ''}
                                </div>
                            </div>
                            ${isDeparture ? `
                            <div class="text-right">
                                <div class="text-lg font-mono font-semibold text-error">${checkoutTime}</div>
                                <div class="text-xs opacity-60">Выезд</div>
                            </div>
                            ` : ''}
                            <div class="text-right">
                                <div class="text-lg font-mono font-semibold">${formatTime(t.flight_datetime)}</div>
                                <div class="text-xs opacity-60">${flightNumber || (isDeparture ? 'Вылет' : 'Прилёт')}</div>
                            </div>
                            ${needsTransfer ? '<div class="badge badge-primary gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" /></svg>Нужен трансфер</div>' : ''}
                            ${renderTaxiBadge(t)}
                        </div>
                    `;
                });
            });

            container.innerHTML = html;
        }

        // ==================== ТАКСИ ====================
        function renderTaxiBadge(transfer) {
            const taxiIcon = '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 103.07 59.75" fill="currentColor"><path d="M5.75,53.47c-1.68-1.71-2.63-4.23-2.68-6.64,2.97-10.49,6.26-20.89,9.36-31.35,1.71-5.78,1.81-10.95,9.24-12.11h58.86c3.74.23,7.15,2.76,8.35,6.35.33,1,.31,1.98.58,2.89,3.38,11.42,6.9,22.8,10.18,34.25-.11,4.72-3.5,8.64-8.16,9.3H11.55c-2.09-.16-4.35-1.22-5.8-2.7ZM21.72,9.78c-2.2.69-1.86,2.64-2.36,4.28-3.3,10.95-6.61,21.9-9.85,32.87-.47,2.23,1.92,3.11,3.77,3.19h76.19c1.99-.17,3.63-.69,3.83-2.97-3.25-10.64-6.4-21.3-9.61-31.95-.48-1.59-.56-4.58-2.24-5.26l-59.73-.16Z"/><polygon points="60.75 20.68 63.64 26.16 67.25 20.68 72.58 20.68 66.57 29.82 72.29 38.86 66.96 38.86 63.64 33.67 61.04 38.86 55.27 38.86 60.98 29.81 55.27 20.68 60.75 20.68"/><path d="M37.96,38.86l6.09-18.15,4.45-.05,6.48,18.2h-4.76l-1.27-3.29-4.91-.14-.89,3.43h-5.19ZM48.06,31.93c-.5-1.5-.78-3.12-1.3-4.61-.1-.28-.03-.66-.42-.58l-1.45,5.19h3.17Z"/><polygon points="39.12 20.68 39.12 25.01 33.92 25.01 33.92 38.86 28.73 38.86 28.73 25.01 23.54 25.01 23.54 20.68 39.12 20.68"/><rect x="74.03" y="20.68" width="5.19" height="18.18"/></svg>';
            if (transfer.taxi_status === 'ordered') {
                return `<div class="badge badge-success gap-1 cursor-pointer" onclick="event.stopPropagation(); showTaxiDetails('${transfer.id}')">${taxiIcon}Такси заказано</div>`;
            }
            return `<button class="btn btn-xs btn-outline gap-1" onclick="event.stopPropagation(); openTaxiModal('${transfer.id}')">${taxiIcon}Заказать такси</button>`;
        }

        function openTaxiModal(transferId) {
            document.getElementById('taxiTransferId').value = transferId;
            document.getElementById('taxiDriverInfo').value = '';
            document.getElementById('taxiOrderedBy').value = localStorage.getItem('srsk_taxi_name') || '';
            document.getElementById('taxiModal').showModal();
        }

        function closeTaxiModal() {
            document.getElementById('taxiModal').close();
        }

        async function saveTaxiOrder() {
            const transferId = document.getElementById('taxiTransferId').value;
            const driverInfo = document.getElementById('taxiDriverInfo').value.trim();
            const orderedBy = document.getElementById('taxiOrderedBy').value.trim();

            if (!orderedBy) {
                alert('Укажите ваше имя');
                return;
            }

            localStorage.setItem('srsk_taxi_name', orderedBy);

            const { error } = await Layout.db
                .from('guest_transfers')
                .update({
                    taxi_status: 'ordered',
                    taxi_driver_info: driverInfo || null,
                    taxi_ordered_by: orderedBy
                })
                .eq('id', transferId);

            if (error) {
                console.error('Error saving taxi order:', error);
                alert('Ошибка сохранения');
                return;
            }

            closeTaxiModal();

            // Обновляем локальные данные
            const t = transfers.find(t => t.id == transferId);
            if (t) {
                t.taxi_status = 'ordered';
                t.taxi_driver_info = driverInfo || null;
                t.taxi_ordered_by = orderedBy;
            }
            renderTransfers();
        }

        function showTaxiDetails(transferId) {
            const transfer = transfers.find(t => t.id == transferId);
            if (!transfer) return;
            document.getElementById('taxiDetailsTransferId').value = transferId;
            document.getElementById('taxiDetailsDriver').textContent = transfer.taxi_driver_info || '—';
            document.getElementById('taxiDetailsOrderedBy').textContent = transfer.taxi_ordered_by || '—';
            document.getElementById('taxiDetailsModal').showModal();
        }

        async function cancelTaxiFromDetails() {
            const transferId = document.getElementById('taxiDetailsTransferId').value;
            document.getElementById('taxiDetailsModal').close();
            await cancelTaxi(transferId);
        }

        async function cancelTaxi(transferId) {
            const { error } = await Layout.db
                .from('guest_transfers')
                .update({
                    taxi_status: null,
                    taxi_driver_info: null,
                    taxi_ordered_by: null
                })
                .eq('id', transferId);

            if (error) {
                console.error('Error cancelling taxi:', error);
                alert('Ошибка отмены');
                return;
            }

            const t = transfers.find(t => t.id == transferId);
            if (t) {
                t.taxi_status = null;
                t.taxi_driver_info = null;
                t.taxi_ordered_by = null;
            }
            renderTransfers();
        }

        async function init() {
            await Layout.init({ module: 'housing', menuId: 'placement', itemId: 'transfers' });
            Layout.showLoader();

            await loadTransfers();

            Layout.hideLoader();
        }

        window.onLanguageChange = () => {
            Layout.updateAllTranslations();
            renderTransfers();
        };

        init();
    </script>
</body>
</html>
