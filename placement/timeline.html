<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <!-- v2026-02-01-checkout -->
    <script src="../js/color-init.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Шахматка — ШРСК</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        /* Основная таблица */
        .timeline-table {
            border-collapse: separate;
            border-spacing: 0;
        }

        .timeline-table th,
        .timeline-table td {
            padding: 0;
            height: 32px;
            vertical-align: middle;
        }

        /* Границы: только правая и нижняя чтобы избежать двойных линий */
        .timeline-table th,
        .timeline-table td {
            border: none;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
        }

        /* Тёмная граница слева у первой половины дня (начало дня) */
        .day-start {
            border-left: 2px solid #9ca3af !important;
        }

        /* Ширина ячейки = половина дня */
        .half-day {
            width: 24px;
            min-width: 24px;
            max-width: 24px;
        }

        /* Левая колонка - закреплена */
        .sticky-col {
            position: sticky !important;
            left: 0 !important;
            background: white;
            z-index: 10;
            width: 160px;
            min-width: 160px;
            padding: 0 12px;
            text-align: left;
            white-space: nowrap;
            border-right: 2px solid #9ca3af;
        }

        /* Заголовок таблицы - каждая ячейка sticky */
        .timeline-table thead th {
            position: sticky;
            z-index: 15;
            background: #f3f4f6;
            border-color: #d1d5db !important;
        }

        .timeline-table thead th.sticky-col {
            z-index: 20;
            background: #f3f4f6;
        }

        /* ===== ПОЛОСА РЕТРИТОВ (отдельный div) ===== */
        .retreats-bar {
            height: 34px;
            background: #f3f4f6;
            border-bottom: 1px solid #d1d5db;
            display: flex;
            flex-shrink: 0;
        }

        .retreats-label {
            min-width: 160px;
            width: 160px;
            background: #f3f4f6;
            flex-shrink: 0;
        }

        .retreats-content {
            position: relative;
            flex: 1;
            overflow: hidden;
        }

        .retreats-scroll {
            display: flex;
            height: 100%;
            position: relative;
        }

        /* Половина дня в полосе ретритов */
        .retreat-half {
            min-width: 24px;
            width: 24px;
            flex-shrink: 0;
            background: #f3f4f6;
            border: none !important;
        }

        .retreat-chip {
            position: absolute;
            top: 0;
            height: 34px;
            background: #10b981;
            color: white;
            font-size: 14px;
            font-weight: 600;
            padding: 0 10px;
            border-radius: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 34px;
        }

        .month-label {
            position: absolute;
            top: 0;
            height: 34px;
            line-height: 34px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(0, 0, 0, 0.45);
            z-index: 2;
            pointer-events: none;
            padding-left: 4px;
            white-space: nowrap;
        }

        /* Строка с числами — top: 0 (ретриты теперь отдельно) */
        .row-dates th {
            top: 0;
        }

        /* Строка с днями недели — top: 32px */
        .row-weekdays th {
            top: 32px;
        }

        /* Выходные и сегодня в заголовке */
        .timeline-table thead th.weekend {
            background: #fef2f2;
        }

        .timeline-table thead th.today {
            background: #dbeafe;
        }

        /* Строка с числами */
        .row-dates th {
            font-weight: 600;
            font-size: 13px;
            text-align: center;
        }

        /* Строка с днями недели */
        .row-weekdays th {
            font-weight: 400;
            font-size: 10px;
            color: #6b7280;
            text-transform: uppercase;
            text-align: center;
        }

        /* Заголовок здания */
        .row-building td {
            background: #d1d5db !important;
            font-weight: 600;
            font-size: 14px;
            border-top: 4px solid #6b7280 !important;
            height: 44px;
        }

        .row-building .sticky-col {
            background: #d1d5db !important;
            cursor: pointer;
            user-select: none;
            border-top: 4px solid #6b7280 !important;
        }

        .row-building .sticky-col:hover {
            background: #c0c5cc !important;
        }

        /* Временное здание — светлее */
        .row-building.temporary td {
            background: #e8e8e8 !important;
        }

        .row-building.temporary .sticky-col {
            background: #e8e8e8 !important;
        }

        .row-building.temporary .sticky-col:hover {
            background: #dcdcdc !important;
        }

        /* Заголовок номера */
        .row-room td {
            background: #e5e7eb !important;
            font-weight: 500;
            font-size: 13px;
            border-bottom: 2px solid #d1d5db !important;
            position: relative; /* для позиционирования cleaning-bar */
        }

        .row-room .sticky-col {
            background: #e5e7eb !important;
            cursor: pointer;
            user-select: none;
            padding-left: 20px;
        }

        .row-room .sticky-col:hover {
            background: #d6d9dc !important;
        }

        /* Строка места */
        .row-bed .sticky-col {
            padding-left: 36px;
            font-size: 13px;
            color: #374151;
        }

        /* Полоска гостя — абсолютное позиционирование */
        .guest-bar {
            position: absolute;
            top: 3px;
            left: 1px;
            background: #3b82f6;
            border: 1px solid #2563eb;
            color: white;
            height: 24px;
            border-radius: 4px;
            font-size: 11px;
            padding: 0 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            z-index: 5;
            cursor: pointer;
        }

        .guest-bar:hover {
            filter: brightness(0.95);
        }

        /* Бронирование — штриховка */
        .guest-bar.booking {
            background: repeating-linear-gradient(
                45deg,
                var(--bar-color),
                var(--bar-color) 4px,
                rgba(255,255,255,0.5) 4px,
                rgba(255,255,255,0.5) 8px
            );
            border-style: dashed;
        }

        /* Выселенный — серый */
        .guest-bar.checked-out {
            background: #d1d5db !important;
            border-color: #9ca3af !important;
            color: #6b7280;
        }

        .room-summary-bar.checked-out {
            background: #d1d5db !important;
            border-color: #9ca3af !important;
            color: #6b7280;
        }

        /* Уборка */
        .cleaning-bar {
            position: absolute;
            top: 3px;
            left: 1px;
            background: #9ca3af;
            height: 24px;
            border-radius: 4px;
            padding: 0 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4;
            color: white;
        }

        .cleaning-bar.clickable {
            cursor: pointer;
        }

        .cleaning-bar.clickable:hover {
            filter: brightness(0.9);
        }

        .cleaning-bar svg {
            width: 16px;
            height: 16px;
        }

        .cleaning-bar.completed {
            background: #22c55e;
        }

        .cleaning-bar.bedding {
            background: #06b6d4;
        }

        /* Сводная плашка в строке номера */
        .room-summary-bar {
            position: absolute;
            top: 3px;
            left: 1px;
            height: 24px;
            border-radius: 4px;
            font-size: 11px;
            padding: 0 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            z-index: 5;
            color: white;
            border: 1px solid rgba(0,0,0,0.15);
        }

        .room-summary-bar.booking {
            background: repeating-linear-gradient(
                45deg,
                var(--bar-color),
                var(--bar-color) 4px,
                rgba(255,255,255,0.5) 4px,
                rgba(255,255,255,0.5) 8px
            );
            border-style: dashed;
        }

        /* Частичная занятость — показываем дробь */
        .room-summary-bar .fraction {
            font-weight: 600;
            opacity: 0.7;
        }

        .row-room td {
            position: relative;
        }

        .row-bed td {
            position: relative;
        }

        /* Выходные дни */
        .weekend {
            background: #fef2f2 !important;
        }

        /* Сегодня */
        .today {
            background: #dbeafe !important;
        }

        /* Скрытые строки (свёрнутые) */
        .collapsed {
            display: none;
        }

        /* Калибровочная строка - всегда видима, но без высоты */
        .row-calibration {
            height: 0 !important;
            visibility: collapse;
        }
        .row-calibration td {
            height: 0 !important;
            padding: 0 !important;
            border: none !important;
        }

        /* Стрелка сворачивания */
        .toggle-arrow {
            display: inline-block;
            width: 16px;
            transition: transform 0.2s;
        }

        .toggle-arrow.collapsed {
            transform: rotate(-90deg);
        }

        /* Пустые ячейки кликабельны */
        .row-bed td.clickable {
            cursor: pointer;
        }
        .row-bed td.clickable:hover {
            background: #e0f2fe !important;
        }

        /* Fullscreen mode */
        body.board-fullscreen > header,
        body.board-fullscreen > footer {
            display: none !important;
        }
        body.board-fullscreen main {
            padding: 8px;
        }
        body.board-fullscreen .timeline-wrapper {
            max-height: calc(100vh - 70px) !important;
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen">

    <div id="header-placeholder"></div>

    <main class="px-4 py-6">
        <!-- Заголовок страницы -->
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-bold">Шахматка</h1>
                <!-- Навигация по месяцам -->
                <div class="flex gap-2">
                    <button class="btn btn-sm btn-ghost" onclick="shiftMonth(-1)" title="Месяц назад">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <button class="btn btn-sm btn-ghost" onclick="resetToToday()" title="Сегодня">Сегодня</button>
                    <button class="btn btn-sm btn-ghost" onclick="shiftMonth(1)" title="Месяц вперёд">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
            </div>
            <!-- Легенда -->
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-4" id="legend"></div>
                <button class="btn btn-ghost btn-sm btn-square" onclick="toggleFullscreen(this)" title="На весь экран">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Контейнер шахматки -->
        <div class="bg-white rounded-lg shadow flex flex-col timeline-wrapper" style="max-height: calc(100vh - 180px);">
            <!-- Полоса ретритов -->
            <div class="retreats-bar">
                <div class="retreats-label"></div>
                <div class="retreats-content">
                    <div class="retreats-scroll" id="retreatsScroll"></div>
                </div>
            </div>
            <!-- Таблица -->
            <div class="overflow-auto flex-1" id="tableContainer">
                <table class="timeline-table" id="timelineTable">
                    <!-- Генерируется через JS -->
                </table>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <!-- Модалка действий -->
    <dialog id="actionModal" class="modal">
        <div class="modal-box max-w-lg">
            <!-- Экран 1: Выбор действия -->
            <div id="actionScreen">
                <h3 class="font-bold text-lg mb-4">Действие</h3>

                <!-- Информация о месте -->
                <div class="text-sm text-gray-500 mb-4" id="modalLocation"></div>

                <!-- Даты -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">Заезд</span>
                        </label>
                        <input type="date" id="modalCheckIn" class="input input-bordered" />
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">Выезд</span>
                        </label>
                        <input type="date" id="modalCheckOut" class="input input-bordered" />
                    </div>
                </div>

                <!-- Кнопки действий -->
                <div class="grid grid-cols-2 gap-3">
                    <button class="btn btn-primary" onclick="showCheckinForm()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                        </svg>
                        Заселить
                    </button>
                    <button class="btn btn-info" onclick="showBookingForm()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        Забронировать
                    </button>
                    <button class="btn btn-warning" onclick="handleAction('cleaning')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                        </svg>
                        Уборка
                    </button>
                    <button class="btn" style="background: #06b6d4; color: white; border: none;" onclick="handleAction('bedding')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                        </svg>
                        Бельё
                    </button>
                    <button class="btn btn-error" onclick="handleAction('repair')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                        </svg>
                        Закрыть на ремонт
                    </button>
                </div>

                <div class="modal-action">
                    <form method="dialog">
                        <button class="btn">Отмена</button>
                    </form>
                </div>
            </div>

            <!-- Экран 2: Форма заселения -->
            <div id="checkinScreen" class="hidden">
                <div class="flex items-center gap-2 mb-4">
                    <button class="btn btn-ghost btn-sm btn-circle" onclick="showActionScreen()">←</button>
                    <h3 class="font-bold text-lg">Заселение</h3>
                </div>

                <div class="text-sm text-gray-500 mb-4" id="checkinLocation"></div>

                <form id="checkinForm" onsubmit="saveCheckin(event)">
                    <!-- Категория -->
                    <div class="form-control mb-3">
                        <label class="label">
                            <span class="label-text font-medium">Категория</span>
                        </label>
                        <select name="category_id" id="checkinCategory" class="select select-bordered w-full">
                            <option value="">—</option>
                        </select>
                    </div>

                    <!-- Выбор вайшнава -->
                    <div class="form-control mb-3">
                        <label class="label">
                            <span class="label-text font-medium">Вайшнав</span>
                        </label>
                        <div class="relative">
                            <input type="hidden" name="vaishnava_id" id="checkinVaishnavId" />
                            <input type="text" id="checkinVaishnavSearch" class="input input-bordered w-full pr-16"
                                   placeholder="Поиск по имени..."
                                   autocomplete="off"
                                   oninput="searchVaishnavas(this.value)"
                                   onfocus="showVaishnavaSuggestions()" />
                            <div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1">
                                <button type="button" class="btn btn-ghost btn-xs hidden" id="clearVaishnava" onclick="clearVaishnavSelection()">✕</button>
                                <a href="../vaishnavas/person.html" target="_blank" class="btn btn-ghost btn-xs" title="Добавить нового">+</a>
                            </div>
                            <div id="vaishnavaSuggestions" class="hidden absolute z-50 w-full bg-base-100 shadow-lg rounded-lg mt-1 max-h-48 overflow-y-auto border"></div>
                        </div>
                    </div>

                    <!-- Данные нового гостя (если не выбран существующий) -->
                    <div id="guestFields">
                        <div class="divider text-sm opacity-60">Или новый гость</div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text">Имя</span>
                                </label>
                                <input type="text" name="guest_name" id="checkinGuestName" class="input input-bordered input-sm w-full" />
                            </div>
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text">Телефон</span>
                                </label>
                                <input type="tel" name="guest_phone" class="input input-bordered input-sm w-full" />
                            </div>
                        </div>
                    </div>

                    <!-- Даты -->
                    <div class="divider text-sm opacity-60"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">Заезд</span>
                            </label>
                            <input type="date" name="check_in" id="checkinDateIn" class="input input-bordered input-sm w-full" required />
                            <label class="label cursor-pointer justify-start gap-2 py-1">
                                <input type="checkbox" name="early_checkin" class="checkbox checkbox-sm checkbox-primary" />
                                <span class="label-text text-sm">Ранний заезд</span>
                            </label>
                        </div>
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">Выезд</span>
                            </label>
                            <input type="date" name="check_out" id="checkinDateOut" class="input input-bordered input-sm w-full" />
                            <label class="label cursor-pointer justify-start gap-2 py-1">
                                <input type="checkbox" name="late_checkout" class="checkbox checkbox-sm checkbox-primary" />
                                <span class="label-text text-sm">Поздний выезд</span>
                            </label>
                        </div>
                    </div>

                    <!-- Питание -->
                    <div class="form-control mt-3">
                        <label class="label py-1">
                            <span class="label-text font-medium">Питание</span>
                        </label>
                        <select name="meal_type" class="select select-bordered select-sm w-full">
                            <option value="prasad">С нами</option>
                            <option value="child">Детское</option>
                            <option value="self">Самостоятельно</option>
                        </select>
                    </div>

                    <!-- Примечания -->
                    <div class="form-control mt-3">
                        <label class="label py-1">
                            <span class="label-text">Примечания</span>
                        </label>
                        <textarea name="notes" rows="2" class="textarea textarea-bordered textarea-sm w-full"></textarea>
                    </div>

                    <div class="modal-action">
                        <button type="button" class="btn btn-ghost" onclick="showActionScreen()">Назад</button>
                        <button type="submit" class="btn btn-primary">Заселить</button>
                    </div>
                </form>
            </div>

            <!-- Экран 3: Форма бронирования -->
            <div id="bookingScreen" class="hidden">
                <div class="flex items-center gap-2 mb-4">
                    <button class="btn btn-ghost btn-sm btn-circle" onclick="showActionScreen()">←</button>
                    <h3 class="font-bold text-lg">Бронирование</h3>
                </div>

                <div class="text-sm text-gray-500 mb-4" id="bookingLocation"></div>

                <form id="bookingForm" onsubmit="saveBooking(event)">
                    <!-- Название брони -->
                    <div class="form-control mb-3">
                        <label class="label py-1">
                            <span class="label-text font-medium">Название брони</span>
                        </label>
                        <input type="text" name="name" class="input input-bordered input-sm w-full" placeholder="Например: Группа из Москвы" />
                    </div>

                    <!-- Контакт -->
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">Контактное лицо</span>
                            </label>
                            <input type="text" name="contact_name" class="input input-bordered input-sm w-full" required />
                        </div>
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">Телефон</span>
                            </label>
                            <input type="tel" name="contact_phone" class="input input-bordered input-sm w-full" />
                        </div>
                    </div>

                    <!-- Даты -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">Заезд</span>
                            </label>
                            <input type="date" name="check_in" id="bookingDateIn" class="input input-bordered input-sm w-full" required />
                            <label class="label cursor-pointer justify-start gap-2 py-1">
                                <input type="checkbox" name="early_checkin" class="checkbox checkbox-sm checkbox-info" />
                                <span class="label-text text-sm">Ранний заезд</span>
                            </label>
                        </div>
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">Выезд</span>
                            </label>
                            <input type="date" name="check_out" id="bookingDateOut" class="input input-bordered input-sm w-full" required />
                            <label class="label cursor-pointer justify-start gap-2 py-1">
                                <input type="checkbox" name="late_checkout" class="checkbox checkbox-sm checkbox-info" />
                                <span class="label-text text-sm">Поздний выезд</span>
                            </label>
                        </div>
                    </div>

                    <!-- Количество мест -->
                    <div class="form-control mt-3">
                        <label class="label py-1">
                            <span class="label-text font-medium">Количество мест</span>
                        </label>
                        <input type="number" name="beds_count" min="1" value="1" class="input input-bordered input-sm w-full" required />
                    </div>

                    <!-- Примечания -->
                    <div class="form-control mt-3">
                        <label class="label py-1">
                            <span class="label-text">Примечания</span>
                        </label>
                        <textarea name="notes" rows="2" class="textarea textarea-bordered textarea-sm w-full"></textarea>
                    </div>

                    <div class="modal-action">
                        <button type="button" class="btn btn-ghost" onclick="showActionScreen()">Назад</button>
                        <button type="submit" class="btn btn-info">Забронировать</button>
                    </div>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Модалка уборки -->
    <dialog id="cleaningModal" class="modal">
        <div class="modal-box max-w-sm">
            <h3 class="font-bold text-lg mb-2 flex items-center gap-2">
                <svg class="w-5 h-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                </svg>
                Уборка
            </h3>

            <div class="text-sm text-gray-500 mb-4" id="cleaningModalLocation"></div>

            <!-- Даты уборки -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="form-control">
                    <label class="label py-1">
                        <span class="label-text font-medium">Начало</span>
                    </label>
                    <input type="date" id="cleaningStartDate" class="input input-bordered input-sm" disabled />
                </div>
                <div class="form-control">
                    <label class="label py-1">
                        <span class="label-text font-medium">Окончание</span>
                    </label>
                    <input type="date" id="cleaningEndDate" class="input input-bordered input-sm" />
                </div>
            </div>

            <!-- Статус выполнено -->
            <div id="cleaningCompletedStatus" class="hidden alert alert-success mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                <span>Уборка выполнена</span>
            </div>

            <!-- Кнопки действий (скрываются для выполненных и без прав) -->
            <div id="cleaningActions" class="grid grid-cols-2 gap-3 mb-3" data-permission="manage_cleaning">
                <button class="btn btn-success" onclick="completeCleaning()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Выполнена
                </button>
                <button class="btn btn-info" onclick="extendCleaning()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6l4 2m6-2a10 10 0 11-20 0 10 10 0 0120 0z" />
                    </svg>
                    Продлить
                </button>
            </div>

            <!-- Кнопка удаления (только с правами manage_cleaning) -->
            <button id="cleaningDeleteBtn" class="btn btn-ghost btn-sm text-error w-full" onclick="deleteCleaning()" data-permission="manage_cleaning">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Удалить
            </button>

            <div class="modal-action">
                <form method="dialog">
                    <button class="btn">Закрыть</button>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Модалка резидента/брони -->
    <dialog id="residentModal" class="modal">
        <div class="modal-box max-w-lg">
            <!-- Экран информации -->
            <div id="residentInfoScreen">
                <h3 class="font-bold text-lg mb-2" id="residentModalTitle">Резидент</h3>
                <div class="text-sm text-gray-500 mb-4" id="residentModalLocation"></div>

                <!-- Информация -->
                <div class="space-y-2 mb-4" id="residentInfo"></div>

                <!-- Кнопки действий -->
                <div class="grid grid-cols-2 gap-3" id="residentActions"></div>

                <div class="modal-action">
                    <form method="dialog">
                        <button class="btn">Закрыть</button>
                    </form>
                </div>
            </div>

            <!-- Экран выбора номера для перемещения -->
            <div id="moveScreen" class="hidden">
                <div class="flex items-center gap-2 mb-4">
                    <button class="btn btn-ghost btn-sm btn-circle" onclick="showResidentInfoScreen()">←</button>
                    <h3 class="font-bold text-lg">Перенос в номер</h3>
                </div>

                <div class="text-sm text-gray-500 mb-4">
                    Выберите новый номер для <span id="moveGuestName" class="font-medium"></span>
                </div>

                <!-- Список зданий и номеров -->
                <div class="max-h-64 overflow-y-auto space-y-2" id="roomsList"></div>

                <div class="modal-action">
                    <button class="btn btn-ghost" onclick="showResidentInfoScreen()">Отмена</button>
                </div>
            </div>

            <!-- Экран редактирования дат -->
            <div id="editDatesScreen" class="hidden">
                <div class="flex items-center gap-2 mb-4">
                    <button class="btn btn-ghost btn-sm btn-circle" onclick="showResidentInfoScreen()">←</button>
                    <h3 class="font-bold text-lg">Изменить даты</h3>
                </div>

                <div class="text-sm text-gray-500 mb-4">
                    <span id="editDatesGuestName" class="font-medium"></span>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text">Заезд</span></label>
                        <input type="date" id="editCheckIn" class="input input-bordered">
                        <label class="label cursor-pointer justify-start gap-2 mt-1">
                            <input type="checkbox" id="editEarlyCheckin" class="checkbox checkbox-sm">
                            <span class="label-text">Ранний заезд</span>
                        </label>
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Выезд</span></label>
                        <input type="date" id="editCheckOut" class="input input-bordered">
                        <label class="label cursor-pointer justify-start gap-2 mt-1">
                            <input type="checkbox" id="editLateCheckout" class="checkbox checkbox-sm">
                            <span class="label-text">Поздний выезд</span>
                        </label>
                    </div>
                </div>

                <div class="modal-action">
                    <button class="btn btn-ghost" onclick="showResidentInfoScreen()">Отмена</button>
                    <button class="btn btn-primary" onclick="saveDates()">Сохранить</button>
                </div>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <script src="../js/config.js"></script>
    <script src="../js/auth-check.js?v=3"></script>
    <script src="../js/cache.js"></script>
    <script src="../js/utils.js?v=2"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/date-utils.js"></script>
    <script src="../js/layout.js?v=5"></script>
    <script>
    function toggleFullscreen(btn) {
        const isFS = document.body.classList.toggle('board-fullscreen');
        if (btn) { btn.classList.toggle('btn-active', isFS); btn.title = isFS ? 'Обычный вид' : 'На весь экран'; }
    }
    </script>
    <script src="../js/pages/timeline.js?v=3"></script>

</body>
</html>
