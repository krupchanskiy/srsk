<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <!-- v2026-02-01-checkout -->
    <script src="../js/color-init.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Шахматка — ШРСК</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        /* Основная таблица */
        .timeline-table {
            border-collapse: separate;
            border-spacing: 0;
        }

        .timeline-table th,
        .timeline-table td {
            padding: 0;
            height: 32px;
            vertical-align: middle;
        }

        /* Границы: только правая и нижняя чтобы избежать двойных линий */
        .timeline-table th,
        .timeline-table td {
            border: none;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
        }

        /* Тёмная граница слева у первой половины дня (начало дня) */
        .day-start {
            border-left: 2px solid #9ca3af !important;
        }

        /* Ширина ячейки = половина дня */
        .half-day {
            width: 24px;
            min-width: 24px;
            max-width: 24px;
        }

        /* Левая колонка - закреплена */
        .sticky-col {
            position: sticky !important;
            left: 0 !important;
            background: white;
            z-index: 10;
            width: 160px;
            min-width: 160px;
            padding: 0 12px;
            text-align: left;
            white-space: nowrap;
            border-right: 2px solid #9ca3af;
        }

        /* Заголовок таблицы - каждая ячейка sticky */
        .timeline-table thead th {
            position: sticky;
            z-index: 15;
            background: #f3f4f6;
            border-color: #d1d5db !important;
        }

        .timeline-table thead th.sticky-col {
            z-index: 20;
            background: #f3f4f6;
        }

        /* ===== ПОЛОСА РЕТРИТОВ (отдельный div) ===== */
        .retreats-bar {
            height: 34px;
            background: #f3f4f6;
            border-bottom: 1px solid #d1d5db;
            display: flex;
            flex-shrink: 0;
        }

        .retreats-label {
            min-width: 160px;
            width: 160px;
            background: #f3f4f6;
            flex-shrink: 0;
        }

        .retreats-content {
            position: relative;
            flex: 1;
            overflow: hidden;
        }

        .retreats-scroll {
            display: flex;
            height: 100%;
            position: relative;
        }

        /* Половина дня в полосе ретритов */
        .retreat-half {
            min-width: 24px;
            width: 24px;
            flex-shrink: 0;
            background: #f3f4f6;
            border: none !important;
        }

        .retreat-chip {
            position: absolute;
            top: 0;
            height: 34px;
            background: #10b981;
            color: white;
            font-size: 14px;
            font-weight: 600;
            padding: 0 10px;
            border-radius: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 34px;
        }

        .month-label {
            position: absolute;
            top: 0;
            height: 34px;
            line-height: 34px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(0, 0, 0, 0.45);
            z-index: 2;
            pointer-events: none;
            padding-left: 4px;
            white-space: nowrap;
        }

        /* Строка с числами — top: 0 (ретриты теперь отдельно) */
        .row-dates th {
            top: 0;
        }

        /* Строка с днями недели — top: 32px */
        .row-weekdays th {
            top: 32px;
        }

        /* Выходные и сегодня в заголовке */
        .timeline-table thead th.weekend {
            background: #fef2f2;
        }

        .timeline-table thead th.today {
            background: #dbeafe;
        }

        /* Строка с числами */
        .row-dates th {
            font-weight: 600;
            font-size: 13px;
            text-align: center;
        }

        /* Строка с днями недели */
        .row-weekdays th {
            font-weight: 400;
            font-size: 10px;
            color: #6b7280;
            text-transform: uppercase;
            text-align: center;
        }

        /* Заголовок здания */
        .row-building td {
            background: #d1d5db !important;
            font-weight: 600;
            font-size: 14px;
            border-top: 4px solid #6b7280 !important;
            height: 44px;
        }

        .row-building .sticky-col {
            background: #d1d5db !important;
            cursor: pointer;
            user-select: none;
            border-top: 4px solid #6b7280 !important;
        }

        .row-building .sticky-col:hover {
            background: #c0c5cc !important;
        }

        /* Временное здание — светлее */
        .row-building.temporary td {
            background: #e8e8e8 !important;
        }

        .row-building.temporary .sticky-col {
            background: #e8e8e8 !important;
        }

        .row-building.temporary .sticky-col:hover {
            background: #dcdcdc !important;
        }

        /* Заголовок номера */
        .row-room td {
            background: #e5e7eb !important;
            font-weight: 500;
            font-size: 13px;
            border-bottom: 2px solid #d1d5db !important;
            position: relative; /* для позиционирования cleaning-bar */
        }

        .row-room .sticky-col {
            background: #e5e7eb !important;
            cursor: pointer;
            user-select: none;
            padding-left: 20px;
        }

        .row-room .sticky-col:hover {
            background: #d6d9dc !important;
        }

        /* Строка места */
        .row-bed .sticky-col {
            padding-left: 36px;
            font-size: 13px;
            color: #374151;
        }

        /* Полоска гостя — абсолютное позиционирование */
        .guest-bar {
            position: absolute;
            top: 3px;
            left: 1px;
            background: #fef08a;
            border: 1px solid #facc15;
            height: 24px;
            border-radius: 4px;
            font-size: 11px;
            padding: 0 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            z-index: 5;
            cursor: pointer;
        }

        .guest-bar:hover {
            filter: brightness(0.95);
        }

        /* Бронирование — штриховка */
        .guest-bar.booking {
            background: repeating-linear-gradient(
                45deg,
                var(--bar-color),
                var(--bar-color) 4px,
                rgba(255,255,255,0.5) 4px,
                rgba(255,255,255,0.5) 8px
            );
            border-style: dashed;
        }

        /* Выселенный — серый */
        .guest-bar.checked-out {
            background: #d1d5db !important;
            border-color: #9ca3af !important;
            color: #6b7280;
        }

        .room-summary-bar.checked-out {
            background: #d1d5db !important;
            border-color: #9ca3af !important;
            color: #6b7280;
        }

        /* Уборка */
        .cleaning-bar {
            position: absolute;
            top: 3px;
            left: 1px;
            background: #9ca3af;
            height: 24px;
            border-radius: 4px;
            padding: 0 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4;
            color: white;
        }

        .cleaning-bar.clickable {
            cursor: pointer;
        }

        .cleaning-bar.clickable:hover {
            filter: brightness(0.9);
        }

        .cleaning-bar svg {
            width: 16px;
            height: 16px;
        }

        .cleaning-bar.completed {
            background: #22c55e;
        }

        .cleaning-bar.bedding {
            background: #06b6d4;
        }

        /* Сводная плашка в строке номера */
        .room-summary-bar {
            position: absolute;
            top: 3px;
            left: 1px;
            height: 24px;
            border-radius: 4px;
            font-size: 11px;
            padding: 0 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            z-index: 5;
            border: 1px solid rgba(0,0,0,0.15);
        }

        .room-summary-bar.booking {
            background: repeating-linear-gradient(
                45deg,
                var(--bar-color),
                var(--bar-color) 4px,
                rgba(255,255,255,0.5) 4px,
                rgba(255,255,255,0.5) 8px
            );
            border-style: dashed;
        }

        /* Частичная занятость — показываем дробь */
        .room-summary-bar .fraction {
            font-weight: 600;
            opacity: 0.7;
        }

        .row-room td {
            position: relative;
        }

        .row-bed td {
            position: relative;
        }

        /* Выходные дни */
        .weekend {
            background: #fef2f2 !important;
        }

        /* Сегодня */
        .today {
            background: #dbeafe !important;
        }

        /* Скрытые строки (свёрнутые) */
        .collapsed {
            display: none;
        }

        /* Калибровочная строка - всегда видима, но без высоты */
        .row-calibration {
            height: 0 !important;
            visibility: collapse;
        }
        .row-calibration td {
            height: 0 !important;
            padding: 0 !important;
            border: none !important;
        }

        /* Стрелка сворачивания */
        .toggle-arrow {
            display: inline-block;
            width: 16px;
            transition: transform 0.2s;
        }

        .toggle-arrow.collapsed {
            transform: rotate(-90deg);
        }

        /* Пустые ячейки кликабельны */
        .row-bed td.clickable {
            cursor: pointer;
        }
        .row-bed td.clickable:hover {
            background: #e0f2fe !important;
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen">

    <div id="header-placeholder"></div>

    <main class="px-4 py-6">
        <!-- Заголовок страницы -->
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-bold">Шахматка</h1>
                <!-- Навигация по месяцам -->
                <div class="flex gap-2">
                    <button class="btn btn-sm btn-ghost" onclick="shiftMonth(-1)" title="Месяц назад">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <button class="btn btn-sm btn-ghost" onclick="resetToToday()" title="Сегодня">Сегодня</button>
                    <button class="btn btn-sm btn-ghost" onclick="shiftMonth(1)" title="Месяц вперёд">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
            </div>
            <!-- Легенда -->
            <div class="flex items-center gap-4" id="legend"></div>
        </div>

        <!-- Контейнер шахматки -->
        <div class="bg-white rounded-lg shadow flex flex-col" style="max-height: calc(100vh - 180px);">
            <!-- Полоса ретритов -->
            <div class="retreats-bar">
                <div class="retreats-label"></div>
                <div class="retreats-content">
                    <div class="retreats-scroll" id="retreatsScroll"></div>
                </div>
            </div>
            <!-- Таблица -->
            <div class="overflow-auto flex-1" id="tableContainer">
                <table class="timeline-table" id="timelineTable">
                    <!-- Генерируется через JS -->
                </table>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <!-- Модалка действий -->
    <dialog id="actionModal" class="modal">
        <div class="modal-box max-w-lg">
            <!-- Экран 1: Выбор действия -->
            <div id="actionScreen">
                <h3 class="font-bold text-lg mb-4">Действие</h3>

                <!-- Информация о месте -->
                <div class="text-sm text-gray-500 mb-4" id="modalLocation"></div>

                <!-- Даты -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">Заезд</span>
                        </label>
                        <input type="date" id="modalCheckIn" class="input input-bordered" />
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">Выезд</span>
                        </label>
                        <input type="date" id="modalCheckOut" class="input input-bordered" />
                    </div>
                </div>

                <!-- Кнопки действий -->
                <div class="grid grid-cols-2 gap-3">
                    <button class="btn btn-primary" onclick="showCheckinForm()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                        </svg>
                        Заселить
                    </button>
                    <button class="btn btn-info" onclick="showBookingForm()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        Забронировать
                    </button>
                    <button class="btn btn-warning" onclick="handleAction('cleaning')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                        </svg>
                        Уборка
                    </button>
                    <button class="btn" style="background: #06b6d4; color: white; border: none;" onclick="handleAction('bedding')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                        </svg>
                        Бельё
                    </button>
                    <button class="btn btn-error" onclick="handleAction('repair')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                        </svg>
                        Закрыть на ремонт
                    </button>
                </div>

                <div class="modal-action">
                    <form method="dialog">
                        <button class="btn">Отмена</button>
                    </form>
                </div>
            </div>

            <!-- Экран 2: Форма заселения -->
            <div id="checkinScreen" class="hidden">
                <div class="flex items-center gap-2 mb-4">
                    <button class="btn btn-ghost btn-sm btn-circle" onclick="showActionScreen()">←</button>
                    <h3 class="font-bold text-lg">Заселение</h3>
                </div>

                <div class="text-sm text-gray-500 mb-4" id="checkinLocation"></div>

                <form id="checkinForm" onsubmit="saveCheckin(event)">
                    <!-- Категория -->
                    <div class="form-control mb-3">
                        <label class="label">
                            <span class="label-text font-medium">Категория</span>
                        </label>
                        <select name="category_id" id="checkinCategory" class="select select-bordered w-full">
                            <option value="">—</option>
                        </select>
                    </div>

                    <!-- Выбор вайшнава -->
                    <div class="form-control mb-3">
                        <label class="label">
                            <span class="label-text font-medium">Вайшнав</span>
                        </label>
                        <div class="relative">
                            <input type="hidden" name="vaishnava_id" id="checkinVaishnavId" />
                            <input type="text" id="checkinVaishnavSearch" class="input input-bordered w-full pr-16"
                                   placeholder="Поиск по имени..."
                                   autocomplete="off"
                                   oninput="searchVaishnavas(this.value)"
                                   onfocus="showVaishnavaSuggestions()" />
                            <div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1">
                                <button type="button" class="btn btn-ghost btn-xs hidden" id="clearVaishnava" onclick="clearVaishnavSelection()">✕</button>
                                <a href="../vaishnavas/person.html" target="_blank" class="btn btn-ghost btn-xs" title="Добавить нового">+</a>
                            </div>
                            <div id="vaishnavaSuggestions" class="hidden absolute z-50 w-full bg-base-100 shadow-lg rounded-lg mt-1 max-h-48 overflow-y-auto border"></div>
                        </div>
                    </div>

                    <!-- Данные нового гостя (если не выбран существующий) -->
                    <div id="guestFields">
                        <div class="divider text-sm opacity-60">Или новый гость</div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text">Имя</span>
                                </label>
                                <input type="text" name="guest_name" id="checkinGuestName" class="input input-bordered input-sm w-full" />
                            </div>
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text">Телефон</span>
                                </label>
                                <input type="tel" name="guest_phone" class="input input-bordered input-sm w-full" />
                            </div>
                        </div>
                    </div>

                    <!-- Даты -->
                    <div class="divider text-sm opacity-60"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">Заезд</span>
                            </label>
                            <input type="date" name="check_in" id="checkinDateIn" class="input input-bordered input-sm w-full" required />
                            <label class="label cursor-pointer justify-start gap-2 py-1">
                                <input type="checkbox" name="early_checkin" class="checkbox checkbox-sm checkbox-primary" />
                                <span class="label-text text-sm">Ранний заезд</span>
                            </label>
                        </div>
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">Выезд</span>
                            </label>
                            <input type="date" name="check_out" id="checkinDateOut" class="input input-bordered input-sm w-full" />
                            <label class="label cursor-pointer justify-start gap-2 py-1">
                                <input type="checkbox" name="late_checkout" class="checkbox checkbox-sm checkbox-primary" />
                                <span class="label-text text-sm">Поздний выезд</span>
                            </label>
                        </div>
                    </div>

                    <!-- Примечания -->
                    <div class="form-control mt-3">
                        <label class="label py-1">
                            <span class="label-text">Примечания</span>
                        </label>
                        <textarea name="notes" rows="2" class="textarea textarea-bordered textarea-sm w-full"></textarea>
                    </div>

                    <div class="modal-action">
                        <button type="button" class="btn btn-ghost" onclick="showActionScreen()">Назад</button>
                        <button type="submit" class="btn btn-primary">Заселить</button>
                    </div>
                </form>
            </div>

            <!-- Экран 3: Форма бронирования -->
            <div id="bookingScreen" class="hidden">
                <div class="flex items-center gap-2 mb-4">
                    <button class="btn btn-ghost btn-sm btn-circle" onclick="showActionScreen()">←</button>
                    <h3 class="font-bold text-lg">Бронирование</h3>
                </div>

                <div class="text-sm text-gray-500 mb-4" id="bookingLocation"></div>

                <form id="bookingForm" onsubmit="saveBooking(event)">
                    <!-- Название брони -->
                    <div class="form-control mb-3">
                        <label class="label py-1">
                            <span class="label-text font-medium">Название брони</span>
                        </label>
                        <input type="text" name="name" class="input input-bordered input-sm w-full" placeholder="Например: Группа из Москвы" />
                    </div>

                    <!-- Контакт -->
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">Контактное лицо</span>
                            </label>
                            <input type="text" name="contact_name" class="input input-bordered input-sm w-full" required />
                        </div>
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">Телефон</span>
                            </label>
                            <input type="tel" name="contact_phone" class="input input-bordered input-sm w-full" />
                        </div>
                    </div>

                    <!-- Даты -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">Заезд</span>
                            </label>
                            <input type="date" name="check_in" id="bookingDateIn" class="input input-bordered input-sm w-full" required />
                            <label class="label cursor-pointer justify-start gap-2 py-1">
                                <input type="checkbox" name="early_checkin" class="checkbox checkbox-sm checkbox-info" />
                                <span class="label-text text-sm">Ранний заезд</span>
                            </label>
                        </div>
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">Выезд</span>
                            </label>
                            <input type="date" name="check_out" id="bookingDateOut" class="input input-bordered input-sm w-full" required />
                            <label class="label cursor-pointer justify-start gap-2 py-1">
                                <input type="checkbox" name="late_checkout" class="checkbox checkbox-sm checkbox-info" />
                                <span class="label-text text-sm">Поздний выезд</span>
                            </label>
                        </div>
                    </div>

                    <!-- Количество мест -->
                    <div class="form-control mt-3">
                        <label class="label py-1">
                            <span class="label-text font-medium">Количество мест</span>
                        </label>
                        <input type="number" name="beds_count" min="1" value="1" class="input input-bordered input-sm w-full" required />
                    </div>

                    <!-- Примечания -->
                    <div class="form-control mt-3">
                        <label class="label py-1">
                            <span class="label-text">Примечания</span>
                        </label>
                        <textarea name="notes" rows="2" class="textarea textarea-bordered textarea-sm w-full"></textarea>
                    </div>

                    <div class="modal-action">
                        <button type="button" class="btn btn-ghost" onclick="showActionScreen()">Назад</button>
                        <button type="submit" class="btn btn-info">Забронировать</button>
                    </div>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Модалка уборки -->
    <dialog id="cleaningModal" class="modal">
        <div class="modal-box max-w-sm">
            <h3 class="font-bold text-lg mb-2 flex items-center gap-2">
                <svg class="w-5 h-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                </svg>
                Уборка
            </h3>

            <div class="text-sm text-gray-500 mb-4" id="cleaningModalLocation"></div>

            <!-- Даты уборки -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="form-control">
                    <label class="label py-1">
                        <span class="label-text font-medium">Начало</span>
                    </label>
                    <input type="date" id="cleaningStartDate" class="input input-bordered input-sm" disabled />
                </div>
                <div class="form-control">
                    <label class="label py-1">
                        <span class="label-text font-medium">Окончание</span>
                    </label>
                    <input type="date" id="cleaningEndDate" class="input input-bordered input-sm" />
                </div>
            </div>

            <!-- Статус выполнено -->
            <div id="cleaningCompletedStatus" class="hidden alert alert-success mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                <span>Уборка выполнена</span>
            </div>

            <!-- Кнопки действий (скрываются для выполненных) -->
            <div id="cleaningActions" class="grid grid-cols-2 gap-3 mb-3">
                <button class="btn btn-success" onclick="completeCleaning()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Выполнена
                </button>
                <button class="btn btn-info" onclick="extendCleaning()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6l4 2m6-2a10 10 0 11-20 0 10 10 0 0120 0z" />
                    </svg>
                    Продлить
                </button>
            </div>

            <!-- Кнопка удаления (показывается всегда) -->
            <button id="cleaningDeleteBtn" class="btn btn-ghost btn-sm text-error w-full" onclick="deleteCleaning()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Удалить
            </button>

            <div class="modal-action">
                <form method="dialog">
                    <button class="btn">Закрыть</button>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Модалка резидента/брони -->
    <dialog id="residentModal" class="modal">
        <div class="modal-box max-w-lg">
            <!-- Экран информации -->
            <div id="residentInfoScreen">
                <h3 class="font-bold text-lg mb-2" id="residentModalTitle">Резидент</h3>
                <div class="text-sm text-gray-500 mb-4" id="residentModalLocation"></div>

                <!-- Информация -->
                <div class="space-y-2 mb-4" id="residentInfo"></div>

                <!-- Кнопки действий -->
                <div class="grid grid-cols-2 gap-3" id="residentActions"></div>

                <div class="modal-action">
                    <form method="dialog">
                        <button class="btn">Закрыть</button>
                    </form>
                </div>
            </div>

            <!-- Экран выбора номера для перемещения -->
            <div id="moveScreen" class="hidden">
                <div class="flex items-center gap-2 mb-4">
                    <button class="btn btn-ghost btn-sm btn-circle" onclick="showResidentInfoScreen()">←</button>
                    <h3 class="font-bold text-lg">Перенос в номер</h3>
                </div>

                <div class="text-sm text-gray-500 mb-4">
                    Выберите новый номер для <span id="moveGuestName" class="font-medium"></span>
                </div>

                <!-- Список зданий и номеров -->
                <div class="max-h-64 overflow-y-auto space-y-2" id="roomsList"></div>

                <div class="modal-action">
                    <button class="btn btn-ghost" onclick="showResidentInfoScreen()">Отмена</button>
                </div>
            </div>

            <!-- Экран редактирования дат -->
            <div id="editDatesScreen" class="hidden">
                <div class="flex items-center gap-2 mb-4">
                    <button class="btn btn-ghost btn-sm btn-circle" onclick="showResidentInfoScreen()">←</button>
                    <h3 class="font-bold text-lg">Изменить даты</h3>
                </div>

                <div class="text-sm text-gray-500 mb-4">
                    <span id="editDatesGuestName" class="font-medium"></span>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text">Заезд</span></label>
                        <input type="date" id="editCheckIn" class="input input-bordered">
                        <label class="label cursor-pointer justify-start gap-2 mt-1">
                            <input type="checkbox" id="editEarlyCheckin" class="checkbox checkbox-sm">
                            <span class="label-text">Ранний заезд</span>
                        </label>
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Выезд</span></label>
                        <input type="date" id="editCheckOut" class="input input-bordered">
                        <label class="label cursor-pointer justify-start gap-2 mt-1">
                            <input type="checkbox" id="editLateCheckout" class="checkbox checkbox-sm">
                            <span class="label-text">Поздний выезд</span>
                        </label>
                    </div>
                </div>

                <div class="modal-action">
                    <button class="btn btn-ghost" onclick="showResidentInfoScreen()">Отмена</button>
                    <button class="btn btn-primary" onclick="saveDates()">Сохранить</button>
                </div>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <script src="../js/config.js"></script>
    <script src="../js/auth-check.js?v=2"></script>
    <script src="../js/cache.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/layout.js"></script>
    <script>
        // Конфигурация
        const DAYS_TO_SHOW = 90; // 3 месяца
        const CELL_WIDTH = 24;   // ширина половины дня
        const e = str => Layout.escapeHtml(str);

        // Состояние сворачивания
        const collapsedBuildings = new Set();
        const collapsedRooms = new Set();

        // Данные из БД
        let timelineData = {
            retreats: [],
            buildings: []
        };

        // Справочники для форм
        let categories = [];
        let vaishnavas = [];

        // Хранилище гостей для кликов
        let guestsMap = new Map();

        // Хранилище уборок для кликов
        let cleaningsMap = new Map();

        // Базовая дата (сегодня минус 2 дня)
        let baseDate = new Date();
        baseDate.setHours(0, 0, 0, 0);
        baseDate.setDate(baseDate.getDate() - 2);

        // Индекс сегодняшнего дня относительно baseDate
        const TODAY_INDEX = 2;

        // Преобразовать дату в dayIndex относительно baseDate
        function dateToDayIndex(dateStr) {
            const date = new Date(dateStr);
            date.setHours(0, 0, 0, 0);
            const diff = date - baseDate;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        // Загрузка данных из БД
        async function loadTimelineData() {
            const endDate = new Date(baseDate);
            endDate.setDate(endDate.getDate() + DAYS_TO_SHOW);
            const startDateStr = baseDate.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];

            // Загружаем параллельно
            const [buildingsData, roomsRes, residentsRes, retreatsRes, cleaningsRes] = await Promise.all([
                Cache.getOrLoad('buildings', async () => {
                    const { data, error } = await Layout.db.from('buildings')
                        .select('*, building_types(id, slug, color, name_ru, name_en, name_hi)')
                        .eq('is_active', true)
                        .order('sort_order');
                    if (error) { console.error('Error loading buildings:', error); return null; }
                    return data;
                }),
                Layout.db.from('rooms')
                    .select('*')
                    .eq('is_active', true)
                    .order('building_id')
                    .order('floor')
                    .order('number'),
                Layout.db.from('residents')
                    .select(`*,
                        resident_categories(id, name_ru, name_en, name_hi, color),
                        vaishnavas(id, first_name, last_name, spiritual_name),
                        bookings(id, name, contact_name)`)
                    .in('status', ['active', 'confirmed', 'checked_out'])
                    .lte('check_in', endDateStr)
                    .or(`check_out.is.null,check_out.gte.${startDateStr}`),
                Layout.db.from('retreats')
                    .select('*')
                    .lte('start_date', endDateStr)
                    .gte('end_date', startDateStr)
                    .order('start_date'),
                Layout.db.from('room_cleanings')
                    .select('*')
                    .lte('start_date', endDateStr)
                    .gte('end_date', startDateStr)
            ]);

            let buildings = buildingsData || [];
            const rooms = roomsRes.data || [];
            const residents = residentsRes.data || [];
            const retreats = retreatsRes.data || [];
            const cleanings = cleaningsRes.data || [];

            // Фильтруем временные здания по датам шахматки
            buildings = buildings.filter(b => {
                // Постоянные здания показываем всегда
                if (!b.is_temporary) return true;
                // Временные — только если период аренды пересекается с диапазоном шахматки
                return b.available_from <= endDateStr && b.available_until >= startDateStr;
            });

            // Очищаем хранилища
            guestsMap.clear();
            cleaningsMap.clear();

            // Преобразуем ретриты
            timelineData.retreats = retreats.map(r => {
                const rawStartDay = dateToDayIndex(r.start_date);
                const rawEndDay = dateToDayIndex(r.end_date);
                return {
                    name: Layout.getName(r),
                    startDay: Math.max(0, rawStartDay),
                    endDay: Math.min(DAYS_TO_SHOW - 1, rawEndDay),
                    rawStartDay,
                    rawEndDay
                };
            }).filter(r => r.rawStartDay <= DAYS_TO_SHOW - 1 && r.rawEndDay >= 0);

            // Группируем комнаты по зданиям
            const roomsByBuilding = {};
            rooms.forEach(room => {
                if (!roomsByBuilding[room.building_id]) {
                    roomsByBuilding[room.building_id] = [];
                }
                roomsByBuilding[room.building_id].push(room);
            });

            // Сортируем номера числовым способом (1, 2, 3, 10, 11, а не 1, 10, 11, 2, 3)
            Object.values(roomsByBuilding).forEach(roomList => {
                roomList.sort((a, b) => {
                    // Сначала по этажу
                    if (a.floor !== b.floor) return (a.floor || 0) - (b.floor || 0);
                    // Потом по номеру (натуральная сортировка)
                    return a.number.localeCompare(b.number, undefined, { numeric: true });
                });
            });

            // Группируем резидентов по комнатам (исключаем самостоятельное размещение)
            const residentsByRoom = {};
            residents.forEach(res => {
                // Skip self-accommodation (NULL room_id)
                if (!res.room_id) return;

                if (!residentsByRoom[res.room_id]) {
                    residentsByRoom[res.room_id] = [];
                }
                residentsByRoom[res.room_id].push(res);
            });

            // Группируем ручные уборки по комнатам
            const cleaningsByRoom = {};
            cleanings.forEach(c => {
                if (!cleaningsByRoom[c.room_id]) {
                    cleaningsByRoom[c.room_id] = [];
                }
                cleaningsByRoom[c.room_id].push(c);
            });

            // Формируем структуру данных
            timelineData.buildings = buildings.map(building => {
                const buildingRooms = roomsByBuilding[building.id] || [];

                return {
                    id: building.id,
                    name: Layout.getName(building),
                    isTemporary: building.is_temporary || false,
                    availableFromDay: building.available_from ? dateToDayIndex(building.available_from) : null,
                    availableUntilDay: building.available_until ? dateToDayIndex(building.available_until) : null,
                    rooms: buildingRooms.map(room => {
                        const capacity = room.capacity || 1;
                        const roomResidents = residentsByRoom[room.id] || [];

                        // Создаём виртуальные места
                        const beds = [];
                        for (let i = 0; i < capacity; i++) {
                            beds.push({
                                name: capacity === 1 ? '' : `${i + 1}`,
                                roomId: room.id,
                                bedIndex: i,
                                guests: []
                            });
                        }

                        // Массив уборок на уровне комнаты
                        const roomCleaningsList = [];

                        // Распределяем резидентов по местам
                        // Сортируем по дате заселения
                        roomResidents.sort((a, b) => new Date(a.check_in) - new Date(b.check_in));

                        roomResidents.forEach(res => {
                            const startDay = Math.max(0, dateToDayIndex(res.check_in));
                            const endDay = res.check_out
                                ? Math.min(DAYS_TO_SHOW - 1, dateToDayIndex(res.check_out))
                                : DAYS_TO_SHOW - 1;

                            if (startDay > DAYS_TO_SHOW - 1 || endDay < 0) return;

                            // Получаем имя резидента
                            let guestName = res.guest_name || '';
                            if (res.vaishnavas) {
                                const v = res.vaishnavas;
                                guestName = v.spiritual_name || `${v.first_name} ${v.last_name}`.trim();
                            }
                            // Если это бронирование - показываем название брони или имя контакта
                            if (!guestName && res.bookings) {
                                guestName = res.bookings.name || res.bookings.contact_name || '';
                            }

                            // Определяем, это бронирование или заселение
                            // Бронирование = есть booking_id, но нет реального гостя (vaishnava или guest_name)
                            const isBooking = res.booking_id && !res.vaishnava_id && !res.guest_name;

                            // Получаем цвет категории
                            const category = res.resident_categories;
                            const color = category?.color || '#fef08a';
                            // Делаем border темнее
                            const border = color;

                            // Ранний заезд = обе половины дня заезда (startHalf = 0)
                            // Обычный заезд = только вторая половина (startHalf = 1)
                            // Поздний выезд = обе половины дня выезда (endHalf = 1)
                            // Обычный выезд = только первая половина (endHalf = 0)
                            let startHalf = res.early_checkin === true ? 0 : 1;
                            let endHalf = res.late_checkout === true ? 1 : 0;

                            // Если заезд и выезд в один день, корректируем чтобы span был минимум 1
                            if (startDay === endDay && startHalf > endHalf) {
                                // Показываем хотя бы одну половину
                                endHalf = startHalf;
                            }

                            const guest = {
                                id: res.id,
                                name: guestName || '—',
                                startDay,
                                startHalf,
                                endDay,
                                endHalf,
                                color,
                                border,
                                isBooking,
                                isCheckedOut: res.status === 'checked_out',
                                // Сырые данные для модалки
                                rawData: res
                            };

                            // Уборка после выезда (не для временных зданий)
                            // Обычный выезд (endHalf=0): уборка со второй половины дня выезда
                            // Поздний выезд (endHalf=1): уборка с первой половины СЛЕДУЮЩЕГО дня
                            // ВАЖНО: уборка создаётся только если это последний выезжающий из комнаты
                            let cleaningEntry = null;
                            const hasOthersStayingLonger = roomResidents.some(other =>
                                other.id !== res.id &&
                                (other.check_out === null || other.check_out > res.check_out)
                            );
                            if (res.check_out && !building.isTemporary && !hasOthersStayingLonger) {
                                let cleaningStartDay, cleaningStartHalf, cleaningEndDay, cleaningEndHalf;

                                if (endHalf === 0) {
                                    // Обычный выезд — уборка начинается во второй половине дня выезда
                                    cleaningStartDay = endDay;
                                    cleaningStartHalf = 1;
                                    cleaningEndDay = endDay + 1;
                                    cleaningEndHalf = 0;
                                } else {
                                    // Поздний выезд — уборка начинается на следующий день
                                    cleaningStartDay = endDay + 1;
                                    cleaningStartHalf = 0;
                                    cleaningEndDay = endDay + 1;
                                    cleaningEndHalf = 1;
                                }

                                // Если уборка попадает в диапазон отображения — показываем (выполненные тоже, но не удалённые)
                                if (cleaningStartDay < DAYS_TO_SHOW && !res.cleaning_skipped) {
                                    const autoCleaningId = 'cleaning-' + res.id;
                                    cleaningEntry = {
                                        id: autoCleaningId,
                                        cleaningId: autoCleaningId,
                                        residentId: res.id, // для обновления cleaning_done
                                        name: '<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>',
                                        startDay: cleaningStartDay,
                                        startHalf: cleaningStartHalf,
                                        endDay: Math.min(cleaningEndDay, DAYS_TO_SHOW - 1),
                                        endHalf: cleaningEndDay >= DAYS_TO_SHOW ? 1 : cleaningEndHalf,
                                        isCleaning: true,
                                        isAutoCleaning: true,
                                        isCompleted: res.cleaning_done || false,
                                        rawData: {
                                            room_id: room.id,
                                            start_date: getDateForDay(cleaningStartDay).toISOString().split('T')[0],
                                            end_date: getDateForDay(cleaningEndDay).toISOString().split('T')[0]
                                        }
                                    };
                                }
                            }

                            // Ищем свободное место для этого периода
                            let placed = false;
                            let placedBed = null;
                            for (const bed of beds) {
                                const hasOverlap = bed.guests.some(g => {
                                    if (g.isCleaning) return false; // Уборка не блокирует
                                    const gStart = g.startDay * 2 + g.startHalf;
                                    const gEnd = g.endDay * 2 + g.endHalf;
                                    const rStart = guest.startDay * 2 + guest.startHalf;
                                    const rEnd = guest.endDay * 2 + guest.endHalf;
                                    return !(rEnd < gStart || rStart > gEnd);
                                });

                                if (!hasOverlap) {
                                    bed.guests.push(guest);
                                    // Сохраняем в хранилище с контекстом
                                    guestsMap.set(guest.id, { ...guest, buildingName: Layout.getName(building), roomName: room.number });
                                    placedBed = bed;
                                    placed = true;
                                    break;
                                }
                            }

                            // Если не нашли место, добавляем в первое (будет визуальное наложение)
                            if (!placed && beds.length > 0) {
                                beds[0].guests.push(guest);
                                guestsMap.set(guest.id, { ...guest, buildingName: Layout.getName(building), roomName: room.number });
                                placedBed = beds[0];
                            }

                            // Добавляем автоуборку в cleaningsMap (не в beds!)
                            if (cleaningEntry) {
                                cleaningsMap.set(cleaningEntry.id, {
                                    ...cleaningEntry,
                                    roomId: room.id,
                                    buildingName: Layout.getName(building),
                                    roomName: room.number,
                                    isAuto: true,
                                    residentId: res.id
                                });
                                roomCleaningsList.push(cleaningEntry);
                            }
                        });

                        // Добавляем ручные уборки
                        const roomCleanings = cleaningsByRoom[room.id] || [];
                        roomCleanings.forEach(c => {
                            const startDay = Math.max(0, dateToDayIndex(c.start_date));
                            const endDay = Math.min(DAYS_TO_SHOW - 1, dateToDayIndex(c.end_date));

                            if (startDay > DAYS_TO_SHOW - 1 || endDay < 0) return;

                            // Определяем половины дня:
                            // - bedding: только первая половина дня (0-0)
                            // - cleaning с start_date === end_date: обе половины одного дня (0-1)
                            // - cleaning с end_date = start_date + 1: вторая половина первого + первая второго (1-0)
                            const isBedding = c.type === 'bedding';
                            const sameDay = c.start_date === c.end_date;
                            let startHalf, endHalf;
                            if (isBedding) {
                                startHalf = 0;
                                endHalf = 0; // только первая половина
                            } else if (sameDay) {
                                startHalf = 0;
                                endHalf = 1;
                            } else {
                                startHalf = 1;
                                endHalf = 0;
                            }

                            // Иконка зависит от типа
                            const icon = isBedding
                                ? '<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>'
                                : '<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>';

                            const cleaningEntry = {
                                id: 'manual-cleaning-' + c.id,
                                cleaningId: c.id,
                                name: icon,
                                type: c.type || 'cleaning',
                                startDay,
                                startHalf,
                                endDay,
                                endHalf,
                                isCleaning: true,
                                isManualCleaning: true,
                                isCompleted: c.completed || false,
                                rawData: c
                            };

                            // Сохраняем в хранилище с контекстом
                            cleaningsMap.set(c.id, {
                                ...cleaningEntry,
                                roomId: room.id,
                                buildingName: Layout.getName(building),
                                roomName: room.number
                            });

                            roomCleaningsList.push(cleaningEntry);
                        });

                        return {
                            id: room.id,
                            name: room.number,
                            beds,
                            cleanings: roomCleaningsList // Уборки на уровне комнаты
                        };
                    })
                };
            }).filter(b => b.rooms.length > 0);
        }

        // Получить дату для дня
        function getDateForDay(dayIndex) {
            const date = new Date(baseDate);
            date.setDate(baseDate.getDate() + dayIndex);
            return date;
        }

        // Проверка выходного
        function isWeekend(dayIndex) {
            const date = getDateForDay(dayIndex);
            const day = date.getDay();
            return day === 0 || day === 6;
        }

        // Получить день недели
        function getWeekdayName(dayIndex) {
            const days = ['вс', 'пн', 'вт', 'ср', 'чт', 'пт', 'сб'];
            const date = getDateForDay(dayIndex);
            return days[date.getDay()];
        }

        // Переключить сворачивание здания
        function toggleBuilding(buildingId) {
            if (collapsedBuildings.has(buildingId)) {
                collapsedBuildings.delete(buildingId);
            } else {
                collapsedBuildings.add(buildingId);
            }
            renderTable();
        }

        // Переключить сворачивание номера
        function toggleRoom(roomId) {
            if (collapsedRooms.has(roomId)) {
                collapsedRooms.delete(roomId);
            } else {
                collapsedRooms.add(roomId);
            }
            renderTable();
        }

        // Свернуть все номера (здания остаются развёрнутыми)
        function collapseAllRooms() {
            collapsedBuildings.clear();
            collapsedRooms.clear();
            timelineData.buildings.forEach(building => {
                building.rooms.forEach(room => {
                    collapsedRooms.add(room.id);
                });
            });
            renderTable();
        }

        // Свернуть всё (включая здания)
        function collapseAllBuildings() {
            collapsedBuildings.clear();
            collapsedRooms.clear();
            timelineData.buildings.forEach(building => {
                collapsedBuildings.add(building.id);
                building.rooms.forEach(room => {
                    collapsedRooms.add(room.id);
                });
            });
            renderTable();
        }

        // Развернуть всё
        function expandAll() {
            collapsedBuildings.clear();
            collapsedRooms.clear();
            renderTable();
        }

        // Текущий контекст модалки
        let modalContext = null;

        // Форматировать дату для input[type="date"]
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Открыть модалку действий
        function openActionModal(dayIndex, roomId, buildingName, roomName, bedName, halfIndex = 0) {
            const checkInDate = getDateForDay(dayIndex);
            const checkOutDate = getDateForDay(dayIndex + 1);

            // Сохраняем контекст (сбрасываем флаг конвертации)
            modalContext = { dayIndex, halfIndex, roomId, buildingName, roomName, bedName, isConversion: false };

            // Заполняем поля
            const location = bedName
                ? `${buildingName} → ${roomName} → Место ${bedName}`
                : `${buildingName} → ${roomName}`;
            document.getElementById('modalLocation').textContent = location;
            document.getElementById('modalCheckIn').value = formatDateForInput(checkInDate);
            document.getElementById('modalCheckOut').value = formatDateForInput(checkOutDate);

            // Показываем экран выбора действия
            showActionScreen();

            // Открываем модалку
            document.getElementById('actionModal').showModal();
        }

        // Загрузка справочников
        async function loadDictionaries() {
            const [catData, vaishnavasRes] = await Promise.all([
                Cache.getOrLoad('resident_categories', async () => {
                    const { data, error } = await Layout.db.from('resident_categories').select('*').order('sort_order');
                    if (error) { console.error('Error loading resident_categories:', error); return null; }
                    return data;
                }),
                Layout.db.from('vaishnavas').select('*').eq('is_deleted', false).order('spiritual_name')
            ]);
            categories = catData || [];
            vaishnavas = vaishnavasRes.data || [];

            // Заполняем категории
            const catSelect = document.getElementById('checkinCategory');
            catSelect.innerHTML = '<option value="">—</option>' +
                categories.map(c => `<option value="${c.id}">${Layout.getName(c)}</option>`).join('');

            // Рендерим легенду
            renderLegend();
        }

        // Легенда цветов
        function renderLegend() {
            const legend = document.getElementById('legend');

            // Категории заселений
            const categoriesHtml = categories.map(c => {
                const color = c.color || '#fef08a';
                return `<div class="flex items-center gap-1.5">
                    <span class="w-4 h-4 rounded" style="background: ${color}; border: 1px solid rgba(0,0,0,0.15);"></span>
                    <span class="text-sm text-gray-600">${Layout.getName(c)}</span>
                </div>`;
            }).join('');

            // Бронирования (штриховка)
            const bookingHtml = `<div class="flex items-center gap-1.5">
                <span class="w-4 h-4 rounded" style="background: repeating-linear-gradient(45deg, #fef08a, #fef08a 2px, rgba(255,255,255,0.5) 2px, rgba(255,255,255,0.5) 4px); border: 1px dashed rgba(0,0,0,0.3);"></span>
                <span class="text-sm text-gray-600">Бронь</span>
            </div>`;

            // Уборка и бельё
            const cleaningHtml = `<div class="flex items-center gap-1.5">
                <span class="w-4 h-4 rounded" style="background: #9ca3af;"></span>
                <span class="text-sm text-gray-600">Уборка</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="w-4 h-4 rounded" style="background: #06b6d4;"></span>
                <span class="text-sm text-gray-600">Бельё</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="w-4 h-4 rounded" style="background: #22c55e;"></span>
                <span class="text-sm text-gray-600">Готово</span>
            </div>`;

            legend.innerHTML = categoriesHtml + bookingHtml + cleaningHtml;
        }

        // Переключение экранов
        function showActionScreen() {
            document.getElementById('actionScreen').classList.remove('hidden');
            document.getElementById('checkinScreen').classList.add('hidden');
            document.getElementById('bookingScreen').classList.add('hidden');
        }

        function showCheckinForm() {
            document.getElementById('actionScreen').classList.add('hidden');
            document.getElementById('checkinScreen').classList.remove('hidden');
            document.getElementById('bookingScreen').classList.add('hidden');

            // Копируем данные
            document.getElementById('checkinLocation').textContent =
                document.getElementById('modalLocation').textContent;
            document.getElementById('checkinDateIn').value =
                document.getElementById('modalCheckIn').value;
            document.getElementById('checkinDateOut').value =
                document.getElementById('modalCheckOut').value;

            // Сбрасываем форму
            document.getElementById('checkinForm').reset();
            document.getElementById('checkinDateIn').value =
                document.getElementById('modalCheckIn').value;
            document.getElementById('checkinDateOut').value =
                document.getElementById('modalCheckOut').value;

            // Сбрасываем выбор вайшнава
            clearVaishnavSelection();
        }

        function showBookingForm() {
            document.getElementById('actionScreen').classList.add('hidden');
            document.getElementById('checkinScreen').classList.add('hidden');
            document.getElementById('bookingScreen').classList.remove('hidden');

            // Копируем данные
            document.getElementById('bookingLocation').textContent =
                document.getElementById('modalLocation').textContent;
            document.getElementById('bookingDateIn').value =
                document.getElementById('modalCheckIn').value;
            document.getElementById('bookingDateOut').value =
                document.getElementById('modalCheckOut').value;

            // Сбрасываем форму
            document.getElementById('bookingForm').reset();
            document.getElementById('bookingDateIn').value =
                document.getElementById('modalCheckIn').value;
            document.getElementById('bookingDateOut').value =
                document.getElementById('modalCheckOut').value;
        }

        // ===== Поиск вайшнавов =====
        function getVaishnavName(v) {
            return v.spiritual_name || `${v.first_name || ''} ${v.last_name || ''}`.trim() || 'Без имени';
        }

        function searchVaishnavas(query) {
            const suggestionsEl = document.getElementById('vaishnavaSuggestions');
            if (!query || query.length < 2) {
                suggestionsEl.classList.add('hidden');
                return;
            }

            const q = query.toLowerCase();
            const matches = vaishnavas.filter(v => {
                const name = getVaishnavName(v).toLowerCase();
                const phone = (v.phone || '').toLowerCase();
                return name.includes(q) || phone.includes(q);
            }).slice(0, 10);

            if (matches.length === 0) {
                suggestionsEl.innerHTML = '<div class="p-3 text-gray-500 text-sm">Не найдено</div>';
            } else {
                suggestionsEl.innerHTML = matches.map(v => {
                    const name = getVaishnavName(v);
                    const badge = v.is_team_member ? '<span class="badge badge-sm badge-primary ml-2">Команда</span>' : '';
                    return `<div class="p-2 hover:bg-base-200 cursor-pointer flex items-center" onclick="selectVaishnava('${v.id}', '${name.replace(/'/g, "\\'")}')">
                        <span>${name}</span>${badge}
                    </div>`;
                }).join('');
            }
            suggestionsEl.classList.remove('hidden');
        }

        function showVaishnavaSuggestions() {
            const query = document.getElementById('checkinVaishnavSearch').value;
            if (query.length >= 2) {
                searchVaishnavas(query);
            }
        }

        function selectVaishnava(id, name) {
            document.getElementById('checkinVaishnavId').value = id;
            document.getElementById('checkinVaishnavSearch').value = name;
            document.getElementById('vaishnavaSuggestions').classList.add('hidden');
            document.getElementById('clearVaishnava').classList.remove('hidden');
            // Скрываем поля нового гостя
            document.getElementById('guestFields').classList.add('hidden');
            document.getElementById('checkinGuestName').value = '';
        }

        function clearVaishnavSelection() {
            document.getElementById('checkinVaishnavId').value = '';
            document.getElementById('checkinVaishnavSearch').value = '';
            document.getElementById('clearVaishnava').classList.add('hidden');
            // Показываем поля нового гостя
            document.getElementById('guestFields').classList.remove('hidden');
        }

        // Закрытие подсказок при клике вне
        document.addEventListener('click', (e) => {
            const suggestions = document.getElementById('vaishnavaSuggestions');
            const searchInput = document.getElementById('checkinVaishnavSearch');
            if (suggestions && !suggestions.contains(e.target) && e.target !== searchInput) {
                suggestions.classList.add('hidden');
            }
        });

        // Сохранение заселения
        async function saveCheckin(e) {
            e.preventDefault();
            const form = e.target;

            const data = {
                room_id: modalContext.roomId,
                category_id: form.category_id.value || null,
                vaishnava_id: form.vaishnava_id.value || null,
                guest_name: form.guest_name.value || null,
                guest_phone: form.guest_phone?.value || null,
                check_in: form.check_in.value,
                check_out: form.check_out.value || null,
                early_checkin: form.early_checkin.checked,
                late_checkout: form.late_checkout.checked,
                notes: form.notes.value || null,
                status: 'active'
            };

            // Проверка: должен быть либо вайшнав из БД, либо имя нового гостя
            if (!data.vaishnava_id && !data.guest_name) {
                alert(Layout.t('select_vaishnava_or_enter_name'));
                return;
            }

            let error;

            if (modalContext.isConversion && modalContext.residentId) {
                // Конвертация брони в заселение — обновляем существующую запись
                const result = await Layout.db
                    .from('residents')
                    .update(data)
                    .eq('id', modalContext.residentId);
                error = result.error;
            } else {
                // Новое заселение
                const result = await Layout.db.from('residents').insert(data);
                error = result.error;
            }

            if (error) {
                console.error('Error saving checkin:', error);
                alert(Layout.t('checkin_error') + ': ' + error.message);
                return;
            }

            document.getElementById('actionModal').close();
            showActionScreen();
            await loadTimelineData();
            renderTable();
        }

        // Сохранение бронирования
        async function saveBooking(e) {
            e.preventDefault();
            const form = e.target;

            const bedsCount = parseInt(form.beds_count.value) || 1;

            // Создаём бронирование
            const earlyCheckin = form.early_checkin.checked;
            const lateCheckout = form.late_checkout.checked;
            const bookingName = form.name.value.trim() || null;

            const bookingData = {
                name: bookingName,
                contact_name: form.contact_name.value,
                contact_phone: form.contact_phone.value || null,
                check_in: form.check_in.value,
                check_out: form.check_out.value,
                beds_count: bedsCount,
                early_checkin: earlyCheckin,
                late_checkout: lateCheckout,
                notes: form.notes.value || null,
                status: 'confirmed'
            };

            const { data: booking, error: bookingError } = await Layout.db
                .from('bookings')
                .insert(bookingData)
                .select()
                .single();

            if (bookingError) {
                console.error('Error saving booking:', bookingError);
                alert(Layout.t('booking_error') + ': ' + bookingError.message);
                return;
            }

            // Создаём placeholder резидентов для бронирования
            const residents = [];
            for (let i = 0; i < bedsCount; i++) {
                residents.push({
                    room_id: modalContext.roomId,
                    booking_id: booking.id,
                    check_in: form.check_in.value,
                    check_out: form.check_out.value,
                    early_checkin: earlyCheckin,
                    late_checkout: lateCheckout,
                    status: 'active'
                });
            }

            const { error: residentsError } = await Layout.db.from('residents').insert(residents);

            if (residentsError) {
                console.error('Error saving booking residents:', residentsError);
            }

            document.getElementById('actionModal').close();
            showActionScreen();
            await loadTimelineData();
            renderTable();
        }

        // Обработчик других действий
        async function handleAction(action) {
            const startDate = document.getElementById('modalCheckIn').value;
            const endDate = document.getElementById('modalCheckOut').value;

            if (action === 'cleaning' || action === 'bedding') {
                // Для белья: только половина ячейки (end_date = start_date)
                const finalEndDate = action === 'bedding' ? startDate : endDate;

                const { error } = await Layout.db.from('room_cleanings').insert({
                    room_id: modalContext.roomId,
                    start_date: startDate,
                    end_date: finalEndDate,
                    type: action
                });

                if (error) {
                    alert(Layout.t('error') + ': ' + error.message);
                    return;
                }

                document.getElementById('actionModal').close();
                await loadTimelineData();
                renderTable();
                return;
            }

            if (action === 'repair') {
                // TODO: Закрытие на ремонт
                alert(Layout.t('feature_in_development'));
            }

            document.getElementById('actionModal').close();
        }

        // Текущий резидент для модалки
        let currentResident = null;
        // День, на который кликнули (для выселения)
        let clickedDayIndex = null;

        // Открыть модалку резидента из хранилища
        function openResidentFromMap(guestId, event) {
            const guestData = guestsMap.get(guestId);
            if (!guestData) {
                console.error('Guest not found:', guestId);
                return;
            }

            // Вычисляем день клика по позиции мыши на плашке
            if (event) {
                const bar = event.target.closest('.guest-bar');
                if (bar) {
                    const rect = bar.getBoundingClientRect();
                    const clickX = event.clientX - rect.left;
                    const barWidth = rect.width;
                    const totalDays = guestData.endDay - guestData.startDay + 1;
                    const dayOffset = Math.floor((clickX / barWidth) * totalDays);
                    clickedDayIndex = guestData.startDay + dayOffset;
                } else {
                    clickedDayIndex = guestData.endDay; // По умолчанию последний день
                }
            } else {
                clickedDayIndex = guestData.endDay;
            }

            openResidentModal(guestData, guestData.buildingName, guestData.roomName);
        }

        // Открыть модалку резидента
        function openResidentModal(guestData, buildingName, roomName) {
            currentResident = guestData;
            const res = guestData.rawData;
            const isBooking = guestData.isBooking;
            const isCheckedOut = res.status === 'checked_out';

            // Заголовок
            let title = isBooking ? 'Бронирование' : 'Проживание';
            if (isCheckedOut) title = 'Выселен';
            document.getElementById('residentModalTitle').textContent = title;

            // Локация
            document.getElementById('residentModalLocation').textContent =
                `${buildingName} → Номер ${roomName}`;

            // Информация
            let infoHtml = '';

            // Имя (с ссылкой на профиль, если есть vaishnava_id)
            const nameLink = res.vaishnava_id
                ? `<a href="../vaishnavas/person.html?id=${res.vaishnava_id}" class="link link-primary">${guestData.name}</a>`
                : guestData.name;
            infoHtml += `<div class="flex justify-between py-1 border-b">
                <span class="text-gray-500">Гость:</span>
                <span class="font-medium">${nameLink}</span>
            </div>`;

            // Категория
            if (res.resident_categories) {
                infoHtml += `<div class="flex justify-between py-1 border-b">
                    <span class="text-gray-500">Категория:</span>
                    <span class="font-medium">${Layout.getName(res.resident_categories)}</span>
                </div>`;
            }

            // Даты
            infoHtml += `<div class="flex justify-between py-1 border-b">
                <span class="text-gray-500">Заезд:</span>
                <span class="font-medium">${formatDisplayDate(res.check_in)}${res.early_checkin ? ' (ранний)' : ''}</span>
            </div>`;

            if (res.check_out) {
                infoHtml += `<div class="flex justify-between py-1 border-b">
                    <span class="text-gray-500">Выезд:</span>
                    <span class="font-medium">${formatDisplayDate(res.check_out)}${res.late_checkout ? ' (поздний)' : ''}</span>
                </div>`;
            }

            // Телефон
            if (res.guest_phone) {
                infoHtml += `<div class="flex justify-between py-1 border-b">
                    <span class="text-gray-500">Телефон:</span>
                    <span class="font-medium">${e(res.guest_phone)}</span>
                </div>`;
            }

            // Примечания
            if (res.notes) {
                infoHtml += `<div class="flex justify-between py-1 border-b">
                    <span class="text-gray-500">Примечания:</span>
                    <span class="font-medium">${e(res.notes)}</span>
                </div>`;
            }

            // Бронирование
            if (res.bookings) {
                if (res.bookings.name) {
                    infoHtml += `<div class="flex justify-between py-1 border-b">
                        <span class="text-gray-500">Бронь:</span>
                        <span class="font-medium">${e(res.bookings.name)}</span>
                    </div>`;
                }
                if (res.bookings.contact_name) {
                    infoHtml += `<div class="flex justify-between py-1 border-b">
                        <span class="text-gray-500">Контакт:</span>
                        <span class="font-medium">${e(res.bookings.contact_name)}</span>
                    </div>`;
                }
            }

            document.getElementById('residentInfo').innerHTML = infoHtml;

            // Кнопки действий
            let actionsHtml = '';

            if (isBooking) {
                // Действия для бронирования
                actionsHtml += `<button class="btn btn-primary" onclick="convertToCheckin()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                    </svg>
                    Заселить
                </button>`;
                actionsHtml += `<button class="btn btn-info btn-outline" onclick="showMoveScreen()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                    </svg>
                    Перенос
                </button>`;
                actionsHtml += `<button class="btn btn-error btn-outline" onclick="cancelBooking()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    Отменить
                </button>`;
            } else if (!isCheckedOut) {
                // Действия для заселённого гостя (не выселенного)
                actionsHtml += `<button class="btn btn-warning" onclick="checkoutResident()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Выселить
                </button>`;
                actionsHtml += `<button class="btn btn-outline" onclick="showEditDatesScreen()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Даты
                </button>`;
                actionsHtml += `<button class="btn btn-info btn-outline" onclick="showMoveScreen()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                    </svg>
                    Перенос
                </button>`;
            }
            // Для выселенных (isCheckedOut) — только кнопка удаления

            // Кнопка удаления для всех
            actionsHtml += `<button class="btn btn-error btn-outline" onclick="deleteResident()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Удалить
            </button>`;

            document.getElementById('residentActions').innerHTML = actionsHtml;

            // Показываем экран информации (сбрасываем если был на экране перемещения)
            showResidentInfoScreen();

            // Открываем модалку
            document.getElementById('residentModal').showModal();
        }

        // Форматирование даты для отображения
        function formatDisplayDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        // Выселить резидента (установить дату выезда = кликнутый день)
        async function checkoutResident() {
            if (!currentResident) return;

            const res = currentResident.rawData;
            let checkoutDate;

            // Если кликнули на конкретный день — используем его
            if (clickedDayIndex !== null && clickedDayIndex >= currentResident.startDay) {
                checkoutDate = getDateForDay(clickedDayIndex).toISOString().split('T')[0];
            } else {
                // Если день не определён или некорректный — используем оригинальную дату выезда
                checkoutDate = res.check_out;
            }

            // Финальная проверка: дата не раньше заезда и не позже оригинального выезда
            if (!checkoutDate || checkoutDate < res.check_in) {
                checkoutDate = res.check_out || res.check_in;
            }

            const { error } = await Layout.db
                .from('residents')
                .update({ check_out: checkoutDate, status: 'checked_out' })
                .eq('id', currentResident.id);

            if (error) {
                alert(Layout.t('error') + ': ' + error.message);
                return;
            }

            document.getElementById('residentModal').close();
            await loadTimelineData();
            renderTable();
        }

        // Удалить резидента
        async function deleteResident() {
            if (!currentResident) return;
            if (!confirm(Layout.t('confirm_delete_entry'))) return;

            const { error } = await Layout.db
                .from('residents')
                .delete()
                .eq('id', currentResident.id);

            if (error) {
                alert(Layout.t('error') + ': ' + error.message);
                return;
            }

            document.getElementById('residentModal').close();
            await loadTimelineData();
            renderTable();
        }

        // Отменить бронирование
        async function cancelBooking() {
            if (!currentResident) return;
            if (!confirm(Layout.t('confirm_cancel_booking'))) return;

            const res = currentResident.rawData;

            // Удаляем резидента
            const { error: resError } = await Layout.db
                .from('residents')
                .delete()
                .eq('id', currentResident.id);

            if (resError) {
                alert(Layout.t('error') + ': ' + resError.message);
                return;
            }

            // Если это было связано с бронированием, обновляем статус брони
            if (res.booking_id) {
                await Layout.db
                    .from('bookings')
                    .update({ status: 'cancelled' })
                    .eq('id', res.booking_id);
            }

            document.getElementById('residentModal').close();
            await loadTimelineData();
            renderTable();
        }

        // Показать экран информации о резиденте
        function showResidentInfoScreen() {
            document.getElementById('residentInfoScreen').classList.remove('hidden');
            document.getElementById('moveScreen').classList.add('hidden');
            document.getElementById('editDatesScreen').classList.add('hidden');
        }

        // Показать экран редактирования дат
        function showEditDatesScreen() {
            if (!currentResident) return;

            document.getElementById('residentInfoScreen').classList.add('hidden');
            document.getElementById('moveScreen').classList.add('hidden');
            document.getElementById('editDatesScreen').classList.remove('hidden');

            document.getElementById('editDatesGuestName').textContent = currentResident.name;

            const res = currentResident.rawData;
            document.getElementById('editCheckIn').value = res.check_in || '';
            document.getElementById('editCheckOut').value = res.check_out || '';
            document.getElementById('editEarlyCheckin').checked = res.early_checkin || false;
            document.getElementById('editLateCheckout').checked = res.late_checkout || false;
        }

        // Сохранить изменённые даты
        async function saveDates() {
            if (!currentResident) return;

            const checkIn = document.getElementById('editCheckIn').value;
            const checkOut = document.getElementById('editCheckOut').value;
            const earlyCheckin = document.getElementById('editEarlyCheckin').checked;
            const lateCheckout = document.getElementById('editLateCheckout').checked;

            if (!checkIn) {
                alert(Layout.t('specify_checkin_date'));
                return;
            }

            const { error } = await Layout.db
                .from('residents')
                .update({
                    check_in: checkIn,
                    check_out: checkOut || null,
                    early_checkin: earlyCheckin,
                    late_checkout: lateCheckout
                })
                .eq('id', currentResident.id);

            if (error) {
                alert(Layout.t('error') + ': ' + error.message);
                return;
            }

            document.getElementById('residentModal').close();
            await loadTimelineData();
            renderTable();
        }

        // Показать экран выбора номера для перемещения
        async function showMoveScreen() {
            if (!currentResident) return;

            document.getElementById('residentInfoScreen').classList.add('hidden');
            document.getElementById('moveScreen').classList.remove('hidden');
            document.getElementById('editDatesScreen').classList.add('hidden');
            document.getElementById('moveGuestName').textContent = currentResident.name;

            // Загружаем список номеров
            const roomsList = document.getElementById('roomsList');
            roomsList.innerHTML = '<div class="text-center py-4">Загрузка...</div>';

            const res = currentResident.rawData;
            const checkIn = res.check_in;
            const checkOut = res.check_out || '2099-12-31'; // если нет даты выезда

            // Получаем здания, номера и текущих резидентов
            const [buildingsRes, residentsRes] = await Promise.all([
                Layout.db
                    .from('buildings')
                    .select('*, rooms(*)')
                    .eq('is_active', true)
                    .order('sort_order'),
                Layout.db
                    .from('residents')
                    .select('room_id, check_in, check_out')
                    .in('status', ['active', 'confirmed'])
                    .neq('id', currentResident.id) // исключаем текущего резидента
                    .lte('check_in', checkOut)
                    .or(`check_out.is.null,check_out.gte.${checkIn}`)
            ]);

            const buildings = buildingsRes.data || [];
            const residents = residentsRes.data || [];

            if (buildings.length === 0) {
                roomsList.innerHTML = '<div class="text-center py-4 text-gray-500">Нет доступных номеров</div>';
                return;
            }

            // Считаем занятость по комнатам на период перемещаемого резидента
            const roomOccupancy = {};
            residents.forEach(r => {
                if (!roomOccupancy[r.room_id]) {
                    roomOccupancy[r.room_id] = 0;
                }
                roomOccupancy[r.room_id]++;
            });

            const currentRoomId = res.room_id;

            let html = '';
            buildings.forEach(building => {
                const rooms = (building.rooms?.filter(r => r.is_active) || [])
                    .sort((a, b) => {
                        if (a.floor !== b.floor) return (a.floor || 0) - (b.floor || 0);
                        return a.number.localeCompare(b.number, undefined, { numeric: true });
                    });
                if (rooms.length === 0) return;

                html += `<div class="collapse collapse-arrow bg-base-200 rounded-lg">
                    <input type="checkbox" checked />
                    <div class="collapse-title font-medium py-2">${Layout.getName(building)}</div>
                    <div class="collapse-content p-0">
                        <div class="grid grid-cols-3 gap-1 p-2">`;

                rooms.forEach(room => {
                    const isCurrent = room.id === currentRoomId;
                    const occupied = roomOccupancy[room.id] || 0;
                    const capacity = room.capacity || 1;
                    const isFull = occupied >= capacity;

                    let btnClass, label, disabled;

                    if (isCurrent) {
                        btnClass = 'btn-disabled bg-gray-200';
                        label = `${room.number} ←`;
                        disabled = true;
                    } else if (isFull) {
                        btnClass = 'btn-disabled bg-red-100 text-red-400';
                        label = `${room.number} (${occupied}/${capacity})`;
                        disabled = true;
                    } else if (occupied > 0) {
                        btnClass = 'btn-outline btn-warning';
                        label = `${room.number} (${occupied}/${capacity})`;
                        disabled = false;
                    } else {
                        btnClass = 'btn-outline btn-success';
                        label = room.number;
                        disabled = false;
                    }

                    html += `<button class="btn btn-sm ${btnClass}"
                        ${disabled ? 'disabled' : `onclick="moveToRoom('${room.id}')"`}>
                        ${label}
                    </button>`;
                });

                html += `</div></div></div>`;
            });

            roomsList.innerHTML = html;
        }

        // Перенос резидента в другой номер
        async function moveToRoom(newRoomId) {
            if (!currentResident) return;

            const { error } = await Layout.db
                .from('residents')
                .update({ room_id: newRoomId })
                .eq('id', currentResident.id);

            if (error) {
                alert(Layout.t('error') + ': ' + error.message);
                return;
            }

            document.getElementById('residentModal').close();
            await loadTimelineData();
            renderTable();
        }

        // === Модалка управления уборкой ===
        let currentCleaning = null;

        function openCleaningModal(cleaningId) {
            const cleaningData = cleaningsMap.get(cleaningId);
            if (!cleaningData) {
                console.error('Cleaning not found:', cleaningId);
                return;
            }

            currentCleaning = cleaningData;
            const raw = cleaningData.rawData;

            // Локация
            document.getElementById('cleaningModalLocation').textContent =
                `${cleaningData.buildingName} → Номер ${cleaningData.roomName}`;

            // Даты
            document.getElementById('cleaningStartDate').value = raw.start_date;
            document.getElementById('cleaningEndDate').value = raw.end_date;

            // Показываем/скрываем элементы в зависимости от статуса
            const isCompleted = cleaningData.isCompleted;
            document.getElementById('cleaningCompletedStatus').classList.toggle('hidden', !isCompleted);
            document.getElementById('cleaningActions').classList.toggle('hidden', isCompleted);

            document.getElementById('cleaningModal').showModal();
        }

        // Уборка выполнена — помечаем как выполненную (перекрашивается в зелёный)
        async function completeCleaning() {
            if (!currentCleaning) return;

            // Для автоуборки — ставим флаг cleaning_done в residents
            if (currentCleaning.isAuto || currentCleaning.isAutoCleaning) {
                const { error } = await Layout.db
                    .from('residents')
                    .update({ cleaning_done: true })
                    .eq('id', currentCleaning.residentId);

                if (error) {
                    alert(Layout.t('error') + ': ' + error.message);
                    return;
                }

                document.getElementById('cleaningModal').close();
                await loadTimelineData();
                renderTable();
                return;
            }

            // Для ручной уборки — помечаем как выполненную
            const { error } = await Layout.db
                .from('room_cleanings')
                .update({ completed: true, completed_at: new Date().toISOString() })
                .eq('id', currentCleaning.cleaningId);

            if (error) {
                alert(Layout.t('error') + ': ' + error.message);
                return;
            }

            document.getElementById('cleaningModal').close();
            await loadTimelineData();
            renderTable();
        }

        // Продлить уборку — обновляем дату окончания (ручная) или создаём новую запись (авто)
        async function extendCleaning() {
            if (!currentCleaning) return;

            const newEndDate = document.getElementById('cleaningEndDate').value;
            if (!newEndDate) {
                alert(Layout.t('select_new_checkout_date'));
                return;
            }

            const raw = currentCleaning.rawData;

            // Для автоуборки — создаём новую запись в room_cleanings
            if (currentCleaning.isAuto || currentCleaning.isAutoCleaning) {
                const { error } = await Layout.db
                    .from('room_cleanings')
                    .insert({
                        room_id: raw.room_id,
                        start_date: raw.start_date,
                        end_date: newEndDate
                    });

                if (error) {
                    alert(Layout.t('error') + ': ' + error.message);
                    return;
                }
            } else {
                // Для ручной уборки — обновляем существующую запись
                const { error } = await Layout.db
                    .from('room_cleanings')
                    .update({ end_date: newEndDate })
                    .eq('id', currentCleaning.cleaningId);

                if (error) {
                    alert(Layout.t('error') + ': ' + error.message);
                    return;
                }
            }

            document.getElementById('cleaningModal').close();
            await loadTimelineData();
            renderTable();
        }

        // Удалить уборку (скрыть совсем, в отличие от "Выполнена" которая делает зелёной)
        async function deleteCleaning() {
            if (!currentCleaning) return;

            // Для автоуборки — помечаем как пропущенную (скрываем)
            if (currentCleaning.isAuto || currentCleaning.isAutoCleaning) {
                const { error } = await Layout.db
                    .from('residents')
                    .update({ cleaning_skipped: true })
                    .eq('id', currentCleaning.residentId);

                if (error) {
                    alert(Layout.t('error') + ': ' + error.message);
                    return;
                }

                document.getElementById('cleaningModal').close();
                await loadTimelineData();
                renderTable();
                return;
            }

            // Для ручной уборки — удаляем из БД
            const { error } = await Layout.db
                .from('room_cleanings')
                .delete()
                .eq('id', currentCleaning.cleaningId);

            if (error) {
                alert(Layout.t('error') + ': ' + error.message);
                return;
            }

            document.getElementById('cleaningModal').close();
            await loadTimelineData();
            renderTable();
        }

        // Превратить бронирование в заселение
        async function convertToCheckin() {
            if (!currentResident) return;

            // Закрываем модалку резидента
            document.getElementById('residentModal').close();

            // Открываем модалку заселения с предзаполненными данными
            const res = currentResident.rawData;

            modalContext = {
                roomId: res.room_id,
                residentId: currentResident.id,
                isConversion: true
            };

            // Показываем форму заселения
            document.getElementById('actionScreen').classList.add('hidden');
            document.getElementById('checkinScreen').classList.remove('hidden');
            document.getElementById('bookingScreen').classList.add('hidden');

            document.getElementById('checkinLocation').textContent =
                document.getElementById('residentModalLocation').textContent;
            document.getElementById('checkinDateIn').value = res.check_in;
            document.getElementById('checkinDateOut').value = res.check_out || '';

            // Сбрасываем форму
            document.getElementById('checkinForm').reset();
            document.getElementById('checkinDateIn').value = res.check_in;
            document.getElementById('checkinDateOut').value = res.check_out || '';

            if (res.early_checkin) {
                document.querySelector('#checkinForm [name="early_checkin"]').checked = true;
            }
            if (res.late_checkout) {
                document.querySelector('#checkinForm [name="late_checkout"]').checked = true;
            }

            clearVaishnavSelection();

            document.getElementById('actionModal').showModal();
        }

        // Рендер таблицы
        // Рендер полосы ретритов (отдельно от таблицы)
        function renderRetreats() {
            const container = document.getElementById('retreatsScroll');
            if (!container) return;

            let html = '';

            // Половинки дней (как в таблице — 2 на день)
            for (let day = 0; day < DAYS_TO_SHOW; day++) {
                html += '<div class="retreat-half day-start"></div>';
                html += '<div class="retreat-half"></div>';
            }

            // Плашки ретритов
            timelineData.retreats.forEach(r => {
                // Позиция: каждая половина = 24px + 1px border, первая половина ещё +2px border-left
                // Упрощённо: startDay * (24+1+24+1) + 2 для border-left
                const left = r.startDay * CELL_WIDTH * 2 + 2; // +2 для первой границы
                const spanDays = r.endDay - r.startDay + 1;
                const width = spanDays * CELL_WIDTH * 2 - 4;
                html += `<div class="retreat-chip" style="left: ${left}px; width: ${width}px;">${r.name}</div>`;
            });

            // Названия месяцев на первых числах
            const monthNames = ['ЯНВАРЬ', 'ФЕВРАЛЬ', 'МАРТ', 'АПРЕЛЬ', 'МАЙ', 'ИЮНЬ',
                'ИЮЛЬ', 'АВГУСТ', 'СЕНТЯБРЬ', 'ОКТЯБРЬ', 'НОЯБРЬ', 'ДЕКАБРЬ'];
            for (let day = 0; day < DAYS_TO_SHOW; day++) {
                const date = getDateForDay(day);
                if (date.getDate() === 1) {
                    const left = day * CELL_WIDTH * 2 + 2;
                    html += `<div class="month-label" style="left: ${left}px;">${monthNames[date.getMonth()]}</div>`;
                }
            }

            container.innerHTML = html;
        }

        // Синхронизация скролла ретритов с таблицей
        function syncScroll() {
            const tableContainer = document.getElementById('tableContainer');
            const retreatsScroll = document.getElementById('retreatsScroll');
            if (!tableContainer || !retreatsScroll) return;

            tableContainer.addEventListener('scroll', () => {
                retreatsScroll.style.transform = `translateX(-${tableContainer.scrollLeft}px)`;
            });
        }

        function renderTable() {
            const table = document.getElementById('timelineTable');

            let html = '<thead>';

            // Строка с числами
            html += `<tr class="row-dates"><th class="sticky-col">
                <div class="flex gap-1">
                    <button class="btn btn-xs btn-ghost opacity-60 hover:opacity-100" onclick="event.stopPropagation(); collapseAllBuildings()" title="Свернуть всё">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 9H4m16 6H4" /></svg>
                    </button>
                    <button class="btn btn-xs btn-ghost opacity-60 hover:opacity-100" onclick="event.stopPropagation(); collapseAllRooms()" title="Свернуть номера">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
                    </button>
                    <button class="btn btn-xs btn-ghost opacity-60 hover:opacity-100" onclick="event.stopPropagation(); expandAll()" title="Развернуть всё">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    </button>
                </div>
            </th>`;
            for (let day = 0; day < DAYS_TO_SHOW; day++) {
                const date = getDateForDay(day);
                const weekend = isWeekend(day) ? 'weekend' : '';
                const today = day === TODAY_INDEX ? 'today' : '';
                html += `<th colspan="2" class="day-start ${weekend} ${today}">${date.getDate()}</th>`;
            }
            html += '</tr>';

            // Строка с днями недели
            html += '<tr class="row-weekdays"><th class="sticky-col"></th>';
            for (let day = 0; day < DAYS_TO_SHOW; day++) {
                const weekend = isWeekend(day) ? 'weekend' : '';
                const today = day === TODAY_INDEX ? 'today' : '';
                html += `<th colspan="2" class="day-start ${weekend} ${today}">${getWeekdayName(day)}</th>`;
            }
            html += '</tr>';

            html += '</thead><tbody>';

            // Калибровочная строка для фиксации ширины колонок
            html += '<tr class="row-calibration"><td class="sticky-col"></td>';
            for (let col = 0; col < DAYS_TO_SHOW * 2; col++) {
                html += '<td class="half-day"></td>';
            }
            html += '</tr>';

            // Здания
            timelineData.buildings.forEach(building => {
                const buildingCollapsed = collapsedBuildings.has(building.id);
                const arrowClass = buildingCollapsed ? 'collapsed' : '';

                // Заголовок здания
                const tempBadge = building.isTemporary ? ' <span style="font-size: 10px; color: #d97706;">⏱</span>' : '';
                const tempClass = building.isTemporary ? ' temporary' : '';
                html += `<tr class="row-building${tempClass}">`;
                html += `<td class="sticky-col" onclick="toggleBuilding('${building.id}')">`;
                html += `<span class="toggle-arrow ${arrowClass}">▼</span> ${building.name}${tempBadge}</td>`;
                for (let col = 0; col < DAYS_TO_SHOW * 2; col++) {
                    const dayIndex = Math.floor(col / 2);
                    const isFirstHalf = col % 2 === 0;
                    const dayStart = isFirstHalf ? 'day-start' : '';

                    // Для временных зданий закрашиваем ячейки вне периода аренды
                    const isOutsideRental = building.isTemporary &&
                        (dayIndex < building.availableFromDay || dayIndex > building.availableUntilDay);

                    if (isOutsideRental) {
                        html += `<td class="${dayStart}" style="background: #d1d5db;"></td>`;
                    } else {
                        html += `<td class="${dayStart}"></td>`;
                    }
                }
                html += '</tr>';

                // Номера (скрыты если здание свёрнуто)
                building.rooms.forEach(room => {
                    const roomCollapsed = collapsedRooms.has(room.id);
                    const roomArrowClass = roomCollapsed ? 'collapsed' : '';
                    const hiddenClass = buildingCollapsed ? 'collapsed' : '';

                    // Заголовок номера — показываем сводку по занятости
                    html += `<tr class="row-room ${hiddenClass}">`;
                    html += `<td class="sticky-col" onclick="toggleRoom('${room.id}')">`;
                    html += `<span class="toggle-arrow ${roomArrowClass}">▼</span> Номер ${room.name}</td>`;

                    // Вычисляем сегменты занятости только для свёрнутых номеров
                    let segments = [];
                    let totalBeds = room.beds.length;

                    if (roomCollapsed) {
                        const allGuests = room.beds.flatMap(bed =>
                            bed.guests.filter(g => !g.isCleaning)
                        );

                        let currentSegment = null;

                        for (let col = 0; col < DAYS_TO_SHOW * 2; col++) {
                            const occupying = allGuests.filter(g => {
                                const gStart = g.startDay * 2 + g.startHalf;
                                const gEnd = g.endDay * 2 + g.endHalf;
                                return col >= gStart && col <= gEnd;
                            });

                            const occupiedCount = occupying.length;
                            const ids = occupying.map(g => g.id).sort().join(',');

                            if (currentSegment && currentSegment.ids === ids) {
                                currentSegment.endCol = col;
                            } else {
                                if (currentSegment && currentSegment.count > 0) {
                                    segments.push(currentSegment);
                                }
                                if (occupiedCount > 0) {
                                    currentSegment = {
                                        startCol: col,
                                        endCol: col,
                                        count: occupiedCount,
                                        ids: ids,
                                        guests: occupying
                                    };
                                } else {
                                    currentSegment = null;
                                }
                            }
                        }
                        if (currentSegment && currentSegment.count > 0) {
                            segments.push(currentSegment);
                        }
                    }

                    // Рендерим ячейки строки номера
                    for (let col = 0; col < DAYS_TO_SHOW * 2; col++) {
                        const dayIndex = Math.floor(col / 2);
                        const halfIndex = col % 2;
                        const isFirstHalf = halfIndex === 0;
                        const dayStart = isFirstHalf ? 'day-start' : '';

                        // Проверка: для временных зданий закрашиваем ячейки вне периода аренды
                        const isOutsideRental = building.isTemporary &&
                            (dayIndex < building.availableFromDay || dayIndex > building.availableUntilDay);

                        if (isOutsideRental) {
                            html += `<td class="${dayStart}" style="background: #e5e7eb; pointer-events: none;"></td>`;
                            continue;
                        }

                        html += `<td class="${dayStart}">`;

                        // Показываем сводку только когда номер свёрнут
                        if (roomCollapsed) {
                            const segment = segments.find(s => s.startCol === col);
                            if (segment) {
                                const spanCells = segment.endCol - segment.startCol + 1;
                                const width = spanCells * CELL_WIDTH - 2;

                                const firstGuest = segment.guests[0];
                                const bgColor = firstGuest?.color || '#fef08a';
                                const isBooking = segment.guests.some(g => g.isBooking);
                                const isCheckedOut = segment.guests.some(g => g.isCheckedOut);
                                const isPartial = segment.count < totalBeds;

                                let label = '';
                                if (totalBeds === 1) {
                                    // Одноместный номер — показываем имя
                                    label = firstGuest.name;
                                } else {
                                    // Многоместный номер — всегда показываем дробь
                                    label = `<span class="fraction">${segment.count}/${totalBeds}</span>`;
                                }

                                const bookingClass = isBooking ? 'booking' : '';
                                const checkedOutClass = isCheckedOut ? ' checked-out' : '';
                                const style = isBooking
                                    ? `width: ${width}px; --bar-color: ${bgColor}; border-color: ${bgColor};`
                                    : `width: ${width}px; background: ${bgColor};`;

                                html += `<div class="room-summary-bar ${bookingClass}${checkedOutClass}" style="${style}">${label}</div>`;
                            }
                        }

                        // Рендерим уборки на строке номера (всегда, независимо от сворачивания)
                        const cleaning = (room.cleanings || []).find(c =>
                            c.startDay === dayIndex && c.startHalf === halfIndex
                        );
                        if (cleaning) {
                            const startCol = cleaning.startDay * 2 + cleaning.startHalf;
                            const endCol = cleaning.endDay * 2 + cleaning.endHalf;
                            const spanCells = Math.max(1, endCol - startCol + 1);
                            const width = spanCells * CELL_WIDTH - 2;
                            const completedClass = cleaning.isCompleted ? ' completed' : '';
                            const typeClass = cleaning.type === 'bedding' ? ' bedding' : '';
                            html += `<div class="cleaning-bar clickable${completedClass}${typeClass}" style="width: ${width}px;" onclick="event.stopPropagation(); openCleaningModal('${cleaning.cleaningId}')">${cleaning.name}</div>`;
                        }

                        html += '</td>';
                    }
                    html += '</tr>';

                    // Места (скрыты если здание или номер свёрнуты)
                    const bedsHiddenClass = (buildingCollapsed || roomCollapsed) ? 'collapsed' : '';

                    room.beds.forEach(bed => {
                        const bedLabel = bed.name ? `Место ${bed.name}` : '';
                        html += `<tr class="row-bed ${bedsHiddenClass}"><td class="sticky-col">${bedLabel}</td>`;

                        // Всегда рендерим все ячейки (DAYS_TO_SHOW * 2)
                        for (let col = 0; col < DAYS_TO_SHOW * 2; col++) {
                            const dayIndex = Math.floor(col / 2);
                            const halfIndex = col % 2;
                            const isFirstHalf = halfIndex === 0;
                            const dayStart = isFirstHalf ? 'day-start' : '';
                            const weekend = isWeekend(dayIndex) ? 'weekend' : '';
                            const today = dayIndex === TODAY_INDEX ? 'today' : '';

                            // Проверка: для временных зданий закрашиваем ячейки вне периода аренды
                            const isOutsideRental = building.isTemporary &&
                                (dayIndex < building.availableFromDay || dayIndex > building.availableUntilDay);

                            if (isOutsideRental) {
                                html += `<td class="half-day ${dayStart}" style="background: #e5e7eb; pointer-events: none;"></td>`;
                                continue;
                            }

                            // Проверяем есть ли гость начинающийся здесь
                            const guest = bed.guests.find(g =>
                                g.startDay === dayIndex && g.startHalf === halfIndex
                            );

                            // Экранируем кавычки в именах
                            const bName = building.name.replace(/'/g, "\\'");
                            const rName = room.name.replace(/'/g, "\\'");
                            const bedName = bed.name.replace(/'/g, "\\'");

                            html += `<td class="half-day clickable ${dayStart} ${weekend} ${today}" onclick="openActionModal(${dayIndex}, '${room.id}', '${bName}', '${rName}', '${bedName}', ${halfIndex})">`;

                            // Если здесь начинается гость — добавляем плашку
                            // (уборки теперь рендерятся на строке номера, не на строке места)
                            if (guest && !guest.isCleaning) {
                                const startCol = guest.startDay * 2 + guest.startHalf;
                                const endCol = guest.endDay * 2 + guest.endHalf;
                                const spanCells = Math.max(1, endCol - startCol + 1);
                                const width = spanCells * CELL_WIDTH - 2; // минус отступы
                                const checkedOutClass = guest.isCheckedOut ? ' checked-out' : '';

                                if (guest.isBooking) {
                                    // Бронирование — штриховка
                                    const bgColor = guest.color || '#fef08a';
                                    html += `<div class="guest-bar booking${checkedOutClass}" style="width: ${width}px; --bar-color: ${bgColor}; border-color: ${bgColor};" onclick="event.stopPropagation(); openResidentFromMap('${guest.id}', event)">${guest.name}</div>`;
                                } else {
                                    // Обычное заселение
                                    const bgColor = guest.color || '#fef08a';
                                    const borderColor = guest.border || '#facc15';
                                    html += `<div class="guest-bar${checkedOutClass}" style="width: ${width}px; background: ${bgColor}; border-color: ${borderColor};" onclick="event.stopPropagation(); openResidentFromMap('${guest.id}', event)">${guest.name}</div>`;
                                }
                            }

                            html += '</td>';
                        }

                        html += '</tr>';
                    });
                });
            });

            html += '</tbody>';
            table.innerHTML = html;
        }

        // Перезагрузка данных и рендеринг
        async function reload() {
            Layout.showLoader();
            await Promise.all([
                loadTimelineData(),
                loadDictionaries()
            ]);
            renderRetreats();
            renderTable();
            syncScroll();
            Layout.hideLoader();
        }

        // Сдвиг на месяц вперёд или назад
        function shiftMonth(direction) {
            baseDate.setMonth(baseDate.getMonth() + direction);
            reload();
        }

        // Сброс к сегодняшнему дню
        async function resetToToday() {
            baseDate = new Date();
            baseDate.setHours(0, 0, 0, 0);
            baseDate.setDate(baseDate.getDate() - 2);

            await reload();

            // Сбросить скролл к началу ПОСЛЕ перерисовки
            setTimeout(() => {
                const tableContainer = document.getElementById('tableContainer');
                if (tableContainer) {
                    tableContainer.scrollLeft = 0;
                }
            }, 100);
        }

        // Инициализация
        async function init() {
            await Layout.init({ module: 'housing', menuId: 'reception', itemId: 'timeline' });
            Layout.showLoader();
            await Promise.all([
                loadTimelineData(),
                loadDictionaries()
            ]);
            renderRetreats();
            renderTable();
            syncScroll();
            Layout.hideLoader();
        }

        init();
    </script>
</body>
</html>
