<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Заезды</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="../css/common.css">
</head>
<body class="min-h-screen bg-base-200">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 max-w-6xl">

        <!-- Page Header -->
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold mb-2">Заезды</h1>
                <p class="text-sm opacity-60">Ожидаемое время прибытия гостей</p>
            </div>

            <!-- Retreat Selector -->
            <div class="flex items-center gap-2">
                <select id="retreatSelect" class="select select-bordered" onchange="onRetreatChange(this.value)">
                    <option value="">Выберите ретрит...</option>
                </select>
            </div>
        </div>

        <!-- Stats + Chart Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6" id="statsBlock" style="display: none;">
            <!-- Stats (1/3) -->
            <div class="bg-base-100 rounded-lg shadow p-4">
                <div class="grid grid-cols-2 gap-3 text-center">
                    <div class="bg-accent/10 rounded-lg p-3">
                        <div class="text-2xl font-bold text-accent" id="statToday">0</div>
                        <div class="text-xs opacity-60">Сегодня</div>
                    </div>
                    <div class="bg-info/10 rounded-lg p-3">
                        <div class="text-2xl font-bold text-info" id="statTomorrow">0</div>
                        <div class="text-xs opacity-60">Завтра</div>
                    </div>
                    <div class="bg-warning/10 rounded-lg p-3">
                        <div class="text-2xl font-bold text-warning" id="statNoTime">0</div>
                        <div class="text-xs opacity-60">Без времени</div>
                    </div>
                    <div class="bg-success/10 rounded-lg p-3">
                        <div class="text-2xl font-bold text-success" id="statWithTime">0</div>
                        <div class="text-xs opacity-60">С временем</div>
                    </div>
                </div>
                <div class="mt-3 bg-primary/10 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-primary" id="statTotal">0</div>
                    <div class="text-xs opacity-60">Всего</div>
                </div>
            </div>

            <!-- Chart (2/3) -->
            <div class="lg:col-span-2 bg-base-100 rounded-lg shadow p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-sm">Распределение по времени</h3>
                    <div class="flex items-center gap-2">
                        <button class="btn btn-xs btn-ghost" onclick="changeChartDate(-1)">←</button>
                        <input type="date" id="chartDate" class="input input-xs input-bordered w-36" onchange="updateChart()">
                        <button class="btn btn-xs btn-ghost" onclick="changeChartDate(1)">→</button>
                    </div>
                </div>
                <div class="flex items-end gap-1 h-32" id="chartBars">
                    <!-- Bars will be rendered by JS -->
                </div>
                <div class="flex justify-between text-xs opacity-50 mt-1 px-1">
                    <span>06:00</span>
                    <span>12:00</span>
                    <span>18:00</span>
                    <span>00:00</span>
                </div>
            </div>
        </div>

        <!-- Search -->
        <div class="mb-4">
            <div class="relative max-w-sm">
                <input type="text" id="searchInput" placeholder="Поиск по имени..."
                       class="input input-bordered w-full pr-10"
                       oninput="onSearchInput(this.value)">
                <button id="searchClear" class="absolute right-3 top-1/2 -translate-y-1/2 opacity-50 hover:opacity-100 hidden" onclick="clearSearch()">✕</button>
            </div>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto bg-base-100 rounded-lg shadow">
            <table class="table table-zebra">
                <thead>
                    <tr>
                        <th class="cursor-pointer hover:bg-base-200 select-none" onclick="toggleSort('name')">
                            <div class="flex items-center gap-1">
                                <span>Имя</span>
                                <span class="sort-icon" data-sort="name">↕</span>
                            </div>
                        </th>
                        <th class="cursor-pointer hover:bg-base-200 select-none whitespace-nowrap" onclick="toggleSort('gender_age')">
                            <div class="flex items-center gap-1">
                                <span>Пол / Возраст</span>
                                <span class="sort-icon" data-sort="gender_age">↕</span>
                            </div>
                        </th>
                        <th class="cursor-pointer hover:bg-base-200 select-none whitespace-nowrap" onclick="toggleSort('arrival')">
                            <div class="flex items-center gap-1">
                                <span>Время прилёта</span>
                                <span class="sort-icon" data-sort="arrival">↕</span>
                            </div>
                        </th>
                        <th class="cursor-pointer hover:bg-base-200 select-none whitespace-nowrap" onclick="toggleSort('estimated')">
                            <div class="flex items-center gap-1">
                                <span>Приедет</span>
                                <span class="sort-icon" data-sort="estimated">↕</span>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody id="arrivalsTable">
                </tbody>
            </table>
            <div id="noData" class="hidden text-center py-12 opacity-50">
                <div class="text-4xl mb-2">✈️</div>
                <p>Выберите ретрит для просмотра заездов</p>
            </div>
        </div>

    </main>

    <div id="footer-placeholder"></div>

    <script src="../js/layout.js"></script>
    <script>
        let retreatId = null;
        let registrations = [];
        let sortField = 'arrival';
        let sortDirection = 'asc';
        let searchQuery = '';

        // ==================== DATA LOADING ====================
        async function loadRetreats() {
            const { data, error } = await Layout.db
                .from('retreats')
                .select('*')
                .order('start_date', { ascending: false });

            if (error) {
                console.error('Error loading retreats:', error);
                return;
            }

            const select = document.getElementById('retreatSelect');
            select.innerHTML = '<option value="">Выберите ретрит...</option>' +
                (data || []).map(r => `<option value="${r.id}">${Layout.getName(r)}</option>`).join('');

            // Check URL for retreat id
            const urlParams = new URLSearchParams(window.location.search);
            const urlRetreatId = urlParams.get('retreat');
            if (urlRetreatId) {
                select.value = urlRetreatId;
                onRetreatChange(urlRetreatId);
            }
        }

        async function onRetreatChange(id) {
            retreatId = id;

            // Update URL
            const url = new URL(window.location);
            if (id) {
                url.searchParams.set('retreat', id);
            } else {
                url.searchParams.delete('retreat');
            }
            window.history.replaceState({}, '', url);

            if (!id) {
                registrations = [];
                renderTable();
                document.getElementById('statsBlock').style.display = 'none';
                return;
            }

            await loadRegistrations();
        }

        async function loadRegistrations() {
            Layout.showLoader();

            const { data, error } = await Layout.db
                .from('retreat_registrations')
                .select(`
                    id,
                    vaishnava_id,
                    status,
                    vaishnavas (id, first_name, last_name, spiritual_name, gender, birth_date),
                    guest_transfers (*)
                `)
                .eq('retreat_id', retreatId)
                .eq('is_deleted', false)
                .in('status', ['pending', 'confirmed', 'team']);

            Layout.hideLoader();

            if (error) {
                console.error('Error loading registrations:', error);
                return;
            }

            registrations = data || [];
            updateStats();
            renderTable();
            document.getElementById('statsBlock').style.display = '';
        }

        function updateStats() {
            const total = registrations.length;
            let withTime = 0;
            let noTime = 0;
            let today = 0;
            let tomorrow = 0;

            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const tomorrowDate = new Date(now);
            tomorrowDate.setDate(tomorrowDate.getDate() + 1);
            const tomorrowStr = tomorrowDate.toISOString().split('T')[0];

            registrations.forEach(reg => {
                const arrival = (reg.guest_transfers || []).find(t => t.direction === 'arrival');
                if (arrival?.flight_datetime) {
                    withTime++;
                    // Estimated arrival = flight_datetime + 4 hours
                    const estimatedDate = new Date(arrival.flight_datetime);
                    estimatedDate.setHours(estimatedDate.getHours() + 4);
                    const estimatedStr = estimatedDate.toISOString().split('T')[0];

                    if (estimatedStr === todayStr) today++;
                    if (estimatedStr === tomorrowStr) tomorrow++;
                } else {
                    noTime++;
                }
            });

            document.getElementById('statToday').textContent = today;
            document.getElementById('statTomorrow').textContent = tomorrow;
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statWithTime').textContent = withTime;
            document.getElementById('statNoTime').textContent = noTime;

            // Initialize chart date to today
            const chartDateInput = document.getElementById('chartDate');
            if (!chartDateInput.value) {
                chartDateInput.value = todayStr;
            }
            updateChart();
        }

        // ==================== CHART ====================
        function updateChart() {
            const selectedDate = document.getElementById('chartDate').value;
            if (!selectedDate) return;

            // Count arrivals by hour (6:00 - 23:00, then 0:00 - 5:00)
            const hourCounts = {};
            for (let h = 0; h < 24; h++) {
                hourCounts[h] = 0;
            }

            registrations.forEach(reg => {
                const arrival = (reg.guest_transfers || []).find(t => t.direction === 'arrival');
                if (arrival?.flight_datetime) {
                    const estimatedDate = new Date(arrival.flight_datetime);
                    estimatedDate.setHours(estimatedDate.getHours() + 4);
                    const dateStr = estimatedDate.toISOString().split('T')[0];

                    if (dateStr === selectedDate) {
                        const hour = estimatedDate.getHours();
                        hourCounts[hour]++;
                    }
                }
            });

            // Find max for scaling
            const maxCount = Math.max(...Object.values(hourCounts), 1);

            // Render bars (from 6:00 to 5:00 next day = hours 6,7,8...23,0,1,2,3,4,5)
            const hoursOrder = [6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,0,1,2,3,4,5];
            const chartBars = document.getElementById('chartBars');

            chartBars.innerHTML = hoursOrder.map(h => {
                const count = hourCounts[h];
                const heightPercent = (count / maxCount) * 100;
                const barColor = count > 0 ? 'bg-primary' : 'bg-base-300';
                const title = `${h.toString().padStart(2, '0')}:00 — ${count} чел.`;

                return `<div class="flex-1 flex flex-col items-center justify-end h-full group cursor-default" title="${title}">
                    <div class="text-xs font-medium mb-1 opacity-0 group-hover:opacity-100 transition-opacity">${count || ''}</div>
                    <div class="${barColor} w-full rounded-t transition-all" style="height: ${count > 0 ? Math.max(heightPercent, 8) : 4}%"></div>
                </div>`;
            }).join('');
        }

        function changeChartDate(delta) {
            const input = document.getElementById('chartDate');
            const date = new Date(input.value);
            date.setDate(date.getDate() + delta);
            input.value = date.toISOString().split('T')[0];
            updateChart();
        }

        // ==================== HELPERS ====================
        function calculateAge(birthDate) {
            if (!birthDate) return '';
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function formatDateTime(datetime) {
            if (!datetime) return '';
            const date = new Date(datetime);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${day}.${month} ${hours}:${minutes}`;
        }

        function addHours(datetime, hours) {
            if (!datetime) return null;
            const date = new Date(datetime);
            date.setHours(date.getHours() + hours);
            return date.toISOString();
        }

        // ==================== SORTING ====================
        function toggleSort(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'asc';
            }
            updateSortIcons();
            renderTable();
        }

        function onSearchInput(query) {
            searchQuery = query.toLowerCase().trim();
            document.getElementById('searchClear').classList.toggle('hidden', !query);
            renderTable();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            searchQuery = '';
            document.getElementById('searchClear').classList.add('hidden');
            renderTable();
        }

        function updateSortIcons() {
            document.querySelectorAll('.sort-icon').forEach(icon => {
                const field = icon.dataset.sort;
                if (field === sortField) {
                    icon.classList.add('active');
                    icon.textContent = sortDirection === 'asc' ? '↑' : '↓';
                } else {
                    icon.classList.remove('active');
                    icon.textContent = '↕';
                }
            });
        }

        function getSortedRegistrations() {
            let filtered = [...registrations];

            // Фильтрация по поиску
            if (searchQuery) {
                filtered = filtered.filter(reg => {
                    const v = reg.vaishnavas;
                    const name = `${v?.spiritual_name || ''} ${v?.first_name || ''} ${v?.last_name || ''}`.toLowerCase();
                    return name.includes(searchQuery);
                });
            }

            return filtered.sort((a, b) => {
                let aVal, bVal;

                if (sortField === 'name') {
                    aVal = (a.vaishnavas?.spiritual_name || `${a.vaishnavas?.first_name || ''} ${a.vaishnavas?.last_name || ''}`.trim()).toLowerCase();
                    bVal = (b.vaishnavas?.spiritual_name || `${b.vaishnavas?.first_name || ''} ${b.vaishnavas?.last_name || ''}`.trim()).toLowerCase();
                } else if (sortField === 'gender_age') {
                    const genderOrder = { male: 1, female: 2 };
                    const aGender = genderOrder[a.vaishnavas?.gender] || 3;
                    const bGender = genderOrder[b.vaishnavas?.gender] || 3;
                    if (aGender !== bGender) {
                        aVal = aGender;
                        bVal = bGender;
                    } else {
                        aVal = a.vaishnavas?.birth_date || '9999';
                        bVal = b.vaishnavas?.birth_date || '9999';
                    }
                } else if (sortField === 'arrival' || sortField === 'estimated') {
                    const aTransfer = (a.guest_transfers || []).find(t => t.direction === 'arrival');
                    const bTransfer = (b.guest_transfers || []).find(t => t.direction === 'arrival');
                    aVal = aTransfer?.flight_datetime || '9999';
                    bVal = bTransfer?.flight_datetime || '9999';
                } else {
                    aVal = '';
                    bVal = '';
                }

                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // ==================== RENDER ====================
        function renderTable() {
            const tbody = document.getElementById('arrivalsTable');
            const noData = document.getElementById('noData');

            if (!retreatId || registrations.length === 0) {
                tbody.innerHTML = '';
                noData.classList.remove('hidden');
                return;
            }

            noData.classList.add('hidden');
            const sorted = getSortedRegistrations();

            tbody.innerHTML = sorted.map(reg => {
                const v = reg.vaishnavas;
                const name = v ? `${v.first_name || ''} ${v.last_name || ''}`.trim() : '—';
                const spiritualName = v?.spiritual_name || '';

                const genderLabel = v?.gender === 'male' ? 'М' : v?.gender === 'female' ? 'Ж' : '';
                const age = v?.birth_date ? calculateAge(v.birth_date) : '';
                const genderAge = [genderLabel, age].filter(Boolean).join(', ') || '—';

                const arrival = (reg.guest_transfers || []).find(t => t.direction === 'arrival');
                const arrivalTime = arrival?.flight_datetime;
                const arrivalFormatted = formatDateTime(arrivalTime);
                const estimatedArrival = arrivalTime ? formatDateTime(addHours(arrivalTime, 4)) : '';

                const noArrivalTime = !arrivalTime;

                return `
                    <tr class="hover align-top">
                        <td class="cursor-pointer" onclick="window.location.href='../vaishnavas/person.html?id=${v?.id}'">
                            <div>
                                ${spiritualName ? `<div class="font-medium">${spiritualName}</div>` : ''}
                                <div class="${spiritualName ? 'text-xs opacity-60' : 'font-medium'}">${name}</div>
                            </div>
                        </td>
                        <td class="text-sm whitespace-nowrap">${genderAge}</td>
                        <td class="text-sm whitespace-nowrap ${noArrivalTime ? 'bg-warning/30' : ''}">
                            ${arrivalFormatted || '<span class="opacity-30">—</span>'}
                        </td>
                        <td class="text-sm whitespace-nowrap ${noArrivalTime ? 'bg-warning/30' : ''}">
                            ${estimatedArrival || '<span class="opacity-30">—</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ==================== INIT ====================
        async function init() {
            await Layout.init({ module: 'housing', menuId: 'placement', itemId: 'arrivals' });
            Layout.showLoader();
            await loadRetreats();
            Layout.hideLoader();
            updateSortIcons();
        }

        init();
    </script>

</body>
</html>
