<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–µ–∑–¥—ã</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="../css/common.css">
</head>
<body class="min-h-screen bg-base-200">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 max-w-6xl">

        <!-- Page Header -->
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold mb-2">–ó–∞–µ–∑–¥—ã</h1>
                <p class="text-sm opacity-60">–û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏–±—ã—Ç–∏—è –≥–æ—Å—Ç–µ–π</p>
            </div>

            <!-- Retreat Selector -->
            <div class="flex items-center gap-2">
                <select id="retreatSelect" class="select select-bordered" onchange="onRetreatChange(this.value)">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ç—Ä–∏—Ç...</option>
                </select>
            </div>
        </div>

        <!-- Stats Header (collapsible) -->
        <div id="statsWrapper" style="display: none;">
            <button class="flex items-center gap-2 mb-3 hover:opacity-70 transition-opacity" onclick="toggleStatsBlock()">
                <span id="statsToggleIcon" class="text-xs">‚ñº</span>
                <span class="font-semibold text-sm">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–µ–∑–¥–æ–≤</span>
            </button>

            <!-- Stats + Chart Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6" id="statsBlock" style="overflow: hidden; transition: all 0.2s;">
                <!-- Stats (1/3) -->
                <div class="bg-base-100 rounded-lg shadow p-4">
                    <div class="grid grid-cols-2 gap-3 text-center">
                        <div class="bg-accent/10 rounded-lg p-3">
                            <div class="text-2xl font-bold text-accent" id="statToday">0</div>
                            <div class="text-xs opacity-60">–°–µ–≥–æ–¥–Ω—è</div>
                        </div>
                        <div class="bg-info/10 rounded-lg p-3">
                            <div class="text-2xl font-bold text-info" id="statTomorrow">0</div>
                            <div class="text-xs opacity-60">–ó–∞–≤—Ç—Ä–∞</div>
                        </div>
                        <div class="bg-warning/10 rounded-lg p-3">
                            <div class="text-2xl font-bold text-warning" id="statNoTime">0</div>
                            <div class="text-xs opacity-60">–ë–µ–∑ –≤—Ä–µ–º–µ–Ω–∏</div>
                        </div>
                        <div class="bg-success/10 rounded-lg p-3">
                            <div class="text-2xl font-bold text-success" id="statWithTime">0</div>
                            <div class="text-xs opacity-60">–° –≤—Ä–µ–º–µ–Ω–µ–º</div>
                        </div>
                    </div>
                </div>

                <!-- Chart (2/3) -->
                <div class="lg:col-span-2 bg-base-100 rounded-lg shadow p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-sm">–ü—Ä–∏–µ–∑–¥ –≤ –®–†–°–ö</h3>
                        <div class="flex items-center gap-2">
                            <button class="btn btn-xs btn-ghost" onclick="changeChartDate(-1)">‚Üê</button>
                            <input type="date" id="chartDate" class="input input-xs input-bordered w-36" onchange="updateChart()">
                            <button class="btn btn-xs btn-ghost" onclick="changeChartDate(1)">‚Üí</button>
                        </div>
                    </div>
                    <div class="flex items-end gap-1 h-32 mt-4" id="chartBars">
                        <!-- Bars will be rendered by JS -->
                    </div>
                    <div class="flex justify-between text-xs opacity-50 mt-1 px-1">
                        <span>00:00</span>
                        <span>06:00</span>
                        <span>12:00</span>
                        <span>18:00</span>
                        <span>24:00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search -->
        <div class="mb-4">
            <div class="relative max-w-sm">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏..."
                       class="input input-bordered w-full pr-10"
                       oninput="onSearchInput(this.value)">
                <button id="searchClear" class="absolute right-3 top-1/2 -translate-y-1/2 opacity-50 hover:opacity-100 hidden" onclick="clearSearch()">‚úï</button>
            </div>
        </div>

        <!-- Cards -->
        <div id="cardsContainer"></div>
        <div id="noData" class="hidden text-center py-12 opacity-50">
            <div class="text-4xl mb-2">‚úàÔ∏è</div>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ç—Ä–∏—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–µ–∑–¥–æ–≤</p>
        </div>

    </main>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–∞–∫—Å–∏ -->
    <dialog id="taxiInfoModal" class="modal">
        <div class="modal-box max-w-sm">
            <h3 class="font-bold text-lg mb-4">üöï –¢–∞–∫—Å–∏ –∑–∞–∫–∞–∑–∞–Ω–æ</h3>
            <div class="space-y-3">
                <div>
                    <div class="text-xs opacity-50 mb-1">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–æ–¥–∏—Ç–µ–ª–µ</div>
                    <div id="taxiInfoDriver" class="whitespace-pre-wrap">‚Äî</div>
                </div>
                <div>
                    <div class="text-xs opacity-50 mb-1">–ó–∞–∫–∞–∑–∞–ª</div>
                    <div id="taxiInfoOrderedBy">‚Äî</div>
                </div>
            </div>
            <div class="modal-action">
                <form method="dialog"><button class="btn btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button></form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <div id="footer-placeholder"></div>

    <script src="../js/cache.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/layout.js"></script>
    <script>
        let retreatId = null;
        let registrations = [];
        let residentsMap = new Map(); // vaishnava_id ‚Üí { roomNumber, buildingName }
        let searchQuery = '';

        // ==================== DATA LOADING ====================
        async function loadRetreats() {
            const { data, error } = await Layout.db
                .from('retreats')
                .select('*')
                .order('start_date', { ascending: false });

            if (error) {
                console.error('Error loading retreats:', error);
                return;
            }

            const select = document.getElementById('retreatSelect');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ç—Ä–∏—Ç...</option>' +
                (data || []).map(r => `<option value="${r.id}">${Layout.getName(r)}</option>`).join('');

            // Check URL for retreat id
            const urlParams = new URLSearchParams(window.location.search);
            const urlRetreatId = urlParams.get('retreat');
            if (urlRetreatId) {
                select.value = urlRetreatId;
                onRetreatChange(urlRetreatId);
            } else if (data && data.length > 0) {
                // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –±–ª–∏–∂–∞–π—à–µ–≥–æ —Ä–µ—Ç—Ä–∏—Ç–∞
                const today = toLocalDateStr(new Date());
                const active = data.filter(r => r.end_date >= today);
                const nearest = active.length > 0 ? active[active.length - 1] : data[0];
                select.value = nearest.id;
                onRetreatChange(nearest.id);
            }
        }

        async function onRetreatChange(id) {
            retreatId = id;

            // Update URL
            const url = new URL(window.location);
            if (id) {
                url.searchParams.set('retreat', id);
            } else {
                url.searchParams.delete('retreat');
            }
            window.history.replaceState({}, '', url);

            if (!id) {
                registrations = [];
                residentsMap = new Map();
                renderCards();
                document.getElementById('statsWrapper').style.display = 'none';
                return;
            }

            await loadRegistrations();
        }

        async function loadRegistrations() {
            Layout.showLoader();

            const regResult = await Layout.db
                .from('retreat_registrations')
                .select(`
                    id,
                    vaishnava_id,
                    status,
                    vaishnavas (id, first_name, last_name, spiritual_name, gender, birth_date, phone, telegram, has_whatsapp),
                    guest_transfers (*)
                `)
                .eq('retreat_id', retreatId)
                .eq('is_deleted', false)
                .in('status', ['pending', 'confirmed', 'team']);

            if (regResult.error) {
                Layout.hideLoader();
                console.error('Error loading registrations:', regResult.error);
                return;
            }

            registrations = regResult.data || [];

            // –°–æ–±–∏—Ä–∞–µ–º vaishnava_id –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–π
            const vaishnavaIds = registrations.map(r => r.vaishnava_id).filter(Boolean);

            residentsMap = new Map();
            if (vaishnavaIds.length > 0) {
                const resResult = await Layout.db
                    .from('residents')
                    .select('vaishnava_id, rooms(number, buildings(name_ru, name_en, name_hi))')
                    .in('vaishnava_id', vaishnavaIds)
                    .in('status', ['active', 'confirmed']);

                if (resResult.data) {
                    resResult.data.forEach(r => {
                        if (r.vaishnava_id && r.rooms) {
                            residentsMap.set(r.vaishnava_id, {
                                roomNumber: r.rooms.number,
                                buildingName: Layout.getName(r.rooms.buildings)
                            });
                        }
                    });
                }
            }

            Layout.hideLoader();

            updateStats();
            renderCards();
            document.getElementById('statsWrapper').style.display = '';
        }

        // Helper to format date as YYYY-MM-DD in local timezone
        function toLocalDateStr(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function updateStats() {
            const total = registrations.length;
            let withTime = 0;
            let noTime = 0;
            let today = 0;
            let tomorrow = 0;

            const now = new Date();
            const todayStr = toLocalDateStr(now);
            const tomorrowDate = new Date(now);
            tomorrowDate.setDate(tomorrowDate.getDate() + 1);
            const tomorrowStr = toLocalDateStr(tomorrowDate);

            registrations.forEach(reg => {
                const arrival = (reg.guest_transfers || []).find(t => t.direction === 'arrival');
                if (arrival?.flight_datetime) {
                    withTime++;
                    const estimatedDate = new Date(arrival.flight_datetime);
                    estimatedDate.setHours(estimatedDate.getHours() + 4);
                    const estimatedStr = toLocalDateStr(estimatedDate);

                    if (estimatedStr === todayStr) today++;
                    if (estimatedStr === tomorrowStr) tomorrow++;
                } else {
                    noTime++;
                }
            });

            document.getElementById('statToday').textContent = today;
            document.getElementById('statTomorrow').textContent = tomorrow;
            document.getElementById('statWithTime').textContent = withTime;
            document.getElementById('statNoTime').textContent = noTime;

            const chartDateInput = document.getElementById('chartDate');
            if (!chartDateInput.value) {
                chartDateInput.value = todayStr;
            }
            updateChart();
        }

        // ==================== STATS BLOCK ====================
        const STATS_COLLAPSED_KEY = 'srsk_arrivals_stats_collapsed';

        function toggleStatsBlock() {
            const statsBlock = document.getElementById('statsBlock');
            const icon = document.getElementById('statsToggleIcon');
            const isCollapsed = statsBlock.style.display === 'none';

            if (isCollapsed) {
                statsBlock.style.display = '';
                icon.textContent = '‚ñº';
                localStorage.removeItem(STATS_COLLAPSED_KEY);
            } else {
                statsBlock.style.display = 'none';
                icon.textContent = '‚ñ∂';
                localStorage.setItem(STATS_COLLAPSED_KEY, '1');
            }
        }

        function initStatsState() {
            if (localStorage.getItem(STATS_COLLAPSED_KEY)) {
                const statsBlock = document.getElementById('statsBlock');
                const icon = document.getElementById('statsToggleIcon');
                statsBlock.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        function updateChart() {
            const selectedDate = document.getElementById('chartDate').value;
            if (!selectedDate) return;

            const hourCounts = {};
            for (let h = 0; h < 24; h++) {
                hourCounts[h] = 0;
            }

            registrations.forEach(reg => {
                const arrival = (reg.guest_transfers || []).find(t => t.direction === 'arrival');
                if (arrival?.flight_datetime) {
                    const estimatedDate = new Date(arrival.flight_datetime);
                    estimatedDate.setHours(estimatedDate.getHours() + 4);
                    const dateStr = toLocalDateStr(estimatedDate);

                    if (dateStr === selectedDate) {
                        const hour = estimatedDate.getHours();
                        hourCounts[hour]++;
                    }
                }
            });

            const maxCount = Math.max(...Object.values(hourCounts), 1);

            const hoursOrder = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23];
            const chartBars = document.getElementById('chartBars');

            const maxBarHeight = 120;
            chartBars.innerHTML = hoursOrder.map(h => {
                const count = hourCounts[h];
                const heightPx = count > 0 ? Math.max(Math.round((count / maxCount) * maxBarHeight), 10) : 5;
                const barBg = count > 0 ? '#570df8' : '#e5e7eb';
                const title = `${h.toString().padStart(2, '0')}:00 ‚Äî ${count} —á–µ–ª.`;

                return `<div style="flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; min-width: 8px;" title="${title}">
                    ${count > 0 ? `<div style="font-size: 11px; font-weight: 500; margin-bottom: 2px;">${count}</div>` : ''}
                    <div style="width: 100%; height: ${heightPx}px; background: ${barBg}; border-radius: 4px 4px 0 0;"></div>
                </div>`;
            }).join('');
        }

        function changeChartDate(delta) {
            const input = document.getElementById('chartDate');
            const date = new Date(input.value + 'T12:00:00');
            date.setDate(date.getDate() + delta);
            input.value = toLocalDateStr(date);
            updateChart();
        }

        // ==================== HELPERS ====================
        function calculateAge(birthDate) {
            if (!birthDate) return '';
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function formatDateTime(datetime) {
            if (!datetime) return '';
            const date = new Date(datetime);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${day}.${month} ${hours}:${minutes}`;
        }

        function formatTime(datetime) {
            if (!datetime) return '';
            const date = new Date(datetime);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function addHours(datetime, hours) {
            if (!datetime) return null;
            const date = new Date(datetime);
            date.setHours(date.getHours() + hours);
            return date.toISOString();
        }

        function formatDateLabel(dateStr) {
            const date = new Date(dateStr + 'T12:00:00');
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const weekDays = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
            return `${day}.${month}, ${weekDays[date.getDay()]}`;
        }

        function formatPhone(phone) {
            if (!phone) return '';
            return phone.replace(/[^\d+]/g, '');
        }

        // ==================== SEARCH ====================
        function onSearchInput(query) {
            searchQuery = query.toLowerCase().trim();
            document.getElementById('searchClear').classList.toggle('hidden', !query);
            renderCards();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            searchQuery = '';
            document.getElementById('searchClear').classList.add('hidden');
            renderCards();
        }

        function getFilteredRegistrations() {
            let filtered = [...registrations];

            if (searchQuery) {
                filtered = filtered.filter(reg => {
                    const v = reg.vaishnavas;
                    const name = `${v?.spiritual_name || ''} ${v?.first_name || ''} ${v?.last_name || ''}`.toLowerCase();
                    return name.includes(searchQuery);
                });
            }

            return filtered;
        }

        // ==================== RENDER ====================
        function getGroupLabel(dateStr) {
            const now = new Date();
            const todayStr = toLocalDateStr(now);
            const tomorrowDate = new Date(now);
            tomorrowDate.setDate(tomorrowDate.getDate() + 1);
            const tomorrowStr = toLocalDateStr(tomorrowDate);
            const dayAfterDate = new Date(now);
            dayAfterDate.setDate(dayAfterDate.getDate() + 2);
            const dayAfterStr = toLocalDateStr(dayAfterDate);

            if (dateStr === todayStr) return `–°–µ–≥–æ–¥–Ω—è, ${formatDateLabel(dateStr)}`;
            if (dateStr === tomorrowStr) return `–ó–∞–≤—Ç—Ä–∞, ${formatDateLabel(dateStr)}`;
            return formatDateLabel(dateStr);
        }

        function renderCard(reg) {
            const v = reg.vaishnavas;
            const name = v ? `${v.first_name || ''} ${v.last_name || ''}`.trim() : '‚Äî';
            const spiritualName = v?.spiritual_name || '';

            const genderLabel = v?.gender === 'male' ? '–ú' : v?.gender === 'female' ? '–ñ' : '';
            const age = v?.birth_date ? calculateAge(v.birth_date) : '';
            const genderAge = [genderLabel, age].filter(Boolean).join(', ');

            const arrival = (reg.guest_transfers || []).find(t => t.direction === 'arrival');
            const arrivalTime = arrival?.flight_datetime;
            const estimatedArrival = arrivalTime ? addHours(arrivalTime, 4) : null;

            const accommodation = v ? residentsMap.get(v.id) : null;

            const phone = v?.phone ? formatPhone(v.phone) : '';
            const hasWhatsapp = v?.has_whatsapp && phone;
            const telegram = v?.telegram;

            // –°—Ç—Ä–æ–∏–º –∫–∞—Ä—Ç–æ—á–∫—É
            let html = `<div class="bg-base-100 rounded-lg shadow p-3 flex flex-col gap-1.5">`;

            // –ò–º—è (–∫–ª–∏–∫ ‚Üí person.html)
            html += `<a href="../vaishnavas/person.html?id=${v?.id}" class="hover:underline">`;
            if (spiritualName) {
                html += `<span class="font-semibold">${spiritualName}</span>`;
                html += `<span class="text-xs opacity-60 ml-1.5">${name}</span>`;
            } else {
                html += `<span class="font-semibold">${name}</span>`;
            }
            html += `</a>`;

            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ —Å—Ç—Ä–æ–∫—É
            const infoParts = [];
            if (genderAge) infoParts.push(genderAge);
            if (arrivalTime) {
                infoParts.push(`<span title="–í—Ä–µ–º—è –ø—Ä–∏–ª—ë—Ç–∞">‚úà ${formatDateTime(arrivalTime)}</span>`);
                infoParts.push(`<span class="font-semibold text-base-content" title="–ü—Ä–∏–µ–¥–µ—Ç –≤ –®–†–°–ö">‚Üí ${formatTime(estimatedArrival)}</span>`);
            }
            if (arrival?.taxi_status === 'ordered') {
                const driverInfo = arrival.taxi_driver_info ? arrival.taxi_driver_info.replace(/'/g, '&#39;').replace(/"/g, '&quot;') : '';
                const orderedBy = arrival.taxi_ordered_by ? arrival.taxi_ordered_by.replace(/'/g, '&#39;').replace(/"/g, '&quot;') : '';
                infoParts.push(`<span class="badge badge-success badge-sm gap-1 cursor-pointer" onclick="event.preventDefault(); showTaxiInfo('${driverInfo}', '${orderedBy}')">üöï –¢–∞–∫—Å–∏ –∑–∞–∫–∞–∑–∞–Ω–æ</span>`);
            }
            if (accommodation) {
                infoParts.push(`<span class="font-semibold text-base-content" title="–†–∞–∑–º–µ—â–µ–Ω–∏–µ">üè† ${accommodation.buildingName}, ${accommodation.roomNumber}</span>`);
            }

            if (infoParts.length) {
                html += `<div class="flex flex-wrap items-center gap-x-3 gap-y-0.5 text-sm opacity-70">${infoParts.join('')}</div>`;
            }

            // –ö–æ–Ω—Ç–∞–∫—Ç—ã
            const contactParts = [];
            if (hasWhatsapp) {
                contactParts.push(`<a href="https://wa.me/${phone.replace('+', '')}" target="_blank" class="btn btn-xs btn-ghost gap-1 text-green-600" title="WhatsApp">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 0C5.373 0 0 5.373 0 12c0 2.126.554 4.12 1.522 5.856L.057 23.988l6.272-1.418A11.935 11.935 0 0012 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 21.75c-1.875 0-3.66-.507-5.228-1.467l-.375-.222-3.89.88.918-3.792-.244-.388A9.698 9.698 0 012.25 12 9.75 9.75 0 0112 2.25 9.75 9.75 0 0121.75 12 9.75 9.75 0 0112 21.75z"/></svg>
                    WA</a>`);
            } else if (phone) {
                contactParts.push(`<a href="tel:${phone}" class="btn btn-xs btn-ghost gap-1" title="–ü–æ–∑–≤–æ–Ω–∏—Ç—å">üìû ${v.phone}</a>`);
            }
            if (telegram) {
                const tgUsername = telegram.replace(/^@/, '');
                contactParts.push(`<a href="https://t.me/${tgUsername}" target="_blank" class="btn btn-xs btn-ghost gap-1 text-blue-500" title="Telegram">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0a12 12 0 00-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 01.171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                    TG</a>`);
            }

            if (contactParts.length) {
                html += `<div class="flex items-center gap-1 -ml-1">${contactParts.join('')}</div>`;
            }

            html += `</div>`;
            return html;
        }

        function renderCards() {
            const container = document.getElementById('cardsContainer');
            const noData = document.getElementById('noData');

            if (!retreatId || registrations.length === 0) {
                container.innerHTML = '';
                noData.classList.remove('hidden');
                return;
            }

            noData.classList.add('hidden');
            const filtered = getFilteredRegistrations();

            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-center py-8 opacity-50">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                return;
            }

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ estimated arrival
            const groups = new Map(); // dateStr ‚Üí [regs]
            const noTimeGroup = [];

            filtered.forEach(reg => {
                const arrival = (reg.guest_transfers || []).find(t => t.direction === 'arrival');
                if (arrival?.flight_datetime) {
                    const estimatedDate = new Date(arrival.flight_datetime);
                    estimatedDate.setHours(estimatedDate.getHours() + 4);
                    const dateStr = toLocalDateStr(estimatedDate);

                    if (!groups.has(dateStr)) groups.set(dateStr, []);
                    groups.get(dateStr).push(reg);
                } else {
                    noTimeGroup.push(reg);
                }
            });

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≥—Ä—É–ø–ø—ã –ø–æ –¥–∞—Ç–µ
            const sortedDates = [...groups.keys()].sort();

            // –í–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ estimated arrival
            for (const [dateStr, regs] of groups) {
                regs.sort((a, b) => {
                    const aTransfer = (a.guest_transfers || []).find(t => t.direction === 'arrival');
                    const bTransfer = (b.guest_transfers || []).find(t => t.direction === 'arrival');
                    return (aTransfer?.flight_datetime || '').localeCompare(bTransfer?.flight_datetime || '');
                });
            }

            // –†–µ–Ω–¥–µ—Ä–∏–º
            let html = '';

            for (const dateStr of sortedDates) {
                const regs = groups.get(dateStr);
                const label = getGroupLabel(dateStr);
                html += `<div class="mb-6">
                    <h3 class="font-semibold text-sm mb-2 flex items-center gap-2">
                        ${label}
                        <span class="badge badge-sm badge-ghost">${regs.length}</span>
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                        ${regs.map(r => renderCard(r)).join('')}
                    </div>
                </div>`;
            }

            if (noTimeGroup.length > 0) {
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏
                noTimeGroup.sort((a, b) => {
                    const aName = (a.vaishnavas?.spiritual_name || `${a.vaishnavas?.first_name || ''} ${a.vaishnavas?.last_name || ''}`.trim()).toLowerCase();
                    const bName = (b.vaishnavas?.spiritual_name || `${b.vaishnavas?.first_name || ''} ${b.vaishnavas?.last_name || ''}`.trim()).toLowerCase();
                    return aName.localeCompare(bName);
                });

                html += `<div class="mb-6">
                    <h3 class="font-semibold text-sm mb-2 flex items-center gap-2 text-warning">
                        –ë–µ–∑ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–ª—ë—Ç–∞
                        <span class="badge badge-sm badge-warning">${noTimeGroup.length}</span>
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                        ${noTimeGroup.map(r => renderCard(r)).join('')}
                    </div>
                </div>`;
            }

            container.innerHTML = html;
        }

        // ==================== –¢–ê–ö–°–ò ====================
        function showTaxiInfo(driverInfo, orderedBy) {
            document.getElementById('taxiInfoDriver').textContent = driverInfo || '‚Äî';
            document.getElementById('taxiInfoOrderedBy').textContent = orderedBy || '‚Äî';
            document.getElementById('taxiInfoModal').showModal();
        }

        // ==================== INIT ====================
        async function init() {
            await Layout.init({ module: 'housing', menuId: 'placement', itemId: 'arrivals' });
            initStatsState();
            Layout.showLoader();
            await loadRetreats();
            Layout.hideLoader();
        }

        init();
    </script>

</body>
</html>
