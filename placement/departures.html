<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script src="../js/color-init.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Выезды</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="../css/common.css">
</head>
<body class="min-h-screen bg-base-200">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 max-w-6xl">

        <!-- Page Header -->
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold mb-2" data-i18n="departures">Выезды</h1>
                <p class="text-sm opacity-60" data-i18n="departures_description">Ожидаемое время выезда гостей</p>
            </div>

            <!-- Retreat Selector -->
            <div class="flex items-center gap-2">
                <select id="retreatSelect" class="select select-bordered" onchange="onRetreatChange(this.value)">
                    <option value="" data-i18n="select_retreat">Выберите ретрит...</option>
                </select>
            </div>
        </div>

        <!-- Stats Header (collapsible) -->
        <div id="statsWrapper" style="display: none;">
            <button class="flex items-center gap-2 mb-3 hover:opacity-70 transition-opacity" onclick="toggleStatsBlock()">
                <span id="statsToggleIcon" class="text-xs">▼</span>
                <span class="font-semibold text-sm" data-i18n="departures_stats">Статистика выездов</span>
            </button>

            <!-- Stats + Chart Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6" id="statsBlock" style="overflow: hidden; transition: all 0.2s;">
                <!-- Stats (1/3) -->
                <div class="bg-base-100 rounded-lg shadow p-4">
                    <div class="grid grid-cols-2 gap-3 text-center">
                        <div class="bg-accent/10 rounded-lg p-3">
                            <div class="text-2xl font-bold text-accent" id="statToday">0</div>
                            <div class="text-xs opacity-60" data-i18n="today">Сегодня</div>
                        </div>
                        <div class="bg-info/10 rounded-lg p-3">
                            <div class="text-2xl font-bold text-info" id="statTomorrow">0</div>
                            <div class="text-xs opacity-60" data-i18n="tomorrow">Завтра</div>
                        </div>
                        <div class="bg-warning/10 rounded-lg p-3">
                            <div class="text-2xl font-bold text-warning" id="statNoTime">0</div>
                            <div class="text-xs opacity-60" data-i18n="without_time">Без времени</div>
                        </div>
                        <div class="bg-success/10 rounded-lg p-3">
                            <div class="text-2xl font-bold text-success" id="statWithTime">0</div>
                            <div class="text-xs opacity-60" data-i18n="with_time">С временем</div>
                        </div>
                    </div>
                </div>

                <!-- Chart (2/3) -->
                <div class="lg:col-span-2 bg-base-100 rounded-lg shadow p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-sm" data-i18n="departure_from_srsc">Выезд из ШРСК</h3>
                        <div class="flex items-center gap-2">
                            <button class="btn btn-xs btn-ghost" onclick="changeChartDate(-1)">←</button>
                            <input type="date" id="chartDate" class="input input-xs input-bordered w-36" onchange="updateChart()">
                            <button class="btn btn-xs btn-ghost" onclick="changeChartDate(1)">→</button>
                        </div>
                    </div>
                    <div class="flex items-end gap-1 h-32 mt-4" id="chartBars">
                        <!-- Bars will be rendered by JS -->
                    </div>
                    <div class="flex justify-between text-xs opacity-50 mt-1 px-1">
                        <span>00:00</span>
                        <span>06:00</span>
                        <span>12:00</span>
                        <span>18:00</span>
                        <span>24:00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="mb-4 flex gap-4">
            <div class="relative flex-1 max-w-sm">
                <input type="text" id="searchInput" data-i18n-placeholder="search_by_name"
                       class="input input-bordered w-full pr-10"
                       oninput="onSearchInput(this.value)">
                <button id="searchClear" class="absolute right-3 top-1/2 -translate-y-1/2 opacity-50 hover:opacity-100 hidden" onclick="clearSearch()">✕</button>
            </div>
            <select id="buildingFilter" class="select select-bordered w-64" onchange="onBuildingChange(this.value)">
                <option value="all" data-i18n="all_buildings">Все гостиницы</option>
            </select>
        </div>

        <!-- Table -->
        <div id="tableContainer"></div>
        <div id="noData" class="hidden text-center py-12 opacity-50">
            <div class="text-4xl mb-2">✈️</div>
            <p data-i18n="select_retreat_for_departures">Выберите ретрит для просмотра выездов</p>
        </div>

    </main>

    <!-- Модалка заказа такси -->
    <dialog id="taxiModal" class="modal">
        <div class="modal-box max-w-sm">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>
            <h3 class="font-bold text-lg mb-4">Заказ такси</h3>
            <input type="hidden" id="taxiTransferId">
            <div class="form-control mb-3">
                <label class="label"><span class="label-text">Информация о водителе</span></label>
                <textarea id="taxiDriverInfo" class="textarea textarea-bordered" rows="3" placeholder="Имя, телефон, марка авто..."></textarea>
            </div>
            <div class="form-control mb-4">
                <label class="label"><span class="label-text">Кто заказал:</span></label>
                <input type="text" id="taxiOrderedBy" class="input input-bordered" placeholder="Кто заказывает">
            </div>
            <div class="modal-action">
                <button class="btn btn-primary" onclick="saveTaxiOrder()">Заказать</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Модалка просмотра/редактирования информации о такси -->
    <dialog id="taxiDetailsModal" class="modal">
        <div class="modal-box max-w-sm">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-success" viewBox="0 0 103.07 59.75" fill="currentColor">
                    <path d="M5.75,53.47c-1.68-1.71-2.63-4.23-2.68-6.64,2.97-10.49,6.26-20.89,9.36-31.35,1.71-5.78,1.81-10.95,9.24-12.11h58.86c3.74.23,7.15,2.76,8.35,6.35.33,1,.31,1.98.58,2.89,3.38,11.42,6.9,22.8,10.18,34.25-.11,4.72-3.5,8.64-8.16,9.3H11.55c-2.09-.16-4.35-1.22-5.8-2.7ZM21.72,9.78c-2.2.69-1.86,2.64-2.36,4.28-3.3,10.95-6.61,21.9-9.85,32.87-.47,2.23,1.92,3.11,3.77,3.19h76.19c1.99-.17,3.63-.69,3.83-2.97-3.25-10.64-6.4-21.3-9.61-31.95-.48-1.59-.56-4.58-2.24-5.26l-59.73-.16Z"/>
                    <polygon points="60.75 20.68 63.64 26.16 67.25 20.68 72.58 20.68 66.57 29.82 72.29 38.86 66.96 38.86 63.64 33.67 61.04 38.86 55.27 38.86 60.98 29.81 55.27 20.68 60.75 20.68"/>
                    <path d="M37.96,38.86l6.09-18.15,4.45-.05,6.48,18.2h-4.76l-1.27-3.29-4.91-.14-.89,3.43h-5.19ZM48.06,31.93c-.5-1.5-.78-3.12-1.3-4.61-.1-.28-.03-.66-.42-.58l-1.45,5.19h3.17Z"/>
                    <polygon points="39.12 20.68 39.12 25.01 33.92 25.01 33.92 38.86 28.73 38.86 28.73 25.01 23.54 25.01 23.54 20.68 39.12 20.68"/>
                    <rect x="74.03" y="20.68" width="5.19" height="18.18"/>
                </svg>
                <span>Такси заказано</span>
            </h3>
            <input type="hidden" id="taxiDetailsTransferId">
            <div class="form-control mb-3">
                <label class="label"><span class="label-text">Информация о водителе</span></label>
                <textarea id="taxiDetailsDriver" class="textarea textarea-bordered" rows="3" placeholder="Имя, телефон, марка авто..."></textarea>
            </div>
            <div class="form-control mb-4">
                <label class="label"><span class="label-text">Кто заказал:</span></label>
                <input type="text" id="taxiDetailsOrderedBy" class="input input-bordered" placeholder="Кто заказывает">
            </div>
            <div class="modal-action">
                <button class="btn btn-primary" onclick="saveEditedTaxiDetails()">Сохранить</button>
                <button class="btn btn-error btn-outline" onclick="cancelTaxiFromDetails()">Отменить такси</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <div id="footer-placeholder"></div>

    <script src="../js/config.js"></script>
    <script src="../js/auth-check.js?v=3"></script>
    <script src="../js/cache.js"></script>
    <script src="../js/utils.js?v=2"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/date-utils.js"></script>
    <script src="../js/layout.js?v=5"></script>
    <script src="../js/pages/departures.js"></script>

</body>
</html>
