<!DOCTYPE html>
<html lang="ru" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ ‚Äî –®–†–°–ö</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/color-init.js"></script>
    <link rel="stylesheet" href="../css/common.css">
</head>

<body class="bg-base-200 min-h-screen flex flex-col">
    <div id="header-placeholder"></div>

    <main class="container mx-auto p-4 flex-1">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h1>
        </div>

        <!-- –¢–∞–±—ã -->
        <div role="tablist" class="tabs tabs-boxed mb-6">
            <a role="tab" class="tab tab-active" data-tab="all" onclick="switchTab('all')">
                –í—Å–µ (<span id="countAll">0</span>)
            </a>
            <a role="tab" class="tab" data-tab="pending" onclick="switchTab('pending')">
                –û–∂–∏–¥–∞—é—Ç (<span id="countPending">0</span>)
            </a>
            <a role="tab" class="tab" data-tab="staff" onclick="switchTab('staff')">
                –ö–æ–º–∞–Ω–¥–∞ (<span id="countStaff">0</span>)
            </a>
            <a role="tab" class="tab" data-tab="guest" onclick="switchTab('guest')">
                –ì–æ—Å—Ç–∏ (<span id="countGuest">0</span>)
            </a>
            <a role="tab" class="tab" data-tab="blocked" onclick="switchTab('blocked')">
                –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (<span id="countBlocked">0</span>)
            </a>
        </div>

        <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
        <div class="mb-4 flex flex-wrap gap-2">
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email..."
                   class="input input-bordered flex-1 min-w-48" onkeyup="filterUsers()">
            <button class="btn btn-outline btn-primary" onclick="sendBulkInvites()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –≤—Å–µ—Ö –±–µ–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ (<span id="countNoAccount">0</span>)
            </button>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div class="overflow-x-auto bg-base-100 rounded-lg shadow">
            <table class="table table-zebra">
                <thead>
                    <tr>
                        <th>–§–æ—Ç–æ</th>
                        <th>–ò–º—è</th>
                        <th>Email</th>
                        <th>–¢–∏–ø</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–†–æ–ª–∏</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="7" class="text-center py-8">
                            <span class="loading loading-spinner loading-lg"></span>
                            <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º -->
    <dialog id="manageUserModal" class="modal">
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-lg mb-4">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º: <span id="modalUserName"></span></h3>

            <div class="space-y-4">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div><strong>Email:</strong> <span id="modalUserEmail"></span></div>
                    <div><strong>–¢–∏–ø:</strong> <span id="modalUserType"></span></div>
                </div>

                <!-- –°—Ç–∞—Ç—É—Å -->
                <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-2">
                        <input type="checkbox" id="modalIsActive" class="checkbox checkbox-sm" disabled>
                        <span class="label-text">–ê–∫—Ç–∏–≤–µ–Ω</span>
                    </label>
                    <label class="label cursor-pointer justify-start gap-2">
                        <input type="checkbox" id="modalIsSuperuser" class="checkbox checkbox-sm">
                        <span class="label-text">–°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                    </label>
                </div>

                <div class="divider">–†–æ–ª–∏</div>

                <!-- –†–æ–ª–∏ -->
                <div id="rolesContainer" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- –†–æ–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                <div class="divider">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞</div>

                <!-- –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ -->
                <div class="flex gap-2">
                    <button class="btn btn-sm btn-outline" onclick="openAddPermissionModal()">
                        + –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–æ
                    </button>
                    <button class="btn btn-sm btn-outline btn-error" onclick="openRevokePermissionModal()">
                        ‚àí –£–±—Ä–∞—Ç—å –ø—Ä–∞–≤–æ
                    </button>
                </div>

                <div id="customPermissionsContainer" class="text-sm">
                    <!-- –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>

            <div class="modal-action">
                <button class="btn btn-error mr-auto" onclick="blockUser()">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn" onclick="closeManageModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="saveUserChanges()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- –ú–æ–¥–∞–ª–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ -->
    <dialog id="permissionSelectModal" class="modal">
        <div class="modal-box max-w-4xl">
            <h3 class="font-bold text-lg mb-4">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>

            <div class="alert alert-info mb-4">
                <div class="text-sm">
                    <strong>–°–µ—Ä—ã–µ –≥–∞–ª–æ—á–∫–∏</strong> - –ø—Ä–∞–≤–∞ –∏–∑ —Ä–æ–ª–µ–π. <strong>–¶–≤–µ—Ç–Ω—ã–µ –≥–∞–ª–æ—á–∫–∏</strong> - –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.
                    <br>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≥–∞–ª–æ—á–∫—É —á—Ç–æ–±—ã <strong>–¥–æ–±–∞–≤–∏—Ç—å</strong> –ø—Ä–∞–≤–æ, —Å–Ω–∏–º–∏—Ç–µ —á—Ç–æ–±—ã <strong>—É–±—Ä–∞—Ç—å</strong>.
                </div>
            </div>

            <div class="form-control mb-4">
                <input type="text" id="permissionSearch" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–∞–≤–∞..." class="input input-bordered">
            </div>

            <div class="max-h-96 overflow-y-auto">
                <div id="permissionsList"></div>
            </div>

            <div class="modal-action">
                <button class="btn" onclick="document.getElementById('permissionSelectModal').close()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è -->
    <dialog id="approvalModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4" id="approvalTitle"></h3>
            <p id="approvalText"></p>
            <div class="modal-action">
                <button class="btn" onclick="closeApprovalModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" id="approvalConfirmBtn" onclick="confirmApproval()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </dialog>

    <script src="../js/config.js"></script>
    <script src="../js/auth-check.js?v=2"></script>
    <script src="../js/cache.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/layout.js?v=4"></script>
    <script>
        const db = window.supabaseClient;

        let allUsers = [];
        let currentTab = 'all';
        let currentUserId = null;
        let approvalAction = null;
        let countsLoaded = false;
        let isLoading = false;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ª—å–∫–æ —Å—á—ë—Ç—á–∏–∫–æ–≤ (–±—ã—Å—Ç—Ä–æ, –±–µ–∑ —Ä–æ–ª–µ–π)
        async function loadCounts() {
            try {
                const { data: users, error } = await db
                    .from('vaishnavas')
                    .select('id, user_id, email, user_type, approval_status, is_active')
                    .eq('is_deleted', false);

                if (error) throw error;

                document.getElementById('countAll').textContent = users.length;
                document.getElementById('countPending').textContent = users.filter(u => u.approval_status === 'pending').length;
                document.getElementById('countStaff').textContent = users.filter(u => u.user_type === 'staff').length;
                document.getElementById('countGuest').textContent = users.filter(u => u.user_type === 'guest').length;
                document.getElementById('countBlocked').textContent = users.filter(u => u.approval_status === 'blocked' || !u.is_active).length;
                document.getElementById('countNoAccount').textContent = users.filter(u => !u.user_id && u.email).length;
                countsLoaded = true;
            } catch (err) {
                console.error('Load counts error:', err);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
        async function loadUsers(filter = {}) {
            if (isLoading) return;
            isLoading = true;

            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8"><span class="loading loading-spinner loading-lg"></span></td></tr>';

            try {
                let query = db
                    .from('vaishnavas')
                    .select(`
                        id,
                        user_id,
                        email,
                        first_name,
                        last_name,
                        spiritual_name,
                        photo_url,
                        user_type,
                        approval_status,
                        is_superuser,
                        is_active
                    `)
                    .eq('is_deleted', false)
                    .order('created_at', { ascending: false });

                // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
                if (filter.tab === 'pending') {
                    query = query.eq('approval_status', 'pending');
                } else if (filter.tab === 'staff') {
                    query = query.eq('user_type', 'staff');
                } else if (filter.tab === 'guest') {
                    query = query.eq('user_type', 'guest');
                } else if (filter.tab === 'blocked') {
                    query = query.or('approval_status.eq.blocked,is_active.eq.false');
                }

                // –ü–æ–∏—Å–∫
                if (filter.search && filter.search.length >= 2) {
                    const s = filter.search.toLowerCase();
                    query = query.or(`spiritual_name.ilike.%${s}%,first_name.ilike.%${s}%,last_name.ilike.%${s}%,email.ilike.%${s}%`);
                }

                // –õ–∏–º–∏—Ç –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                query = query.limit(100);

                const { data: users, error } = await query;
                if (error) throw error;

                // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–æ–ª–∏ –û–î–ù–ò–ú –∑–∞–ø—Ä–æ—Å–æ–º (–≤–º–µ—Å—Ç–æ N+1)
                const userIds = users.filter(u => u.user_id).map(u => u.user_id);
                let rolesMap = {};

                if (userIds.length > 0) {
                    const { data: allRoles } = await db
                        .from('user_roles')
                        .select(`
                            user_id,
                            roles!inner (name_ru, code)
                        `)
                        .in('user_id', userIds)
                        .eq('is_active', true);

                    // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ user_id
                    if (allRoles) {
                        allRoles.forEach(r => {
                            if (!rolesMap[r.user_id]) rolesMap[r.user_id] = [];
                            rolesMap[r.user_id].push(r);
                        });
                    }
                }

                // –ü—Ä–∏—Å–≤–æ–∏—Ç—å —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
                users.forEach(u => {
                    u.roles = rolesMap[u.user_id] || [];
                });

                allUsers = users;
                renderUsers();
            } catch (err) {
                console.error('Load users error:', err);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
            } finally {
                isLoading = false;
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('tab-active');
            document.getElementById('searchInput').value = '';

            if (tab === 'all') {
                // –ü–æ–∫–∞–∑–∞—Ç—å placeholder –≤–º–µ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö
                showPlaceholder();
            } else {
                loadUsers({ tab });
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å placeholder
        function showPlaceholder() {
            allUsers = [];
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-12">
                        <div class="text-base-content/50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <p class="text-lg font-medium mb-1">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è –ø–æ–∏—Å–∫–∞</p>
                            <p class="text-sm">–∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤—ã—à–µ</p>
                        </div>
                    </td>
                </tr>
            `;
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å debounce
        let searchTimeout;
        function filterUsers() {
            clearTimeout(searchTimeout);
            const searchText = document.getElementById('searchInput').value.trim();

            if (searchText.length === 0) {
                if (currentTab === 'all') {
                    showPlaceholder();
                } else {
                    loadUsers({ tab: currentTab });
                }
                return;
            }

            if (searchText.length < 2) return;

            searchTimeout = setTimeout(() => {
                loadUsers({ search: searchText, tab: currentTab !== 'all' ? currentTab : null });
            }, 300);
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —É–∂–µ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ë–î)
        function renderUsers() {
            const tbody = document.getElementById('usersTableBody');

            if (allUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
                return;
            }

            tbody.innerHTML = allUsers.map(user => `
                <tr>
                    <td>
                        <div class="avatar">
                            <div class="w-10 h-10 rounded-full">
                                ${user.photo_url
                                    ? `<img src="${user.photo_url}" alt="${user.spiritual_name || user.first_name}">`
                                    : `<div class="bg-primary text-primary-content w-full h-full flex items-center justify-center text-xl">${(user.spiritual_name || user.first_name || '?')[0]}</div>`
                                }
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="font-bold">${user.spiritual_name || user.first_name + ' ' + (user.last_name || '')}</div>
                        ${user.is_superuser ? '<span class="badge badge-warning badge-sm">Superuser</span>' : ''}
                    </td>
                    <td>${user.email}</td>
                    <td>
                        <span class="badge ${user.user_type === 'staff' ? 'badge-primary' : 'badge-secondary'}">
                            ${user.user_type === 'staff' ? '–ö–æ–º–∞–Ω–¥–∞' : '–ì–æ—Å—Ç—å'}
                        </span>
                    </td>
                    <td>
                        ${getStatusBadge(user)}
                    </td>
                    <td>
                        <div class="flex flex-wrap gap-1">
                        ${user.roles.length > 0
                            ? user.roles.map(r => `<span class="badge badge-sm badge-outline">${r.roles.name_ru}</span>`).join('')
                            : '<span class="text-xs opacity-50">–ù–µ—Ç —Ä–æ–ª–µ–π</span>'
                        }
                        </div>
                    </td>
                    <td>
                        <div class="flex gap-1 flex-wrap">
                            ${user.approval_status === 'pending'
                                ? `
                                    <button class="btn btn-xs btn-success" onclick="approveUser('${user.id}')">–û–¥–æ–±—Ä–∏—Ç—å</button>
                                    <button class="btn btn-xs btn-error" onclick="rejectUser('${user.id}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                                `
                                : `<button class="btn btn-xs btn-primary" onclick="openManageModal('${user.id}')">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>`
                            }
                            ${!user.user_id && user.email
                                ? `<button class="btn btn-xs btn-outline btn-secondary" onclick="sendInvite('${user.id}', '${user.email.replace(/'/g, "\\'")}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                    </svg>
                                    –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å
                                   </button>`
                                : ''
                            }
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // –ü–æ–ª—É—á–∏—Ç—å badge —Å—Ç–∞—Ç—É—Å–∞
        function getStatusBadge(user) {
            if (!user.is_active) return '<span class="badge badge-error">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>';
            if (user.approval_status === 'pending') return '<span class="badge badge-warning">–û–∂–∏–¥–∞–µ—Ç</span>';
            if (user.approval_status === 'approved') return '<span class="badge badge-success">–û–¥–æ–±—Ä–µ–Ω</span>';
            if (user.approval_status === 'rejected') return '<span class="badge badge-error">–û—Ç–∫–ª–æ–Ω—ë–Ω</span>';
            if (user.approval_status === 'blocked') return '<span class="badge badge-error">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>';
            return '<span class="badge">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>';
        }

        // –û–¥–æ–±—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function approveUser(userId) {
            currentUserId = userId;
            approvalAction = 'approve';
            const user = allUsers.find(u => u.id === userId);
            document.getElementById('approvalTitle').textContent = '–û–¥–æ–±—Ä–∏—Ç—å –∑–∞—è–≤–∫—É?';
            document.getElementById('approvalText').textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–¥–æ–±—Ä–∏—Ç—å –∑–∞—è–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.spiritual_name || user.first_name}?`;
            document.getElementById('approvalConfirmBtn').className = 'btn btn-success';
            document.getElementById('approvalModal').showModal();
        }

        // –û—Ç–∫–ª–æ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function rejectUser(userId) {
            currentUserId = userId;
            approvalAction = 'reject';
            const user = allUsers.find(u => u.id === userId);
            document.getElementById('approvalTitle').textContent = '–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É?';
            document.getElementById('approvalText').textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.spiritual_name || user.first_name}?`;
            document.getElementById('approvalConfirmBtn').className = 'btn btn-error';
            document.getElementById('approvalModal').showModal();
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–¥–æ–±—Ä–µ–Ω–∏–µ/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
        async function confirmApproval() {
            try {
                const newStatus = approvalAction === 'approve' ? 'approved' : 'rejected';

                const { error } = await db
                    .from('vaishnavas')
                    .update({
                        approval_status: newStatus,
                        approved_by: window.currentUser.id,
                        approved_at: new Date().toISOString()
                    })
                    .eq('id', currentUserId);

                if (error) throw error;

                // –ï—Å–ª–∏ –æ–¥–æ–±—Ä–∏–ª–∏ - –Ω–∞–∑–Ω–∞—á–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—É—é —Ä–æ–ª—å Guest –¥–ª—è –≥–æ—Å—Ç–µ–π
                if (approvalAction === 'approve') {
                    const user = allUsers.find(u => u.id === currentUserId);
                    if (user.user_type === 'guest' && user.user_id) {
                        const { data: guestRole } = await db
                            .from('roles')
                            .select('id')
                            .eq('code', 'guest')
                            .single();

                        if (guestRole) {
                            await db.from('user_roles').insert({
                                user_id: user.user_id,
                                role_id: guestRole.id,
                                is_active: true,
                                assigned_by: window.currentUser.id
                            });
                        }
                    }
                }

                closeApprovalModal();
                loadUsers({ tab: currentTab !== 'all' ? currentTab : null });
                alert(approvalAction === 'approve' ? '‚úÖ –ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞' : '‚ùå –ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
            } catch (err) {
                console.error('Approval error:', err);
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        function closeApprovalModal() {
            document.getElementById('approvalModal').close();
        }

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        async function openManageModal(userId) {
            const user = allUsers.find(u => u.id === userId);

            // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å user_id (–ø—Ä–∏–≤—è–∑–∞–Ω –∫ auth.users)
            if (!user.user_id) {
                alert('–£ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ —Å–∏—Å—Ç–µ–º–µ. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏ –∏ –ø—Ä–∞–≤–∞–º–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.');
                return;
            }

            currentUserId = user.user_id; // –°–æ—Ö—Ä–∞–Ω—è–µ–º auth.users.id, –∞ –Ω–µ vaishnava.id

            document.getElementById('modalUserName').textContent = user.spiritual_name || user.first_name;
            document.getElementById('modalUserEmail').textContent = user.email;
            document.getElementById('modalUserType').textContent = user.user_type === 'staff' ? '–ö–æ–º–∞–Ω–¥–∞' : '–ì–æ—Å—Ç—å';
            document.getElementById('modalIsActive').checked = user.is_active;
            document.getElementById('modalIsSuperuser').checked = user.is_superuser;

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –∫—Ä–æ—Å—Å-–º–æ–¥—É–ª—å–Ω—ã–µ —Ä–æ–ª–∏
            const { data: allRoles } = await db
                .from('roles')
                .select('id, code, name_ru, description_ru')
                .is('module_id', null)
                .order('sort_order');

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const { data: userRoles } = await db
                .from('user_roles')
                .select('role_id')
                .eq('user_id', user.user_id)
                .eq('is_active', true);

            const userRoleIds = userRoles ? userRoles.map(r => r.role_id) : [];

            // –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ä–æ–ª–∏
            const rolesContainer = document.getElementById('rolesContainer');
            rolesContainer.innerHTML = allRoles.map(role => `
                <label class="label cursor-pointer justify-start gap-3 py-2 px-3 rounded-lg hover:bg-base-200 transition-colors">
                    <input type="checkbox" class="checkbox checkbox-sm checkbox-primary"
                           data-role-id="${role.id}"
                           ${userRoleIds.includes(role.id) ? 'checked' : ''}>
                    <div class="flex-1">
                        <div class="font-medium">${role.name_ru}</div>
                        <div class="text-xs opacity-60">${role.description_ru || ''}</div>
                    </div>
                </label>
            `).join('');

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞
            const { data: customPerms } = await db
                .from('user_permissions')
                .select(`
                    is_granted,
                    permissions!inner (
                        code,
                        name_ru
                    )
                `)
                .eq('user_id', user.user_id);

            const customPermsContainer = document.getElementById('customPermissionsContainer');
            if (customPerms && customPerms.length > 0) {
                customPermsContainer.innerHTML = '<div class="space-y-1">' + customPerms.map(p => `
                    <div class="flex items-center gap-2">
                        <span class="badge ${p.is_granted ? 'badge-success' : 'badge-error'} badge-sm">
                            ${p.is_granted ? '+' : '‚àí'}
                        </span>
                        <span class="text-sm">${p.permissions.name_ru}</span>
                    </div>
                `).join('') + '</div>';
            } else {
                customPermsContainer.innerHTML = '<p class="text-sm opacity-50">–ù–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –ø—Ä–∞–≤</p>';
            }

            document.getElementById('manageUserModal').showModal();
        }

        function closeManageModal() {
            document.getElementById('manageUserModal').close();
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function saveUserChanges() {
            try {
                const user = allUsers.find(u => u.user_id === currentUserId);
                if (!user) {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }

                const isSuperuser = document.getElementById('modalIsSuperuser').checked;

                // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ vaishnavas
                await db
                    .from('vaishnavas')
                    .update({ is_superuser: isSuperuser })
                    .eq('id', user.id);

                // –û–±–Ω–æ–≤–∏—Ç—å —Ä–æ–ª–∏
                const checkedRoles = Array.from(document.querySelectorAll('#rolesContainer input:checked'))
                    .map(cb => cb.dataset.roleId);

                // –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ä–æ–ª–∏
                await db
                    .from('user_roles')
                    .update({ is_active: false })
                    .eq('user_id', user.user_id);

                // –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–æ–ª–∏
                for (let roleId of checkedRoles) {
                    await db
                        .from('user_roles')
                        .upsert({
                            user_id: user.user_id,
                            role_id: roleId,
                            is_active: true,
                            assigned_by: window.currentUser.id,
                            assigned_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id,role_id'
                        });
                }

                closeManageModal();
                loadUsers({ tab: currentTab !== 'all' ? currentTab : null });
                alert('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            } catch (err) {
                console.error('Save error:', err);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + err.message);
            }
        }

        // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function blockUser() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;

            try {
                const user = allUsers.find(u => u.user_id === currentUserId);
                if (!user) {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }

                await db
                    .from('vaishnavas')
                    .update({
                        approval_status: 'blocked',
                        is_active: false
                    })
                    .eq('id', user.id);

                closeManageModal();
                loadUsers({ tab: currentTab !== 'all' ? currentTab : null });
                alert('üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
            } catch (err) {
                console.error('Block error:', err);
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        async function openPermissionsModal() {
            if (!currentUserId) return;

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ (–∫—Ä–æ—Å—Å-–º–æ–¥—É–ª—å–Ω—ã–µ)
            const { data: allPerms, error: permsError } = await db
                .from('permissions')
                .select('id, code, name_ru, category')
                .is('module_id', null)
                .order('category, name_ru');

            if (permsError || !allPerms || allPerms.length === 0) {
                console.error('Permissions error:', permsError);
                alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–∞–≤');
                return;
            }

            console.log('Loaded permissions:', allPerms.length);

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ä–æ–ª–µ–π
            const { data: userRoles } = await db
                .from('user_roles')
                .select('role_id')
                .eq('user_id', currentUserId)
                .eq('is_active', true);

            const roleIds = userRoles ? userRoles.map(r => r.role_id) : [];

            let rolePermissionCodes = [];
            if (roleIds.length > 0) {
                const { data: rolePerms } = await db
                    .from('role_permissions')
                    .select('permissions!inner(code)')
                    .in('role_id', roleIds);
                rolePermissionCodes = rolePerms ? rolePerms.map(rp => rp.permissions.code) : [];
            }

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞
            const { data: customPerms } = await db
                .from('user_permissions')
                .select('permissions!inner(code), is_granted')
                .eq('user_id', currentUserId);

            const customPermMap = {};
            if (customPerms) {
                customPerms.forEach(cp => {
                    customPermMap[cp.permissions.code] = cp.is_granted;
                });
            }

            const permissionsList = document.getElementById('permissionsList');

            const renderPermissions = (perms) => {
                // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                const byCategory = {};
                perms.forEach(p => {
                    if (!byCategory[p.category]) byCategory[p.category] = [];
                    byCategory[p.category].push(p);
                });

                permissionsList.innerHTML = Object.entries(byCategory).map(([cat, perms]) => `
                    <div class="mb-4">
                        <div class="text-sm font-bold opacity-60 mb-2">${cat || '–î—Ä—É–≥–æ–µ'}</div>
                        ${perms.map(p => {
                            const hasFromRole = rolePermissionCodes.includes(p.code);
                            const hasCustom = p.code in customPermMap;
                            const isGranted = hasCustom ? customPermMap[p.code] : hasFromRole;
                            const isCustomOverride = hasCustom;

                            return `
                            <label class="label cursor-pointer justify-start gap-3 py-2">
                                <input type="checkbox"
                                       class="checkbox checkbox-sm ${isCustomOverride ? 'checkbox-primary' : ''}"
                                       data-perm-id="${p.id}"
                                       data-perm-code="${p.code}"
                                       data-perm-name="${p.name_ru.replace(/"/g, '&quot;')}"
                                       ${isGranted ? 'checked' : ''}
                                       onchange="togglePermission(this)">
                                <div class="flex-1">
                                    <div class="font-medium">${p.name_ru}</div>
                                    <div class="text-xs opacity-60">${p.code}${hasFromRole && !isCustomOverride ? ' (–∏–∑ —Ä–æ–ª–∏)' : ''}${isCustomOverride ? ' (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ)' : ''}</div>
                                </div>
                            </label>`;
                        }).join('')}
                    </div>
                `).join('');
            };

            renderPermissions(allPerms);

            // –ü–æ–∏—Å–∫
            document.getElementById('permissionSearch').value = '';
            document.getElementById('permissionSearch').oninput = (e) => {
                const query = e.target.value.toLowerCase();
                const filtered = allPerms.filter(p =>
                    p.name_ru.toLowerCase().includes(query) ||
                    p.code.toLowerCase().includes(query)
                );
                renderPermissions(filtered);
            };

            document.getElementById('permissionSelectModal').showModal();
        }

        // –ó–∞–º–µ–Ω—è–µ–º –æ–±–µ —Å—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ –æ–¥–Ω—É
        function openAddPermissionModal() {
            openPermissionsModal();
        }

        function openRevokePermissionModal() {
            openPermissionsModal();
        }

        async function togglePermission(checkbox) {
            const permId = checkbox.dataset.permId;
            const permCode = checkbox.dataset.permCode;
            const permName = checkbox.dataset.permName;
            const isGranted = checkbox.checked;

            console.log('togglePermission:', { permId, permCode, permName, isGranted, currentUserId });

            try {
                // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å upsert –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤—Å—Ç–∞–≤–∫–∏ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                const { error } = await db.from('user_permissions').upsert({
                    user_id: currentUserId,
                    permission_id: permId,
                    is_granted: isGranted,
                    granted_by: window.currentUser.id,
                    granted_at: new Date().toISOString()
                }, {
                    onConflict: 'user_id,permission_id'
                });

                if (error) {
                    console.error('Upsert error:', error);
                    throw error;
                }

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ–∫–±–æ–∫—Å —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∏–ª—å
                checkbox.classList.toggle('checkbox-primary', true);

                Layout.showNotification(
                    `–ü—Ä–∞–≤–æ "${permName}" ${isGranted ? '–¥–æ–±–∞–≤–ª–µ–Ω–æ' : '—É–±—Ä–∞–Ω–æ'}`,
                    'success'
                );

            } catch (err) {
                // –û—Ç–∫–∞—Ç–∏—Ç—å —á–µ–∫–±–æ–∫—Å –ø—Ä–∏ –æ—à–∏–±–∫–µ
                checkbox.checked = !isGranted;
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ–¥–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        async function sendInvite(vaishnavId, email) {
            const user = allUsers.find(u => u.id === vaishnavId);
            const userName = user?.spiritual_name || user?.first_name || email;

            if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${userName} (${email})?`)) {
                return;
            }

            try {
                const { data: { session } } = await db.auth.getSession();
                if (!session) {
                    alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    return;
                }

                const response = await fetch(
                    `${window.CONFIG.SUPABASE_URL}/functions/v1/send-invite`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session.access_token}`
                        },
                        body: JSON.stringify({ email, vaishnavId })
                    }
                );

                const result = await response.json();

                if (!response.ok) {
                    if (result.alreadyHasAccount) {
                        alert('–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç');
                        loadUsers({ tab: currentTab !== 'all' ? currentTab : null });
                    } else {
                        throw new Error(result.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                    }
                    return;
                }

                Layout.showNotification(`–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ ${email}`, 'success');

            } catch (err) {
                console.error('Send invite error:', err);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: ' + err.message);
            }
        }

        // –ú–∞—Å—Å–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
        async function sendBulkInvites() {
            const usersWithoutAccount = allUsers.filter(u => !u.user_id && u.email);

            if (usersWithoutAccount.length === 0) {
                alert('–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –∞–∫–∫–∞—É–Ω—Ç–∞');
                return;
            }

            if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è ${usersWithoutAccount.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?\n\n–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.`)) {
                return;
            }

            try {
                const { data: { session } } = await db.auth.getSession();
                if (!session) {
                    alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    return;
                }

                let sent = 0;
                let errors = 0;
                const errorList = [];

                for (const user of usersWithoutAccount) {
                    try {
                        const response = await fetch(
                            `${window.CONFIG.SUPABASE_URL}/functions/v1/send-invite`,
                            {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${session.access_token}`
                                },
                                body: JSON.stringify({ email: user.email, vaishnavId: user.id })
                            }
                        );

                        const result = await response.json();

                        if (response.ok) {
                            sent++;
                        } else {
                            errors++;
                            errorList.push(`${user.email}: ${result.error}`);
                        }

                        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                        await new Promise(r => setTimeout(r, 200));

                    } catch (err) {
                        errors++;
                        errorList.push(`${user.email}: ${err.message}`);
                    }
                }

                let message = `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${sent}`;
                if (errors > 0) {
                    message += `\n–û—à–∏–±–æ–∫: ${errors}`;
                    console.error('Bulk invite errors:', errorList);
                }

                alert(message);
                Layout.showNotification(`–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã: ${sent}`, sent > 0 ? 'success' : 'warning');

            } catch (err) {
                console.error('Bulk invite error:', err);
                alert('–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + err.message);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('DOMContentLoaded', async () => {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è layout (—Ö–µ–¥–µ—Ä, —Ñ—É—Ç–µ—Ä, –ø–µ—Ä–µ–≤–æ–¥—ã)
            await Layout.init({ module: 'housing', menuId: 'settings', itemId: 'user_management' });

            // –ü–æ–¥–æ–∂–¥–∞—Ç—å –ø–æ–∫–∞ auth-check.js —Å–æ–∑–¥–∞—Å—Ç hasPermission
            while (typeof window.hasPermission !== 'function') {
                await new Promise(resolve => setTimeout(resolve, 50));
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
            if (!window.hasPermission('manage_users') && !window.currentUser?.is_superuser) {
                alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ');
                window.location.href = '/';
                return;
            }

            // –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞: —Ç–æ–ª—å–∫–æ —Å—á—ë—Ç—á–∏–∫–∏ + placeholder
            loadCounts();
            showPlaceholder();
        });
    </script>
</body>

</html>
