<!DOCTYPE html>
<html lang="ru" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ ‚Äî –®–†–°–ö</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-base-200">
    <div id="header"></div>

    <div class="container mx-auto p-4">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h1>
        </div>

        <!-- –¢–∞–±—ã -->
        <div role="tablist" class="tabs tabs-boxed mb-6">
            <a role="tab" class="tab tab-active" data-tab="all" onclick="switchTab('all')">
                –í—Å–µ (<span id="countAll">0</span>)
            </a>
            <a role="tab" class="tab" data-tab="pending" onclick="switchTab('pending')">
                –û–∂–∏–¥–∞—é—Ç (<span id="countPending">0</span>)
            </a>
            <a role="tab" class="tab" data-tab="staff" onclick="switchTab('staff')">
                –ö–æ–º–∞–Ω–¥–∞ (<span id="countStaff">0</span>)
            </a>
            <a role="tab" class="tab" data-tab="guest" onclick="switchTab('guest')">
                –ì–æ—Å—Ç–∏ (<span id="countGuest">0</span>)
            </a>
            <a role="tab" class="tab" data-tab="blocked" onclick="switchTab('blocked')">
                –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (<span id="countBlocked">0</span>)
            </a>
        </div>

        <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
        <div class="mb-4 flex gap-2">
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email..."
                   class="input input-bordered flex-1" onkeyup="filterUsers()">
            <select id="moduleFilter" class="select select-bordered" onchange="filterUsers()">
                <option value="">–í—Å–µ –º–æ–¥—É–ª–∏</option>
                <option value="housing">Housing</option>
                <option value="kitchen">Kitchen</option>
            </select>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div class="overflow-x-auto bg-base-100 rounded-lg shadow">
            <table class="table table-zebra">
                <thead>
                    <tr>
                        <th>–§–æ—Ç–æ</th>
                        <th>–ò–º—è</th>
                        <th>Email</th>
                        <th>–¢–∏–ø</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–†–æ–ª–∏</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="7" class="text-center py-8">
                            <span class="loading loading-spinner loading-lg"></span>
                            <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º -->
    <dialog id="manageUserModal" class="modal">
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-lg mb-4">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º: <span id="modalUserName"></span></h3>

            <div class="space-y-4">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div><strong>Email:</strong> <span id="modalUserEmail"></span></div>
                    <div><strong>–¢–∏–ø:</strong> <span id="modalUserType"></span></div>
                </div>

                <!-- –°—Ç–∞—Ç—É—Å -->
                <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-2">
                        <input type="checkbox" id="modalIsActive" class="checkbox checkbox-sm" disabled>
                        <span class="label-text">–ê–∫—Ç–∏–≤–µ–Ω</span>
                    </label>
                    <label class="label cursor-pointer justify-start gap-2">
                        <input type="checkbox" id="modalIsSuperuser" class="checkbox checkbox-sm">
                        <span class="label-text">–°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                    </label>
                </div>

                <div class="divider">–†–æ–ª–∏ Housing</div>

                <!-- –†–æ–ª–∏ -->
                <div id="rolesContainer" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- –†–æ–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                <div class="divider">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞</div>

                <!-- –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ -->
                <div class="flex gap-2">
                    <button class="btn btn-sm btn-outline" onclick="openAddPermissionModal()">
                        + –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–æ
                    </button>
                    <button class="btn btn-sm btn-outline btn-error" onclick="openRevokePermissionModal()">
                        ‚àí –£–±—Ä–∞—Ç—å –ø—Ä–∞–≤–æ
                    </button>
                </div>

                <div id="customPermissionsContainer" class="text-sm">
                    <!-- –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>

            <div class="modal-action">
                <button class="btn btn-error" onclick="blockUser()">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn" onclick="closeManageModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="saveUserChanges()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–∞–≤–∞ -->
    <dialog id="permissionSelectModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4" id="permissionModalTitle">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–æ</h3>

            <div class="form-control">
                <input type="text" id="permissionSearch" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–∞–≤–∞..." class="input input-bordered mb-2">
            </div>

            <div class="max-h-96 overflow-y-auto">
                <div id="permissionsList"></div>
            </div>

            <div class="modal-action">
                <button class="btn" onclick="document.getElementById('permissionSelectModal').close()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è -->
    <dialog id="approvalModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4" id="approvalTitle"></h3>
            <p id="approvalText"></p>
            <div class="modal-action">
                <button class="btn" onclick="closeApprovalModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" id="approvalConfirmBtn" onclick="confirmApproval()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </dialog>

    <script src="../js/config.js"></script>
    <script src="../js/auth-check.js?v=2"></script>
    <script src="../js/cache.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/layout.js"></script>
    <script>
        const db = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

        let allUsers = [];
        let currentTab = 'all';
        let currentUserId = null;
        let approvalAction = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function loadUsers() {
            try {
                const { data: users, error } = await db
                    .from('vaishnavas')
                    .select(`
                        id,
                        user_id,
                        email,
                        first_name,
                        last_name,
                        spiritual_name,
                        photo_url,
                        user_type,
                        approval_status,
                        is_superuser,
                        is_active,
                        is_deleted
                    `)
                    .eq('is_deleted', false)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–æ–ª–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                for (let user of users) {
                    if (user.user_id) {
                        const { data: roles } = await db
                            .from('user_roles')
                            .select(`
                                roles!inner (
                                    name_ru,
                                    code,
                                    module_id
                                )
                            `)
                            .eq('user_id', user.user_id)
                            .eq('is_active', true);

                        user.roles = roles || [];
                    } else {
                        user.roles = [];
                    }
                }

                allUsers = users;
                updateCounts();
                renderUsers();
            } catch (err) {
                console.error('Load users error:', err);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + err.message);
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫–∏
        function updateCounts() {
            document.getElementById('countAll').textContent = allUsers.length;
            document.getElementById('countPending').textContent = allUsers.filter(u => u.approval_status === 'pending').length;
            document.getElementById('countStaff').textContent = allUsers.filter(u => u.user_type === 'staff').length;
            document.getElementById('countGuest').textContent = allUsers.filter(u => u.user_type === 'guest').length;
            document.getElementById('countBlocked').textContent = allUsers.filter(u => u.approval_status === 'blocked' || !u.is_active).length;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('tab-active');
            renderUsers();
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function filterUsers() {
            renderUsers();
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
        function renderUsers() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const moduleFilter = document.getElementById('moduleFilter').value;

            let filtered = allUsers;

            // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∞–±—É
            if (currentTab === 'pending') {
                filtered = filtered.filter(u => u.approval_status === 'pending');
            } else if (currentTab === 'staff') {
                filtered = filtered.filter(u => u.user_type === 'staff');
            } else if (currentTab === 'guest') {
                filtered = filtered.filter(u => u.user_type === 'guest');
            } else if (currentTab === 'blocked') {
                filtered = filtered.filter(u => u.approval_status === 'blocked' || !u.is_active);
            }

            // –ü–æ–∏—Å–∫
            if (searchText) {
                filtered = filtered.filter(u =>
                    (u.spiritual_name?.toLowerCase().includes(searchText)) ||
                    (u.first_name?.toLowerCase().includes(searchText)) ||
                    (u.last_name?.toLowerCase().includes(searchText)) ||
                    (u.email?.toLowerCase().includes(searchText))
                );
            }

            // –§–∏–ª—å—Ç—Ä –ø–æ –º–æ–¥—É–ª—é
            if (moduleFilter) {
                filtered = filtered.filter(u =>
                    u.roles.some(r => r.roles.module_id === moduleFilter)
                );
            }

            const tbody = document.getElementById('usersTableBody');

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(user => `
                <tr>
                    <td>
                        <div class="avatar">
                            <div class="w-10 h-10 rounded-full">
                                ${user.photo_url
                                    ? `<img src="${user.photo_url}" alt="${user.spiritual_name || user.first_name}">`
                                    : `<div class="bg-primary text-primary-content w-full h-full flex items-center justify-center text-xl">${(user.spiritual_name || user.first_name || '?')[0]}</div>`
                                }
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="font-bold">${user.spiritual_name || user.first_name + ' ' + (user.last_name || '')}</div>
                        ${user.is_superuser ? '<span class="badge badge-warning badge-sm">Superuser</span>' : ''}
                    </td>
                    <td>${user.email}</td>
                    <td>
                        <span class="badge ${user.user_type === 'staff' ? 'badge-primary' : 'badge-secondary'}">
                            ${user.user_type === 'staff' ? '–ö–æ–º–∞–Ω–¥–∞' : '–ì–æ—Å—Ç—å'}
                        </span>
                    </td>
                    <td>
                        ${getStatusBadge(user)}
                    </td>
                    <td>
                        ${user.roles.length > 0
                            ? user.roles.map(r => `<span class="badge badge-sm badge-outline">${r.roles.name_ru}</span>`).join(' ')
                            : '<span class="text-xs opacity-50">–ù–µ—Ç —Ä–æ–ª–µ–π</span>'
                        }
                    </td>
                    <td>
                        <div class="flex gap-1">
                            ${user.approval_status === 'pending'
                                ? `
                                    <button class="btn btn-xs btn-success" onclick="approveUser('${user.id}')">–û–¥–æ–±—Ä–∏—Ç—å</button>
                                    <button class="btn btn-xs btn-error" onclick="rejectUser('${user.id}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                                `
                                : `<button class="btn btn-xs btn-primary" onclick="openManageModal('${user.id}')">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>`
                            }
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // –ü–æ–ª—É—á–∏—Ç—å badge —Å—Ç–∞—Ç—É—Å–∞
        function getStatusBadge(user) {
            if (!user.is_active) return '<span class="badge badge-error">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>';
            if (user.approval_status === 'pending') return '<span class="badge badge-warning">–û–∂–∏–¥–∞–µ—Ç</span>';
            if (user.approval_status === 'approved') return '<span class="badge badge-success">–û–¥–æ–±—Ä–µ–Ω</span>';
            if (user.approval_status === 'rejected') return '<span class="badge badge-error">–û—Ç–∫–ª–æ–Ω—ë–Ω</span>';
            if (user.approval_status === 'blocked') return '<span class="badge badge-error">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>';
            return '<span class="badge">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>';
        }

        // –û–¥–æ–±—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function approveUser(userId) {
            currentUserId = userId;
            approvalAction = 'approve';
            const user = allUsers.find(u => u.id === userId);
            document.getElementById('approvalTitle').textContent = '–û–¥–æ–±—Ä–∏—Ç—å –∑–∞—è–≤–∫—É?';
            document.getElementById('approvalText').textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–¥–æ–±—Ä–∏—Ç—å –∑–∞—è–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.spiritual_name || user.first_name}?`;
            document.getElementById('approvalConfirmBtn').className = 'btn btn-success';
            document.getElementById('approvalModal').showModal();
        }

        // –û—Ç–∫–ª–æ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function rejectUser(userId) {
            currentUserId = userId;
            approvalAction = 'reject';
            const user = allUsers.find(u => u.id === userId);
            document.getElementById('approvalTitle').textContent = '–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É?';
            document.getElementById('approvalText').textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.spiritual_name || user.first_name}?`;
            document.getElementById('approvalConfirmBtn').className = 'btn btn-error';
            document.getElementById('approvalModal').showModal();
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–¥–æ–±—Ä–µ–Ω–∏–µ/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
        async function confirmApproval() {
            try {
                const newStatus = approvalAction === 'approve' ? 'approved' : 'rejected';

                const { error } = await db
                    .from('vaishnavas')
                    .update({
                        approval_status: newStatus,
                        approved_by: window.currentUser.id,
                        approved_at: new Date().toISOString()
                    })
                    .eq('id', currentUserId);

                if (error) throw error;

                // –ï—Å–ª–∏ –æ–¥–æ–±—Ä–∏–ª–∏ - –Ω–∞–∑–Ω–∞—á–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—É—é —Ä–æ–ª—å Guest –¥–ª—è –≥–æ—Å—Ç–µ–π
                if (approvalAction === 'approve') {
                    const user = allUsers.find(u => u.id === currentUserId);
                    if (user.user_type === 'guest' && user.user_id) {
                        const { data: guestRole } = await db
                            .from('roles')
                            .select('id')
                            .eq('code', 'guest')
                            .single();

                        if (guestRole) {
                            await db.from('user_roles').insert({
                                user_id: user.user_id,
                                role_id: guestRole.id,
                                is_active: true,
                                assigned_by: window.currentUser.id
                            });
                        }
                    }
                }

                closeApprovalModal();
                loadUsers();
                alert(approvalAction === 'approve' ? '‚úÖ –ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞' : '‚ùå –ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
            } catch (err) {
                console.error('Approval error:', err);
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        function closeApprovalModal() {
            document.getElementById('approvalModal').close();
        }

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        async function openManageModal(userId) {
            const user = allUsers.find(u => u.id === userId);

            // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å user_id (–ø—Ä–∏–≤—è–∑–∞–Ω –∫ auth.users)
            if (!user.user_id) {
                alert('–£ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ —Å–∏—Å—Ç–µ–º–µ. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏ –∏ –ø—Ä–∞–≤–∞–º–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.');
                return;
            }

            currentUserId = user.user_id; // –°–æ—Ö—Ä–∞–Ω—è–µ–º auth.users.id, –∞ –Ω–µ vaishnava.id

            document.getElementById('modalUserName').textContent = user.spiritual_name || user.first_name;
            document.getElementById('modalUserEmail').textContent = user.email;
            document.getElementById('modalUserType').textContent = user.user_type === 'staff' ? '–ö–æ–º–∞–Ω–¥–∞' : '–ì–æ—Å—Ç—å';
            document.getElementById('modalIsActive').checked = user.is_active;
            document.getElementById('modalIsSuperuser').checked = user.is_superuser;

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Ä–æ–ª–∏ Housing
            const { data: allRoles } = await db
                .from('roles')
                .select('id, code, name_ru, description_ru')
                .eq('module_id', (await db.from('modules').select('id').eq('code', 'housing').single()).data.id)
                .order('name_ru');

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const { data: userRoles } = await db
                .from('user_roles')
                .select('role_id')
                .eq('user_id', user.user_id)
                .eq('is_active', true);

            const userRoleIds = userRoles ? userRoles.map(r => r.role_id) : [];

            // –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ä–æ–ª–∏
            const rolesContainer = document.getElementById('rolesContainer');
            rolesContainer.innerHTML = allRoles.map(role => `
                <label class="label cursor-pointer justify-start gap-2">
                    <input type="checkbox" class="checkbox checkbox-sm"
                           data-role-id="${role.id}"
                           ${userRoleIds.includes(role.id) ? 'checked' : ''}>
                    <div>
                        <div class="font-medium">${role.name_ru}</div>
                        <div class="text-xs opacity-60">${role.description_ru}</div>
                    </div>
                </label>
            `).join('');

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞
            const { data: customPerms } = await db
                .from('user_permissions')
                .select(`
                    is_granted,
                    permissions!inner (
                        code,
                        name_ru
                    )
                `)
                .eq('user_id', user.user_id);

            const customPermsContainer = document.getElementById('customPermissionsContainer');
            if (customPerms && customPerms.length > 0) {
                customPermsContainer.innerHTML = '<div class="space-y-1">' + customPerms.map(p => `
                    <div class="flex items-center gap-2">
                        <span class="badge ${p.is_granted ? 'badge-success' : 'badge-error'} badge-sm">
                            ${p.is_granted ? '+' : '‚àí'}
                        </span>
                        <span class="text-sm">${p.permissions.name_ru}</span>
                    </div>
                `).join('') + '</div>';
            } else {
                customPermsContainer.innerHTML = '<p class="text-sm opacity-50">–ù–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –ø—Ä–∞–≤</p>';
            }

            document.getElementById('manageUserModal').showModal();
        }

        function closeManageModal() {
            document.getElementById('manageUserModal').close();
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function saveUserChanges() {
            try {
                const user = allUsers.find(u => u.id === currentUserId);
                const isSuperuser = document.getElementById('modalIsSuperuser').checked;

                // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await db
                    .from('vaishnavas')
                    .update({ is_superuser: isSuperuser })
                    .eq('id', currentUserId);

                // –û–±–Ω–æ–≤–∏—Ç—å —Ä–æ–ª–∏
                const checkedRoles = Array.from(document.querySelectorAll('#rolesContainer input:checked'))
                    .map(cb => cb.dataset.roleId);

                // –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ä–æ–ª–∏
                await db
                    .from('user_roles')
                    .update({ is_active: false })
                    .eq('user_id', user.user_id);

                // –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–æ–ª–∏
                for (let roleId of checkedRoles) {
                    await db
                        .from('user_roles')
                        .upsert({
                            user_id: user.user_id,
                            role_id: roleId,
                            is_active: true,
                            assigned_by: window.currentUser.id,
                            assigned_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id,role_id'
                        });
                }

                closeManageModal();
                loadUsers();
                alert('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            } catch (err) {
                console.error('Save error:', err);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + err.message);
            }
        }

        // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function blockUser() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;

            try {
                await db
                    .from('vaishnavas')
                    .update({
                        approval_status: 'blocked',
                        is_active: false
                    })
                    .eq('id', currentUserId);

                closeManageModal();
                loadUsers();
                alert('üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
            } catch (err) {
                console.error('Block error:', err);
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        async function openAddPermissionModal() {
            if (!currentUserId) return;

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –ø—Ä–∞–≤–∞ Housing
            const { data: allPerms } = await db
                .from('permissions')
                .select('id, code, name_ru, category')
                .eq('module_id', (await db.from('modules').select('id').eq('code', 'housing').single()).data.id)
                .order('category, name_ru');

            if (!allPerms || allPerms.length === 0) {
                alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–∞–≤');
                return;
            }

            // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            document.getElementById('permissionModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–æ';
            const permissionsList = document.getElementById('permissionsList');

            const renderPermissions = (perms) => {
                // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                const byCategory = {};
                perms.forEach(p => {
                    if (!byCategory[p.category]) byCategory[p.category] = [];
                    byCategory[p.category].push(p);
                });

                permissionsList.innerHTML = Object.entries(byCategory).map(([cat, perms]) => `
                    <div class="mb-4">
                        <div class="text-sm font-bold opacity-60 mb-1">${cat || '–î—Ä—É–≥–æ–µ'}</div>
                        ${perms.map(p => `
                            <div class="p-2 hover:bg-base-200 cursor-pointer rounded" onclick="addPermission('${p.id}', '${p.name_ru.replace(/'/g, "\\'")}')">
                                <div class="font-medium">${p.name_ru}</div>
                                <div class="text-xs opacity-60">${p.code}</div>
                            </div>
                        `).join('')}
                    </div>
                `).join('');
            };

            renderPermissions(allPerms);

            // –ü–æ–∏—Å–∫
            document.getElementById('permissionSearch').oninput = (e) => {
                const query = e.target.value.toLowerCase();
                const filtered = allPerms.filter(p =>
                    p.name_ru.toLowerCase().includes(query) ||
                    p.code.toLowerCase().includes(query)
                );
                renderPermissions(filtered);
            };

            document.getElementById('permissionSelectModal').showModal();
        }

        async function addPermission(permId, permName) {
            try {
                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–µ –ø—Ä–∞–≤–æ
                const { data: existing } = await db
                    .from('user_permissions')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .eq('permission_id', permId)
                    .maybeSingle();

                if (existing) {
                    // –û–±–Ω–æ–≤–∏—Ç—å is_granted –Ω–∞ true
                    await db.from('user_permissions')
                        .update({ is_granted: true })
                        .eq('user_id', currentUserId)
                        .eq('permission_id', permId);
                } else {
                    // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–∞–≤–æ
                    await db.from('user_permissions').insert({
                        user_id: currentUserId,
                        permission_id: permId,
                        is_granted: true,
                        granted_by: window.currentUser.id,
                        granted_at: new Date().toISOString()
                    });
                }

                document.getElementById('permissionSelectModal').close();
                Layout.showNotification(`–ü—Ä–∞–≤–æ "${permName}" –¥–æ–±–∞–≤–ª–µ–Ω–æ`, 'success');

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const user = allUsers.find(u => u.user_id === currentUserId);
                if (user) openManageModal(user.id);
            } catch (err) {
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        async function openRevokePermissionModal() {
            if (!currentUserId) return;

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –ø—Ä–∞–≤–∞ Housing
            const { data: allPerms } = await db
                .from('permissions')
                .select('id, code, name_ru, category')
                .eq('module_id', (await db.from('modules').select('id').eq('code', 'housing').single()).data.id)
                .order('category, name_ru');

            if (!allPerms || allPerms.length === 0) {
                alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–∞–≤');
                return;
            }

            // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            document.getElementById('permissionModalTitle').textContent = '–£–±—Ä–∞—Ç—å –ø—Ä–∞–≤–æ';
            const permissionsList = document.getElementById('permissionsList');

            const renderPermissions = (perms) => {
                // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                const byCategory = {};
                perms.forEach(p => {
                    if (!byCategory[p.category]) byCategory[p.category] = [];
                    byCategory[p.category].push(p);
                });

                permissionsList.innerHTML = Object.entries(byCategory).map(([cat, perms]) => `
                    <div class="mb-4">
                        <div class="text-sm font-bold opacity-60 mb-1">${cat || '–î—Ä—É–≥–æ–µ'}</div>
                        ${perms.map(p => `
                            <div class="p-2 hover:bg-base-200 cursor-pointer rounded" onclick="revokePermission('${p.id}', '${p.name_ru.replace(/'/g, "\\'")}')">
                                <div class="font-medium">${p.name_ru}</div>
                                <div class="text-xs opacity-60">${p.code}</div>
                            </div>
                        `).join('')}
                    </div>
                `).join('');
            };

            renderPermissions(allPerms);

            // –ü–æ–∏—Å–∫
            document.getElementById('permissionSearch').oninput = (e) => {
                const query = e.target.value.toLowerCase();
                const filtered = allPerms.filter(p =>
                    p.name_ru.toLowerCase().includes(query) ||
                    p.code.toLowerCase().includes(query)
                );
                renderPermissions(filtered);
            };

            document.getElementById('permissionSelectModal').showModal();
        }

        async function revokePermission(permId, permName) {
            try {
                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–µ –ø—Ä–∞–≤–æ
                const { data: existing } = await db
                    .from('user_permissions')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .eq('permission_id', permId)
                    .maybeSingle();

                if (existing) {
                    // –û–±–Ω–æ–≤–∏—Ç—å is_granted –Ω–∞ false
                    await db.from('user_permissions')
                        .update({ is_granted: false })
                        .eq('user_id', currentUserId)
                        .eq('permission_id', permId);
                } else {
                    // –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–æ —Å is_granted = false
                    await db.from('user_permissions').insert({
                        user_id: currentUserId,
                        permission_id: permId,
                        is_granted: false,
                        granted_by: window.currentUser.id,
                        granted_at: new Date().toISOString()
                    });
                }

                document.getElementById('permissionSelectModal').close();
                Layout.showNotification(`–ü—Ä–∞–≤–æ "${permName}" —É–±—Ä–∞–Ω–æ`, 'success');

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const user = allUsers.find(u => u.user_id === currentUserId);
                if (user) openManageModal(user.id);
            } catch (err) {
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('DOMContentLoaded', async () => {
            // –ü–æ–¥–æ–∂–¥–∞—Ç—å –ø–æ–∫–∞ auth-check.js —Å–æ–∑–¥–∞—Å—Ç hasPermission
            while (typeof window.hasPermission !== 'function') {
                await new Promise(resolve => setTimeout(resolve, 50));
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
            if (!window.hasPermission('manage_users') && !window.currentUser?.is_superuser) {
                alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ');
                window.location.href = '/';
                return;
            }

            loadUsers();
        });
    </script>
</body>

</html>
