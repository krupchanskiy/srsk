<!DOCTYPE html>
<html lang="ru" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="settings_user_management_title">Управление пользователями — ШРСК</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/color-init.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
</head>

<body class="bg-base-200 min-h-screen flex flex-col">
    <div id="header-placeholder"></div>

    <main class="container mx-auto p-4 flex-1">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold" data-i18n="settings_user_management_heading">Управление пользователями</h1>
        </div>

        <!-- Табы -->
        <div role="tablist" class="tabs tabs-boxed mb-6">
            <a role="tab" class="tab tab-active" data-tab="all" onclick="switchTab('all')">
                <span data-i18n="settings_tab_all">Все</span> (<span id="countAll">0</span>)
            </a>
            <a role="tab" class="tab" data-tab="pending" onclick="switchTab('pending')">
                <span data-i18n="settings_tab_pending">Ожидают</span> (<span id="countPending">0</span>)
            </a>
            <a role="tab" class="tab" data-tab="team" onclick="switchTab('team')">
                <span data-i18n="settings_tab_team">Команда и волонтёры</span> (<span id="countTeam">0</span>)
            </a>
            <a role="tab" class="tab" data-tab="guest" onclick="switchTab('guest')">
                <span data-i18n="settings_tab_guests">Гости</span> (<span id="countGuest">0</span>)
            </a>
            <a role="tab" class="tab" data-tab="blocked" onclick="switchTab('blocked')">
                <span data-i18n="settings_tab_blocked">Заблокированные</span> (<span id="countBlocked">0</span>)
            </a>
        </div>

        <!-- Поиск и фильтры -->
        <div class="mb-4 flex flex-wrap gap-2">
            <input type="text" id="searchInput" placeholder="Поиск по имени или email..." data-i18n-placeholder="settings_search_placeholder"
                   class="input input-bordered flex-1 min-w-48" onkeyup="filterUsers()">
            <button class="btn btn-outline btn-primary" onclick="sendBulkInvites()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                <span data-i18n="settings_invite_all">Пригласить всех без аккаунта</span> (<span id="countNoAccount">0</span>)
            </button>
        </div>

        <!-- Таблица пользователей -->
        <div class="overflow-x-auto bg-base-100 rounded-lg shadow">
            <table class="table table-zebra">
                <thead>
                    <tr>
                        <th data-i18n="settings_col_photo">Фото</th>
                        <th data-i18n="settings_col_name">Имя</th>
                        <th>Email</th>
                        <th data-i18n="settings_col_type">Тип</th>
                        <th data-i18n="settings_col_status">Статус</th>
                        <th data-i18n="settings_col_roles">Роли</th>
                        <th data-i18n="settings_col_actions">Действия</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- Skeleton loader -->
                    <tr class="skeleton-row"><td><div class="skeleton w-10 h-10 rounded-full"></div></td><td><div class="skeleton h-4 w-32"></div></td><td><div class="skeleton h-4 w-40"></div></td><td><div class="skeleton h-4 w-16"></div></td><td><div class="skeleton h-4 w-20"></div></td><td><div class="skeleton h-4 w-24"></div></td><td><div class="skeleton h-8 w-24"></div></td></tr>
                    <tr class="skeleton-row"><td><div class="skeleton w-10 h-10 rounded-full"></div></td><td><div class="skeleton h-4 w-28"></div></td><td><div class="skeleton h-4 w-36"></div></td><td><div class="skeleton h-4 w-16"></div></td><td><div class="skeleton h-4 w-20"></div></td><td><div class="skeleton h-4 w-20"></div></td><td><div class="skeleton h-8 w-24"></div></td></tr>
                    <tr class="skeleton-row"><td><div class="skeleton w-10 h-10 rounded-full"></div></td><td><div class="skeleton h-4 w-36"></div></td><td><div class="skeleton h-4 w-44"></div></td><td><div class="skeleton h-4 w-16"></div></td><td><div class="skeleton h-4 w-20"></div></td><td><div class="skeleton h-4 w-28"></div></td><td><div class="skeleton h-8 w-24"></div></td></tr>
                    <tr class="skeleton-row"><td><div class="skeleton w-10 h-10 rounded-full"></div></td><td><div class="skeleton h-4 w-24"></div></td><td><div class="skeleton h-4 w-32"></div></td><td><div class="skeleton h-4 w-16"></div></td><td><div class="skeleton h-4 w-20"></div></td><td><div class="skeleton h-4 w-16"></div></td><td><div class="skeleton h-8 w-24"></div></td></tr>
                    <tr class="skeleton-row"><td><div class="skeleton w-10 h-10 rounded-full"></div></td><td><div class="skeleton h-4 w-30"></div></td><td><div class="skeleton h-4 w-38"></div></td><td><div class="skeleton h-4 w-16"></div></td><td><div class="skeleton h-4 w-20"></div></td><td><div class="skeleton h-4 w-24"></div></td><td><div class="skeleton h-8 w-24"></div></td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <!-- Модалка управления пользователем -->
    <dialog id="manageUserModal" class="modal">
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-lg mb-4"><span data-i18n="settings_manage_user">Управление пользователем</span>: <span id="modalUserName"></span></h3>

            <div class="space-y-4">
                <!-- Информация о пользователе -->
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div><strong>Email:</strong> <span id="modalUserEmail"></span></div>
                    <div><strong data-i18n="settings_col_type">Тип</strong>: <span id="modalUserType"></span></div>
                </div>

                <!-- Статус -->
                <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-2">
                        <input type="checkbox" id="modalIsActive" class="checkbox checkbox-sm" disabled>
                        <span class="label-text" data-i18n="settings_active">Активен</span>
                    </label>
                    <label class="label cursor-pointer justify-start gap-2">
                        <input type="checkbox" id="modalIsSuperuser" class="checkbox checkbox-sm">
                        <span class="label-text" data-i18n="settings_superuser">Суперпользователь</span>
                    </label>
                </div>

                <div class="divider" data-i18n="settings_roles">Роли</div>

                <!-- Роли -->
                <div id="rolesContainer" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Роли загружаются динамически -->
                </div>

                <div class="divider" data-i18n="settings_custom_permissions">Индивидуальные права</div>

                <!-- Индивидуальные права -->
                <div class="flex gap-2">
                    <button class="btn btn-sm btn-outline" onclick="openPermissionsModal()">
                        <span data-i18n="settings_configure_permissions">Настроить права</span>
                    </button>
                </div>

                <div id="customPermissionsContainer" class="text-sm">
                    <!-- Индивидуальные права загружаются динамически -->
                </div>
            </div>

            <div class="modal-action">
                <button class="btn btn-error mr-auto" onclick="blockUser()" data-i18n="settings_block">Заблокировать</button>
                <button class="btn" onclick="closeManageModal()" data-i18n="cancel">Отмена</button>
                <button class="btn btn-primary" onclick="saveUserChanges()" data-i18n="save">Сохранить</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Модалка управления индивидуальными правами -->
    <dialog id="permissionSelectModal" class="modal">
        <div class="modal-box max-w-4xl">
            <h3 class="font-bold text-lg mb-4" data-i18n="settings_user_permissions_title">Индивидуальные права пользователя</h3>

            <div class="alert alert-info mb-4">
                <div class="text-sm" data-i18n="settings_permissions_hint">
                    <strong>Серые галочки</strong> - права из ролей. <strong>Цветные галочки</strong> - индивидуальные переопределения.
                    <br>Установите галочку чтобы <strong>добавить</strong> право, снимите чтобы <strong>убрать</strong>.
                </div>
            </div>

            <div class="form-control mb-4">
                <input type="text" id="permissionSearch" placeholder="Поиск права..." data-i18n-placeholder="settings_search_permission" class="input input-bordered">
            </div>

            <div class="max-h-96 overflow-y-auto">
                <div id="permissionsList"></div>
            </div>

            <div class="modal-action">
                <button class="btn" onclick="document.getElementById('permissionSelectModal').close()" data-i18n="settings_close">Закрыть</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Модалка одобрения/отклонения -->
    <dialog id="approvalModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4" id="approvalTitle"></h3>
            <p id="approvalText"></p>
            <div class="modal-action">
                <button class="btn" onclick="closeApprovalModal()" data-i18n="cancel">Отмена</button>
                <button class="btn btn-primary" id="approvalConfirmBtn" onclick="confirmApproval()" data-i18n="settings_confirm">Подтвердить</button>
            </div>
        </div>
    </dialog>

    <script src="../js/config.js"></script>
    <script src="../js/auth-check.js?v=3"></script>
    <script src="../js/cache.js"></script>
    <script src="../js/utils.js?v=2"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/layout.js?v=5"></script>
    <script>
        const db = window.supabaseClient;

        // Экранирование HTML для защиты от XSS
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        let allUsers = [];
        let currentTab = 'all';
        let currentUserId = null;
        let approvalAction = null;
        let countsLoaded = false;
        let isLoading = false;
        let volunteerIds = new Set(); // vaishnava_id волонтёров (для фильтрации табов)

        // Загрузить ID волонтёров из residents
        async function loadVolunteerIds() {
            const { data } = await db
                .from('residents')
                .select('vaishnava_id, resident_categories!inner(name_ru)')
                .eq('resident_categories.name_ru', 'Волонтёр');
            volunteerIds = new Set(data?.map(r => r.vaishnava_id).filter(Boolean) || []);
        }

        // Загрузка только счётчиков (параллельные count-запросы, без лимита 1000)
        async function loadCounts() {
            try {
                const base = db.from('vaishnavas').select('id', { count: 'exact', head: true }).eq('is_deleted', false);
                const [allRes, pendingRes, staffRes, guestRes, blockedRes, noAccountRes] = await Promise.all([
                    db.from('vaishnavas').select('id', { count: 'exact', head: true }).eq('is_deleted', false),
                    db.from('vaishnavas').select('id', { count: 'exact', head: true }).eq('is_deleted', false).eq('approval_status', 'pending'),
                    db.from('vaishnavas').select('id', { count: 'exact', head: true }).eq('is_deleted', false).eq('user_type', 'staff'),
                    db.from('vaishnavas').select('id', { count: 'exact', head: true }).eq('is_deleted', false).eq('user_type', 'guest'),
                    db.from('vaishnavas').select('id', { count: 'exact', head: true }).eq('is_deleted', false).or('approval_status.eq.blocked,is_active.eq.false'),
                    db.from('vaishnavas').select('id', { count: 'exact', head: true }).eq('is_deleted', false).is('user_id', null).not('email', 'is', null)
                ]);

                // Волонтёры-гости = пересечение volunteerIds с guest user_type
                const guestVolCount = volunteerIds.size > 0
                    ? (await db.from('vaishnavas').select('id', { count: 'exact', head: true })
                        .eq('is_deleted', false).eq('user_type', 'guest')
                        .in('id', [...volunteerIds])).count || 0
                    : 0;

                document.getElementById('countAll').textContent = allRes.count || 0;
                document.getElementById('countPending').textContent = pendingRes.count || 0;
                document.getElementById('countTeam').textContent = (staffRes.count || 0) + guestVolCount;
                document.getElementById('countGuest').textContent = (guestRes.count || 0) - guestVolCount;
                document.getElementById('countBlocked').textContent = blockedRes.count || 0;
                document.getElementById('countNoAccount').textContent = noAccountRes.count || 0;
                countsLoaded = true;
            } catch (err) {
                console.error('Load counts error:', err);
            }
        }

        // Загрузка пользователей с фильтрацией (оптимизировано)
        async function loadUsers(filter = {}) {
            if (isLoading) return;
            isLoading = true;

            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8"><span class="loading loading-spinner loading-lg"></span></td></tr>';

            try {
                let query = db
                    .from('vaishnavas')
                    .select(`
                        id,
                        user_id,
                        email,
                        first_name,
                        last_name,
                        spiritual_name,
                        photo_url,
                        user_type,
                        approval_status,
                        is_superuser,
                        is_active
                    `)
                    .eq('is_deleted', false)
                    .order('created_at', { ascending: false });

                // Применить фильтры на уровне БД
                if (filter.tab === 'pending') {
                    query = query.eq('approval_status', 'pending');
                } else if (filter.tab === 'team') {
                    // Команда + волонтёры-гости
                    const volIds = [...volunteerIds];
                    if (volIds.length > 0) {
                        query = query.or(`user_type.eq.staff,id.in.(${volIds.join(',')})`);
                    } else {
                        query = query.eq('user_type', 'staff');
                    }
                } else if (filter.tab === 'guest') {
                    query = query.eq('user_type', 'guest');
                } else if (filter.tab === 'blocked') {
                    query = query.or('approval_status.eq.blocked,is_active.eq.false');
                }

                // Поиск
                if (filter.search && filter.search.length >= 2) {
                    const s = filter.search.toLowerCase();
                    query = query.or(`spiritual_name.ilike.%${s}%,first_name.ilike.%${s}%,last_name.ilike.%${s}%,email.ilike.%${s}%`);
                }

                // Лимит для производительности
                query = query.limit(100);

                let { data: users, error } = await query;
                if (error) throw error;

                // Загрузить роли ОДНИМ запросом (вместо N+1)
                const userIds = users.filter(u => u.user_id).map(u => u.user_id);
                let rolesMap = {};

                if (userIds.length > 0) {
                    const { data: allRoles } = await db
                        .from('user_roles')
                        .select(`
                            user_id,
                            roles!inner (name_ru, code)
                        `)
                        .in('user_id', userIds)
                        .eq('is_active', true);

                    // Группировать по user_id
                    if (allRoles) {
                        allRoles.forEach(r => {
                            if (!rolesMap[r.user_id]) rolesMap[r.user_id] = [];
                            rolesMap[r.user_id].push(r);
                        });
                    }
                }

                // Загрузить категории размещения (для отображения реального типа)
                const vaishnavasIds = users.map(u => u.id);
                let categoryMap = {};
                if (vaishnavasIds.length > 0) {
                    const { data: resData } = await db
                        .from('residents')
                        .select('vaishnava_id, resident_categories(name_ru, color)')
                        .in('vaishnava_id', vaishnavasIds)
                        .order('check_in', { ascending: false });

                    if (resData) {
                        resData.forEach(r => {
                            // Берём первую (последнюю по дате) категорию
                            if (!categoryMap[r.vaishnava_id] && r.resident_categories) {
                                categoryMap[r.vaishnava_id] = r.resident_categories;
                            }
                        });
                    }
                }

                // Присвоить роли и категории пользователям
                users.forEach(u => {
                    u.roles = rolesMap[u.user_id] || [];
                    u.category = categoryMap[u.id] || null;
                });

                // На вкладке «Гости» исключаем волонтёров (они на вкладке «Команда и волонтёры»)
                if (filter.tab === 'guest') {
                    users = users.filter(u => !volunteerIds.has(u.id));
                }

                allUsers = users;
                renderUsers();
            } catch (err) {
                console.error('Load users error:', err);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-error">Ошибка загрузки</td></tr>';
            } finally {
                isLoading = false;
            }
        }

        // Переключение табов
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('tab-active');
            document.getElementById('searchInput').value = '';

            if (tab === 'all') {
                // Показать placeholder вместо загрузки всех
                showPlaceholder();
            } else {
                loadUsers({ tab });
            }
        }

        // Показать placeholder
        function showPlaceholder() {
            allUsers = [];
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-12">
                        <div class="text-base-content/50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <p class="text-lg font-medium mb-1">Введите имя для поиска</p>
                            <p class="text-sm">или выберите категорию выше</p>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Фильтрация с debounce
        let searchTimeout;
        function filterUsers() {
            clearTimeout(searchTimeout);
            const searchText = document.getElementById('searchInput').value.trim();

            if (searchText.length === 0) {
                if (currentTab === 'all') {
                    showPlaceholder();
                } else {
                    loadUsers({ tab: currentTab });
                }
                return;
            }

            if (searchText.length < 2) return;

            searchTimeout = setTimeout(() => {
                loadUsers({ search: searchText, tab: currentTab !== 'all' ? currentTab : null });
            }, 300);
        }

        // Отрисовка таблицы (фильтрация уже на стороне БД)
        function renderUsers() {
            const tbody = document.getElementById('usersTableBody');

            if (allUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8">Пользователи не найдены</td></tr>';
                return;
            }

            tbody.innerHTML = allUsers.map(user => {
                const displayName = escapeHtml(user.spiritual_name || `${user.first_name || ''} ${user.last_name || ''}`.trim());
                const initial = (user.spiritual_name || user.first_name || '?')[0];
                const safeEmail = escapeHtml(user.email);

                return `
                <tr>
                    <td>
                        <div class="avatar">
                            <div class="w-10 h-10 rounded-full">
                                ${user.photo_url
                                    ? `<img src="${escapeHtml(user.photo_url)}" alt="${displayName}">`
                                    : `<div class="bg-primary text-primary-content w-full h-full flex items-center justify-center text-xl">${escapeHtml(initial)}</div>`
                                }
                            </div>
                        </div>
                    </td>
                    <td>
                        <a href="/vaishnavas/person.html?id=${user.id}" class="font-bold hover:underline">${displayName}</a>
                        ${user.is_superuser ? '<span class="badge badge-warning badge-sm">Superuser</span>' : ''}
                    </td>
                    <td>${safeEmail}</td>
                    <td>
                        ${getCategoryBadge(user)}
                    </td>
                    <td>
                        ${getStatusBadge(user)}
                    </td>
                    <td>
                        <div class="flex flex-wrap gap-1">
                        ${user.roles.length > 0
                            ? user.roles.map(r => `<span class="badge badge-sm badge-outline">${r.roles.name_ru}</span>`).join('')
                            : '<span class="text-xs opacity-50">Нет ролей</span>'
                        }
                        </div>
                    </td>
                    <td>
                        <div class="flex gap-1 flex-wrap">
                            ${user.approval_status === 'pending'
                                ? `
                                    <button class="btn btn-xs btn-success" onclick="approveUser('${user.id}')">Одобрить</button>
                                    <button class="btn btn-xs btn-error" onclick="rejectUser('${user.id}')">Отклонить</button>
                                `
                                : `<button class="btn btn-xs btn-primary" onclick="openManageModal('${user.id}')">Управление</button>`
                            }
                            ${!user.user_id && user.email
                                ? `<button class="btn btn-xs btn-outline btn-secondary" onclick="sendInvite('${user.id}', '${safeEmail.replace(/'/g, "\\'")}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                    </svg>
                                    Пригласить
                                   </button>`
                                : ''
                            }
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // Получить badge категории (из resident_categories или fallback на user_type)
        function getCategoryBadge(user) {
            if (user.category) {
                const color = Utils.isValidColor(user.category.color) ? user.category.color : '#6b7280';
                return `<span class="badge text-white border-0" style="background-color: ${escapeHtml(color)}">${escapeHtml(user.category.name_ru)}</span>`;
            }
            return `<span class="badge ${user.user_type === 'staff' ? 'badge-primary' : 'badge-secondary'}">
                ${user.user_type === 'staff' ? 'Команда' : 'Гость'}
            </span>`;
        }

        // Получить badge статуса
        function getStatusBadge(user) {
            if (!user.is_active) return '<span class="badge badge-error">Неактивен</span>';
            if (user.approval_status === 'pending') return '<span class="badge badge-warning">Ожидает</span>';
            if (user.approval_status === 'approved') return '<span class="badge badge-success">Одобрен</span>';
            if (user.approval_status === 'rejected') return '<span class="badge badge-error">Отклонён</span>';
            if (user.approval_status === 'blocked') return '<span class="badge badge-error">Заблокирован</span>';
            return '<span class="badge">Неизвестно</span>';
        }

        // Одобрить пользователя
        function approveUser(userId) {
            currentUserId = userId;
            approvalAction = 'approve';
            const user = allUsers.find(u => u.id === userId);
            document.getElementById('approvalTitle').textContent = 'Одобрить заявку?';
            document.getElementById('approvalText').textContent = `Вы уверены что хотите одобрить заявку пользователя ${user.spiritual_name || user.first_name}?`;
            document.getElementById('approvalConfirmBtn').className = 'btn btn-success';
            document.getElementById('approvalModal').showModal();
        }

        // Отклонить пользователя
        function rejectUser(userId) {
            currentUserId = userId;
            approvalAction = 'reject';
            const user = allUsers.find(u => u.id === userId);
            document.getElementById('approvalTitle').textContent = 'Отклонить заявку?';
            document.getElementById('approvalText').textContent = `Вы уверены что хотите отклонить заявку пользователя ${user.spiritual_name || user.first_name}?`;
            document.getElementById('approvalConfirmBtn').className = 'btn btn-error';
            document.getElementById('approvalModal').showModal();
        }

        // Подтвердить одобрение/отклонение
        async function confirmApproval() {
            try {
                const newStatus = approvalAction === 'approve' ? 'approved' : 'rejected';

                const { error } = await db
                    .from('vaishnavas')
                    .update({
                        approval_status: newStatus,
                        approved_by: window.currentUser.id,
                        approved_at: new Date().toISOString()
                    })
                    .eq('id', currentUserId);

                if (error) throw error;

                // Если одобрили - назначить дефолтную роль Guest для гостей
                if (approvalAction === 'approve') {
                    const user = allUsers.find(u => u.id === currentUserId);
                    if (user.user_type === 'guest' && user.user_id) {
                        const { data: guestRole } = await db
                            .from('roles')
                            .select('id')
                            .eq('code', 'guest')
                            .single();

                        if (guestRole) {
                            await db.from('user_roles').insert({
                                user_id: user.user_id,
                                role_id: guestRole.id,
                                is_active: true,
                                assigned_by: window.currentUser.id
                            });
                        }
                    }
                }

                closeApprovalModal();
                loadCounts(); // Обновить счётчики в табах
                loadUsers({ tab: currentTab !== 'all' ? currentTab : null });
                Layout.showNotification(approvalAction === 'approve' ? 'Заявка одобрена' : 'Заявка отклонена', 'success');
            } catch (err) {
                console.error('Approval error:', err);
                Layout.showNotification('Ошибка: ' + err.message, 'error');
            }
        }

        function closeApprovalModal() {
            document.getElementById('approvalModal').close();
        }

        // Открыть модалку управления
        async function openManageModal(userId) {
            const user = allUsers.find(u => u.id === userId);

            // Проверить что у пользователя есть user_id (привязан к auth.users)
            if (!user.user_id) {
                Layout.showNotification('У этого пользователя нет аккаунта в системе. Управление ролями и правами недоступно.', 'warning');
                return;
            }

            currentUserId = user.user_id; // Сохраняем auth.users.id, а не vaishnava.id

            document.getElementById('modalUserName').textContent = user.spiritual_name || user.first_name;
            document.getElementById('modalUserEmail').textContent = user.email;
            document.getElementById('modalUserType').textContent = user.user_type === 'staff' ? 'Команда' : 'Гость';
            document.getElementById('modalIsActive').checked = user.is_active;
            document.getElementById('modalIsSuperuser').checked = user.is_superuser;

            // Загрузить все кросс-модульные роли
            const { data: allRoles } = await db
                .from('roles')
                .select('id, code, name_ru, description_ru')
                .is('module_id', null)
                .order('sort_order');

            // Загрузить роли пользователя
            const { data: userRoles } = await db
                .from('user_roles')
                .select('role_id')
                .eq('user_id', user.user_id)
                .eq('is_active', true);

            const userRoleIds = userRoles ? userRoles.map(r => r.role_id) : [];

            // Отрисовать роли
            const rolesContainer = document.getElementById('rolesContainer');
            rolesContainer.innerHTML = allRoles.map(role => `
                <label class="label cursor-pointer justify-start gap-3 py-2 px-3 rounded-lg hover:bg-base-200 transition-colors">
                    <input type="checkbox" class="checkbox checkbox-sm checkbox-primary"
                           data-role-id="${role.id}"
                           ${userRoleIds.includes(role.id) ? 'checked' : ''}>
                    <div class="flex-1">
                        <div class="font-medium">${role.name_ru}</div>
                        <div class="text-xs opacity-60">${role.description_ru || ''}</div>
                    </div>
                </label>
            `).join('');

            // Загрузить индивидуальные права
            const { data: customPerms } = await db
                .from('user_permissions')
                .select(`
                    is_granted,
                    permissions!inner (
                        code,
                        name_ru
                    )
                `)
                .eq('user_id', user.user_id);

            const customPermsContainer = document.getElementById('customPermissionsContainer');
            if (customPerms && customPerms.length > 0) {
                customPermsContainer.innerHTML = '<div class="space-y-1">' + customPerms.map(p => `
                    <div class="flex items-center gap-2">
                        <span class="badge ${p.is_granted ? 'badge-success' : 'badge-error'} badge-sm">
                            ${p.is_granted ? '+' : '−'}
                        </span>
                        <span class="text-sm">${p.permissions.name_ru}</span>
                    </div>
                `).join('') + '</div>';
            } else {
                customPermsContainer.innerHTML = '<p class="text-sm opacity-50">Нет индивидуальных прав</p>';
            }

            document.getElementById('manageUserModal').showModal();
        }

        function closeManageModal() {
            document.getElementById('manageUserModal').close();
        }

        // Сохранить изменения пользователя
        async function saveUserChanges() {
            try {
                const user = allUsers.find(u => u.user_id === currentUserId);
                if (!user) {
                    Layout.showNotification('Пользователь не найден', 'error');
                    return;
                }

                const isSuperuser = document.getElementById('modalIsSuperuser').checked;

                // Обновить статус суперпользователя в vaishnavas
                await db
                    .from('vaishnavas')
                    .update({ is_superuser: isSuperuser })
                    .eq('id', user.id);

                // Обновить роли
                const checkedRoles = Array.from(document.querySelectorAll('#rolesContainer input:checked'))
                    .map(cb => cb.dataset.roleId);

                // Деактивировать все роли
                await db
                    .from('user_roles')
                    .update({ is_active: false })
                    .eq('user_id', user.user_id);

                // Добавить выбранные роли (batch upsert)
                if (checkedRoles.length > 0) {
                    const rolesData = checkedRoles.map(roleId => ({
                        user_id: user.user_id,
                        role_id: roleId,
                        is_active: true,
                        assigned_by: window.currentUser.id,
                        assigned_at: new Date().toISOString()
                    }));
                    await db.from('user_roles').upsert(rolesData, { onConflict: 'user_id,role_id' });
                }

                closeManageModal();
                loadCounts(); // Обновить счётчики в табах
                loadUsers({ tab: currentTab !== 'all' ? currentTab : null });
                Layout.showNotification('Изменения сохранены', 'success');
            } catch (err) {
                console.error('Save error:', err);
                Layout.showNotification('Ошибка сохранения: ' + err.message, 'error');
            }
        }

        // Заблокировать пользователя (с optimistic update)
        async function blockUser() {
            if (!confirm('Вы уверены что хотите заблокировать этого пользователя?')) return;

            const user = allUsers.find(u => u.user_id === currentUserId);
            if (!user) {
                Layout.showNotification('Пользователь не найден', 'error');
                return;
            }

            // Optimistic update: сразу закрываем модалку и показываем уведомление
            closeManageModal();
            Layout.showNotification('Пользователь заблокирован', 'success');

            try {
                await db
                    .from('vaishnavas')
                    .update({
                        approval_status: 'blocked',
                        is_active: false
                    })
                    .eq('id', user.id);

                loadCounts(); // Обновить счётчики в табах
                loadUsers({ tab: currentTab !== 'all' ? currentTab : null });
            } catch (err) {
                console.error('Block error:', err);
                Layout.showNotification('Ошибка блокировки: ' + err.message, 'error');
                // Перезагружаем список чтобы откатить UI
                loadUsers({ tab: currentTab !== 'all' ? currentTab : null });
            }
        }

        async function openPermissionsModal() {
            if (!currentUserId) return;

            // Загрузить все глобальные права (кросс-модульные)
            const { data: allPerms, error: permsError } = await db
                .from('permissions')
                .select('id, code, name_ru, category')
                .is('module_id', null)
                .order('category, name_ru');

            if (permsError || !allPerms || allPerms.length === 0) {
                console.error('Permissions error:', permsError);
                Layout.showNotification('Нет доступных прав', 'warning');
                return;
            }

            // Загрузить права пользователя из ролей
            const { data: userRoles } = await db
                .from('user_roles')
                .select('role_id')
                .eq('user_id', currentUserId)
                .eq('is_active', true);

            const roleIds = userRoles ? userRoles.map(r => r.role_id) : [];

            let rolePermissionCodes = [];
            if (roleIds.length > 0) {
                const { data: rolePerms } = await db
                    .from('role_permissions')
                    .select('permissions!inner(code)')
                    .in('role_id', roleIds);
                rolePermissionCodes = rolePerms ? rolePerms.map(rp => rp.permissions.code) : [];
            }

            // Загрузить индивидуальные права
            const { data: customPerms } = await db
                .from('user_permissions')
                .select('permissions!inner(code), is_granted')
                .eq('user_id', currentUserId);

            const customPermMap = {};
            if (customPerms) {
                customPerms.forEach(cp => {
                    customPermMap[cp.permissions.code] = cp.is_granted;
                });
            }

            const permissionsList = document.getElementById('permissionsList');

            const renderPermissions = (perms) => {
                // Группировать по категориям
                const byCategory = {};
                perms.forEach(p => {
                    if (!byCategory[p.category]) byCategory[p.category] = [];
                    byCategory[p.category].push(p);
                });

                permissionsList.innerHTML = Object.entries(byCategory).map(([cat, perms]) => `
                    <div class="mb-4">
                        <div class="text-sm font-bold opacity-60 mb-2">${cat || 'Другое'}</div>
                        ${perms.map(p => {
                            const hasFromRole = rolePermissionCodes.includes(p.code);
                            const hasCustom = p.code in customPermMap;
                            const isGranted = hasCustom ? customPermMap[p.code] : hasFromRole;
                            const isCustomOverride = hasCustom;

                            return `
                            <label class="label cursor-pointer justify-start gap-3 py-2">
                                <input type="checkbox"
                                       class="checkbox checkbox-sm ${isCustomOverride ? 'checkbox-primary' : ''}"
                                       data-perm-id="${p.id}"
                                       data-perm-code="${p.code}"
                                       data-perm-name="${p.name_ru.replace(/"/g, '&quot;')}"
                                       ${isGranted ? 'checked' : ''}
                                       onchange="togglePermission(this)">
                                <div class="flex-1">
                                    <div class="font-medium">${p.name_ru}</div>
                                    <div class="text-xs opacity-60">${p.code}${hasFromRole && !isCustomOverride ? ' (из роли)' : ''}${isCustomOverride ? ' (индивидуальное)' : ''}</div>
                                </div>
                            </label>`;
                        }).join('')}
                    </div>
                `).join('');
            };

            renderPermissions(allPerms);

            // Поиск
            document.getElementById('permissionSearch').value = '';
            document.getElementById('permissionSearch').oninput = (e) => {
                const query = e.target.value.toLowerCase();
                const filtered = allPerms.filter(p =>
                    p.name_ru.toLowerCase().includes(query) ||
                    p.code.toLowerCase().includes(query)
                );
                renderPermissions(filtered);
            };

            document.getElementById('permissionSelectModal').showModal();
        }

        async function togglePermission(checkbox) {
            const permId = checkbox.dataset.permId;
            const permCode = checkbox.dataset.permCode;
            const permName = checkbox.dataset.permName;
            const isGranted = checkbox.checked;

            try {
                // Использовать upsert для автоматической вставки или обновления
                const { error } = await db.from('user_permissions').upsert({
                    user_id: currentUserId,
                    permission_id: permId,
                    is_granted: isGranted,
                    granted_by: window.currentUser.id,
                    granted_at: new Date().toISOString()
                }, {
                    onConflict: 'user_id,permission_id'
                });

                if (error) {
                    console.error('Upsert error:', error);
                    throw error;
                }

                // Перезагрузить чекбокс чтобы обновить стиль
                checkbox.classList.toggle('checkbox-primary', true);

                Layout.showNotification(
                    `Право "${permName}" ${isGranted ? 'добавлено' : 'убрано'}`,
                    'success'
                );

            } catch (err) {
                // Откатить чекбокс при ошибке
                checkbox.checked = !isGranted;
                Layout.showNotification('Ошибка: ' + err.message, 'error');
            }
        }

        // Отправить приглашение одному пользователю
        async function sendInvite(vaishnavId, email) {
            const user = allUsers.find(u => u.id === vaishnavId);
            const userName = user?.spiritual_name || user?.first_name || email;

            if (!confirm(`Отправить приглашение пользователю ${userName} (${email})?`)) {
                return;
            }

            try {
                const { data: { session } } = await db.auth.getSession();
                if (!session) {
                    Layout.showNotification('Сессия истекла. Перезагрузите страницу.', 'error');
                    return;
                }

                const response = await fetch(
                    `${window.CONFIG.SUPABASE_URL}/functions/v1/send-invite`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session.access_token}`
                        },
                        body: JSON.stringify({ email, vaishnavId })
                    }
                );

                const result = await response.json();

                if (!response.ok) {
                    if (result.alreadyHasAccount) {
                        Layout.showNotification('У пользователя уже есть аккаунт', 'info');
                        loadUsers({ tab: currentTab !== 'all' ? currentTab : null });
                    } else {
                        throw new Error(result.error || 'Ошибка отправки');
                    }
                    return;
                }

                Layout.showNotification(`Приглашение отправлено на ${email}`, 'success');

            } catch (err) {
                console.error('Send invite error:', err);
                Layout.showNotification('Ошибка отправки приглашения: ' + err.message, 'error');
            }
        }

        // Массовая отправка приглашений
        async function sendBulkInvites() {
            const usersWithoutAccount = allUsers.filter(u => !u.user_id && u.email);

            if (usersWithoutAccount.length === 0) {
                Layout.showNotification('Нет пользователей без аккаунта', 'info');
                return;
            }

            if (!confirm(`Отправить приглашения ${usersWithoutAccount.length} пользователям?\n\nЭто может занять некоторое время.`)) {
                return;
            }

            try {
                const { data: { session } } = await db.auth.getSession();
                if (!session) {
                    Layout.showNotification('Сессия истекла. Перезагрузите страницу.', 'error');
                    return;
                }

                let sent = 0;
                let errors = 0;
                const errorList = [];

                for (const user of usersWithoutAccount) {
                    try {
                        const response = await fetch(
                            `${window.CONFIG.SUPABASE_URL}/functions/v1/send-invite`,
                            {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${session.access_token}`
                                },
                                body: JSON.stringify({ email: user.email, vaishnavId: user.id })
                            }
                        );

                        const result = await response.json();

                        if (response.ok) {
                            sent++;
                        } else {
                            errors++;
                            errorList.push(`${user.email}: ${result.error}`);
                        }

                        // Небольшая задержка между запросами
                        await new Promise(r => setTimeout(r, 200));

                    } catch (err) {
                        errors++;
                        errorList.push(`${user.email}: ${err.message}`);
                    }
                }

                if (errors > 0) {
                    console.error('Bulk invite errors:', errorList);
                    Layout.showNotification(`Отправлено: ${sent}, ошибок: ${errors}`, 'warning');
                } else {
                    Layout.showNotification(`Приглашения отправлены: ${sent}`, 'success');
                }

            } catch (err) {
                console.error('Bulk invite error:', err);
                Layout.showNotification('Ошибка массовой отправки: ' + err.message, 'error');
            }
        }

        // Ждём событие authReady от auth-check.js
        function waitForAuth(maxWait = 3000) {
            return new Promise(resolve => {
                if (window.currentUser) {
                    resolve();
                    return;
                }
                const handler = () => resolve();
                window.addEventListener('authReady', handler, { once: true });
                setTimeout(() => {
                    window.removeEventListener('authReady', handler);
                    resolve();
                }, maxWait);
            });
        }

        // Инициализация
        window.addEventListener('DOMContentLoaded', async () => {
            // Инициализация layout (хедер, футер, переводы)
            await Layout.init({ module: 'admin', menuId: 'access', itemId: 'user_management' });
            await waitForAuth();

            // Модуль admin только для суперпользователей
            if (!window.currentUser?.is_superuser) {
                window.location.href = '../index.html';
                return;
            }

            // Подождать пока auth-check.js создаст hasPermission
            while (typeof window.hasPermission !== 'function') {
                await new Promise(resolve => setTimeout(resolve, 50));
            }

            // Проверка прав доступа
            if (!window.hasPermission('manage_users') && !window.currentUser?.is_superuser) {
                Layout.showNotification('У вас нет прав для доступа к этой странице', 'error');
                window.location.href = '/';
                return;
            }

            // Загрузить ID волонтёров, затем счётчики + placeholder
            await loadVolunteerIds();
            loadCounts();
            showPlaceholder();
        });
    </script>
</body>

</html>
