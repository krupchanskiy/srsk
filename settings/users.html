<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script src="../js/color-init.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="users_page_title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚Äî –®–†–°–ö</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        .user-card { transition: all 0.2s ease; }
        .user-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px -5px rgba(0,0,0,0.1); }
        .role-badge { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 0.375rem; }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-6 flex-1">
        <!-- Page Title -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold" data-i18n="nav_vaishnavas_team">–ö–æ–º–∞–Ω–¥–∞</h1>
                <p class="text-sm opacity-60" id="usersCount" data-i18n="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <a href="../vaishnavas/team.html" class="btn btn-primary gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <span data-i18n="add">–î–æ–±–∞–≤–∏—Ç—å</span>
            </a>
        </div>

        <!-- Search & Filters -->
        <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <div class="flex-1 max-w-md relative">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email..." data-i18n-placeholder="users_search_placeholder" class="input input-bordered w-full pr-10" />
                <button type="button" id="clearSearch" class="absolute right-3 top-1/2 -translate-y-1/2 text-base-content/40 hover:text-base-content hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <select id="filterDepartment" class="select select-bordered">
                <option value="all" data-i18n="users_all_departments">–í—Å–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã</option>
            </select>
        </div>

        <!-- Users Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="usersGrid">
            <div class="card bg-base-100 shadow-md"><div class="card-body"><div class="skeleton h-4 w-32 mb-2"></div><div class="skeleton h-6 w-full mb-2"></div><div class="skeleton h-4 w-24"></div></div></div>
            <div class="card bg-base-100 shadow-md"><div class="card-body"><div class="skeleton h-4 w-32 mb-2"></div><div class="skeleton h-6 w-full mb-2"></div><div class="skeleton h-4 w-24"></div></div></div>
            <div class="card bg-base-100 shadow-md"><div class="card-body"><div class="skeleton h-4 w-32 mb-2"></div><div class="skeleton h-6 w-full mb-2"></div><div class="skeleton h-4 w-24"></div></div></div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="../js/config.js"></script>
    <script src="../js/auth-check.js?v=3"></script>
    <script src="../js/cache.js"></script>
    <script src="../js/utils.js?v=2"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/layout.js?v=5"></script>
    <script>
        // ==================== STATE ====================
        let users = [];
        let departments = [];
        let searchQuery = '';
        let filterDepartment = 'all';

        const e = str => Layout.escapeHtml(str);
        const db = Layout.db;

        // ==================== DATA LOADING ====================
        async function loadUsers() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–ª–µ–Ω–æ–≤ –∫–æ–º–∞–Ω–¥—ã –∏–∑ vaishnavas
                const { data: teamMembers, error: tmError } = await db
                    .from('vaishnavas')
                    .select('*, departments(id, name_ru, name_en, name_hi, color)')
                    .eq('is_team_member', true)
                    .eq('is_deleted', false)
                    .order('spiritual_name', { ascending: true, nullsFirst: false });

                if (tmError) throw tmError;

                users = teamMembers || [];
                renderUsers();
            } catch (err) {
                console.error('Error loading users:', err);
                users = [];
                renderUsers();
            }
        }

        async function loadDepartments() {
            try {
                departments = await Cache.getOrLoad('departments', async () => {
                    const { data, error } = await db.from('departments').select('*').order('sort_order');
                    if (error) throw error;
                    return data;
                });
                departments = departments || [];
                populateDepartmentFilters();
            } catch (err) {
                console.error('Error loading departments:', err);
                departments = [];
            }
        }

        function populateDepartmentFilters() {
            const filterSelect = Layout.$('#filterDepartment');
            const options = departments.map(d =>
                `<option value="${d.id}">${Layout.getName(d)}</option>`
            ).join('');

            if (filterSelect) {
                filterSelect.innerHTML = `<option value="all">–í—Å–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã</option>` + options;
            }
        }

        // ==================== RENDERING ====================
        function renderUsers() {
            const grid = Layout.$('#usersGrid');
            const countEl = Layout.$('#usersCount');

            const filtered = users.filter(user => {
                const name = user.spiritual_name || user.first_name || '';
                const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim();
                const matchesSearch = searchQuery === '' ||
                    name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    fullName.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    (user.email || '').toLowerCase().includes(searchQuery.toLowerCase());

                const matchesDepartment = filterDepartment === 'all' || user.department_id === filterDepartment;

                return matchesSearch && matchesDepartment;
            });

            countEl.textContent = `${filtered.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`;

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-12 opacity-50">
                    <div class="text-4xl mb-2">üë§</div>
                    <div>–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                </div>`;
                return;
            }

            grid.innerHTML = filtered.map(user => {
                const name = user.spiritual_name || user.first_name || '‚Äî';
                const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim();
                const initials = getInitials(name);
                const dept = user.departments;

                const deptHtml = dept
                    ? `<span class="badge badge-xs" style="background-color: ${dept.color}20; color: ${dept.color}; border-color: ${dept.color}">${Layout.getName(dept)}</span>`
                    : `<span class="text-sm opacity-50">–ù–µ—Ç –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞</span>`;

                return `
                    <div class="card bg-base-100 shadow-md user-card cursor-pointer" onclick="window.location.href='../vaishnavas/person.html?id=${user.id}'">
                        <div class="card-body">
                            <div class="flex items-start gap-3">
                                <div class="w-12 h-12 rounded-full bg-primary text-primary-content flex items-center justify-center font-bold flex-shrink-0">${initials}</div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <h3 class="font-semibold truncate">${Layout.currentLang === 'ru' ? name : Layout.transliterate(name)}</h3>
                                    </div>
                                    ${fullName && fullName !== name ? `<div class="text-sm opacity-60">${Layout.currentLang === 'ru' ? fullName : Layout.transliterate(fullName)}</div>` : ''}
                                    <div class="text-sm opacity-60 truncate">${e(user.phone) || '‚Äî'}</div>
                                    ${dept ? `<div class="mt-1">${deptHtml}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getInitials(name) {
            if (!name) return '?';
            const parts = name.trim().split(/\s+/);
            if (parts.length === 1) {
                return parts[0].substring(0, 2).toUpperCase();
            }
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        }

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = Layout.$('#searchInput');
            const clearBtn = Layout.$('#clearSearch');
            const filterSelect = Layout.$('#filterDepartment');

            searchInput?.addEventListener('input', e => {
                searchQuery = e.target.value;
                clearBtn?.classList.toggle('hidden', !e.target.value);
                renderUsers();
            });

            clearBtn?.addEventListener('click', () => {
                searchInput.value = '';
                searchQuery = '';
                clearBtn.classList.add('hidden');
                renderUsers();
                searchInput.focus();
            });

            filterSelect?.addEventListener('change', e => {
                filterDepartment = e.target.value;
                renderUsers();
            });
        });

        window.onLanguageChange = function() {
            Layout.updateAllTranslations();
            populateDepartmentFilters();
            renderUsers();
        };

        // ==================== INIT ====================
        async function init() {
            const ctx = await Layout.init({ menuId: 'settings', itemId: 'users' });
            if (!ctx) return;

            await Promise.all([
                loadUsers(),
                loadDepartments()
            ]);

            Layout.updateAllTranslations();
        }

        init();
    </script>
</body>
</html>
