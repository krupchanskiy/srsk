<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <script src="../js/color-init.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="translations_page_title">–ü–µ—Ä–µ–≤–æ–¥—ã ‚Äî –®–†–°–ö</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        /* –°—Ç–∏–ª–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–µ—Ä–µ–≤–æ–¥–æ–≤ */
        .edit-cell {
            transition: all 0.15s ease;
        }
        .edit-cell:hover {
            background-color: rgba(0,0,0,0.03);
        }
        .edit-input {
            background: transparent;
            border: none;
            width: 100%;
            padding: 0.5rem;
            outline: none;
        }
        .edit-input:focus {
            background: white;
            box-shadow: 0 0 0 2px var(--current-color);
            border-radius: 4px;
        }
        .saving {
            opacity: 0.5;
            pointer-events: none;
        }
        .saved {
            animation: flash-green 0.5s ease;
        }
        @keyframes flash-green {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(34, 197, 94, 0.2); }
        }
        .context-text {
            font-size: 0.75rem;
            color: #999;
        }
        .translate-btn {
            padding: 2px 8px;
            font-size: 11px;
            border-radius: 4px;
            background: #e5e7eb;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.15s;
        }
        .translate-btn:hover {
            background: var(--current-color);
            color: white;
        }
        .translate-btn.loading {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <!-- –•–µ–¥–µ—Ä (–≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∏–∑ layout.js) -->
    <div id="header-placeholder"></div>

    <!-- ==================== MAIN CONTENT ==================== -->
    <main class="container mx-auto px-4 py-6 flex-1">

        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold" data-i18n="translations_title">–ü–µ—Ä–µ–≤–æ–¥—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</h1>
                <p class="text-sm opacity-60" id="translationsCount" data-i18n="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <button class="btn btn-primary gap-2" data-permission="edit_translations" onclick="openAddModal()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <span data-i18n="add_translation">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥</span>
            </button>
        </div>

        <!-- Search & Filter -->
        <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <div class="flex-1 max-w-md relative">
                <input type="text" id="searchInput" data-i18n-placeholder="search_by_key" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á—É –∏–ª–∏ —Ç–µ–∫—Å—Ç—É..." class="input input-bordered w-full pr-10" />
                <button type="button" id="clearSearch" class="absolute right-3 top-1/2 -translate-y-1/2 text-base-content/40 hover:text-base-content hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <select class="select select-bordered" id="pageFilter">
                <option value="" data-i18n="translations_all_pages">–í—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</option>
            </select>
        </div>

        <!-- Info -->
        <div class="alert bg-base-300 mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span data-i18n="translations_info">–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ –ø–æ–ª—è. –ù–∞–∂–º–∏—Ç–µ Tab –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –≤–Ω–µ –ø–æ–ª—è.</span>
        </div>

        <!-- Translations Table -->
        <div class="bg-base-100 rounded-xl shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="table w-full">
                    <thead>
                        <tr class="border-b border-base-200">
                            <th class="bg-base-100 w-48" data-i18n="col_key">–ö–ª—é—á</th>
                            <th class="bg-base-100" data-i18n="col_russian">–†—É—Å—Å–∫–∏–π</th>
                            <th class="bg-base-100" data-i18n="col_english">English</th>
                            <th class="bg-base-100" data-i18n="col_hindi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</th>
                            <th class="bg-base-100 w-20"></th>
                        </tr>
                    </thead>
                    <tbody id="translationsTable">
                        <tr><td colspan="5" class="text-center py-8 opacity-50" data-i18n="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        <div id="pagination" class="flex justify-center items-center gap-2 py-4"></div>

    </main>

    <!-- –§—É—Ç–µ—Ä (–≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∏–∑ layout.js) -->
    <div id="footer-placeholder"></div>

    <!-- Add Modal -->
    <dialog id="addModal" class="modal">
        <div class="modal-box relative">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="addModal.close()">‚úï</button>
            <h3 class="font-bold text-lg mb-4" data-i18n="add_translation">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥</h3>
            <form id="addForm" class="space-y-4">
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="col_key">–ö–ª—é—á</span></label>
                    <input type="text" name="key" class="input input-bordered w-full" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: btn_submit" data-i18n-placeholder="translations_key_placeholder" required />
                    <p class="text-xs opacity-50 mt-1" data-i18n="key_hint">–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä, –ª–∞—Ç–∏–Ω–∏—Ü–∞ –∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è</p>
                </div>
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="col_russian">–†—É—Å—Å–∫–∏–π</span></label>
                    <input type="text" name="ru" class="input input-bordered w-full" required />
                </div>
                <div>
                    <label class="label">
                        <span class="label-text font-medium" data-i18n="col_english">English</span>
                        <button type="button" class="translate-btn" onclick="autoTranslate('ru', 'en', 'ru', 'en', this)">üåê Auto</button>
                    </label>
                    <input type="text" name="en" class="input input-bordered w-full" required />
                </div>
                <div>
                    <label class="label">
                        <span class="label-text font-medium" data-i18n="col_hindi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</span>
                        <button type="button" class="translate-btn" onclick="autoTranslate('ru', 'hi', 'ru', 'hi', this)">üåê Auto</button>
                    </label>
                    <input type="text" name="hi" class="input input-bordered w-full" required />
                </div>
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="col_page">–°—Ç—Ä–∞–Ω–∏—Ü–∞</span></label>
                    <select name="page" id="modalPageSelect" class="select select-bordered w-full" required></select>
                </div>
                <div>
                    <label class="label"><span class="label-text font-medium" data-i18n="context">–ö–æ–Ω—Ç–µ–∫—Å—Ç</span> <span class="text-xs opacity-50" data-i18n="translations_optional">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
                    <input type="text" name="context" class="input input-bordered w-full" placeholder="–£—Ç–æ—á–Ω–µ–Ω–∏–µ –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è" data-i18n-placeholder="translations_context_placeholder" />
                </div>
                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" onclick="addModal.close()" data-i18n="cancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary" data-i18n="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <script src="../js/config.js"></script>
    <script src="../js/auth-check.js?v=4"></script>
    <script src="../js/cache.js"></script>
    <script src="../js/utils.js?v=2"></script>
    <script src="../js/translit.js"></script>
    <script src="../js/auto-translate.js"></script>
    <script src="../js/layout.js?v=5"></script>
    <script>
        // ==================== STATE ====================
        const PAGE_SIZE = 50;
        let currentPage = 0;
        let totalCount = 0;
        let searchQuery = '';
        let pageFilter = '';
        let currentData = []; // —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö
        let pageOptions = []; // —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü –∏–∑ –ë–î

        // –ê–ª–∏–∞—Å—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
        const t = key => Layout.t(key);
        const addForm = () => document.getElementById('addForm');

        // ==================== AUTO-TRANSLATE ====================
        async function autoTranslate(fromField, toField, fromLang, toLang, btn) {
            const fromEl = addForm()[fromField];
            const toEl = addForm()[toField];
            if (!fromEl || !toEl) return;

            const text = fromEl.value.trim();
            if (!text) {
                toEl.focus();
                return;
            }

            btn.classList.add('loading');
            btn.textContent = '...';

            try {
                const translated = await Layout.translate(text, fromLang, toLang);
                toEl.value = translated;
            } catch (e) {
                console.error('Translation error:', e);
            }

            btn.classList.remove('loading');
            btn.textContent = 'üåê Auto';
        }

        // –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ (page_common, page_navigation, etc.)
        function getPageName(slug) {
            const key = 'page_' + slug;
            const translated = t(key);
            return translated !== key ? translated : slug;
        }

        // –§–æ—Ä–º—ã —Å–∫–ª–æ–Ω–µ–Ω–∏—è –¥–ª—è —Å—á—ë—Ç—á–∏–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤
        const TRANSLATION_FORMS = {
            ru: ['–ø–µ—Ä–µ–≤–æ–¥', '–ø–µ—Ä–µ–≤–æ–¥–∞', '–ø–µ—Ä–µ–≤–æ–¥–æ–≤'],
            en: ['translation', 'translations'],
            hi: '‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶'
        };

        // ==================== DATA ====================

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü –∏–∑ –ë–î (–¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –∏ –º–æ–¥–∞–ª–∫–∏)
        async function loadPageOptions() {
            const { data } = await Layout.db
                .from('translations')
                .select('page')
                .not('page', 'is', null)
                .order('page');
            pageOptions = [...new Set(data.map(d => d.page))];
            buildPageFilter();
            buildModalPageSelect();
        }

        // –°–µ—Ä–≤–µ—Ä–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è + –ø–æ–∏—Å–∫ + —Ñ–∏–ª—å—Ç—Ä
        async function loadPage() {
            const table = Layout.$('#translationsTable');
            table.innerHTML = `<tr><td colspan="5" class="text-center py-8 opacity-50">${t('loading')}</td></tr>`;

            let query = Layout.db.from('translations')
                .select('*', { count: 'exact' })
                .order('page')
                .order('key')
                .range(currentPage * PAGE_SIZE, (currentPage + 1) * PAGE_SIZE - 1);

            if (searchQuery) {
                const q = searchQuery.replace(/[%_]/g, c => '\\' + c);
                query = query.or(`key.ilike.%${q}%,ru.ilike.%${q}%,en.ilike.%${q}%,hi.ilike.%${q}%`);
            }
            if (pageFilter) {
                query = query.eq('page', pageFilter);
            }

            const { data, count, error } = await query;

            if (error) {
                console.error('Error:', error);
                table.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-error">${t('error')}</td></tr>`;
                return;
            }

            currentData = data;
            totalCount = count;
            renderTable(data);
            renderPagination();
        }

        function buildPageFilter() {
            const select = Layout.$('#pageFilter');
            const current = pageFilter;
            select.innerHTML = `<option value="">${t('all_pages')}</option>` +
                pageOptions.map(p => `<option value="${p}" ${p === current ? 'selected' : ''}>${getPageName(p)}</option>`).join('');
        }

        function renderTable(data) {
            const table = Layout.$('#translationsTable');
            const countEl = Layout.$('#translationsCount');
            const canEdit = window.hasPermission && window.hasPermission('edit_translations');

            const from = currentPage * PAGE_SIZE + 1;
            const to = Math.min(from + data.length - 1, totalCount);
            countEl.textContent = totalCount > 0
                ? `${from}‚Äì${to} / ${Layout.pluralize(totalCount, TRANSLATION_FORMS)}`
                : Layout.pluralize(0, TRANSLATION_FORMS);

            if (data.length === 0) {
                table.innerHTML = `<tr><td colspan="5" class="text-center py-8 opacity-50">${t('no_translations')}</td></tr>`;
                return;
            }

            table.innerHTML = data.map(row => `
                <tr class="border-b border-base-200" data-id="${row.id}">
                    <td class="align-top">
                        <code class="text-sm bg-base-200 px-2 py-1 rounded">${escapeHtml(row.key)}</code>
                        ${row.page ? `<div class="context-text mt-1">${getPageName(row.page)}</div>` : ''}
                    </td>
                    <td class="edit-cell p-0">
                        <input type="text" class="edit-input" value="${escapeHtml(row.ru)}" data-field="ru" data-id="${row.id}" data-orig="${escapeHtml(row.ru)}" ${canEdit ? '' : 'readonly'} />
                    </td>
                    <td class="edit-cell p-0">
                        <input type="text" class="edit-input" value="${escapeHtml(row.en)}" data-field="en" data-id="${row.id}" data-orig="${escapeHtml(row.en)}" ${canEdit ? '' : 'readonly'} />
                    </td>
                    <td class="edit-cell p-0">
                        <input type="text" class="edit-input" value="${escapeHtml(row.hi)}" data-field="hi" data-id="${row.id}" data-orig="${escapeHtml(row.hi)}" ${canEdit ? '' : 'readonly'} />
                    </td>
                    <td>
                        ${canEdit ? `<button class="btn btn-ghost btn-sm btn-square text-error" data-action="delete" data-id="${row.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
        function renderPagination() {
            const pag = Layout.$('#pagination');
            const totalPages = Math.ceil(totalCount / PAGE_SIZE);

            if (totalPages <= 1) {
                pag.innerHTML = '';
                return;
            }

            let html = '';

            // –ö–Ω–æ–ø–∫–∞ ¬´–ù–∞–∑–∞–¥¬ª
            html += `<button class="btn btn-sm btn-ghost" data-page="${currentPage - 1}" ${currentPage === 0 ? 'disabled' : ''}>‚Üê</button>`;

            // –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
            const pages = buildPageNumbers(currentPage, totalPages);
            for (const p of pages) {
                if (p === '...') {
                    html += `<span class="px-1 opacity-40">‚Ä¶</span>`;
                } else {
                    const active = p === currentPage;
                    html += `<button class="btn btn-sm ${active ? 'btn-primary' : 'btn-ghost'}" data-page="${p}">${p + 1}</button>`;
                }
            }

            // –ö–Ω–æ–ø–∫–∞ ¬´–î–∞–ª–µ–µ¬ª
            html += `<button class="btn btn-sm btn-ghost" data-page="${currentPage + 1}" ${currentPage >= totalPages - 1 ? 'disabled' : ''}>‚Üí</button>`;

            pag.innerHTML = html;
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–º–µ—Ä–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü: 0 1 ... 5 [6] 7 ... 42
        function buildPageNumbers(current, total) {
            if (total <= 7) return Array.from({ length: total }, (_, i) => i);
            const pages = new Set([0, 1, current - 1, current, current + 1, total - 2, total - 1]);
            const sorted = [...pages].filter(p => p >= 0 && p < total).sort((a, b) => a - b);
            const result = [];
            for (let i = 0; i < sorted.length; i++) {
                if (i > 0 && sorted[i] - sorted[i - 1] > 1) result.push('...');
                result.push(sorted[i]);
            }
            return result;
        }

        function escapeHtml(text) {
            return text.replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        async function saveField(input) {
            if (!window.hasPermission || !window.hasPermission('edit_translations')) {
                Layout.showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤', 'error');
                return;
            }
            const id = input.dataset.id;
            const field = input.dataset.field;
            const value = input.value;
            const origValue = input.dataset.orig;
            const row = input.closest('tr');

            if (origValue === value) return; // –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

            row.classList.add('saving');

            const { error } = await Layout.db
                .from('translations')
                .update({ [field]: value })
                .eq('id', id);

            row.classList.remove('saving');

            if (error) {
                Layout.showNotification(t('error') + ': ' + error.message, 'error');
                input.value = origValue;
            } else {
                input.dataset.orig = value;
                Cache.invalidate('translations_v4');
                row.classList.add('saved');
                setTimeout(() => row.classList.remove('saved'), 500);
            }
        }

        async function deleteTranslation(id) {
            if (!window.hasPermission || !window.hasPermission('edit_translations')) {
                Layout.showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤', 'error');
                return;
            }
            if (!confirm(t('confirm_delete'))) return;

            const { error } = await Layout.db
                .from('translations')
                .delete()
                .eq('id', id);

            if (error) {
                Layout.showNotification(t('error') + ': ' + error.message, 'error');
            } else {
                Cache.invalidate('translations_v4');
                loadPage();
            }
        }

        function openAddModal() {
            if (!window.hasPermission || !window.hasPermission('edit_translations')) {
                Layout.showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤', 'error');
                return;
            }
            Layout.$('#addForm').reset();
            addModal.showModal();
        }

        // ==================== EVENT DELEGATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            const table = Layout.$('#translationsTable');
            const searchInput = Layout.$('#searchInput');
            const clearBtn = Layout.$('#clearSearch');

            // Event delegation –¥–ª—è blur (auto-save) ‚Äî capture –¥–ª—è blur
            table.addEventListener('blur', e => {
                if (e.target.matches('.edit-input')) saveField(e.target);
            }, true);

            // Event delegation –¥–ª—è Enter ‚Üí blur
            table.addEventListener('keydown', e => {
                if (e.target.matches('.edit-input') && e.key === 'Enter') {
                    e.preventDefault();
                    e.target.blur();
                }
            });

            // Event delegation –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
            table.addEventListener('click', e => {
                const btn = e.target.closest('[data-action="delete"]');
                if (btn) deleteTranslation(btn.dataset.id);
            });

            // –°–µ—Ä–≤–µ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ —Å debounce
            const debouncedSearch = Layout.debounce(() => {
                currentPage = 0;
                loadPage();
            }, 400);

            searchInput?.addEventListener('input', e => {
                searchQuery = e.target.value.trim();
                clearBtn?.classList.toggle('hidden', !e.target.value);
                debouncedSearch();
            });

            clearBtn?.addEventListener('click', () => {
                searchInput.value = '';
                searchQuery = '';
                currentPage = 0;
                clearBtn.classList.add('hidden');
                loadPage();
                searchInput.focus();
            });

            // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            Layout.$('#pageFilter')?.addEventListener('change', e => {
                pageFilter = e.target.value;
                currentPage = 0;
                loadPage();
            });

            // –ü–∞–≥–∏–Ω–∞—Ü–∏—è ‚Äî –∫–ª–∏–∫–∏ –ø–æ –∫–Ω–æ–ø–∫–∞–º
            Layout.$('#pagination')?.addEventListener('click', e => {
                const btn = e.target.closest('[data-page]');
                if (!btn || btn.disabled) return;
                currentPage = parseInt(btn.dataset.page);
                loadPage();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            Layout.$('#addForm')?.addEventListener('submit', async e => {
                e.preventDefault();
                const form = e.target;
                const data = {
                    key: form.key.value.trim(),
                    ru: form.ru.value.trim(),
                    en: form.en.value.trim(),
                    hi: form.hi.value.trim(),
                    page: form.page.value,
                    context: form.context.value.trim() || null
                };

                const { error } = await Layout.db
                    .from('translations')
                    .insert(data);

                if (error) {
                    Layout.showNotification(t('error') + ': ' + error.message, 'error');
                } else {
                    Cache.invalidate('translations_v4');
                    await loadPageOptions();
                    currentPage = 0;
                    await loadPage();
                    addModal.close();
                }
            });
        });

        // ==================== UI UPDATE ====================
        function updatePageUI() {
            Layout.updateAllTranslations();
            buildPageFilter();
            buildModalPageSelect();
        }

        function buildModalPageSelect() {
            const select = Layout.$('#modalPageSelect');
            if (!select) return;

            select.innerHTML = pageOptions.map(key =>
                `<option value="${key}">${getPageName(key)}</option>`
            ).join('');
        }

        // Callback –ø—Ä–∏ —Å–º–µ–Ω–µ —è–∑—ã–∫–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ layout.js)
        window.onLanguageChange = function(lang) {
            updatePageUI();
            loadPage();
        };

        // ==================== INIT ====================
        // –ñ–¥—ë–º —Å–æ–±—ã—Ç–∏–µ authReady –æ—Ç auth-check.js
        function waitForAuth(maxWait = 3000) {
            return new Promise(resolve => {
                if (window.currentUser) {
                    resolve();
                    return;
                }
                const handler = () => resolve();
                window.addEventListener('authReady', handler, { once: true });
                setTimeout(() => {
                    window.removeEventListener('authReady', handler);
                    resolve();
                }, maxWait);
            });
        }

        async function init() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º layout (—Ö–µ–¥–µ—Ä, —Ñ—É—Ç–µ—Ä, –ª–æ–∫–∞—Ü–∏–∏)
            await Layout.init({ module: 'admin', menuId: 'system', itemId: 'translations' });
            await waitForAuth();

            // –ú–æ–¥—É–ª—å admin —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            if (!window.currentUser?.is_superuser) {
                window.location.href = '../index.html';
                return;
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü –∏ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
            await Promise.all([loadPageOptions(), loadPage()]);
        }

        init();
    </script>
</body>
</html>
